
Contents
Foreword	22
1	Scope	23
2	References	23
3	Definitions and abbreviations	29
4	Architecture model and concepts	40
4.2.5a	Radio Capabilities Signalling optimisation	51
4.2.8.1A	General Concepts to support Wireline Access	57
5	High level features	90
5.2.2a	Void	91
5.4.4.1a	UE radio capability signalling optimisation (RACS)	117
5.4.4.2a	UE Radio Capability Match Request	121
5.4.4a	UE MM Core Network Capability handling	122
5.4.4b	UE 5GSM Core Network Capability handling	123
5.6.5a	Supporting LADN per DNN and S-NSSAI	148
5.7.1.2a	Alternative QoS Profile	175
5.7.2.4.1a	Notification Control without Alternative QoS Profiles	181
5.7.2.4.1b	Notification control with Alternative QoS Profiles	182
5.9.2a	Subscription Concealed Identifier	237
5.15.11.5a	Support of Network Slice Admission Control in 5GS for maximum number of UEs with at least one PDU Session/PDN Connection	275
5.16.3.2a	IMS voice over PS Session Supported Indication over non-3GPP access	289
5.16.4.9a	Handling of PDU Sessions for normal services for Emergency Registered UEs	297
5.18.2a	PLMN list and SNPN list handling for network sharing	320
5.20a	Data Collection from an AF	331
5.20b	Support exposure of DNN and S-NSSAI specific Group Parameters	331
5.20b.1	Group attribute provisioning	331
5.20b.2	Support LADN service area for a group	331
5.20b.3	Support QoS for a group	332
5.20b.4	Void	332
5.20b.5	Support Change of PDU Session Type for a group of UEs	332
5.20c	Provisioning of traffic characteristics and monitoring of performance characteristics for a group	332
5.20d	User Plane Direct 5GS Information Exposure	333
5.20d.1	General	333
5.27.1a	Periodic deterministic communication	363
5.28a	Support for TSN enabled Transport Network	397
5.28a.1	General	397
5.28a.2	Transfer of TL-Container between SMF/CUC and AN-TL and CN-TL	397
5.28a.3	Topology Information for TSN TN	398
5.32.5.1a	Address of PMF messages	457
5.32.5.2a	Packet Loss Rate Measurements	458
5.35A	Support for Mobile Base Station Relay (MBSR)	493
5.35A.1	General	493
5.35A.2	 Configuration of the MBSR	493
5.35A.3	Mobility support of UEs served by MBSR	494
5.35A.3.1	UE mobility between a fixed cell and MBSR cell	494
5.35A.3.2	UE mobility between MBSR cells	494
5.35A.3.3	UE mobility when moving together with a MBSR cell	494
5.35A.4	MBSR authorization	494
5.35A.5	Location Service Support of UEs served by MBSR	495
5.35A.6	Providing cell ID/TAC of MBSR for services	495
5.35A.7	Control of UE access to MBSR	496
6	Network Functions	518
6.2.5a	Void	525
6.2.9A	TNGF	529
6.2.16A	GMLC	532
6.2.27a	MB-UPF	535
6.2.27b	MBSF	535
6.2.27c	MBSTF	535
6.3.6.2a	SNPN N3IWF selection	552
6.3.12a	Access Network selection for devices that do not support 5GC NAS over WLAN	568
6.3.12a.1	General	568
6.3.12a.2	Access Network Selection Procedure	568
6.3.12b	Access Network selection for 5G NSWO	569
7	Network Function Services and descriptions	576
7.2.8A	Void	588
7.2.16A	GMLC Services	591
8	Control and User Plane Protocol Stacks	596
Annex A (informative):	Relationship between Service-Based Interfaces and Reference Points	607
Annex B (normative):	Mapping between temporary identities	609
Annex C (informative):	Guidelines and Principles for Compute-Storage Separation	610
Annex D (informative):	5GS support for Non-Public Network deployment options	611
D.1	Introduction	611
D.2	Support of Non-Public Network as a network slice of a PLMN	611
D.3	Support for access to PLMN services via Stand-alone Non-Public Network and access to Stand-alone Non Public Network services via PLMN	612
D.4	Support for UE capable of simultaneously connecting to an SNPN and a PLMN	613
D.5	Support for keeping UE in CM-CONNECTED state in overlay network when accessing services via NWu	613
D.6	Support for session/service continuity between SNPN and PLMN when using N3IWF	614
D.7	Guidance for underlay network to support QoS differentiation for User Plane IPsec Child SA	615
D.7.1	Network initiated QoS	615
D.7.2	UE initiated QoS	616
Annex E (informative):	Communication models for NF/NF services interaction	618
E.1	General	618
Annex F (informative):	Redundant user plane paths based on multiple UEs per device	620
Annex G (informative):	SCP Deployment Examples	623
G.1	General	623
G.2	An SCP based on service mesh	623
G.2.1	Introduction	623
G.2.2	Communication across service mesh boundaries	624
G.3	An SCP based on independent deployment units	625
G.4	An SCP deployment example based on name-based routing	626
G.4.0	General Information	626
G.4.1	Service Registration and Service Discovery	627
G.4.2	Overview of Deployment Scenario	628
G.4.3	References	628
Annex H (normative):	PTP usage guidelines	629
H.1	General	629
H.2	Signalling of ingress time for time synchronization	629
H.3	Void	629
H.4	Path and Link delay measurements	629
Annex I (normative):	TSN usage guidelines	631
I.1	Determination of traffic pattern information	631
Annex J (informative):	Link MTU considerations	633
Annex K (normative):	Port and user plane node management information exchange	635
K.1	Standardized port and user plane node management information	635
K.2	Port and user plane node management information exchange for time synchronization	635
K.2.1	Capability exchange	635
K.2.2	PTP Instance configuration	635
K.2.2.1	General	635
K.2.2.2	Configuration for Sync and Announce reception timeouts	637
K.2.2.3	Configuration for PTP port states	637
K.2.2.4	Configuration for PTP grandmaster function	637
K.2.2.5	Configuration for Sync and Announce intervals	638
K.2.2.6	Configuration for transport protocols	638
Annex L (normative):	Support of GERAN/UTRAN access	640
Annex M (normative):	Interworking with TSN deployed in the Transport Network	641
M.1	Mapping of the parameters between 5GS and TSN UNI	641
M.2	TL-Container Information	645
Annex N (informative):	Support for access to localized services	648
N.1	General	648
N.2	Enabling access to localized services	648
N.2.1	General	648
N.2.2	Configuration of network to provide access to localized services	648
N.2.3	Session Management aspects	649
N.3	Selection of network providing access to localized services	649
N.4	Enabling the UE access to localized services	649
N.5	Support for leaving network that provides access to localized services	649
N.6	Configuration of Credentials Holder for determining SNPN selection information	650
Annex O (informative):	Allowing UE to simultaneously send data to different groups with different QoS policy	651
O.1	A PDU Session with multiple QoS Flows for different groups	651
O.2	Multiple PDU Sessions for different groups	652
O.3	A PDU Session targeting a predefined group formed of multiple sub-groups	653
Annex P (informative):	Personal IoT Networks	655
P.1	PIN Reference Architecture	655
P.2	Session management and traffic routing for PIN	655
Annex Q (informative):	Satellite coverage availability information	657
Annex R (informative):	Change history	658


Foreword
This Technical Specification has been produced by the 3rd Generation Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the TSG and may change following formal TSG approval. Should the TSG modify the contents of the present document, it will be re-released by the TSG with an identifying change of release date and an increase in version number as follows:
Version x.y.z
where:
x	the first digit:
1	presented to TSG for information;
2	presented to TSG for approval;
3	or greater indicates TSG approved document under change control.
y	the second digit is incremented for all changes of substance, i.e. technical enhancements, corrections, updates, etc.
z	the third digit is incremented when editorial only changes have been incorporated in the document.
1	Scope
The present document defines the Stage 2 system architecture for the 5G System. The 5G System provides data connectivity and services.
This specification covers both roaming and non-roaming scenarios in all aspects, including interworking between 5GS and EPS, mobility within 5GS, QoS, policy control and charging, authentication and in general 5G System wide features e.g. SMS, Location Services, Emergency Services.
ITU-T Recommendation I.130 [11] describes a three-stage method for characterisation of telecommunication services, and ITU-T Recommendation Q.65 [12] defines Stage 2 of the method.
TS 23.502 [3] contains the stage 2 procedures and flows for 5G System and it is a companion specification to this specification.
TS 23.503 [45] contains the stage 2 Policy Control and Charging architecture for 5G System and it is a companion specification to this specification.
2	References
The following documents contain provisions which, through reference in this text, constitute provisions of the present document.
-	References are either specific (identified by date of publication, edition number, version number, etc.) or non-specific.
-	For a specific reference, subsequent revisions do not apply.
-	For a non-specific reference, the latest version applies. In the case of a reference to a 3GPP document (including a GSM document), a non-specific reference implicitly refers to the latest version of that document in the same Release as the present document.
[1]	3GPP TR 21.905: "Vocabulary for 3GPP Specifications".
[2]	3GPP TS 22.261: "Service requirements for next generation new services and markets; Stage 1".
[3]	3GPP TS 23.502: "Procedures for the 5G System; Stage 2".
[4]	3GPP TS 23.203: "Policies and Charging control architecture; Stage 2".
[5]	3GPP TS 23.040: "Technical realization of the Short Message Service (SMS); Stage 2".
[6]	3GPP TS 24.011: "Point-to-Point (PP) Short Message Service (SMS) support on mobile radio interface: Stage 3".
[7]	IETF RFC 7157: "IPv6 Multihoming without Network Address Translation".
[8]	IETF RFC 4191: "Default Router Preferences and More-Specific Routes".
[9]	IETF RFC 2131: "Dynamic Host Configuration Protocol".
[10]	IETF RFC 4862: "IPv6 Stateless Address Autoconfiguration".
[11]	ITU-T Recommendation I.130: "Method for the characterization of telecommunication services supported by an ISDN and network capabilities of an ISDN".
[12]	ITU-T Recommendation Q.65: "The unified functional methodology for the characterization of services and network capabilities".
[13]	3GPP TS 24.301: "Non-Access-Stratum (NAS) protocol for Evolved Packet System (EPS): Stage 3".
[14]	IETF RFC 3736: "Stateless DHCP Service for IPv6".
[15]	3GPP TS 23.228: "IP Multimedia Subsystem (IMS); Stage 2".
[16]	3GPP TS 22.173: "IMS Multimedia Telephony Service and supplementary services; Stage 1".
[17]	3GPP TS 23.122: "Non-Access-Stratum (NAS) functions related to Mobile Station in idle mode".
[18]	3GPP TS 23.167: "3rd Generation Partnership Project; Technical Specification Group Services and Systems Aspects; IP Multimedia Subsystem (IMS) emergency sessions".
[19]	3GPP TS 23.003: "Numbering, Addressing and Identification".
[20]	IETF RFC 7542: "The Network Access Identifier".
[21]	3GPP TS 23.002: "Network Architecture".
[22]	3GPP TS 23.335: "User Data Convergence (UDC); Technical realization and information flows; Stage 2".
[23]	3GPP TS 23.221: "Architectural requirements".
[24]	3GPP TS 22.153: "Multimedia priority service".
[25]	3GPP TS 22.011: "Service Accessibility".
[26]	3GPP TS 23.401: "General Packet Radio Service (GPRS) enhancements for Evolved Universal Terrestrial Radio Access Network (E-UTRAN) access".
[27]	3GPP TS 38.300: "NR; NR and NG-RAN Overall Description".
[28]	3GPP TS 38.331: "NR; Radio Resource Control (RRC); Protocol Specification".
[29]	3GPP TS 33.501: "Security architecture and procedures for 5G system".
[30]	3GPP TS 36.300: "Evolved Universal Terrestrial Radio Access (E-UTRA) and Evolved Universal Terrestrial Radio Access Network (E-UTRAN); Overall description; Stage 2".
[31]	3GPP TS 37.340: "Evolved Universal Terrestrial Radio Access (E-UTRA) and NR; Multi-connectivity; Stage 2".
[32]	3GPP TS 23.214: "Architecture enhancements for control and user plane separation of EPC nodes; Stage 2".
[33]	3GPP TS 22.101: "3rd Generation Partnership Project; Technical Specification Group Services and Systems Aspects; Service aspects; Service principles".
[34]	3GPP TS 38.413: "NG-RAN; NG Application Protocol (NGAP)".
[35]	3GPP TS 33.126: "Lawful Interception Requirements".
[36]	3GPP TS 23.682: "Architecture enhancements to facilitate communications with packet data networks and applications".
[37]	3GPP TS 22.280: "Mission Critical Services Common Requirements (MCCoRe); Stage 1".
[38]	3GPP TS 23.379: "Functional architecture and information flows to support Mission Critical Push To Talk (MCPTT); Stage 2".
[39]	3GPP TS 23.281: "Functional architecture and information flows to support Mission Critical Video (MCVideo); Stage 2".
[40]	3GPP TS 23.282: "Functional architecture and information flows to support Mission Critical Data (MCData); Stage 2".
[41]	3GPP TS 32.240: "Charging management; Charging architecture and principles".
[42]	3GPP TS 38.401: "NG-RAN Architecture description".
[43]	3GPP TS 23.402: "Architecture enhancements for non-3GPP accesses".
[44]	IETF RFC 4960: "Stream Control Transmission Protocol".
[45]	3GPP TS 23.503: "Policy and Charging Control Framework for the 5G System".
[46]	3GPP TS 23.041: "Public Warning System".
[47]	3GPP TS 24.501: "Non-Access-Stratum (NAS) protocol for 5G System (5GS); Stage 3".
[48]	3GPP TS 24.502: "Access to the 5G System (5GS) via non-3GPP access networks; Stage 3".
[49]	3GPP TS 29.500: "5G System; Technical Realization of Service Based Architecture; Stage 3".
[50]	3GPP TS 38.304: "NR; User Equipment (UE) procedures in idle mode".
[51]	3GPP TS 36.331: "Evolved Universal Terrestrial Radio Access (E-UTRA); Radio Resource Control (RRC); Protocol specification".
[52]	3GPP TS 36.304: "Evolved Universal Terrestrial Radio Access (E-UTRA); User Equipment (UE) procedures in idle mode".
[53]	Void.
[54]	IETF RFC 4861: "Neighbor Discovery for IP version 6 (IPv6)".
[55]	3GPP TS 23.271: "Functional stage 2 description of Location Services (LCS)".
[56]	3GPP TS 23.060: "General Packet Radio Service (GPRS); Service description; Stage 2".
[57]	IETF RFC 4555: "IKEv2 Mobility and Multihoming Protocol (MOBIKE)".
[58]	3GPP TS 29.510: "5G System: Network function repository services; Stage 3".
[59]	3GPP TS 29.502: "5G System: Session Management Services: Stage 3".
[60]	IETF RFC 7296: "Internet Key Exchange Protocol Version 2 (IKEv2) ".
[61]	3GPP TS 23.380: "IMS Restoration Procedures".
[62]	3GPP TS 24.229: "IP multimedia call control protocol based on Session Initiation Protocol (SIP) and Session Description Protocol (SDP); Stage 3".
[63]	3GPP TS 23.292: "IP Multimedia Subsystem (IMS) centralized services; Stage 2".
[64]	3GPP TS 23.222: "Functional architecture and information flows to support Common API Framework for 3GPP Northbound APIs".
[65]	3GPP TS 29.244: "Interface between the Control Plane and the User Plane Nodes; Stage 3".
[66]	3GPP TS 32.421: "Telecommunication management; Subscriber and equipment trace; Trace concepts and requirements".
[67]	3GPP TS 32.290: "5G system; Services, operations and procedures of charging using Service Based Interface (SBI)".
[68]	3GPP TS 32.255: "5G Data connectivity domain charging; Stage 2".
[69]	3GPP TS 38.306: "NR; User Equipment -UE) radio access capabilities".
[70]	3GPP TS 36.306: "Evolved Universal Terrestrial Radio Access -E-UTRA); User Equipment -UE) radio access capabilities".
[71]	3GPP TS 29.518: "5G System; Access and Mobility Management Services; Stage 3".
[72]	Void.
[73]	IETF RFC 2865: "Remote Authentication Dial In User Service (RADIUS)".
[74]	IETF RFC 3162: "RADIUS and IPv6".
[75]	3GPP TS 29.281: "General Packet Radio System (GPRS) Tunnelling Protocol User Plane (GTPv1-U)".
[76]	3GPP TS 26.238: "Uplink streaming".
[77]	3GPP TR 26.939: "Guidelines on the Framework for Live Uplink Streaming (FLUS)".
[78]	International Telecommunication Union (ITU), Standardization Bureau (TSB): "Operational Bulletin No. 1156"; http://handle.itu.int/11.1002/pub/810cad63-en (retrieved October 5, 2018).
[79]	3GPP TS 28.533: "Management and orchestration; Architecture framework".
[80]	3GPP TS 24.250: "Protocol for Reliable Data Service; Stage 3".
[81]	IETF RFC 8684: "TCP Extensions for Multipath Operation with Multiple Addresses".
[82]	IETF RFC 8803: "0-RTT TCP Convert Protocol".
[83]	IEEE Std 802.1CB-2017: "IEEE Standard for Local and metropolitan area networks-Frame Replication and Elimination for Reliability".
[84]	3GPP TS 23.316: "Wireless and wireline convergence access support for the 5G System (5GS)".
[85]	WiFi Alliance Technical Committee, Hotspot 2.0 Technical Task Group: "Hotspot 2.0 (Release 2) Technical Specification".
[86]	3GPP TS 23.288: "Architecture enhancements for 5G System (5GS) to support network data analytics services".
[87]	3GPP TS 23.273: "5G System (5GS) Location Services (LCS); Stage 2".
[88]	3GPP TS 23.216: "Single Radio Voice Call Continuity (SRVCC); Stage 2".
[89]	CableLabs DOCSIS MULPI: "Data-Over-Cable Service Interface Specifications DOCSIS 3.1, MAC and Upper Layer Protocols Interface Specification".
[90]	BBF TR-124 issue 5: "Functional Requirements for Broadband Residential Gateway Devices".
[91]	BBF TR-101 issue 2: "Migration to Ethernet-Based Broadband Aggregation".
[92]	BBF TR-178 issue 1: "Multi-service Broadband Network Architecture and Nodal Requirements".
[93]	BBF TR-456 issue 2: "AGF Functional Requirements".
[94]	BBF WT-457: "FMIF Functional Requirements".
Editor's note:	The reference to BBF WT-457 will be revised when finalized by BBF.
[95]	Void.
[96]	Void.
[97]	IEEE Std 802.1AB-2016: "IEEE Standard for Local and metropolitan area networks -- Station and Media Access Control Connectivity Discovery".
[98]	IEEE Std 802.1Q-2022: "IEEE Standard for Local and metropolitan area networks--Bridges and Bridged Networks".
[99]	3GPP TS 38.423: "NG-RAN; Xn Application Protocol (XnAP)".
[100]	3GPP TS 36.413: "Evolved Universal Terrestrial Radio Access Network (E-UTRAN); S1 Application Protocol (S1AP)".
[101]	3GPP TS 29.274: "Evolved General Packet Radio Service (GPRS) Tunnelling Protocol for Control plane (GTPv2-C); Stage 3".
[102]	3GPP TS 23.632: "User Data Interworking, Coexistence and Migration; stage 2".
[103]	3GPP TS 29.563: "5G System (5GS); HSS services for interworking with UDM; Stage 3".
[104]	IEEE Std 802.1AS-2020: "IEEE Standard for Local and metropolitan area networks--Timing and Synchronization for Time-Sensitive Applications".
[105]	3GPP TS 22.104: "Service requirements for cyber-physical control applications in vertical domains".
[106]	IEEE Std 802.11-2012: "IEEE Standard for Information technology - Telecommunications and information exchange between systems - Local and metropolitan area networks - Specific requirements - Part 11: Wireless LAN Medium Access Control (MAC) and Physical Layer (PHY) Specifications".
[107]	IEEE Std 1588-2008: "IEEE Standard for a Precision Clock Synchronization Protocol for Networked Measurement and Control Systems".
[108]	3GPP TS 28.552: "Management and orchestration; 5G performance measurements".
[109]	3GPP TS 24.193: "Access Traffic Steering, Switching and Splitting; Stage 3".
[110]	3GPP TS 24.526: "User Equipment (UE) policies for 5G System (5GS); Stage 3".
[111]	3GPP TS 22.186: "Enhancement of 3GPP support for V2X scenarios; Stage 1".
[112]	3GPP TR 38.824: "Study on physical layer enhancements for NR ultra-reliable and low latency case (URLLC)".
[113]	IEEE: "Guidelines for Use of Extended Unique Identifier (EUI), Organizationally Unique Identifier (OUI), and Company ID (CID)", https://standards.ieee.org/content/dam/ieee-standards/standards/web/documents/tutorials/eui.pdf.
[114]	3GPP TS 32.256: "Charging Management; 5G connection and mobility domain charging; Stage 2".
[115]	3GPP TS 33.210: "Network Domain Security (NDS); IP network layer security".
[116]	3GPP TS 38.415: "PDU Session User Plane Protocol".
[117]	3GPP TS 24.535: "Device-side Time-Sensitive Networking (TSN) Translator (DS-TT) to network-side TSN Translator (NW-TT) protocol aspects; Stage 3".
[118]	3GPP TS 32.274: "Charging Management; Short Message Service (SMS) charging".
[119]	3GPP TS 23.008: "Organization of subscriber data".
[120]	3GPP TS 38.314: "NR; Layer 2 measurements".
[121]	3GPP TS 23.287: "Architecture enhancements for 5G System (5GS) to support Vehicle-to-Everything (V2X) services".
[122]	3GPP TS 29.503: "5G System; Unified Data Management Services; Stage 3".
[123]	3GPP TS 32.254: "Charging management; Exposure function Northbound Application Program Interfaces (APIs) charging".
[124]	3GPP TS 33.535: "Authentication and Key Management for Applications based on 3GPP credentials in the 5G System (5GS)".
[125]	3GPP TS 38.410: "NG-RAN; NG general aspects and principles".
[126]	IEEE Std 1588: "IEEE Standard for a Precision Clock Synchronization Protocol for Networked Measurement and Control Systems", Edition 2019.
[127]	ST 2059-2:2015: "SMPTE Standard - SMPTE Profile for Use of IEEE-1588 Precision Time Protocol in Professional Broadcast Applications".
[128]	3GPP TS 23.304: "Proximity based Services (ProSe) in the 5G System (5GS)".
[129]	3GPP TS 23.247: "Architectural enhancements for 5G multicast-broadcast services".
[130]	3GPP TS 23.548: "5G System Enhancements for Edge Computing; Stage 2".
[131]	IEEE Std 802.3: "Ethernet".
[132]	3GPP TS 29.561: "5G System; Interworking between 5G Network and external Data Networks; Stage 3".
[133]	3GPP TS 29.513: "Policy and Charging Control signalling flows and QoS parameter mapping; Stage 3".
[134]	3GPP TS 23.558: "Architecture for enabling Edge Applications (EA)".
[135]	3GPP TS 26.501: "5G Media Streaming (5GMS); General description and architecture".
[136]	3GPP TS 23.256: "Support of Uncrewed Aerial Systems (UAS) connectivity, identification and tracking; Stage 2".
[137]	GSMA NG.116: "Generic Network Slice Template".
[138]	IETF RFC 3948: "UDP Encapsulation of IPsec ESP Packets".
[139]	3GPP TS 24.539: "5G System (5GS); Network to TSN translator (TT) protocol aspects; Stage 3".
[140]	3GPP TS 33.220: "Generic Authentication Architecture (GAA); Generic bootstrapping architecture".
[141]	3GPP TS 33.223: "Generic Authentication Architecture (GAA); Generic Bootstrapping Architecture (GBA) Push function".
[142]	3GPP TS 23.540: "Technical realization of Service Based Short Message Service; Stage 2".
[143]	3GPP TS 38.321: "NR; Medium Access Control (MAC) protocol specification".
[144]	3GPP TS 29.525: "5G System; UE Policy Control Service; Stage 3".
[145]	3GPP TS 29.505: "5G System; Usage of the Unified Data Repository Services for Subscription Data; Stage 3".
[146]	IEEE Std P802.1Qdj-d1.0: "IEEE Draft Standard for Local and metropolitan area networks - Bridges and Bridged Networks - Amendment XX: Configuration Enhancements for Time-Sensitive Networking".
[147]	Void.
[148]	3GPP TS 28.557: "Management and orchestration; Management of Non-Public Networks (NPN)".
[149]	3GPP TS 28.541: "Management and orchestration; 5G Network Resource Model (NRM)".
[150]	IETF RFC 8655: "Deterministic Networking Architecture".
[151]	IETF RFC 8343: "A YANG Data Model for Interface Management".
[152]	IETF RFC 8344: "A YANG Data Model for IP Management".
[153]	IETF RFC 7224: " IANA Interface Type YANG Module".
[154]	IETF draft-ietf-detnet-yang: "Deterministic Networking (DetNet) YANG Model".
Editor's note:	The reference to draft-ietf-detnet-yang will be revised to RFC when finalized by IETF.
[155]	IETF RFC 6241: "Network Configuration Protocol (NETCONF)".
[156]	IETF RFC 8040: "RESTCONF Protocol".
[157]	IETF RFC 8939: "Deterministic Networking (DetNet) Data Plane: IP".
[158]	IETF RFC 5279: "A Uniform Resource Name (URN) Namespace for the 3rd Generation Partnership Project (3GPP)".
[159]	IETF RFC 9330:"Low Latency, Low Loss, Scalable Throughput (L4S) Internet Service: Architecture".
[160]	IETF RFC 9331: "Explicit Congestion Notification (ECN) Protocol for Very Low Queuing Delay (L4S)".
[161]	IETF RFC 9332: "Dual-Queue Coupled Active Queue Management (AQM) for Low Latency, Low Loss, and Scalable Throughput (L4S)".
[162]	IETF RFC 6603: "Prefix Exclude Option for DHCPv6-based Prefix Delegation".
[163]	IETF RFC 8415: "Dynamic Host Configuration Protocol for IPv6 (DHCPv6)".
[164]	ITU-T Recommendation G.810: "Definitions and terminology for synchronization networks".
[165]	3GPP TS 38.470: "NG-RAN; F1 general aspects and principles".
[166]	IETF RFC 9000: "QUIC: A UDP-Based Multiplexed and Secure Transport".
[167]	IETF RFC 9001: "Using TLS to Secure QUIC".
[168]	IETF RFC 9002: "QUIC Loss Detection and Congestion Control".
[169]	IETF RFC 9221: "An Unreliable Datagram Extension to QUIC".
[170]	IETF RFC 9298: "Proxying UDP in HTTP".
[171]	IETF RFC 9114: "Hypertext Transfer Protocol Version 3 (HTTP/3)".
[172]	IETF RFC 9297: "HTTP Datagrams and the Capsule Protocol".
[173]	IETF RFC 9220: "Bootstrapping WebSockets with HTTP/3".
[174]	draft-ietf-quic-multipath: "Multipath Extension for QUIC".
Editor's note:	The above document cannot be formally referenced until it is published as an RFC.
[175]	3GPP TS 28.530: "Management and orchestration; Concepts, use cases and requirements".
[176]	3GPP TS 28.531: "Management and orchestration; Provisioning".
[177]	3GPP TS 23.434: "Service Enabler Architecture Layer for Verticals (SEAL); Functional architecture and information flows".
[178]	IEEE Std 802.1CBdb-2021: "Amendment 2: Extend Stream Identification Functions".
[179]	3GPP TS 26.522: "5G Real-time Media Transport Protocol Configurations".
[180]	3GPP TS 23.586: "Architectural Enhancements to support Ranging based services and Sidelink Positioning".
[181]	3GPP TS 23.542: "Application layer support for Personal IoT Network".
3	Definitions and abbreviations
For the purposes of the present document, the terms and definitions given in TR 21.905 [1] and the following apply. A term defined in the present document takes precedence over the definition of the same term, if any, in TR 21.905 [1].
5G VN Group: A set of UEs using private communication for 5G LAN-type service.
5G Access Network: An access network comprising a NG-RAN and/or non-3GPP AN connecting to a 5G Core Network.
5G Access Stratum-based Time Distribution: A time synchronization distribution method that is used by an NG-RAN to provide the 5GS time to the UE(s) over the radio interface using procedures specified in TS 38.331 [28].
5G Core Network: The core network specified in the present document. It connects to a 5G Access Network.
5G LAN-Type Service: A service over the 5G system offering private communication using IP and/or non-IP type communications.
5G LAN-Virtual Network: A virtual network over the 5G system capable of supporting 5G LAN-type service.
5G NSWO: The 5G NSWO is the capability provided by 5G system and by UE to enable the connection to a WLAN access network using 5GS credentials without registration to 5GS.
5G QoS Flow or QoS Flow: The finest granularity for QoS forwarding treatment in the 5G System. All traffic mapped to the same 5G QoS Flow receive the same forwarding treatment (e.g. scheduling policy, queue management policy, rate shaping policy, RLC configuration, etc.). Providing different QoS forwarding treatment requires separate 5G QoS Flow.
5G QoS Identifier: A scalar that is used as a reference to a specific QoS forwarding behaviour (e.g. packet loss rate, packet delay budget) to be provided to a 5G QoS Flow. This may be implemented in the access network by the 5QI referencing node specific parameters that control the QoS forwarding treatment (e.g. scheduling weights, admission thresholds, queue management thresholds, link layer protocol configuration, etc.).
5G System: 3GPP system consisting of 5G Access Network (AN), 5G Core Network and UE.
5G-BRG: The 5G-BRG is a 5G-RG defined in BBF.
5G-CRG: The 5G-CRG is a 5G-RG specified in DOCSIS MULPI [89].
5G-RG: A 5G-RG is a RG capable of connecting to 5GC playing the role of a UE with regard to the 5G core. It supports secure element and exchanges N1 signalling with 5GC. The 5G-RG can be either a 5G-BRG or 5G-CRG.
Access Traffic Steering: The procedure that selects an access network for a new data flow and transfers the traffic of this data flow over the selected access network. Access traffic steering is applicable between one 3GPP access and one non-3GPP access.
Access Traffic Switching: The procedure that moves all traffic of an ongoing data flow from one access network to another access network in a way that maintains the continuity of the data flow. Access traffic switching is applicable between one 3GPP access and one non-3GPP access.
Access Traffic Splitting: The procedure that splits the traffic of a data flow across multiple access networks. When traffic splitting is applied to a data flow, some traffic of the data flow is transferred via one access and some other traffic of the same data flow is transferred via another access. Access traffic splitting is applicable between one 3GPP access and one non-3GPP access.
Allowed NSSAI: Indicating the S-NSSAIs values the UE could use in the Serving PLMN in the current Registration Area.
Allowed Area: Area where the UE is allowed to initiate communication as specified in clause 5.3.2.3.
Alternative S-NSSAI: Indicating a compatible S-NSSAI for an S-NSSAI in the Allowed NSSAI that the AMF uses to replace an S-NSSAI when the S-NSSAI is not available or congested, as specified in clause 5.15.19.
AMF Region: An AMF Region consists of one or multiple AMF Sets.
AMF Set: An AMF Set consists of some AMFs that serve a given area and Network Slice(s). AMF Set is unique within an AMF Region and it comprises of AMFs that support the same Network Slice(s). Multiple AMF Sets may be defined per AMF Region. The AMF instances in the same AMF Set may be geographically distributed but have access to the same context data.
Application Identifier: An identifier that can be mapped to a specific application traffic detection rule.
AUSF Group ID: This refers to one or more AUSF instances managing a specific set of SUPIs. An AUSF Group consists of one or multiple AUSF Sets.
Binding Indication: Information included by a NF service producer to a NF service consumer in request responses or notifications to convey the scope within which selection/reselection of target NF/NF Services may be performed, or information included by the NF service consumer in requests or subscriptions to convey the scope within which selection/reselection of notification targets or the selection of other service(s) that the NF consumer produces for the same data context may be performed. See clause 6.3.1.0.
BSF Group ID: This refers to one or more BSF instances managing a specific set of SUPIs or GPSIs. A BSF Group consists of one or multiple BSF Sets.
Configured NSSAI: NSSAI provisioned in the UE applicable to one or more PLMNs.
CHF Group ID: This refers to one or more CHF instances managing a specific set of SUPIs.
Credentials Holder: Entity which authenticates and authorizes access to an SNPN separate from the Credentials Holder.
Data Burst: A set of multiple PDUs generated and sent by the application in a short period of time.
NOTE 1:	A Data Burst can be composed of one or multiple PDU Sets.
Default UE credentials: Information configured in the UE to make the UE uniquely identifiable and verifiably secure to perform UE onboarding.
Default Credentials Server (DCS): An entity that can perform authentication based on the Default UE credentials or provide means for another entity to perform authentication based on the Default UE credentials.
Delegated Discovery: This refers to delegating the discovery and associated selection of NF instances or NF service instances to an SCP.
Direct Communication: This refers to the communication between NFs or NF services without using an SCP.
Disaster Condition: See definition in TS 22.261 [2].
Disaster Inbound Roamer: See definition in TS 22.261 [2].
Disaster Roaming: See definition in TS 22.261 [2].
DN Access Identifier (DNAI): Identifier of a user plane access to one or more DN(s) where applications are deployed.
Emergency Registered: A UE is considered Emergency Registered over an Access Type in a PLMN when registered for emergency services only over this Access Type in this PLMN.
Endpoint Address: An address in the format of an IP address or FQDN, which is used to determine the host/authority part of the target URI. This Target URI is used to access an NF service (i.e. to invoke service operations) of an NF service producer or for notifications to an NF service consumer.
En-gNB: as defined in TS 37.340 [31].
Expected UE Behaviour: Set of parameters provisioned by an external party to 5G network functions on the foreseen or expected UE behaviour, see clause 5.20.
Fixed Network Residential Gateway: A Fixed Network RG (FN-RG) is a RG that it does not support N1 signalling and it is not 5GC capable.
Fixed Network Broadband Residential Gateway: A Fixed Network RG (FN-BRG) is a FN-RG specified in BBF TR-124 [90].
Fixed Network Cable Residential Gateway: A Fixed Network Cable RG (FN-CRG) is a FN-RG with cable modem specified in DOCSIS MULPI [89].
Forbidden Area: An area where the UE is not allowed to initiate communication as specified in clause 5.3.2.3.
GBR QoS Flow: A QoS Flow using the GBR resource type or the Delay-critical GBR resource type and requiring guaranteed flow bit rate.
Group ID for Network Selection (GIN): An identifier used during SNPN selection to enhance the likelihood of selecting a preferred SNPN that supports a Default Credentials Server or a Credentials Holder.
(g)PTP-based Time Distribution: a method to distribute timing among entities in a (g)PTP domain using PTP messages generated by a GM (in the case the GM is external to 5GS) or by 5GS (in the case the 5GS acts as a GM for a given (g)PTP domain). Possible dependencies between (g)PTP-based Time Distribution and 5G Access Stratum-based Time Distribution are described in clause 5.27.1. The synchronization process is described in clause 5.27.1 and follows the applicable profiles of IEEE Std 802.1AS [104] or IEEE Std 1588 [126].
Home Network Public Key Identifier: An identifier used to indicate which public/private key pair is used for SUPI protection and de-concealment of the SUCI as specified in TS 23.003 [19].
IAB-donor: This is a NG-RAN node that supports Integrated access and backhaul (IAB) feature and provides connection to the core network to IAB-nodes. It supports the CU function of the CU/DU architecture for IAB defined in TS 38.401 [42].
IAB-node: A relay node that supports wireless in-band and out-of-band relaying of NR access traffic via NR Uu backhaul links. It supports the UE function and the DU function of the CU/DU architecture for IAB defined in TS 38.401 [42].
Indirect Communication: This refers to the communication between NFs or NF services via an SCP.
Initial Registration: UE registration in RM-DEREGISTERED state as specified in clause 5.3.2.
Intermediate SMF (I-SMF): An SMF that is inserted to support a PDU session as the UE is located in an area which cannot be controlled by the original SMF because the UPF(s) belong to a different SMF Service Area.
Local Area Data Network: a DN that is accessible by the UE only in specific locations, that provides connectivity to a specific DNN, and whose availability is provided to the UE.
Local Break Out (LBO): Roaming scenario for a PDU Session where the PDU Session Anchor and its controlling SMF are located in the serving PLMN (VPLMN).
LTE-M: a 3GPP RAT type Identifier used in the Core Network only, which is a sub-type of E-UTRA RAT type, and defined to identify in the Core Network the E-UTRA when used by a UE indicating Category M.
MA PDU Session: A PDU Session that provides a PDU connectivity service, which can use one access network at a time, or simultaneously one 3GPP access network and one non-3GPP access network.
Mobile Base Station Relay: A mobile base station acts as a relay between a UE and the 5G network. Such mobile base station relay can for example be mounted on a moving vehicle and serve UEs that can be located inside or outside the vehicle (or entering/leaving the vehicle). See description of TS 22.261 [2]. A mobile Base Station Relay is supported in 5GS with the IAB-architecture with mobility as specified in clause 5.35A and that described in TS 38.401 [42].
Mobility Pattern: Network concept of determining within the AMF the UE mobility parameters as specified in clause 5.3.2.4.
Mobility Registration Update: UE re-registration when entering new TA outside the TAI List as specified in clause 5.3.2.
MPS-subscribed UE: A UE having a USIM with MPS subscription.
Multi-USIM UE: A UE with multiple USIMs, capable of maintaining a separate registration state with a PLMN for each USIM at least over 3GPP Access and supporting one or more of the features described in clause 5.38.
NB-IoT UE Priority: Numerical value used by the NG-RAN to prioritise between different UEs accessing via NB-IoT.
NGAP UE association: The logical per UE association between a 5G-AN node and an AMF.
NGAP UE-TNLA-binding: The binding between a NGAP UE association and a specific TNL association for a given UE.
Network Function: A 3GPP adopted or 3GPP defined processing function in a network, which has defined functional behaviour and 3GPP defined interfaces.
NOTE 2:	A network function can be implemented either as a network element on a dedicated hardware, as a software instance running on a dedicated hardware, or as a virtualised function instantiated on an appropriate platform, e.g. on a cloud infrastructure.
Network Instance: Information identifying a domain. Used by the UPF for traffic detection and routing.
Network Slice: A logical network that provides specific network capabilities and network characteristics.
Network Slice Area of Service: The area where a UE can access and get service of a particular network slice as more than zero resources are allocated to the network slice in the NG-RAN cells.
Network Slice instance: A set of Network Function instances and the required resources (e.g. compute, storage and networking resources) which form a deployed Network Slice.
Non-GBR QoS Flow: A QoS Flow using the Non-GBR resource type and not requiring guaranteed flow bit rate.
NSI ID: an identifier for identifying the Core Network part of a Network Slice instance when multiple Network Slice instances of the same Network Slice are deployed, and there is a need to differentiate between them in the 5GC.
NF instance: an identifiable instance of the NF.
NF service: a functionality exposed by a NF through a service-based interface and consumed by other authorized NFs.
NF service instance: an identifiable instance of the NF service.
NF service operation: An elementary unit a NF service is composed of.
NF Service Set: A group of interchangeable NF service instances of the same service type within an NF instance. The NF service instances in the same NF Service Set have access to the same context data.
NF Set: A group of interchangeable NF instances of the same type, supporting the same services and the same Network Slice(s). The NF instances in the same NF Set may be geographically distributed but have access to the same context data.
NG-RAN: A radio access network that supports one or more of the following options with the common characteristics that it connects to 5GC:
1)	Standalone New Radio.
2)	New Radio is the anchor with E-UTRA extensions.
3)	Standalone E-UTRA.
4)	E-UTRA is the anchor with New Radio extensions.
Non-3GPP QoS Assistance Information: A set of QoS assistance information provided to the UE (e.g. PEGC) to enable the UE to perform QoS differentiation for the connected devices in the non-3GPP network behind the UE.
Non-Allowed Area: Area where the UE is allowed to initiate Registration procedure but no other communication as specified in clause 5.3.2.3.
Non-Public Network: See definition in TS 22.261 [2].
Non-Seamless Non-3GPP offload: The offload of user plane traffic via non-3GPP access without traversing either N3IWF/TNGF or UPF.
Non-Seamless WLAN offload: Non-Seamless Non-3GPP offload when the non-3GPP access network is WLAN.
Onboarding Network: Either a PLMN enabling Remote Provisioning for a registered UE, or an Onboarding SNPN.
Onboarding Standalone Non-Public Network: An SNPN providing Onboarding access and enabling Remote Provisioning for a UE registered for Onboarding as specified in clause 4.2.2.2.4 of TS 23.502 [3].
Partially Allowed NSSAI: Indicating the S-NSSAIs values the UE could use in the Serving PLMN or SNPN in some of the TAs in the current Registration Area. Each S-NSSAI in the Partially Allowed NSSAI is associated with a list of TAs where the S-NSSAI is supported.
PCF Group ID: This refers to one or more PCF instances managing a specific set of SUPIs. A PCF Group consists of one or multiple PCF Sets.
PDU Connectivity Service: A service that provides exchange of PDUs between a UE and a Data Network.
PDU Session: Association between the UE and a Data Network that provides a PDU connectivity service.
PDU Session Type: The type of PDU Session which can be IPv4, IPv6, IPv4v6, Ethernet or Unstructured.
PDU Set: One or more PDUs carrying the payload of one unit of information generated at the application level (e.g. frame(s) or video slice(s) etc. for eXtended Reality (XR) Services). All the PDUs of a PDU set are transmitted within the same QoS Flow.
Pending NSSAI: NSSAI provided by the Serving PLMN during a Registration procedure, indicating the S-NSSAI(s) for which the network slice-specific authentication and authorization procedure is pending.
Periodic Registration Update: UE re-registration at expiry of periodic registration timer as specified in clause 5.3.2.
Personal IoT Network (PIN): A configured and managed group of PIN Element(s) that are able to communicate with each other directly, communicate with each other via PIN Element(s) with Gateway Capability (i.e. PEGC(s)), or use a PEGC to communicate with devices or servers that are outside of the PIN via the 5G network. A PIN includes at least one PEGC and is managed by PIN Element(s) with Management Capability (i.e. PEMC(s)) with the support by an AF if AF is deployed.
PIN Element (PINE): A UE or non-3GPP device that can communicate within a PIN (via PINE-to-PINE direct connection or PINE-to-PINE indirect connection), or outside the PIN via a PEGC and 5GC.
PIN Element with Gateway Capability (PEGC): A PIN Element with the ability to provide DN connectivity via the 5G network for other PIN Elements and/or is able to provide relay functionality for communication between PIN Elements. Only a UE is able to act as a PEGC.
PIN Element with Management Capability (PEMC): A PIN Element with capability to manage the PIN.
NOTE 3:	A UE that is a PIN Element may both act as PEMC and PEGC.
PIN management traffic: The traffic among PINE, PEGC, PEMC and PIN AF related to the management of PIN network.
PIN-DN communication: The communication between PINE and DN via a PEGC and UPF and between PEGC and DN via UPF. The communication includes both the data traffic and the PIN management traffic (e.g. the data traffic towards the internet or the PIN management traffic towards the PIN AF).
PIN direct communication: The communication between two PIN Elements, between a PIN Element and a PEGC, between a PIN Element and a PEMC, between a PEMC and a PEGC and between two PEGCs without traversing an intermediate PEGC, 3GPP RAN or UPF. The communication includes both the data traffic and the PIN management traffic (e.g. the data traffic between 2 PINEs or the PIN management traffic between PINE, PEGC and PEMC).
PIN indirect communication: The communication between PIN Elements connected to different PEGCs of the same PIN, and between a PIN Element and a PEMC, via PEGC and 5GC. The communication includes both the data traffic and the PIN management traffic (e.g. the data traffic between 2 PINEs connected to different PEGCs of the same PIN or the PIN management traffic between PINE and PEMC connected to different PEGCs of the same PIN).
PLMN with Disaster Condition: A PLMN to which a Disaster Condition applies.
Pre-configured 5QI: Pre-defined QoS characteristics configured in the AN and 5GC and referenced via a non-standardized 5QI value.
Private communication: See definition in TS 22.261 [2].
Provisioning Server: Entity that provisions network credentials and other data in the UE to enable SNPN access.
PTP domain: As defined in IEEE Std 1588 [126].
Public network integrated NPN: A non-public network deployed with the support of a PLMN.
(Radio) Access Network: See 5G Access Network.
RAT type: Identifies the transmission technology used in the access network for both 3GPP accesses and non-3GPP Accesses, for example, NR, NB-IOT, Untrusted Non-3GPP, Trusted Non-3GPP, Trusted IEEE 802.11 Non-3GPP access, Wireline, Wireline-Cable, Wireline-BBF, etc.
NR RedCap: a 3GPP RAT type Identifier used in the Core Network only, which is a sub-type of NR RAT type, and defined to identify in the Core Network the NR when used by a UE indicating NR RedCap.
Requested NSSAI: NSSAI provided by the UE to the Serving PLMN during registration.
Residential Gateway: The Residential Gateway (RG) is a device providing, for example voice, data, broadcast video, video on demand, to other devices in customer premises.
Routing Binding Indication: Information included in a request or notification and that can be used by the SCP for discovery and associated selection to of a suitable target. See clauses 6.3.1.0 and 7.1.2
Routing Indicator: Indicator that allows together with SUCI/SUPI Home Network Identifier to route network signalling to AUSF and UDM instances capable to serve the subscriber.
RRC_IDLE, RRC_CONNECTED, RRC_INACTIVE: As defined in TS 38.331 [28] and TS 38.306 [69].
SCP Domain: A configured group of one or more SCP(s) and zero or more NF instances(s). An SCP within the group can communicate with any NF instance or SCP within the same group directly, i.e. without passing through an intermediate SCP.
SNPN-enabled UE: A UE configured to use stand-alone Non-Public Networks.
SNPN access mode: A UE operating in SNPN access mode only selects stand-alone Non-Public Networks over Uu, Yt, NWu.
NOTE 4:	If there are multiple instances of Uu/Yt/NWu, whether the UE is in SNPN access mode is determined for each instance independently. NWu can be either direct access via untrusted non-3GPP access or access via underlay network (see Annex D, clause D.3).
Service based interface: It represents how a set of services is provided/exposed by a given NF.
Service Continuity: The uninterrupted user experience of a service, including the cases where the IP address and/or anchoring point change.
Service Data Flow Filter: A set of packet flow header parameter values/ranges used to identify one or more of the (IP or Ethernet) packet flows constituting a Service Data Flow.
Service Data Flow Template: The set of Service Data Flow filters in a policy rule or an application identifier in a policy rule referring to an application detection filter, required for defining a Service Data Flow.
Session Continuity: The continuity of a PDU Session. For PDU Session of IPv4 or IPv6 or IPv4v6 type "session continuity" implies that the IP address is preserved for the lifetime of the PDU Session.
SMF Service Area: The collection of UPF Service Areas of all UPFs which can be controlled by one SMF.
SNPN ID: PLMN ID and NID identifying an SNPN.
Stand-alone Non-Public Network: A non-public network not relying on network functions provided by a PLMN
Subscribed S-NSSAI: S-NSSAI based on subscriber information, which a UE is subscribed to use in a PLMN
Subscription Owner Standalone Non-Public Network: A Standalone Non-Public Network owning the subscription of a UE and providing subscription data to the UE via a Provisioning Server during the onboarding procedure.
Survival Time: The time that an application consuming a communication service may continue without an anticipated message.
NOTE 5:	Taken from clause 3.1 of TS 22.261 [2].
Target NSSAI: NSSAI provided by the Serving PLMN to the NG-RAN to cause the NG-RAN to attempt to steer the UE to a cell supporting the Network Slices identified by the S-NSSAIs in this NSSAI. See clause 5.3.4.3.3 for more details.
Time Sensitive Communication (TSC): A communication service that supports deterministic communication (i.e. which ensures a maximum delay) and/or isochronous communication with high reliability and availability. It is about providing packet transport with QoS characteristics such as bounds on latency, loss, and reliability, where end systems and relay/transmit nodes may or may not be strictly synchronized.
TSN working domain: Synchronization domain for a localized set of devices collaborating on a specific task or work function in a TSN network, corresponding to a gPTP domain defined in IEEE 802.1AS [104].
UDM Group ID: This refers to one or more UDM instances managing a specific set of SUPIs. An UDM Group consists of one or multiple UDM Sets.
UDR Group ID: This refers to one or more UDR instances managing a specific set of SUPIs. An UDR Group consists of one or multiple UDR Sets.
UE-DS-TT Residence Time: The time taken within the UE and DS-TT to forward a packet, i.e. between the ingress of the UE and the DS-TT port in the DL direction, or between the DS-TT port and the egress of the UE in the UL direction. UE-DS-TT Residence Time is provided at the time of PDU Session Establishment by the UE to the network.
NOTE 6:	UE-DS-TT Residence Time is the same for uplink and downlink traffic and applies to all QoS Flows.
UPF Service Area: An area consisting of one or more TA(s) within which PDU Session associated with the UPF can be served by (R)AN nodes via a N3 interface between the (R)AN and the UPF without need to add a new UPF in between or to remove/re-allocate the UPF.
Uplink Classifier: UPF functionality that aims at diverting Uplink traffic, based on filter rules provided by SMF, towards Data Network.
WB-E-UTRA: In the RAN, WB-E-UTRA is the part of E-UTRA that excludes NB-IoT. In the Core Network, WB-E-UTRA also excludes LTE-M.
Wireline 5G Access Network: The Wireline 5G Access Network (W-5GAN) is a wireline AN that connects to a 5GC via N2 and N3 reference points. The W-5GAN can be either a W-5GBAN or W-5GCAN.
Wireline 5G Cable Access Network: The Wireline 5G Cable Access Network (W-5GCAN) is the Access Network defined in CableLabs.
Wireline BBF Access Network: The Wireline 5G BBF Access Network (W-5GBAN) is the Access Network defined in BBF.
Wireline Access Gateway Function (W-AGF): The Wireline Access Gateway Function (W-AGF) is a Network function in W-5GAN that provides connectivity to the 5G Core to 5G-RG and FN-RG.
NOTE 7:	If one AUSF/PCF/UDR/UDM group consists of multiple AUSF/PCF/UDR/UDM Sets, AUSF/PCF/UDR/UDM instance from different Set may be selected to serve the same UE. The temporary data which is not shared across different Sets may be lost, e.g. the event subscriptions stored at one UDM instance are lost if another UDM instance from different Set is selected and no data shared across the UDM Sets.
For the purposes of the present document, the abbreviations given in TR 21.905 [1] and the following apply. An abbreviation defined in the present document takes precedence over the definition of the same abbreviation, if any, in TR 21.905 [1].
5GC	5G Core Network
5G DDNMF	5G Direct Discovery Name Management Function
5G LAN	5G Local Area Network
5GS	5G System
5G-AN	5G Access Network
5G-AN PDB	5G Access Network Packet Delay Budget
5G-EIR	5G-Equipment Identity Register
5G-GUTI	5G Globally Unique Temporary Identifier
5G-BRG	5G Broadband Residential Gateway
5G-CRG	5G Cable Residential Gateway
5G GM	5G Grand Master
5G NSWO	5G Non-Seamless WLAN offload
5G-RG	5G Residential Gateway
5G-S-TMSI	5G S-Temporary Mobile Subscription Identifier
5G VN	5G Virtual Network
5QI	5G QoS Identifier
ADRF	Analytics Data Repository Function
AF	Application Function
AKMA	Authentication and Key Management for Applications
AnLF	Analytics Logical Function
AMF	Access and Mobility Management Function
AoI	Area of Interest
AS	Access Stratum
ATSSS	Access Traffic Steering, Switching, Splitting
ATSSS-LL	ATSSS Low-Layer
AUSF	Authentication Server Function
BMCA	Best Master Clock Algorithm
BSF	Binding Support Function
CAG	Closed Access Group
CAPIF	Common API Framework for 3GPP northbound APIs
CH	Credentials Holder
CHF	Charging Function
CN PDB	Core Network Packet Delay Budget
CP	Control Plane
DAPS	Dual Active Protocol Stacks
DCCF	Data Collection Coordination Function
DCS	Default Credentials Server
DetNet	Deterministic Networking
DL	Downlink
DN	Data Network
DNAI	DN Access Identifier
DNN	Data Network Name
DRX	Discontinuous Reception
DS-TT	Device-side TSN translator
EAC	Early Admission Control
ePDG	evolved Packet Data Gateway
EBI	EPS Bearer Identity
EUI	Extended Unique Identifier
FAR	Forwarding Action Rule
FN-BRG	Fixed Network Broadband RG
FN-CRG	Fixed Network Cable RG
FN-RG	Fixed Network RG
FQDN	Fully Qualified Domain Name
GBA	Generic Bootstrapping Architecture
GEO	Geostationary Orbit
GFBR	Guaranteed Flow Bit Rate
GIN	Group ID for Network Selection
GMLC	Gateway Mobile Location Centre
GPSI	Generic Public Subscription Identifier
GUAMI	Globally Unique AMF Identifier
HMTC	High-Performance Machine-Type Communications
HR	Home Routed (roaming)
IAB	Integrated access and backhaul
IMEI/TAC	IMEI Type Allocation Code
IPUPS	Inter PLMN UP Security
I-SMF	Intermediate SMF
I-UPF	Intermediate UPF
LADN	Local Area Data Network
LBO	Local Break Out (roaming)
LEO	Low Earth Orbit
LMF	Location Management Function
LoA	Level of Automation
LPP	LTE Positioning Protocol
LRF	Location Retrieval Function
L4S	Low Latency, Low Loss and Scalable Throughput
MBS	Multicast/Broadcast Service
MBSF	Multicast/Broadcast Service Function
MBSR	Mobile Base Station Relay
MBSTF	Multicast/Broadcast Service Transport Function
MB-SMF	Multicast/Broadcast Session Management Function
MB-UPF	Multicast/Broadcast User Plane Function
MEO	Medium Earth Orbit
MFAF	Messaging Framework Adaptor Function
MCX	Mission Critical Service
MDBV	Maximum Data Burst Volume
MFBR	Maximum Flow Bit Rate
MICO	Mobile Initiated Connection Only
MINT	Minimization of Service Interruption
ML	Machine Learning
MPQUIC	Multi-Path QUIC
MPS	Multimedia Priority Service
MPTCP	Multi-Path TCP Protocol
MTLF	Model Training Logical Function
N3IWF	Non-3GPP InterWorking Function
N3QAI		Non-3GPP QoS Assistance Information
N5CW	Non-5G-Capable over WLAN
NAI	Network Access Identifier
NEF	Network Exposure Function
NF	Network Function
NGAP	Next Generation Application Protocol
NID	Network identifier
NPN	Non-Public Network
NR	New Radio
NRF	Network Repository Function
NS-AoS	Network Slice Area of Service
NSAC	Network Slice Admission Control
NSACF	Network Slice Admission Control Function
NSAG	Network Slice AS Group
NSI ID	Network Slice Instance Identifier
NSSAA	Network Slice-Specific Authentication and Authorization
NSSAAF	Network Slice-specific and SNPN Authentication and Authorization Function
NSSAI	Network Slice Selection Assistance Information
NSSF	Network Slice Selection Function
NSSP	Network Slice Selection Policy
NSSRG	Network Slice Simultaneous Registration Group
NSWO	Non-Seamless WLAN offload
NSWOF	Non-Seamless WLAN offload Function
NW-TT	Network-side TSN translator
NWDAF	Network Data Analytics Function
ONN	Onboarding Network
ON-SNPN	Onboarding Standalone Non-Public Network
PCF	Policy Control Function
PDB	Packet Delay Budget
PDR	Packet Detection Rule
PDU	Protocol Data Unit
PDV	Packet Delay Variation
PEGC	PIN Element with Gateway Capability
PEI	Permanent Equipment Identifier
PEMC	PIN Element with Management Capability
PER	Packet Error Rate
PFD	Packet Flow Description
PIN	Personal IoT Network
PINE	PIN Element
PLR	Packet Loss Rate
PNI-NPN	Public Network Integrated Non-Public Network
PPD	Paging Policy Differentiation
PPF	Paging Proceed Flag
PPI	Paging Policy Indicator
PSA	PDU Session Anchor
PSDB	PDU Set Delay Budget
PSER	PDU Set Error Rate
PSIHI	PDU Set Integrated Handling Information
PTP	Precision Time Protocol
PVS	Provisioning Server
QFI	QoS Flow Identifier
QoE	Quality of Experience
RACS	Radio Capabilities Signalling optimisation
(R)AN	(Radio) Access Network
RG	Residential Gateway
RIM	Remote Interference Management
RQA	Reflective QoS Attribute
RQI	Reflective QoS Indication
RSN	Redundancy Sequence Number
RTT	Round Trip Time
SA NR	Standalone New Radio
SBA	Service Based Architecture
SBI	Service Based Interface
SCP	Service Communication Proxy
SD	Slice Differentiator
SEAF	Security Anchor Functionality
SEPP	Security Edge Protection Proxy
SF	Service Function
SFC	Service Function Chain
SMF	Session Management Function
SMSF	Short Message Service Function
SN	Sequence Number
SNPN	Stand-alone Non-Public Network
S-NSSAI	Single Network Slice Selection Assistance Information
SO-SNPN	Subscription Owner Standalone Non-Public Network
SSC	Session and Service Continuity
SSCMSP	Session and Service Continuity Mode Selection Policy
SST	Slice/Service Type
SUCI	Subscription Concealed Identifier
SUPI	Subscription Permanent Identifier
SV	Software Version
TA	Tracking Area
TAI	Tracking Area Identity
TNAN	Trusted Non-3GPP Access Network
TNAP	Trusted Non-3GPP Access Point
TNGF	Trusted Non-3GPP Gateway Function
TNL	Transport Network Layer
TNLA	Transport Network Layer Association
TSC	Time Sensitive Communication
TSCAI	TSC Assistance Information
TSCTSF	Time Sensitive Communication and Time Synchronization Function
TSN	Time Sensitive Networking
TSN GM	TSN Grand Master
TSP	Traffic Steering Policy
TT	TSN Translator
TWIF	Trusted WLAN Interworking Function
UAS NF	Uncrewed Aerial System Network Function
UCMF	UE radio Capability Management Function
UDM	Unified Data Management
UDR	Unified Data Repository
UDSF	Unstructured Data Storage Function
UL	Uplink
UL CL	Uplink Classifier
UPF	User Plane Function
URLLC	Ultra Reliable Low Latency Communication
URRP-AMF	UE Reachability Request Parameter for AMF
URSP	UE Route Selection Policy
VID	VLAN Identifier
VLAN	Virtual Local Area Network
W-5GAN	Wireline 5G Access Network
W-5GBAN	Wireline BBF Access Network
W-5GCAN	Wireline 5G Cable Access Network
W-AGF	Wireline Access Gateway Function

4	Architecture model and concepts
The 5G System architecture is defined to support data connectivity and services enabling deployments to use techniques such as e.g. Network Function Virtualization and Software Defined Networking. The 5G System architecture shall leverage service-based interactions between Control Plane (CP) Network Functions where identified. Some key principles and concept are to:
-	Separate the User Plane (UP) functions from the Control Plane (CP) functions, allowing independent scalability, evolution and flexible deployments e.g. centralized location or distributed (remote) location.
-	Modularize the function design, e.g. to enable flexible and efficient network slicing.
-	Wherever applicable, define procedures (i.e. the set of interactions between network functions) as services, so that their re-use is possible.
-	Enable each Network Function and its Network Function Services to interact with other NF and its Network Function Services directly or indirectly via a Service Communication Proxy if required. The architecture does not preclude the use of another intermediate function to help route Control Plane messages (e.g. like a DRA).
-	Minimize dependencies between the Access Network (AN) and the Core Network (CN). The architecture is defined with a converged core network with a common AN - CN interface which integrates different Access Types e.g. 3GPP access and non-3GPP access.
-	Support a unified authentication framework.
-	Support "stateless" NFs, where the "compute" resource is decoupled from the "storage" resource.
-	Support capability exposure.
-	Support concurrent access to local and centralized services. To support low latency services and local access to data networks, UP functions can be deployed close to the Access Network.
-	Support roaming with both Home routed traffic as well as Local breakout traffic in the visited PLMN.
This specification describes the architecture for the 5G System. The 5G architecture is defined as service-based and the interaction between network functions is represented in two ways.
-	A service-based representation, where network functions (e.g. AMF) within the Control Plane enables other authorized network functions to access their services. This representation also includes point-to-point reference points where necessary.
-	A reference point representation, shows the interaction exist between the NF services in the network functions described by point-to-point reference point (e.g. N11) between any two network functions (e.g. AMF and SMF).
Service-based interfaces are listed in clause 4.2.6. Reference points are listed in clause 4.2.7.
Network functions within the 5GC Control Plane shall only use service-based interfaces for their interactions.
NOTE 1:	The interactions between NF services within one NF are not specified in this Release of the specification.
NFs and NF services can communicate directly, referred to as Direct Communication, or indirectly via the SCP, referred to as Indirect Communication. For more information on communication options, see Annex E and clauses under 6.3.1 and 7.1.2.
In addition to the architecture descriptions in clause 4, the following areas are further described in other specifications:
-	NG-RAN architecture is described in TS 38.300 [27] and TS 38.401 [42].
-	Security architecture is described in TS 33.501 [29] and TS 33.535 [124].
-	Charging architecture is described in TS 32.240 [41].
-	5G Media streaming architecture is described in TS 26.501 [135].
NOTE 3:	The NFs listed in clause 4.2.2 are described in the following clauses or in the specifications above.
The 5G System architecture consists of the following network functions (NF):
-	Authentication Server Function (AUSF).
-	Access and Mobility Management Function (AMF).
-	Data Network (DN), e.g. operator services, Internet access or 3rd party services.
-	Unstructured Data Storage Function (UDSF).
-	Network Exposure Function (NEF).
-	Network Repository Function (NRF).
-	Network Slice Admission Control Function (NSACF).
-	Network Slice-specific and SNPN Authentication and Authorization Function (NSSAAF).
-	Network Slice Selection Function (NSSF).
-	Policy Control Function (PCF).
-	Session Management Function (SMF).
-	Unified Data Management (UDM).
-	Unified Data Repository (UDR).
-	User Plane Function (UPF).
-	UE radio Capability Management Function (UCMF).
-	Application Function (AF).
-	User Equipment (UE).
-	(Radio) Access Network ((R)AN).
-	5G-Equipment Identity Register (5G-EIR).
-	Network Data Analytics Function (NWDAF).
-	CHarging Function (CHF).
-	Time Sensitive Networking AF (TSN AF).
-	Time Sensitive Communication and Time Synchronization Function (TSCTSF).
-	Data Collection Coordination Function (DCCF).
-	Analytics Data Repository Function (ADRF).
-	Messaging Framework Adaptor Function (MFAF).
-	Non-Seamless WLAN Offload Function (NSWOF).
NOTE:	The functionalities provided by DCCF and/or ADRF can also be hosted by an NWDAF.
-	Edge Application Server Discovery Function (EASDF).
The 5G System architecture also comprises the following network entities:
-	Service Communication Proxy (SCP).
-	Security Edge Protection Proxy (SEPP).
The functional descriptions of these Network Functions and entities are specified in clause 6.
-	Non-3GPP InterWorking Function (N3IWF).
-	Trusted Non-3GPP Gateway Function (TNGF).
-	Wireline Access Gateway Function (W-AGF).
-	Trusted WLAN Interworking Function (TWIF).
Figure 4.2.3-1 depicts the non-roaming reference architecture. Service-based interfaces are used within the Control Plane.

Figure 4.2.3-1: Non-Roaming 5G System Architecture
NOTE:	If an SCP is deployed it can be used for indirect communication between NFs and NF services as described in Annex E. SCP does not expose services itself.
Figure 4.2.3-2 depicts the 5G System architecture in the non-roaming case, using the reference point representation showing how various network functions interact with each other.

Figure 4.2.3-2: Non-Roaming 5G System Architecture in reference point representation
NOTE 1:	N9, N14 are not shown in all other figures however they may also be applicable for other scenarios.
NOTE 2:	For the sake of clarity of the point-to-point diagrams, the UDSF, NEF and NRF have not been depicted. However, all depicted Network Functions can interact with the UDSF, UDR, NEF and NRF as necessary.
NOTE 3:	The UDM uses subscription data and authentication data and the PCF uses policy data that may be stored in UDR (refer to clause 4.2.5).
NOTE 4:	For clarity, the UDR and its connections with other NFs, e.g. PCF, are not depicted in the point-to-point and service-based architecture diagrams. For more information on data storage architectures refer to clause 4.2.5.
NOTE 5:	For clarity, the NWDAF(s), DCCF, MFAF and ADRF and their connections with other NFs, are not depicted in the point-to-point and service-based architecture diagrams. For more information on network data analytics architecture refer to TS 23.288 [86].
NOTE 6:	For clarity, the 5G DDNMF and its connections with other NFs, e.g. UDM, PCF are not depicted in the point-to-point and service-based architecture diagrams. For more information on ProSe architecture refer to TS 23.304 [128].
NOTE 7:	For clarity, the TSCTSF and its connections with other NFs, e.g. PCF, NEF, UDR are not depicted in the point-to-point and service-based architecture diagrams. For more information on TSC architecture refer to clause 4.4.8.
NOTE 8:	For exposure of the QoS monitoring information as specified in clause 5.8.2.18, exposure of data collected for analytics as specified in clause 5.2.26.2 of TS 23.502 [3], and exposure of the TSC management information as specified in clause 5.8.5.14, direct interaction between UPF and NFs can be supported via the Nupf interface (see clause 4.2.16).
NOTE 9:	For clarity, the EASDF and its connections with SMF is not depicted in the point-to-point and service-based architecture diagrams. For more information on edge computing architecture refer to TS 23.548 [130].
Figure 4.2.3-3 depicts the non-roaming architecture for UEs concurrently accessing two (e.g. local and central) data networks using multiple PDU Sessions, using the reference point representation. This figure shows the architecture for multiple PDU Sessions where two SMFs are selected for the two different PDU Sessions. However, each SMF may also have the capability to control both a local and a central UPF within a PDU Session.

Figure 4.2.3-3: Applying Non-Roaming 5G System Architecture for multiple PDU Session in reference point representation
Figure 4.2.3-4 depicts the non-roaming architecture in the case of concurrent access to two (e.g. local and central) data networks is provided within a single PDU Session, using the reference point representation.

Figure 4.2.3-4: Applying Non-Roaming 5G System Architecture for concurrent access to two (e.g. local and central) data networks (single PDU Session option) in reference point representation
Figure 4.2.3-5 depicts the non-roaming architecture for Network Exposure Function, using reference point representation.

Figure 4.2.3-5: Non-Roaming Architecture for Network Exposure Function in reference point representation
NOTE 1:	In Figure 4.2.3-5, Trust domain for NEF is same as Trust domain for SCEF as defined in TS 23.682 [36].
NOTE 2:	In Figure 4.2.3-5, 3GPP Interface represents southbound interfaces between NEF and 5GC Network Functions e.g. N29 interface between NEF and SMF, N30 interface between NEF and PCF, etc. All southbound interfaces from NEF are not shown for the sake of simplicity.
Figure 4.2.4-1 depicts the 5G System roaming architecture with local breakout with service-based interfaces within the Control Plane.

Figure 4.2.4-1: Roaming 5G System architecture- local breakout scenario in service-based interface representation
NOTE 1:	In the LBO architecture. the PCF in the VPLMN may interact with the AF in order to generate PCC Rules for services delivered via the VPLMN, the PCF in the VPLMN uses locally configured policies according to the roaming agreement with the HPLMN operator as input for PCC Rule generation, the PCF in VPLMN has no access to subscriber policy information from the HPLMN, the NSACF in the HPLMN is not used in this Release of the specification.
NOTE 2:	An SCP can be used for indirect communication between NFs and NF services within the VPLMN, within the HPLMN, or in within both VPLMN and HPLMN. For simplicity, the SCP is not shown in the roaming architecture.
NOTE 3:	For clarity, the NWDAF(s) with roaming exchange capability (RE-NWDAF) and their connections with other NFs, are not depicted in the service-based architecture diagram. For more information on network data analytics architecture refer to TS 23.288 [86].

Figure 4.2.4-2: Void
Figure 4.2.4-3 depicts the 5G System roaming architecture in the case of home routed scenario with service-based interfaces within the Control Plane.

Figure 4.2.4-3: Roaming 5G System architecture - home routed scenario in service-based interface representation
NOTE 4:	An SCP can be used for indirect communication between NFs and NF services within the VPLMN, within the HPLMN, or in within both VPLMN and HPLMN. For simplicity, the SCP is not shown in the roaming architecture.
NOTE 5:	UPFs in the home routed scenario can be used also to support the IPUPS functionality (see clause 5.8.2.14).
NOTE 6:	For clarity, the NWDAF(s) with roaming exchange capability (RE-NWDAF) and their connections with other NFs, are not depicted in the service-based architecture diagram. For more information on network data analytics architecture refer to TS 23.288 [86].
Figure 4.2.4-4 depicts 5G System roaming architecture in the case of local break out scenario using the reference point representation.

Figure 4.2.4-4: Roaming 5G System architecture - local breakout scenario in reference point representation
NOTE 7:	The NRF is not depicted in reference point architecture figures. Refer to Figure 4.2.4-7 for details on NRF and NF interfaces.
NOTE 8:	For the sake of clarity, SEPPs are not depicted in the roaming reference point architecture figures.
NOTE 9:	For clarity, the NWDAF(s) with roaming exchange capability (RE-NWDAF) and their connections with other NFs, are not depicted in the reference point architecture figure. For more information on network data analytics architecture refer to TS 23.288 [86].
The following figure 4.2.4-6 depicts the 5G System roaming architecture in the case of home routed scenario using the reference point representation.

Figure 4.2.4-6: Roaming 5G System architecture - Home routed scenario in reference point representation
The N38 references point can be between V-SMFs in the same VPLMN, or between V-SMFs in different VPLMNs (to enable inter-PLMN mobility).
NOTE 10:	For clarity, the NWDAF(s) with roaming exchange capability (RE-NWDAF) and their connections with other NFs, are not depicted in the reference point architecture figure. For more information on network data analytics architecture refer to TS 23.288 [86].
For the roaming scenarios described above each PLMN implements proxy functionality to secure interconnection and hide topology on the inter-PLMN interfaces.

Figure 4.2.4-7: NRF Roaming architecture in reference point representation
NOTE 11:	For the sake of clarity, SEPPs on both sides of PLMN borders are not depicted in figure 4.2.4-7.
Figure 4.2.4-8: Void
Operators can deploy UPFs supporting the Inter PLMN UP Security (IPUPS) functionality at the border of their network to protect their network from invalid inter PLMN N9 traffic in home routed roaming scenarios. The UPFs supporting the IPUPS functionality in VPLMN and HPLMN are controlled by the V-SMF and the H-SMF of that PDU Session respectively. A UPF supporting the IPUPS functionality terminates GTP-U N9 tunnels. The SMF can activate the IPUPS functionality together with other UP functionality in the same UPF, or insert a separate UPF for the IPUPS functionality in the UP path (which e.g. may be dedicated to be used for IPUPS functionality). Figure 4.2.4-9 depicts the home routed roaming architecture where a UPF is inserted in the UP path for the IPUPS functionality. Figure 4.2.4-3 depicts the home routed roaming architecture where the two UPFs perform the IPUPS functionality and other UP functionality for the PDU Session.
NOTE 12:	Operators are not prohibited from deploying the IPUPS functionality as a separate Network Function from the UPF, acting as a transparent proxy which can transparently read N4 and N9 interfaces. However, such deployment option is not specified and needs to take at least into account very long lasting PDU Sessions with infrequent traffic and Inter-PLMN handover.
The IPUPS functionality is specified in clause 5.8.2.14 and TS 33.501 [29].

Figure 4.2.4-9: Roaming 5G System architecture - home routed roaming scenario in service-based interface representation employing UPF dedicated to IPUPS
As depicted in Figure 4.2.5-1, the 5G System architecture allows any NF to store and retrieve its unstructured data into/from a UDSF (e.g. UE contexts). The UDSF belongs to the same PLMN where the network function is located. CP NFs may share a UDSF for storing their respective unstructured data or may each have their own UDSF (e.g. a UDSF may be located close to the respective NF).
NOTE 1:	Structured data in this specification refers to data for which the structure is defined in 3GPP specifications. Unstructured data refers to data for which the structure is not defined in 3GPP specifications.

Figure 4.2.5-1: Data Storage Architecture for unstructured data from any NF
NOTE 2:	3GPP will specify (possibly by referencing) the N18/Nudsf interface.
As depicted in Figure 4.2.5-2, the 5G System architecture allows the UDM, PCF and NEF to store data in the UDR, including subscription data and policy data by UDM and PCF, structured data for exposure and application data (including Packet Flow Descriptions (PFDs) for application detection, AF request information for multiple UEs) by the NEF. UDR can be deployed in each PLMN and it can serve different functions as follows:
-	UDR accessed by the NEF belongs to the same PLMN where the NEF is located.
-	UDR accessed by the UDM belongs to the same PLMN where the UDM is located if UDM supports a split architecture.
-	UDR accessed by the PCF belongs to the same PLMN where the PCF is located.
NOTE 3:	The UDR deployed in each PLMN can store application data for roaming subscribers.

Figure 4.2.5-2: Data Storage Architecture
NOTE 4:	There can be multiple UDRs deployed in the network, each of which can accommodate different data sets or subsets, (e.g. subscription data, subscription policy data, data for exposure, application data) and/or serve different sets of NFs. Deployments where a UDR serves a single NF and stores its data, and, thus, can be integrated with this NF, can be possible.
NOTE 5: The internal structure of the UDR in figure 4.2.5-2 is shown for information only.
The Nudr interface is defined for the network functions (i.e. NF Service Consumers), such as UDM, PCF and NEF, to access a particular set of the data stored and to read, update (including add, modify), delete, and subscribe to notification of relevant data changes in the UDR.
Each NF Service Consumer accessing the UDR, via Nudr, shall be able to add, modify, update or delete only the data it is authorised to change. This authorisation shall be performed by the UDR on a per data set and NF service consumer basis and potentially on a per UE, subscription granularity.
The following data in the UDR sets exposed via Nudr to the respective NF service consumer and stored shall be standardized:
-	Subscription Data,
-	Policy Data,
-	Structured Data for exposure,
-	Application data: Packet Flow Descriptions (PFDs) for application detection and AF request information for multiple UEs, as defined in clause 5.6.7.
The service based Nudr interface defines the content and format/encoding of the 3GPP defined information elements exposed by the data sets.
In addition, it shall be possible to access operator specific data sets by the NF Service Consumers from the UDR as well as operator specific data for each data set.
NOTE 6:	The content and format/encoding of operator specific data and operator specific data sets are not subject to standardization.
NOTE 7:	The organization of the different data stored in the UDR is not to be standardized.
4.2.5a	Radio Capabilities Signalling optimisation
Figure 4.2.5a-1 depicts the AMF to UCMF reference point and interface. Figure 4.2.5a-2 depicts the related interfaces in AMF and UCMF for the Radio Capabilities Signalling optimisation in the roaming architecture.

Figure 4.2.5a-1: Radio Capability Signalling optimisation architecture

NOTE:	The AF in the VPLMN (i.e. the one having a relationship with the VPLMN NEF) is the one which provisions Manufacturer Assigned UE radio capability IDs in the VPLMN UCMF. RACS is a serving PLMN only feature (it requires no specific support in the roaming agreement with the UE HPLMN to operate).

Figure 4.2.5a-2: Roaming architecture for Radio Capability Signalling optimisation
The 5G System Architecture contains the following service-based interfaces:
Namf:	Service-based interface exhibited by AMF.
Nsmf:	Service-based interface exhibited by SMF.
Nnef:	Service-based interface exhibited by NEF.
Npcf:	Service-based interface exhibited by PCF.
Nudm:	Service-based interface exhibited by UDM.
Naf:	Service-based interface exhibited by AF.
Nnrf:	Service-based interface exhibited by NRF.
Nnsacf:	Service-based interface exhibited by NSACF.
Nnssaaf:	Service-based interface exhibited by NSSAAF.
Nnssf:	Service-based interface exhibited by NSSF.
Nausf:	Service-based interface exhibited by AUSF.
Nudr:	Service-based interface exhibited by UDR.
Nudsf:	Service-based interface exhibited by UDSF.
N5g-eir:	Service-based interface exhibited by 5G-EIR.
Nnwdaf:	Service-based interface exhibited by NWDAF.
Nchf:	Service-based interface exhibited by CHF.
Nucmf:	Service-based interface exhibited by UCMF.
Ndccf:	Service based interface exhibited by DCCF.
Nmfaf:	Service based interface exhibited by MFAF.
Nadrf:	Service based interface exhibited by ADRF.
Naanf:	Service-based interface exhibited by AANF.
NOTE 1:	The Service-based interface exhibited by AANF is defined in TS 33.535 [124].
N5g-ddnmf:	Service-based interface exhibited by 5G DDNMF.
Nmbsmf:	Service-based interface exhibited by MB-SMF.
Nmbsf:	Service-based interface exhibited by MBSF.
NOTE 2:	The Service-based interfaces exhibited by MB-SMF and MBSF are defined in TS 23.247 [129].
Ntsctsf:	Service-based interface exhibited by TSCTSF.
Nbsp:	Service-based interface exhibited by an SBI capable Boostrapping Server Function in GBA.
NOTE 2:	The Service-based interfaces exhibited by an SBI capable Boostrapping Server Function are defined in TS 33.220 [140] and TS 33.223 [141].
Neasdf:	Service-based interface exhibited by EASDF.
NOTE 3:	The Service-based interfaces exhibited by EADSF is defined in TS 23.548 [130].
Nupf:	Service-based interface exhibited by UPF.
The 5G System Architecture contains the following reference points:
N1:	Reference point between the UE and the AMF.
N2:	Reference point between the (R)AN and the AMF.
N3:	Reference point between the (R)AN and the UPF.
N4:	Reference point between the SMF and the UPF.
N6:	Reference point between the UPF and a Data Network.
N9:	Reference point between two UPFs.
The following reference points show the interactions that exist between the NF services in the NFs. These reference points are realized by corresponding NF service-based interfaces and by specifying the identified consumer and producer NF service as well as their interaction in order to realize a particular system procedure.
N5:	Reference point between the PCF and an AF or TSN AF.
N7:	Reference point between the SMF and the PCF.
N8:	Reference point between the UDM and the AMF.
N10:	Reference point between the UDM and the SMF.
N11:	Reference point between the AMF and the SMF.
N12:	Reference point between AMF and AUSF.
N13:	Reference point between the UDM and Authentication Server function the AUSF.
N14:	Reference point between two AMFs.
N15:	Reference point between the PCF and the AMF in the case of non-roaming scenario, PCF in the visited network and AMF in the case of roaming scenario.
N16:	Reference point between two SMFs, (in roaming case between SMF in the visited network and the SMF in the home network).
N16a:	Reference point between SMF and I-SMF.
N17:	Reference point between AMF and 5G-EIR.
N18:	Reference point between any NF and UDSF.
N19:	Reference point between two PSA UPFs for 5G LAN-type service.
N22:	Reference point between AMF and NSSF.
N23:	Reference point between PCF and NWDAF.
N24:	Reference point between the PCF in the visited network and the PCF in the home network.
N27:	Reference point between NRF in the visited network and the NRF in the home network.
N28:	Reference point between PCF and CHF.
N29:	Reference point between NEF and SMF.
N30:	Reference point between PCF and NEF.
NOTE 1:	The functionality of N28 and N29 and N30 reference points are defined in TS 23.503 [45].
N31:	Reference point between the NSSF in the visited network and the NSSF in the home network.
NOTE 2:	In some cases, a couple of NFs may need to be associated with each other to serve a UE.
N32:	Reference point between a SEPP in one PLMN or SNPN and a SEPP in another PLMN or SNPN; or between a SEPP in a SNPN and a SEPP in a CH/DCS, where the CH/DCS contains a UDM/AUSF.
NOTE 3:	The functionality of N32 reference point is defined in TS 33.501 [29].
N33:	Reference point between NEF and AF.
N34:	Reference point between NSSF and NWDAF.
N35:	Reference point between UDM and UDR.
N36:	Reference point between PCF and UDR.
N37:	Reference point between NEF and UDR.
N38:	Reference point between I-SMFs and between V-SMFs.
N40:	Reference point between SMF and the CHF.
N41:	Reference point between AMF and CHF in HPLMN.
N42:	Reference point between AMF and CHF in VPLMN.
NOTE 4:	The functionality of N40, N41 and N42 reference points are defined in TS 32.240 [41].
N43:	Reference point between PCFs.
NOTE 5:	The functionality of N43 reference point is defined in TS 23.503 [45].
NOTE 6:	The reference points from N44 up to and including N49 are reserved for allocation and definition in TS 32.240 [41].
N50:	Reference point between AMF and the CBCF.
N51:	Reference point between AMF and NEF.
N52:	Reference point between NEF and UDM.
N55:	Reference point between AMF and the UCMF.
N56:	Reference point between NEF and the UCMF.
N57:	Reference point between AF and the UCMF.
NOTE 7:	The Public Warning System functionality of N50 reference point is defined in TS 23.041 [46].
N58:	Reference point between AMF and the NSSAAF.
N59:	Reference point between UDM and the NSSAAF.
N60:	Reference point between AUSF and NSWOF.
NOTE 8:	The functionality of N60 reference point is defined in TS 33.501 [29].
N80:	Reference point between AMF and NSACF.
N81:	Reference point between SMF and NSACF.
N82:	Reference point between NSACF and NEF.
N83:	Reference point between AUSF and NSSAAF.
N84:	Reference point between TSCTSF and PCF.
N85:	Reference point between TSCTSF and NEF.
N86:	Reference point between TSCTSF and AF.
N87:	Reference point between TSCTSF and UDM.
N88:	Reference point between SMF and EASDF.
N89:	Reference point between TSCTSF and AMF.
N96:	Reference point between TSCTSF and NRF.
N97:	Reference point between two NSACFs in different PLMNs.
N99:	Reference point between two NSACFs within the same PLMN.
NOTE 9:	The reference points from N90 up to and including N95 are reserved for allocation and definition in TS 23.503 [45].
NOTE 10:	The reference points from N100 up to and including N109 are reserved for allocation and definition in TS 32.240 [41].
The reference points to support SMS over NAS are listed in clause 4.4.2.2.
The reference points to support Location Services are listed in TS 23.273 [87].
The reference points to support SBA in IMS (N5, N70 and N71) are described in TS 23.228 [15].
The reference points to support AKMA (N61, N62 and N63) are described in TS 33.535 [124].
The reference points to support 5G ProSe are described in TS 23.304 [128].
The reference points to support 5G multicast-broadcast services are described in TS 23.247 [129].
The reference points to Support Uncrewed Aerial Systems (UAS) connectivity, identification and tracking are described in TS 23.256 [136].
The reference points to support SBA in GBA and GBA push (N65, N66, N67 and N68) are described in TS 33.220 [140] and TS 33.223 [141].
The reference points to support SMS delivery using SBA are described in TS 23.540 [142].
The reference points to support Ranging based services and Sidelink Positioning are described in TS 23.586 [180].
In this Release of the specification, the following types of non-3GPP access networks are defined:
-	Untrusted non-3GPP access networks;
-	Trusted non-3GPP access networks; and
-	Wireline access networks.
The architecture to support Untrusted and Trusted non-3GPP access networks is defined in clause 4.2.8.2. The architecture to support Wireline access networks is defined in clause 4.2.8.2.4 and in TS 23.316 [84].
The 5G Core Network supports connectivity of UEs via non-3GPP access networks, e.g. WLAN access networks.
Only the support of non-3GPP access networks deployed outside the NG-RAN is described in this clause.
The 5G Core Network supports both untrusted non-3GPP access networks and trusted non-3GPP access networks (TNANs).
An untrusted non-3GPP access network shall be connected to the 5G Core Network via a Non-3GPP InterWorking Function (N3IWF), whereas a trusted non-3GPP access network shall be connected to the 5G Core Network via a Trusted Non-3GPP Gateway Function (TNGF). Both the N3IWF and the TNGF interface with the 5G Core Network CP and UP functions via the N2 and N3 interfaces, respectively.
A non-3GPP access network may advertise the PLMNs or SNPNs for which it supports trusted connectivity and the type of supported trusted connectivity (e.g. "5G connectivity"). Therefore, the UEs can discover the non-3GPP access networks that can provide trusted connectivity to one or more PLMNs or SNPNs. This is further specified in clause 6.3.12 (Trusted Non-3GPP Access Network selection).
The UE decides to use trusted or untrusted non-3GPP access for connecting to a 5G PLMN or SNPNs by using procedures not specified in this document. Examples of such procedures are defined in clause 6.3.12.1.
When the UE decides to use untrusted non-3GPP access to connect to a 5G Core Network in a PLMN:
-	the UE first selects and connects with a non-3GPP access network; and then
-	the UE selects a PLMN/SNPN and an N3IWF in this PLMN/SNPN. The PLMN/SNPN/N3IWF selection and the non-3GPP access network selection are independent. The N3IWF selection is defined in clause 6.3.6.
When the UE decides to use trusted non-3GPP access to connect to a 5G Core Network in a PLMN:
-	the UE first selects a PLMN/SNPN; and then
-	the UE selects a non-3GPP access network (a TNAN) that supports trusted connectivity to the selected PLMN/SNPN. In this case, the non-3GPP access network selection is affected by the PLMN/SNPN selection.
A UE that accesses the 5G Core Network over a non-3GPP access shall, after UE registration, support NAS signalling with 5G Core Network control-plane functions using the N1 reference point.
When a UE is connected via a NG-RAN and via a non-3GPP access, multiple N1 instances shall exist for the UE i.e. there shall be one N1 instance over NG-RAN and one N1 instance over non-3GPP access.
A UE simultaneously connected to the same 5G Core Network of a PLMN/SNPN over a 3GPP access and a non-3GPP access shall be served by a single AMF in this 5G Core Network.
When a UE is connected to a 3GPP access of a PLMN, if the UE selects a N3IWF and the N3IWF is located in a PLMN different from the PLMN of the 3GPP access, e.g. in a different VPLMN or in the HPLMN, the UE is served separately by the two PLMNs. The UE is registered with two separate AMFs. PDU Sessions over the 3GPP access are served by V-SMFs different from the V-SMF serving the PDU Sessions over the non-3GPP access. The same can be true when the UE uses trusted non-3GPP access, i.e. the UE may select one PLMN for 3GPP access and a different PLMN for trusted non-3GPP access.
NOTE:	The registrations with different PLMNs over different Access Types doesn't apply to UE registered for Disaster Roaming service as described in the clause 5.40.
The PLMN selection for the 3GPP access does not depend on the PLMN that is used for non-3GPP access. In other words, if a UE is registered with a PLMN over a non-3GPP access, the UE performs PLMN selection for the 3GPP access independently of this PLMN.
A UE shall establish an IPsec tunnel with the N3IWF or with the TNGF in order to register with the 5G Core Network over non-3GPP access. Further details about the UE registration to 5G Core Network over untrusted non-3GPP access and over trusted non-3GPP access are described in clause 4.12.2 and in clause 4.12.2a of TS 23.502 [3], respectively.
It shall be possible to maintain the UE NAS signalling connection with the AMF over the non-3GPP access after all the PDU Sessions for the UE over that access have been released or handed over to 3GPP access.
N1 NAS signalling over non-3GPP accesses shall be protected with the same security mechanism applied for N1 over a 3GPP access.
User plane QoS differentiation between UE and N3IWF is supported as described in clause 5.7 and clause 4.12.5 of TS 23.502 [3]. QoS differentiation between UE and TNGF is supported as described in clause 5.7 and clause 4.12a.5 of TS 23.502 [3].
4.2.8.1A	General Concepts to support Wireline Access
Wireline 5G Access Network (W-5GAN) shall be connected to the 5G Core Network via a Wireline Access Gateway Function (W-AGF). The W-AGF interfaces the 5G Core Network CP and UP functions via N2 and N3 interfaces, respectively.
For the scenario of 5G-RG connected via NG RAN the specification for UE defined in this TS, TS 23.502 [3] and TS 23.503 [45] are applicable as defined for UE connected to 5GC via NG RAN unless differently specified in this TS and in TS 23.316 [84].
When a 5G-RG is connected via a NG-RAN and via a W-5GAN, multiple N1 instances shall exist for the 5G-RG i.e. there shall be one N1 instance over NG-RAN and one N1 instance over W-5GAN.
A 5G-RG simultaneously connected to the same 5G Core Network of a PLMN over a 3GPP access and a W-5GAN access shall be served by a single AMF in this 5G Core Network.
5G-RG shall maintain the NAS signalling connection with the AMF over the W-5GAN after all the PDU Sessions for the 5G-RG over that access have been released or handed over to 3GPP access.
The 5G-RG connected to 5GC via NG-RAN is specified in TS 23.316 [84].
For the scenario of FN-RG, which is not 5G capable, connected via W-5GAN to 5GC, the W-AGF provides the N1 interface to AMF on behalf of the FN-RG.
An UE connected to a 5G-RG or FN-RG can access to the 5GC via the N3IWF or via the TNGF where the combination of 5G-RG/FN-RG, W-AGF and UPF serving the 5G-RG or FN-RG is acting respectively as Untrusted Non-3GPP access network or as a Trusted Non-3GPP access network defined in clause 4.2.8.2; for example a UE is connecting to 5G-RG by means of WLAN radio access and connected to 5GC via N3IWF. The detailed description is specified in TS 23.316 [84].
The roaming architecture for 5G-BRG, FN-BRG, 5G-CRG and FN-CRG with the W-5GAN is not specified in this Release. The Home Routed roaming scenario is supported for 5G-RG connected via NG RAN, while Local Breakout scenario is not supported.
5G Multi-Operator Core Network (5G MOCN) is supported for 5G-RG connected via NG RAN as defined in clause 5.18

Figure 4.2.8.2.1-1: Non-roaming architecture for 5G Core Network with untrusted non-3GPP access

Figure 4.2.8.2.1-2: Non-roaming architecture for 5G Core Network with trusted non-3GPP access
NOTE 1:	The reference architecture in Figure 4.2.8.2.1-1 and in Figure 4.2.8.2.1-2 only shows the architecture and the network functions directly connected to non-3GPP access, and other parts of the architecture are the same as defined in clause 4.2.
NOTE 2:	The reference architecture in Figure 4.2.8.2.1-1 and in Figure 4.2.8.2.1-2 supports service based interfaces for AMF, SMF and other NFs not represented in the figure.
NOTE 3:	The two N2 instances in Figure 4.2.8.2.1-1 and in Figure 4.2.8.2.1-2 terminate to a single AMF for a UE which is simultaneously connected to the same 5G Core Network over 3GPP access and non-3GPP access.
NOTE 4	The two N3 instances in Figure 4.2.8.2.1-1 and in Figure 4.2.8.2.1-2 may terminate to different UPFs when different PDU Sessions are established over 3GPP access and non-3GPP access.

Figure 4.2.8.2.2-1: LBO Roaming architecture for 5G Core Network with untrusted non-3GPP access - N3IWF in the same VPLMN as 3GPP access

Figure 4.2.8.2.2-2: LBO Roaming architecture for 5G Core Network with untrusted non-3GPP access - N3IWF in a different PLMN from 3GPP access

Figure 4.2.8.2.2-3: LBO Roaming architecture for 5G Core Network with trusted non-3GPP access using the same VPLMN as 3GPP access

Figure 4.2.8.2.2-4: LBO Roaming architecture for 5G Core Network with trusted non-3GPP access using a different PLMN than 3GPP access
NOTE 1:	The reference architecture in all above figures only shows the architecture and the network functions directly connected to support non-3GPP access, and other parts of the architecture are the same as defined in clause 4.2.
NOTE 2:	The reference architecture in all above figures supports service based interfaces for AMF, SMF and other NFs not represented in the figures.
NOTE 3:	The two N2 instances in Figure 4.2.8.2.2-1 and in Figure 4.2.8.2.2-3 terminate to a single AMF for a UE which is connected to the same 5G Core Network over 3GPP access and non-3GPP access simultaneously.
NOTE 4:	The two N3 instances in Figure 4.2.8.2.2-1 and in Figure 4.2.8.2.2-3 may terminate to different UPFs when different PDU Sessions are established over 3GPP access and non-3GPP access.

Figure 4.2.8.2.3-1: Home-routed Roaming architecture for 5G Core Network with untrusted non-3GPP access - N3IWF in the same VPLMN as 3GPP access

Figure 4.2.8.2.3-2: Home-routed Roaming architecture for 5G Core Network with untrusted non-3GPP access - N3IWF in a different VPLMN than 3GPP access

Figure 4.2.8.2.3-3: Home-routed Roaming architecture for 5G Core Network with untrusted non-3GPP access - N3IWF in HPLMN

Figure 4.2.8.2.3-4: Home-routed Roaming architecture for 5G Core Network with trusted non-3GPP access using the same VPLMN as 3GPP access
NOTE 1:	The reference architecture in all above figures only shows the architecture and the network functions directly connected to support non-3GPP access, and other parts of the architecture are the same as defined in clause 4.2.
NOTE 2:	The two N2 instances in Figure 4.2.8.2.3-1 and in Figure 4.2.8.2.3-4 terminate to a single AMF for a UE which is connected to the same 5G Core Network over 3GPP access and non-3GPP access simultaneously.
The description of the reference points specific for the non-3GPP access:
N2, N3, N4, N6: these are defined in clause 4.2.
Y1	Reference point between the UE and the untrusted non-3GPP access (e.g. WLAN). This depends on the non-3GPP access technology and is outside the scope of 3GPP.
Y2	Reference point between the untrusted non-3GPP access and the N3IWF for the transport of NWu traffic.
Y4	Reference point between the 5G-RG and the W-AGF which transports the user plane traffic and the N1 NAS protocol. The definition of this interface is outside the scope of 3GPP.
Y5	Reference point between the FN-RG and the W-AGF. The definition of this interface is outside the scope of 3GPP.
Yt	Reference point between the UE and the TNAP. See e.g. Figure 4.2.8.2.1-2.
Yt'	Reference point between the N5CW devices and the TWAP. It is defined in clause 4.2.8.5.
NWu	Reference point between the UE and N3IWF for establishing secure tunnel(s) between the UE and N3IWF so that control-plane and user-plane exchanged between the UE and the 5G Core Network is transferred securely over untrusted non-3GPP access.
NWt	Reference point between the UE and the TNGF. A secure NWt connection is established over this reference point, as specified in clause 4.12a.2.2 of TS 23.502 [3]. NAS messages between the UE and the AMF are transferred via this NWt connection.
Ta	A reference point between the TNAP and the TNGF, which is used to support an AAA interface. Ta requirements are documented in clause 4.2.8.3.2.
Tn	A reference point between two TNGFs, which is used to facilitate UE mobility between different TNGFs (inter-TNGF mobility).
Tn and inter-TNGF mobility are not specified in this Release of the specification.
Ta shall be able to
-	Carry EAP-5G traffic and user location information before the NWt connection is established between the UE and the TNGF.
-	Allow the UE and the TNGF to exchange IP traffic.
In deployments where the TNAP does not allocate the local IP addresses to UE(s), Ta shall be able to:
-	Allow the UE to request and receive IP configuration from the TNAN (including a local IP address), e.g. with DHCP. This is to allow the UE to use an IP stack to establish a NWt connection between the UE and the TNGF.
NOTE:	The "local IP address" is the IP address that allows the UE to contact the TNGF; the entity providing this local IP address is part of TNAN and out of 3GPP scope
In this Release of the specification, Ta is not specified.

Figure 4.2.8.4-1: Non- roaming architecture for 5G Core Network for 5G-RG with Wireline 5G Access network and NG RAN
The 5G-RG can be connected to 5GC via W-5GAN, NG RAN or via both accesses.
NOTE 1:	The reference architecture in figure 4.2.8.4-1 only shows the architecture and the network functions directly connected to Wireline 5G Access Network, and other parts of the architecture are the same as defined in clause 4.2.
NOTE 2:	The reference architecture in figure 4.2.8.4-1 supports service based interfaces for AMF, SMF and other NFs not represented in the figure.
NOTE 3:	The two N2 instances in Figure 4.2.8.4-1 apply to a single AMF for a 5G-RG which is simultaneously connected to the same 5G Core Network over 3GPP access and Wireline 5G Access Network.
NOTE 4	The two N3 instances in Figure 4.2.8. 4-1 may apply to different UPFs when different PDU Sessions are established over 3GPP access and Wireline 5G Access Network.

Figure 4.2.8.4-2: Non- roaming architecture for 5G Core Network for FN-RG with Wireline 5G Access network and NG RAN
The N1 for the FN-RG, which is not 5G capable, is terminated on W-AGF which acts on behalf of the FN-RG.
The FN-RG can only be connected to 5GC via W-5GAN.
NOTE 5:	The reference architecture in figure 4.2.8.4-2 only shows the architecture and the network functions directly connected to Wireline 5G Access Network, and other parts of the architecture are the same as defined in clause 4.2.
NOTE 6:	The reference architecture in figure 4.2.8.4-1 supports service based interfaces for AMF, SMF and other NFs not represented in the figure.
The devices that do not support 5GC NAS signalling over WLAN access are referred to as "Non-5G-Capable over WLAN" devices, or N5CW devices for short. A N5CW device is not capable to operate as a 5G UE that supports 5GC NAS signalling over a WLAN access network, however, it may be capable to operate as a 5G UE over NG-RAN.
Clause 4.2.8.5 specifies the 5GC architectural enhancements that enable N5CW devices to access 5GC via trusted WLAN access networks. A trusted WLAN access network is a particular type of a Trusted Non-3GPP Access Network (TNAN) that supports a WLAN access technology, e.g. IEEE 802.11. Not all trusted WLAN access networks support 5GC access from N5CW devices. To support 5GC access from N5CW devices, a trusted WLAN access network must support the special functionality specified below (e.g. it must support a TWIF function).
When a N5CW device performs an EAP-based access authentication procedure to connect to a trusted WLAN access network, the N5CW device may simultaneously be registered to a 5GC of a PLMN or SNPN. The 5GC registration is performed by the TWIF function (see next clause) in the trusted WLAN access network, on behalf of the N5CW device. The type of EAP authentication procedure, which is used during the 5GC registration to authenticate the N5CW device, is specified in TS 33.501 [29]. In this Release of the specification, Trusted WLAN Access for N5CW Device only supports IP PDU Session type.
The architecture diagram in Figure 4.2.8.5.2-1 is based on the general 5GS architecture diagrams in clause 4.2 and shows the main network functions required to support 5GC access from N5CW devices. Other network functions are not shown for simplicity.

Figure 4.2.8.5.2-1: Non-roaming and LBO Roaming Architecture for supporting 5GC access from N5CW devices
The reference architecture in Figure 4.2.8.5.2-1 also supports N5CW device access to the subscribed SNPN or access to the SNPN with credentials owned by Credentials Holder. Other parts of the architecture are the same as defined in clause 5.30.2.9.
Trusted WLAN Access Point (TWAP): It is a particular type of a Trusted Non-3GPP Access Point (TNAP) specified in clause 4.2.8.2, that supports a WLAN access technology, e.g. IEEE 802.11. This function is outside the scope of the 3GPP specifications.
Trusted WLAN Interworking Function (TWIF): It provides interworking functionality that enables N5CW devices to access 5GC. The TWIF supports the following functions:
-	Terminates the N1, N2 and N3 interfaces.
-	Implements the AMF selection procedure.
-	Implements the NAS protocol stack and exchanges NAS messages with the AMF on behalf of the N5CW device.
-	On the user plane, it relays protocol data units (PDUs) between the Yw interface and the N3 interface.
-	May implement a local mobility anchor within the trusted WLAN access network.
The Yt' and Yw reference points are both outside the scope of the 3GPP specifications. The Yt' reference point transports WLAN messages (e.g. IEEE 802.11 messages), while the Yw reference point:
-	Shall be able to transport authentication messages between the TNAP and the TWIF for enabling authentication of a N5CW device;
-	Shall allow the N5CW device to request and receive IP configuration from the TWIF, including an IP address, e.g. with DHCP.
-	Shall support the transport of user-plane traffic for the N5CW device.
The N1, N2 and N3 reference points are the same reference points defined in clause 4.2.7.
The Network Analytics architecture is defined in TS 23.288 [86].
In order to support the ATSSS feature, the 5G System Architecture is extended as shown in Figure 4.2.10-1, Figure 4.2.10-2 and Figure 4.2.10-3. The additional functionality that is supported by the UE and the network functions shown in these figures is specified in clause 5.32 below. In summary:
-	The UE supports one or more of the steering functionalities specified in clause 5.32.6, i.e. the MPTCP functionality, the MPQUIC functionality and the ATSSS-LL functionality. Each steering functionality in the UE enables traffic steering, switching and splitting across 3GPP access and non-3GPP access, in accordance with the ATSSS rules provided by the network. The ATSSS-LL functionality is mandatory in the UE for MA PDU Session of type Ethernet.
-	The UPF may support the MPTCP Proxy functionality, which communicates with the MPTCP functionality in the UE by using the MPTCP protocol (IETF RFC 8684 [81]), as defined in clause 5.32.6.2.1.
-	The UPF may support the MPQUIC Proxy functionality, which communicates with the MPQUIC functionality in the UE by using the QUIC protocol (RFC 9000 [166], RFC 9001 [167], RFC 9002 [168]) and its multipath extensions (draft-ietf-quic-multipath [174]), as defined in clause 5.32.6.2.2.
-	The UPF may support ATSSS-LL functionality, which is similar to the ATSSS-LL functionality defined for the UE. There is no user plane protocol defined between the ATSSS-LL functionality in the UE and the ATSSS-LL functionality in the UPF. The ATSSS-LL functionality in the UPF is not shown in the following three figures.
NOTE 1:	ATSSS-LL functionality is needed in the 5GC for MA PDU Session of type Ethernet.
-	In addition, the UPF supports Performance Measurement Functionality (PMF), which may be used by the UE to obtain access performance measurements (see clause 5.32.5) over the user-plane of 3GPP access and/or over the user-plane of non-3GPP access.
-	The AMF, SMF and PCF are extended with new functionality that is further discussed in clause 5.32.

Figure 4.2.10-1: Non-roaming and Roaming with Local Breakout architecture for ATSSS support
NOTE 2:	The interactions between the UE and PCF that may be required for ATSSS control are specified in TS 23.503 [45].
NOTE 3:	The UPF shown in Figure 4.2.10-1 can be connected via an N9 reference point, instead of the N3 reference point.
Figure 4.2.10-2 shows the 5G System Architecture for ATSSS support in a roaming case with home-routed traffic and when the UE is registered to the same VPLMN over 3GPP and non-3GPP accesses. In this case, the MPTCP Proxy functionality, the MPQUIC Proxy functionality and the PMF are located in the H-UPF.

Figure 4.2.10-2: Roaming with Home-routed architecture for ATSSS support (UE registered to the same VPLMN)
Figure 4.2.10-3 shows the 5G System Architecture for ATSSS support in a roaming case with home-routed traffic and when the UE is registered to a VPLMN over 3GPP access and to HPLMN over non-3GPP access (i.e. the UE is registered to different PLMNs). In this case, the MPTCP Proxy functionality, the MPQUIC functionality and the PMF are located in the H-UPF.

Figure 4.2.10-3: Roaming with Home-routed architecture for ATSSS support (UE registered to different PLMNs)
The architecture for 5G multicast-broadcast services is defined in TS 23.247 [129].
The architecture for Proximity based Services (ProSe) in the 5G System is defined in TS 23.304 [128].
The architecture enhancements for edge computing are outlined in clause 5.13 and further described in TS 23.548 [130].
The architecture for Support of Uncrewed Aerial Systems (UAS) connectivity, identification and tracking is defined in TS 23.256 [136].
The reference architecture shown with reference point representation in Figure 4.2.15-1 and with Service Based Interface (SBI)-representation in Figure 4.2.15-2, enables a UE to connect to a WLAN access network using its 5GS credentials without registration to 5GS. This architecture is based on the Non-Seamless WLAN Offload Function (NSWOF), which interfaces to the WLAN access network using the SWa' reference point and interfaces to the AUSF using the Nausf SBI. The SWa' reference point corresponds to SWa reference point as defined in TS 23.402 [43] with the difference that SWa' the EAP procedure ensures that the permanent user ID is not visible over the access as defined in TS 33.501 [29] and that SWa' connects the Untrusted non-3GPP IP Access, possibly via 3GPP AAA Proxy, to the NSWOF and that the EAP user ID is a SUCI and not an IMSI.
The functionality of the NSWOF and the procedures applied for supporting a WLAN connection using 5GS credentials for Non-seamless WLAN offload are further defined in TS 33.501 [29] Annex S. The roaming architectures are shown with reference point representation in Figure 4.2.15-3 and with SBI representation in Figure 4.2.15-4. The architecture in Figure 4.2.15-1 and Figure 4.2.15-2 applies to UEs with PLMN or SNPN credentials.
NOTE 1:	For a UE with SNPN credentials it is assumed that the realm part of UE identifier in SUCI format is defined in a way that enables routing of SWa requests from the WLAN AN to the NSWOF in the SNPN's 5GC.
The architectures in Figure 4.2.15-3a and Figure 4.2.15-4a apply to UEs with PLMN or SNPN credentials from a CH using UDM.
The architecture in Figure 4.2.15-3b applies to UEs with SNPN credentials from a CH using AAA Server. In this architecture the UE procedures for access selection for 5G NSWO defined in clause 6.3.12b apply. Except the UE, all NFs in Figure 4.2.15-3b are out of scope of 3GPP.
NOTE 2:	How to protect the user identity over the WLAN interface in architecture defined in Figure 4.2.15-3b is defined in TS 33.501 [29].
The UE can also connect to a WLAN access network using 5GS credentials by performing the 5GS registration via Trusted non-3GPP access procedure defined in clause 4.12a.2.2 of TS 23.502 [3]. With this procedure, the UE connects to a WLAN access network using 5GS credentials and simultaneously registers in 5GS. However, the architecture defined in Figure 4.2.15-1, Figure 4.2.15-2, Figure 4.2.15-3 and in Figure 4.2.15-4, enables a UE to connect to a WLAN access network using 5GS credentials but without registration in 5GS.
If the WLAN is configured as Untrusted Non-3GPP access, in the case that the WLAN supports IEEE 802.1x, the UE may first use the 5G NSWO procedure to obtain a connection with and the local IP address from the WLAN, and any time after that, the UE may initiate the Untrusted Non-3GPP Access to obtain the access to 5GC.

Figure 4.2.15-1: Reference architecture to support authentication for Non-seamless WLAN offload in 5GS

Figure 4.2.15-2: Service based reference architecture to support authentication for Non-seamless WLAN offload in 5GS

Figure 4.2.15-3: Roaming reference architectures to support authentication for Non-seamless WLAN offload in 5GS

Figure 4.2.15-3a: Reference architectures to support authentication for Non-seamless WLAN offload using credentials from Credentials Holder using UDM

Figure 4.2.15-3b: Reference architectures to support authentication for Non-seamless WLAN offload using credentials from Credentials Holder using AAA Server
NOTE 2:	Configuration 2) in Figure 4.2.15-3 and Figure 4.2.15-3a is a deployment variant of configuration 1)

Figure 4.2.15-4: Service based Roaming reference architecture to support authentication for Non-seamless WLAN offload in 5GS
The SWd' reference point corresponds to the SWd reference point as defined in TS 23.402 [43] with the difference that SWd' connects the 3GPP AAA Proxy, possibly via intermediate 3GPP AAA Proxy, to the NSWOF and that the EAP user ID is a SUCI and not an IMSI.
In both roaming and non-roaming scenarios, the NSWOF acts towards the WLAN Access as a 3GPP AAA server, with the difference that the EAP user ID is a SUCI and not an IMSI.

Figure 4.2.15-4a: Service based reference architecture to support authentication for Non-seamless WLAN offload using credentials from Credentials Holder using UDM
As depicted in Figure 4.2.16-1, the 5G System architecture allows user plane information exposure to some NFs via service-based interface in UPF.

Figure 4.2.16-1: Architecture to support User Plane Information Exposure via a service-based interface
NOTE 1:	In this Release of the specification, only NWDAF/DCCF/MFAF, NEF/AF and TSNAF/TSCTSF are considered as the receiver of the UPF event notifications.
NOTE 2:	UPF exposure is not restricted to SBI interface, i.e. reporting via PFCP over N4 to SMF is still applicable.
Not all events can be subscribed to UPF directly. The details and constraints for the subscription (i.e. direct vs. indirect) and the UPF-related information that is exposed to certain NFs via subscriptions, as well as the information contained in the event notifications, are defined in clause 5.2.26.2 of TS 23.502 [3].
The architecture for Ranging based services and Sidelink Positioning is defined in TS 23.586 [180].
Figure 4.3.1-1 represents the non-roaming architecture for interworking between 5GS and EPC/E-UTRAN.

Figure 4.3.1-1: Non-roaming architecture for interworking between 5GS and EPC/E-UTRAN
NOTE 1:	N26 interface is an inter-CN interface between the MME and 5GS AMF in order to enable interworking between EPC and the NG core. Support of N26 interface in the network is optional for interworking. N26 supports subset of the functionalities (essential for interworking) that are supported over S10.
NOTE 2:	PGW-C + SMF and UPF + PGW-U are dedicated for interworking between 5GS and EPC, which are optional and are based on UE MM Core Network Capability and UE subscription. UEs that are not subject to 5GS and EPC interworking may be served by entities not dedicated for interworking, i.e. by either by PGW or SMF/UPF.
NOTE 3:	There can be another UPF (not shown in the figure above) between the NG-RAN and the UPF + PGW-U, i.e. the UPF + PGW-U can support N9 towards an additional UPF, if needed.
NOTE 4: Figures and procedures in this specification that depict an SGW make no assumption whether the SGW is deployed as a monolithic SGW or as an SGW split into its control-plane and user-plane functionality as described in TS 23.214 [32].
Figure 4.3.2-1 represents the Roaming architecture with local breakout and Figure 4.3.2-2 represents the Roaming architecture with home-routed traffic for interworking between 5GS and EPC/E-UTRAN.

Figure 4.3.2-1: Local breakout roaming architecture for interworking between 5GS and EPC/E-UTRAN
NOTE 1:	There can be another UPF (not shown in the figure above) between the NG-RAN and the UPF + PGW-U, i.e. the UPF + PGW-U can support N9 towards the additional UPF, if needed.
NOTE 2:	S9 interface from EPC is not required since no known deployment exists.

Figure 4.3.2-2: Home-routed roaming architecture for interworking between 5GS and EPC/E-UTRAN
Figure 4.3.3-1 represents the non-roaming architecture for interworking between 5GC via non-3GPP access and EPC/E-UTRAN.

Figure 4.3.3.1-1: Non-roaming architecture for interworking between 5GC via non-3GPP access and EPC/E-UTRAN
NOTE 1:	There can be another UPF (not shown in the figure above) between the N3IWF/TNGF and the UPF + PGW-U, i.e. the UPF + PGW-U can support N9 towards an additional UPF, if needed.
NOTE 2:	N26 interface is not precluded, but it is not shown in the figure because it is not required for the interworking between 5GC via non-3GPP access and EPC/E-UTRAN.
Figure 4.3.3.2-1 represents the Roaming architecture with local breakout and Figure 4.3.3.2-2 represents the Roaming architecture with home-routed traffic for interworking between 5GC via non-3GPP access and EPC/E-UTRAN.

Figure 4.3.3.2-1: Local breakout roaming architecture for interworking between 5GC via non-3GPP access and EPC/E-UTRAN
NOTE 1:	There can be another UPF (not shown in the figure above) between the N3IWF/TNGF and the UPF + PGW-U, i.e. the UPF + PGW-U can support N9 towards the additional UPF, if needed.
NOTE 2:	S9 interface from EPC is not required since no known deployment exists.
NOTE 3:	N26 interface is not precluded, but it not shown in the figure because it is not required for the interworking between 5GC via non-3GPP access and EPC/E-UTRAN.

Figure 4.3.3.2-2: Home-routed roaming architecture for interworking between 5GC via non-3GPP access and EPC/E-UTRAN
NOTE 4:	N26 interface is not precluded, but it not shown in the figure because it is not required for the interworking between 5GC via non-3GPP access and EPC/E-UTRAN.
Figure 4.3.4.1-1 represents the non-roaming architecture for interworking between ePDG/EPC and 5GS.

Figure 4.3.4.1-1: Non-roaming architecture for interworking between ePDG/EPC and 5GS
NOTE 1:	The details of the interfaces between the UE and the ePDG, and between EPC nodes (i.e. SWm, SWx, S2b and S6b), are documented in TS 23.402 [43].
NOTE 2:	Interworking with ePDG is only supported with GTP based S2b. S6b interface is optional (see clause 4.11.4.3.6 of TS 23.502 [3]).
Figure 4.3.4.2-1 represents the Roaming architecture with local breakout and Figure 4.3.4.2-2 represents the Roaming architecture with home-routed traffic for interworking between ePDG/EPC and 5GS.

Figure 4.3.4.2-1: Local breakout roaming architecture for interworking between ePDG/EPC and 5GS
NOTE 1:	The details of the interfaces between the UE and the ePDG, and between EPC nodes (i.e. SWm, SWd, SWx, S2b and S6b), are documented in TS 23.402 [43].
NOTE 2:	Interworking with ePDG is only supported with GTP based S2b. S6b interface is optional (see clause 4.11.4.3.6 of TS 23.502 [3]).

Figure 4.3.4.2-2: Home-routed roaming architecture for interworking between ePDG/EPC and 5GS
NOTE 1:	The details of the interfaces between the UE and the ePDG, and between EPC nodes (i.e. SWm, SWd, SWx, S2b and S6b), are documented in TS 23.402 [43].
NOTE 2:	Interworking with ePDG is only supported with GTP based S2b. S6b interface is optional (see clause 4.11.4.3.6 of TS 23.502 [3]).
Figure 4.3.5.1-1 shows the non-roaming architecture for Service Exposure for EPC-5GC Interworking. If the UE is capable of mobility between EPS and 5GS, the network is expected to associate the UE with an SCEF+NEF node for Service Capability Exposure.

Figure 4.3.5.1 1: Non-roaming Service Exposure Architecture for EPC-5GC Interworking
NOTE 1:	In Figure 4.3.5.1-1, Trust domain for SCEF+NEF is same as Trust domain for SCEF as defined in TS 23.682 [36].
NOTE 2:	In Figure 4.3.5.1-1, EPC Interface represents southbound interfaces between SCEF and EPC nodes e.g. the S6t interface between SCEF and HSS, the T6a interface between SCEF and MME, etc. All southbound interfaces from SCEF are defined in TS 23.682 [36] and are not shown for the sake of simplicity.
NOTE 3:	In Figure 4.3.5.1-1, 5GC Interface represents southbound interfaces between NEF and 5GC Network Functions e.g. N29 interface between NEF and SMF, N30 interface between NEF and PCF, etc. All southbound interfaces from NEF are not shown for the sake of simplicity.
NOTE 4:	Interaction between the SCEF and NEF within the combined SCEF+NEF is required. For example, when the SCEF+NEF supports monitoring APIs, the SCEF and NEF need to share context and state information on a UE's configured monitoring events if the UE moves between from EPC and 5GC.
NOTE 5:	The north-bound APIs which can be supported by an EPC or 5GC network are discovered by the SCEF+NEF node via the CAPIF function and/or via local configuration of the SCEF+NEF node. Different sets of APIs can be supported by the two network types.
Figure 4.3.5.2-1 represents the roaming architecture for Service Exposure for EPC-5GC Interworking. This architecture is applicable to both the home routed roaming and local breakout roaming.

Figure 4.3.5.2-1: Roaming Service Exposure Architecture for EPC-5GC Interworking
NOTE:	Figure 4.3.5.2-1 does not include all the interfaces, and network elements or network functions that may be connected to SCEF+NEF.
The Public Warning System architecture for 5G System is specified in TS 23.041 [46].
This clause introduces legacy SMS over NAS architecture, in which the interfaces between SMSF/UDM and SMS-GMSC/SMS-IWMSC/IP-SM-GW/SMS Router are still based on legacy protocol (i.e. MAP or Diameter).
The SBI-based SMS architecture and interfaces are specified in TS 23.540 [142].
Figure 4.4.2.1-1 shows the non-roaming architecture to support SMS over NAS using the Service-based interfaces within the Control Plane.

Figure 4.4.2.1-1: Non-roaming System Architecture for SMS over NAS
Figure 4.4.2.1-2 shows the non-roaming architecture to support SMS over NAS using the reference point representation.

Figure 4.4.2.1-2: Non-roaming System Architecture for SMS over NAS in reference point representation
NOTE 1:	SMS Function (SMSF) may be connected to the SMS-GMSC/IWMSC/SMS Router via one of the standardized interfaces as shown in TS 23.040 [5].
NOTE 2:	UDM may be connected to the SMS-GMSC/IWMSC/SMS Router via one of the standardized interfaces as shown in TS 23.040 [5].
NOTE 3:	Each UE is associated with only one SMS Function in the registered PLMN.
NOTE 4:	SMSF re-allocation while the UE is in RM-REGISTERED state in the serving PLMN is not supported in this Release of the specification. When serving AMF is re-allocated for a given UE, the source AMF includes SMSF identifier as part of UE context transfer to target AMF. If the target AMF, e.g. in the case of inter-PLMN mobility, detects that no SMSF has been selected in the serving PLMN, then the AMF performs SMSF selection as specified in clause 6.3.10.
NOTE 5:	To support MT SMS domain selection by IP-SM-GW/SMS Router, IP-SM-GW/SMS Router may connect to SGs MSC, MME and SMSF via one of the standardized interfaces as shown in TS 23.040 [5].
Figure 4.4.2.1-3 shows the roaming architecture to support SMS over NAS using the Service-based interfaces within the Control Plane.

Figure 4.4.2.1-3: Roaming architecture for SMS over NAS
Figure 4.4.2.1-4 shows the roaming architecture to support SMS over NAS using the reference point representation.

Figure 4.4.2.1-4: Roaming architecture for SMS over NAS in reference point representation
N1:	Reference point for SMS transfer between UE and AMF via NAS.
Following reference points are realized by service based interfaces:
N8:	Reference point for SMS Subscription data retrieval between AMF and UDM.
N20:	Reference point for SMS transfer between AMF and SMS Function.
N21:	Reference point for SMS Function address registration management and SMS Management Subscription data retrieval between SMS Function and UDM.
Nsmsf:	Service-based interface exhibited by SMSF.
IMS support for 5GC is defined in TS 23.228 [15].
The 5G System architecture supports N5 interface between PCF and P-CSCF and supports Rx interface between PCF and P-CSCF, to enable IMS service. See TS 23.228 [15], TS 23.503 [45] and TS 23.203 [4].
NOTE 1:	Rx support between PCF and P-CSCF is for backwards compatibility for early deployments using Diameter between IMS and 5GC functions.
NOTE 2:	When service based interfaces are used between the PCF and P-CSCF in the same PLMN, the P-CSCF performs the functions of a trusted AF in the 5GC.
Location Service feature is optional and applicable to both regulatory services and commercial services in this Release of the specification. The non-roaming and roaming architecture to support Location Services are defined in clause 4.2 of TS 23.273 [87].
The reference points to support Location Services are defined in clause 4.4 of TS 23.273 [87].
The Service Based Interfaces to support Location Services are defined in clause 4.5 of TS 23.273 [87].
See clause 5.2.6.1 of TS 23.502 [3].
Application trigger message contains information that allows the network to route the message to the appropriate UE and the UE to route the message to the appropriate application. The information destined to the application, excluding the information to route it, is referred to as the Trigger payload. The Trigger payload is implementation specific.
NOTE:	The application in the UE may perform actions indicated by the Trigger payload when the Triggered payload is received at the UE. For example initiation of immediate or later communication with the application server based on the information contained in the Trigger payload, which includes the PDU Session Establishment procedure if the related PDU Session is not already established.
The general User Plane architectures described in clause 4.2.3 and clause 4.2.4 apply to 5G LAN-type services, with the additional options described in this clause.
Figure 4.4.6.1-1 depicts the non-roaming user plane architecture to support 5G LAN-type service using local switch.

Figure 4.4.6.1-1: Local-switch based user plane architecture in non-roaming scenario
Figure 4.4.6.1-2 depicts the non-roaming user plane architecture to support 5G LAN-type service using N19 tunnel.

Figure 4.4.6.1-2: N19-based user plane architecture in non-roaming scenario
NOTE:	As described in clause 5.29.3, the PSA UPFs can be controlled by a dedicated SMF, a dedicated SMF Set or multiple SMF Sets.
N19:	Reference point between two UPFs for direct routing of traffic between different PDU Sessions without using N6. It has a per 5G VN group granularity.
MSISDN-less MO SMS via T4 is subscription based. The subscription provides the information whether a UE is allowed to originate MSISDN-less MO SMS.
The UE is pre-configured with the Service Centre address that points to SMS-SC that performs this MO SMS delivery via NEF delivery procedure. The recipient of this short message is set to the pre-configured address of the AF (i.e. Address of the destination SME). If UE has multiple GPSIs associated to the same IMSI, the GPSI that is associated with an SMS may be determined from the UE's IMSI and the Application Port ID value in the TP-User-Data field (see TS 23.040 [5]). The NEF may obtain the GPSI by querying the UDM with the IMSI and application port ID.
UE is aware whether the MO SMS delivery status (success or fail) based on the SMS delivery report from SMS-SC. The network does not perform any storing and forwarding functionality for MO SMS.
See clause 5.2.6 of TS 23.502 [3] for a description of NEF Services and Service Operations.
The 5G System can be extended to support the following:
a)	Integration of 5GS into a TSN data network (DN): Integration as a bridge in an IEEE 802.1 Time Sensitive Networking (TSN). The 5GS bridge supports the Time sensitive communication as defined in IEEE 802.1 Time Sensitive Networking (TSN) standards. The architecture is described in clause 4.4.8.2.
	This Release supports of the specification, integration of the 5G System with IEEE 802.1 TSN networks that apply the fully centralized configuration model as defined in IEEE Std 802.1Q [98]. IEEE TSN is a set of standards to define mechanisms for the time-sensitive (i.e. deterministic) transmission of data over Ethernet networks.
b)	Enablers for AF requested support of Time Synchronization and/or some aspects of Time Sensitive Communication. The architecture is described in clause 4.4.8.3.
c)	Support for TSN enabled transport network (TN): Enablers for interworking with TSN network deployed in the transport network. This option can be used simultaneously with either option a) or b). The architecture is described in clause 5.28a. The interworking is applicable when the transport network deploys the fully centralized configuration model as defined in IEEE Std 802.1Q [98]. In this scenario, a TSN TN is deployed to realize the N3 interface between (R)AN and UPF. From the perspective of the TSN TN, (R)AN and UPF act as End Stations of the TSN TN.
d)	Integration as a router in a Deterministic Network as defined in IETF RFC 8655 [150]. The architecture is described in clause 4.4.8.4.
The 5G System is integrated with the external network as a TSN bridge. This "logical" TSN bridge (see Figure 4.4.8.2-1) includes TSN Translator functionality for interoperation between TSN Systems and 5G System both for user plane and control plane. 5GS TSN translator functionality consists of Device-side TSN translator (DS-TT) and Network-side TSN translator (NW-TT). The TSN AF is part of 5GC and provides the control plane translator functionality for the integration of the 5GS with a TSN network, e.g. the interactions with the CNC. 5G System specific procedures in 5GC and RAN, wireless communication links, etc. remain hidden from the TSN network. To achieve such transparency to the TSN network and the 5GS to appear as any other TSN Bridge, the 5GS provides TSN ingress and egress ports via DS-TT and NW-TT. DS-TT and NW-TT optionally support:
-	hold and forward functionality for the purpose of de-jittering;
-	per-stream filtering and policing as defined in clause 8.6.5.2.1 of IEEE Std 802.1Q [98].
DS-TT optionally supports link layer connectivity discovery and reporting as defined in IEEE Std 802.1AB [97] for discovery of Ethernet devices attached to DS-TT. NW-TT supports link layer connectivity discovery and reporting as defined in IEEE Std 802.1AB [97] for discovery of Ethernet devices attached to NW-TT. If a DS-TT does not support link layer connectivity discovery and reporting, then NW-TT performs link layer connectivity discovery and reporting as defined in IEEE Std 802.1AB [97] for discovery of Ethernet devices attached to DS-TT on behalf of DS-TT.
NOTE 1:	If NW-TT performs link layer connectivity discovery and reporting on behalf of DS-TT, it is assumed that LLDP frames are transmitted between NW-TT and UE on the QoS Flow with the default QoS rule as defined in the clause 5.7.1.1. Alternatively, SMF can establish a dedicated QoS Flow matching on the Ethertype defined for LLDP (IEEE Std 802.1AB [97]).
There are three TSN configuration models defined in IEEE Std 802.1Q [98]. Amongst the three models:
-	fully centralized model is supported in this Release of the specification;
-	fully distributed model is not supported in this Release of the specification;
-	centralized network/distributed user model is not supported in this Release of the specification.
NOTE 2:	This Release supports interworking with TSN using clause 8.6.8.4 of IEEE Std 802.1Q [98] scheduled traffic and clause 8.6.5.2.1 of IEEE Std 802.1Q [98] per-stream filtering and policy.

Figure 4.4.8.2-1: System architecture view with 5GS appearing as TSN bridge
NOTE 3:	Whether DS-TT and UE are combined or are separate is up to implementation.
NOTE 4:	TSN AF does not need to support N33 in this release of the specification.
This clause describes the architecture to enable Time Sensitive Communication AF requested time sensitive communication and time synchronization services. The Time Sensitive Communication and Time Synchronization related features that are supported based on AF request are described in clauses 5.27.1 and 5.27.2, respectively. Figure 4.4.8.3-1 shows the architecture to support Time Sensitive Communication and Time Synchronization services.
As shown in Figure 4.4.8.3-1, to support Time Synchronization service based on IEEE Std 802.1AS [104] or IEEE Std 1588 [126] for Ethernet or IP type PDU Sessions, the DS-TT, NW-TT and Time Sensitive Communication and Time Synchronization Function (TSCTSF) are required in order to support the features in IEEE Std 802.1AS [104] or IEEE Std 1588 [126] as described in clause 5.27. The NEF exposes 5GS capability to support Time Synchronization service as described in clause 5.27.1.8. TSCTSF controls the DS-TT(s) and NW-TT for the (g)PTP based time synchronization service. In addition, TSCTSF supports TSC assistance container related functionalities.

Figure 4.4.8.3-1: Architecture to enable Time Sensitive Communication and Time Synchronization services
NOTE 1:	If the AF is considered to be trusted by the operator, the AF could interact directly with TSCTSF, the connection between AF and TSCTSF is not depicted in the architecture diagram for brevity.
UPF/NW-TT distributes the (g)PTP messages as described in clause 5.27.1.
When the UPF supports one or more NW-TT(s), there is one-to-one association between an NW-TT and the network instance or between an NW-TT and network instance together with DNN/S-NSSAI in the UPF. When there are multiple network instances within a UPF, each network instance is considered logically separate. The network instance for the N6 interface (clause 5.6.12) may be indicated by the SMF to the UPF for a given PDU Session during PDU Session establishment procedure. UPF allocates resources based on the Network Instance and S-NSSAI and it is supported according to TS 29.244 [65]. DNN/S-NSSAI may be indicated by the SMF together with the network instance to the UPF for a given PDU Session during PDU Session establishment procedure.
NOTE 2:	The same NW-TT is used for all PDU Sessions in the UPF for the given DNN/S-NSSAI; the NW-TT is unique per DNN/S-NSSAI. This ensures that the UPF selects an N4 session associated with the correct TSCTSF when the NW-TT initiates an UMIC or PMIC. At any given time, the NW-TT is associated with a single TSCTSF.
The 5G System is integrated with the Deterministic Network as defined in IETF RFC 8655 [150] as a logical DetNet transit router, see Figure 4.4.8.4-1. The TSCTSF performs mapping in the control plane between the 5GS internal functions and the DetNet controller. 5G System specific procedures in 5GC and RAN remain hidden from the DetNet controller.

Figure 4.4.8.4-1: 5GS Architecture to support IETF Deterministic Networking
On the device side, the UE is connected with a DetNet system, which may be a DetNet End System or a DetNet Node.
The architecture does not require the DS-TT functionality to be supported in the device nor require the user plane NW-TT functionality to be supported in the UPF, however, it can co-exist with such functions. For the reporting of information of the network side ports, NW-TT control plane function is used. The architecture can be combined with architecture in clause 4.4.8.3 to support time synchronization and TSC.
DetNet may be used in combination with time synchronization mechanisms as defined in clause 5.27, but it does not require usage of these mechanisms.
5GS acts as a DetNet router in the DetNet domain. Use cases where the 5GS acts as a sub-network (see clause 4.1.2 of IETF RFC 8655 [150]) are also possible but do not require any additional 3GPP standardization. A special case where the 5GS can act as a sub-network is when the 5GS acts as a TSN network, which is supported by the 3GPP specifications based on the architecture in clause 4.4.8.2.
NOTE:	For DetNet interworking, it is assumed that there is a business agreement to support the use of the DetNet controller so that it can be regarded trusted for the operator. Depending on the needs of a given deployment, functions such as the authentication, authorization and potential throttling of signalling from the DetNet controller can be achieved by including such functionalities in the TSCTSF.
The routing of the downlink packets is achieved using the existing 3GPP functions.
5	High level features
Clause 5 specifies the high level functionality and features of the 5G System for both 3GPP and Non-3GPP access and for the interoperability with the EPC defined in TS 23.401 [26].
Network access is the means for the user to connect to 5G CN. Network access control comprises the following functionality:
-	Network selection,
-	Identification and authentication,
-	Authorisation,
-	Access control and barring,
-	Policy control,
-	Lawful Interception.
In order to determine to which PLMN to attempt registration, the UE performs network selection. The network selection procedure comprises two main parts, PLMN selection and access network selection. The requirements for the PLMN selection are specified in TS 22.011 [25] and the procedures are in TS 23.122 [17]. The access network selection part for the 3GPP access networks is specified in TS 36.300 [30] for E-UTRAN and in TS 38.300 [27] for the NR.
The network selection for the Disaster Roaming is described in TS 23.122 [17] and TS 24.501 [47].
5.2.2a	Void

The network may authenticate the UE during any procedure establishing a NAS signalling connection with the UE. The security architecture is specified in TS 33.501 [29]. The network may optionally perform an PEI check with 5G-EIR.
The authorisation for connectivity of the subscriber to the 5GC and the authorization for the services that the user is allowed to access based on subscription (e.g. Operator Determined Barring, Roaming restrictions, Access Type and RAT Type currently in use) is evaluated once the user is successfully identified and authenticated. This authorization is executed during UE Registration procedure.
When the UE needs to transmit an initial NAS message, the UE shall request to establish an RRC Connection first and the NAS shall provide the RRC establishment related information to the lower layer. The RAN handles the RRC Connection with priority during and after RRC Connection Establishment procedure, when UE indicates priority in Establishment related information
Under high network load conditions, the network may protect itself against overload by using the Unified Access Control functionality for 3GPP access specified in TS 22.261 [2], TS 24.501 [47] and TS 38.300 [27] to limit access attempts from UEs. Depending on network configuration, the network may determine whether certain access attempt should be allowed or blocked based on categorized criteria, as specified in TS 22.261 [2] and TS 24.501 [47]. The NG-RAN may broadcast barring control information associated with Access Categories and Access Identities as specified in TS 38.300 [27].
The NG-RAN node may initiate such Unified Access Control when:
-	AMFs request to restrict the load for UEs that access the network by sending OVERLOAD START message containing conditions defined in clause 5.19.5.2, or
-	requested by OAM, or
-	triggered by NG-RAN itself.
If the NG-RAN node takes a decision to initiate UAC because of the reception of the N2 interface OVERLOAD START messages, the NG-RAN should only initiate such procedure if all the AMFs relevant to the request contained in the OVERLOAD START message and connected to this NG-RAN node request to restrict the load for UEs that access the network.
If the UE supports both N1 and S1 modes NAS and, as defined in TS 23.401 [26], the UE is configured for Extended Access Barring (EAB) but is not configured with a permission for overriding Extended Access Barring (EAB), when the UE wants to access the 5GS it shall perform Unified Access Control checks for Access Category 1 on receiving an indication from the upper layers as defined in TS 24.501 [47], TS 38.331 [28], TS 36.331 [51].
If the UE supports both N1 and S1 modes NAS and, as defined in TS 23.401 [26], the UE is configured with a permission for overriding Extended Access Barring (EAB), when the UE wants to access the 5GS it shall ignore Unified Access Control checks for Access Category 1 on receiving an indication from the upper layers, as defined in TS 24.501 [47].
NOTE:	UE signalling of Low Access Priority indication over N1 in 5GS is not supported in this release of the specification.
Operator may provide one or more PLMN-specific Operator-defined access category definitions to the UE using NAS signalling, and the UE handles the Operator-defined access category definitions stored for the Registered PLMN, as specified in TS 24.501 [47].
The access control for the Disaster Roaming is described in TS 23.122 [17] and TS 24.501 [47].
Network access control including service authorization may be influenced by Policy control, as specified in clause 5.14.
For definition and functionality of Lawful Interception, please see TS 33.126 [35].
The Registration Management is used to register or deregister a UE/user with the network, and establish the user context in the network. The Connection Management is used to establish and release the signalling connection between the UE and the AMF.
A UE/user needs to register with the network to receive services that requires registration. Once registered and if applicable the UE updates its registration with the network (see TS 23.502 [3]):
-	periodically, in order to remain reachable (Periodic Registration Update); or
-	upon mobility (Mobility Registration Update); or
-	to update its capabilities or re-negotiate protocol parameters (Mobility Registration Update).
The Initial Registration procedure involves execution of Network Access Control functions as defined in clause 5.2 (i.e. user authentication and access authorization based on subscription profiles in UDM). As result of the Registration procedure, the identifier of the serving AMF serving the UE in the access through which the UE has registered will be registered in UDM.
The registration management procedures are applicable over both 3GPP access and Non-3GPP access. The 3GPP and Non-3GPP RM states are independent of each other, see clause 5.3.2.4.
Two RM states are used in the UE and the AMF that reflect the registration status of the UE in the selected PLMN:
-	RM-DEREGISTERED.
-	RM-REGISTERED.
In the RM-DEREGISTERED state, the UE is not registered with the network. The UE context in AMF holds no valid location or routing information for the UE so the UE is not reachable by the AMF. However, some parts of UE context may still be stored in the UE and the AMF e.g. to avoid running an authentication procedure during every Registration procedure.
In the RM-DEREGISTERED state, the UE shall:
-	attempt to register with the selected PLMN using the Initial Registration procedure if it needs to receive service that requires registration (see clause 4.2.2.2 of TS 23.502 [3]).
-	remain in RM-DEREGISTERED state if receiving a Registration Reject upon Initial Registration (see clause 4.2.2.2 of TS 23.502 [3]).
-	enter RM-REGISTERED state upon receiving a Registration Accept (see clause 4.2.2.2 of TS 23.502 [3]).
When the UE RM state in the AMF is RM-DEREGISTERED, the AMF shall:
-	when applicable, accept the Initial Registration of a UE by sending a Registration Accept to this UE and enter RM-REGISTERED state for the UE (see clause 4.2.2.2 of TS 23.502 [3]); or
-	when applicable, reject the Initial Registration of a UE by sending a Registration Reject to this UE (see clause 4.2.2.2 of TS 23.502 [3]).
In the RM-REGISTERED state, the UE is registered with the network. In the RM-REGISTERED state, the UE can receive services that require registration with the network.
In the RM-REGISTERED state, the UE shall:
-	perform Mobility Registration Update procedure if the current TAI of the serving cell (see TS 37.340 [31]) is not in the list of TAIs that the UE has received from the network in order to maintain the registration and enable the AMF to page the UE;
NOTE:	Additional considerations for Mobility Registration Update in case of NR satellite access are provided in clause 5.4.11.6.
-	perform Periodic Registration Update procedure triggered by expiration of the periodic update timer to notify the network that the UE is still active.
-	perform a Mobility Registration Update procedure to update its capability information or to re-negotiate protocol parameters with the network;
-	perform Deregistration procedure (see clause 4.2.2.3.1 of TS 23.502 [3]), and enter RM-DEREGISTERED state, when the UE needs to be no longer registered with the PLMN. The UE may decide to deregister from the network at any time.
-	enter RM-DEREGISTERED state when receiving a Registration Reject message or a Deregistration message. The actions of the UE depend upon the cause value' in the Registration Reject or Deregistration message. See clause 4.2.2 of TS 23.502 [3].
When the UE RM state in the AMF is RM-REGISTERED, the AMF shall:
-	perform Deregistration procedure (see clauses 4.2.2.3.2, 4.2.2.3.3 of TS 23.502 [3]), and enter RM-DEREGISTERED state for the UE, when the UE needs to be no longer registered with the PLMN. The network may decide to deregister the UE at any time;
-	perform Implicit Deregistration at any time after the Implicit Deregistration timer expires. The AMF shall enter RM-DEREGISTERED state for the UE after Implicit Deregistration;
-	when applicable, accept or reject Registration Requests or Service Requests from the UE.

Figure 5.3.2.2.4-1: RM state model in UE

Figure 5.3.2.2.4-2: RM state model in AMF
Registration Area management comprises the functions to allocate and reallocate a Registration area to a UE. Registration area is managed per access type i.e. 3GPP access or Non-3GPP access.
When a UE registers with the network over the 3GPP access, the AMF allocates a set of tracking areas in TAI List to the UE. When the AMF allocates registration area, i.e. the set of tracking areas in TAI List, to the UE it may take into account various information (e.g. Mobility Pattern and Allowed/Non-Allowed Area (refer to clause 5.3.4.1)). An AMF which has the whole PLMN as serving area may alternatively allocate the whole PLMN ("all PLMN") as registration area to a UE in MICO mode (refer to clause 5.4.1.3). When AMF allocates registration area for UE registered for Disaster Roaming service as specified in clause 5.40.4, AMF shall only consider TAIs covering the area with the Disaster Condition.
The 5G System shall support allocating a Registration Area using a single TAI List which includes tracking areas of any NG-RAN nodes in the Registration Area for a UE.
In the case of SNPN, the TAI list allocated by AMF does not support Tracking Areas belonging to different SNPNs.
TAI used for non-3GPP access shall be dedicated to non-3GPP access. TAI(s) dedicated to Non-3GPP access may be defined in a PLMN and apply within this PLMN. Each N3IWF, TNGF, TWIF and W-AGF is locally configured with one TAI value. Each N3IWF, TNGF, TWIF and W-AGF may be configured with a different TAI value or with the same TAI value as other N3IWFs, TNGFs, TWIFs and/or W-AGFs. The TAI is provided to the AMF during N2 interface setup and as part of the User Location Information in UE associated messages as described in TS 38.413 [34].
When a UE registers with the network over a Non-3GPP access, the AMF allocates to the UE a registration area that only includes the TAI received from the serving N3IWF, TNGF, TWIF or W-AGF.
NOTE 1:	For example, two W-AGFs can each correspond to a different TAI (one TAI per W-AGF) and thus support different sets of S-NSSAI(s).
When generating the TAI list, the AMF shall include only TAIs that are applicable on the access type (i.e. 3GPP access or Non-3GPP access) where the TAI list is sent.
NOTE 2:	To prevent extra signalling load resulting from Mobility Registration Update occurring at every RAT change, it is preferable to avoid generating a RAT-specific TAI list for a UE supporting more than one RAT.
NOTE 3:	For a UE registered on N3GPP access the TAI(s) provided to the UE as part of the Registration Area is expected to enable the support of the slices that are intended to be provided for this UE over this specific Non-3GPP access. In addition, the Registration Area provided to the UE for non-3GPP access will never change until the UE deregisters from non-3GPP access (either explicit deregistration or implicit deregistration due to Deregistration timer expiring due to UE entering CM_IDLE state).
For all 3GPP Access RATs in NG-RAN and for Non-3GPP Access, the 5G System supports the TAI format as specified in TS 23.003 [19] consisting of MCC, MNC and a 3-byte TAC only.
The additional aspects for registration management when a UE is registered over one access type while the UE is already registered over the other access type is further described in clause 5.3.2.4.
To ensure a UE initiates a Mobility Registration procedure when performing inter-RAT mobility to or from NB-IoT, a Tracking Area shall not contain both NB-IoT and other RATs cells (e.g. WB-E-UTRA, NR), and the AMF shall not allocate a TAI list that contains both NB-IoT and other RATs Tracking Areas.
For 3GPP access the AMF determines the RAT type the UE is camping on based on the Global RAN Node IDs associated with the N2 interface and additionally the Tracking Area indicated by NG-RAN. When the UE is accessing NR using unlicensed bands, as defined in clause 5.4.8, an indication is provided in N2 interface as defined in TS 38.413 [34].
The AMF may also determine more precise RAT Type information based on further information received from NG-RAN:
-	The AMF may determine the RAT Type to be LTE-M as defined in clause 5.31.20; or
-	The AMF may determine the RAT Type to be NR using unlicensed bands, as defined in clause 5.4.8.
-	The AMF may determine the RAT Type to be one of the RAT types for satellite access, as defined in clause 5.4.10.
-	The AMF may determine the RAT Type to be NR RedCap as defined in clause 5.41.
For Non-3GPP accesses the AMF determines the RAT type the UE is camping based on the 5G-AN node associated with N2 interface as follows:
-	The RAT type is Untrusted Non-3GPP if the 5G-AN node has a Global N3IWF Node ID;
-	The RAT type is Trusted Non-3GPP if the 5G-AN node has a Global TNGF Node ID or a Global TWIF Node ID; and
-	The RAT type is Wireline -BBF if the 5G-AN node has a Global W-AGF Node ID corresponding to a W-AGF supporting the Wireline BBF Access Network. The RAT type is Wireline-Cable if the 5G-AN node has a Global W-AGF Node ID corresponding to a W-AGF supporting the Wireline Cable Access Network. If not possible to distinguish between the two, the RAT type is Wireline.
NOTE 4:	How to differentiate between W-AGF supporting either Wireline BBF Access Network or the Wireline (e.g. different Global W-AGF Node ID IE or the Global W-AGF Node ID including a field to distinguish between them) is left to Stage 3 definition.
NOTE 5:	If an operator supports only one kind of Wireline Access Network (either Wireline BBF Access Network or a Wireline Cable Access Network) the AMF may be configured to use RAT type Wireline or the specific one.
For Non-3GPP access the AMF may also use the User Location Information provided at N2 connection setup to determine a more precise RAT Type, e.g. identifying IEEE 802.11 access, Wireline-Cable access, Wireline-BBF access.
When the 5G-AN node has either a Global N3IWF Node ID, or a Global TNGF Node ID, or a Global TWIF Node ID, or a Global W-AGF Node ID, the Access Type is Non-3GPP Access.
This clause applies to Non-3GPP access network corresponding to the Untrusted Non-3GPP access network, to the Trusted Non-3GPP and to the W-5GAN. In the case of W-5GAN the UE mentioned in this clause corresponds to the 5G-RG.
For a given serving PLMN there is one RM context for a UE for each access, e.g. when the UE is consecutively or simultaneously served by a 3GPP access and by a non-3GPP access (i.e. via an N3IWF, TNGF and W-AGF) of the same PLMN. UDM manages separate/independent UE Registration procedures for each access.
When served by the same PLMN for 3GPP and non-3GPP accesses, an UE is served by the same AMF except in the temporary situation described in clause 5.17 i.e. after a mobility from EPS while the UE has PDU Sessions associated with non-3GPP access.
The 5G NSWO authentication as defined in Annex S of TS 33.501 [29] does not impact the RM state.
An AMF associates multiple access-specific RM contexts for an UE with:
-	a 5G-GUTI that is common to both 3GPP and Non-3GPP accesses. This 5G-GUTI is globally unique.
-	a Registration state per access type (3GPP / Non-3GPP)
-	a Registration Area per access type: one Registration Area for 3GPP access and another Registration Area for non 3GPP access. Registration Areas for the 3GPP access and the Non-3GPP access are independent.
-	timers for 3GPP access:
-	a Periodic Registration timer; and
-	a Mobile Reachable timer and an Implicit Deregistration timer.
-	timers for non-3GPP access:
-	a UE Non-3GPP Deregistration timer; and
-	a Network Non-3GPP Implicit Deregistration timer.
The AMF shall not provide a Periodic Registration Timer for the UE over a Non-3GPP access. Consequently, the UE need not perform Periodic Registration Update procedure over Non-3GPP access. Instead, during the Initial Registration procedure and Re-registration, the UE is provided by the network with a UE Non-3GPP Deregistration timer that starts when the UE enters non-3GPP CM-IDLE state.
When the 3GPP access and the non-3GPP access for the same UE are served by the same PLMN, the AMF assigns the same 5G-GUTI for use over both accesses. Such a 5G-GUTI may be assigned or re-assigned over any of the 3GPP and Non-3GPP accesses. The 5G-GUTI is assigned upon a successful registration of the UE, and is valid over both 3GPP and Non-3GPP access to the same PLMN for the UE. Upon performing an initial access over the Non-3GPP access or over the 3GPP access while the UE is already registered with the 5G System over another access of the same PLMN, the UE provides the native 5G-GUTI for the other access. This enables the AN to select an AMF that maintains the UE context created at the previous Registration procedure via the GUAMI derived from the 5G-GUTI, and enables the AMF to correlate the UE request to the existing UE context via the 5G-GUTI.
If the UE is performing registration over one access and intends to perform registration over the other access in the same PLMN (e.g. the 3GPP access and the selected N3IWF, TNGF or W-AGF are located in the same PLMN), the UE shall not initiate the registration over the other access until the Registration procedure over first access is completed.
NOTE:	To which access the UE performs registration first is up to UE implementation.
When the UE is successfully registered to an access (3GPP access or Non-3GPP access respectively) and the UE registers via the other access:
-	if the second access is located in the same PLMN (e.g. the UE is registered via a 3GPP access and selects a N3IWF, TNGF or W-AGF located in the same PLMN), the UE shall use for the registration to the PLMN associated with the new access the 5G-GUTI that the UE has been provided with at the previous registration or UE configuration update procedure for the first access in the same PLMN. Upon successful completion of the registration to the second access, if the network included a 5G-GUTI in the Registration Accept, the UE shall use the 5G-GUTI received in the Registration Accept for both registrations. If no 5G-GUTI is included in the Registration Accept, then the UE uses the 5G-GUTI assigned for the existing registration also for the new registration.
-	if the second access is located in a PLMN different from the registered PLMN of the first access (i.e. not the registered PLMN), (e.g. the UE is registered to a 3GPP access and selects a N3IWF, TNGF or W-AGF located in a PLMN different from the PLMN of the 3GPP access, or the UE is registered over Non-3GPP and registers to a 3GPP access in a PLMN different from the PLMN of the N3IWF, TNGF or W-AGF), the UE shall use for the registration to the PLMN associated with the new access a 5G-GUTI only if it has got one previously received from a PLMN that is not the same as the PLMN the UE is already registered with. If the UE does not include a 5G-GUTI, the SUCI shall be used for the new registration. Upon successful completion of the registration to the second access, the UE has the two 5G-GUTIs (one per PLMN).
A UE supporting registration over both 3GPP and Non-3GPP access to two PLMNs shall be able to handle two separate registrations, including two 5G-GUTIs, one per PLMN, and two associated equivalent PLMN lists.
When a UE 5G-GUTI assigned during a Registration procedure over 3GPP (e.g. the UE registers first over a 3GPP access) is location-dependent, the same UE 5G-GUTI can be re-used over the Non-3GPP access when the selected N3IWF, TNGF or W-AGF function is in the same PLMN as the 3GPP access. When an UE 5G-GUTI is assigned during a Registration procedure performed over a Non 3GPP access (e.g. the UE registers first over a non-3GPP access), the UE 5G-GUTI may not be location-dependent, so that the UE 5G-GUTI may not be valid for NAS procedures over the 3GPP access and, in this case, a new AMF is allocated during the Registration procedure over the 3GPP access.
When the UE is registered first via 3GPP access, if the UE registers to the same PLMN via Non-3GPP access, the UE shall send the GUAMI obtained via 3GPP access to the N3IWF, TNGF or W-AGF, which uses the received GUAMI to select the same AMF as the 3GPP access.
The Deregistration Request message indicates whether it applies to the 3GPP access the Non-3GPP access, or both.
If the UE is registered on both 3GPP and Non-3GPP accesses and it is in CM-IDLE over Non-3GPP access, then the UE or AMF may initiate a Deregistration procedure over the 3GPP access to deregister the UE only on the Non-3GPP access, in which case all the PDU Sessions which are associated with the Non-3GPP access shall be released.
If the UE is registered on both 3GPP and non-3GPP accesses and it is in CM-IDLE over 3GPP access and in CM-CONNECTED over non-3GPP access, then the UE may initiate a Deregistration procedure over the non-3GPP access to deregister the UE only on the 3GPP access, in which case all the PDU Sessions which are associated with the 3GPP access shall be released.
Registration Management over Non-3GPP access is further defined in clause 5.5.1.
Connection management comprises the functions of establishing and releasing a NAS signalling connection between a UE and the AMF over N1. This NAS signalling connection is used to enable NAS signalling exchange between the UE and the core network. It comprises both the AN signalling connection between the UE and the AN (RRC Connection over 3GPP access or UE-N3IWF connection over untrusted N3GPP access or UE-TNGF connection over trusted N3GPP access) and the N2 connection for this UE between the AN and the AMF.
Two CM states are used to reflect the NAS signalling Connection of the UE with the AMF:
-	CM-IDLE
-	CM-CONNECTED
The CM state for 3GPP access and Non-3GPP access are independent of each other, i.e. one can be in CM-IDLE state at the same time when the other is in CM-CONNECTED state.
A UE in CM-IDLE state has no NAS signalling connection established with the AMF over N1. The UE performs cell selection/cell reselection according to TS 38.304 [50] and PLMN selection according to TS 23.122 [17].
There are no AN signalling connection, N2 connection and N3 connections for the UE in the CM-IDLE state.
If the UE is both in CM-IDLE state and in RM-REGISTERED state, the UE shall, unless otherwise specified in clause 5.3.4.1:
-	Respond to paging by performing a Service Request procedure (see clause 4.2.3.2 of TS 23.502 [3]), unless the UE is in MICO mode (see clause 5.4.1.3);
-	perform a Service Request procedure when the UE has uplink signalling or user data to be sent (see clause 4.2.3.2 of TS 23.502 [3]). Specific conditions apply for LADN, see clause 5.6.5.
When the UE state in the AMF is RM-REGISTERED, UE information required for initiating communication with the UE shall be stored. The AMF shall be able to retrieve stored information required for initiating communication with the UE using the 5G-GUTI.
NOTE:	In 5GS there is no need for paging using the SUPI/SUCI of the UE.
The UE provides 5G-S-TMSI as part of AN parameters during AN signalling connection establishment as specified in TS 38.331 [28] and TS 36.331 [51]. The UE shall enter CM-CONNECTED state whenever an AN signalling connection is established between the UE and the AN (entering RRC_CONNECTED state over 3GPP access, or at the establishment of the UE-N3IWF connectivity over untrusted non-3GPP access or the UE-TNGF connectivity over trusted non-3GPP access). The transmission of an Initial NAS message (Registration Request, Service Request or Deregistration Request) initiates the transition from CM-IDLE to CM-CONNECTED state.
When the UE states in the AMF are CM-IDLE and RM-REGISTERED, the AMF shall:
-	perform a network triggered Service Request procedure when it has signalling or mobile-terminated data to be sent to this UE, by sending a Paging Request to this UE (see clause 4.2.3.3 of TS 23.502 [3]), if a UE is not prevented from responding e.g. due to MICO mode or Mobility Restrictions.
The AMF shall enter CM-CONNECTED state for the UE whenever an N2 connection is established for this UE between the AN and the AMF. The reception of initial N2 message (e.g. N2 INITIAL UE MESSAGE) initiates the transition of AMF from CM-IDLE to CM-CONNECTED state.
The UE and the AMF may optimize the power efficiency and signalling efficiency of the UE when in CM-IDLE state e.g. by activating MICO mode (see clause 5.4.1.3).
A UE in CM-CONNECTED state has a NAS signalling connection with the AMF over N1. A NAS signalling connection uses an RRC Connection between the UE and the NG-RAN and an NGAP UE association between the AN and the AMF for 3GPP access. A UE can be in CM-CONNECTED state with an NGAP UE association that is not bound to any TNLA between the AN and the AMF. See clause 5.21.1.2 for details on the state of NGAP UE association for an UE in CM-CONNECTED state. Upon completion of a NAS signalling procedure, the AMF may decide to release the NAS signalling connection with the UE.
In the CM-CONNECTED state, the UE shall:
-	enter CM-IDLE state whenever the AN signalling connection is released (entering RRC_IDLE state over 3GPP access or when the release of the UE-N3IWF connectivity over untrusted non-3GPP access or the UE-TNGF connectivity over trusted non-3GPP access is detected by the UE), see TS 38.331 [28] for 3GPP access.
When the UE CM state in the AMF is CM-CONNECTED, the AMF shall:
-	enter CM-IDLE state for the UE whenever the logical NGAP signalling connection and the N3 user plane connection for this UE are released upon completion of the AN Release procedure as specified in TS 23.502 [3].
The AMF may keep a UE CM state in the AMF in CM-CONNECTED state until the UE de-registers from the core network.
A UE in CM-CONNECTED state can be in RRC_INACTIVE state, see TS 38.300 [27]. When the UE is in RRC_INACTIVE state the following applies:
-	UE reachability is managed by the RAN, with assistance information from core network;
-	UE paging is managed by the RAN.
-	UE monitors for paging with UE's CN (5G S-TMSI) and RAN identifier.

Figure 5.3.3.2.4-1: CM state transition in UE

Figure 5.3.3.2.4-2: CM state transition in AMF
When a UE enters CM-IDLE state, the UP connection of the PDU Sessions that were active on this access are deactivated.
NOTE:	The activation of UP connection of PDU Sessions is documented in clause 5.6.8.
RRC_INACTIVE state applies to NG-RAN. UE support for RRC_INACTIVE state is defined in TS 38.306 [69] for NR and TS 36.306 [70] for E-UTRA connected to 5GC. RRC_INACTIVE is not supported by NB-IoT connected to 5GC.
The AMF shall provide assistance information to the NG-RAN, to assist the NG-RAN's decision whether the UE can be sent to RRC_INACTIVE state except due to some exceptional cases such as:
-	PLMN (or AMF set) does not support RRC_INACTIVE;
-	The UE needs to be kept in CM-CONNECTED State (e.g. for tracking).
The "RRC Inactive Assistance Information" includes:
-	UE specific DRX values;
-	UE specific extended idle mode DRX values (cycle length and Paging Time Window length);
-	The Registration Area provided to the UE;
-	Periodic Registration Update timer;
-	If the AMF has enabled MICO mode for the UE, an indication that the UE is in MICO mode;
-	Information from the UE identifier, as defined in TS 38.304 [50] for NR and TS 36.304 [52] for E-UTRA connected to 5GC, that allows the RAN to calculate the UE's RAN paging occasions;
-	An indication that Paging Cause Indication for Voice Service is supported;
-	AMF PEIPS Assistance Information (see clause 5.4.12.2) for paging a UE in CM-CONNECTED with RRC_INACTIVE state over NR as defined in TS 38.300 [27];
-	CN based MT communication handling support indication for RRC_INACATIVE state (see clause 5.31.7.2.1).
The RRC Inactive Assistance Information mentioned above is provided by the AMF during N2 activation with the (new) serving NG-RAN node (i.e. during Registration, Service Request, Handover) to assist the NG RAN's decision whether the UE can be sent to RRC_INACTIVE state. If the AMF allocates a new Registration Area to the UE, the AMF should update the NG-RAN with the new Registration Area by sending the RRC Inactive Assistance Information accordingly. The Paging Cause Indication for Voice Service is used to assist NG RAN to perform RAN based paging.
RRC_INACTIVE state is part of RRC state machine, and it is up to the RAN to determine the conditions to enter RRC_INACTIVE state. If any of the parameters included in the RRC Inactive Assistance Information changes as the result of NAS procedure, the AMF shall update the RRC Inactive Assistance Information to the NG-RAN node.
When the UE is in CM-CONNECTED state, if the AMF has provided RRC Inactive assistance information, the RAN node may decide to move a UE to CM-CONNECTED with RRC_INACTIVE state.
The state and "endpoints" (in the case of Dual Connectivity configuration) of the N2 and N3 reference points are not changed by the UE entering CM-CONNECTED with RRC_INACTIVE state. A UE in RRC_INACTIVE state is aware of the RAN Notification area and periodic RAN Notification Area Update timer.
The 5GC network is not aware of the UE transitions between CM-CONNECTED with RRC_CONNECTED and CM-CONNECTED with RRC_INACTIVE state, unless the 5GC network is notified via N2 notification procedure in clause 4.8.3 of TS 23.502 [3].
At transition into CM-CONNECTED with RRC_INACTIVE state, the NG-RAN configures the UE with a periodic RAN Notification Area Update timer taking into account the value of the Periodic Registration Update timer value indicated in the RRC Inactive Assistance Information, and uses a guard timer with a value longer than the RAN Notification Area Update timer value provided to the UE.
If the periodic RAN Notification Area Update guard timer expires in NG-RAN, the NG-RAN shall initiate AN Release procedure as specified in clause 4.2.6 of TS 23.502 [3].
When the UE is in CM-CONNECTED with RRC_INACTIVE state, the UE performs PLMN selection procedures as defined in TS 23.122 [17] and TS 24.501 [47].
When the UE is CM-CONNECTED with RRC_INACTIVE state, the UE may resume the RRC Connection due to:
-	Uplink data pending;
-	Mobile initiated NAS signalling procedure;
-	As a response to RAN paging;
-	Notifying the network that it has left the RAN Notification Area;
-	Upon periodic RAN Notification Area Update timer expiration.
If the UE resumes the connection in a different NG-RAN node within the same PLMN or equivalent PLMN or within the same SNPN or equivalent SNPN, the UE AS context is retrieved from the old NG-RAN node and a procedure is triggered towards the CN (see clause 4.8.2 of TS 23.502 [3]).
NOTE 1:	With Dual Connectivity configuration if the UE resumes the RRC connection in the Master RAN node, the Secondary RAN node configuration is defined in TS 38.300 [27].
If the RAN paging procedure applying DRX or eDRX value no longer than 10.24s, as defined in TS 38.300 [27], is not successful in establishing contact with the UE the procedure shall be handled by the network as follows:
-	If NG-RAN has at least one pending NAS PDU for transmission, the RAN node shall initiate the AN Release procedure (see clause 4.2.6 of TS 23.502 [3]) to move the UE CM state in the AMF to CM-IDLE state and indicate to the AMF the NAS non-delivery.
-	If NG RAN has only pending user plane data for transmission, the NG-RAN node may keep the N2 connection active or initiate the AN Release procedure (see clause 4.2.6 of TS 23.502 [3]) based on local configuration in NG-RAN.
NOTE 2:	The user plane data which triggers the RAN paging can be lost, e.g. in the case of RAN paging failure.
If the RAN paging procedure applying eDRX value longer than 10.24s, as defined in TS 38.300 [27], has not requested the CN based mobile terminated (MT) communication handling as described in clause 5.31.7.2.1 and is not successful in establishing contact with the UE after paging the UE, the procedure shall be handled by network as follows:
-	If NG-RAN has at least one pending NAS PDU for transmission, the RAN node shall initiate the AN Release procedure (see clause 4.2.6 of TS 23.502 [3]) to move the UE CM state in the AMF to CM-IDLE state and indicate to the AMF the NAS non-delivery.
-	If NG-RAN has only pending user plane data for transmission, the NG-RAN node may keep the N2 connection active and based on implementation send indication to the CN requesting the CN based mobile terminated (MT) communication handling as described in clause 5.31.7.2.1, or initiate the AN Release procedure (see clause 4.2.6 of TS 23.502 [3]) based on local configuration in NG-RAN.
NOTE 3:	The user plane data which triggers the RAN paging can be lost, e.g. in the case of RAN paging failure.
If a UE in CM-CONNECTED with RRC_INACTIVE state performs cell selection to GERAN/UTRAN/E-UTRAN, it shall follow idle mode procedures of the selected RAT as specified in clause 5.17.
In addition, a UE in CM-CONNECTED state with RRC_INACTIVE state shall enter CM-IDLE state and initiates the NAS signalling recovery (see TS 24.501 [47]) in the following cases:
-	If RRC resume procedure fails,
	If the UE receives Core Network paging,
-	If the periodic RAN Notification Area Update timer expires and the UE cannot successfully resume the RRC Connection,
-	In any other failure scenario that cannot be resolved in RRC_INACTIVE state and requires the UE to move to CM-IDLE state.
When a UE is in CM-CONNECTED with RRC_INACTIVE state, and a trigger to change the UE's NG-RAN or E-UTRAN UE Radio Capability information happens, the UE shall move to CM-IDLE state and initiate the procedure for updating UE Radio Capability defined in clause 5.4.4.1. (For specific requirements for a UE operating in dual-registration mode see clause 5.17.2.1)
When UE is in CM-CONNECTED with RRC_INACTIVE state, if RAN has received Location Reporting Control message from AMF with the Reporting Type indicating single stand-alone report or continuously reporting whenever the UE changes the cell, the RAN shall perform location reporting as specified in clause 4.10 of TS 23.502 [3].
When the UE is CM-CONNECTED with RRC_INACTIVE state. If the AMF receives Nudm_UECM_DeregistrationNotification from UDM, the AMF shall initiate AN Release procedure as specified in clause 4.2.6 of TS 23.502 [3].
When UE is in CM-CONNECTED with RRC_INACTIVE state, if RAN has received Location Reporting Control message from AMF with the Reporting Type of the Area Of Interest based reporting, the RAN shall send a Location Report message to AMF including UE presence in the Area Of Interest (i.e. IN, OUT, or UNKNOWN) and the UE's last known location with time stamp.
When the UE is in CM-CONNECTED with RRC_INACTIVE state, if the old NG-RAN node that sends the UE into RRC_INACTIVE state receives the downlink N2 signalling, it initiates the RAN paging as defined in TS 38.300 [27]. If the UE resumes the RRC Connection towards a different NG-RAN node, the old NG-RAN node includes the "UE Context Transfer" indication into a response container to the NF (e.g. AMF or SMF) that generates such N2 downlink signalling. Then the NF shall reattempt the same procedure when the path switch from the old NG-RAN node to the new NG-RAN node is complete.
NAS signalling connection management includes the functions of establishing and releasing a NAS signalling connection.
NAS signalling connection establishment function is provided by the UE and the AMF to establish a NAS signalling connection for a UE in CM-IDLE state. The AMF shall provide the list of recommended cells/ TAs / NG-RAN node identifiers for paging, if the NG-RAN had provided that information in an earlier AN Release Procedure in the AN (see clause 4.2.6 of TS 23.502 [3]).
When the UE in CM-IDLE state needs to transmit an NAS message, the UE shall initiate a Service Request, a Registration or a Deregistration procedure to establish a NAS signalling connection to the AMF as specified in clauses 4.2.2 and 4.2.3 of TS 23.502 [3]. If the NAS signalling connection is to be established via an NG-RAN node, but the AMF detects that this UE has already established a NAS signalling connection via old NG-RAN node, the AMF shall release the old established NAS signalling connection by triggering AN Release Procedure.
Based on UE preferences, UE subscription, Mobility Pattern and network configuration, the AMF may keep the NAS signalling connection until the UE de-registers from the network.
The procedure of releasing a NAS signalling connection is initiated by the AN node (either 5G (R)AN node or N3IWF) or the AMF. The NG-RAN node may include the list of recommended cells/ TAs / NG-RAN node identifiers for paging, during the AN Release Procedure in the AN (see clause 4.2.6 of TS 23.502 [3]). The AMF stores this information, if provided by the NG-RAN.
The UE considers the NAS signalling connection is released if it detects the AN signalling connection is released. The AMF considers the NAS signalling connection is released if it detects the N2 context is released.
The AMF manages two CM states for an UE: a CM state for 3GPP access and a CM state for Non-3GPP access. An N2 interface can serve the UE for either 3GPP access or for Non 3GPP access. UE connected over both 3GPP and Non-3GPP has got two N2 interfaces, one for each access. A UE may be in any combination of the CM states between 3GPP and Non-3GPP access, e.g. a UE may be CM-IDLE for one access and CM-CONNECTED for the other access, CM-IDLE for both accesses or CM-CONNECTED for both accesses.
When the UE CM state in the AMF is CM-IDLE for 3GPP access and CM-CONNECTED for Non-3GPP access, the AMF shall perform a network triggered Service Request procedure, when it has downlink data to be sent to this UE for 3GPP access, by sending either the Paging Request via 3GPP access or the NAS notification via Non-3GPP access to this UE (see clause 4.2.3.3 of TS 23.502 [3]).
Connection Management over Non-3GPP access is further defined in clause 5.5.2.
Mobility Restrictions restrict mobility handling or service access of a UE. The Mobility Restriction functionality is provided by the UE (only for mobility restriction categories provided to the UE), the radio access network and the core network.
Unless otherwise stated, Mobility Restrictions only apply to 3GPP access and wireline access, they do not apply to other non-3GPP accesses.
The UE and the network shall override Mobility restriction as specified in clause 5.16.4.3 when accessing the network for Emergency Services. For MPS and MCX, service area restriction does not apply, as specified in TS 24.501 [47].
For UE requesting Disaster Roaming service, the UE is only allowed to receive services in the area with Disaster Condition as specified in clause 5.40.4. The other areas within the PLMN shall be considered as forbidden area for the UE registered for Disaster Roaming service.
Service Area restrictions and handling of Forbidden Areas for CM-IDLE state and, for CM-CONNECTED state when in RRC_INACTIVE state are executed by the UE based on information received from the core network. Mobility Restrictions for CM-CONNECTED state when in RRC_CONNECTED state are executed by the radio access network and the core network.
In CM-CONNECTED state, the core network provides Mobility Restrictions to the radio access network within Mobility Restriction List.
Mobility Restrictions consists of RAT restriction, Forbidden Area, Service Area Restrictions, Core Network type restriction and Closed Access Group information as follows:
-	RAT restriction:
	Defines the 3GPP and non-3GPP Radio Access Technology(ies), a UE is not allowed to access in a PLMN. In a restricted RAT a UE based on subscription is not permitted access to the network for this PLMN. For 3GPP access and CM-CONNECTED state, when radio access network determines target RAT and target PLMN during Handover procedure, it should take per PLMN RAT restriction into consideration. The RAT restriction is enforced in the network, and not provided to the UE.
-	Forbidden Area:
	In a Forbidden Area, the UE, based on subscription, is not permitted to initiate any communication with the network for this PLMN. The UE behaviour in terms of cell selection, RAT selection and PLMN selection depends on the network response that informs the UE of Forbidden Area. A Forbidden Area applies either to 3GPP access or to non-3GPP access.
	Further description on Forbidden Area when using wireline access is available in TS 23.316 [84].
	Support for Forbidden Area with NR satellite access is described in clause 5.4.11.8.
	Forbidden Areas should not be used for Untrusted or Trusted non-3GPP access.
NOTE 1:	If a UE receives that the UE is accessing from a forbidden tracking area when registering over untrusted non-3GPP access or trusted non-3GPP access, the UE cannot determine the corresponding TAI and thus needs to consider that access to untrusted non-3GPP access and to trusted non-3GPP access in this PLMN is forbidden until the forbidden area list is removed as described in TS 24.501 [47].
NOTE 2:	The UE reactions to specific network responses are described in TS 24.501 [47].
-	Service Area Restriction:
	Defines areas in which the UE may or may not initiate communication with the network as follows:
-	Allowed Area:
	In an Allowed Area, the UE is permitted to initiate communication with the network as allowed by the subscription.
-	Non-Allowed Area:
	In a Non-Allowed Area a UE is service area restricted based on subscription. The UE and the network are not allowed to initiate Service Request, or any connection requests for user plane data, control plane data, exception data reporting, or SM signalling (except for PS Data Off status change reporting) to obtain user services that are not related to mobility.
	The UE shall not use the entering of a Non-Allowed Area as a criterion for Cell Reselection, a trigger for PLMN Selection or Domain selection for UE originating sessions or calls. The RRC procedures while the UE is in CM-CONNECTED with RRC_INACTIVE state are unchanged compared to when the UE is in an Allowed Area. The RM procedures are unchanged compared to when the UE is in an Allowed Area. The UE in a Non-Allowed Area shall respond to core network paging or NAS Notification message from non-3GPP access with Service Request and RAN paging. The UE in a Non-Allowed Area may initiate MA PDU Session establishment or activation over a non-3GPP access other than wireline access, but the User Plane resources on the 3GPP access for the MA-PDU shall not be established or activated. The handling of Non-Allowed Area when using wireline access is described in TS 23.316 [84].
NOTE 3:	When the services are restricted in 5GS due to Service Area Restriction, then it is assumed that the services will be also restricted in all RATs/Systems at the same location(s) using appropriate mechanisms available in the other RATs/Systems.
NOTE 4:	Delivery of SOR transparent container, UE policy container, UE parameters update transparent container as defined in TS 24.501 [47], or removal of any stored Paging Restriction Information from network via Registration Request (see clause 5.38), is part of the mobility related service and is allowed in an area with service restriction.
NOTE 5:	For a UE in CM-CONNECTED state then neither control plane data transmission nor, if user plane resources are already established, user plane data transmission are restricted by a non-allowed area.
-	Core Network type restriction:
	Defines whether UE is allowed to connect to 5GC only, EPC only, both 5GC and EPC for this PLMN. The Core Network type restriction when received applies in the PLMN either to both 3GPP and non-3GPP Access Types or to non-3GPP Access Type only.
NOTE 6:	The Core Network type restriction can be used e.g. in network deployments where the E-UTRAN connects to both EPC and 5GC as described in clause 5.17. When the Core Network type restriction applies to non-3GPP Access Type, the UE is restricted from using any connectivity to an N3IWF.
-	Closed Access Group information:
	As defined in clause 5.30.3.
For a given UE, the core network determines the Mobility Restrictions based on UE subscription information, UE location and/or local policy (e.g. if the HPLMN has not deployed 5GC, HPLMN ID of the UE and the operator's policy are used in the VPLMN for determining the Core Network type restriction). The Mobility Restriction may change due to e.g. UE's subscription, location change and local policy. Optionally the Service Area Restrictions or the Non-Allowed Area may in addition be fine-tuned by the PCF e.g. based on UE location, PEI and network policies. Service Area Restrictions may be updated during a Registration procedure or UE Configuration Update procedure.
NOTE 7:	The subscription management ensures that for MPS service subscriber the Mobility Restrictions is not included.
If the network sends Service Area Restrictions to the UE, the network sends only either an Allowed Area, or a Non-Allowed Area, but not both at the same time, to the UE. If the UE has received an Allowed Area from the network, any TA not part of the Allowed Area is considered by the UE as non-allowed. If the UE has received a Non-Allowed Area from the network, any TA not part of the Non-Allowed Area is considered by the UE as allowed. If the UE has not received any Service Area Restrictions, any TA in the PLMN is considered as allowed.
If the UE has overlapping areas between Forbidden Areas, Service Area Restrictions, or any combination of them, the UE shall proceed in the following precedence order:
-	The evaluation of Forbidden Areas shall take precedence over the evaluation of Service Area Restrictions.
The UDM shall provide to the AMF the information defined in TS 23.008 [119] about the subscriber's NR or E-UTRA access restriction set by the operator determined e.g. by subscription scenario and roaming scenario:
-	For NR:
-	NR not allowed as primary access.
-	NR not allowed as secondary access.
-	NR in unlicensed bands not allowed as primary access.
-	NR in unlicensed bands not allowed as secondary access.
-	NR(LEO) satellite access not allowed as primary access.
-	NR(MEO) satellite access not allowed as primary access.
-	NR(GEO) satellite access not allowed as primary access.
-	NR(OTHERSAT) satellite access not allowed as primary access.
-	NR RedCap not allowed as primary access.
Editor's note:	The final decision on whether Dual Connectivity and Carrier Aggregation are supported is in RAN WG2 and RAN WG3. Subsequently SA WG2 will consider whether any system features are needed to support such DC or CA RAN functionality such as mobility restrictions for secondary access.
-	For E-UTRA:
-	E-UTRA not allowed as primary access.
-	E-UTRA not allowed as secondary access.
-	E-UTRA in unlicensed bands not allowed as secondary access.
-	NB-IoT not allowed as primary access.
-	LTE-M not allowed as primary access.
In order to enforce all primary access restrictions, the related access has to be deployed in different Tracking Area Codes and the subscriber shall not be allowed to access the network in TAs using the particular access.
With all secondary access restrictions, the subscriber shall not be allowed to use this access as secondary access.
This clause describes Service Area Restrictions for 3GPP access. For Service Area Restrictions when using wireline access, see TS 23.316 [84].
A Service Area Restriction may contain one or more (e.g. up to 16) entire Tracking Areas each or the Service Area Restriction may be set as unlimited (i.e. contain all Tracking Areas of the PLMN). The UE's subscription data in the UDM includes a Service Area Restriction which may contain either Allowed or Non-Allowed Areas–specified by using explicit Tracking Area identities and/or other geographical information (e.g. longitude/latitude, zip code, etc). The geographical information used to specify Allowed or Non-Allowed Area is only managed in the network, and the network will map it to a list of TAs before sending Service Area Restriction information to the PCF, NG-RAN and UE.
When the AMF assigns a limited allowed area to the UE, the AMF shall provide the UE with Service Area Restrictions which consist of either Allowed Areas or Non-Allowed Areas. The Allowed Areas included in the Service Area Restrictions can be pre-configured and/or dynamically assigned by the AMF.
The Allowed Area may alternatively be configured as unlimited i.e. it may contain all Tracking Areas of the PLMN. The Registration Area of a UE in the Non-Allowed Area should consist of a set of TAs which belongs to a Non-Allowed Area of the UE. The Registration Area of a UE in the Allowed Area should consist of a set of TAs which belongs to an Allowed Area of the UE. The AMF provides the Service Area Restriction in the form of TA(s), which may be a subset of full list stored in UE's subscription data or provided by the PCF, to the UE during the Registration procedure.
NOTE:	As the finest granularity for Service Area Restrictions are at TA level, subscriptions with limited geographical extent, like subscriptions for Fixed Wireless Access, will be allocated one or a few TAs and will consequently be allowed to access services in a larger area than in e.g. a FWA system.
The limited allowed area may also be limited by the AMF by a maximum allowed number of Tracking Areas, even though this limitation is not sent to the UE. If maximum allowed number of Tracking Areas is used in combination with Allowed Area, the maximum allowed number of Tracking Areas indicates (to the AMF) the maximum number of TAs allowed in limited allowed area inside the Allowed Area. If maximum allowed number of Tracking Areas is used in combination with Non-Allowed Area, the maximum allowed number of Tracking Areas indicates (to the AMF) the maximum number of TAs allowed in limited allowed area outside of the Non-Allowed Area.
The UDM stores the Service Area Restrictions of a UE as part of the UE's subscription data. The PCF in the serving network may (e.g. due to varying conditions such as UE's location, application in use, time and date) further adjust Service Area Restrictions of a UE, either by expanding an Allowed Area or by reducing a Non-Allowed Area or by increasing the maximum allowed number of Tracking Areas. If NWDAF is deployed, the PCF may use analytics (i.e. statistics or predictions) on UE mobility from NWDAF (see TS 23.288 [86]) to adjust Service Area Restrictions. The UDM and the PCF may update the Service Area Restrictions of a UE at any time. For the UE in CM-CONNECTED state the AMF updates the UE and RAN immediately. For UE in CM-IDLE state the AMF may page the UE immediately or store the updated service area restriction and update the UE upon next signalling interaction with the UE, as defined in TS 24.501 [47].
During registration, if the Service Area Restrictions of the UE is not present in the AMF, the AMF fetches from the UDM the Service Area Restrictions of the UE that may be further adjusted by the PCF. The serving AMF shall enforce the Service Area Restrictions of a UE. A limited allowed area given by a maximum allowed number of Tracking Areas, may be dynamically assigned by the AMF adding any not yet visited (by the UE) Tracking Areas to the limited allowed area until the maximum allowed number of Tracking Areas is reached (i.e. the AMF adds new TAs to the limited allowed area until the number of TAs is equal to the maximum allowed number of Tracking Areas). The AMF deletes the list of TAs that have been used up under the maximum allowed number of Tracking Areas quota at every Initial Registration.
For a UE in CM-CONNECTED state the AMF shall indicate the Service Area Restrictions of this UE to the RAN, using a Mobility Restriction List.
The UE shall store the received Service Area Restrictions and, if there is previously stored Service Area Restrictions, replace them with the newly received information. If the Service Area Restrictions include a limited allowed area, the Service Area Restrictions are applicable for the Tracking areas indicated in Service Area Restrictions. If the Service Area Restrictions included an unlimited allowed area, the received Service Area Restrictions are either applicable for the registered PLMN and its equivalent PLMN(s) that are available in the Registration Area, or the registered SNPN that is available in the Registration Area. The RAN uses the Service Area Restrictions for target cell selection in Xn and N2 based handover.
Upon change of serving AMF due to mobility, the old AMF may provide the new AMF with the Service Area Restrictions of the UE that may be further adjusted by the PCF.
The network may perform paging for a UE to update Service Area Restrictions with Generic UE Configuration Update procedure (see clause 4.2.4 of TS 23.502 [3]).
In the case of roaming, the Service Area Restrictions are transferred from the UDM via the serving AMF to the serving PCF in the visited network. The serving PCF in the visited network may further adjust the Service Area Restrictions.
Support for Service Area Restrictions with NR satellite access is described in clause 5.4.11.8.
The Mobility Pattern is a concept that may be used by the AMF to characterise and optimise the UE mobility. The AMF determines and updates Mobility Pattern of the UE based on subscription of the UE, statistics of the UE mobility, network local policy, and the UE assisted information, or any combination of them. The statistics of the UE mobility can be historical or expected UE moving trajectory. If NWDAF is deployed, the statistics of the UE mobility can also be analytics (i.e. statistics or predictions) provided by the NWDAF (see TS 23.288 [86]).
The Mobility Pattern can be used by the AMF to optimize mobility support provided to the UE, for example, Registration area allocation.
To support radio resource management in NG-RAN the AMF provides the parameter 'Index to RAT/Frequency Selection Priority' (RFSP Index) to NG-RAN across N2. The RFSP Index is mapped by the RAN to locally defined configuration in order to apply specific RRM strategies, taking into account any available information in RAN. The RFSP Index is UE specific and applies to all the Radio Bearers. Examples of how this parameter may be used by the RAN:
-	to derive UE specific cell reselection priorities to control idle mode camping.
-	to decide on redirecting active mode UEs to different frequency layers or RATs (e.g. see clause 5.3.4.3.2).
The HPLMN may set the RFSP Index taking into account the Subscribed S-NSSAIs. The AMF receives the subscribed RFSP Index from the UDM (e.g. during the Registration procedure). For non-roaming subscribers, the AMF chooses the RFSP Index in use according to one of the following procedures, depending on operator's configuration:
-	the RFSP Index in use is identical to the subscribed RFSP Index, or
-	the AMF chooses the RFSP Index in use based on the subscribed RFSP Index, the locally configured operator's policies, the Allowed NSSAI and any Partially Allowed NSSAI and the UE related context information available at the AMF, including UE's usage setting, if received during Registration procedures (see clause TS 23.502 [3]).
NOTE 1:	One example of how the AMF can use the "UE's usage setting," is to select an RFSP value that enforces idle mode camping on E-UTRA for a UE acting in a "Voice centric" way, in the case voice over NR is not supported in the specific Registration Area and it contains NR cells.
The AMF may report to the PCF the subscribed RFSP Index received from the UDM for further evaluation as described in clause 6.1.2.1 of TS 23.503 [45]. When receiving the authorized RFSP Index from the PCF, the AMF shall apply the authorized RFSP Index instead of the subscribed RFSP Index for choosing the RFSP index in use (as described above).
For roaming subscribers, the AMF may choose the RFSP Index in use based on the visited network policy, but can take input from the HPLMN into account (e.g. an RFSP Index value pre-configured per HPLMN, or a single RFSP Index value to be used for all roamers independent of the HPLMN). If the AMF receives authorized RFSP Index value from the V-PCF, the AMF chooses the RFSP index in use based on the authorized RFSP Index value.
NOTE 2:	The PCF can provide validity time together with the authorized RFSP Index indicating a change in priority from 5G access to E-UTRAN access as specified in clause 5.17.2.2.
The RFSP Index in use is also forwarded from source to target NG-RAN node when Xn or N2 is used for intra-NG-RAN handover.
The AMF stores the subscribed RFSP Index value received and the RFSP Index value in use. During the Registration procedure, the AMF may update the RFSP Index value in use (e.g. the AMF may need to update the RFSP Index value in use if the UE related context information in the AMF has changed). When the RFSP Index value in use is changed, the AMF immediately provides the updated RFSP Index value in use to NG-RAN node by modifying an existing UE context or by establishing a new UE context in RAN or by being configured to include the updated RFSP Index value in use in the NGAP DOWNLINK NAS TRANSPORT message if the user plane establishment is not needed. During inter-AMF mobility procedures, the source AMF forwards both RFSP Index values to the target AMF. The target AMF may replace the received RFSP Index value in use with a new RFSP Index value in use that is based on the operator's policies and the UE related context information available at the target AMF.
In order to enable UE idle mode mobility control and priority-based reselection mechanism considering availability of Network Slices at the network and the Network Slices allowed for a UE, an RFSP is derived as described in clause 5.3.4.3, considering also the Allowed NSSAI and any Partially Allowed NSSAI for the UE.
A UE supporting NSAG (see clause 5.15.14) may be configured, for some of the S-NSSAIs in the configured NSSAI, with NSAGs it can use as described in TS 38.300 [27], TS 38.304 [50], TS 38.331 [28], TS 38.321 [143], TS 24.501 [47] and as described in clause 5.3.4.3.4.
Editor's note:	The AMF can provide the Partially Allowed NSSAI without indication of the TAs where these are supported to the NG-RAN (in addition to providing the Partially Allowed NSSAI to the UE), but this will be evaluated after feedback from RAN WG2 and RAN WG3 whether and how to use the Partially Allowed NSSAI in the NG-RAN.
The NG-RAN may prefer to use specific radio resources per data radio bearer(s), e.g. depending on the Network Slices associated to the data radio bearer used by the UE. The UE idle mode mobility control and priority-based reselection mechanism operates as described in clause 5.3.4.3.1, and when UP resources are activated e.g. for a specific S-NSSAI the NG-RAN can use local policies to decide on what specific radio resources to use for the associated data radio bearer(s). A UE may be served by a set of data radio bearers which may be served by cells in different bands, selected based on RRM policies.
If a Network Slice, S-NSSAI, is configured to be available only in TAs covering specific dedicated frequency band(s), then there may be a need to redirect the UE to the dedicated frequency band(s) when such S-NSSAI is requested. If the Requested NSSAI contains S-NSSAI(s) that are not available in the UE's current TA, see clause 5.15.8, the AMF itself or by interacting with the NSSF as described in clause 5.15.5.2.1 may determine a Target NSSAI to be used by the NG-RAN, in addition to the information the AMF receives, such as the Allowed NSSAI and the RFSP for the Allowed NSSAI, to attempt to redirect the UE to a cell and TA in another frequency band and TA that supports the S-NSSAIs in the Target NSSAI. The Target NSSAI includes at least one S-NSSAI from the Requested NSSAI not available in the current TA, but available in another TA in different frequency band possibly overlapping with the current TA, and optionally additional S-NSSAIs from the Requested NSSAI that are configured to be available within the same TAs as the S-NSSAIs not available in the current TA. If the serving PLMN supports the subscription-based restrictions to simultaneous registration of network slices (see clause 5.15.12), and if the UE has NSSRG as part of the subscription information received from the HPLMN, the Target NSSAI includes only S-NSSAIs sharing at least one NSSRG.
The Target NSSAI may be excluding some of the S-NSSAIs in the Allowed NSSAI and include some of the rejected S-NSSAIs due to lack of support in the TA where the UE is located based on network policies that are in line with customer and operator agreements.
The Target NSSAI shall only include S-NSSAIs that can be provided in an Allowed NSSAI, or in an Allowed NSSAI and Partially Allowed NSSAI, for the UE. The Target NSSAI includes at least one Rejected S-NSSAI and may include e.g.:
-	all or a subset of the Rejected S-NSSAIs for RA, all or a subset of the S-NSSAIs rejected partially in the RA, all or a subset of Partially Allowed NSSAI when none of the S-NSSAIs in the Requested S-NSSAI were available in the TA where the UE is;
-	all the S-NSSAIs of the Allowed NSSAI, all the S-NSSAIs of the Partially Allowed NSSAI and all or a subset of the Rejected S-NSSAIs for the RA and all or subset of S-NSSAIs rejected partially in the RA;
-	a subset of the S-NSSAIs in the Allowed NSSAI, a subset of the S-NSSAIs in the Partially Allowed NSSAI and all or a subset of the Rejected S-NSSAIs for the RA and all or subset of S-NSSAIs rejected partially in the RA, if the operator policy is to prefer this Target S-NSSAI to the Allowed NSSAI.
The AMF should retrieve an RFSP Index suitable for the Target NSSAI and includes the RFSP Index in the information sent to the NG-RAN. The AMF retrieves the RFSP Index from the PCF or, in case PCF is not deployed the AMF determines the RFSP Index according to local configuration. The RFSP index associated to the Target NSSAI is considered if the NG-RAN succeeds to redirect the UE to a new TA where the Target NSSAI, or some S-NSSAIs of the Target NSSAI are supported, otherwise the RFSP index of the Allowed NSSAI is considered.
If the Requested NSSAI contains S-NSSAI(s) which map to S-NSSAI(s) of the HPLMN subject to Network Slice-Specific Authentication and Authorization that are not available in the UE's current TA, the AMF shall proceed with the Network Slice-Specific Authentication and Authorization procedure as described in clause 4.2.9 of TS 23.502 [3]. If the AMF determines a new Allowed NSSAI and/or Partially Allowed NSSAI at the end of Network Slice-Specific Authentication and Authorization steps and some S-NSSAI is not available in the UE's current TA, a Target NSSAI and corresponding RFSP index may be determined and provided to NG-RAN during UE Configuration Update procedure as described in clause 4.2.4.2 of TS 23.502 [3].
The NG-RAN shall attempt to find cells of TAs that can support all the S-NSSAIs in the Target S-NSSAIs, and if no such cell of a TA is available the RAN can attempt to select cells of TAs that best match the Target S-NSSAI. The NG-RAN shall attempt to ensure continuity of the PDU Sessions with activated User Plane associated with the S-NSSAIs in the Allowed NSSAI and/or Partially Allowed NSSAI which are in the Target NSSAI. Also, the NG-RAN should attempt to ensure continuity of service for the S-NSSAIs of the Allowed NSSAI and/or Partially Allowed NSSAI also available in the Target NSSAI, before prioritizing cells that are not supporting one or more of the S-NSSAI of the Allowed NSSAI and/or Partially Allowed NSSAI also available in the Target NSSAI.
The NG-RAN attempts to determine target cell(s) supporting the Target NSSAI considering the UE Radio Capabilities (i.e. the AMF (if available in the UE context) shall provide the NG-RAN with the current UE Radio Capability Information or the RACS UE Radio Capability ID when a Target NSSAI is provided, if the NG-RAN had not yet received any of them, or, if the AMF cannot provide any of these, the UE Radio Capability Information may be retrieved by the NG-RAN from the UE).
Once the target cells are determined, the NG-RAN initiates RRC redirection procedure towards the target cells, or the NG-RAN initiates handover for the UE with active PDU Sessions associated with the S-NSSAIs which are in the Target NSSAI, if possible.
After a successful redirection or handover of the UE to a new TA inside the current RA, the UE may request a PDU Session and activate UP resources for a PDU Session for S-NSSAIs of Partially Allowed NSSAI that are supported in the new TA, and the UE may request to register S-NSSAIs rejected partially in the RA that are not rejected in the new TA, as described in clause 5.15.17.
After a successful redirection or handover of the UE to a new TA outside the current RA, the UE shall perform a Mobility Registration Update procedure and the S-NSSAIs that the new TA supports can be allowed if the UE requests them. In order to ensure that the UE is redirected to a TA outside the current RA when there are S-NSSAIs Rejected for the RA, thus triggering a Mobility Registration Update procedure enabling the UE to request the S-NSSAI(s) that were rejected for the RA, the AMF shall set the RA so that the RA does not include TAs supporting the S-NSSAIs rejected for the RA included in the Target NSSAI when the AMF provides a Target NSSAI to the RAN.
When one or more S-NSSAI(s) are associated with NSAG(s), the UE may perform Network Slice based cell reselection and Random Access as described in TS 38.300 [27], TS 38.304 [50], TS 38.331 [28], TS 38.321 [143] and TS 24.501 [47].
When providing NSAG Information to the UE, the AMF shall also provide the NSAG priority information for the NSAGs provided in the NSAG Information. The AMF determines the NSAG priority information based on configured local policy of the serving PLMN or SNPN.
NOTE 1:	How the AMF assigns the NSAG priority information per UE is not specified but AMF can take into account information like e.g. UE MM capabilities, Subscribed S-NSSAIs and HPLMN.
NOTE 2:	The AMF can assign same priority value for NSAGs provided in the NSAG Information.
If the UE has received NSAG Information from the AMF, the UE shall use the NSAG Information provided by the AMF for cell reselection and Random Access as described below. If the UE has not received any NSAG Information from the AMF, the UE shall not use Network Slice based cell reselection and Random Access at all.
The UE NAS provides to the UE AS the NSAG Information as received from the AMF and the S-NSSAIs in the Allowed NSSAI and any Partially Allowed NSSAI as input to cell reselection, except when the UE intends to register with a new (including any S-NSSAIs rejected partially in the RA) set of S-NSSAIs with a Requested NSSAI different from the current Allowed NSSAI and any Partially Allowed NSSAI, in which case the UE NAS provides to the UE AS layer the NSAG Information as received from the AMF and the S-NSSAIs in the Requested NSSAI, and this may trigger a cell reselection, before sending the Registration Request including the new Requested NSSAI.
For Network Slice based Random Access, different Random Access resources may be assigned to different NSAG(s). The UE determines Random Access configuration among NSAGs that are published in SIB for Random Access and that are associated to the S-NSSAIs triggering the access. If the signalling transaction triggering the access attempt is related to more than one network slice, and the S-NSSAIs of these network slices are associated with more than one NSAG for Random Access, the NSAG with the highest priority is selected.
NOTE 3:	How the UE NAS provides the NSAGs priorities to UE AS is based internal UE interface, and not specified.
5G System supports the functionality of tracking and reporting UE mobility events.
The AMF provides the UE mobility related event reporting to NF that has been authorized to subscribe to the UE mobility event reporting service. Any NF service consumer such as SMF, NEF, TSCTSF or NWDAF that wants to be reported on the UE location is able to subscribe to the UE mobility event notification service to the AMF with the following parameters:
-	Event reporting type that specifies what to be reported on UE mobility (e.g. UE location, UE mobility on Area of Interest).
-	Event filters indicating the:
-	Area Of Interest that specifies a location area within 3GPP system. The Area Of Interest is represented by a list of Tracking Areas, list of cells or list of (R)AN node identifiers. In the case of LADN, the event consumer (e.g. SMF) provides the "LADN DNN" or "LADN DNN and S-NSSAI" to refer the LADN service area as the Area Of Interest. In the case of PRA, the event consumer (e.g. SMF or PCF) may provide an identifier for Area Of Interest to refer predefined area as the Area Of Interest.
-	The Area Of Interest may include a "RAN timing synchronization status change event" indicator, indicating that the presence in Area of Interest can be determined based on the most recent N2 connection.
-	The Area Of Interest may include an "Adjust AoI based on RA" indicator, indicating that the Area of Interest may be adjusted depending on UE's RA.
-	S-NSSAI and optionally the NSI ID(s).
-	Event Reporting Information: event reporting mode, number of reports, maximum duration of reporting, event reporting condition (e.g. when the target UE moved into a specified Area Of Interest, immediate reporting flag).
-	Notification Endpoint of NF service consumer to be notified.
-	The target of event reporting that indicates a specific UE, a group of UE(s) or any UE (i.e. all UEs). Further details on the information provided by the NF service consumer are provided in clause 4.15 of TS 23.502 [3].
If an NF service consumer subscribes to the UE mobility event notification service provided by AMF for reporting of UE presence in Area Of Interest, the AMF tracks UE's location considering UE's CM state and using NG-RAN procedures (if RRC_INACTIVE state applies to NG-RAN) in order to determine the UE presence in the Area Of Interest, as described in clause 4.15.4.2 of TS 23.502 [3]. Upon detecting the change of the UE presence in the Area Of Interest, the AMF notifies the UE presence in the Area Of Interest and the new UE location to the subscribed NF service consumer.
If the Area Of Interest in the subscription to the UE mobility event notification includes "RAN timing synchronization status change event" indicator as described in Table 5.2.2.3.1-1 of TS 23.502 [3], and the registration request from the UE includes a UE 5GMM Core Network Capability with an indication for "support for network reconnection due to RAN timing synchronization status change " as described in clause 5.4.4.a, the AMF reports the UE presence in Area of Interest based on the most recent N2 connection as described in Annex D of TS 23.502 [3].
If the Area Of Interest in the subscription to the UE mobility event notification includes "Adjust AoI based on RA" indicator as described in Table 5.2.2.3.1-1 in TS 23.502 [3], the AMF reports the UE presence in Area of Interest based on the most recent N2 connection as described in Annex D in TS 23.502 [3].
When the AMF is changed, the subscription of mobility event for a UE or group of UEs is transferred from the old AMF. The new AMF may decide not to notify the SMF with the current status related to the subscription of mobility event if the new AMF determines that, based on MM Context of the UE, the event is reported by the old AMF.
In the network deployment where a UE may leave or enter the Area Of Interest without any notification to the 5GC in CM-CONNECTED state (i.e. in the case that RRC_INACTIVE state applies to the NG-RAN), the AMF may initiate the NG-RAN location reporting as described in clause 5.4.7 or N2 Notification as described in clause 4.8.3 of TS 23.502 [3] to track the UE presence in the Area Of Interest.
The AMF may provide UE mobility event reporting to PCF, using Policy Control Report Triggers defined in TS 23.503 [45].
Triggers for the AMF to request for or subscribe to the analytics information from the NWDAF are internal logic in the AMF and may include for example:
-	UE access and mobility related event subscription by other NFs (e.g. SMF, NEF);
-	locally detected events;
-	analytics information received.
The trigger conditions may depend on operator and implementation policy in the AMF. When a trigger condition happens, the AMF may decide if any analytics information is needed and if so, request for or subscription to the analytics information from the NWDAF.
The AMF may, upon detection of certain local events, e.g. frequent mobility re-registration of one or more UEs, subscribe to mobility related abnormal behaviour analytics of the UE(s) as described in TS 23.288 [86] in order to trace UE mobility trend and take appropriate actions.
Reachability management is responsible for detecting whether the UE is reachable and providing UE location (i.e. access node) for the network to reach the UE. This is done by paging UE and UE location tracking. The UE location tracking includes both UE registration area tracking (i.e. UE registration area update) and UE reachability tracking ((i.e. UE periodic registration area update)). Such functionalities can be either located at 5GC (in the case of CM-IDLE state) or NG-RAN (in the case of CM-CONNECTED state).
The UE and the AMF negotiate UE reachability characteristics for CM-IDLE state during Registration procedures.
Three UE reachability categories are negotiated between UE and AMF for CM-IDLE state:
1.	UE reachability allowing Mobile Terminated data while the UE is CM-IDLE state.
-	The UE location is known by the network on a Tracking Area List granularity
-	Paging procedures apply to this category.
-	Mobile originating and mobile terminated data apply in this category for both CM-CONNECTED and CM-IDLE state.
2.	Mobile Initiated Connection Only (MICO) mode:
-	Mobile originated data applies in this category for both CM-CONNECTED and CM-IDLE state.
-	Mobile terminated data is only supported when the UE is in CM-CONNECTED state.
3.	UE unreachability due to Unavailability Period:
-	Mobile originated data and Mobile terminated data are not transmitted in this category (handling of data by extending buffering may apply).
-	Paging procedure is not applicable to this category.
Whenever a UE in RM-REGISTERED state enters CM-IDLE state, it starts a periodic registration timer according to the periodic registration timer value received from the AMF during a Registration procedure.
The AMF allocates a periodic registration timer value to the UE based on local policies, subscription information and information provided by the UE. After the expiry of the periodic registration timer, the UE shall perform a periodic registration. If the UE moves out of network coverage when its periodic registration timer expires, the UE shall perform a Registration procedure when it next returns to the coverage.
The AMF runs a Mobile Reachable timer for the UE. The timer is started with a value longer than the UE's periodic registration timer whenever the CM state for the UE in RM-REGISTERED state changes to CM-IDLE. If the AMF receives an elapsed time from RAN when RAN initiate UE context release indicating UE unreachable, the AMF should deduce a Mobile Reachable timer value based on the elapsed time received from RAN and the normal Mobile Reachable timer value. The AMF stops the Mobile Reachable timer, if the UE CM state in the AMF moves to CM-CONNECTED state. If the Mobile Reachable timer expires, the AMF determines that the UE is not reachable.
However, the AMF does not know for how long the UE remains not reachable, thus the AMF shall not immediately de-register the UE. Instead, after the expiry of the Mobile Reachable timer, the AMF should clear the PPF and shall start an Implicit De-registration timer, with a relatively large value. The AMF shall stop the Implicit De-registration timer and set the PPF if the AMF moves the UE CM state in the AMF to CM-CONNECTED state.
NOTE:	If the UE CM state in the AMF is CM-IDLE, then AMF considers the UE always unreachable if the UE is in MICO mode (refer to clause 5.4.1.3).
If the UE indicates an Unavailability Period Duration, then AMF shall consider the UE as unreachable and will not trigger the Paging procedure (e.g. clear the PPF) until the UE registers for normal service again (e.g. set the PPF). Once the event that makes the UE unavailable is completed or cancelled in the UE, the UE shall initiate the registration procedure in order to resume normal service.
If the PPF is not set, the AMF does not page the UE and shall reject any request for delivering DL signalling or data to this UE.
If the Implicit De-registration timer expires before the UE contacts the network, the AMF implicitly de-register the UE.
As part of deregistration for a particular access (3GPP or non-3GPP), the AMF shall request the UE's related SMF to release the PDU Sessions established on that access.
The AMF considers a UE in RM-REGISTERED state to be reachable by CN paging if the UE CM state in the AMF is CM-IDLE state unless the UE applies MICO mode or the UE has indicated Unavailability Period Duration..
A UE may indicate preference for MICO mode during Initial Registration or Mobility Registration Update procedure. The AMF, based on local configuration, Expected UE Behaviour and/or Network Configuration parameters if available from the UDM, UE indicated preferences, UE subscription information and network policies, or any combination of them, determines whether MICO mode is allowed for the UE and indicates it to the UE during Registration procedure. If NWDAF is deployed, the AMF may also use analytics on UE mobility and/or UE communication generated by NWDAF (see TS 23.288 [86]) to decide MICO mode parameters. If the UE does not indicate preference for MICO mode during Registration procedure, the AMF shall not activate MICO mode for this UE.
The UE and the AMF re- negotiate the MICO mode at every subsequent Registration procedure. When the UE is in CM-CONNECTED, the AMF may deactivate MICO mode by triggering Mobility Registration Update procedure through UE Configuration Update procedure as described in clause 4.2.4 of TS 23.502 [3].
The AMF assigns a registration area to the UE during the Registration procedure. When the AMF indicates MICO mode to a UE, the registration area is not constrained by paging area size. If the AMF serving area is the whole PLMN, based on local policy, and subscription information, may decide to provide an "all PLMN" registration area to the UE. In that case, re-registration to the same PLMN due to mobility does not apply.
If Mobility Restrictions are applied to a UE in MICO mode, the AMF needs to allocate an Allowed Area/Non-Allowed Area to the UE as specified in clause 5.3.4.1.
When the AMF indicates MICO mode to a UE, the AMF considers the UE always unreachable while the UE CM state in the AMF is CM-IDLE. The AMF rejects any request for downlink data delivery for UE in MICO mode and whose UE CM state in the AMF is CM-IDLE with an appropriate cause. For MT-SMS over NAS, the AMF notifies the SMSF that UE is not reachable, then the procedure of the unsuccessful Mobile terminating SMS delivery described in clause 4.13.3.9 of TS 23.502 [3] is performed. The AMF also defers location services, etc. The UE in MICO mode is only reachable for mobile terminated data or signalling when the UE is in CM-CONNECTED.
A UE in MICO mode need not listen to paging while in CM-IDLE. A UE in MICO mode may stop any access stratum procedures in CM-IDLE, until the UE initiates transition from CM-IDLE to CM-CONNECTED due to one of the following triggers:
-	A change in the UE (e.g. change in configuration) requires an update of its registration with the network.
-	Periodic registration timer expires.
-	MO data pending.
-	MO signalling pending (e.g. SM procedure initiated).
If a registration area that is not the "all PLMN" registration area is allocated to a UE in MICO mode, then the UE determines if it is within the registration area or not when it has MO data or MO signalling, and the UE performs Mobility Registration Update before the UE initiates the MO data or MO signalling if it is not within the registration area.
A UE initiating emergency service shall not indicate MICO preference during Registration procedure. When the MICO mode is already activated in the UE, the UE and AMF shall locally disable MICO mode after PDU Session Establishment procedure for Emergency Services is completed successfully. The UE and the AMF shall not enable MICO mode until the AMF accepts the use of MICO mode in the next registration procedure. To enable an emergency call back, the UE should wait for a UE implementation-specific duration of time before requesting the use of MICO mode after the release of the emergency PDU session.
In order to enable power saving for MT reachability e.g. for Cellular IoT, enhancements to MICO mode are specified in clause 5.31.7:
-	MICO mode with Extended Connected Time.
-	MICO mode with Active Time.
-	MICO mode and Periodic Registration Timer Control.
During Registration procedure, the UE supporting the Unavailability Period feature provides "Unavailability Period Support" indication as part of 5GMM Core Network Capability in Registration Request message for initial registration and for every mobility registration. The AMF indicates whether the corresponding feature is supported in the AMF by providing the "Unavailability Period Supported" indication in Registration Accept message.
If the UE and network support Unavailability Period and an event is triggered in the UE that would make the UE unavailable or lose coverage (see clause 5.4.13.1) for a certain period of time, the UE uses Support of Unavailability Period to inform the AMF of the upcoming unavailability and whether it is due to NR satellite access discontinuous coverage. Use of Support of Unavailability Period for loss of coverage due to NR satellite access discontinuous coverage shall only be used if both UE and the AMF signalled "discontinuous coverage support", see clause 5.4.13.0.
If the use of Support of Unavailability Period is not due to NR satellite access discontinuous coverage, the UE may store its MM and SM context in the USIM or Non-Volatile memory in the ME to be able to reuse it after its unavailability period. If the UE can store its contexts the UE may trigger Mobility Registration Update procedure otherwise the UE shall trigger UE-initiated Deregistration procedure.
NOTE:	How and where the UE stores its contexts depends upon the UE implementation and the type of unavailability. The UE can store some or all of its contexts in the ME or USIM using existing ME or USIM functionality.
Before the start of an event that makes the UE unavailable, the UE includes an indication and type of unavailability, the Start of the Unavailability Period if known and the Unavailability Period Duration (if known) and triggers either Mobility Registration Update or UE initiated Deregistration procedure:
a)	If the UE initiates Mobility Registration Update procedure:
1)	If the UE did not include a Start of Unavailability Period, the AMF considers implicitly the Start of Unavailability Period to be the time at which it has received the Registration Request message from the UE. If the UE included a Start of Unavailability Period, the Start of Unavailability Period indicates the time at which the UE determines it expects to be unavailable, i.e. time until which the UE determines it is available.
2)	The AMF may determine, if not provided by the UE, or update the Unavailability Period Duration.
	If the AMF knows an Unavailability Period Duration (e.g. based on the type of unavailability and other information available to the AMF as described in clause 5.4.13.3), and the UE did not include an Unavailability Period Duration or the UE included an Unavailability Period Duration different to the Unavailability Period Duration known to the AMF, the AMF may use either the Unavailability Period Duration known to the AMF or the Unavailability Period Duration from the UE as the Unavailability Period Duration. The AMF should include the Unavailability Period Duration known to the AMF in the Registration Accept. How the UE treats the AMF provided Unavailability Period Duration is up to UE implementation e.g. to help to determine when to return to coverage after a discontinuous coverage period, whether to listen to paging in eDRX, not to initiate any NAS signalling (including Service Request for MO data) within the discontinuous coverage period in case of any UL signalling/data request or the UE may deactivate its Access Stratum functions for NR satellite access in order to optimise power consumption until coverage returns, etc.
3)	The AMF indicates to the UE in the Registration Accept whether the UE is not required to perform a Registration procedure when the unavailability period has ended, is delayed or is cancelled.
4)	The AMF may take the Unavailability Period Duration (if available) and Start of Unavailability Period into account when determining Periodic Registration Update timer value. The AMF may provide a Periodic Registration Update time longer than or equal to the combination of the Unavailability Period Duration and Start of Unavailability Period to avoid interfering with the UE dealing with the event that causes the unavailability;
5)	The AMF stores the information that the UE is unavailable at the Start of Unavailability Period in UE context, and considers the UE is unreachable (i.e. clear the PPF in AMF) from then until the UE enters CM-CONNECTED state;
6)	While the UE is unreachable, all high latency communication solutions (see clause 5.31.8) apply if supported in the network, e.g. extended data buffering, downlink data buffering status report, etc; and
7)	If there is "Loss of Connectivity" event subscription for the UE by AF, the AMF considers the remaining time in the Unavailability Period (if available) when constructing the "Loss of Connectivity" event report towards the NEF and the Unavailability Period is reported to the respective subscribed AF.
b)	If the UE initiates UE-initiated Deregistration procedure:
1)	If there is "Loss of Connectivity" event subscription for the UE by AF, the AMF considers the remaining time in the Unavailability Period when constructing the "Loss of Connectivity" event report towards the NEF and the Unavailability Period is reported to the respective subscribed AF;
Unless the AMF indicated that the UE is not required to perform a Registration procedure when the unavailability period has ended, is delayed or is cancelled, then once the event which makes the UE unavailable is completed in the UE or the event is delayed to a future time or cancelled in the UE, the UE triggers Registration procedure. The UE may also trigger a Registration procedure before the Unavailability Period has started for other reasons. Depending on the UE state, the Registration procedure can be Initial Registration procedure or Mobility Registration Update procedure.
If the UE determines an upcoming loss of coverage no longer applies or determines a new Start of Unavailability Period or Unavailability Period Duration related to the upcoming loss of coverage, the UE sends a new Registration Request.
The UE and the AMF re-negotiate unavailability at every Registration procedure, if it is required. If Start of Unavailability Period and/or Unavailability Period Duration is not included in a Registration procedure any pending unavailability configuration stored in the UE context at AMF is discarded.
Editor's note:	The encoding of the Start of Unavailability Period and the indication for use of Support of Unavailability will be determined by CT WG1.
For a UE in CM-CONNECTED state:
-	the AMF knows the UE location on a serving (R)AN node granularity.
-	the NG-RAN notifies the AMF when UE becomes unreachable from RAN point of view.
UE RAN reachability management is used by RAN for UEs in RRC_INACTIVE state, see TS 38.300 [27]. The location of a UE in RRC_INACTIVE state is known by the RAN on a RAN Notification area granularity. A UE in RRC_INACTIVE state is paged in cells of the RAN Notification area that is assigned to the UEs. The RAN Notification area can be a subset of cells configured in UE's Registration Area or all cells configured in the UE's Registration Area. UE in RRC_INACTIVE state performs RAN Notification Area Update when entering a cell that is not part of the RAN Notification area that is assigned to the UE.
At transition into RRC_INACTIVE state RAN configures the UE with a periodic RAN Notification Area Update timer value and the timer is restarted in the UE with this initial timer value. After the expiry of the periodic RAN Notification Area Update timer in the UE, the UE in RRC_INACTIVE state performs periodic RAN Notification Area Update, as specified in TS 38.300 [27].
To aid the UE reachability management in the AMF, RAN uses a guard timer with a value longer than the RAN Notification Area Update timer value provided to the UE. Upon the expiry of the periodic RAN Notification Area Update guard timer in RAN, the RAN shall initiate the AN Release procedure as specified in TS 23.502 [3]. The RAN may provide the elapsed time since RAN's last contact with the UE to AMF.
Based on operator configuration, the 5GS supports the AMF and NG-RAN to apply different paging strategies for different types of traffic.
In the case of UE in CM-IDLE state, the AMF performs paging and determines the paging strategy based on e.g. local configuration, what NF triggered the paging and information available in the request that triggered the paging. If NWDAF is deployed, the AMF may also use analytics (i.e. statistics or predictions) on the UE's mobility as provided by NWDAF (see TS 23.288 [86]).
In the case of UE in CM-CONNECTED with RRC_INACTIVE state, the NG-RAN performs paging and determines the paging strategy based on e.g. local configuration, and information received from AMF as described in clause 5.4.6.3 and SMF as described in clause 5.4.3.2.
In the case of Network Triggered Service Request from SMF, the SMF determines the 5QI and ARP based on the downlink packet (if the SMF performs buffering) or the Downlink Data Report received from UPF (if the UPF performs buffering). The SMF includes the 5QI and ARP corresponding to the QoS Flow of the received downlink PDU in the request sent to the AMF. If the UE is in CM IDLE, the AMF uses e.g. the 5QI and ARP to derive different paging strategies as described in clause 4.2.3.3 of TS 23.502 [3].
NOTE:	The 5QI is used by AMF to determine suitable paging strategies.
Paging policy differentiation is an optional feature that allows the AMF, based on operator configuration, to apply different paging strategies for different traffic or service types provided within the same PDU Session. In this Release of the specification this feature applies only to PDU Session of IP type.
When the 5GS supports the Paging Policy Differentiation (PPD) feature, the DSCP value (TOS in IPv4 / TC in IPv6) is set by the application to indicate to the 5GS which Paging Policy should be applied for a certain IP packet. For example, as defined in TS 23.228 [15], the P-CSCF may support Paging Policy Differentiation by marking packet(s) to be sent towards the UE that relate to a specific IMS services (e.g. conversational voice as defined in IMS multimedia telephony service).
NOTE 1:	This PPD feature may be used to determine the Paging Cause Indication for Voice Service, as described in clause 5.38.3.
It shall be possible for the operator to configure the SMF in such a way that the Paging Policy Differentiation feature only applies to certain HPLMNs, DNNs and 5QIs. In the case of HR roaming, this configuration is done in the SMF in the VPLMN.
NOTE 2:	Support of Paging Policy Differentiation in the case of HR roaming requires inter operator agreements including on the DSCP value associated with this feature.
In the case of Network Triggered Service Request and UPF buffering downlink packets, the UPF shall include the DSCP in TOS (IPv4) / TC (IPv6) value from the IP header of the downlink packet and an indication of the corresponding QoS Flow in the Downlink Data Report sent to the SMF. When PPD applies, the SMF determines the Paging Policy Indicator (PPI) based on the DSCP received from the UPF.
In the case of Network Triggered Service Request and SMF buffering downlink packets, when PPD applies, the SMF determines the PPI based on the DSCP in TOS (IPv4) / TC (IPv6) value from the IP header of the received downlink packet and identifies the corresponding QoS Flow from the QFI of the received downlink packet.
The SMF includes the PPI, the ARP and the 5QI of the corresponding QoS Flow in the N11 message sent to the AMF. If the UE is in CM IDLE, the AMF uses this information to derive a paging strategy, and sends paging messages to NG-RAN over N2.
NOTE 3:	Network configuration needs to ensure that the information used as a trigger for Paging Policy Indication is not changed within the 5GS.
NOTE 4:	Network configuration needs to ensure that the specific DSCP in TOS (IPv4) / TC (IPv6) value, used as a trigger for Paging Policy Indication, is managed correctly in order to avoid the accidental use of certain paging policies.
For a UE in RRC_INACTIVE state the NG-RAN may enforce specific paging policies in the case of NG-RAN paging, based on 5QI, ARP and PPI associated with an incoming DL PDU. To enable this, the SMF instructs the UPF to detect the DSCP in the TOS (IPv4) / TC (IPv6) value in the IP header of the DL PDU (by using a DL PDR with the DSCP for this traffic) and to transfer the corresponding PPI in the CN tunnel header (by using a QER with the PPI value). The NG-RAN can then utilize the PPI received in the CN tunnel header of an incoming DL PDU in order to apply the corresponding paging policy for the case the UE needs to be paged when in RRC_INACTIVE state. In the case of Home-Routed roaming, the V-SMF is responsible of controlling UPF setting of the PPI. In the case of PDU Session with I-SMF, the I-SMF is responsible of controlling UPF setting of the PPI.
Paging Priority is a feature that allows the AMF to include an indication in the Paging Message sent to NG-RAN that the UE be paged with priority. The decision by the AMF whether to include Paging Priority in the Paging Message is based on the ARP value in the message received from the SMF for an IP packet waiting to be delivered in the UPF. If the ARP value is associated with select priority services (e.g. MPS, MCS), the AMF includes Paging Priority in the Paging Message. When the NG-RAN receives a Paging Message with Paging Priority, it handles the page with priority.
The AMF while waiting for the UE to respond to a page sent without priority receives another message from the SMF with an ARP associated with select priority services (e.g. MPS, MCS), the AMF sends another Paging message to the (R)AN including the Paging Priority. For subsequent messages, the AMF may determine whether to send the Paging message with higher Paging Priority based on local policy.
For a UE in RRC_INACTIVE state, the NG-RAN determines Paging Priority based on the ARP associated with the QoS Flow as provisioned by the operator policy, and the Core Network Assisted RAN paging information from AMF as described in clause 5.4.6.3.
This clause applies when no radio capability signalling optimisation is used between a UE and the network.
The UE Radio Capability information is defined in TS 38.300 [27] and contains information on RATs that the UE supports (e.g. power class, frequency bands, etc). Consequently, this information can be sufficiently large that it is undesirable to send it across the radio interface at every transition of UE CM state in the AMF from CM-IDLE to CM-CONNECTED. To avoid this radio overhead, the AMF shall store the UE Radio Capability information during CM-IDLE state for the UE and RM-REGISTERED state for the UE and the AMF shall if it is available, send its most up to date UE Radio Capability information to the RAN in the N2 REQUEST message, i.e. INITIAL CONTEXT SETUP REQUEST or UE RADIO CAPABILITY CHECK REQUEST.
NOTE 1:	Due to issues with the handling of dynamic UMTS security parameters, the UTRA UE Radio Capability information is excluded from the information that is uploaded and stored in the AMF (see TS 38.300 [27]).
The AMF deletes the UE radio capability when the UE RM state in the AMF transitions to RM-DEREGISTERED. When the AMF receives Registration Request with the Registration type set to Initial Registration or when it receives the first Registration Request after E-UTRA/EPC Attach with Registration type set to Mobility Registration Update, the AMF deletes the UE radio capability.
The UE Radio Capability is maintained in the core network, even during AMF reselection.
NOTE 2:	The UE Radio Capability is not transferred to EPC during the inter-system mobility.
If the UE's NG-RAN or E-UTRAN UE Radio Capability information changes while in CM-IDLE state, the UE shall perform the Registration procedure with the Registration type set to Mobility Registration Update and it also includes "UE Radio Capability Update". (For specific requirements for a UE operating in dual-registration mode see clause 5.17.2.1). When the AMF receives Mobility Registration Update Request with "UE Radio Capability Update" requested by the UE, it shall delete any UE Radio Capability information that it has stored for the UE. If the UE's NG-RAN UE Radio Capability information changes when the UE is in CM-IDLE with Suspend, NAS shall trigger AS to establish a new RRC connection and not resume the existing one in order to perform the Registration procedure with the Registration type set to Mobility Registration Update including "UE Radio Capability Update". As a result of this, the access stratum in the UE will discard the AS information and establish a new RRC connection as defined in TS 36.331 [51].
If the trigger to change the UE's NG-RAN or E-UTRAN UE Radio Capability information happens when the UE is in CM-CONNECTED state, the UE shall first enter CM-IDLE state and then perform the Registration procedure with the Registration type set to Mobility Registration Update and it also includes "UE Radio Capability Update".
The RAN stores the UE Radio Capability information, received in the N2 message or obtained from the UE, for the duration of the UE staying in RRC_CONNECTED or RRC_INACTIVE state. Before any 5G SRVCC handover attempt from NG-RAN to UTRAN, the RAN retrieves the UE's UTRA UE Radio Capabilities from the UE. (For specific requirements for a UE operating in dual-registration mode see clause 5.17.2.1).
If the AMF sends N2 REQUEST (i.e. INITIAL CONTEXT SETUP REQUEST or UE RADIO CAPABILITY CHECK REQUEST) message to NG-RAN without UE Radio Capability information in that message and there is no UE Radio Capability information available in RAN, this triggers the RAN to request the UE Radio Capability from the UE and to upload it to the AMF in the N2 UE RADIO CAPABILITY INFO INDICATION message.
If a UE supports both NB-IoT and other RATs the UE handles the UE Radio capability information as follows:
-	When the UE is camping on NB-IoT the UE provides only NB-IoT UE radio capabilities to the network.
-	When the UE is not camping on NB-IoT, the UE provides UE radio capabilities for the RAT but not NB-IoT UE radio capabilities to the network.
In order to handle the distinct UE radio capabilities, the AMF stores a separate NB-IoT specific UE Radio Capability information when the UE provides the UE Radio Capability information while camping on NB-IoT.
When the UE is camping on NB-IoT, the AMF sends, if available, the NB-IoT RAT specific UE Radio Capability information to the E-UTRAN.
When the UE is not camping on NB-IoT, the AMF sends, if available, UE radio capabilities for the RAT but not NB-IoT radio capabilities.
5.4.4.1a	UE radio capability signalling optimisation (RACS)
With the increase of the size of UE radio capabilities driven e.g. by additional frequency bands and combinations thereof for E-UTRA and NR, an efficient approach to signal UE Radio Capability Information over the radio interface and other network interfaces is defined with RACS.
In this Release of the specification, RACS does not apply to NB-IOT.
RACS works by assigning an identifier to represent a set of UE radio capabilities. This identifier is called UE Radio Capability ID. A UE Radio Capability ID can be either UE manufacturer-assigned or PLMN-assigned, as specified in clause 5.9.10. The UE Radio Capability ID is an alternative to the signalling of the UE Radio Capability information over the radio interface, within NG-RAN, from NG-RAN to E-UTRAN, from AMF to NG-RAN and between CN nodes supporting RACS.
PLMN-assigned UE Radio Capability ID is assigned to the UE using the UE Configuration Update Command, or Registration Accept as defined in TS 23.502 [3]. The UCMF shall be configured with a Version ID for PLMN-assigned UE Radio Capability IDs, defined in clause 5.9.10.
The UCMF (UE radio Capability Management Function) stores all UE Radio Capability ID mappings in a PLMN and is responsible for assigning every PLMN-assigned UE Radio Capability ID in this PLMN, see clause 6.2.21. The UCMF stores the UE Radio Capability IDs alongside the UE Radio Capability information and the UE Radio Capability for Paging they map to. Each UE Radio Capability ID stored in the UCMF can be associated to one or both UE radio capabilities formats specified in TS 36.331 [51] and TS 38.331 [28]. The two UE radio capabilities formats shall be identifiable by the AMF and UCMF and the AMF shall store the TS 38.331 [28] format only.
An NG-RAN which supports RACS can be configured to operate with one of two modes of operation when providing the UE radio capabilities to the AMF when the NG-RAN executes a UE Radio Capability Enquiry procedure (see TS 38.331 [28]) to retrieve UE radio capabilities from the UE:
-	Mode of operation A): The NG-RAN provides to the AMF both formats (i.e. the TS 38.331 [28] format and TS 36.331 [51] format). The NG-RAN derives one of the UE Radio Capability formats using local transcoding of the other format it receives from the UE and extracts the E-UTRAN UE Radio Capability for Paging and NR UE Radio Capability for Paging from the UE Radio capabilities.
-	Mode of operation B): The NG-RAN provides to the AMF the TS 38.331 [28] format only.
In a PLMN supporting RACS only in 5GS, Mode of Operation B shall be configured.
If the PLMN supports RACS in both EPS and 5GS:
-	If RAN nodes in the EPS and 5GS are configured in Mode of operation B, then the UCMF shall be capable to transcode between TS 36.331 [51] and TS 38.331 [28] formats and the UCMF shall be able to generate the RAT-specific UE Radio Capability for Paging information from the UE Radio Capability.
-	If the NG-RAN is configured to operate according to Mode A, then also the E-UTRAN shall be configured to operate according to mode A and the UMCF is not required to transcode between TS 36.331 [51] and TS 38.331 [28] formats and the AMF shall provide the UE Radio Capability for Paging information.
When the NG-RAN updates the AMF with new UE radio capabilities information, the AMF provides the information obtained from the NG-RAN to the UCMF even if the AMF already has a UE Radio Capability ID for that UE. The UCMF then returns a value of UE Radio Capability ID. If the value is different from the one stored in the AMF, the AMF updates the UE Radio Capability ID it stores and provides this new value to the NG-RAN (if applicable) and to the UE.
In order to be able to interpret the UE Radio Capability ID a Network Function or node may store a local copy of the mapping between the UE Radio Capability ID and its corresponding UE Radio Capability information i.e. a dictionary entry. When no mapping is available between a UE Radio Capability ID and the corresponding UE Radio Capability information in a Network Function or node, this Network Function or node shall be able to retrieve this mapping and store it.
-	An AMF which supports RACS shall store such UE Radio Capability ID mapping at least for all the UEs that it serves that have a UE Radio Capability ID assigned.
-	The NG-RAN performs local caching of the UE Radio Capability information for the UE Radio Capability IDs for the UEs it is serving, and potentially for other UE Radio Capability IDs according to suitable local policies.
-	When the NG-RAN needs to retrieve the mapping of a UE Radio Capability ID to the corresponding UE Radio Capability information, it queries the AMF using N2 signalling defined in TS 38.413 [34].
-	When the AMF needs to obtain a PLMN-assigned UE Radio Capability ID for a UE from the UCMF, it provides the UE Radio Capability information it has for the current radio configuration of the UE and the IMEI/TAC for the UE and the UCMF returns a UE Radio Capability ID. The AMF shall provide to the UCMF the UE Radio Capability information (and at least in Mode A, the UE Radio Capability for Paging) obtained from the NG-RAN in one or both the TS 36.331 [51] and TS 38.331 [28] formats depending on how the RAN is configured. The UCMF stores the association of this IMEI/TAC with this UE Radio Capability ID and the UE Radio Capability information and the UE Radio Capability for Paging in all the formats it receives. The UE Radio Capability information formats the AMF provides shall be identifiable at the UCMF.
-	When the AMF needs to obtain the UE Radio Capability information and the UE Radio Capability for Paging associated to a UE Radio Capability ID it provides the UE Radio Capability ID to the UCMF with an indication that it is requesting the TS 38.331 [28] format and the UCMF returns a mapping of the UE Radio Capability ID to the corresponding UE Radio Capability information in TS 38.331 [28] format to the AMF.
-	UEs, AMFs and RAN nodes which support RACS learn the current value of the Version ID when a new PLMN-assigned UE Radio Capability ID is received from the UCMF and the Version ID it contains is different from the ones in their PLMN Assigned UE Radio Capability ID cache. For a PLMN, PLMN-assigned UE Radio Capability IDs related to old values (i.e. not current value) of the Version ID can be removed from cache but, if so, prior to removing any cached PLMN-assigned UE radio Capability IDs with the current value of the Version ID. The AMF, RAN and UE may continue to use the stored PLMN assigned UE Radio Capability IDs with old values of the Version ID, until these are purged from cache. If an out of date PLMN assigned UE Radio Capability ID is removed form an AMF cache, the AMF shall proceed to assign a new PLMN assigned UE Radio Capability ID to all the UEs for which the UE context includes the removed PLMN-assigned UE Radio Capability ID using a UE Configuration Update procedure, or when these UEs perform a Registration. If the AMF attempts to resolve a PLMN assigned UE Radio capability ID with an old Version ID, the UCMF shall return an error code indicating that the Version ID in the UE radio capability ID is no longer current and proceed to assign a new UE Radio Capability ID to the UE.
	If at any time the AMF has neither a valid UE Radio Capability ID nor any stored UE radio capabilities for the UE, the AMF may trigger the RAN to provide the UE Radio Capability information and subsequently request the UCMF to allocate a UE Radio Capability ID.
-	The RAN, in order to support MOCN network sharing scenarios, shall be capable to cache PLMN assigned UE Radio Capability IDs per PLMN ID.
A network may utilise the PLMN-assigned UE Radio Capability ID, without involving the UE, e.g. for use with legacy UEs.
Mutual detection of the support of the RACS feature happens between directly connected NG-RAN nodes and between NG-RAN and AMF using protocol means as defined in TS 38.413 [34] and TS 38.423 [99]. To allow for a mix of RACS-supporting and non-RACS-supporting RAN nodes over the Xn interfaces, the UE Radio Capability ID should be included in the Path Switch signalling during Xn based handover and Handover Request during N2 based handover between AMF and NG-RAN. In addition, RACS-supporting RAN nodes can be discovered across inter-CN node boundaries by using the mechanism defined in TS 38.413 [34] that allows the source NG-RAN node to retrieve information on the level of support for a certain feature at the target NG-RAN side by means of information provided within the Source to Target and Target to Source transparent handover containers during handover procedure. The support of RACS by peer AMFs or MMEs is based on configuration in a PLMN or across PLMNs.
A UE that supports WB-E-UTRA and/or NR indicates its support for RACS to AMF using UE MM Core Network Capability as defined in clause 5.4.4a.
A UE that supports RACS and stores an applicable UE Radio Capability ID for the current UE Radio Configuration in the PLMN, shall signal the UE Radio Capability ID in the Initial, and Mobility Registration procedure as defined in TS 23.502 [3] and based on triggers defined in TS 24.501 [47]. If both PLMN-assigned for the current PLMN and UE manufacturer-assigned UE Radio Capability IDs are stored in the UE and applicable in the PLMN, the UE shall signal the PLMN-assigned UE Radio Capability ID in the Registration Request message.
When a PLMN decides to switch to request a particular type of UE to use UE manufacturer-assigned UE Radio Capability ID(s):
-	The UCMF sends a Nucmf_UECapabilityManagement_Notify message to the AMF including either a list of UE Radio Capability IDs (if the UE was previously using any PLMN-assigned IDs) or the IMEI/TAC values corresponding to UE types that are requested to use UE manufacturer-assigned UE Radio Capability ID. These values are stored in a "UE Manufacturer Assigned operation requested list" in the AMF.
-	The AMF uses the Registration Accept message or the UE Configuration Update command message to request the UE to delete all the PLMN-assigned UE Radio Capability ID(s) for this PLMN if the UE is, respectively, registering or is registered with PLMN-assigned ID or IMEI/TAC values matching one value in the "UE Manufacturer Assigned operation requested list".
NOTE 1:	It is expected that in a given PLMN the UCMF and AMFs will be configured to either use a UE manufacturer-assigned operation requested list based on a list of PLMN-assigned UE Radio Capability IDs or a list of IMEI/TACs, but not both.
NOTE 2:	The strategy for triggering of the deletion of PLMN-assigned UE Radio Capability ID(s) in the UE by the AMF is implementation-specific (e.g. can be used only towards UEs in CM-CONNECTED state).
-	a UE that receives indication to delete all the PLMN-assigned UE Radio Capability IDs in the Registration Accept message, or UE Configuration Update command message, shall delete any PLMN-assigned UE Radio Capability IDs for this PLMN. The UE proceeds to register with a UE manufacturer-assigned UE Radio Capability ID that is applicable to the current UE Radio configuration.
-	When the "UE Manufacturer Assigned operation requested list" contains PLMN-assigned UE Radio Capability IDs, the UCMF shall avoid re-assigning PLMN-assigned UE Radio Capability IDs that were added to the "UE Manufacturer Assigned operation requested list" in the AMFs to any UE.
-	The AMF stores a PLMN-assigned ID in the "UE Manufacturer Assigned operation requested list" for a time duration that is implementation specific, but IMEI/TACs are stored until the UCMF require to remove certain TACs from the list (i.e. the list of IMEI/TACs which are requested to use UE manufacturer-assigned IDs in the AMF and UCMF is synchronised at all times).
-	The UCMF can request at any time the AMF to remove PLMN-assigned ID(s) or IMEI/TAC(s) values from the UE manufacturer-assigned operation requested list.
NOTE 3:	The AMF can decide to remove a UE Radio Capability ID from the "UE Manufacturer Assigned operation requested list" list e.g. because no UE with that UE Radio Capability ID has connected to the network for long time. If later a UE with such UE Radio Capability ID connects to the network, the AMF contacts the UCMF to resolve the UE Radio Capability ID, and at this point the UCMF can trigger again the deletion of the UE Radio Capability ID by including this in the "UE Manufacturer Assigned operation requested list" of the AMF.
The serving AMF stores the UE Radio Capability ID related to selected PLMN for a UE in the UE context and provides this UE Radio Capability ID to NG-RAN as part of the UE context information using N2 signalling. During inter PLMN mobility, the new AMF shall delete the UE Radio Capability ID received from the old AMF, unless the operator policy indicates that all UE Radio Capability IDs used in the old PLMN is also valid in the new PLMN.
NOTE 4:	If AMF decides to allocate TAIs of multiple PLMN IDs as part of Registration Area to the UE then AMF provides the UE Radio Capability ID of the new selected PLMN to the NG-RAN during UE mobility, whether the UE Radio Capability ID is taken from stored UE context previously assigned by the same new selected PLMN or generated freshly each time a new PLMN is selected is up to AMF implementation.
The UE stores the PLMN-assigned UE Radio Capability ID in non-volatile memory when in RM-DEREGISTERED state and can use it again when it registers in the same PLMN.
NOTE 5:	It is assumed that UE does not need to store the access stratum information (i.e. UE-E-UTRA-Capability and UE-NR-Capability specified in TS 36.331 [51] and TS 38.331 [28], respectively) that was indicated by the UE to the network when the PLMN-assigned UE Radio Capability ID was assigned by the network. However, it is assumed that the UE does store the related UE configuration (e.g. whether or not GERAN or UTRAN or MBMS is enabled/disabled).
At any given time at most one UE Radio Capability ID is used from the UE context in CN and RAN which is related to the selected PLMN.
The number of PLMN-assigned UE Radio Capability IDs that the UE stores in non-volatile memory is left up to UE implementation. However, to minimise the load (e.g. from radio signalling) on the Uu interface and to provide smoother inter-PLMN mobility (e.g. at land borders) the UE shall be able to store at least the latest 16 PLMN-assigned UE Radio Capability IDs (along with the PLMN that assigned them). This number is independent of the UE manufacturer-assigned UE Radio Capability ID(s) the UE may store.
It shall be possible for a UE to change, e.g. upon change in its usage settings, the set of UE radio capabilities in time and signal the associated UE Radio Capability ID, if available. The UE stores the mapping between the UE Radio Capability ID and the corresponding UE Radio Capability Information for every UE Radio Capability ID it stores.
If the UE's Radio Capability Information changes and regardless of whether the UE has an associated UE Radio Capability ID for the updated UE Radio Capability information, the UE shall perform the Registration procedure by sending a Registration Request message to the AMF with the Registration type set to Mobility Registration Update which includes "UE Radio Capability Update" and:
-	If the UE has an associated UE Radio Capability ID for the updated UE Radio Capability information, the UE shall include it in the Registration Request message so that the AMF, upon receiving it, shall update the UE's context with this UE Radio Capability ID.
-	If the UE does not have an associated UE Radio Capability ID for the updated UE Radio Capability information, the UE shall not include any UE Radio Capability ID in the Registration Request message so that the AMF, upon receiving this Registration Request without any UE Radio Capability ID, retrieves the UE radio capabilities from the UE as defined in clause 5.4.4.1.
The NG-RAN may apply RRC filtering of UE radio capabilities when it retrieves the UE Radio Capability Information from the UE as defined in TS 38.331 [28].
NOTE 6:	In a RACS supporting PLMN, the filter of UE radio capabilities configured in NG-RAN is preferably as wide in scope as possible (e.g. PLMN-wide). In this case, it corresponds e.g. to the super-set of bands, band-combinations and RATs the PLMN deploys and not only to the specific NG-RAN node or region.
NOTE 7:	If the filter, included in the UE Radio Capability information, of UE radio capabilities configured in two NG-RAN nodes is different, during handover between these two nodes, it is possible that the target NG-RAN node might need to enquire the UE for its UE Radio Capability Information again and trigger re-allocation of a PLMN-assigned UE Radio Capability ID leading to extra signalling. Additionally, a narrow filter might reduce the list of candidate target nodes.
If a UE supports both NB-IoT and other RATs that do support RACS (e.g. WB-E-UTRA and/or NR) then (since there is no support for RACS in NB-IoT) the UE handles the RACS procedures as follows:
-	NB-IoT specific UE Radio Capability Information is handled in UE, NG-RAN and AMF according to clause 5.4.4.1 and in EPS according to TS 23.401 [26].
-	when the UE is not camping on NB-IoT, the RAN provides UE radio capabilities for other RATs but not NB-IoT UE radio capabilities, according to TS 38.300 [27] and TS 36.300 [30]. As a result the UE Radio Capability ID that is assigned by the network corresponds only to the UE radio capabilities of the non-NB-IoT RATs. The UE uses the UE Radio Capability IDs assigned only in Mobility Registration Update procedures performed over non-NB-IoT RATs.
Support for RACS in EPS is defined in TS 23.401 [26].

5.4.4.2a	UE Radio Capability Match Request
If the AMF requires more information on the UE radio capabilities support to be able to set the IMS voice over PS Session Supported Indication (see clause 5.16.3), then the AMF may send a UE Radio Capability Match Request message to the NG-RAN. This procedure is typically used during the Registration Procedure or when AMF has not received the Voice Support Match Indicator (as part of the 5GMM Context).
NOTE:	During the Registration Procedure, if the AMF does not already have the UEs radio capabilities, and if the RAT where the UE is requires the establishment of AN security context prior to retrieval of radio capabilities, the AMF needs to initiate "Initial Context Setup" procedure as defined in TS 38.413 [34] to provide the 5G-AN with security context, before sending a UE Radio Capability Match Request message.
The paging assistance information contains UE radio related information that assists the RAN for efficient paging. The Paging assistance information contains:
a)	UE radio capability for paging information:
-	The UE Radio Capability for Paging Information contains information derived by the NG-RAN node (e.g. band support information) from the UE Radio Capability information. The AMF stores this information without needing to understand its contents.
	As the AMF only infrequently (e.g. at Initial Registration) prompts the NG-RAN to retrieve and upload the UE radio capabilities i.e. UE Radio Capability information to the AMF, and the AMF may be connected to more than one NG-RAN RAT, it is the responsibility of the NG-RAN to ensure that UE Radio Capability for Paging Information (which is derived by the NG-RAN node) contains information on all NG-RAN RATs that the UE supports in that PLMN. To assist the NG-RAN in this task, as specified in TS 38.413 [34], the AMF provides its stored UE Radio Capability for Paging Information in every NG-AP INITIAL CONTEXT SETUP REQUEST message sent to the NG-RAN.
-	The UE Radio Capability for Paging Information is maintained in the core network, even during AMF reselection, and is stored in the UCMF alongside the UE Radio Capability information associated to a UE Radio Capability ID.
b)	Information On Recommended Cells And RAN nodes For Paging:
-	Information sent by the NG-RAN, and used by the AMF when paging the UE to help determining the NG RAN nodes to be paged as well as to provide the information on recommended cells to each of these RAN nodes, in order to optimize the probability of successful paging while minimizing the signalling load on the radio path.
-	The RAN provides this information during N2 release.
5.4.4a	UE MM Core Network Capability handling
The UE MM Core Network Capability is split into the S1 UE network capability (mostly for E-UTRAN access related core network parameters) and the UE 5GMM Core Network Capability (mostly to include other UE capabilities related to 5GCN or interworking with EPS) as defined in TS 24.501 [47] and contains non radio-related capabilities, e.g. the NAS security algorithms, etc. The S1 UE network capability is transferred between all CN nodes at AMF to AMF, AMF to MME, MME to MME, and MME to AMF changes. The UE 5GMM Core Network Capability is transferred only at AMF to AMF changes.
In order to ensure that the UE MM Core Network Capability information stored in the AMF is up to date (e.g. to handle the situation when the USIM is moved into a different device while out of coverage, and the old device did not send the Detach message; and the cases of inter-RAT Registration Area Update), the UE shall send the UE MM Core Network Capability information to the AMF during the Initial Registration and Mobility Registration Update procedure within the NAS message.
The AMF shall store always the latest UE MM Core Network Capability received from the UE. Any UE MM Core Network Capability that an AMF receives from an old AMF/MME is replaced when the UE provides the UE MM Core Network Capability with Registration signalling.
If the UE's UE MM Core Network Capability information changes (in either CM-CONNECTED or in CM-IDLE state), the UE shall perform a Mobility Registration Update procedure when it next returns to NG-RAN coverage. See clause 4.2.2 of TS 23.502 [3].
The UE shall indicate in the UE 5GMM Core Network Capability if the UE supports:
-	Attach in EPC with Request type "Handover" in PDN CONNECTIVITY Request message (clause 5.3.2.1 of TS 23.401 [26]).
-	EPC NAS.
-	SMS over NAS.
-	LCS.
-	5G SRVCC from NG-RAN to UTRAN, as specified in TS 23.216 [88].
-	Radio Capabilities Signalling optimisation (RACS).
-	Network Slice-Specific Authentication and Authorization.
-	Network Slice Replacement as described in clause 5.15.19.
-	Parameters in Supported Network Behaviour for 5G CIoT as described in clause 5.31.2.
-	Receiving WUS Assistance Information (E-UTRA) see clause 5.4.9.
-	Paging Subgrouping Support Indication (NR) see clause 5.4.12.
-	CAG, see clause 5.30.3.3.
-	CAG with validity information (if UE supports CAG), see clause 5.30.3.3.
-	Subscription-based restrictions to simultaneous registration of network slices (see clause 5.15.12).
-	Support of NSAG (see clause 5.15.14).
-	Partial Network Slice support in a RA (see clause 5.15.17).
-	Minimization of Service Interruption (MINT), as described in clause 5.40.
-	Equivalent SNPNs (see clause 5.30.2.11).
-	Unavailability Period, as described in clause 5.4.1.4.
-	Support for network reconnection due to RAN timing synchronization status change, see clause 5.3.4.4.
-	UE Configuration of network-controlled Slice Usage Policy (see clause 5.15.15.2).
-	Temporarily available network slices (see clause 5.15.16).
-	Support of S-NSSAI location availability information, as described in clause 5.15.18.2.
If a UE operating two or more USIMs, supports and intends to use one or more Multi-USIM features (see clause 5.38) in a PLMN for a USIM, it shall indicate in the UE 5GMM Core Network Capability for this USIM in this PLMN that it supports these one or more Multi-USIM features with the following indications:
-	Connection Release Supported.
-	Paging Cause Indication for Voice Service Supported.
-	Reject Paging Request Supported.
-	Paging Restriction Supported.
Otherwise, the UE with the capabilities of Multi-USIM features but does not intend to use them shall not indicate support of these one or more Multi-USIM features.
A UE not operating two or more USIMs shall indicate the Multi-USIM features are not supported.
NOTE:	It is not necessary for a UE operating two or more USIMs to use Multi-USIM features with all USIMs.
5.4.4b	UE 5GSM Core Network Capability handling
The UE 5GSM Core Network Capability is included in PDU Session Establishment/Modification Request.
The UE shall indicate in the UE 5GSM Core Network Capability whether the UE supports:
-	"Ethernet" PDU Session Type supported in EPC as PDN Type "Ethernet";
-	Reflective QoS;
-	Multi-homed IPv6 PDU Session (only if the Requested PDU Type was set to "IPv6" or "IPv4v6");
-	ATSSS capability (as referred to clause 5.32.2);
-	Transfer of Port Management Information containers.
The 5GSM Core Network Capability is transferred, if needed, from V-SMF to H-SMF during PDU Session Establishment/Modification procedure.
After the first inter-system change from EPS to 5GS for a PDU session established in EPS, the 5GSM Core Network Capability is also included in the PDU Session Modification if the Reflective QoS and/or Multi-homed IPv6 PDU Session is present.
The 5G System supports DRX architecture which allows Idle mode DRX cycle is negotiated between UE and the AMF. The Idle mode DRX cycle applies in CM-IDLE state and in CM-CONNECTED with RRC_INACTIVE state.
If the UE wants to use UE specific DRX parameters, the UE shall include its preferred values consistently in every Initial Registration and Mobility Registration procedure separately for NR/WB-EUTRA and NB-IoT. During Initial Registration and Mobility Registration procedures performed on NB-IoT cells, the normal 5GS procedures apply. For NB-IoT, the cell broadcasts an indication of support of UE specific DRX for NB-IoT in that cell, and the UE can request UE specific DRX for NB-IoT in the Registration procedure irrespective of whether the cell broadcasts that support indication.
The AMF shall determine Accepted DRX parameters based on the received UE specific DRX parameters and the AMF should accept the UE requested values, but subject to operator policy the AMF may change the UE requested values.
The AMF shall respond to the UE with the Accepted DRX parameters separately for NR/WB-EUTRA and NB-IoT.
For details of DRX parameters, see TS 38.331 [28] and TS 36.331 [51].
The UE shall apply the DRX cycle broadcast in the cell by the RAN unless it has received Accepted DRX parameters for the RAT from the AMF and for NB-IoT the cell supports UE specific DRX for NB-IoT, in which case the UE shall apply either the DRX cycle broadcast in the cell or the Accepted DRX parameters for the RAT, as defined in TS 38.304 [50] and TS 36.304 [52].
The Periodic Registration procedure does not change the UE's DRX settings.
In CM-CONNECTED with RRC_INACTIVE state, the UE applies either the DRX cycle negotiated with AMF, or the DRX cycle broadcast by RAN or the UE specific DRX cycle configured by RAN, as defined in TS 38.300 [27] and TS 38.304 [50].
Core Network assistance information for RAN aids the RAN to optimize the UE state transition steering and the RAN paging strategy formulation in RRC_INACTIVE state. The Core Network assistance information includes the information set, Core Network assisted RAN parameters tuning, which assist RAN optimize the UE RRC state transition and CM state transition decision. It also includes the information set, Core Network assisted RAN paging information, which assist RAN to formulate an optimized paging strategy when RAN paging is triggered.
Core Network assisted RAN parameters tuning aids the RAN to minimize the UE state transitions and achieve optimum network behaviour. How the RAN uses the CN assistance information is not defined in this specification.
Core Network assisted RAN parameters tuning may be derived by the AMF per UE in the AMF based on collection of UE behaviour statistics, Expected UE Behaviour and/or other available information about the UE (such as subscribed DNN, SUPI ranges, or other information). If the AMF maintains Expected UE Behaviour parameters, Network Configuration parameters (as described in clause 4.15.6.3 or 4.15.6.3a, TS 23.502 [3]) or SMF derived CN assisted RAN parameters tuning, the AMF may use this information for selecting the CN assisted RAN parameter values. If the AMF is able to derive the Mobility Pattern of the UE (as described in clause 5.3.4.2), the AMF may take the Mobility Pattern information into account when selecting the CN assisted RAN parameter values.
The SMF uses the SMF-Associated parameters (e.g. Expected UE Behaviour parameters or Network Configuration parameters of the UE) to derive the SMF derived CN assisted RAN parameters tuning. The SMF sends the SMF derived CN assisted RAN parameters tuning to the AMF during the PDU Session establishment procedure and if the SMF-Associated parameters change the PDU Session modification procedure is applied. The AMF stores the SMF derived CN assisted RAN parameters tuning in the PDU Session level context. The AMF uses the SMF derived CN assisted RAN parameters tuning to determine a PDU Session level "Expected UE activity behaviour" parameters set, which may be associated with a PDU Session ID, as described below in this clause.
The Expected UE Behaviour parameters or the Network Configuration parameters can be provisioned by external party via the NEF to the AMF or SMF, as described in clause 5.20.
The CN assisted RAN parameters tuning provides the RAN with a way to understand the UE behaviour for these aspects:
-	"Expected UE activity behaviour", i.e. the expected pattern of the UE's changes between CM-CONNECTED and CM-IDLE states or the duration of CM-CONNECTED state. This may be derived e.g. from the statistical information, or Expected UE Behaviour or from subscription information. The AMF derives one or more sets of the "Expected UE activity behaviour" parameters for the UE as follows:
-	AMF may derive and provide to the RAN a UE level of "Expected UE activity behaviour" parameters set considering the Expected UE Behaviour parameters or Network Configuration parameters received from the UDM (see clauses 4.15.6.3 or 4.15.6.3a of TS 23.502 [3]) and the SMF derived CN assisted RAN parameters tuning associated with a PDU Session using Control Plane CIoT 5GS Optimisation. This set of "Expected UE activity behaviour" parameters is valid for the UE; and
-	AMF may provide to the RAN a PDU Session level "Expected UE activity behaviour" parameters set, e.g. considering the SMF derived CN assisted RAN parameters tuning, per established PDU Session. The PDU Session level "Expected UE activity behaviour" set of parameters is associated with and valid for a PDU Session ID. The RAN may consider the PDU Session level "Expected UE activity behaviour" parameters when the User Plane resources for the PDU Session are activated;
-	"Expected HO behaviour", i.e. the expected interval between inter-RAN handovers. This may be derived by the AMF e.g. from the Mobility Pattern information;
-	"Expected UE mobility", i.e. whether the UE is expected to be stationary or mobile. This may be derived e.g. from the statistical information or Expected UE Behaviour parameters or from subscription information;
-	"Expected UE moving trajectory" which may be derived e.g. from the statistical information or Expected UE Behaviour parameters or from subscription information; or
-	"UE Differentiation Information" including the Expected UE Behaviour parameters excluding the Expected UE moving trajectory (see clause 4.15.6.3 of TS 23.502 [3]) to support Uu operation optimisation for NB-IoT UE differentiation if the RAT type is NB-IoT.
The AMF decides when to send this information to the RAN as "Expected UE activity behaviour" carried in N2 request over the N2 interface (see TS 38.413 [34]).
NOTE:	The calculation of the CN assistance information, i.e. the algorithms used and related criteria, and the decision when it is considered suitable and stable to send to the RAN are vendor specific.
Core Network assisted RAN paging information aids the RAN to formulate a RAN paging policy and strategy in RRC_INACTIVE state, besides the PPI and QoS information associated to the QoS Flows as indicated in clause 5.4.3.
CN assisted RAN paging information may be derived by the AMF per UE and/or per PDU Session based on collection of UE behaviour statistics, Expected UE Behaviour and/or other available information about the UE (such as subscribed DNN, SUPI ranges, Multimedia priority service), and/or information received from other network functions when downlink signalling is triggered.
The CN assisted RAN paging information consists of a service priority (values 1 to 256) which provides AN with a way to understand how important the downlink signalling is. The AMF derives this service priority based on available information as described above. The method to derive the service priority is implementation depended and can be controlled by operator.
The Core Network may provide the CN assisted RAN paging information to RAN in different occasions, e.g. during downlink N1 and N2 message delivery, etc.
NG-RAN supports the NG-RAN location reporting for the services that require accurate cell identification (e.g. emergency services, lawful intercept, charging) or for the UE mobility event notification service subscribed to the AMF by other NFs. The NG-RAN location reporting may be used by the AMF when the target UE is in CM-CONNECTED state. The NG-RAN location reporting may be used by the AMF to determine the geographically located TAI in the case of NR satellite access.
The AMF may request the NG-RAN location reporting with event reporting type (e.g. UE location or UE presence in Area of Interest), reporting mode and its related parameters (e.g. number of reporting).
If the AMF requests UE location, the NG-RAN reports the current UE location (or last known UE location with time stamp if the UE is in RRC_INACTIVE state) based on the requested reporting parameter (e.g. one-time reporting or continuous reporting).
If the AMF requests UE location, in the case of NR satellite access, the NG-RAN provides all broadcast TAIs to the AMF as part of the ULI. The NG-RAN also reports the TAI where the UE is geographically located if this TAI can be determined.
If the AMF requests UE presence in the Area Of Interest, the NG-RAN reports the UE location and the indication (i.e. IN, OUT or UNKNOWN) when the NG-RAN determines the change of UE presence in Area Of Interest.
After N2 based Handover, if the NG-RAN location reporting information is required, the AMF shall re-request the NG-RAN location reporting to the target NG-RAN node. For Xn based Handover, the source NG-RAN shall transfer the requested NG-RAN location reporting information to target NG-RAN node.
The AMF requests the location information of the UE either through independent N2 procedure (i.e. NG-RAN location reporting as specified in clause 4.10 of TS 23.502 [3]), or by including the request in some specific N2 messages as specified in TS 38.413 [34].
Support for NG-RAN using unlicensed spectrum is defined in TS 38.300 [27] and TS 36.300 [30].
For NG-RAN, in the case of NR in stand-alone mode, all cells are in unlicensed spectrum and the NR is used as primary RAT. NR or E-UTRA cells in unlicensed spectrum, can be used as secondary cells as specified in the Dual Connectivity architecture defined in clause 5.11 or in addition can be configured to support the Carrier Aggregation Architecture (CA) defined in TS 38.300 [27] and TS 36.300 [30].
For either case the serving PLMN can enforce Access Restriction for Unlicensed Spectrum (either signalled from the UDM, or, locally generated by VPLMN policy in the AMF) with the following:
-	To restrict the use of NR in unlicensed spectrum as primary RAT, the AMF rejects the UE Registration procedure with appropriate cause code defined in TS 24.501 [47] if the UE performs initial access from NR using unlicensed spectrum. If the UE is accessing through some other allowed RAT, the AMF signals this access restriction to NG-RAN as part of Mobility Restriction List.
-	To restrict the use of use of unlicensed spectrum with NR or E-UTRA as secondary RAT using Dual Connectivity or Carrier Aggregation Architecture (CA) defined in TS 38.300 [27] and TS 36.300 [30], the AMF signals this access restriction to NG-RAN as part of Mobility Restriction List.
An NG-RAN node supporting aggregation with unlicensed spectrum using either NR or E-UTRA checks whether the UE is allowed to use unlicensed spectrum based on received Mobility Restriction List. If the UE is not allowed to use Unlicensed Spectrum, the NG-RAN node shall restrict the using of unlicensed spectrum, either NR or E-UTRA as secondary RATs when using either Dual Connectivity or Carrier Aggregation (CA) as defined in TS 38.300 [27] and TS 36.300 [30].
At inter-RAT handover from E-UTRAN/EPS, the Access Restriction for Unlicensed Spectrum is either already in the AMF's UE context, or is obtained from the UDM during the subsequent Registration Area Update procedure (i.e. not from the source MME or source RAN). In both inter-RAT handover cases, any Access Restriction for use of Unlicensed Spectrum is then signalled to NG-RAN or enforced in AMF.
NOTE:	This signalling of the Access Restriction during the Registration Area Update after the inter-RAT handover procedure means that there is a small risk that unlicensed spectrum resources are transiently allocated.
When the UE is accessing 5GS using unlicensed spectrum as primary RAT:
-	The NG-RAN node shall provide an indication to the AMF in N2 interface that NR access is using unlicensed spectrum as defined in TS 38.413 [34].
-	In order to restrict access to NR in unlicensed spectrum, cells supporting NR in unlicensed spectrum have to be deployed in Tracking Area(s) different to cells supporting licensed spectrum.
-	When the AMF receives an indication from NG-RAN over N2 whether NR in unlicensed spectrum is being used as defined in TS 38.413 [34], the AMF provides to the SMF an indication that the RAT type is NR with usage of unlicensed spectrum during PDU Session Establishment or as part of the UP activation and Handover procedures.
-	The PCF will also receive the indication whether the UE is using NR in unlicensed spectrum, when applicable, from the SMF during SM Policy Association Establishment or SM Policy Association Modification procedure.
-	The NFs generating CDRs shall include the indication that the UE is using NR in unlicensed spectrum in their CDRs.
When the UE is accessing NR or E-UTRA using unlicensed spectrum as secondary RAT, procedures for Usage Data Reporting for Secondary RAT as defined in clause 5.12.2 can apply.
The RAN and UE may use a Wake Up Signal (WUS) to reduce the UE's idle mode power consumption. The RAN sends the WUS shortly before the UE's paging occasion. The WUS feature enables UEs to determine that in the paging occasions immediately following their WUS occasion they will not be paged if their WUS is not transmitted, or that they might be paged if their WUS is transmitted (see TS 36.304 [52]).
To avoid waking up UEs due to an AMF paging other UEs across multiple cells (e.g. due to frequent UE mobility and/or for low paging latency services such as VoLTE), the use of WUS by the ng-eNB and the UE is restricted to the last used cell, i.e. the cell in which the UE's RRC connection was last released. To support this:
a)	ng-eNBs should provide the Recommended Cells for Paging IE in the Information on Recommended Cells and RAN Nodes for Paging IE (see TS 38.413 [34]) to the AMF in the NGAP UE Context Release Complete, UE Context Suspend Request and UE Context Resume Request messages;
b)	if received during the last NGAP UE Context Release Complete or UE Context Suspend Request message, the AMF provides (without modification) the Recommended Cells for Paging as Assistance Data for Recommended Cells IE in the Assistance Data for Paging IE within the NGAP Paging message to the RAN (see also TS 38.413 [34]); and
c)	the AMF shall delete (or mark as invalid) the Information On Recommended Cells And RAND nodes For Paging when a new NGAP association is established for the UE.
In the NGAP Paging message, the last used cell ID is sent in the Assistance Data for Recommended Cells IE in the Assistance Data for Paging IE (see TS 38.413 [34]). When receiving an NGAP Paging message for a WUS-capable UE that also includes the Assistance Data for Recommended Cells IE then a WUS-capable ng-eNB shall only broadcast the WUS on the cell that matches the last used cell ID.
To support the Wake Up Signal (WUS), the WUS Assistance Information is used by the ng-eNB to help determine the WUS group used when paging the UE (see TS 36.300 [30]).
The content of the WUS Assistance Information consists of the paging probability information. The paging probability information provides a metric on the probability of a UE receiving a paging message based on, e.g. statistical information.
The UE may in the Registration Request message provide its capability to support receiving WUS Assistance Information. If WUS Assistance Information is supported by the UE, then the UE in the Registration Request message may provide the additional UE paging probability information. The AMF may use the UE provided paging probability, local configuration and/or previous statistical information for the UE, when determining the WUS Assistance Information. If the UE supports WUS Assistance Information, the AMF may assign WUS Assistance Information to the UE, even when the UE has not provided the additional UE paging probability information.
If the AMF has determined WUS Assistance Information for the UE, the AMF provides it to the UE in every Registration Accept message. The AMF stores the WUS Assistance Information parameter in the MM context and provides it to the ng-eNB when paging the UE.
UE and AMF shall not signal WUS Assistance Information in Registration Request, Registration Accept messages when the UE has an active emergency PDU session.
Support for NR satellite access is specified in TS 38.300 [27].
Editor's note:	TS 38.300 [27] not yet updated by RAN groups.
The AMF determines the RAT Type for NR satellite access, i.e. NR(LEO), NR(MEO), NR(GEO) and NR(OTHERSAT). When the UE is accessing NR using satellite access, an indication is provided in N2 interface indicating the type of NR satellite access, as defined in TS 38.413 [34].
Editor's note:	Further details on what type of satellite platforms OTHERSAT includes is FFS and to be aligned with RAN WG3.
The serving PLMN can enforce mobility restrictions for NR satellite access as specified in clause 5.3.4.1.
In order to enable efficient enforcement of Mobility Restrictions, cells of each NR satellite RAT Type (NR(LEO), NR(MEO), NR(GEO) or NR(OTHERSAT)) need to be deployed in TAs different from TAs for other NR satellite RAT Types as well as different from TAs supporting terrestrial access RAT Types.
The AMF may initiate deregistration of the UE when an N2 UE Context Release Request is received with cause value indicating that the UE is not in PLMN serving area, as specified in TS 38.413 [34].
This clause describes the specific aspects for NR satellite access.
In case of NR satellite access, the RAT Types values "NR(LEO)", "NR(MEO)", "NR(GEO)" and "NR(OTHERSAT)" are used in 5GC to distinguish the different NR satellite access types (see clause 5.4.10).
When a UE is accessing to the network via satellite access, the AMF determines the RAT type as specified in clause 5.4.10.

In order to ensure that the regulatory requirements are met, the network may be configured to enforce that the selected PLMN is allowed to operate in the current UE location by verifying the UE location during Mobility Management and Session Management procedures. In this case, when the AMF receives a NGAP message containing User Location Information for a UE using NR satellite access, the AMF may decide to verify the UE location. If the AMF determines based on the Selected PLMN ID and ULI (including Cell ID) received from the gNB that it is not allowed to operate at the present UE location the AMF should reject any NAS request with a suitable cause value. If the UE is already registered to the network when the AMF determines that it is not allowed to operate at the present UE location, the AMF may initiate deregistration of the UE. The AMF should not reject the request or deregister the UE unless it has sufficiently accurate UE location information to determine that the UE is located in a geographical area where the PLMN is not allowed to operate.
NOTE:	The area where the UE is allowed to operate can be determined based on the regulatory area where the PLMN is allowed to operate based on its licensing conditions.
If the AMF, based on the ULI, is not able to determine the UE's location with sufficient accuracy to make a final decision or if the received ULI is not sufficiently reliable, the AMF proceeds with the Mobility Management or Session Management procedure and may initiate UE location procedure after the Mobility Management or Session Management procedure is complete, as specified in clause 6.10.1 of TS 23.273 [87], to determine the UE location. The AMF shall be prepared to deregister the UE if the information received from LMF indicates that the UE is registered to a PLMN that is not allowed to operate in the UE location. In the case of a NAS procedure, the AMF should either reject any NAS request targeted towards a PLMN that is not allowed to operate in the known UE location and indicate a suitable cause value, or accept the NAS procedure and initiate deregistration procedure once the UE location is known. In the deregistration message to the UE, the AMF shall include a suitable cause value. For UE processing of the cause value indicating that the PLMN is not allowed to operate in the current UE location, see TS 23.122 [17] and TS 24.501 [47].
In the case of a handover procedure, if the (target) AMF determines that it is not allowed to operate at the current UE location, the AMF either rejects the handover, or accepts the handover and later deregisters the UE.
Network selection principles specified in clause 5.2.2 apply also for NR satellite access.
For NR satellite access, a UE with location capability should use its awareness of its location to select a PLMN that is allowed to operate in the UE location as specified in TS 23.122 [17].
In order to ensure that the regulatory requirements are met, the network may be configured to enforce this UE choice by verifying the UE location, as described in clause 5.4.11.4.
A moving radio cell for NR satellite access may indicate support for one or more TACs for each PLMN. A UE that is registered with a PLMN may access a radio cell and does not need to perform a Mobility Registration Update procedure as long as at least one supported TAC for the RPLMN or equivalent to the RPLMN is part of the UE Registration Area. A UE shall perform a Mobility Registration Update procedure when accessing a radio cell where none of the supported TACs for the RPLMN or equivalent to the RPLMN are part of the UE Registration Area.
When indicating a last visited TAI in a Registration Update, a UE may indicate any TAI supported in a radio cell for the RPLMN or equivalent to the RPLMN for the last UE access prior to the Registration Update that is part of the UE Registration Area.
Editor's note:	References to RAN TSs are needed after RAN WGs have further progressed their work on TA handling in NTN.
In the case of NR satellite access with moving cells, in order to ensure that each TA is Earth-stationary even if the radio cells are moving across the Earth's surface, the NG-RAN may change the TAC values that are broadcast in a cell's system information as the cell moves, as described in TS 38.331 [28].
NG-RAN may broadcast in a cell a single TAC per PLMN and change that TAC value as the cell moves. Alternatively, the NG-RAN may broadcast in a cell more than one TAC for a PLMN and add or remove TAC values as the cell moves. The NG-RAN provides either the single broadcast TAI or all broadcast TAIs corresponding to the Selected PLMN as described in TS 38.413 [34] to the AMF as part of the ULI, whenever the ULI is included in the NGAP message as described in TS 38.413 [34]. The NG-RAN indicates, if known, also the TAI where the UE is geographically located.
NOTE:	The AMF may take the TAI where the UE is geographically located into account to generate a suitable Registration Area for the UE.
Forbidden Area functionality is supported as described in clause 5.3.4.1.1 with the modifications described below:
-	The AMF and the UE receive the broadcast TAI (if a single TAI is broadcast) or all broadcast TAIs (if multiple TAIs are broadcast) from the NG-RAN as described clause 5.4.11.7. The AMF considers the UE to be in a Forbidden Area if the only received TAI is forbidden or if all received TAIs are forbidden based on subscription data. The UE considers it is in a Forbidden Area if the only received TAI is forbidden, or if all received TAIs are forbidden and is not within a Forbidden Area in the case that at least one broadcast TAI is not forbidden.
-	If AMF receives multiple TAIs from the NG-RAN and determines that some, but not all of them are forbidden by subscription or by operator policy, the AMF shall send the forbidden TAI(s) to the UE as described in clauses 4.2.2.2 and 4.2.3 in TS 23.502 [3]. The UE stores the TAI(s) in the appropriate Forbidden Area list and removes the TAI(s) from Registration Area if present.
Service Area Restrictions functionality is supported as described in clause 5.3.4.1.2 with the modifications described below:
-	The AMF receives the broadcast TAI (if a single TAI is broadcast) or all broadcast TAIs (if multiple TAIs are broadcast) from the NG-RAN as described clause 5.4.11.7. The AMF provides the UE with Service Area Restrictions which consist of either Allowed Areas or Non-Allowed Areas, as described in clause 5.3.4.1.2. The UE and AMF consider the UE to be in a Non-Allowed Area if none of the broadcast TAIs is Allowed. The UE and AMF consider the UE to be in an Allowed Area if at least one broadcast TAI is allowed.
The RAN and UE may use a Paging Early Indication with Paging Subgrouping (PEIPS) to reduce the UE's power consumption in RRC_IDLE and RRC_INACTIVE over NR (see TS 38.304 [50]).
The paging subgrouping can be based on either the UE's temporary ID or a Paging Subgroup ID allocated by the AMF. Paging subgrouping based on the UE's temporary ID is implemented within the NG-RAN. For paging subgrouping based on UE's temporary ID, the UE's support is included in the UE Radio Capability for Paging, either derived by the NG-RAN from UE provided UE radio capability (see clause 5.4.4) or based on UE Radio Capability ID if UE radio capability signalling optimisation is used (see clause 5.4.4.1a).
The AMF, when determining its paging strategy (see clause 5.4.3), should take into consideration whether a gNB is using Paging subgrouping based on the UE's temporary ID.
NOTE:	Paging messages sent to that gNB can increase UE power consumption for other UEs that support Paging Subgrouping based on the UE's temporary ID.
If paging subgroups are being allocated by the AMF, then all AMFs connected to one gNB (including the AMFs in different PLMNs using 5G MOCN network sharing) shall use a consistent policy in allocating UEs to the paging subgroups. The AMF may configure up to 8 different Paging Subgroup IDs.
NOTE:	Because the UE uses the AMF allocated paging subgroup across all cells in its TAI-list, and, different, overlapping TAI lists can be allocated to different UEs, then to avoid UE power consumption increasing, it is likely to be necessary that all AMFs with an overlapping coverage area use a consistent policy in allocating UEs to the paging subgroups.
The NG-RAN node and the UE determine per cell which paging subgrouping method to use as defined in TS 38.304 [50] and TS 38.331 [28].
To support the Paging Early Indication with Paging Subgrouping (PEIPS), Paging Subgrouping Support Indication and the PEIPS Assistance Information is used by the AMF and NG-RAN to help determine whether PEIPS applies to the UE and which paging subgroup used when paging the UE (see TS 38.300 [27]).
In the Registration Request message, the Paging Subgrouping Support Indication indicates whether the UE supports PEIPS with AMF PEIPS Assistance Information. If the UE includes Paging Subgrouping Support Indication, the UE may also include the paging probability information to assist the AMF. If the AMF supports PEIPS assistance and if the UE provided Paging Subgrouping Support Indication, the AMF stores the indication in the UE context in AMF. The AMF may use local configuration, the UE's paging probability information if provided, information provided by the RAN (e.g. any of the Information On Recommended Cells And RAN nodes For Paging), and/or previous statistical information for the UE to determine the AMF PEIPS Assistance Information. The AMF PEIPS Assistance Information includes the Paging Subgroup ID.
NOTE 1:	To minimise MT voice call setup latency, the AMF could allocate Paging Subgroup IDs taking into account whether or not the UE is likely to receive IMS voice over PS session calls.
NOTE 2:	To avoid MT traffic for more mobile UEs causing more stationary UEs to be woken up, the AMF could allocate Paging Subgroup IDs taking into account the UE's mobility pattern.
If the AMF has determined AMF PEIPS Assistance Information for the UE, the AMF stores it in the UE context in AMF and provides it to the UE in every Registration Accept message.
If the AMF has determined AMF PEIPS Assistance Information, the AMF shall provide it to NG RAN when paging the UE. In addition, in order to support PEIPS for UEs in RRC_INACTIVE mode, the AMF shall provide the AMF PEIPS Assistance Information to NG-RAN as part of the RRC Inactive Assistance Information.
The NG-RAN chooses on a per-cell basis whether to use PEIPS and which paging subgrouping mechanism to use. When using AMF allocated subgroups, both the UE and NG-RAN use the AMF PEIPS Assistance Information to determine the paging subgroup to apply as defined in TS 38.300 [27].
The AMF may use the UE Configuration Update procedure (as described in clause 4.2.4 of TS 23.502 [3]) and N2 UE Context Modification procedure (as described in clause 8.3.4 of TS 38.413 [34]) to update the AMF PEIPS Assistance Information in the UE and NG-RAN.
When the UE has an active emergency PDU Session:
-	The UE shall not signal Paging Subgrouping Support Indication in the Registration Request message.
The present clause 5.4.13 provides optional enhancements to support discontinuous coverage:
-	Mobility management and power saving optimization, see clause 5.4.13.1; and
-	Coverage availability information provisioning to the UE, see clause 5.4.13.2; and
-	Coverage availability information provisioning to the AMF, see clause 5.4.13.3; and
-	Paging, see clause 5.4.13.4; and
-	Overload control, see clause 5.4.13.5.
NOTE:	In this Release, there is no specified support for discontinuous coverage over NR in RAN specifications.
For NR satellite access that provides discontinuous network coverage the Mobility Management and Power Saving Optimization functionality may be used.
If both the UE and the network support "Unavailability Period Support", and if the UE determines it will lose coverage and will become unavailable, and the UE decides to remain in no service during that time, then:
-	the UE triggers the Mobility Registration Update procedure to inform the network of its unavailability, as described in clause 5.4.1.4.
-	The UE may be able to determine, including considering current and expected future locations of the UE, a Start of Unavailability Period and/or Unavailability Period Duration for when it expects to be out of coverage and include them in the Mobility Registration Update procedure, as described in clause 5.4.1.4.
-	The UE should trigger the Mobility Registration Update procedure early enough such that the procedure, under normal conditions, is able to complete before the start of the unreachability period.
NOTE 1:	A UE based on implementation can combine successive periods of no satellite coverage into a single continuous period that is notified to the network if the UE does not require network access during this period.
NOTE 2:	UE informing the network of coverage gaps would increase signalling and UE power consumption if coverage gaps are more frequent than UE's communication period.
In case the UE requests power saving features the AMF uses the procedures defined in other clauses to provide the UE with timers (e.g. Periodic Registration Update timer), extended DRX in CM-IDLE configuration (see clause 5.31.7.2), and MICO mode configuration (see clause 5.4.1.3), and to the NG-RAN Extended Connected Time (see clause 5.31.7.3) and may also consider the Unavailability Period Duration and Start of Unavailability Period (if available). This is to keep UE in power saving mode and avoid the network attempting to page the UE if it is out of satellite network coverage.
The AMF should adjust the mobile reachable timer or Implicit Deregistration timer or both such that the AMF does not implicitly deregister the UE while the UE is unavailable, see clause 5.4.1. Features described for High latency communication in clause 5.31.8 may be used to handle mobile terminated (MT) communication with UEs being unreachable due to discontinuous coverage and the Unavailability Period Duration and Start of Unavailability Period (if available) may be used to when determining Maximum Time Offset.
Tracking Area or RAT specific configuration in the AMF may be used to set timer values based on typical coverage periods of a satellite system.
NOTE 3:	For example, if a satellite system only provides coverage to a UE for 20 minutes when a satellite passes, and the maximum time before a satellite passes any point on the earth is 10 hours, the AMF could configure the periodic registration timer and Mobile Reachable timer to be just greater than 20 minutes and the Implicit Deregistration timer to be greater than 10 hours to avoid unintended implicit detach due to coverage gap. Such configuration does not require AMF to be aware of detailed coverage times for each UE or for different locations.
The UE may send Mobility Registration Update procedure to inform the network of its UE unavailability period (see clause 5.4.1.4) even if Mobility Management back-off timer is running.
A UE may use satellite coverage availability information for satellite access to support discontinuous coverage operations. Satellite coverage availability information can be provided to a UE by an external server via a PDU Session or SMS. The protocol and format of satellite coverage availability information via PDU session or SMS is not defined in this release of the specification, but some examples on possible information that constitutes the satellite coverage availability information is defined in Annex Q.
The AMF may use satellite coverage availability information to support satellite access by UEs with discontinuous coverage operation. Satellite coverage availability information may be provisioned to the AMF by O&M.
The satellite coverage availability information provisioned to the AMF describes when and where satellite coverage is expected to be available in an area. The satellite coverage availability information is not UE specific and can be applied by the AMF for any UE in the affected area.
In the case of NR satellite access that provides discontinuous network coverage, AMF may utilize sub-area paging as described in clause 4.2.3.3 of TS 23.502 [3] (e.g. first page in the last known cell-id or TA and retransmission in all registered TAs). The AMF may utilize the location information as received at or before the AN release due to the discontinuous coverage for paging optimisation.
The AMF may e.g. receive UE location from NG-RAN during the Registration procedure e.g. triggered for Mobility Management and Power Saving Optimization for discontinuous network coverage as described in clause 5.4.13.1, or the AMF may request NG-RAN location reporting when the UE is in CM-CONNECTED state as described in clause 5.4.7.
The AMF and UE may only use the procedure defined in this clause if both the UE and AMF indicate support for "Unavailability Period Support", see clause 5.4.13.1. A UE indicating support for "Unavailability Period Support" shall support the procedures defined in this clause when leaving coverage and re-gaining coverage for an NR satellite RAT.
In order to avoid a large number of UEs causing excessive signalling load on the network when leaving coverage or re-gaining coverage after being out of coverage, the AMF may determine a Maximum Time Offset controlling when UEs are allowed to initiate NAS signalling with the network, as described in this clause.
In this case, the AMF determines this Maximum Time Offset based on network configuration, priority users and priority service as specified in TS 23.122 [17] and TS 24.501 [47]. The AMF sends this Maximum Time Offset to individual UEs during the Registration procedure or UE Configuration Update procedure.
If the UE receives a Maximum Time Offset from the network in a Registration Accept or UE Configuration Update Command message, the UE shall replace any previously received Maximum Time Offset on the same RAT type and PLMN with this one.
When the UE knows a later time at which coverage will be lost and when the UE does not send Mobility Registration Update to the AMF in advance (see clause 5.4.13.1), the UE determines a random value up to and including the latest Maximum Time Offset for this PLMN and RAT type and determines an earlier time equal to the later time when coverage will be lost less the random value. The UE shall send the Mobility Registration Update at that earlier time to the AMF indicating the loss of coverage.
Upon returning in coverage after being out of coverage due to discontinuous coverage, the UE sets the discontinuous coverage wait timer value to a random value up to and including the latest Maximum Time Offset for this PLMN and RAT type, and starts this timer. The UE shall not initiate any NAS signalling on that RAT Type and PLMN while the discontinuous coverage wait timer is running.
The UE shall stop the discontinuous coverage wait timer and initiate NAS signalling if the UE receives paging message, has pending emergency services or when UE enters a TAI outside the registration area.
Editor's note:	It is for CT WG1 to decide whether the Maximum Time Offset will require a new IE or reuse existing IE used for MINT i.e. disaster return wait range information. SA WG2 specifications will be aligned based on CT WG1 decision.
This clause describe the specific aspects for untrusted non-3GPP access, trusted non-3GPP access and W-5GAN access.
This clause applies to Non-3GPP access network corresponding to the Untrusted Non-3GPP access network, to the Trusted Non-3GPP access network and to the W-5GAN. In the case of W-5GAN the UE mentioned in this clause corresponds to 5G-RG or to the W-AGF in the case of FN-RG. In the case of N5CW devices access 5GC via trusted WLAN access networks, the UE mentioned in this clause corresponds to TWIF.
The UE shall enter RM-DEREGISTERED state and the AMF shall enter RM-DEREGISTERED state for the UE on non-3GPP access as follows:
-	at the UE and at the AMF, after performing an Explicit Deregistration procedure;
-	at the AMF, after the Network non-3GPP Implicit Deregistration timer has expired.
-	at the UE, after the UE non-3GPP Deregistration timer has expired.
NOTE:	This is assumed to leave sufficient time to allow the UE to re-activate UP connections for the established PDU Sessions over 3GPP or non-3GPP access.
Whenever a UE registered over non-3GPP access enters CM-IDLE state for the non-3GPP access, it starts the UE non-3GPP Deregistration timer according to the value received from the AMF during a Registration procedure.
Over non-3GPP access, the AMF runs the Network non-3GPP Implicit Deregistration timer. The Network non-3GPP Implicit Deregistration timer is started with a value longer than the UE's non-3GPP Deregistration timer, whenever the CM state for the UE registered over non-3GPP access changes to CM-IDLE for the non-3GPP access.
For a UE that is registered over Non-3GPP access, a change of the point of attachment (e.g. change of WLAN AP) shall not lead the UE to perform a Registration procedure.
A UE that is registered over non-3GPP access may trigger a Mobility Registration Update procedure via a new non-3GPP AN node (i.e. N3IWF or TNGF) to switch traffic from an old non-3GPP access to a new non-3GPP access.
Traffic switching from an old non-3GPP access to and from a wireline access is not supported in this Release.
Traffic switching from an old non-3GPP access to new non-3GPP access is supported only when PLMN of the new non-3GPP access is the same PLMN of the old non-3GPP access.
A UE shall not provide 3GPP-specific parameters (e.g. indicate a preference for MICO mode) during registration over a non-3GPP access.
During registration procedure the AMF may determine whether the serving N3IWF/TNGF is appropriate based on the slices supported by the N3IWFs/TNGFs as specified in clause 6.3.6 and clause 6.3.12 respectively.
This clause applies to Non-3GPP access network corresponding to the Untrusted Non-3GPP access network, to the Trusted Non-3GPP access network and to the W-5GAN. The UE mentioned in this clause corresponds to the 5G-RG in the case of W-5GAN and to the W-AGF in the case of FN-RG. In the case of N5CW devices access 5GC via trusted WLAN access networks, the UE mentioned in this clause corresponds to TWIF.
A UE that successfully establishes a Non-3GPP Access Connection to the 5GC over a Non-3GPP access transitions to CM-CONNECTED state for the Non-3GPP access.
In the case of Untrusted Non-3GPP access to 5GC, the Non-3GPP Access Connection corresponds to an NWu connection.
In the case of Trusted access to 5GC, the Non-3GPP Access Connection corresponds to an NWt connection.
In the case of N5CW devices access 5GC via trusted WLAN access networks, the Non-3GPP Access Connection corresponds to an Yt' connection.
In the case of Wireline access to 5GC, the Non-3GPP Access Connection corresponds to a Y4 connection and to Y5 connection.
A UE does not establish multiple simultaneous Non-3GPP Access Connection to the 5GC.
The Non-3GPP Access Connection is released either as a result of an Explicit Deregistration procedure or an AN Release procedure.
In the case of Untrusted Non-3GPP access, Trusted Non-3GPP access and W-5GAN access to 5GC, the N3IWF, TNGF, TWIF and W-AGF may in addition explicitly release the NWu, NWt, Yt', Y4 and Y5 signalling connection due to NWu, NWt, Yt', Y4 and Y5 connection failure, respectively. In the case of NWu and NWt, the release may be determined by the "dead peer detection" mechanism in IKEv2 defined in RFC 7296 [60]. In the case of Y4 and Y5 the release may be detected for example by lost of synchronisation of physical link, lost of PPPoE session, etc. Further details on how NWu, NWt, Yt', Y4 and Y5 connection failure is detected is out of scope of 3GPP specifications.
For W-5GCAN, the W-AGF explicitly releases the N2 connection due to Y4 or Y5 connection failure, as determined by the "dead peer detection" mechanism in DOCSIS MULPI [89].
The release of the Non-3GPP Access Connection between the UE and the N3IWF, TNGF, TWIF or W-AGF shall be interpreted as follows:
-	By the N3IWF, TNGF, TWIF and W-AGF as a criterion to release the N2 connection.
-	By the UE as a criterion for the UE to transition to CM-IDLE. A UE registered over non-3GPP access remains in RM-REGISTERED state, unless the Non-3GPP Access Connection release occurs as part of a Deregistration procedure over non-3GPP access in which case the UE enters the RM-DEREGISTERED state. When the UE in RM-REGISTERED transitions to CM-IDLE, the UE non-3GPP Deregistration timer starts running in the UE. The UE non-3GPP Deregistration timer stops when the UE moves to CM-CONNECTED state or to the RM-DEREGISTERED state.
NOTE 1:	When moved to CM-IDLE state over one access, the UE can attempt to re-activate UP connections for the PDU Sessions over other access, per UE policies and depending on the availability of these accesses.
NOTE 2:	The release of the NWu, NWt, Yt', Y4 or Y5 at the UE can occur as a result of explicit signalling from the N3IWF, TNGF, TWIF or W-AGF respectively, e.g. IKE INFORMATION EXCHANGE in the case of NWu or as a result of the UE detecting NWu, NWt, Yt', Y4 or Y5 connection failure, e.g. as determined by the "dead peer detection" mechanism in IKEv2 as defined in RFC 7296 [60] for NWu, NWt and Yt' or W-5GAN access specific mechanism for Y4 and Y5. Further details on how the UE detects NWu, NWt, Yt', Y4 or Y5 connection failure is out of scope of 3GPP specifications.
In the case of Non-3GPP access, when the AMF releases the N2 interface, the N3IWF, TNGF, TWIF and W-AGF shall release all the resources associated with the UE including the Non-3GPP Access Connection with the UE and its corresponding N3 resources. A release of the N2 connection by the AMF shall set the CM state for the UE in the AMF to CM-IDLE.
NOTE 3:	It is assumed that a UE configured to receive services from a 5GC over non-3GPP access that is RM-DEREGISTERED or CM-IDLE over the non-3GPP access will attempt to establish Non-3GPP Access Connection and transition to CM-CONNECTED state whenever the UE successfully connects to a non-3GPP access unless prohibited by the network to make a N3GPP Access Connection (e.g. due to network congestion).
An UE cannot be paged on Non-3GPP access network.
When a UE registered simultaneously over a 3GPP access and a non-3GPP access moves all the PDU Sessions to one of the accesses, whether the UE initiates a Deregistration procedure in the access that has no PDU Sessions is up to the UE implementation.
Release of PDU Sessions over the non-3GPP access does not imply the release of N2 connection.
When the UE has PDU Sessions routed over the non-3GPP access and the UE state becomes CM-IDLE for the non-3GPP access, these PDU Sessions are not released to enable the UE to move the PDU Sessions over the 3GPP access based on UE policies. The core network maintains the PDU Sessions but deactivates the N3 user plane connection for such PDU Sessions.
This clause applies to Non-3GPP access network corresponding to the Untrusted Non-3GPP access network, to the Trusted Non-3GPP access network and to the W-5GAN. The UE mentioned in this clause corresponds to 5G-RG, in the case of W-5GAN or to W-AGF in the case of support of FN-RG. In the case of N5CW devices access 5GC via trusted WLAN access networks, the UE mentioned in this clause corresponds to TWIF.
An UE cannot be paged over Non-3GPP access network.
If the UE states in the AMF are CM-IDLE and RM-REGISTERED for the non-3GPP access, there may be PDU Sessions that were last routed over the non-3GPP access and without user plane resources. If the AMF receives a message with a Non-3GPP Access Type indication from an SMF for a PDU Session corresponding to a UE that is CM-IDLE for non-3GPP access, and the UE is registered over 3GPP access in the same PLMN as the one registered over non-3GPP access, a Network Triggered Service Request may be performed over the 3GPP access independently of whether the UE is CM-IDLE or CM-CONNECTED over the 3GPP access. In this case, the AMF provides an indication that the procedure is related to non-3GPP access, as specified in clause 5.6.8.
NOTE:	The UE behaviour upon such network triggered Service Request is specified in clause 5.6.8.
This clause applies to Non-3GPP access network corresponding to the Untrusted Non-3GPP access network, to the Trusted Non-3GPP access network and to the W-5GAN. In the case of W-5GAN the UE mentioned in this clause corresponds to 5G-RG and to W-AGF in the case of support of FN-RG. In the case of N5CW devices access 5GC via trusted WLAN access networks, the UE mentioned in this clause corresponds to TWIF.
For a UE in CM-CONNECTED state:
-	the AMF knows the UE location on a N3IWF, TNGF, TWIF and W-AGF node granularity.
-	the N3IWF, TNGF, TWIF and W-AGF releases the N2 connection when UE becomes unreachable from N3IWF, TNGF, TWIF and W-AGF point of view, i.e. upon Non-3GPP Access Connection release.
The 5GC supports a PDU Connectivity Service i.e. a service that provides exchange of PDUs between a UE and a data network identified by a DNN. The PDU Connectivity Service is supported via PDU Sessions that are established upon request from the UE.
The Subscription Information for each S-NSSAI may contain a Subscribed DNN list and one default DNN. When the UE does not provide a DNN in a NAS Message containing PDU Session Establishment Request for a given S-NSSAI, the serving AMF determines the DNN for the requested PDU Session by selecting the default DNN for this S-NSSAI if a default DNN is present in the UE's Subscription Information; otherwise the serving AMF selects a locally configured DNN for this S-NSSAI.
The expectation is that the URSP in the UE is always up to date using the procedure defined in clause 4.16.12.2 of TS 23.502 [3] and therefore the UE requested DNN will be up to date.
In order to cover cases that UE operates using local configuration, but also other cases where operator policies can be used in order to replace an "up to date" UE requested DNN with another DNN used only internally in the network, during UE Registration procedure the PCF may indicate, to the AMF, the operator policies to be used at PDU Session Establishment for DNN replacement of a UE requested DNN. PCF may indicate a policy for DNN replacement of UE requested DNNs not supported by the network, and/or indicate a list of UE requested DNNs per S-NSSAI valid for the serving network, that are subject for replacement (details are described in TS 23.503 [45]).
If the DNN provided by the UE is not supported by the network and AMF cannot select an SMF by querying NRF, the AMF shall reject the NAS Message containing PDU Session Establishment Request from the UE with a cause indicating that the DNN is not supported unless the PCF provided the policy to perform a DNN replacement of unsupported DNNs.
If the DNN requested by the UE is indicated for replacement or the DNN provided by the UE is not supported by the network and the PCF provided the policy to perform DNN replacement of UE requested DNNs not supported by the network, the AMF shall interact with the PCF to perform a DNN replacement. During PDU Session Establishment procedure and as a result of DNN replacement, the PCF provides the selected DNN that is applicable for the S-NSSAI requested by the UE at the PDU Session Establishment. The AMF uses the selected DNN in the query towards the NRF for the SMF selection, as specified in clause 6.3.2, and provides both requested and selected DNN to the selected SMF. For PDU Session with Home-routed Roaming whether to perform DNN replacement is based on operator agreements.
NOTE 1:	The selected DNN is determined based on operator preferences and can differ from subscribed DNNs. The matching of selected DNN to S-NSSAI is assumed to be based on network configuration.
Each PDU Session supports a single PDU Session type i.e. supports the exchange of a single type of PDU requested by the UE at the establishment of the PDU Session. The following PDU Session types are defined: IPv4, IPv6, IPv4v6, Ethernet, Unstructured.
PDU Sessions are established (upon UE request), modified (upon UE and 5GC request) and released (upon UE and 5GC request) using NAS SM signalling exchanged over N1 between the UE and the SMF. Upon request from an Application Server, the 5GC is able to trigger a specific application in the UE. When receiving that trigger message, the UE shall pass it to the identified application in the UE. The identified application in the UE may establish a PDU Session to a specific DNN, see clause 4.4.5.
SMF may support PDU Sessions for LADN where the access to a DN is only available in a specific LADN service area. This is further defined in clause 5.6.5.
SMF may support PDU Sessions for a 5G VN group which offers a virtual data network capable of supporting 5G LAN-type service over the 5G system. This is further defined in clause 5.8.2.13.
The SMF is responsible of checking whether the UE requests are compliant with the user subscription. For this purpose, it retrieves and requests to receive update notifications on SMF level subscription data from the UDM. Such data may indicate per DNN and per S-NSSAI of the HPLMN:
-	The allowed PDU Session Types and the default PDU Session Type.
-	The allowed SSC modes and the default SSC mode.
-	QoS Information (refer to clause 5.7): the subscribed Session-AMBR, Default 5QI and Default ARP.
-	The IP Index information.
-	The static IP address/prefix.
-	The subscribed User Plane Security Policy.
-	the Charging Characteristics to be associated with the PDU Session. Whether this information is provided by the UDM to a SMF in another PLMN (for PDU Sessions in LBO mode) is defined by operator policies in the UDM/UDR.
NOTE 2:	The content of the Charging Characteristics as well as the usage of the Charging Characteristics by the SMF are defined in TS 32.255 [68].
A PDU Session may support:
(a)	a single-access PDU Connectivity Service, in which case the PDU Session is associated with a single access type at a given time, i.e. either 3GPP access or non-3GPP access; or
(b) a multi-access PDU Connectivity Service, in which case the PDU Session is simultaneously associated with both 3GPP access and non-3GPP access and simultaneously associated with two independent N3/N9 tunnels between the PSA and RAN/AN.
A PDU Session supporting a single-access PDU Connectivity Service is also referred to as single-access PDU Session, while a PDU Session supporting a multi-access PDU Connectivity Service is referred to as Multi-Access PDU (MA PDU) Session and it is used to support the ATSSS feature (see clause 5.32 for details).
A UE that is registered over multiple accesses chooses over which access to establish a PDU Session. As defined in TS 23.503 [45], the HPLMN may send policies to the UE to guide the UE selection of the access over which to establish a PDU Session.
NOTE 3:	In this Release of the specification, at any given time, a PDU Session is routed over only a single access network, unless it is an MA PDU Session in which case it can be routed over one 3GPP access network and one Non 3GPP access network concurrently.
A UE may request to move a single-access PDU Session between 3GPP and Non 3GPP accesses. The decision to move single-access PDU Sessions between 3GPP access and Non 3GPP access is made on a per PDU Session basis, i.e. the UE may, at a given time, have some PDU Sessions using 3GPP access while other PDU Sessions are using Non 3GPP access.
If the UE is attempting to move a single-access PDU session from 3GPP access to non-3GPP access and the PDU session is associated with control plane only indication, then the AMF shall reject the PDU Session Establishment request as related CIoT 5GS optimisation features are not supported over non-3GPP access as described in clause 5.4.5.2.5 of TS 24.501 [47]. If the UE is attempting to move a single-access PDU session from non-3GPP access to NB-N1 mode of 3GPP access, the PDU Session Establishment request would also be rejected by AMF when the UP resources for the UE exceed the maximum number of supported UP resources as described in clause 5.4.5.2.4 of TS 24.501 [47].
In a PDU Session Establishment Request message sent to the network, the UE shall provide a PDU Session ID. The PDU Session ID is unique per UE and is the identifier used to uniquely identify one of a UE's PDU Sessions. The PDU Session ID shall be stored in the UDM to support handover between 3GPP and non-3GPP access when different PLMNs are used for the two accesses. The UE also provides as described in TS 24.501 [47]:
(a)	PDU Session Type.
(b)	S-NSSAI of the HPLMN that matches the application (that is triggering the PDU Session Request) within the NSSP in the URSP rules or within the UE Local Configuration as defined in clause 6.1.2.2.1 of TS 23.503 [45].
NOTE 4:	If the UE cannot determine any S-NSSAI after performing the association of the application to a PDU Session, then it does not indicate any S-NSSAI in the PDU Session Establishment procedure as defined in clause 5.15.5.3.
(c)	S-NSSAI of the Serving PLMN from the Allowed NSSAI, corresponding to the S-NSSAI of the HPLMN (b).
NOTE 5:	In non-roaming scenario the mapping of the Allowed NSSAI to HPLMN S-NSSAIs is not provided to the UE (because the S-NSSAI of the Serving PLMN (c) has the same value of the S-NSSAI of the HPLMN (b)), therefore the UE provides in the PDU Session Request only the S-NSSAI of the Serving PLMN (c).
NOTE 6:	In roaming scenarios the UE provides in the PDU Session Request both the S-NSSAI of the HPLMN (b) and the S-NSSAI of the VPLMN from the Allowed NSSAI (c) that maps to the S-NSSAI of the HPLMN.
(d)	DNN (Data Network Name).
(e)	SSC mode (Service and Session Continuity mode defined in clause 5.6.9.2).
Additionally, if the UE supports ATSSS and wants to activate a MA PDU Session, the UE shall provide Request Type as "MA PDU Request" and shall indicate the supported ATSSS capabilities (see clause 5.32 for details).
Table 5.6.1-1: Attributes of a PDU Session

Subscription Information may include a wildcard DNN per subscribed S-NSSAI: when a wildcard DNN is associated with a subscribed S-NSSAI, the subscription allows, for this S-NSSAI, the UE to establish a PDU Session using any DNN value.
NOTE 7:	The SMF is made aware whether the DNN of a PDU Session being established corresponds to an explicitly subscribed DNN or corresponds to a wildcard DNN. Thus, the SMF can reject a PDU Session establishment if the DNN of the PDU Session is not part of explicitly subscribed DNN(s) and local policies in the SMF require UE to have a subscription to this DNN.
A UE may establish multiple PDU Sessions, to the same data network or to different data networks, via 3GPP and via and Non-3GPP access networks at the same time.
A UE may establish multiple PDU Sessions to the same Data Network and served by different UPF terminating N6.
A UE with multiple established PDU Sessions may be served by different SMF.
The SMF shall be registered and deregistered on a per PDU Session granularity in the UDM.
The user plane paths of different PDU Sessions (to the same or to different DNN) belonging to the same UE may be completely disjoint between the AN and the UPF interfacing with the DN.
When the SMF cannot control the UPF terminating the N3 interface used by a PDU Session and SSC mode 2/3 procedures are not applied to the PDU Session, an I-SMF is inserted between the SMF and the AMF and handling of PDU Session(s) is described in clause 5.34.
NOTE 8:	User Plane resources for PDU Sessions of a UE, except for regulatory prioritized service like Emergency Services and MPS, can be deactivated by the SMF if the UE is only reachable for regulatory prioritized services.
The SMF serving a PDU session (i.e. Anchor) can be changed during lifetime of the PDU session either within the same SMF set or, if the Context Transfer Procedures as specified in clause 4.26 of TS 23.502 [3] are supported, between SMFs in different SMF sets.
The AMF and SMF are separate Network Functions.
N1 related interaction with SMF is as follows:
-	The single N1 termination point is located in AMF. The AMF forwards SM related NAS information to the SMF based on the PDU Session ID in the NAS message. Further SM NAS exchanges (e.g. SM NAS message responses) for N1 NAS signalling received by the AMF over an access (e.g. 3GPP access or non-3GPP access) are transported over the same access.
-	The serving PLMN ensures that subsequent SM NAS exchanges (e.g. SM NAS message responses) for N1 NAS signalling received by the AMF over an access (e.g. 3GPP access or non-3GPP access) are transported over the same access.
-	SMF handles the Session management part of NAS signalling exchanged with the UE.
-	The UE shall only initiate PDU Session Establishment in RM-REGISTERED state.
-	When a SMF has been selected to serve a specific PDU Session, AMF has to ensure that all NAS signalling related with this PDU Session is handled by the same SMF instance.
-	Upon successful PDU Session Establishment, the AMF and SMF stores the Access Type that the PDU Session is associated.
N11 related interaction with SMF is as follows:
-	The AMF reports the reachability of the UE based on a subscription from the SMF, including:
-	The UE location information with respect to the area of interest indicated by the SMF.
-	The SMF indicates to AMF when a PDU Session has been released.
-	Upon successful PDU Session Establishment, AMF stores the identification of serving SMF of UE and SMF stores the identification of serving AMF of UE including the AMF set. When trying to reach the AMF serving the UE, the SMF may need to apply the behaviour described for "the other CP NFs" in clause 5.21.
N2 related interaction with SMF is as follows:
-	Some N2 signalling (such as handover related signalling) may require the action of both AMF and SMF. In such case, the AMF is responsible to ensure the coordination between AMF and SMF. The AMF may forward the SM N2 signalling towards the corresponding SMF based on the PDU Session ID in N2 signalling.
-	SMF shall provide PDU Session Type together with PDU Session ID to NG-RAN, in order to facilitate NG-RAN to apply suitable header compression mechanism to packet of different PDU type. Details refer to TS 38.413 [34].
N3 related interaction with SMF is as follows:
-	Selective activation and deactivation of UP connection of existing PDU Session is defined in clause 5.6.8.
N4 related interaction with SMF is as follows:
-	When it is made aware by the UPF that some DL data has arrived for a UE without downlink N3 tunnel information, the SMF interacts with the AMF to initiate Network Triggered Service Request procedure. In this case, if the SMF is aware that the UE is unreachable or if the UE is reachable only for regulatory prioritized service and the PDU Session is not for regulatory prioritized service, then the SMF shall not inform DL data notification to the AMF
The AMF is responsible of selecting the SMF per procedures described in clause 6.3.2. For this purpose, it gets subscription data from the UDM that are defined in that clause. Furthermore, it retrieves the subscribed UE-AMBR from the UDM, and optionally dynamic serving network UE-AMBR from PCF based on operator local policy, and sends to the (R)AN as defined in clause 5.7.2
AMF-SMF interactions to support LADN are defined in clause 5.6.5.
In order to support charging and to fulfil regulatory requirement (in order to provide NPLI (Network Provided Location Information) as defined in TS 23.228 [15]) related with the set-up, modification and release of IMS Voice calls or with SMS transfer the following applies
-	At the time of the PDU Session Establishment, the AMF provides the SMF with the PEI of the UE if the PEI is available at the AMF.
-	When it forwards UL NAS or N2 signalling to a peer NF (e.g. to SMF or to SMSF) or during the UP connection activation of a PDU Session, the AMF provides any User Location Information it has received from the 5G-AN as well as the Access Type (3GPP - Non 3GPP) of the AN over which it has received the UL NAS or N2 signalling. The AMF also provides the corresponding UE Time Zone. In addition, in order to fulfil regulatory requirement (i.e. providing Network Provided Location Information (NPLI), as defined in TS 23.228 [15]) when the access is non-3GPP, the AMF may also provide the last known 3GPP access User Location Information with its age, if the UE is still attached to the same AMF for 3GPP access (i.e. valid User Location Information).
The User Location Information, the access type and the UE Time Zone may be further provided by SMF to PCF. The PCF may get this information from the SMF in order to provide NPLI to applications (such as IMS) that have requested it.
The User Location Information may correspond to:
-	In the case of 3GPP access: TAI, Cell-Id. The AMF includes only the Primary Cell-Id even if it had received also the Cell-Id of the Primary cell in the Secondary RAN node from NG-RAN.
-	In the case of Untrusted non-3GPP access: TAI, the UE local IP address used to reach the N3IWF and optionally the UDP source port number if NAT is detected.
-	In the case of Trusted non-3GPP access: TAI, TNAP/TWAP Identifier, the UE/N5CW device local IP address used to reach the TNGF/TWIF and optionally the UDP source port number if NAT is detected.
	When the UE uses WLAN based on IEEE 802.11 technology to reach the TNGF, the TNAP Identifier shall include the SSID of the access point to which the UE is attached. The TNAP Identifier shall include at least one of the following elements, unless otherwise determined by the TWAN operator's policies:
-	the BSSID (see IEEE Std 802.11-2012 [106]);
-	civic address information of the TNAP to which the UE is attached.
	The TWAP Identifier shall include the SSID of the access point to which the NC5W is attached. The TWAP Identifier shall also include at least one of the following elements, unless otherwise determined by the TWAN operator's policies:
-	the BSSID (see IEEE Std 802.11-2012 [106]);
-	civic address information of the TWAP to which the UE is attached.
NOTE 1:	The SSID can be the same for several TNAPs/TWAPs and SSID only cannot provide a location, but it might be sufficient for charging.
NOTE 2:	the BSSID associated with a TNAP/TWAP is assumed to be static.
-	In the case of W-5GAN access: The User Location Information for W-5GAN is defined in TS 23.316 [84].
When the SMF receives a request to provide Access Network Information reporting while there is no action to carry out towards the 5G-AN or the UE (e.g. no QoS Flow to create / Update / modify), the SMF may request User Location Information from the AMF.
The interaction between AMF and SMF(s) for the case of a I-SMF insertion, relocation or removal for a PDU session is described in clause 5.34.
In the case of roaming the 5GC supports following possible deployments scenarios for a PDU Session:
-	"Local Break Out" (LBO) where the SMF and all UPF(s) involved by the PDU Session are under control of the VPLMN.
-	"Home Routed" (HR) where the PDU Session is supported by a SMF function under control of the HPLMN, by a SMF function under control of the VPLMN, by at least one UPF under control of the HPLMN and by at least one UPF under control of the VPLMN. In this case the SMF in HPLMN selects the UPF(s) in the HPLMN and the SMF in VPLMN selects the UPF(s) in the VPLMN. This is further described in clause 6.3. Home Routed with Session Breakout in VPLMN (HR-SBO) is described in clause 6.7 of TS 23.548 [130].
NOTE 1:	The use of an UPF in the VPLMN e.g. enables VPLMN charging, VPLMN LI and minimizes the impact on the HPLMN of the UE mobility within the VPLMN (e.g. for scenarios where SSC mode 1 applies).
Different simultaneous PDU Sessions of an UE may use different modes: Home Routed and LBO. The HPLMN can control via subscription data per DNN and per S-NSSAI whether a PDU Session is to be set-up in HR or in LBO mode.
In the case of PDU Sessions per Home Routed deployment:
-	NAS SM terminates in the SMF in VPLMN.
-	The SMF in VPLMN forwards to the SMF in the HPLMN SM related information.
-	The SMF in the HPLMN receives the SUPI of the UE from the SMF in the VPLMN during the PDU Session Establishment procedure.
-	The SMF in HPLMN is responsible to check the UE request with regard to the user subscription and to possibly reject the UE request in the case of mismatch. The SMF in HPLMN obtains subscription data directly from the UDM.
-	The SMF in HPLMN may send QoS requirements associated with a PDU Session to the SMF in VPLMN. This may happen during the PDU Session Establishment procedure and after the PDU Session is established. The interface between SMF in HPLMN and SMF in VPLMN is also able to carry (N9) User Plane forwarding information exchanged between SMF in HPLMN and SMF in VPLMN. The SMF in the VPLMN may check QoS requests from the SMF in HPLMN with respect to roaming agreements.
In home routed roaming case, the AMF selects an SMF in the VPLMN and a SMF in the HPLMN as described in clause 6.3.2 and in clause 4.3.2.2.3.3 of TS 23.502 [3], and provides the identifier of the selected SMF in the HPLMN to the selected SMF in the VPLMN.
In roaming with LBO, the AMF selects a SMF in the VPLMN as described in clause 6.3.2 and in clause 4.3.2.2.3.2 of TS 23.502 [3]. In this case, when handling a PDU Session Establishment Request message, the SMF in the VPLMN may reject the N11 message (related with the PDU Session Establishment Request message) with a proper N11 cause. This triggers the AMF to select both a new SMF in the VPLMN and a SMF in the HPLMN in order to handle the PDU Session using home routed roaming.
In order to support selective traffic routing to the DN or to support SSC mode 3 as defined in clause 5.6.9.2.3, the SMF may control the data path of a PDU Session so that the PDU Session may simultaneously correspond to multiple N6 interfaces. The UPF that terminates each of these interfaces is said to support PDU Session Anchor functionality. Each PDU Session Anchor supporting a PDU Session provides a different access to the same DN. Further, the PDU Session Anchor assigned at PDU Session Establishment is associated with the SSC mode of the PDU Session and the additional PDU Session Anchor(s) assigned within the same PDU Session e.g. for selective traffic routing to the DN are independent of the SSC mode of the PDU Session. When a PCC rule including the Application Function influence on traffic routing Enforcement Control information defined in clause 6.3.1 of TS 23.503 [45] is provided to the SMF, the SMF can decide whether to apply traffic routing (by using UL Classifier functionality or IPv6 multi-homing) based on DNAI(s) included in the PCC rule.
NOTE 1:	Application Function influence on traffic routing Enforcement Control information can be either determined by the PCF when requested by AF via NEF as described in clause 5.6.7.1 or statically pre-configured in the PCF.
NOTE 2:	Selective traffic routing to the DN supports, for example, deployments where some selected traffic is forwarded on an N6 interface to the DN that is "close" to the AN serving the UE.
This may correspond to
-	The Usage of UL Classifier functionality for a PDU Session defined in clause 5.6.4.2.
-	The Usage of an IPv6 multi-homing for a PDU Session defined in clause 5.6.4.3.
SMF may also take decision to apply traffic routing (by using UL Classifier functionality or IPv6 multi-homing) in EAS Discovery with EASDF procedure described in TS 23.548 [130].
In the case of PDU Sessions of type IPv4 or IPv6 or IPv4v6 or Ethernet, the SMF may decide to insert in the data path of a PDU Session an "UL CL" (Uplink classifier). The UL CL is a functionality supported by an UPF that aims at diverting (locally) some traffic matching traffic filters provided by the SMF. The insertion and removal of an UL CL is decided by the SMF and controlled by the SMF using generic N4 and UPF capabilities. The SMF may decide to insert in the data path of a PDU Session a UPF supporting the UL CL functionality during or after the PDU Session Establishment, or to remove from the data path of a PDU Session a UPF supporting the UL CL functionality after the PDU Session Establishment. The SMF may include more than one UPF supporting the UL CL functionality in the data path of a PDU Session.
The UE is unaware of the traffic diversion by the UL CL, and does not involve in both the insertion and the removal of UL CL. In the case of a PDU Session of IPv4 or IPv6 or IPv4v6 type, the UE associates the PDU Session with either a single IPv4 address or a single IPv6 Prefix or both of them allocated by the network.
When an UL CL functionality has been inserted in the data path of a PDU Session, there are multiple PDU Session Anchors for this PDU Session. These PDU Session Anchors provide different access to the same DN. In the case of a PDU Session of IPv4 or IPv6 or IPv4v6 type, only one IPv4 address and/or IPv6 prefix is provided to the UE. The SMF may be configured with local policies for some (DNN, S-NSSAI) combinations to release the PDU Session when there is a PSA associated with the IPv4 address allocated to the UE and this PSA has been removed.
NOTE 0:	The use of only one IPv4 address and/or IPv6 prefix with multiple PDU Session Anchors assumes that when needed, appropriate mechanisms are in place to correctly forward packets on the N6 reference point. The mechanisms for packet forwarding on the N6 reference point between the PDU Session Anchor providing local access and the DN are outside the scope of this specification.
The UL CL provides forwarding of UL traffic towards different PDU Session Anchors and merge of DL traffic to the UE i.e. merging the traffic from the different PDU Session Anchors on the link towards the UE. This is based on traffic detection and traffic forwarding rules provided by the SMF.
The UL CL applies filtering rules (e.g. to examine the destination IP address/Prefix of UL IP packets sent by the UE) and determines how the packet should be routed. The UPF supporting an UL CL may also be controlled by the SMF to support traffic measurement for charging, traffic replication for LI and bit rate enforcement (Session-AMBR per PDU Session).
NOTE 1:	When N9 forwarding tunnel exists between source ULCL and target ULCL, the Session-AMBR per PDU Session can be enforced by the source UL CL UPF.
NOTE 2:	The UPF supporting an UL CL may also support a PDU Session Anchor for connectivity to the local access to the data network (including e.g. support of tunnelling or NAT on N6). This is controlled by the SMF.
Additional UL CLs (and thus additional PDU Session Anchors) can be inserted in the data path of a PDU Session to create new data paths for the same PDU Session. The way to organize the data path of all UL CLs in a PDU Session is up to operator configuration and SMF logic and there is only one UPF supporting UL CL connecting to the (R)AN via N3 interface, except when session continuity upon UL CL relocation is used.
The insertion of an ULCL in the data path of a PDU Session is depicted in Figure 5.6.4.2-1.

Figure 5.6.4.2-1: User plane Architecture for the Uplink Classifier
NOTE 3:	It is possible for a given UPF to support both the UL CL and the PDU Session Anchor functionalities.
Due to UE mobility the network may need to relocate the UPF acting as UL CL and establish a new PSA for local access to the DN. To support session continuity during UL CL relocation the network may establish a temporary N9 forwarding tunnel between the source UL CL and target UL CL. The AF may influence the creation of the N9 forwarding tunnel as described in clause 5.6.7.1.
The N9 forwarding tunnel is maintained until:
-	all active traffic flowing on it ceases to exist for:
-	a configurable period of time; or
-	a period of time indicated by the AF;
-	until the AF informs the SMF that it can release the source PSA providing local access to the DN.
During the existence of the N9 forwarding tunnel the UPF acting as target UL CL is configured with packet filters that:
-	force uplink traffic from existing data sessions between UE and the application in the source local part of the DN (as defined in TS 23.548 [130]) into the N9 forwarding tunnel towards the source UL CL.
-	force any traffic related to the application in the target local part of the DN to go to the new local part of the DN via the target PSA.
SMF may send a Late Notification to AF to inform it about the DNAI change as described in clause 4.3.6.3 of TS 23.502 [3]. This notification can be used by the AF e.g. to trigger mechanisms in the source local part of the DN to redirect the ongoing traffic sessions towards an application in the target local part of the DN. SMF can also send late notification to the target AF instance if associated with this target local part of the DN.
The procedure for session continuity upon UL CL relocation is described in clause 4.3.5.7 of TS 23.502 [3].
When an I-SMF is inserted for a PDU Session, the details of UL CL insertion which is controlled by an I-SMF is described in clause 5.34.4.
A PDU Session may be associated with multiple IPv6 prefixes. This is referred to as multi-homed PDU Session. The multi-homed PDU Session provides access to the Data Network via more than one PDU Session Anchor. The different user plane paths leading to the different PDU Session Anchors branch out at a "common" UPF referred to as a UPF supporting "Branching Point" functionality. The Branching Point provides forwarding of UL traffic towards the different PDU Session Anchors and merge of DL traffic to the UE i.e. merging the traffic from the different PDU Session Anchors on the link towards the UE.
The UPF supporting a Branching Point functionality may also be controlled by the SMF to support traffic measurement for charging, traffic replication for LI and bit rate enforcement (Session-AMBR per PDU Session). The insertion and removal of a UPF supporting Branching Point is decided by the SMF and controlled by the SMF using generic N4 and UPF capabilities. The SMF may decide to insert in the data path of a PDU Session a UPF supporting the Branching Point functionality during or after the PDU Session Establishment, or to remove from the data path of a PDU Session a UPF supporting the Branching Point functionality after the PDU Session Establishment.
Multi homing of a PDU Session applies only for PDU Sessions of IPv6 type. When the UE requests a PDU Session of type "IPv4v6" or "IPv6" the UE also provides an indication to the network whether it supports a Multi-homed IPv6 PDU Session.
The use of multiple IPv6 prefixes in a PDU Session is characterised by the following:
-	The UPF supporting a Branching Point functionality is configured by the SMF to spread UL traffic between the PDU Session Anchors based on the Source Prefix of the PDU (which may be selected by the UE based on routing information and preferences received from the network).
-	IETF RFC 4191 [8] is used to configure routing information and preferences into the UE to influence the selection of the source Prefix.
NOTE 1:	This corresponds to Scenario 1 defined in IETF RFC 7157 [7] "IPv6 Multi-homing without Network Address Translation". This allows to make the Branching Point unaware of the routing tables in the Data Network and to keep the first hop router function in the PDU Session Anchors.
-	The multi-homed PDU Session may be used to support make-before-break service continuity to support SSC mode 3. This is illustrated in Figure 5.6.4.3-1.
-	The multi-homed PDU Session may also be used to support cases where UE needs to access both a local service (e.g. local server) and a central service (e.g. the internet), illustrated in Figure 5.6.4.3-2.
-	The UE shall use the method specified in clause 4.3.5.3 of TS 23.502 [3] to determine if a multi-homed PDU Session is used to support the service continuity case shown in Figure 5.6.4.3-1, or if it is used to support the local access to DN case shown in Figure 5.6.4.3-2.

Figure 5.6.4.3-1: Multi-homed PDU Session: service continuity case
NOTE 2:	It is possible for a given UPF to support both the Branching Point and the PDU Session Anchor functionalities.

Figure 5.6.4.3-2: Multi-homed PDU Session: local access to same DN
NOTE 3:	It is possible for a given UPF to support both the Branching Point and the PDU Session Anchor functionalities.
The access to a DN via a PDU Session for a LADN is only available in a specific LADN service area. A LADN service area is a set of Tracking Areas. LADN is a service provided by the serving PLMN. It includes:
-	LADN service applies only to 3GPP accesses and does not apply in Home Routed case.
-	The usage of LADN DNN requires an explicit subscription to this DNN or subscription to a wildcard DNN.
-	Whether a DNN corresponds to a LADN service is an attribute of a DNN and is per PLMN.
The UE is configured to know whether a DNN is a LADN DNN on a per-PLMN basis, and an association between application and LADN DNN. The configured association is considered to be a UE local configuration defined in TS 23.503 [45]. Alternatively, the UE gets the information whether a DNN is a LADN DNN from LADN Information during (re-)registration procedure as described in this clause.
NOTE 1:	No other procedure for configuring the UE to know whether a DNN is a LADN DNN is defined in this release of the specifications.
NOTE 2:	The procedure for configuring the UE to know an association between application and LADN DNN is not defined in this release of the specifications.
LADN service area and LADN DNN are configured in the AMF on a per DN basis, i.e. for different UEs accessing the same LADN, the configured LADN service area is the same regardless of other factors (e.g. UE's Registration Area or UE subscription).
NOTE 3:	If a LADN is not available in any TA of an AMF's service area, the AMF is not required to be configured with any LADN related information for that DNN.
LADN Information (i.e. LADN Service Area Information and LADN DNN) is provided by AMF to the UE during the Registration procedure or UE Configuration Update procedure. For each LADN DNN configured in the AMF, the corresponding LADN Service Area Information includes a set of Tracking Areas that belong to the Registration Area that the AMF assigns to the UE (i.e. the intersection of the LADN service area and the assigned Registration Area). The AMF shall not create Registration Area based on the availability of LADNs.
NOTE 4:	It is thus possible that the LADN Service Area Information sent by the AMF to the UE contains only a sub-set of the full LADN service area as the LADN service area can contain TA(s) outside of the registration area of the UE or outside of the area served by the AMF.
When the UE performs a successful (re-)registration procedure, the AMF may provide to the UE, based on local configuration (e.g. via OAM) about LADN, on UE location, and on UE subscription information received from the UDM about subscribed DNN(s), the LADN Information for the list of LADN available to the UE in that Registration Area in the Registration Accept message.
The UE may provide either the LADN DNN(s) to retrieve the LADN Information for the indicated LADN DNN(s) or an indication of Requesting LADN Information to retrieve the LADN Information for all LADN(s) available in the current Registration Area.
The list of LADN is determined as follows:
-	If neither LADN DNN nor an indication of requesting LADN Information is provided in the Registration Request message, the list of LADN is the LADN DNN(s) in subscribed DNN list except for wildcard DNN.
-	If the UE provides LADN DNN(s) in the Registration Request message, the list of LADN is LADN DNN(s) the UE requested if the UE subscribed DNN(s) includes the requested LADN DNN or if a wildcard DNN is included in the UE's subscription data.
NOTE 5:	It is assumed that an application can use only one LADN DNN at a time.
-	If the UE provides an indication of requesting LADN Information in the Registration Request message, the list of LADN is all the LADN DNN(s) configured in the AMF if the wildcard DNN is subscribed, or the LADN DNN(s) which is in subscribed DNN list and no wildcard DNN is subscribed.
The UE considers the retrieved LADN Information valid only for the registered PLMN and the E-PLMN(s) if the LADN Service Area Information includes Tracking Areas that belong to E-PLMN(s). Additionally, an LADN DNN discovered by the UE via the retrieved LADN Information is considered an LADN DNN also in the E-PLMNs of the Registered PLMN, i.e. the UE can request LADN Information for the discovered LADN DNN in the E-PLMNs.
During the subsequent Registration procedure, if the network does not provide LADN Information for a DNN, the UE deletes any LADN Information for that DNN.
When the LADN Information for the UE in the 5GC is changed, the AMF shall update LADN Information to the UE through UE Configuration Update/Registration procedure as described in clauses 4.2.4 / 4.2.2.2.2 of TS 23.502 [3].
When receiving PDU Session Establishment with LADN DNN or Service Request for the established PDU Session corresponding to LADN, the AMF determines UE presence in LADN service area and forwards it to the SMF if the requested DNN is configured at the AMF as a LADN DNN.
Based on the LADN Service Area Information in the UE, the UE determines whether it is in or out of a LADN service area. If the UE does not have the LADN Service Area Information for a LADN DNN, the UE shall consider it is out of the LADN service area.
The UE takes actions as follows:
a)	When the UE is out of a LADN service area, the UE:
-	shall not request to activate UP connection of a PDU Session for this LADN DNN;
-	shall not attempt to send user data as payload of a NAS message (see clause 5.31.4.1) using a PDU Session for this LADN DNN;
-	shall not establish/modify a PDU Session for this LADN DNN (except for PS Data Off status change reporting for an established PDU Session);
-	need not release any existing PDU Session for this LADN DNN unless UE receives explicit SM PDU Session Release Request message from the network.
b)	When the UE is in a LADN service area, the UE:
-	may request a PDU Session Establishment/Modification for this LADN DNN;
-	may request to activate UP connection of the existing PDU Session for this LADN DNN;
-	may attempt to send user data as payload of a NAS message (see clause 5.31.4.1) using a PDU Session for this LADN DNN.
NOTE 6:	The evaluation of Service Area Restrictions will be performed before the evaluation of LADN service area, if the UE has overlapping areas between Service Area Restrictions and LADN service area.
The SMF supporting a DNN is configured with information about whether this DNN is a LADN DNN or not.
When receiving SM request corresponding an LADN from the AMF, the SMF determines whether the UE is inside LADN service area based on the indication (i.e. UE Presence in LADN service area) received from the AMF. If the SMF does not receive the indication, the SMF considers that the UE is outside of the LADN service area. The SMF shall reject the request if the UE is outside of the LADN service area.
When the SMF receives a request for PDU Session Establishment with the LADN DNN, it shall subscribe to "UE mobility event notification" for reporting UE presence in Area of Interest by providing LADN DNN to the AMF as described in clauses 5.6.11 and 5.3.4.4.
Based on the notification about the UE presence in LADN service area notified by AMF (i.e. IN, OUT, or UNKNOWN), the SMF takes actions as follows based on operator's policy:
a)	When SMF is informed that the UE presence in a LADN service area is OUT, the SMF shall:
-	release the PDU Session immediately; or
-	deactivate the user plane connection for the PDU Session and it shall not attempt to send user data as payload of a NAS message (see clause 5.31.4.1) while maintaining the PDU Session and ensure the Data Notification is disabled and the SMF may release the PDU Session if the SMF is not informed that the UE moves into the LADN service area after a period.
b)	When SMF is informed that the UE presence a LADN service area is IN, the SMF shall:
-	ensure that Data Notification is enabled.
-	trigger the Network triggered Service Request procedure for a LADN PDU Session to active the UP connection or send user data as payload of a NAS message (see clause 5.31.4.1) when the SMF receives downlink data or Data Notification from UPF.
c)	When the SMF is informed that the UE presence in a LADN service area is UNKNOWN, the SMF may:
-	ensure that Data Notification is enabled.
-	trigger the Network triggered Service Request procedure for a LADN PDU Session to active the UP connection or send user data as payload of a NAS message (see clause 5.31.4.1) when the SMF receives downlink data or Data Notification from UPF.
SMF may make use of UE mobility analytics provided by NWDAF, as described in clause 6.7.2 of TS 23.288 [86], to determine UE presence pattern in LADN service area and take a decision how to handle LADN PDN Session (e.g. release the PDU Session immediately, or deactivate the user plane connection for the PDU Session with maintaining the PDU Session).
5.6.5a	Supporting LADN per DNN and S-NSSAI
The 5GS may support LADN per DNN and S-NSSAI, and the functions specified in clause 5.6.5 are used (with the extension to apply per DNN and S-NSSAI whenever applicable) with the following enhancements:
-	The UE indicates the support of LADN per DNN and S-NSSAI in the UE MM Core Network Capability of the Registration Request message.
-	The LADN service area can be provisioned for a group (e.g. 5G VN group) or an individual subscriber using UDM/NEF parameter provisioning service triggered by AF request as described in clause 4.15.6 of TS 23.502 [3].
-	LADN service area per DNN and S-NSSAI may be configured in the AMF. The LADN service area may also be provided to AMF as part of the subscription data from UDM.
-	The LADN Service Area Information provided to the UE is determined by AMF, based on the Registration Area that the AMF assigns to the UE and either the local configured LADN service area or the LADN service area received from UDM. In case there is both a configured LADN service area and a LADN service area received from UDM, the AMF decides based on operator configuration which one takes precedence.
-	If the UE indicates support of LADN per DNN and S-NSSAI, the AMF may provide the LADN Service Area Information per LADN DNN and S-NSSAI to the UE.
-	If the UE does not indicate support of LADN per DNN and S-NSSAI and the AMF has a LADN service area for the DNN as well as a LADN service area for the DNN and S-NSSAI, the AMF may determine the LADN Service Area Information per LADN DNN sent to UE using the LADN service area for the DNN as described in clause 5.6.5.
-	If the UE does not indicate support of LADN per DNN and S-NSSAI and the AMF has no LADN service area for the DNN but there is a LADN service area for the DNN and S-NSSAI, then the AMF may determine the LADN Service Area Information per LADN DNN sent to UE using this LADN service area for the DNN and S-NSSAI as the LADN service area for that DNN as described in clause 5.6.5 if the UE is not subscribed to the same DNN for multiple S-NSSAI(s) (i.e. the UE is subscribed to the DNN for a single S-NSSAI only).
NOTE:	In order to serve the UEs that do not support LADN per DNN and S-NSSAIs, the operator can avoid using the same DNN for multiple S-NSSAIs if LADN service area is configured per DNN and S-NSSAI.
-	If the UE does not indicate support of LADN per DNN and S-NSSAI and the AMF neither has a LADN service area for the DNN nor has a LADN service area for the DNN and S-NSSAI, the AMF shall not provide any LADN Information to the UE.
-	The AMF enforces the LADN Service Area per LADN DNN and S-NSSAI in the same way as is described in clause 5.6.5 with the difference that the LADN service area is defined per DNN and S-NSSAI.
-	The UE enforces the LADN Service Area per LADN DNN and S-NSSAI, if received from the AMF, in the same way as is described in clause 5.6.5 with the difference that the LADN service area is defined per DNN and S-NSSAI.
-	If the AMF enforces the LADN Service Area per LADN DNN and S-NSSAI for the UE, the AMF indicates to the SMF during PDU Session Establishment that the PDU Session is subject to LADN per LADN DNN and S-NSSAI. If indicated by AMF at PDU Session Establishment that PDU Session is subject to LADN per LADN DNN and S-NSSAI, the SMF configures the DNN of PDU Session as LADN DNN and subscribes to "UE mobility event notification" for reporting UE presence in Area of Interest by providing LADN DNN and S-NSSAI to the AMF as described in clauses 5.6.11 and 5.3.4.4.
At PDU Session Establishment to a DN:
-	The DN-specific identity (TS 33.501 [29]) of a UE may be authenticated/authorized by the DN.
NOTE 1: the DN-AAA server may belong to the 5GC or to the DN.
-	If the UE provides authentication/authorization information corresponding to a DN-specific identity during the Establishment of the PDU Session, and the SMF determines that Secondary authentication/authorization of the PDU Session Establishment is required based on the SMF policy associated with the DN, the SMF passes the authentication/authorization information of the UE to the DN-AAA server via the UPF if the DN-AAA server is located in the DN. If the SMF determines that Secondary authentication/authorization of the PDU Session Establishment is required but the UE has not provided a DN-specific identity as part of the PDU Session Establishment request, the SMF requests the UE to indicate a DN-specific identity using EAP procedures as described in TS 33.501 [29]. If the Secondary authentication/authorization of the PDU Session Establishment fails, the SMF rejects the PDU Session Establishment.
NOTE 2:	If the DN-AAA server is located in the 5GC and reachable directly, then the SMF may communicate with it directly without involving the UPF.
-	The DN-AAA server may authenticate/authorize the PDU Session Establishment.
-	When DN-AAA server authorizes the PDU Session Establishment, it may send DN Authorization Data for the established PDU Session to the SMF. The DN authorization data for the established PDU Session may include one or more of the following:
-	A DN Authorization Profile Index which is a reference to authorization data for policy and charging control locally configured in the SMF or PCF.
-	a list of allowed MAC addresses for the PDU Session; this shall apply only for PDU Session of Ethernet PDU type and is further described in clause 5.6.10.2.
-	a list of allowed VLAN tags for the PDU Session; this shall apply only for PDU Session of Ethernet PDU type and is further described in clause 5.6.10.2.
-	DN authorized Session AMBR for the PDU Session. The DN Authorized Session AMBR for the PDU Session takes precedence over the subscribed Session-AMBR received from the UDM.
-	Framed Route information (see clause 5.6.14) for the PDU Session.
-	L2TP information, such as LNS IP address and/or LNS host name, as described in TS 29.561 [132].
SMF policies may require DN authorization without Secondary authentication/authorization. In that case, when contacting the DN-AAA server for authorization, the SMF provides the GPSI of the UE if available.
Such Secondary authentication/authorization takes place for the purpose of PDU Session authorization in addition to:
-	The 5GC access authentication handled by AMF and described in clause 5.2.
-	The PDU Session authorization enforced by SMF with regards to subscription data retrieved from UDM.
Based on local policies the SMF may initiate Secondary authentication/authorization at PDU Session Establishment. The SMF provides the GPSI, if available, in the signalling exchanged with the DN-AAA during Secondary authentication/authorization.
After the successful Secondary authentication/authorization, a session is kept between the SMF and the DN-AAA.
The UE provides the authentication/authorization information required to support Secondary authentication/authorization by the DN over NAS SM.
If a UE is configured with DNNs, which are subject to secondary authentication/authorization, the UE stores an association between the DNN and corresponding credentials for the secondary authentication/authorization.
NOTE 3:	How the UE is aware that a DNN is subject to secondary authentication/authorization (e.g. based on local configuration) is out of scope of this specification.
The UE may support remote provisioning of credentials for secondary authentication/authorization, as specified in clause 5.39.
A UE that supports to be provisioned with the credentials used for secondary authentication/authorization over UP remote provisioning shall use connectivity over an S-NSSAI/DNN which can access the provisioning server to establish a PDU session for remote provisioning as defined in clause 5.39.
NOTE 4:	The credentials for secondary authentication/authorization are not specified.
SMF policies or subscription information (such as defined in Table 5.2.3.3.1 of TS 23.502 [3]) may trigger the need for SMF to request the Secondary authentication/authorization and/or UE IP address / Prefix from the DN-AAA server.
When SMF adds a PDU Session Anchor (such as defined in clause 5.6.4) to a PDU Session Secondary authentication/authorization is not carried out, but SMF policies may require SMF to notify the DN when a new prefix or address has been added to or removed from a PDU Session or N6 traffic routing information has been changed for a PDU Session.
When SMF gets notified from UPF with the addition or removal of MAC addresses to/from a PDU Session, the SMF policies may require SMF to notify the DN-AAA server.
Indication of PDU Session Establishment rejection is transferred by SMF to the UE via NAS SM.
If the DN-AAA sends DN Authorization Data for the authorized PDU Session to the SMF and dynamic PCC is deployed, the SMF sends the PCF the DN authorized Session AMBR and/or DN Authorization Profile Index in the DN Authorization Data for the established PDU Session.
If the DN-AAA sends DN Authorization Profile Index in DN Authorization Data to the SMF and dynamic PCC is not deployed, the SMF uses the DN Authorization Profile Index to refer the locally configured information.
NOTE 5:	DN Authorization Profile Index is assumed to be pre-negotiated between the operator and the administrator of DN-AAA server.
If the DN-AAA does not send DN Authorization Data for the established PDU Session, the SMF may use locally configured information.
At any time, a DN-AAA server may revoke the authorization for a PDU Session or update DN Authorization Data for a PDU Session. According to the request from DN-AAA server, the SMF may release or update the PDU Session. See clause 5.6.14 when the update involves Framed Route information.
At any time, a DN-AAA server or SMF may trigger Secondary Re-authentication procedure for a PDU Session established with Secondary Authentication as specified in clause 11.1.3 of TS 33.501 [29].
During Secondary Re-authentication/Re-authorization, if the SMF receives from DN-AAA the DN authorized Session AMBR and/or DN Authorization Profile Index, the SMF shall report the received value(s) to the PCF.
The procedure for secondary authentication/authorization by a DN-AAA server during the establishment of a PDU Session is described in clause 4.3.2.3 of TS 23.502 [3].
The support for L2TP on N6 is further specified in clause 5.8.2.16, and the procedure for establishment of L2TP tunnelling on N6 for a PDU Session is described in clause 4.3.2.4 of TS 23.502 [3].
NOTE 6:	The L2TP Tunnel information sent to the SMF can, for example, be provisioned in the DN-AAA server per DNN/S-NSSAI or per SUPI or GPSI.
The content of this clause applies to non-roaming and to LBO deployments i.e. to cases where the involved entities (AF, PCF, SMF, UPF) belong to the Serving PLMN or AF belongs to a third party with which the Serving PLMN has an SLA agreement.
AF influence on traffic routing may apply in the case of Home Routed deployments with Session Breakout (HR SBO) as defined in TS 23.548 [130]. In that case when an AF belonging to the V-PLMN (or with an offloading SLA with the V PLMN) desires to provide Traffic Influence policies it may invoke at the V-NEF the API defined in this clause and provide the information listed in Table 5.6.7-1 below but the corresponding Traffic Influence information is provided directly from V-NEF to V-SMF bypassing the PCF. This is further defined in TS 23.548 [130] clause 6.7.2. and the rest of the clause 5.6.7.1 does not address how information related with AF influence on traffic routing may be provided to the SMF in the case of HR SBO.
PCF shall not apply AF requests to influence traffic routing to PDU Sessions established in Home Routed mode.
The AF may determine the common EAS/DNAI for the UE set in order to indicate a common EAS or common local part of DN, and provide the common EAS/DNAI to the 5GS.
An AF may send requests to influence SMF routeing decisions for traffic of PDU Session. The AF requests may influence UPF (re)selection and (I-)SMF (re)selection and allow routeing user traffic to a local access to a Data Network (identified by a DNAI).
The AF may issue requests on behalf of applications not owned by the PLMN serving the UE.
If the operator does not allow an AF to access the network directly, the AF shall use the NEF to interact with the 5GC, as described in clause 6.2.10.
The AF may be in charge of the (re)selection or relocation of the applications within the local part of the DN (as defined in TS 23.548 [130]). Such functionality is not defined. For this purpose, the AF may request to get notified about events related with PDU Sessions.
In the case of AF instance change, the AF may send request of AF relocation information.
The AF requests are sent to the PCF via N5 (in the case of requests targeting specific on-going PDU Sessions of individual UE(s), for an AF allowed to interact directly with the 5GC NFs) or via the NEF. The AF requests that target existing or future PDU Sessions of multiple UE(s) or of any UE are sent via the NEF and may target multiple PCF(s), as described in clause 6.3.7.2. The PCF(s) transform(s) the AF requests into policies that apply to PDU Sessions. When the AF has subscribed to UP path management event notifications from SMF(s) (including notifications on how to reach a GPSI over N6), such notifications are sent either directly to the AF or via an NEF (without involving the PCF). For AF interacting with PCF directly or via NEF, the AF requests may contain the information as described in the Table 5.6.7-1:
Table 5.6.7-1: Information element contained in AF request

For each information element mentioned above in the AF request, the detailed description is as follows:
1)	Information to identify the traffic. The traffic can be identified in the AF request by
-	Either a DNN and possibly slicing information (S-NSSAI) or an AF-Service-Identifier
-	When the AF provides an AF-Service-Identifier i.e. an identifier of the service on behalf of which the AF is issuing the request, the 5G Core maps this identifier into a target DNN and slicing information (S-NSSAI)
-	When the NEF processes the AF request the AF-Service-Identifier may be used to authorize the AF request.
-	An application identifier or traffic filtering information (e.g. IP 5 Tuple). The application identifier refers to an application handling UP traffic and is used by the UPF to detect the traffic of the application.
	When the AF request is for influencing SMF routing decisions, the information is to identify the traffic to be routed.
	When the AF request is for subscription to notifications about UP path management events, the information is to identify the traffic that the events relate to.
2)	Information about the N6 traffic routing requirements for traffic identified as defined in 1). This includes:
-	Information about the N6 traffic routing requirements that is provided per DNAI: for each DNAI, the N6 traffic routing requirements may contain a routing profile ID and/or N6 traffic routing information.
-	An optional indication of traffic correlation, when the information in 4) identifies a group of UEs. This implies the targeted PDU Sessions should be correlated by a common DNAI in the user plane for the traffic identified in 1). If this indication is provided by the AF, the 5GC should select a common DNAI for the target PDU Sessions from the list of DNAI(s) specified in 3).
NOTE 1:	The N6 traffic routing requirements are related to the mechanism enabling traffic steering in the local access to the DN. The routing profile ID refers to a pre-agreed policy between the AF and the 5GC. This policy may refer to different steering policy ID(s) sent to SMF and e.g. based on time of the day etc.
NOTE 2:	The mechanisms enabling traffic steering in the local access to the DN are not defined.
3)	Potential locations of applications towards which the traffic routing should apply. The potential location of application is expressed as a list of DNAI(s). If the AF interacts with the PCF via the NEF, the NEF may map the AF-Service-Identifier information to a list of DNAI(s). The DNAI(s) may be used for UPF (re)selection and (I-)SMF (re)selection. When only one DNAI is included, and the Indication of traffic correlation is available, the DNAI is used as common DNAI for UEs identified by AF request.
4)	Information on the set of target UE(s). This may correspond to:
-	Individual UEs (i.e. one or a list of UEs) identified using GPSI, or an IP address/Prefix or a MAC address.
-	Group(s) of UEs identified by External Group Identifier(s) as defined in TS 23.682 [36] when the AF interacts via the NEF, or Internal-Group Identifier (see clause 5.9.7) when the AF interacts directly with the PCF.
-	Any UE accessing the combination of DNN, S-NSSAI and DNAI(s).
-	External Group ID(s) or any UE can both be complemented with External Subscriber Category(s) for a more granular selection of UEs. NEF may map this to Internal Group ID(s) or a combination of Internal Group ID(s) and Subscriber Category(s), defined in TS 23.503 [45].
NOTE 3:	Only NEF is aware of the External Subscriber Category. As a user can be associated with multiple Subscriber Category(s), some values of Subscriber Category(s) can correspond to an SLA between an application provider represented by an AF and the 5GC operator. In the NEF API, the combination of application identifier and External Subscriber Category can also be used to refer to this SLA.
	When the PDU Session type is IPv4 or IPv6 or IPv4v6, and the AF provides an IP address and/or an IP Prefix, or when the PDU Session type is Ethernet and the AF provides a MAC address, this allows the PCF to identify the PDU Session for which this request applies and the AF request applies only to that specific PDU Session of the UE. In this case, additional information such as the UE identity may also be provided to help the PCF to identify the correct PDU Session.
	Otherwise, the request targets multiple UE(s) and shall apply to any existing or future PDU Sessions that match the parameters in the AF request.
	When the AF request targets an individual or a list of UE(s) and GPSI is provided within the AF request, the GPSI is mapped to SUPI according to the subscription information received from UDM.
	When the AF request targets any UE or a group of UE, the AF request is likely to influence multiple PDU Sessions possibly served by multiple SMFs and PCFs.
	When the AF request targets a group of UE it provides one or several group identifiers in its request. The group identifiers provided by the AF are mapped to Internal-Group identifiers. Members of the group have Group Identifier(s) in their subscription. The Internal-Group Identifier(s) is(are) stored in UDM, retrieved by SMF from UDM and passed by SMF to PCF at PDU Session set-up. The PCF can then map the AF request with user subscription and determine whether an AF request targeting a Group of users applies to a PDU Session. When External Subscriber Category(s) is provided, the NEF maps External Subscriber Category(s) into Subscriber Category(s), the PCF can map the AF request with user subscription and then creates PCC rules for UEs that have the Susbscriber Category(s) in their subscription.
	When the AF request is for influencing SMF routing decisions, the information is to identify UE(s) whose traffic is to be routed.
	When the AF request is for subscription to notifications about UP path management events, the information is to identify UE(s) whose traffic the events relate to.
	When the AF request is for traffic forwarding in a PDU Session serving for TSC, the MAC address used by the PDU Session is determined by the AF to identify UE whose traffic is to be routed according to the previously stored binding relationship of the 5GS Bridge and the port number of the traffic forwarding information received from TSN network.
5)	Indication of application relocation possibility. This indicates whether an application can be relocated once a location of the application is selected by the 5GC. If application relocation is not possible, the 5GC shall ensure that for the traffic related with an application, no DNAI change takes place once selected for this application.
6)	Temporal validity condition. This is provided in the form of time interval(s) or duration(s) during which the AF request is to be applied.
	When the AF request is for influencing SMF routing decisions, the temporal validity condition indicates when the traffic routing is to apply.
	When the AF request is for subscription to notifications about UP path management events, the temporal validity condition indicates when the notifications are to be generated.
7)	Spatial validity condition on the UE(s) location. This is provided in the form of validity area(s). If the AF interacts with the PCF via the NEF, it may provide geographical area (e.g. a civic address or shapes) and the NEF maps the information to areas of validity based on pre-configuration. The PCF in turn determines area(s) of interest based on validity area(s).
	When the AF request is for influencing SMF routing decisions, the spatial validity condition indicates that the request applies only to the traffic of UE(s) located in the specified location.
	When the AF request is for subscription to notifications about UP path management events, the spatial validity condition indicates that the subscription applies only to the traffic of UE(s) located in the specified location.
8)	Information on AF subscription to corresponding SMF events.
	The AF may request to be subscribed to change of UP path associated with traffic identified in the bullet 1) above. The AF request contains:
-	A type of subscription (subscription for Early and/or Late notifications).
	The AF subscription can be for Early notifications and/or Late notifications. In the case of a subscription for Early notifications, the SMF sends the notifications before the (new) UP path is configured. In the case of a subscription for Late notifications, the SMF sends the notification after the (new) UP path has been configured.
-	Notification target address for receiving event notification.
-	Optionally, an indication of "AF acknowledgment to be expected".
	The indication implies that the AF will provide a response to the notifications of UP path management events to the 5GC. The SMF may, according to this indication, determine to wait for a response from the AF before the SMF configures in the case of early notification, or activates in the case of late notification, the new UP path as described in clause 5.6.7.2.
-	Optionally, an immediate reporting flag.
	The immediate reporting flag is included when AF subscribe for candidate DNAI(s) of UE for common EAS/DNAI selection. With this flag, SMF should immediately response AF with the candidate DNAI(s) using Notification of user plane management event as described in clause 4.3.6.3 in TS 23.502 [3].
	The AF subscription can also request to receive information associating the GPSI of the UE with the IP address(es) of the UE and/or with actual N6 traffic routing to be used to reach the UE on the PDU Session; in this case the corresponding information is sent by the SMF regardless of whether a DNAI applies to the PDU Session.
9)	An AF transaction identifier referring to the AF request. This allows the AF to update or remove the AF request and to identify corresponding UP path management event notifications. The AF transaction identifier is generated by the AF.
	When the AF interacts with the PCF via the NEF, the NEF maps the AF transaction identifier to an AF transaction internal identifier, which is generated by the NEF and used within the 5GC to identify the information associated to the AF request. The NEF maintains the mapping between the AF transaction identifier and the AF transaction internal identifier. The relation between the two identifiers is implementation specific.
	When the AF interacts with the PCF directly, the AF transaction identifier provided by the AF is used as AF transaction internal identifier within the 5GC.
10)	Indication of UE IP address preservation. This indicates UE IP address related to the traffic identified in bullet 1) should be preserved. If this indication is provided by the AF, the 5GC should preserve the UE IP address by preventing reselection of PSA UPF for the identified traffic once the PSA UPF is selected.
11)	Information for EAS IP Replacement in 5GC. This indicates the Source EAS identifier and Target EAS identifier (i.e. IP addresses and port numbers of the source and target EAS) for a service subject to Edge Computing.
12)	User Plane Latency Requirement. This includes AF requirements for User Plane latency. (see clause 6.3.6 of TS 23.548 [130]).
13)	Information on AF change. The AF relocation information includes:
-	AF Identifier: the identifier of the target AF instance.
NOTE 4:	The AF relocation information is applicable for interaction with NEF only and it is not stored in UDR or transferred to PCF, even for the case AF directly interacts with PCF.
14)	Indication for EAS relocation. This indicates the application(s) are to be relocated.
15)	Indication for Simultaneous Connectivity over source and target PSA at Edge Relocation (see clause 6.3.4 of TS 23.548 [130]). Indicates that source and target PSA should coexist for some time at PSA relocation, and may influence the establishment of a temporary N9 forwarding tunnel between the source UL CL and target UL CL. It may also provide guidance for the time interval after the described traffic ceases when the connectivity over the source PSA may be removed.
16)	Traffic Correlation ID. Identification of a set of UEs subjecting to the AF request and accessing the application identified by the Traffic Description. UEs associated with the same Traffic Correlation ID and accessing the application identified by the Traffic Description should connect to a common EAS or EAS(es) corresponding to a common DNAI.
	The following attributes may be provided with the Traffic Correlation ID:
-	EAS Correlation indication. Indicates selecting a common EAS for a set of UEs identified by Traffic Correlation ID and accessing the application identified by the Traffic Description.
-	Common EAS IP address. IP address of the common EAS to be accessed by the UEs in the set of UE subject to AF request, for the application identified by the Traffic Description.
NOTE 5:	In the case of common EAS selection, if Traffic Correlation ID is provided, either EAS Correlation indication or Common EAS will be included in AF request.
-	FQDN(s). FQDN(s) corresponding to the application to be accessed by a set of UEs. When FQDN(s) is included, it is used for influencing EAS discovery procedure as defined in TS 23.548 [130].
-	Indication of traffic correlation as described in 2).
An AF may send requests to influence SMF routeing decisions, for event subscription or for both.
The AF may request to be subscribed to notifications about UP path management events, i.e. a UP path change occurs for the PDU Session. The corresponding notification about a UP path change sent by the SMF to the AF may indicate the DNAI and /or the N6 traffic routing information and/or common EAS that has changed as described in clause 4.3.6.3 of TS 23.502 [3]. It may include the AF transaction internal identifier, the type of notification (i.e. early notification or late notification), the Identity of the source and/or target DNAI, the IP address/prefix of the UE or the MAC address used by the UE, the GPSI and the N6 traffic routing information related to the 5GC UP. The AF may subscribe for notifications of candidate DNAI(s) for UE if AF selection of common EAS/DNAI for a set of UEs is used.
NOTE 6:	The change from the UP path status where no DNAI applies to a status where a DNAI applies indicates the activation of this AF request; the change from the UP path status where a DNAI applies to a status where no DNAI applies indicates the de-activation of this AF request.
	In the case of IP PDU Session Type, the IP address/prefix of the UE together with N6 traffic routing information indicates to the AF how to reach over the User Plane the UE identified by its GPSI. N6 traffic routing information indicates any tunnelling that may be used over N6. The nature of this information depends on the deployment.
NOTE 7:	N6 traffic routing information can e.g. correspond to the identifier of a VPN or to explicit tunnelling information such as a tunnelling protocol identifier together with a Tunnel identifier.
NOTE 8:	In the case of Unstructured PDU Session type the nature of the N6 traffic routing information related to the 5GC UP is described in clause 5.6.10.3.
	In the case of Ethernet PDU Session Type, the MAC address of the UE together with N6 traffic routing information indicates to the AF how to reach over the User Plane the UE identified by its GPSI. The UE MAC address (es) is reported by the UPF as described in clause 5.8.2.12. The N6 traffic routing information can be, e.g. a VLAN ID or the identifier of a VPN or a tunnel identifier at the UPF.
When notifications about UP path management events are sent to the AF via the NEF, if required, the NEF maps the UE identify information, e.g. SUPI, to the GPSI and the AF transaction internal identifier to the AF transaction identifier before sending the notifications to the AF.
The PCF, based on information received from the AF, operator's policy, optionally service experience analytics per UP path received from NWDAF, etc. authorizes the request received from the AF and determines for each DNAI, a traffic steering policy ID (derived from the routing profile ID provided by the AF) and/or the N6 traffic routing information (as provided by the AF) to be sent to the SMF as part of the PCC rules. The traffic steering policy IDs are configured in the SMF or in the UPF. The traffic steering policy IDs are related to the mechanism enabling traffic steering to the DN.
The DNAIs are related to the information considered by the SMF for UPF selection and (I-)SMF (re)selection, e.g. for diverting (locally) some traffic matching traffic filters provided by the PCF.
The PCF acknowledges a request targeting an individual PDU Session to the AF or to the NEF.
For PDU Session that corresponds to the AF request, the PCF provides the SMF with a PCC rule that is generated based on the AF request, Local routing indication from the PDU Session policy control subscription information and taking into account UE location presence in area of interest (i.e. Presence Reporting Area). The PCC rule contains the information to identify the traffic, information about the DNAI(s) towards which the traffic routing should apply and optionally, an indication of traffic correlation and/or an indication of application relocation possibility and/or indication of UE IP address preservation. The PCC rule also contains per DNAI a traffic steering policy ID and/or N6 traffic routing information, if the N6 traffic routing information is explicitly provided in the AF request.
If Traffic Correlation ID is included in the AF request, with EAS Correlation Indication or Common EAS, and FQDN(s) parameters, the Traffic Correlation ID and the EAS Correlation Indication or Common EAS, and FQDN(s) will be included in the PCC rule sent to SMF. The SMF can use the Traffic Correlation ID to determine that the UE belongs to a set of UEs identified by Traffic Correlation ID and a common EAS should be selected for the set of UE for the traffic identified by Traffic Descriptor as described in clause 6.2.3.2.5 of TS 23.548 [130].
If Traffic Correlation ID is included in the AF request, NEF updates the AF influence data in the UDR with the NEF Notification Endpoint to indicate it as responsible of the set of UEs associated with the Traffic correlation ID and to be notified with 5GC determined information as described in clause 6.2.3.2.7 of TS 23.548 [130].
The PCF provides in the PCC rule with information to notify to the NEF with 5GC determined information related to the UE members of the set of UEs identified by traffic correlation ID.
If Traffic Correlation ID, and traffic correlation indication and FQDN(s) is included in the AF request, the Traffic Correlation ID and the traffic correlation indication will be included in the PCC rule sent to SMF. The SMF can use the Traffic Correlation ID to determine that the UE belongs to a set of UEs identified by Traffic Correlation ID and the UE needs to connect to EAS(s) corresponding to a common DNAI selected for the set of UE for the traffic identified by Traffic Descriptor, as described in clause 6.2.3.2.6 of TS 23.548 [130].
The PCF may also provide in the PCC rule information to subscribe the AF (or the NEF) to SMF events (UP path changes) corresponding to the AF request in which case it provides the information on AF subscription to corresponding SMF events received in the AF request. This is done by providing policies at PDU Session set-up or by initiating a PDU Session Modification procedure. When initiating a PDU Session set-up or PDU Session Modification procedure, the PCF considers the latest known UE location to determine the PCC rules provided to the SMF. The PCF evaluates the temporal validity condition of the AF request and informs the SMF to activate or deactivate the corresponding PCC rules according to the evaluation result. When policies specific to the PDU Session and policies general to multiple PDU Sessions exist, the PCF gives precedence to the PDU Session specific policies over the general policies. The PCF authorizes the AF request of User Plane Latency Requirements. If the PCF determines that the requirements can't be authorized, the PCF rejects the AF request.
The spatial validity condition is resolved at the PCF. In order to do that, the PCF subscribes to the SMF to receive notifications about change of UE location in an area of interest (i.e. Presence Reporting Area). The subscribed area of interest may be the same as spatial validity condition, or may be a subset of the spatial validity condition (e.g. a list of TAs) based on the latest known UE location. When the SMF detects that UE entered the area of interest subscribed by the PCF, the SMF notifies the PCF and the PCF provides to the SMF the PCC rules described above by triggering a PDU Session Modification. When the SMF becomes aware that the UE left the area subscribed by the PCF, the SMF notifies the PCF and the PCF provides updated PCC rules by triggering a PDU Session Modification. SMF notifications to the PCF about UE location in or out of the subscribed area of interest are triggered by UE location change notifications received from the AMF or by UE location information received during a Service Request or Handover procedure.
When the PCC rules are activated, the SMF may, based on local policies, take the information in the PCC rules and, optionally, the Service Experience analytics and/or DN Performance analytics per UP path (including UPF and/or DNAI and/or AS instance) as defined in clause 6.4.3 and clause 6.14.3, respectively, of TS 23.288 [86] into account to:
-	(re)select UP paths (including DNAI(s)) for PDU Sessions. The SMF is responsible for handling the mapping between the UE location (TAI / Cell-Id) and DNAI(s) associated with UPF and applications and the selection of the UPF(s) that serve a PDU Session. This is described in clause 6.3.3. If the PDU Session is of IP type and if Indication of UE IP address preservation is included in the PCC rules, the SMF should preserve the UE IP address, by not reselecting the related PSA UPF once the PSA UPF is selected, for the traffic identified in the PCC rule. If the user plane latency requirement is included in the PCC rules, the SMF chooses the PSA UPF that satisfies the user plane latency requirement. If the PCC rules are related to a 5G VN group served by the SMF and if the PCC rule includes an indication of traffic correlation, the SMF should select a common DNAI for the PDU Sessions of the 5G VN group, see clause 5.29.
-	configure traffic steering at UPF, including activating mechanisms for traffic multi-homing or enforcement of an UL Classifier (UL CL). Such mechanisms are defined in clause 5.6.4. This may include that the SMF is providing the UPF with packet handling instructions (i.e. PDRs and FARs) for steering traffic to the local access to the DN. The packet handling instructions are generated by the SMF using the traffic steering policy ID and/or the N6 traffic routing information in the PCC rules corresponding to the applied DNAI. In the case of UP path reselection, the SMF may configure the source UPF to forward traffic to the UL CL/BP so that the traffic is steered towards the target UPF.
-	if Information on AF subscription to corresponding SMF events has been provided in the PCC rule, inform the AF of the (re)selection of the UP path (UP path change). If the information includes an indication of "AF acknowledgment to be expected", the SMF may decide to wait for a response from the AF before it activates the new UP path, as described in clause 5.6.7.2.
When an I-SMF is inserted for a PDU Session, the I-SMF insertion, relocation or removal to a PDU session shall be transparent (i.e. not aware) to the PCF and to the AF. The processing of the AF influence on traffic routing is described in clause 5.34 and detailed procedure is described in clause 4.23.6 of TS 23.502 [3].
In order to avoid or minimize service interruption during PSA relocation for a PDU session of SSC mode 3, or a PDU session with UL CL or branch point, according to the indication of "AF acknowledgment to be expected" on AF subscription to corresponding SMF events (DNAI change) (that may be provided in PCC rules received from the PCF as defined in clause 5.6.7.1 except in HR-SBO case or that may be provided directly by V-NEF to V-SMF as defined in TS 23.548 [130] clause 6.7.2 in case of HR-SBO) or according to local configuration (e.g. DN-related policies) the SMF may wait for a response from the AF after sending a notification (an early notification or a late notification) to the AF. In the case of late notification, based on the indication of "AF acknowledgment to be expected" on AF subscription, the SMF may send the notification before activating the UP path towards a new DNAI (possibly through a new PSA).
NOTE 1:	Before the UP path toward the new DNAI is activated, application traffic data (if any exists) is still routed toward the old DNAI.
The notification sent from the SMF to the AF indicates UP path management events (DNAI change) as described in clause 5.6.7.1. The AF can confirm the DNAI change indicated in the notification with the SMF by sending a positive response to the notification to the SMF or reject the DNAI change by sending a negative response.
NOTE 2:	The AF can determine whether application relocation is needed according to the notification of DNAI change. If not, the AF can send a positive response to the SMF immediately; otherwise, the AF sends the positive response after application relocation is completed or a negative response if the AF determines that the application relocation cannot be completed on time (e.g. due to temporary congestion). The AF decision and behaviours on application relocation are not defined. However, the new DNAI may be associated with a new AF. In such cases, the SMF and the old AF cancel earlier subscribed UP path management event notifications, and the new AF subscribes to receive UP path management event notifications from the SMF.
The AF can include N6 traffic routing information related to the target DNAI in a positive response sent to the SMF. The SMF configures the N6 traffic routing information from the AF response to the PSA on the UP path.
The AF can include the EAS relocation Indication to indicate the application(s) to be relocated.
In the case of early notification, based on the indication of "AF acknowledgment to be expected" on AF subscription, the SMF does not configure the UP path towards the new DNAI until it receives a positive AF response as specified in clause 4.3.6.3 of TS 23.502 [3].
In the case of late notification, based on the indication of "AF acknowledgment to be expected" on AF subscription, the SMF does not activate the UP path towards the new DNAI until it receives a positive AF response as specified in clause 4.3.5 of TS 23.502 [3].
NOTE 3:	After the UP path toward the new DNAI is activated, data is routed toward the new DNAI.
If the SMF receives a negative response at any time, the SMF keeps using the original DNAI and may cancel related PSA relocation or addition. The SMF may perform DNAI reselection afterwards if needed.
The SMF can assume according to local policy a negative response if a response is expected and but not received from the AF within a certain time window.
When Early/Late Notification happens, the SMF notifies AF about the target DNAI and may indicate capability of supporting EAS IP replacement in 5GC.When EAS relocation is performed, the AF sends an/a early/late notification response to the SMF after the EAS relocation is completed, which may include the Information for EAS IP Replacement in 5GC. The SMF may instruct the local PSA with the EAS IP address replacement using "Outer Header Creation" as defined in clause 5.8.5.6 and "Outer Header Removal" as defined in clause 5.8.5.3. If local PSA relocation is required, the SMF may request the target local PSA to buffer uplink traffic as described in clause 6.3.5 of TS 23.548 [130].
AF relocation may be triggered by SMF e.g. in relationship with DNAI change due to UE mobility. In the case of AF relocation involving different DNAI(s), it is possible that the source EHE is unaware of other/target EHE specific deployment details. In such cases, when SMF selects a target DNAI (e.g. based on current UE location), the SMF may determine based on the EDI that the target DNAI is not supported by the source AF. The SMF determines the target AF ID based on the target DNAI and the EDI. Accordingly, as part of Early/Late Notification, the SMF provides the target AF ID to the source AF as described in clause 4.3.6.3 of TS 23.502 [3].
This clause applies to the case when a UE has established multiple PDU Sessions. The activation of a UP connection of an existing PDU Session causes the activation of its UE-CN User Plane connection (i.e. data radio bearer and N3 tunnel).
For the activation of a UP connection the service area restrictions as specified in clause 5.3.4.1.1 apply.
For the UE in the CM-IDLE state in 3GPP access, either UE or Network-Triggered Service Request procedure may support independent activation of UP connection of existing PDU Session. For the UE in the CM-IDLE state in non-3GPP access, UE-Triggered Service Request procedure allows the re-activation of UP connection of existing PDU Sessions, and may support independent activation of UP connection of existing PDU Session.
A UE in the CM-CONNECTED state invokes a Service Request (see clause 4.2.3.2 of TS 23.502 [3]) procedure to request the independent activation of the UP connection of existing PDU Sessions.
Network Triggered re-activation of UP connection of existing PDU Sessions is handled as follows:
-	If the UE CM state in the AMF is already CM-CONNECTED on the access (3GPP, non-3GPP) associated to the PDU Session in the SMF, the network may re-activate the UP connection of a PDU Session using a Network Initiated Service Request procedure.
Otherwise:
-	If the UE is registered in both 3GPP and non-3GPP accesses and the UE CM state in the AMF is CM-IDLE in non-3GPP access, the UE can be paged or notified through the 3GPP access for a PDU Session associated in the SMF (i.e. last routed) to the non-3GPP access:
-	If the UE CM state in the AMF is CM-IDLE in 3GPP access, the paging message may include the access type associated with the PDU Session in the SMF. The UE, upon reception of the paging message containing an access type, shall reply to the 5GC via the 3GPP access using the NAS Service Request message, which shall contain the list of PDU Sessions associated with the received access type and whose UP connections can be re-activated over 3GPP (i.e. the list does not contain the PDU Sessions whose UP connections cannot be re-activated on 3GPP based on UE policies and whether the S-NSSAIs of these PDU Sessions are within the Allowed NSSAI for 3GPP access). If the PDU Session for which the UE has been paged is in the list of the PDU Sessions provided in the NAS Service Request and the paging was triggered by pending DL data, the 5GC shall re-activate the PDU Session UP connection over 3GPP access. If the paging was triggered by pending DL signalling, the Service Request succeeds without re-activating the PDU session UP connection over the 3GPP access and the pending DL signalling is delivered to the UE over the 3GPP access;
-	If the UE CM state in the AMF is CM-CONNECTED in 3GPP access, the notification message shall include the non-3GPP Access Type. The UE, upon reception of the notification message, shall reply to the 5GC via the 3GPP access using the NAS Service Request message, which shall contain the List of Allowed PDU Sessions that can be re-activated over 3GPP or an empty List of Allowed PDU Sessions if no PDU Sessions are allowed to be re-activated over 3GPP access.
NOTE:	A UE that is in a coverage of a non-3GPP access and has PDU Session(s) that are associated in the UE (i.e. last routed) to non-3GPP access, is assumed to attempt to connect to it without the need to be paged.
-	If the UE is registered in both 3GPP and non-3GPP accesses served by the same AMF and the UE CM state in the AMF is CM-IDLE in 3GPP access and is in CM-CONNECTED in non 3GPP access, the UE can be notified through the non-3GPP for a PDU Session associated in the SMF (i.e. last routed) to the 3GPP access. The notification message shall include the 3GPP Access Type. Upon reception of the notification message, when 3GPP access is available, the UE shall reply to the 5GC via the 3GPP access using the NAS Service Request message.
In addition to the above, a PDU Session may be established as an always-on PDU Session as described in clause 5.6.13.
The deactivation of the UP connection of an existing PDU Session causes the corresponding data radio bearer and N3 tunnel to be deactivated. The UP connection of different PDU Sessions can be deactivated independently when a UE is in CM-CONNECTED state in 3GPP access or non-3GPP access. At the deactivation of the UP of a PDU Session using a N9 tunnel whose end-point is controlled by an I-SMF, the N9 tunnel is preserved. If a PDU Session is an always-on PDU Session, the SMF should not deactivate a UP connection of this PDU Session due to inactivity.
The support for session and service continuity in 5G System architecture enables to address the various continuity requirements of different applications/services for the UE. The 5G System supports different session and service continuity (SSC) modes defined in this clause. The SSC mode associated with a PDU Session does not change during the lifetime of a PDU Session. The following three modes are specified with further details provided in the next clause:
-	With SSC mode 1, the network preserves the connectivity service provided to the UE. For the case of PDU Session of IPv4 or IPv6 or IPv4v6 type, the IP address is preserved.
-	With SSC mode 2, the network may release the connectivity service delivered to the UE and release the corresponding PDU Session(s). For the case of IPv4 or IPv6 or IPv4v6 type, the release of the PDU Session induces the release of IP address(es) that had been allocated to the UE.
-	With SSC mode 3, changes to the user plane can be visible to the UE, while the network ensures that the UE suffers no loss of connectivity. A connection through new PDU Session Anchor point is established before the previous connection is terminated in order to allow for better service continuity. For the case of IPv4 or IPv6 or IPv4v6 type, the IP address is not preserved in this mode when the PDU Session Anchor changes.
NOTE:	In this Release of the specification, the addition/removal procedure of additional PDU Session Anchor in a PDU Session for local access to a DN is independent from the SSC mode of the PDU Session.
For a PDU Session of SSC mode 1, the UPF acting as PDU Session Anchor at the establishment of the PDU Session is maintained regardless of the access technology (e.g. Access Type and cells) a UE is successively using to access the network.
In the case of a PDU Session of IPv4 or IPv6 or IPv4v6 type, IP continuity is supported regardless of UE mobility events.
In this Release of the specification, when IPv6 multihoming or UL CL applies to a PDU Session of in SSC mode 1, and the network allocates (based on local policies) additional PDU Session Anchors to such a PDU Session, these additional PDU Session Anchors may be released or allocated, and the UE does not expect that the additional IPv6 prefix is maintained during the lifetime of PDU Session.
SSC mode 1 may apply to any PDU Session type and to any access type.
A UE supporting PDU Connectivity shall support SSC mode 1.
If a PDU Session of SSC mode 2 has a single PDU Session Anchor, the network may trigger the release of the PDU Session and instruct the UE to establish a new PDU Session to the same data network immediately. The trigger condition depends on operator policy e.g. request from Application Function, based on load status, etc. At establishment of the new PDU Session, a new UPF acting as PDU Session Anchor can be selected.
Otherwise, if a PDU Session of SSC mode 2 has multiple PDU Session Anchors (i.e. in the case of multi-homed PDU Sessions or in the case that UL CL applies to a PDU Session of SSC mode 2), the additional PDU Session Anchors may be released or allocated.
SSC mode 2 may apply to any PDU Session type and to any access type.
SSC mode 2 is optional to be supported in the UE.
NOTE 1:	Features depending on SSC mode 2 will not work with the lack of support for SSC mode 2 in the UE.
NOTE 2:	In UL CL mode, the UE is not involved in PDU Session Anchor re-allocation, so that the existence of multiple PDU Session Anchors is not visible to the UE.
For PDU Session of SSC mode 3, the network allows the establishment of UE connectivity via a new PDU Session Anchor to the same data network before connectivity between the UE and the previous PDU Session Anchor is released. When trigger conditions apply, the network decides whether to select a PDU Session Anchor UPF suitable for the UE's new conditions (e.g. point of attachment to the network).
In this Release of specification, SSC mode 3 only applies to IP PDU Session type and to any access type.
In the case of a PDU Session of IPv4 or IPv6 or IPv4v6 type, during the procedure of change of PDU Session Anchor, the following applies:
a.	For a PDU Session of IPv6 type, the new IP prefix anchored on the new PDU Session Anchor may be allocated within the same PDU Session (relying on IPv6 multi-homing specified in clause 5.6.4.3), or
b.	The new IP address and/or IP prefix may be allocated within a new PDU Session that the UE is triggered to establish.
After the new IP address/prefix has been allocated, the old IP address/prefix is maintained during some time indicated to the UE via NAS signalling (as described in clause 4.3.5.2 of TS 23.502 [3]) or via Router Advertisement (as described in clause 4.3.5.3 of TS 23.502 [3]) and then released.
If a PDU Session of SSC mode 3 has multiple PDU Session Anchors (i.e. in the case of multi-homed PDU Sessions or in the case that UL CL applies to a PDU Session of SSC mode 3), the additional PDU Session Anchors may be released or allocated.
SSC mode 3 is optional to be supported in the UE.
NOTE:	Features depending on SSC mode 3 will not work with the lack of support for SSC mode 3 in the UE.
SSC mode selection is done by the SMF based on the allowed SSC modes -including the default SSC mode) in the user subscription as well as the PDU Session type and if present, the SSC mode requested by the UE.
The operator may provision a SSC mode selection policy (SSCMSP) to the UE as part of the URSP rule -see clause 6.6.2 of TS 23.503 [45]). The UE shall use the SSCMSP to determine the type of session and service continuity mode associated with an application or group of applications for the UE as described in clause 6.6.2.3 of TS 23.503 [45]. If the UE does not have SSCMSP, the UE can select a SSC mode based on UE Local Configuration as described in TS 23.503 [45], if applicable. If the UE cannot select a SSC mode, the UE requests the PDU Session without providing the SSC mode.
NOTE 1:	The UE can use the SSC Mode Selection component of the URSP rule with match-all traffic descriptor if there is no SSC mode in the UE local configuration.
The SSC mode selection policy rules provided to the UE can be updated by the operator by updating the URSP rule.
The SMF receives from the UDM the list of allowed SSC modes and the default SSC mode per DNN per S-NSSAI as part of the subscription information.
If a UE provides an SSC mode when requesting a new PDU Session, the SMF selects the SSC mode by either accepting the requested SSC mode or rejecting the PDU Session Establishment Request message with the cause value and the SSC mode(s) allowed to be used back to UE based on the PDU Session type, subscription and/or local configuration. Based on that cause value and the SSC mode(s) allowed to be used, the UE may re-attempt to request the establishment of that PDU Session with the SSC mode allowed to be used or using another URSP rule.
If a UE does not provide an SSC mode when requesting a new PDU Session, then the SMF selects the default SSC mode for the data network listed in the subscription or applies local configuration to select the SSC mode.
SSC mode 1 shall be assigned to the PDU Session when static IP address/prefix is allocated to the PDU Session based on the static IP address/prefix subscription for the DNN and S-NSSAI. The SMF shall inform the UE of the selected SSC mode for a PDU Session.
The UE shall not request and the network shall not assign SSC mode 3 for the PDU Session of Unstructured type or Ethernet type.
NOTE 2:	To avoid issues for UEs not supporting all SSC modes, the operator can, in the subscription data and local configuration, include at least SSC mode 1 in the allowed SSC modes, and set default SSC mode to 1 (since all UEs supporting PDU sessions are mandated to support SSC mode 1). Still the 5GC can trigger PDU session release with a cause code indicating reactivation due to, e.g. restoration or user plane path optimization purposes, though this may cause interruption of the service.
The IP address allocation is defined in clause 5.8.1
The UE may acquire following configuration information from the SMF, during the lifetime of a PDU Session:
-	Address(es) of P-CSCF(s);
-	Address(es) of DNS server(s).
-	If the UE indicates support of DNS over (D) TLS to the network and the network wants to enforce the use of DNS over (D)TLS, the configuration information is sent by the SMF via PCO may also include the corresponding DNS server security information as specified in TS 24.501 [47] and TS 33.501 [29].
-	the GPSI of the UE.
The UE may acquire from the SMF, at PDU Session Establishment, the MTU that the UE shall consider, see clause 5.6.10.4.
The UE may provide following information to the SMF during the lifetime of a PDU Session:
-	an indication of the support of P-CSCF re-selection based on procedures specified in TS 24.229 [62] (clauses B.2.2.1C and L.2.2.1C).
-	PS data off status of the UE.
NOTE 2:	An operator can deploy NAT functionality in the network; the support of NAT is not specified in this release of the specification, though UPF can expose mapping between public and private IP addresses.
For a PDU Session set up with the Ethernet PDU Session type, the SMF and the UPF acting as PDU Session Anchor (PSA) can support specific behaviours related with the fact the PDU Session carries Ethernet frames.
Depending on operator configuration related with the DNN, different configurations for how Ethernet traffic is handled on N6 may apply, for example:
-	Configurations with a 1-1 relationship between a PDU Session and a N6 interface possibly corresponding to a dedicated tunnel established over N6. In this case the UPF acting as PSA transparently forwards Ethernet frames between the PDU Session and its corresponding N6 interface, and it does not need to be aware of MAC addresses used by the UE in order to route down-link traffic.
-	Configurations, where more than one PDU Session to the same DNN (e.g. for more than one UE) corresponds to the same N6 interface. In this case the UPF acting as PSA needs to be aware of MAC addresses used by the UE in the PDU Session in order to map down-link Ethernet frames received over N6 to the appropriate PDU Session. Forwarding behaviour of the UPF acting as PSA is managed by SMF as specified in clause 5.8.2.5.
NOTE 1:	The "MAC addresses used by the UE" correspond to any MAC address used by the UE or any device locally connected to the UE and using the PDU Session to communicate with the DN.
Based on operator configuration, the SMF may request the UPF acting as the PDU Session Anchor to respond to ARP/IPv6 Neighbour Solicitation requests based on local cache information, i.e. the mapping between the UE MAC address to the UE IP address, and the DN where the PDU Session is connected to, or to redirect the ARP traffic from the UPF to the SMF. Responding to ARP/IPv6 ND based on local cache information applies to ARP/IPv6 ND received in both UL and DL directions.
NOTE 2:	Responding to ARP/ND from a local cache assumes the UE or the devices behind the UE acquire their IP address via in-band mechanisms that the SMF/UPF can detect and by this link the IP address to the MAC address.
NOTE 3:	This mechanism is intended to avoid broadcasting or multicasting the ARP/IPv6 ND to every UE.
Ethernet Preamble and Start of Frame delimiter are not sent over 5GS:
-	For UL traffic the UE strips the preamble and frame check sequence (FCS) from the Ethernet frame.
-	For DL traffic the PDU Session Anchor strips the preamble and frame check sequence (FCS) from the Ethernet frame.
Neither a MAC nor an IP address is allocated by the 5GC to the UE for a PDU Session.
The PSA shall store the MAC addresses received from the UE, and associate those with the appropriate PDU Session.
The SMF may receive a list of allowed VLAN tags from DN-AAA (for a maximum of 16 VLAN tags) or may be locally configured with allowed VLAN tags values. The SMF may also be configured with instructions on VLAN handling (e.g. the VLAN tag to be inserted or removed, S-TAG to be inserted or removed). Taking this into account, the SMF determines the VLAN handling for the PDU Session, and instructs the UPF to accept or discard the UE traffic based on the allowed VLAN tags, as well as to handle VLAN tags (addition/removal) via PDR (Outer header removal) and FAR (UPF applying Outer header creation of a Forwarding policy). For example:
-	The UPF may insert (for uplink traffic) and remove (for downlink traffic) a S-TAG on N6 or N19 or internal interface ("5G VN internal") for the traffic from and to the UE.
-	The UPF may insert (for uplink traffic) and remove (for downlink traffic) a VLAN tag on the N6 interface while there is no VLAN in the traffic to and from the UE.
-	The UPF may discard any UE traffic that does not contain any allowed VLAN tag when the UPF handles the UE uplink or downlink traffic.
NOTE 4:	This can be used for traffic steering to N6-LAN but also for N6-based traffic forwarding related with 5G-VN service described in clause 5.29.4
Apart from specific conditions related to the support of PDU sessions over W-5GAN defined in TS 23.316 [84], the UPF shall not remove VLAN tags sent by the UE and the UPF shall not insert VLAN tags for the traffic sent to the UE.
PDU(s) containing a VLAN tag shall be switched only within the same VLAN by a PDU Session Anchor.
The UE may acquire from the SMF, at PDU Session Establishment, the MTU of the Ethernet frames' payload that the UE shall consider, see clause 5.6.10.4.
NOTE 5:	The UE may operate in bridge mode with regard to a LAN it is connecting to the 5GS, thus different MAC addresses may be used as source address of different frames sent UL over a single PDU Session (and destination MAC address of different frames sent DL over the same PDU Session).
NOTE 6:	Entities on the LAN connected to the 5GS by the UE may have an IP address allocated by the DN but the IP layer is considered as an application layer which is not part of the Ethernet PDU Session.
NOTE 7:	In this Release of the specification, only the UE connected to the 5GS is authenticated, not the devices behind such UE.
NOTE 8:	5GS does not support the scenario where a MAC address or if VLAN applies a (MAC address, VLAN) combination is used on more than one PDU Session for the same DNN and S-NSSAI.
NOTE 9:	This Release of the specification does not guarantee that the Ethernet network remains loop-free. Deployments need to be verified on an individual basis that loops in the Ethernet network are avoided.
NOTE 10:	This Release of the specification does not guarantee that the Ethernet network properly and quickly reacts to topology changes. Deployments need to be verified on an individual basis how they react to topology changes.
Different Frames exchanged on a PDU Session of Ethernet type may be served with different QoS over the 5GS. Thus, the SMF may provide to the UPF Ethernet Packet Filter Set and forwarding rule(s) based on the Ethernet frame structure and UE MAC address(es). The UPF detects and forwards Ethernet frames based on the Ethernet Packet Filter Set and forwarding rule(s) received from the SMF. This is further defined in clauses 5.7 and 5.8.2.
When a PDU Session of Ethernet PDU type is authorized by a DN as described in clause 5.6.6, the DN-AAA server may, as part of authorization data, provide the SMF with a list of allowed MAC addresses for this PDU Session; the list is limited to a maximum of 16 MAC addresses. When the list has been provided for a PDU Session, the SMF sets corresponding filtering rules in the UPF(s) acting as PDU Session Anchor for the PDU Session. The UPF discards any UL traffic that does not contain one of these MAC addresses as a source address if the list of allowed MAC addresses is provided.
In this Release of specification, the PDU Session of Ethernet PDU Session type is restricted to SSC mode 1 and SSC mode 2.
For a PDU Session established with the Ethernet PDU Session type, the SMF may, upon PCF request, need to ensure reporting to the PCF of all Ethernet MAC addresses used as UE address in a PDU Session. In this case, as defined in clause 5.8.2.12, the SMF controls the UPF to report the different MAC addresses used as source address of frames sent UL by the UE in the PDU Session.
NOTE 11:	This relates to whether AF control on a per MAC address is allowed on the PDU Session as defined in clause 6.1.1.2 of TS 23.503 [45].
The PCF may activate or deactivate the reporting of the UE MAC address using the "UE MAC address change" Policy Control Request Trigger as defined in Table 6.1.3.5-1 of TS 23.503 [45].
The SMF may relocate the UPF acting as the PDU Session Anchor for an Ethernet PDU Session as defined in clause 4.3.5.8 of TS 23.502 [3]. The relocation may be triggered by a mobility event such as a handover, or may be triggered independent of UE mobility, e.g. due to load balancing reasons. In order to relocate the PSA UPF, the reporting of the UE MAC addresses needs to be activated by the SMF.
Different Point-to-Point (PtP) tunnelling techniques may be used to deliver Unstructured PDU Session type data to the destination (e.g. application server) in the Data Network via N6.
Point-to-point tunnelling based on UDP/IP encapsulation as described below may be used. Other techniques may be supported. Regardless of addressing scheme used from the UPF to the DN, the UPF shall be able to map the address used between the UPF and the DN to the PDU Session.
When Point-to-Point tunnelling based on UDP/IPv6 is used, the following considerations apply:
-	IPv6 prefix allocation for PDU Sessions are performed locally by the (H-)SMF without involving the UE.
-	The UPF(s) acts as a transparent forwarding node for the payload between the UE and the destination in the DN.
-	For uplink, the UPF forwards the received Unstructured PDU Session type data to the destination in the data network over the N6 PtP tunnel using UDP/IPv6 encapsulation.
-	For downlink, the destination in the data network sends the Unstructured PDU Session type data using UDP/IPv6 encapsulation with the IPv6 address of the PDU Session and the 3GPP defined UDP port for Unstructured PDU Session type data. The UPF acting as PDU Session Anchor decapsulates the received data (i.e. removes the UDP/IPv6 headers) and forwards the data identified by the IPv6 prefix of the PDU Session for delivery to the UE.
-	The (H-)SMF performs the IPv6 related operations but the IPv6 prefix is not provided to the UE, i.e. Router Advertisements and DHCPv6 are not performed. The SMF assigns an IPv6 Interface Identifier for the PDU Session. The allocated IPv6 prefix identifies the PDU Session of the UE.
-	For AF influence on traffic routing (described in clause 5.6.7), when the N6 PtP tunnelling is used over the DNAI and the AF provides, by value, information about N6 traffic routing requirements in the AF request, the AF provides N6 PtP tunnelling requirements (IPv6 address and UDP port of the tunnel end in the DN) as the N6 traffic routing information associated to the DNAI; when the SMF notifies the AF of UP path management events, it includes the N6 PtP tunnel information related to the UP (the IPv6 address and the 3GPP defined UDP port of the tunnel end at the UPF) as N6 traffic routing information in the notification.
In this Release of the specification there is support for maximum one 5G QoS Flow per PDU Session of Type Unstructured.
In this Release of specification, the PDU Session of Unstructured PDU Session type is restricted to SSC mode 1 and SSC mode 2.
The UE may acquire from the SMF, at PDU Session Establishment, the MTU that the UE shall consider, see clause 5.6.10.4.
In order to avoid data packet fragmentation between the UE and the UPF acting as PSA, the link MTU size in the UE should be set to the value provided by the network as part of the IP configuration. The link MTU size for IPv4 is sent to the UE by including it in the PCO (see TS 24.501 [47]). The link MTU size for IPv6 is sent to the UE by including it in the IPv6 Router Advertisement message (see RFC 4861 [54]).
NOTE 1:	Ideally the network configuration ensures that for PDU Session type IPv4v6 the link MTU values provided to the UE via PCO and in the IPv6 Router Advertisement message are the same. In cases where this condition cannot be met, the MTU size selected by the UE is unspecified.
When using a PDU Session type Unstructured, the maximum uplink packet size, and when using Ethernet, the Ethernet frames' payload, that the UE should use may be provided by the network as a part of the session management configuration by encoding it within the PCO (see TS 24.501 [47]).
When using a PDU Session type Unstructured, to provide a consistent environment for application developers, the network shall use a maximum packet size of at least 128 octets (this applies to both uplink and downlink).
When the MT and the TE are separated, the TE may either be pre-configured to use a specific default MTU size or the TE may use an MTU size provided by the network via the MT. Thus, it is not always possible to set the MTU value by means of information provided by the network.
NOTE 2:	In network deployments that have MTU size of 1500 octets in the transport network, providing a link MTU value of 1358 octets (as shown in Figure J-1) to the UE as part of the IP configuration information from the network will prevent the IP layer fragmentation within the transport network between the UE and the UPF. For network deployments that uniformly support transport with larger MTU size than 1500 octets (for example with ethernet jumbo frames of MTU size up to 9216 octets), providing a link MTU value of MTU minus 142 octets to the UE as part of the IP configuration information from the network will prevent the IP layer fragmentation within the transport network between the UE and the UPF. Link MTU considerations are discussed further in Annex J.
NOTE 3:	As the link MTU value is provided as a part of the session management configuration information, a link MTU value can be provided during each PDU Session establishment. In this release, dynamic adjustment of link MTU for scenarios where MTU is not uniform across transport are not addressed.
When a PDU Session is established or modified, or when the user plane path has been changed (e.g. UPF re-allocation/addition/removal), SMF may determine an Area of Interest, e.g. based on UPF Service Area, subscription by PCF for reporting UE presence in Presence Reporting Area, etc.
For 3GPP access, the Area of Interest corresponds:
-	either to Presence Information that may correspond to:
-	a list of Tracking Areas; or
-	a list of Presence Reporting Area ID(s) and optionally the elements comprising TAs and/or NG-RAN nodes and/or cells identifiers corresponding to the PRA ID(s); or
-	a LADN DNN; or
-	a LADN DNN and a S-NSSAI.
For Non-3GPP access, the Area of Interest corresponds to:
-	N3GPP TAI (see clause 5.3.2.3).
For UE location change into or out of an "area of interest", the SMF subscribes to "UE mobility event notification" service provided by AMF for reporting of UE presence in Area of Interest as described in clause 5.3.4.4. The AMF may send the UE location to the SMF along with the notification, e.g. for UPF selection. Upon reception of a notification from AMF, the SMF determines how to deal with the PDU Session, e.g. reallocate UPF.
In the case of LADN, the SMF provides the LADN DNN to the AMF to subscribe to "UE mobility event notification" for reporting UE presence in LADN service area. Upon reception of a notification from the AMF, the SMF determines how to deal with the PDU Session as described in clause 5.6.5.
For use cases related to policy control and charging decisions, the PCF may subscribe to event reporting from the SMF or the AMF, for UE presence in a Presence Reporting Area.
A Presence Reporting Area can be:
-	A "UE-dedicated Presence Reporting Area", defined in the subscriber profile and composed of a short list of TAs and/or NG-RAN nodes and/or cells identifiers in a PLMN; or derived from the Area of Interest provided by the Application Function to the PCF (see clause 5.6.7) and composed of a short list of TAs and/or NG-RAN nodes and/or cells identifiers in a PLMN; or
-	A "Core Network predefined Presence Reporting Area", predefined in the AMF and composed of a short list of TAs and/or NG-RAN nodes and/or cells identifiers in a PLMN.
In the case of Change of UE Presence in Presence Reporting Area, for core network predefined Presence Reporting Area, the AMF determines the "area of interest" corresponding to the Presence Reporting Area Identifier(s), provided by the PCF or the SMF, as a list of TAIs and/or cell identifiers and/or NG-RAN node identifiers based on local configuration. For UE-dedicated Presence Reporting Areas, the subscription for UE location change notification for an "area of interest" shall contain the PRA Identifier(s) and the list(s) of TAs, or NG-RAN Node identifier and/or cell identifiers composing the Presence Reporting Area(s). For Core Network predefined Presence Reporting Areas, the subscription for UE location change notification for an "area of interest" shall contain the PRA identifier(s).
NOTE 1:	If the Presence Reporting Area (PRA) and RAN Notification Area (RNA) are partially overlapping, the PCF will not get notified for the change of PRA when UE enters or leaves the PRA but remains in the RNA in CM-CONNECTED with RRC_INACTIVE state, because AMF is not informed.
Each Core Network predefined Presence Reporting Area can be configured with a priority level in the AMF. In order to prevent overload, the AMF may set the reporting for one or more of the received Presence Reporting Area(s) to inactive under consideration of the priority configured for each of Core Network predefined Presence Reporting Area(s), while storing the reporting request for this Presence Reporting Area in the UE context.
NOTE 2:	Change of UE presence in Presence Reporting Area reporting does not apply to home routed roaming.
The AMF may be configured with a PRA identifier which refers to a Set of Core Network predefined Presence Reporting Areas. If the PCF subscribes to change of UE location for an area of interest for a Set of Presence reporting areas and provides a PRA identifier then the SMF may subscribe for event reporting for this Set of Presence Reporting Areas by only indicating this PRA Identifier in the area of interest. When the Presence Reporting Area(s) to be reported belong to a set of Core Network predefined Presence Reporting Areas in which the AMF is requested to report on change of UE presence, the AMF shall additionally add to the report the PRA Identifier of the Set of Core Network predefined Presence Reporting Areas.
Upon change of AMF, the PRA identifier(s) and if provided, the list(s) of Presence Reporting Area elements are transferred for all PDU sessions as part of MM Context information to the target AMF during the mobility procedure. If one or more Presence Reporting Area(s) was set to inactive, the target AMF may decide to reactivate one or more of the inactive Presence Reporting Area(s). The target AMF indicates per PDU session to the corresponding SMF/PCF the PRA identifier(s) and whether the UE is inside or outside the Presence Reporting Area(s) as well as the inactive Presence Reporting Area(s), if any.
NOTE 3:	The target AMF cannot set the Presence Reporting Area(s) received from the source serving node to inactive.
The subscription may be maintained during the life of PDU Session, regardless of the UP activation state of PDU Session (i.e. whether UP connection of the PDU Session is activated or not).
SMF may determine a new area of interest, and send a new subscription to the AMF with the new area of interest.
SMF un-subscribes to "UE mobility event notification" service when PDU Session is released.
The SMF may provide a Network Instance to the UPF in FAR and/or PDR via N4 Session Establishment or N4 Modification procedures.
NOTE 1:	a Network Instance can be defined e.g. to separate IP domains, e.g. when a UPF is connected to 5G-ANs in different IP domains, overlapping UE IP addresses assigned by multiple Data Networks, transport network isolation in the same PLMN, etc.
NOTE 2:	As the SMF can provide over N2 the Network Instance it has selected for the N3 CN Tunnel Info, the 5G AN does not need to provide Network Instance to the 5GC.
The SMF determines the Network Instance based on local configuration.
The SMF may determine the Network Instance for N3 and N9 interfaces, taking into account e.g. UE location, registered PLMN ID of UE, S-NSSAI of the PDU Session.
The SMF may determine the Network Instance for N6 interface taking into account e.g. (DNN, S-NSSAI) of the PDU Session.
The SMF may determine the Network Instance for N19 interface taking into account e.g. the (DNN, S-NSSAI) identifying a 5G VN group.
NOTE 3:	As an example, the UPF can use the Network Instance included in the FAR, together with other information such as Outer header creation (IP address part) and Destination interface in the FAR, to determine the interface in UPF (e.g. VPN or Layer 2 technology) for forwarding of the traffic.
An always-on PDU Session is a PDU Session for which User Plane resources have to be activated during every transition from CM-IDLE mode to CM-CONNECTED state.
Based on an indication from upper layers, a UE may request to establish a PDU Session as an always-on PDU Session. The SMF decides whether the PDU Session can be established as an always-on PDU Session. In Home Routed roaming case, based on local policies, the V-SMF shall be involved to determine whether the PDU Session can be established as an always-on PDU Session.
If the UE requests the 5GC to modify a PDU Session, which was established in EPS, to an always-on PDU Session after the first inter-system change from EPS to 5GS, the SMF decides whether the PDU Session can be established as an always-on PDU Session based on the procedure described above.
The UE shall request activation of User Plane resources for always-on PDU Sessions even if there are no pending uplink data for this PDU Session or when the Service Request is triggered for signalling only or when the Service Request is triggered for paging response only.
If the UE has one or more established PDU Sessions which are not accepted by the network as always-on PDU Sessions and the UE has no uplink user data pending to be sent for those PDU Sessions, the UE shall not request for activating User Plane resources for those PDU sessions.
Framed Routing is only defined for PDU Sessions of the IP type (IPv4, IPv6, IPv4v6) and allows to support an IP network behind a UE, such that a range of IPv4 addresses or IPv6 prefixes is reachable over a single PDU Session, e.g. for enterprise connectivity. Framed Routes are IP routes behind the UE.
A PDU Session may be associated with multiple Framed Routes. Each Framed Route refers to a range of IPv4 addresses (i.e. an IPv4 address and an IPv4 address mask) or a range of IPv6 Prefixes (i.e. an IPv6 Prefix and an IPv6 Prefix length). The set of one or more Framed Routes associated to a PDU Session is contained in the Framed Route information. The network does not send Framed Route information to the UE: devices in the network(s) behind the UE get their IP address by mechanisms out of the scope of 3GPP specifications. See RFC 2865 [73], RFC 3162 [74].
Framed Route information is provided by the SMF to the UPF (acting as PSA) as part of Packet Detection Rule (PDR, see clause 5.8.5.3) related with the network side (N6) of the UPF.
NOTE:	SMF can take the UPF capabilities into account when selecting PSA UPF, to ensure that the SMF chooses PSA UPF(s) that support Framed Routing for PDU Sessions to DNN and/or slices deemed to support Framed Routing e.g. DNN and/or slices intended to support RG or if Framed Route information has been received as part of Session Management Subscription data.
The Framed Route information may be provided to the SMF by:
-	the DN-AAA server as part of PDU Session Establishment authentication/authorization by a DN-AAA server (as defined in clause 5.6.6); or by
-	Session Management Subscription data associated with DNN and S-NSSAI sent by UDM (as defined in clause 5.2.3.3.1 of TS 23.502 [3]).
	If the SMF receives Framed Route information both from DN-AAA and from UDM, the information received from DN-AAA takes precedence and supersedes the information received from UDM.
The IPv4 address / IPv6 Prefix allocated to the UE as part of the PDU Session establishment (e.g. delivered in NAS PDU Session Establishment Accept) may belong to one of the Framed Routes associated with the PDU Session or may be dynamically allocated outside of such Framed Routes.
If PCC applies to the PDU Session, at PDU Session establishment the SMF reports to the PCF the Framed Route information corresponding to the PDU Session (as described in clause 6.1.3.5 of TS 23.503 [45]). In this case, in order to support session binding, the PCF may further report to the BSF the Framed Route information corresponding to the PDU Session (as described in clause 6.1.2.2 of TS 23.503 [45]).
If the UDM or DN-AAA updates the Framed Route information during the lifetime of the PDU Session, the SMF releases the PDU Session and may include in the release request an indication for the UE to re-establish the PDU Session.
Triggers for the SMF to request for or subscribe to the analytics information from the NWDAF are internal logic may include for example:
-	UE PDU Session related event subscription by other NFs (e.g. AMF, NEF);
-	UE access and mobility event reports from the AMF;
-	locally detected events;
-	analytics information received.
The trigger conditions may depend on operator and implementation policy in the SMF. When a trigger condition happens, the SMF may decide if any analytics information is needed and if so, request for or subscription to the analytics information from the NWDAF.
The SMF may, upon detection of certain local events, e.g. number of PDU sessions establishment or released reaches a threshold in a specific area, request for or subscribe to network analytics related to "Abnormal behaviour" as described in TS 23.288 [86] to detect whether there are any exceptional UE behaviours in this area.
Service Function Chaining, also called N6-LAN Traffic Steering, refers to the steering of subscriber's traffic flows to appropriate operator or 3rd party Service Functions (e.g. NAT, antimalware, parental control, DDoS protection) in the N6-LAN.
The content of this clause applies to non-roaming and to Home Routed roaming scenario, i.e. to cases where the involved entities (AF, PCF, SMF, UPF) belong to the Home PLMN and the AF has an agreement with the Home PLMN.
The PCF controls Service Function Chaining by provisioning and modifying traffic steering control information for N6-LAN Traffic Steering as described in TS 23.503 [45], e.g. clause 6.1.3.14. The traffic steering control information for N6-LAN Traffic Steering consists of a traffic description and a reference to a traffic steering policy that is configured in the SMF/UPF.
The PCF derives the TSP ID(s) (that can be different for uplink and downlink directions) based on operator configuration and sends the TSP ID(s) to the SMF as part of the N6-LAN Traffic Steering Enforcement Control information in the PCC rule as described in clause 6.3.1 of TS 23.503 [45].
When the PCC rule is activated or updated with N6-LAN Traffic Steering Enforcement Control information, the SMF sets the Forwarding Policy (uplink and/or downlink) within the FAR(s) based on the authorized TSP ID(s) in the PCC rule and under consideration of the direction. In case that Application Function influence on traffic routing Enforcement Control information and N6-LAN Traffic Steering Enforcement Control information are both provided for the uplink direction, the SMF shall derive N4 rules which instruct the UPF to pass the traffic through the relevant Service Function(s) deployed in the N6-LAN before steering the traffic to the local data network. The SMF provides instructions to UPF for N6-LAN traffic steering as further detailed in clause 5.8.5.6.
The UPF applies traffic steering mechanism based on Forwarding Policy, i.e. the UPF performs deployment specific actions as configured for the Forwarding Policy.
NOTE 1:	It is assumed that all UPFs in the operator network serving as PSA for the DNN/S-NSSAI/DNAI subject to N6-LAN traffic steering need to be configured with the same traffic steering information for N6-LAN traffic steering.
When performing deployment specific actions configured for the Forwarding Policy, the UPF may support traffic steering related functionality and user plane encapsulation protocols that are out of 3GPP scope (e.g. as defined by other standards organizations).
NOTE 2:	The existing user plane mechanisms (e.g. VXLAN, NSH, GENEVE, GRE, VLAN, etc.) defined at IETF are reused as applicable by the PSA UPF to support N6-LAN traffic steering.
The mechanism used for forwarding the traffic between the Service Functions within the N6-LAN is out of 3GPP scope.
An AF may request the steering of user plane traffic to a pre-configured chain of Service Functions on N6-LAN.
In the non-roaming scenario, Application Function influence on Service Function Chaining and Application Function influence on traffic routing (as defined in clause 5.6.7) can be applicable to the same traffic simultaneously.
It is assumed that a service level agreement exists between the operator and a third party that includes a list of authorized predefined Service Function Chains (SFCs), each SFC being identified based on a Service Function Chaining identifier (SFC ID). The AF may request the selected traffic flows to be steered towards a specific SFC, either at PDU Session establishment or any time after PDU Session establishment.
The AF requests may be sent to the PCF via the NEF. When SFC ID is included in the AF request, the parameters listed in Table 5.6.16.2-1 may be included in the AF request.
Table 5.6.16.2-1: Information element contained in AF request

The PCF checks whether the SFC ID received from the AF corresponds to an authorized predefined SFC according to the service level agreement with this AF. Based on the SFC ID received from the AF, the PCF derives the TSP ID(s) (that can be different for uplink and downlink directions) and sends the TSP ID(s) and optionally Metadata (as provided by the AF) to the SMF as part of the PCC rule(s) as described in clause 6.3.1 of TS 23.503 [45].
The SMF behaves in the same way it is described in clause 5.6.16.1. If the SMF has received Metadata in the N6-LAN Traffic Steering Enforcement Control information of the PCC rule, the SMF forwards the Metadata to the UPF via N4 in the corresponding FAR as described in clause 5.8.5.6.
The 5G QoS model is based on QoS Flows. The 5G QoS model supports both QoS Flows that require guaranteed flow bit rate (GBR QoS Flows) and QoS Flows that do not require guaranteed flow bit rate (Non-GBR QoS Flows). The 5G QoS model also supports Reflective QoS (see clause 5.7.5).
The QoS Flow is the finest granularity of QoS differentiation in the PDU Session. A QoS Flow ID (QFI) is used to identify a QoS Flow in the 5G System. User Plane traffic with the same QFI within a PDU Session receives the same traffic forwarding treatment (e.g. scheduling, admission threshold). The QFI is carried in an encapsulation header on N3 (and N9) i.e. without any changes to the e2e packet header. QFI shall be used for all PDU Session Types. The QFI shall be unique within a PDU Session. The QFI may be dynamically assigned or may be equal to the 5QI (see clause 5.7.2.1).
Within the 5GS, a QoS Flow is controlled by the SMF and may be preconfigured, or established via the PDU Session Establishment procedure (see clause 4.3.2 of TS 23.502 [3]), or the PDU Session Modification procedure (see clause 4.3.3 of TS 23.502 [3].
Any QoS Flow is characterised by:
-	A QoS profile provided by the SMF to the AN via the AMF over the N2 reference point or preconfigured in the AN;
-	One or more QoS rule(s) and optionally QoS Flow level QoS parameters (as specified in TS 24.501 [47]) associated with these QoS rule(s) which can be provided by the SMF to the UE via the AMF over the N1 reference point and/or derived by the UE by applying Reflective QoS control; and
-	One or more UL and DL PDR(s) provided by the SMF to the UPF.
Within the 5GS, a QoS Flow associated with the default QoS rule is required to be established for a PDU Session and remains established throughout the lifetime of the PDU Session. This QoS Flow should be a Non-GBR QoS Flow (further details are described in clause 5.7.2.7).
A QoS Flow is associated with QoS requirements as specified by QoS parameters and QoS characteristics.
NOTE:	The QoS Flow associated with the default QoS rule provides the UE with connectivity throughout the lifetime of the PDU Session. Possible interworking with EPS motivates the recommendation for this QoS Flow to be of type Non-GBR.
A QoS Flow may be enabled with PDU Set based QoS handling as described in clause 5.37.5. For such QoS Flows, PDU Set QoS Parameters (see clause 5.7.7) are determined by the PCF and provided by SMF to the NG-RAN as part of the QoS profile.
A QoS Flow may either be 'GBR' or 'Non-GBR' depending on its QoS profile. The QoS profile of a QoS Flow is sent to the (R)AN and it contains QoS parameters as described below (details of QoS parameters are described in clause 5.7.2):
-	For each QoS Flow, the QoS profile shall include the QoS parameters:
-	5G QoS Identifier (5QI); and
-	Allocation and Retention Priority (ARP).
-	For each QoS Flow, the QoS profile may also include the QoS parameters:
-	PDU Set QoS Parameters (described in clause 5.7.7).
-	For each Non-GBR QoS Flow only, the QoS profile may also include the QoS parameter:
-	Reflective QoS Attribute (RQA).
-	For each GBR QoS Flow only, the QoS profile shall also include the QoS parameters:
-	Guaranteed Flow Bit Rate (GFBR) - UL and DL; and
-	Maximum Flow Bit Rate (MFBR) - UL and DL; and
-	In the case of a GBR QoS Flow only, the QoS profile may also include one or more of the QoS parameters:
-	Notification control;
-	Maximum Packet Loss Rate - UL and DL.
NOTE:	In this Release of the specification, the Maximum Packet Loss Rate (UL, DL) is only provided for a GBR QoS Flow belonging to voice media.
Each QoS profile has one corresponding QoS Flow identifier (QFI) which is not included in the QoS profile itself.
The usage of a dynamically assigned 5QI for a QoS Flow requires in addition the signalling of the complete 5G QoS characteristics (described in clause 5.7.3) as part of the QoS profile.
When a standardized or pre-configured 5QI is used for a QoS Flow, some of the 5G QoS characteristics may be signalled as part of the QoS profile (as described in clause 5.7.3).
5.7.1.2a	Alternative QoS Profile
The Alternative QoS Profile(s) can be optionally provided for a GBR QoS Flow with Notification control enabled. If the corresponding PCC rule contains the related information (as described in TS 23.503 [45]), the SMF shall provide, in addition to the QoS profile, a prioritized list of Alternative QoS Profile(s) to the NG-RAN. If the SMF provides a new prioritized list of Alternative QoS Profile(s) to the NG-RAN (if the corresponding PCC rule information changes), the NG-RAN shall replace any previously stored list with it.
An Alternative QoS Profile represents a combination of QoS parameters PDB, PER, Averaging Window and GFBR to which the application traffic is able to adapt. For delay-critical GBR QoS flows, an Alternative QoS Profile may also include an MDBV.
NOTE 1:	There is no requirement that the GFBR monotonically decreases, nor that the PDB or PER monotonically increase as the Alternative QoS Profiles become less preferred.
When the NG-RAN sends a notification to the SMF that the QoS profile is not fulfilled, the NG-RAN shall, if the currently fulfilled values match an Alternative QoS Profile, include also the reference to the Alternative QoS Profile to indicate the QoS that the NG-RAN currently fulfils (see clause 5.7.2.4). The NG-RAN shall enable the SMF to determine when an NG-RAN node supports the Alternative QoS feature but cannot fulfil even the least preferred Alternative QoS Profile.
NOTE 2:	To reduce the risk that GBR QoS Flows are released in case of RAN resource limitations (and then experience difficulties in being re-established), Application Functions can set the least preferred Alternative Service Requirement to an undemanding level.
The following options are supported to control QoS Flows:
1)	For Non-GBR QoS Flows, and when standardized 5QIs or pre-configured 5QIs are used and when the 5QI is within the range of the QFI (i.e. a value less than 64), the 5QI value may be used as the QFI of the QoS Flow.
(a)	A default ARP shall be pre-configured in the AN; or
 (b)	The ARP and the QFI shall be sent to RAN over N2 at PDU Session Establishment or at PDU Session Modification and when NG-RAN is used every time the User Plane of the PDU Session is activated; and
2)	For all other cases (including GBR and Non-GBR QoS Flows), a dynamically assigned QFI shall be used. The 5QI value may be a standardized, pre-configured or dynamically assigned. The QoS profile and the QFI of a QoS Flow shall be provided to the (R)AN over N2 at PDU Session Establishment/Modification and when NG-RAN is used every time the User Plane of the PDU Session is activated.
Only options 1b and 2 may apply to 3GPP ANs. Options 1a, 1b and 2 may apply to Non-3GPP access.
NOTE:	Pre-configured 5QI values cannot be used when the UE is roaming.
The UE performs the classification and marking of UL User plane traffic, i.e. the association of UL traffic to QoS Flows, based on QoS rules. These QoS rules may be explicitly provided to the UE (i.e. explicitly signalled QoS rules using the PDU Session Establishment/Modification procedure), pre-configured in the UE or implicitly derived by the UE by applying Reflective QoS (see clause 5.7.5). A QoS rule contains the QFI of the associated QoS Flow, a Packet Filter Set (see clause 5.7.6) and a precedence value (see clause 5.7.1.9). An explicitly signalled QoS rule contains a QoS rule identifier which is unique within the PDU Session and is generated by SMF.
There can be more than one QoS rule associated with the same QoS Flow (i.e. with the same QFI).
When the UE informs the network about the number of supported Packet Filters for signalled QoS rules for the PDU Session (during the PDU Session Establishment procedure or using the PDU Session Modification procedure as described in clause 5.17.2.2.2 after the first inter-system change from EPS to 5GS for a PDU Session established in EPS and transferred from EPS with N26 interface), the SMF shall ensure that the sum of the Packet Filters used by all signalled QoS rules for a PDU Session does not exceed the number indicated by the UE.
A default QoS rule is required to be sent to the UE for every PDU Session establishment and it is associated with a QoS Flow. For IP type PDU Session or Ethernet type PDU Session, the default QoS rule is the only QoS rule of a PDU Session which may contain a Packet Filter Set that allows all UL packets, and in this case, the highest precedence value shall be used for the QoS rule.
NOTE 2:	How the UE evaluates UL packets against the Packet Filter Set in a QoS rule is described in clause 5.7.1.5.
NOTE 3:	The QoS rule pre-configured in the UE is only used together with option 1a for control QoS Flows as described in clause 5.7.1.3. How to keep the consistency of QFI and Packet Filter Set between UE and network is out of scope in this release of the specification.
For Unstructured type PDU Session, the default QoS rule does not contain a Packet Filter Set, and in this case the default QoS rule defines the treatment of all packets in the PDU Session.
As long as the default QoS rule does not contain a Packet Filter Set or contains a Packet Filter Set that allows all UL packets, Reflective QoS should not be applied for the QoS Flow which the default QoS rule is associated with and the RQA should not be sent for this QoS Flow.
The SMF performs the binding of PCC rules to QoS Flows based on the QoS and service requirements (as defined in TS 23.503 [45]). The SMF assigns the QFI for a new QoS Flow and derives its QoS profile, corresponding UPF instructions and QoS Rule(s) from the PCC rule(s) bound to the QoS Flow and other information provided by the PCF.
When applicable, the SMF provides the following information for the QoS Flow to the (R)AN:
-	QFI;
-	QoS profile as described in clause 5.7.1.2.
-	optionally, Alternative QoS Profile(s) as described in clause 5.7.1.2a;
For each PCC rule bound to a QoS Flow, the SMF provides the following information to the UPF enabling classification, bandwidth enforcement and marking of User Plane traffic (the details are described in clause 5.8):
-	a DL PDR containing the DL part of the SDF template;
-	an UL PDR containing the UL part of the SDF template;
NOTE 1:	If a DL PDR for an bidirectional SDF is associated with a QoS Flow other than the one associated with the default QoS rule and the UE has not received any instruction to use this QoS Flow for the SDF in uplink direction (i.e. neither a corresponding QoS rule is sent to the UE nor the Reflective QoS Indication is set in the PCC rule), it means that the UL PDR for the same SDF has to be associated with the QoS Flow associated with the default QoS rule.
-	the PDR precedence value (see clause 5.7.1.9) for both PDRs is set to the precedence value of the PCC rule;
-	QoS related information (e.g. MBR for an SDF, GFBR and MFBR for a GBR QoS Flow) as described in clause 5.8.2;
-	the corresponding packet marking information (e.g. the QFI, the transport level packet marking value (e.g. the DSCP value of the outer IP header);
-	optionally, the Reflective QoS Indication is included in the QER associated with the DL PDR (as described in clause 5.7.5.3).
For each PCC rule bound to a QoS Flow, when applicable, the SMF generates an explicitly signalled QoS rule (see clause 5.7.1.4) according to the following principles and provides it to the UE together with an add operation:
-	A unique (for the PDU Session) QoS rule identifier is assigned;
-	The QFI in the QoS rule is set to the QFI of the QoS Flow to which the PCC rule is bound;
-	The Packet Filter Set of the QoS rule is generated from the UL SDF filters and optionally the DL SDF filters of the PCC rule (but only from those SDF filters that have an indication for being signalled to the UE, as defined in TS 23.503 [45]);
-	The QoS rule precedence value is set to the precedence value of the PCC rule for which the QoS rule is generated;
-	for a dynamically assigned QFI, the QoS Flow level QoS parameters (e.g. 5QI, GFBR, MFBR, Averaging Window, see TS 24.501 [47]) are signalled to UE in addition to the QoS rule(s) associated to the QoS Flow. The QoS Flow level QoS parameters of an existing QoS Flow may be updated based on the MBR and GBR information received in the PCC rule (MBR and GBR per SDF are however not provided to UE over N1 in the case of more than one SDF) or, if the PCF has not indicated differently, when Notification control or handover related signalling indicates that the QoS parameter the NG-RAN is currently fulfilling for the QoS Flow have changed (see clause 5.7.2.4).
Changes in the binding of PCC rules to QoS Flows as well as changes in the PCC rules or other information provided by the PCF can require QoS Flow changes which the SMF has to provide to (R)AN, UPF and/or UE. In the case of changes in the explicitly signalled QoS rules associated to a QoS Flow, the SMF provides the explicitly signalled QoS rules and their operation (i.e. add/modify/delete) to the UE.
NOTE 2:	The SMF cannot provide, update or remove pre-configured QoS rules or UE derived QoS rules.
The principle for classification and marking of User Plane traffic and mapping of QoS Flows to AN resources is illustrated in Figure 5.7.1.5-1.

Figure 5.7.1.5-1: The principle for classification and User Plane marking for QoS Flows and mapping to AN Resources
In DL, incoming data packets are classified by the UPF based on the Packet Filter Sets of the DL PDRs in the order of their precedence (without initiating additional N4 signalling). The UPF conveys the classification of the User Plane traffic belonging to a QoS Flow through an N3 (and N9) User Plane marking using a QFI. The AN binds QoS Flows to AN resources (i.e. Data Radio Bearers of in the case of 3GPP RAN). There is no strict 1:1 relation between QoS Flows and AN resources. It is up to the AN to establish the necessary AN resources that QoS Flows can be mapped to, and to release them. The AN shall indicate to the SMF when the AN resources onto which a QoS Flow is mapped are released.
If no matching DL PDR is found, the UPF shall discard the DL data packet.
In UL:
-	For a PDU Session of Type IP or Ethernet, the UE evaluates UL packets against the UL Packet Filters in the Packet Filter Set in the QoS rules based on the precedence value of QoS rules in increasing order until a matching QoS rule (i.e. whose Packet Filter matches the UL packet) is found.
-	If no matching QoS rule is found, the UE shall discard the UL data packet.
-	For a PDU Session of Type Unstructured, the default QoS rule does not contain a Packet Filter Set and allows all UL packets.
NOTE 3:	Only the default QoS rule exist for a PDU Session of Type Unstructured.
	The UE uses the QFI in the corresponding matching QoS rule to bind the UL packet to a QoS Flow. The UE then binds QoS Flows to AN resources.
The following characteristics apply for processing of DL traffic:
-	UPF maps User Plane traffic to QoS Flows based on the PDRs.
-	UPF performs Session-AMBR enforcement as specified in clause 5.7.1.8 and performs counting of packets for charging.
-	UPF transmits the PDUs of the PDU Session in a single tunnel between 5GC and (R)AN, the UPF includes the QFI in the encapsulation header. In addition, UPF may include an indication for Reflective QoS activation in the encapsulation header.
-	UPF performs transport level packet marking in DL on a per QoS Flow basis. The UPF uses the transport level packet marking value provided by the SMF (as described in clause 5.8.2.7).
-	(R)AN maps PDUs from QoS Flows to access-specific resources based on the QFI and the associated 5G QoS profile, also taking into account the N3 tunnel associated with the DL packet.
NOTE:	Packet Filters are not used for the mapping of QoS Flows onto access-specific resources in (R)AN.
-	If Reflective QoS applies, the UE creates a new derived QoS rule as defined in clause 5.7.5.2.
Following characteristics apply for processing of UL traffic:
-	UE uses the stored QoS rules to determine mapping between UL User Plane traffic and QoS Flows. UE marks the UL PDU with the QFI of the QoS rule containing the matching Packet Filter and transmits the UL PDUs using the corresponding access specific resource for the QoS Flow based on the mapping provided by (R)AN. For NG-RAN, the UL behaviour is specified in clause 10.5.2 of TS 38.300 [27].
-	(R)AN transmits the PDUs over N3 tunnel towards UPF. When passing an UL packet from (R)AN to CN, the (R)AN includes the QFI value, in the encapsulation header of the UL PDU, and selects the N3 tunnel.
-	(R)AN performs transport level packet marking in the UL on a per QoS Flow basis with a transport level packet marking value that is determined based on the 5QI, the Priority Level (if explicitly signalled) and the ARP priority level of the associated QoS Flow.
-	UPF verifies whether QFIs in the UL PDUs are aligned with the QoS Rules provided to the UE or implicitly derived by the UE in the case of Reflective QoS).
-	UPF and UE perform Session-AMBR enforcement as specified in clause 5.7.1.8 and the UPF performs counting of packets for charging.
UL and DL Session-AMBR (see clause 5.7.2.6) shall be enforced by the UPF, if the UPF receives the Session-AMBR values from the SMF as described in clause 5.8.2.7 and clause 5.8.5.4.
For UL Classifier PDU Sessions, UL and DL Session-AMBR (see clause 5.7.2.6) shall be enforced in the SMF selected UPF that supports the UL Classifier functionality. In addition, the DL Session-AMBR shall be enforced separately in every UPF that terminates the N6 interface (i.e. without requiring interaction between the UPFs) (see clause 5.6.4).
For multi-homed PDU Sessions, UL and DL Session-AMBR shall be enforced in the UPF that supports the Branching Point functionality. In addition, the DL Session-AMBR shall be enforced separately in every UPF that terminates the N6 interface (i.e. without requiring interaction between the UPFs) (see clause 5.6.4).
NOTE:	The DL Session-AMBR is enforced in every UPF terminating the N6 interface to reduce unnecessary transport of traffic which may be discarded by the UPF performing the UL Classifier/Branching Point functionality due to the amount of the DL traffic for the PDU Session exceeding the DL Session-AMBR. Discarding DL packets in the UL Classifier/Branching Point could cause erroneous PDU counting for support of charging
The (R)AN shall enforce UE-AMBR (see clause 5.7.2.6) in UL and DL per UE for Non-GBR QoS Flows.
The UE shall perform UL rate limitation on PDU Session basis for Non-GBR traffic using Session-AMBR, if the UE receives a Session-AMBR.
MBR per SDF is mandatory for GBR QoS Flows but optional for Non-GBR QoS Flows. The MBR is enforced in the UPF.
The MFBR is enforced in the UPF in the Downlink for GBR QoS Flows. The MFBR is enforced in the (R)AN in the Downlink and Uplink for GBR QoS Flows. For non-3GPP access, the UE should enforce MFBR in the Uplink for GBR QoS Flows.
The QoS control for Unstructured PDUs is performed at the PDU Session level and in this Release of the specification there is only support for maximum of one 5G QoS Flow per PDU Session of Type Unstructured.
When a PDU Session is set up for transferring unstructured PDUs, SMF provides the QFI which will be applied to any packet of the PDU Session to the UPF and UE.
The QoS rule precedence value and the PDR precedence value determine the order in which a QoS rule or a PDR, respectively, shall be evaluated. The evaluation of the QoS rules or PDRs is performed in increasing order of their precedence value.
If a supporting NG-RAN receives for a UE a UE-Slice-MBR (see clause 5.7.2.6) for an S-NSSAI from the AMF, the NG-RAN shall apply this UE-Slice-MBR for all PDU Sessions of that UE corresponding to the S-NSSAI which have an active user plane if feasible. In particular, the NG-RAN shall enforce this UE-Slice-MBR as follows:
1)	Whenever a request for a GBR QoS Flow establishment or modification is received, the NG-RAN admission control shall ensure that the sum of the GFBR values of the admitted GBR QoS Flows is not exceeding the UE-Slice-MBR and, if the QoS Flow cannot be admitted, the NG-RAN shall reject the establishment/modification of the QoS Flow.
NOTE:	If the UE-Slice-MBR would be exceeded by a new/modified GBR QoS Flow, the NG-RAN determines whether the new/modified GBR QoS Flow can pre-empt any existing GBR QoS Flow of the UE's PDU Session(s) corresponding to the same S-NSSAI based on their ARP values (as per clause 5.7.2.2), e.g. to support certain priority services (e.g. MPS). If this is not possible, the NG-RAN can reject the establishment/modification of the QoS Flow.
2)	The NG-RAN shall ensure that the aggregated bitrate across all GBR and Non-GBR QoS Flows belonging to those PDU Sessions is not exceeding the UE-Slice-MBR, while always guaranteeing the GFBR of every GBR QoS Flow of those PDU Sessions as described in clause 5.7.2.5.
In the case of home-routed roaming, the V-SMF may apply VPLMN policies related with the SLA negotiated with the HPLMN or with QoS values supported by the VPLMN. Such policies may result in a situation that the V-SMF does not accept the PDU Session or does not accept some of the QoS Flows requested by the H-SMF.
QoS constraints represent the QoS that the VPLMN can accept for the QoS Flow associated with the default QoS rule and the PDU Session based on SLA or based on QoS values supported by the VPLMN. The QoS constraints may contain 5QI, 5QI Priority Level and ARP for the QoS Flow associated with the default QoS rule and highest Session-AMBR accepted by the VPLMN.
NOTE:	For this Release of the specification, QoS constraints apply only to the non-GBR default QoS Flow.
At PDU Session Establishment for home-routed roaming, to reduce the risk of PDU Session establishment failure due to QoS from the HPLMN not being compliant with SLA, the V-SMF may provide the VPLMN local policy in QoS constraints to the H-SMF as specified in clause 4.3.2.2.2 of TS 23.502 [3].
For intra-5GS mobility with V-SMF insertion or V-SMF change (e.g. inter-PLMN mobility), as specified in clause 4.23 of TS 23.502 [3], the new/target V-SMF may validate the currently applied QoS against the QoS constraints. The new/target V-SMF provides QoS constraints to the H-SMF during the mobility procedure. The new/target V-SMF may temporarily accept a higher QoS even if the currently applied QoS exceeds the QoS constraints. Alternatively, for the QoS parameters related with the QoS constraints, the V-SMF may locally downgrade these values before providing the corresponding QoS profiles to 5G AN. The V-SMF may decide to release the PDU Session if the HPLMN does not provide updated QoS compliant with the QoS constraints after the mobility procedure.
For IMS voice service (e.g. the IMS DNN defined by the GSMA), the V-SMF, based on local policy, may override the ARP received from HPLMN over N16 if the ARP indicates priority not in line with the local policy in VPLMN. The ARP override in the serving PLMN applies to both the QoS Flow associated with the default QoS rule and the QoS Flows for IMS voice, to apply the same allocation and retention priority for all users (i.e. roamers and non-roamers). For MPS (clause 5.16.5), the same allocation and retention priority is applied to all MPS service users (i.e. roamers and non-roamers), when roaming agreements are in place and where regulatory requirements apply.
A 5QI is a scalar that is used as a reference to 5G QoS characteristics defined in clause 5.7.4, i.e. access node-specific parameters that control QoS forwarding treatment for the QoS Flow (e.g. scheduling weights, admission thresholds, queue management thresholds, link layer protocol configuration, etc.).
Standardized 5QI values have one-to-one mapping to a standardized combination of 5G QoS characteristics as specified in Table 5.7.4-1.
The 5G QoS characteristics for pre-configured 5QI values are pre-configured in the AN.
Standardized or pre-configured 5G QoS characteristics, are indicated through the 5QI value, and are not signalled on any interface, unless certain 5G QoS characteristics are modified as specified in clauses 5.7.3.3, 5.7.3.4, 5.7.3.6, and 5.7.3.7.
The 5G QoS characteristics for QoS Flows with dynamically assigned 5QI are signalled as part of the QoS profile.
NOTE:	On N3, each PDU (i.e. in the tunnel used for the PDU Session) is associated with one 5QI via the QFI carried in the encapsulation header.
The QoS parameter ARP contains information about the priority level, the pre-emption capability and the pre-emption vulnerability. This allows deciding whether a QoS Flow establishment/modification/handover may be accepted or needs to be rejected in the case of resource limitations (typically used for admission control of GBR traffic). It may also be used to decide which existing QoS Flow to pre-empt during resource limitations, i.e. which QoS Flow to release to free up resources.
The ARP priority level defines the relative importance of a QoS Flow. The range of the ARP priority level is 1 to 15 with 1 as the highest priority.
The ARP priority levels 1-8 should only be assigned to QoS Flows for services that are authorized to receive prioritized treatment within an operator domain (i.e. that are authorized by the serving network). The ARP priority levels 9-15 may be assigned to QoS Flows for services that are authorized by the home network and thus applicable when a UE is roaming.
NOTE:	This ensures that future releases may use ARP priority level 1-8 to indicate e.g. emergency and other priority services within an operator domain in a backward compatible manner. This does not prevent the use of ARP priority level 1-8 in roaming situation in the case that appropriate roaming agreements exist that ensure a compatible use of these priority levels.
The ARP pre-emption capability defines whether a QoS Flow may get resources that were already assigned to another QoS Flow with a lower priority. The ARP pre-emption vulnerability defines whether a QoS Flow may lose the resources assigned to it in order to admit a QoS Flow with higher priority. The ARP pre-emption capability and the ARP pre-emption vulnerability shall be either set to 'enabled' or 'disabled'.
The ARP pre-emption vulnerability of the QoS Flow which the default QoS rule is associated with should be set appropriately to minimize the risk of a release of this QoS Flow.
The details of how the SMF sets the ARP for a QoS Flow are further described in clause 5.7.2.7.
The Reflective QoS Attribute (RQA) is an optional parameter which indicates that certain traffic (not necessarily all) carried on this QoS Flow is subject to Reflective QoS. Only when the RQA is signalled for a QoS Flow, the (R)AN enables the transfer of the RQI for AN resource corresponding to this QoS Flow. The RQA may be signalled to NG-RAN via the N2 reference point at UE context establishment in NG-RAN and at QoS Flow establishment or modification.
The QoS Parameter Notification control indicates whether notifications are requested from the NG-RAN when the "GFBR can no longer (or can again) be guaranteed" for a QoS Flow during the lifetime of the QoS Flow. Notification control may be used for a GBR QoS Flow if the application traffic is able to adapt to the change in the QoS (e.g. if the AF is capable to trigger rate adaptation).
The SMF shall only enable Notification control when the QoS Notification Control parameter is set in the PCC rule (received from the PCF) that is bound to the QoS Flow. The Notification control parameter is signalled to the NG-RAN as part of the QoS profile.
5.7.2.4.1a	Notification Control without Alternative QoS Profiles
If, for a given GBR QoS Flow, Notification control is enabled and the NG-RAN determines that the GFBR, the PDB or the PER of the QoS profile cannot be fulfilled, NG-RAN shall send a notification towards SMF that the "GFBR can no longer be guaranteed". Furthermore, the NG-RAN shall keep the QoS Flow (i.e. while the NG-RAN is not fulfilling the requested QoS profile for this QoS Flow), unless specific conditions at the NG-RAN require the release of the NG-RAN resources for this GBR QoS Flow, e.g. due to Radio link failure or RAN internal congestion. The NG-RAN should try to fulfil the GFBR, the PDB and the PER of the QoS profile again.
NOTE 1:	NG-RAN can decide that the "GFBR can no longer be guaranteed" based on, e.g. measurements like queuing delay or system load.
Upon receiving a notification from the NG-RAN that the "GFBR can no longer be guaranteed", the SMF may forward the notification to the PCF, see TS 23.503 [45].
When the NG-RAN determines that the GFBR, the PDB and the PER of the QoS profile can be fulfilled again for a QoS Flow (for which a notification that the "GFBR can no longer be guaranteed" has been sent), the NG-RAN shall send a notification, informing the SMF that the "GFBR can be guaranteed" again and the SMF may forward the notification to the PCF, see TS 23.503 [45]. The NG-RAN shall send a subsequent notification that the "GFBR can no longer be guaranteed" whenever necessary.
NOTE 2:	It is assumed that NG-RAN implementation will apply some hysteresis before determining that the "GFBR can be guaranteed again" and therefore a frequent signalling of "GFBR can be guaranteed again" followed by "GFBR can no longer be guaranteed" is not expected.
NOTE 3:	If the QoS Flow is modified, the NG-RAN restarts the check whether the "GFBR can no longer be guaranteed" according to the updated QoS profile. If the Notification control parameter is not included in the updated QoS profile, the Notification control is disabled.
During a handover, the Source NG-RAN does not inform the Target NG-RAN about whether the Source NG-RAN has sent a notification for a QoS Flow that the "GFBR can no longer be guaranteed". The Target NG-RAN performs admission control rejecting any QoS Flows for which resources cannot be permanently allocated. The accepted QoS Flows are included in the N2 Path Switch Request or N2 Handover Request Acknowledge message from the NG-RAN to the AMF. The SMF shall interpret the fact that a QoS Flow is listed as transferred QoS Flow in the Nsmf_PDUSession_UpdateSMContext Request received from the AMF as a notification that "GFBR can be guaranteed again" for this QoS Flow unless the SMF is also receiving a reference to an Alternative QoS Profile for this QoS Flow (which is described in clause 5.7.2.4.2). After the handover is successfully completed, the Target NG-RAN shall send a subsequent notification that the "GFBR can no longer be guaranteed" for such a QoS Flow whenever necessary. If the SMF has previously notified the PCF that the "GFBR can no longer be guaranteed" and the SMF does not receive an explicit notification that the "GFBR can no longer be guaranteed" for that QoS Flow from the Target NG-RAN within a configured time, the SMF shall notify the PCF that the "GFBR can be guaranteed again".
5.7.2.4.1b	Notification control with Alternative QoS Profiles
If, for a given GBR QoS Flow, Notification control is enabled and the NG-RAN has received a list of Alternative QoS Profile(s) for this QoS Flow and supports the Alternative QoS Profile handling, the following shall apply:
1)	If the NG-RAN determines that the GFBR, the PDB or the PER of the QoS profile cannot be fulfilled, NG-RAN shall send a notification towards SMF that the "GFBR can no longer be guaranteed". Before sending a notification that the "GFBR can no longer be guaranteed" towards the SMF, the NG-RAN shall check whether the GFBR, the PDB and the PER that the NG-RAN currently fulfils match any of the Alternative QoS Profile(s) in the indicated priority order. If there is a match, the NG-RAN shall indicate the reference to the matching Alternative QoS Profile with the highest priority together with the notification to the SMF.
	If there is no match, the NG-RAN shall send a notification that the "GFBR can no longer be guaranteed" towards the SMF indicating that the lowest Alternative QoS Profile cannot be fulfilled (unless specific conditions at the NG-RAN require the release of the NG-RAN resources for this GBR QoS Flow, e.g. due to Radio link failure or RAN internal congestion).
2)	If a notification that the "GFBR can no longer be guaranteed" has been sent to the SMF and the NG-RAN determines that the currently fulfilled GFBR, PDB or PER are different (better or worse) from the situation indicated in the last notification, the NG-RAN shall send a notification (i.e. "GFBR can no longer be guaranteed" or "GFBR can be guaranteed again") to the SMF and indicate the current situation (unless specific conditions at the NG-RAN require the release of the NG-RAN resources for this GBR QoS Flow, e.g. due to Radio link failure or RAN internal congestion).
NOTE 1:	The current situation is either that the QoS Profile can be fulfilled (which is implicitly indicated by the "GFBR can be guaranteed again" notification itself), that a different Alternative QoS Profile can be fulfilled, or that the lowest priority Alternative QoS Profile cannot be fulfilled.
3)-	The NG-RAN should always try to fulfil the QoS profile and, if this is not possible, any Alternative QoS Profile that has higher priority.
NOTE 2:	In order to avoid a too frequent signalling to the SMF, it is assumed that NG-RAN implementation can apply hysteresis (e.g. via a configurable time interval) before notifying the SMF that the currently fulfilled values match the QoS Profile or a different Alternative QoS Profile of higher priority. It is also assumed that the PCF has ensured that the QoS values within the different Alternative QoS Profile(s) are not too close to each other.
4)	Upon receiving a notification from the NG-RAN, the SMF may inform the PCF. If it does so, the SMF shall indicate the currently fulfilled situation to the PCF. See TS 23.503 [45].
5)	If the PCF has not indicated differently, the SMF uses NAS signalling (that is sent transparently through the RAN) to inform the UE about changes in the QoS parameters (i.e. 5QI, GFBR, MFBR) that the NG-RAN is currently fulfilling for the QoS Flow after Notification control has occurred.
During handover, the prioritized list of Alternative QoS Profile(s) (if available) is provided to the Target NG-RAN per QoS Flow in addition to the QoS profile. If the Target NG-RAN is not able to guarantee the GFBR, the PDB and the PER included in the QoS profile and if Alternative QoS Profiles are provided to the Target NG-RAN and the Target NG-RAN supports Alternative QoS Profiles, the Target NG-RAN checks whether the GFBR, the PDB and the PER values that it can fulfil match any of the Alternative QoS Profile(s) taking the priority order into account. If there is a match between one of the Alternative QoS Profiles and the GFBR, the PDB and the PER values that Target NG-RAN can fulfil, the Target NG-RAN shall accept the QoS Flow and indicate the reference to that Alternative QoS Profile to the Source NG-RAN.
For delay-critical GBR QoS flows, the Target NG-RAN also takes into consideration whether it is able to accept the MDBV if it is included in the Alternative QoS profile.
If there is no match to any Alternative QoS Profile, the Target NG-RAN rejects QoS Flows for which the Target NG-RAN is not able to guarantee the GFBR, the PDB, the PER and if available, an associated MDBV included in the QoS profile.
After the handover is completed and a QoS Flow has been accepted by the Target NG-RAN based on an Alternative QoS Profile, the Target NG-RAN shall treat this QoS Flow in the same way as if it had sent a notification that the "GFBR can no longer be guaranteed" with a reference to that Alternative QoS Profile to the SMF (as described in clause 5.7.2.4.1b).
If a QoS Flow has been accepted by the Target NG-RAN based on an Alternative QoS Profile, the reference to the matching Alternative QoS Profile is provided from the Target NG-RAN to the AMF (which forwards the message to the SMF) during the Xn and N2 based handover procedures as described in TS 23.502 [3]. After the handover is completed successfully, the SMF shall send a notification to the PCF that the "GFBR can no longer be guaranteed" for a QoS Flow (see TS 23.503 [45] for details) if the SMF has received a reference to an Alternative QoS Profile and this reference indicates a change in the previously notified state of this QoS Flow. If the PCF has not indicated differently, the SMF shall also use NAS signalling (that is sent transparently through the RAN) to inform the UE about the QoS parameters (i.e. 5QI, GFBR, MFBR) corresponding to the new state of the QoS Flow.
NOTE:	A state change for the QoS Flow comprises a change from QoS profile fulfilled to Alternative QoS Profile fulfilled as well as the state change between fulfilled Alternative QoS Profiles.
If a QoS Flow has been accepted by the Target NG-RAN based on the QoS Profile, the SMF shall interpret the fact that a QoS Flow is listed as transferred QoS Flow in the message received from the AMF as a notification that "GFBR can be guaranteed again" for this QoS Flow. After the handover is successfully completed, the Target NG-RAN performs as described in clause 5.7.2.4.1b. If the SMF has previously notified the PCF that the "GFBR can no longer be guaranteed" and the SMF does not receive an explicit notification that the "GFBR can no longer be guaranteed" for that QoS Flow from the Target NG-RAN within a configured time, the SMF shall notify the PCF that the "GFBR can be guaranteed again".
If a QoS Flow has been accepted by the Target NG-RAN and SMF did not receive from the Target NG-RAN a reference to any Alternative QoS Profile and the SMF has previously informed the UE about QoS parameters corresponding to any of the Alternative QoS Profile(s), the SMF shall use NAS signalling to inform the UE about the QoS parameters corresponding to the QoS Profile.
During QoS Flow establishment and modification, a prioritized list of Alternative QoS Profile(s) can be provided to the NG-RAN for the QoS Flow in addition to the QoS profile. If the NG-RAN is not able to guarantee the GFBR, the PDB and the PER included in the QoS profile and if Alternative QoS Profiles are provided to the NG-RAN and the NG-RAN supports Alternative QoS Profiles, the NG-RAN shall check whether the GFBR, the PDB and the PER values that it can fulfil match at least one of the Alternative QoS Profile(s) taking the priority order into account. If there is a match between one of the Alternative QoS Profiles and the GFBR, the PDB and if available, associated MDBV and the PER values that the NG-RAN can fulfil, the NG-RAN shall accept the QoS Flow and indicate the reference to that Alternative QoS Profile to the SMF. If there is no match to any Alternative QoS Profile, the NG-RAN shall reject the QoS Flow establishment or modification.
After a successful QoS Flow establishment or modification during which the NG-RAN indicated that the currently fulfilled QoS matches one of the Alternative QoS Profiles, the NG-RAN shall treat this QoS Flow in the same way as if it had sent a notification that the "GFBR can no longer be guaranteed" with a reference to that Alternative QoS Profile to the SMF (as described in clause 5.7.2.4.1b).
If the SMF has received a reference to an Alternative QoS Profile during QoS Flow establishment and modification the SMF may inform the PCF about it (as described in TS 23.503 [45]).
If the PCF has not indicated differently, the SMF shall use NAS signalling (that is sent transparently through the RAN) to inform the UE about the QoS parameters (i.e. 5QI, GFBR, MFBR) corresponding to the referenced Alternative QoS Profile.
For GBR QoS Flows only, the following additional QoS parameters exist:
-	Guaranteed Flow Bit Rate (GFBR) - UL and DL;
-	Maximum Flow Bit Rate (MFBR) -- UL and DL.
The GFBR denotes the bit rate that is guaranteed to be provided by the network to the QoS Flow over the Averaging Time Window. The MFBR limits the bit rate to the highest bit rate that is expected by the QoS Flow (e.g. excess traffic may get discarded or delayed by a rate shaping or policing function at the UE, RAN, UPF). Bit rates above the GFBR value and up to the MFBR value, may be provided with relative priority determined by the Priority Level of the QoS Flows (see clause 5.7.3.3).
GFBR and MFBR are signalled to the (R)AN in the QoS Profile and signalled to the UE as QoS Flow level QoS parameter (as specified in TS 24.501 [47]) for each individual QoS Flow.
NOTE 1:	The GFBR is recommended as the lowest acceptable service bitrate where the service will survive.
NOTE 2:	For each QoS Flow of Delay-critical GBR resource type, the SMF can ensure that the GFBR of the QoS Flow can be achieved with the MDBV of the QoS Flow using the QoS Flow binding functionality described in clause 6.1.3.2.4 of TS 23.503 [45].
NOTE 3:	The network can set MFBR larger than GFBR for a particular QoS Flow based on operator policy and the knowledge of the end point capability, i.e. support of rate adaptation at application / service level.
Each PDU Session of a UE is associated with the following aggregate rate limit QoS parameter:
-	per Session Aggregate Maximum Bit Rate (Session-AMBR).
The Session-AMBR is signalled to the appropriate UPF entity/ies to the UE and to the (R)AN (to enable the calculation of the UE-AMBR). The Session-AMBR limits the aggregate bit rate that can be expected to be provided across all Non-GBR QoS Flows for a specific PDU Session. The Session-AMBR is measured over an AMBR averaging window which is a standardized value. The Session-AMBR is not applicable to GBR QoS Flows.
Each UE is associated with the following aggregate rate limit QoS parameter:
-	per UE Aggregate Maximum Bit Rate (UE-AMBR).
The UE-AMBR limits the aggregate bit rate that can be expected to be provided across all Non-GBR QoS Flows of a UE. Each (R)AN shall set its UE-AMBR to the sum of the Session-AMBR of all PDU Sessions with active user plane to this (R)AN up to the value of the UE-AMBR received from AMF. The UE-AMBR is a parameter provided to the (R)AN by the AMF based on the value of the subscribed UE-AMBR retrieved from UDM or the dynamic serving network UE-AMBR retrieved from PCF (e.g. for roaming subscriber). The AMF provides the UE-AMBR provided by PCF to (R)AN if available. The UE-AMBR is measured over an AMBR averaging window which is a standardized value. The UE-AMBR is not applicable to GBR QoS Flows.
Each group of PDU Sessions of the UE for the same slice (S-NSSAI) may be associated with the following aggregate rate limit QoS parameter:
-	per UE per Slice-Maximum Bit Rate (UE-Slice-MBR).
The UE-Slice-MBR limits the aggregate bit rate that can be expected to be provided across all GBR and Non-GBR QoS Flows corresponding to PDU Sessions of the UE for the same slice (S-NSSAI) which have an active user plane. Each supporting NG-RAN shall set its UE-Slice-MBR to the sum of the Session-AMBR and MFBR for GBR QoS Flows of all PDU Sessions corresponding to the slice (S-NSSAI) with active user plane to this NG-RAN up to the value of the UE-Slice-MBR corresponding to the slice (S-NSSAI) received from AMF. The UE-Slice-MBR is measured over an AMBR averaging window which is a standardized value. The UE-Slice-MBR is an optional parameter provided to the NG-RAN by the AMF as described in clause 5.15.13.
NOTE:	The AMBR averaging window is only applied to Session-AMBR, UE-AMBR and UE-Slice-MBR measurement and the AMBR averaging windows for Session-AMBR and UE-AMBR are standardised to the same value.
For each PDU Session Setup, the SMF retrieves the subscribed Session-AMBR values as well as the subscribed default values for the 5QI and the ARP and optionally, the 5QI Priority Level, from the UDM. The subscribed default 5QI value shall be a Non-GBR 5QI from the standardized value range.
NOTE 1:	The 5QI Priority Level can be added to the subscription information to achieve an overwriting of the standardized or preconfigured 5QI Priority Level e.g. in scenarios where dynamic PCC is not deployed or the PCF is unavailable or unreachable.
The SMF may change the subscribed values for the default 5QI and the ARP and if received, the 5QI Priority Level, based on interaction with the PCF as described in TS 23.503 [45] or, if dynamic PCC is not deployed, based on local configuration, to set QoS parameters for the QoS Flow associated with the default QoS rule.
For QoS Flow(s) of the PDU Session other than the QoS Flow associated with the default QoS rule, the SMF shall set the ARP priority level, the ARP pre-emption capability and the ARP pre-emption vulnerability to the respective values in the PCC rule(s) bound to that QoS Flow (as described in TS 23.503 [45]). If dynamic PCC is not deployed, the SMF shall set the ARP priority level, the ARP pre-emption capability and the ARP pre-emption vulnerability based on local configuration.
NOTE 2:	The local configuration in the SMF can e.g. make use of the subscribed value for the ARP priority level and apply locally configured values for the ARP pre-emption capability and ARP pre-emption vulnerability.
If dynamic PCC is not deployed, the SMF can have a DNN based configuration to enable the establishment of a GBR QoS Flow as the QoS Flow that is associated with the default QoS rule. This configuration contains a standardized GBR 5QI as well as GFBR and MFBR for UL and DL.
NOTE 3:	Interworking with EPS is not possible for a PDU Session with a GBR QoS Flow as the QoS Flow that is associated with the default QoS rule.
The SMF may change the subscribed Session-AMBR values (for UL and/or DL), based on interaction with the PCF as described in TS 23.503 [45] or, if dynamic PCC is not deployed, based on local configuration, to set the Session-AMBR values for the PDU Session.
The Maximum Packet Loss Rate (UL, DL) indicates the maximum rate for lost packets of the QoS Flow that can be tolerated in the uplink and downlink direction. This is provided to the QoS Flow if it is compliant to the GFBR
NOTE:	In this Release of the specification, the Maximum Packet Loss Rate (UL, DL) can only be provided for a GBR QoS Flow belonging to voice media.
QoS parameters that are applicable only for or wireline access networks (W-5GAN) are specified in TS 23.316 [84].
This clause specifies the 5G QoS characteristics associated with 5QI. The characteristics describe the packet forwarding treatment that a QoS Flow receives edge-to-edge between the UE and the UPF in terms of the following performance characteristics:
1	Resource type (Non-GBR, GBR, Delay-critical GBR);
2	Priority Level;
3	Packet Delay Budget (including Core Network Packet Delay Budget);
4	Packet Error Rate;
5	Averaging window (for GBR and Delay-critical GBR resource type only);
6	Maximum Data Burst Volume (for Delay-critical GBR resource type only).
The 5G QoS characteristics should be understood as guidelines for setting node specific parameters for each QoS Flow e.g. for 3GPP radio access link layer protocol configurations.
Standardized or pre-configured 5G QoS characteristics, are indicated through the 5QI value, and are not signalled on any interface, unless certain 5G QoS characteristics are modified as specified in clauses 5.7.3.3, 5.7.3.4, 5.7.3.6, and 5.7.3.7.
NOTE:	As there are no default values specified, pre-configured 5G QoS characteristics have to include all of the characteristics listed above.
Signalled 5G QoS characteristics are provided as part of the QoS profile and shall include all of the characteristics listed above.
The resource type determines if dedicated network resources related to a QoS Flow-level Guaranteed Flow Bit Rate (GFBR) value are permanently allocated (e.g. by an admission control function in a radio base station).
GBR QoS Flows are therefore typically authorized "on demand" which requires dynamic policy and charging control. A GBR QoS Flow uses either the GBR resource type or the Delay-critical GBR resource type. The definition of PDB and PER are different for GBR and Delay-critical GBR resource types, and the MDBV parameter applies only to the Delay-critical GBR resource type.
A Non-GBR QoS Flow may be pre-authorized through static policy and charging control. A Non-GBR QoS Flow uses only the Non-GBR resource type.
The Priority Level associated with 5G QoS characteristics indicates a priority in scheduling resources among QoS Flows. The lowest Priority Level value corresponds to the highest priority.
The Priority Level shall be used to differentiate between QoS Flows of the same UE, and it shall also be used to differentiate between QoS Flows from different UEs.
In the case of congestion, when all QoS requirements cannot be fulfilled for one or more QoS Flows, the Priority Level shall be used to select for which QoS Flows the QoS requirements are prioritised such that a QoS Flow with Priority Level value N is priorized over QoS Flows with higher Priority Level values (i.e. N+1, N+2, etc).In the case of no congestion, the Priority Level should be used to define the resource distribution between QoS Flows. In addition, the scheduler may prioritize QoS Flows based on other parameters (e.g. resource type, radio condition) in order to optimize application performance and network capacity.
Every standardized 5QI is associated with a default value for the Priority Level -specified in QoS characteristics Table 5.7.4.1). Priority Level may also be signalled together with a standardized 5QI to the -R)AN, and if it is received, it shall be used instead of the default value.
Priority Level may also be signalled together with a pre-configured 5QI to the (R)AN, and if it is received, it shall be used instead of the pre-configured value.
The Packet Delay Budget (PDB) defines an upper bound for the time that a packet may be delayed between the UE and the N6 termination point at the UPF. The PDB applies to the DL packet received by the UPF over the N6 interface, and to the UL packet sent by the UE. For a certain 5QI the value of the PDB is the same in UL and DL. In the case of 3GPP access, the PDB is used to support the configuration of scheduling and link layer functions (e.g. the setting of scheduling priority weights and HARQ target operating points). For GBR QoS Flows using the Delay-critical resource type, a packet delayed more than PDB is counted as lost if the data burst is not exceeding the MDBV within the period of PDB and the QoS Flow is not exceeding the GFBR. For GBR QoS Flows with GBR resource type not exceeding GFBR, 98 percent of the packets shall not experience a delay exceeding the 5QI's PDB.
The 5G Access Network Packet Delay Budget (5G-AN PDB) is determined by subtracting a static value for the Core Network Packet Delay Budget (CN PDB), which represents the delay between any N6 termination point at the UPF (for any UPF that may possibly be selected for the PDU Session) and the 5G-AN from a given PDB.
NOTE 1:	For a standardized 5QI, the static value for the CN PDB is specified in the QoS characteristics Table 5.7.4-1.
NOTE 2:	For a non-standardized 5QI, the static value for the CN PDB is homogeneously configured in the network.
For GBR QoS Flows using the Delay-critical resource type, in order to obtain a more accurate delay budget PDB available for the NG-RAN, a dynamic value for the CN PDB, which represents the delay between the UPF terminating N6 for the QoS Flow and the 5G-AN, can be used. If used for a QoS Flow, the NG-RAN shall apply the dynamic value for the CN PDB instead of the static value for the CN PDB (which is only related to the 5QI). Different dynamic value for CN PDB may be configured per uplink and downlink direction.
NOTE 3:	The configuration of transport network on CN tunnel can be different per UL and DL, which can be different value for CN PDB per UL and DL.
NOTE 4:	It is expected that the UPF deployment ensures that the dynamic value for the CN PDB is not larger than the static value for the CN PDB. This avoids that the functionality that is based on the 5G-AN PDB (e.g. MDBV, NG-RAN scheduler) has to handle an unexpected value.
The dynamic value for the CN PDB of a Delay-critical GBR 5QI may be configured in the network in two ways:
-	Configured in each NG-RAN node, based on a variety of inputs such as different IP address(es) or TEID range of UPF terminating the N3 tunnel and based on different combinations of PSA UPF to NG-RAN under consideration of any potential I-UPF, etc;
-	Configured in the SMF, based on different combinations of PSA UPF to NG-RAN under consideration of any potential I-UPF. The dynamic value for the CN PDB for a particular QoS Flow shall be signalled to NG-RAN (during PDU Session Establishment, PDU Session Modification, Xn/N2 handover and the Service Request procedures) when the QoS Flow is established or the dynamic value for the CN PDB of a QoS Flow changes, e.g. when an I-UPF is inserted by the SMF.
If the NG-RAN node is configured locally with a dynamic value for the CN PDB for a Delay-critical GBR 5QI, and receives a different value via N2 signalling for a QoS Flow with the same 5QI, local configuration in RAN node determines which value takes precedence.
Services using a GBR QoS Flow and sending at a rate smaller than or equal to the GFBR can in general assume that congestion related packet drops will not occur.
NOTE 5:	Exceptions (e.g. transient link outages) can always occur in a radio access system which may then lead to congestion related packet drops. Packets surviving congestion related packet dropping may still be subject to non-congestion related packet losses (see PER below).
Services using Non-GBR QoS Flows should be prepared to experience congestion-related packet drops and delays. In uncongested scenarios, 98 percent of the packets should not experience a delay exceeding the 5QI's PDB.
The PDB for Non-GBR and GBR resource types denotes a "soft upper bound" in the sense that an "expired" packet, e.g. a link layer SDU that has exceeded the PDB, does not need to be discarded and is not added to the PER. However, for a Delay-critical GBR resource type, packets delayed more than the PDB are added to the PER and can be discarded or delivered depending on local decision.
The Packet Error Rate (PER) defines an upper bound for the rate of PDUs (e.g. IP packets) that have been processed by the sender of a link layer protocol (e.g. RLC in RAN of a 3GPP access) but that are not successfully delivered by the corresponding receiver to the upper layer (e.g. PDCP in RAN of a 3GPP access). Thus, the PER defines an upper bound for a rate of non-congestion related packet losses. The purpose of the PER is to allow for appropriate link layer protocol configurations (e.g. RLC and HARQ in RAN of a 3GPP access). For every 5QI the value of the PER is the same in UL and DL. For GBR QoS Flows with Delay-critical GBR resource type, a packet which is delayed more than PDB is counted as lost, and included in the PER unless the data burst is exceeding the MDBV within the period of PDB or the QoS Flow is exceeding the GFBR.
Each GBR QoS Flow shall be associated with an Averaging window. The Averaging window represents the duration over which the GFBR and MFBR shall be calculated (e.g. in the (R)AN, UPF, UE).
Every standardized 5QI (of GBR and Delay-critical GBR resource type) is associated with a default value for the Averaging window (specified in QoS characteristics Table 5.7.4.1). The averaging window may also be signalled together with a standardized 5QI to the (R)AN and UPF, and if it is received, it shall be used instead of the default value.
The Averaging window may also be signalled together with a pre-configured 5QI to the (R)AN, and if it is received, it shall be used instead of the pre-configured value.
Each GBR QoS Flow with Delay-critical resource type shall be associated with a Maximum Data Burst Volume (MDBV).
MDBV denotes the largest amount of data that the 5G-AN is required to serve within a period of 5G-AN PDB.
Every standardized 5QI (of Delay-critical GBR resource type) is associated with a default value for the MDBV (specified in QoS characteristics Table 5.7.4.1). The MDBV may also be signalled together with a standardized 5QI to the (R)AN, and if it is received, it shall be used instead of the default value.
The MDBV may also be signalled together with a pre-configured 5QI to the (R)AN, and if it is received, it shall be used instead of the pre-configured value.
Standardized 5QI values are specified for services that are assumed to be frequently used and thus benefit from optimized signalling by using standardized QoS characteristics. Dynamically assigned 5QI values (which require a signalling of QoS characteristics as part of the QoS profile) can be used for services for which standardized 5QI values are not defined. The one-to-one mapping of standardized 5QI values to 5G QoS characteristics is specified in table 5.7.4-1.
Table 5.7.4-1: Standardized 5QI to QoS characteristics mapping

NOTE:	It is preferred that a value less than 64 is allocated for any new standardised 5QI of Non-GBR resource type. This is to allow for option 1 to be used as described in clause 5.7.1.3 (as the QFI is limited to less than 64).
Reflective QoS enables the UE to map UL User Plane traffic to QoS Flows without SMF provided QoS rules and it applies for IP PDU Session and Ethernet PDU Session. This is achieved by creating UE derived QoS rules in the UE based on the received DL traffic. It shall be possible to apply Reflective QoS and non-Reflective QoS concurrently within the same PDU Session.
For a UE supporting Reflective QoS functionality, the UE shall create a UE derived QoS rule for the uplink traffic based on the received DL traffic if Reflective QoS function is used by the 5GC for some traffic flows. The UE shall use the UE derived QoS rules to determine mapping of UL traffic to QoS Flows.
If the 3GPP UE supports Reflective QoS functionality, the UE should indicate support of Reflective QoS to the network (i.e. SMF) for every PDU Session. For PDU Sessions established in EPS and PDU Sessions transferred from EPS without N26 interface, the UE indicates Reflective QoS support using the PDU Session Establishment procedure. After the first inter-system change from EPS to 5GS for PDU Sessions established in EPS and transferred from EPS with N26 interface, the UE indicates Reflective QoS support using the PDU Session Modification procedure as described in clause 5.17.2.2.2. The UE as well as the network shall apply the information whether or not the UE indicated support of Reflective QoS throughout the lifetime of the PDU Session.
NOTE:	The logic driving a supporting UE under exceptional circumstances to not indicate support of Reflective QoS for a PDU Session is implementation dependent.
Under exceptional circumstances, which are UE implementation dependent, the UE may decide to revoke previously indicated support for Reflective QoS using the PDU Session Modification procedure. In such a case, the UE shall delete all derived QoS rules for this PDU Session and the network shall stop any user plane enforcement actions related to Reflective QoS for this PDU Session. In addition, the network may provide signalled QoS rules for the SDFs for which Reflective QoS was used before. The UE shall not indicate support for Reflective QoS for this PDU Session for the remaining lifetime of the PDU Session.
If under the same exceptional circumstances mentioned above and while NAS level MM or SM congestion control timer is running, the UE needs to revoke a previously indicated support for Reflective QoS, the UE performs PDU Session Release procedure that is exempt from MM and SM congestion control as defined in clause 5.19.7.
The UE derived QoS rule contains following parameters:
-	One UL Packet Filter (in the Packet Filter Set as defined in clause 5.7.6);
-	QFI;
-	Precedence value (see clause 5.7.1.9).
Upon receiving DL packet, one UL Packet Filter derived from the received DL packet as described in this clause is used to identify a UE derived QoS rule within a PDU Session.
For PDU Session of IP type, the UL Packet Filter is derived based on the received DL packet as follows:
-	When Protocol ID / Next Header is set to TCP or UDP, by using the source and destination IP addresses, source and destination port numbers, and the Protocol ID / Next Header field itself.
-	When Protocol ID / Next Header is set to UDP, if the received DL packet is UDP-encapsulated IPSec protected packet, by using the source and destination IP addresses, source and destination port numbers, the Security Parameter Index, and the Protocol ID / Next Header field itself. In this case, if an uplink IPSec SA corresponding to a downlink IPSec SA of the SPI in the DL packet exists and the SPI of the uplink IPSec SA is known to the NAS layer, then the UL Packet Filter contains an SPI of the uplink IPSec SA.
-	When Protocol ID / Next Header is set to ESP, by using the source and destination IP addresses, the Security Parameter Index, and the Protocol ID / Next Header field itself. If the received DL packet is an IPSec protected packet, and an uplink IPSec SA corresponding to a downlink IPSec SA of the SPI in the DL packet exists and the SPI of the uplink IPSec SA is known to the NAS layer, then the UL Packet Filter contains an SPI of the uplink IPSec SA.
NOTE 1:	In this Release of the specification for PDU Sessions of IP type the use of Reflective QoS is restricted to service data flows for which Protocol ID / Next Header is set to TCP, UDP or ESP.
NOTE 2:	The UE does not verify whether the downlink packets with RQI indication match the restrictions on Reflective QoS.
NOTE 3:	How to determine the received DL packet is UDP-encapsulated IPSec protected packet is defined in RFC 3948 [138]. UDP encapsulation for ESP is used when a NAT is detected, and there can be different Security Parameter Indexes within the same IP-tuples.
For PDU Session of Ethernet type the UL Packet Filter is derived based on the received DL packet by using the source and destination MAC addresses, the Ethertype on received DL packet is used as Ethertype for UL packet. In the case of presence of IEEE Std 802.1Q [98], the VID and PCP in IEEE Std 802.1Q [98] header(s) of the received DL packet is also used as the VID and PCP field for the UL Packet Filter. When double IEEE Std 802.1Q [98] tagging is used, only the outer (S-TAG) is taken into account for the UL Packet Filter derivation.
NOTE 4:	In this Release of the specification for PDU Sessions of Ethernet type the use of Reflective QoS is restricted to service data flows for which 802.1Q [98] tagging is used.
The QFI of the UE derived QoS rule is set to the value received in the DL packet.
When Reflective QoS is activated the precedence value for all UE derived QoS rules is set to a standardised value.
Reflective QoS is controlled on per-packet basis by using the Reflective QoS Indication (RQI) in the encapsulation header on N3 (and N9) reference point together with the QFI and together with a Reflective QoS Timer (RQ Timer) value that is either signalled to the UE upon PDU Session Establishment (or upon PDU Session Modification as described in clause 5.17.2.2.2) or set to a default value. The RQ Timer value provided by the core network is at the granularity of PDU Session (the details are specified in TS 24.501 [47]).
When the 5GC determines that Reflective QoS has to be used for a specific SDF belonging to a QoS Flow, the SMF shall provide the RQA (Reflective QoS Attribute) within the QoS Flow's QoS profile to the NG-RAN on N2 reference point unless it has been done so before. When the RQA has been provided to the NG-RAN for a QoS Flow and the 5GC determines that the QoS Flow carries no more SDF for which Reflective QoS has to be used, the SMF should signal the removal of the RQA (Reflective QoS Attribute) from the QoS Flow's QoS profile to the NG-RAN on N2 reference point.
NOTE 1:	The SMF could have a timer to delay the sending of the removal of the RQA. This would avoid signalling to the RAN in the case of new SDFs subject to Reflective QoS are bound to this QoS Flow in the meantime.
When the 5GC determines to use Reflective QoS for a specific SDF, the SMF shall ensure that the UPF applies the RQI marking (e.g. by setting the indication to use Reflective QoS in the QER associated with the DL PDR if not already set) for this SDF. The SMF shall also ensure that the uplink packets for this SDF can be received by the UPF from the QoS Flow to which the DL PDR of the SDF is associated with as specified in TS 29.244 [65], e.g. by generating a new UL PDR for this SDF for that QoS Flow and providing it to the UPF.
When the UPF is instructed by the SMF to apply RQI marking, the UPF shall set the RQI in the encapsulation header on the N3 (or N9) reference point for every DL packet corresponding to this SDF.
When an RQI is received by (R)AN in a DL packet on N3 reference point, the (R)AN shall indicate to the UE the QFI and the RQI of that DL packet.
Upon reception of a DL packet with RQI:
-	if a UE derived QoS rule with a Packet Filter corresponding to the DL packet does not already exist,
-	the UE shall create a new UE derived QoS rule with a Packet Filter corresponding to the DL packet (as described in clause 5.7.5.2); and
-	the UE shall start, for this UE derived QoS rule, a timer set to the RQ Timer value.
-	otherwise,
-	the UE shall restart the timer associated to this UE derived QoS rule; and
-	if the QFI associated with the downlink packet is different from the QFI associated with the UE derived QoS rule, the UE shall update this UE derived QoS rule with the new QFI.
NOTE 2:	Non-3GPP ANs does not need N2 signalling to enable Reflective QoS. Non 3GPP accesses are expected to send transparently the QFI and RQI to the UE. If the UPF does not include the RQI, no UE derived QoS rule will be generated. If RQI is included to assist the UE to trigger an update of the UE derived QoS rule, the reception of PDU for a QFI restarts the RQ Timer.
Upon timer expiry associated with a UE derived QoS rule the UE deletes the corresponding UE derived QoS rule.
When the 5GC determines not to use Reflective QoS for a specific SDF any longer:
-	The SMF shall ensure that the UPF stops applying RQI marking as specified in TS 29.244 [65] (e.g. by removing the indication to use Reflective QoS from the QER associated with the DL PDR) for this SDF.
-	When the UPF receives this instruction to stop applying RQI marking, the UPF shall no longer set the RQI in the encapsulation header on the N3 (or N9) reference point DL packets corresponding to this SDF.
-	The SMF shall also ensure that, after an operator configurable time, the uplink packets for this SDF will not be accepted by the UPF over the QoS Flow on which Reflective QoS was applied for this SDF as specified in TS 29.244 [65], e.g. by removing the UL PDR for this SDF from that QoS Flow.
NOTE 3:	The operator configurable time has to be at least as long as the RQ Timer value to ensure that no UL packet would be dropped until the UE derived QoS rule is deleted by the UE.
When the 5GC determines to change the binding of the SDF while Reflective QoS is used for this SDF, the SMF shall ensure that the uplink packets for this SDF are accepted over the newly bound QoS Flow and, for an operator configurable time, over the previously bound QoS Flow.
The Packet Filter Set is used in the QoS rule and the PDR to identify one or more packet (IP or Ethernet) flow(s).
NOTE 1:	A QoS Flow is characterised by PDR(s) and QoS rule(s) as described in clause 5.7.1.1.
NOTE 2:	DL Packet Filter in a Packet Filter Set of a QoS rule may be needed by the UE e.g. for the purpose of IMS precondition.
The Packet Filter Set may contain one or more Packet Filter(s). Every Packet Filter is applicable for the DL direction, the UL direction or both directions.
NOTE 3:	The Packet Filter in the Packet Filter Set of the default QoS rule that allows all UL traffic (also known as match-all Packet Filter) is described in TS 24.501 [47].
There are two types of Packet Filter Set, i.e. IP Packet Filter Set, and Ethernet Packet Filter Set, corresponding to those PDU Session Types.
For IP PDU Session Type, the Packet Filter Set shall support Packet Filters based on at least any combination of:
-	Source/destination IP address or IPv6 prefix.
-	Source / destination port number.
-	Protocol ID of the protocol above IP/Next header type.
-	Type of Service (TOS) (IPv4) / Traffic class (IPv6) and Mask.
-	Flow Label (IPv6).
-	Security parameter index.
-	Packet Filter direction.
NOTE 1:	A value left unspecified in a Packet Filter matches any value of the corresponding information in a packet.
NOTE 2:	An IP address or Prefix may be combined with a prefix mask.
NOTE 3:	Port numbers may be specified as port ranges.
For Ethernet PDU Session Type, the Packet Filter Set shall support Packet Filters based on at least any combination of:
-	Source/destination MAC address.
-	Ethertype as defined in IEEE 802.3 [131].
-	Customer-VLAN tag (C-TAG) and/or Service-VLAN tag (S-TAG) VID fields as defined in IEEE Std 802.1Q [98].
-	Customer-VLAN tag (C-TAG) and/or Service-VLAN tag (S-TAG) PCP/DEI fields as defined in IEEE Std 802.1Q [98].
-	IP Packet Filter Set, in the case that Ethertype indicates IPv4/IPv6 payload.
-	Packet Filter direction.
NOTE 1:	The MAC address may be specified as address ranges.
NOTE 2:	A value left unspecified in a Packet Filter matches any value of the corresponding information in a packet.
PDU Set QoS Parameters are used to support PDU Set based QoS handling in the NG-RAN. At least one PDU Set QoS Parameter shall be sent to the NG-RAN to enable PDU Set based QoS handling.
The following PDU Set QoS Parameters are specified:
1.	PDU Set Delay Budget (PSDB).
2.	PDU Set Error Rate (PSER).
3.	PDU Set Integrated Handling Information (PSIHI).
The QoS Profile may include the PDU Set QoS Parameters described in this clause (see clause 5.7.1.2). The PCF determines the PDU Set QoS Parameters based on information provided by AF and/or local configuration. The PDU Set QoS parameters are sent to the SMF as part of PCC rule. The SMF sends them to NG-RAN as part of the QoS Profile.
If the NG-RAN receives PDU Set QoS Parameters and supports them, it enables the PDU Set based QoS handling and applies PDU Set QoS Parameters as described in this clause.
Editor's note:	[XRM] The applicability and details of supporting PDU Set handling in uplink direction may be updated based on RAN WG's progress.
The PDU Set Delay Budget (PSDB) defines an upper bound for the delay that a PDU Set may experience for the transfer between the UE and the N6 termination point at the UPF, i.e. the duration between the reception time of the first PDU (at the N6 termination point for DL or the UE for UL) and the time when all PDUs of a PDU Set have been successfully received (at the UE for DL or N6 termination point for UL). PSDB applies to the DL PDU Set received by the PSA UPF over the N6 interface, and to the UL PDU Set sent by the UE.
NOTE:	To enable support for PSDB, it is required that a maximum inter arrival time between the first received PDU and the last received PDU of a PDU Set complies with SLA. This maximum inter arrival time does not exceed PSDB. NG-RAN behaviour when the SLA is not fulfilled is out of scope of this specification.
A QoS Flow is associated with only one PDU Set Delay Budget. The value of the PDU Set Delay Budget is the same in UL and DL. PSDB is an optional parameter that may be provided by the PCF. The provided PSDB can be used by the NG-RAN to support the configuration of scheduling and link layer functions.
When the PSDB is available, the PSDB supersedes the PDB for the given QoS Flow.
The AN PSDB is derived at NG-RAN by subtracting CN PDB (as described in clause 5.7.3.4) from the PSDB.
The PDU Set Error Rate (PSER) defines an upper bound for the rate of PDU Sets that have been processed by the sender of a link layer protocol (e.g. RLC in RAN of a 3GPP access) but that are not successfully delivered by the corresponding receiver to the upper layer (e.g. PDCP in RAN of a 3GPP access). Thus, the PSER defines an upper bound for a rate of non-congestion related PDU Set losses. The purpose of the PSER is to allow for appropriate link layer protocol configurations (e.g. RLC and HARQ in RAN of a 3GPP access).
NOTE 1:	In this Release, a PDU Set is considered as successfully delivered only when all PDUs of a PDU Set are delivered successfully.
NOTE 2:	How RAN enforces PSER is up to RAN implementation.
A QoS Flow is associated with only one PDU Set Error Rate. PSER is an optional parameter. If the PSER is available, the PSER supersedes the PER. The value of the PDU Set Error Rate is the same in UL and DL.
The PDU Set Integrated Handling Information (PSIHI) indicates whether all PDUs of the PDU Set are needed for the usage of the PDU Set by the application layer in the receiver side. PSIHI is an optional parameter.
User Plane Function(s) handle the user plane path of PDU Sessions. 3GPP specifications support deployments with a single UPF or multiple UPFs for a given PDU Session. UPF selection is performed by SMF. The details of UPF selection is described in clause 6.3.3. The number of UPFs supported for a PDU Session is unrestricted.
For an IPv4 type PDU Session or an IPv6 type PDU Session without multi-homing or an IPv4v6 type PDU Session, when multiple PDU Session Anchors are used (due to UL CL being inserted), only one IPv4 address and/or IPv6 prefix is allocated for the PDU Session. For an IPv6 multi-homed PDU Session there are multiple IPv6 prefixes allocated for the PDU Session as described in clause 5.6.4.3.
If the SMF had requested the UPF to proxy ARP or IPv6 Neighbour Solicitation for an Ethernet DNN, the UPF should respond to the ARP or IPv6 Neighbour Solicitation Request, itself.
Deployments with one single UPF used to serve a PDU Session do not apply to the Home Routed case and may not apply to the cases described in clause 5.6.4.
Deployments where a UPF is controlled either by a single SMF or multiple SMFs (for different PDU Sessions) are supported.
UPF traffic detection capabilities may be used by the SMF in order to control at least following features of the UPF:
-	Traffic detection (e.g. classifying traffic of IP type, Ethernet type, or unstructured type)
-	Traffic reporting (e.g. allowing SMF support for charging).
-	QoS enforcement (The corresponding requirements are defined in clause 5.7).
-	Traffic routing (e.g. as defined in clause 5.6.4. for UL CL or IPv6 multi-homing).
This clause contains detailed functional descriptions for some of the functions provided by the UPF. It is described how the SMF instructs it's corresponding UP function and which control parameters are used.
The UE IP address management includes allocation and release of the UE IP address as well as renewal of the allocated IP address, where applicable.
The UE shall perform the association of the application to a new PDU Session described in clause 6.1.2.2.1 of TS 23.503 [45], with the following considerations:
-	If there is a matching URSP rule, except the URSP rule with the "match all" Traffic descriptor, or a matching UE Local Configuration containing a PDU Session Type of "IPv4", "IPv6" or "IPv4v6", then the UE shall set the requested PDU Session Type to the PDU Session Type contained in the matching URSP rule or in the matching UE Local Configuration, if this PDU Session Type is supported by the UE's IP stack capabilities Detailed operation is described in TS 24.526 [110].
-	Otherwise, if a URSP Rule with the "match all" Traffic descriptor exists, the UE shall set the requested PDU Session Type to the PDU Session Type contained in the "match all" URSP Rule, if this PDU Session Type is supported by the UE's IP stack capabilities. Detailed operation is described in TS 24.526 [110].
-	Otherwise, the UE shall set the requested PDU Session Type during the PDU Session Establishment procedure based on its IP stack capabilities as follows:
-	A UE which supports IPv6 and IPv4 shall set the requested PDU Session Type "IPv4v6".
-	A UE which supports only IPv4 shall request for PDU Session Type "IPv4".
-	A UE which supports only IPv6 shall request for PDU Session Type "IPv6".
-	When the IP version capability of the UE is unknown in the UE (as in the case when the MT and TE are separated and the capability of the TE is not known in the MT), the UE shall request for PDU Session Type "IPv4v6".
The SMF selects PDU Session Type of the PDU Session as follows:
-	If the SMF receives a request with PDU Session Type set to "IPv4v6", the SMF selects either PDU Session Type "IPv4" or "IPv6" or "IPv4v6" based on DNN configuration, subscription data and operator policies.
-	If the SMF receives a request for PDU Session Type "IPv4" or "IPv6" and the requested IP version is supported by the DNN the SMF selects the requested PDU Session type.
In its answer to the UE, the SMF may indicate the PDU Session Types not allowed for the combination of (DNN, S-NNSAI). In this case, the UE shall not request another PDU Session to the same (DNN, S-NNSAI) for PDU Session Types indicated as not allowed by the network. In the case that the initial PDU Session was established with a PDU Session Type and the UE needs another single IP version PDU Session Type, the UE may initiate another PDU Session Establishment procedure to this (DNN, S-NNSAI) in order to activate a second PDU session with that PDU Session Type.
An SMF shall ensure that the IP address management procedure is based on the selected PDU Session Type. If IPv4 PDU Session Type is selected, an IPv4 address is allocated to the UE. Similarly, if IPv6 PDU Session type is selected, an IPv6 prefix is allocated. If IPv4v6 PDU Session Type is selected, both an IPv4 address and an IPv6 prefix are allocated. For Roaming case, the SMF in this clause refers to the SMF controlling the UPF(s) acting as PDU Session Anchor. i.e. H-SMF in home routed case and V-SMF in local breakout case. For home routed case, V-SMF forwards the PDU Session Type requested by UE to H-SMF without interpreting it. V-SMF sends back to UE the PDU Session Type selected by H-SMF. The SMF shall process the UE IP address management related messages, maintain the corresponding state information and provide the response messages to the UE.
The 5GC and UE support the following mechanisms:
a.	During PDU Session Establishment procedure, the SMF sends the IP address to the UE via SM NAS signalling. The IPv4 address allocation and/or IPv4 parameter configuration via DHCPv4 (according to RFC 2131 [9]) can also be used once PDU Session is established.
b.	/64 IPv6 prefix allocation shall be supported via IPv6 Stateless Auto-configuration according to RFC 4862 [10], if IPv6 is supported. The details of Stateless IPv6 Address Autoconfiguration are described in clause 5.8.2.2.3. IPv6 parameter configuration via Stateless DHCPv6 (according to RFC 3736 [14]) may also be supported. IPv6 Prefix Delegation using DHCPv6 may be supported for allocating additional IPv6 prefixes for a PDU Session. The details of Prefix Delegation are described in clause 5.8.2.2.4.
For scenarios with RG connecting to 5GC, additional features for IPv6 address allocation and IPv6 prefix delegation are supported, as described in TS 23.316 [84].
To allocate the IP address via DHCPv4, the UE may indicate to the network within the Protocol Configuration Options that the UE requests to obtain the IPv4 address with DHCPv4, or obtain the IP address during the PDU Session Establishment procedure. This implies the following behaviour both for static and dynamic address allocation:
-	The UE may indicate that it requests to obtain an IPv4 address as part of the PDU Session Establishment procedure. In such a case, the UE relies on the 5GC network to provide IPv4 address to the UE as part of the PDU Session Establishment procedure.
-	The UE may indicate that it requests to obtain the IPv4 address after the PDU Session Establishment procedure by DHCPv4. That is, when the 5GC network supports DHCPv4 and allows that, it does not provide the IPv4 address for the UE as part of the PDU Session Establishment procedure. The network may respond to the UE by setting the allocated IPv4 Address to 0.0.0.0. After the PDU Session Establishment procedure is completed, the UE uses the connectivity with the 5GC and initiates the IPv4 address allocation on its own using DHCPv4. However, if the 5GC network provides IPv4 address to the UE as part of the PDU Session Establishment procedure, the UE should accept the IPv4 address indicated in the PDU Session Establishment procedure.
-	If the UE sends no IP Address Allocation request, the SMF determines whether DHCPv4 is used between the UE and the SMF or not, based on per DNN configuration.
If dynamic policy provisioning is deployed, and the PCF was not informed of the IPv4 address at PDU Session Establishment procedure, the SMF shall inform the PCF about an allocated IPv4 address. If the IPv4 address is released, the SMF shall inform the PCF about the de-allocation of an IPv4 address.
In order to support DHCP based IP address configuration, the SMF shall act as the DHCP server towards the UE. The PDU Session Anchor UPF does not have any related DHCP functionality. The SMF instructs the PDU Session Anchor UPF serving the PDU Session to forward DHCP packets between the UE and the SMF over the user plane.
When DHCP is used for external data network assigned addressing and parameter configuration, the SMF shall act as the DHCP client towards the external DHCP server. The UPF does not have any related DHCP functionality. In the case of DHCP server on the external data network, the SMF instructs a UPF with N6 connectivity to forward DHCP packets between the UE and the SMF and the external DHCP server over the user plane.
The 5GC may also support the allocation of a static IPv4 address and/or a static IPv6 prefix based on subscription information in the UDM or based on the configuration on a per-subscriber, per-DNN basis and per-S-NSSAI.
If the static IP address/prefix is stored in the UDM, during PDU Session Establishment procedure, the SMF retrieves this static IP address/prefix from the UDM. If the static IP address/prefix is not stored in the UDM subscription record, it may be configured on a per-subscriber, per-DNN and per-S-NSSAI basis in the DHCP/DN-AAA server and the SMF retrieves the IP address/prefix for the UE from the DHCP/DN-AAA server. This IP address/prefix is delivered to the UE in the same way as a dynamic IP address/prefix. It is transparent to the UE whether the PLMN or the external data network allocates the IP address and whether the IP address is static or dynamic.
For IPv4 or IPv6 or IPv4v6 PDU Session Type, during PDU Session Establishment procedure, the SMF may receive a Subscriber's IP Index from the UDM. If the UE IP address/prefix was not already allocated and provided to PCF when SMF initiates the SM policy association, the SMF may receive a Subscribers IP Index from the PCF. If the SMF received a Subscriber's IP index from both UDM and PCF, the SMF shall apply the Subscriber's IP Index received from the PCF. The SMF may use the Subscriber's IP Index to assist in selecting how the IP address is to be allocated when multiple allocation methods, or multiple instances of the same method are supported. In the case of Home Routed roaming, the H-SMF may receive the IP index from the H-PCF.
NOTE:	The IP Index can e.g. be used to select between different IP pools, including between IP pools with overlapping private address range. To support deployments with overlapping private IPv4 address, the IP domain corresponding to IP index can also be provided from UDM to SMF as part of the subscription data and then provided to PCF.
When Static IP addresses for a PDU session are not used, the actual allocation of the IP Address(es) for a PDU Session may use any of the following mechanisms:
-	The SMF allocates the IP address from a pool that corresponds to the PDU Session Anchor (UPF) that has been selected
-	The UE IP address is obtained from the UPF. In that case the SMF shall interact with the UPF via N4 procedures to obtain a suitable IP address. The SMF provides the UPF with the necessary information allowing the UPF to derive the proper IP address (e.g. the network instance).
-	In the case that the UE IP address is obtained from the external data network, additionally, the SMF shall also send the allocation, renewal and release related request messages to the external data network, i.e. DHCP/DN-AAA server, and maintain the corresponding state information. The IP address allocation request sent to DHCP/DN-AAA server may include the IP address pool ID to identify which range of IP address is to be allocated. In this case the SMF is provisioned with separate IP address pool ID(s), and the mapping between IP address pool ID and UPF Id, DNN, S-NSSAI, IP version. The provision is done by OAM or during the N4 Association Setup procedure.
A given IP address pool is controlled by a unique entity (either the SMF or the UPF or an external server). The IP address managed by the UPF can be partitioned into multiple IP address pool partition(s), i.e. associated with multiple IP address pool ID(s).
When the SMF is configured to obtain UE IP addresses from the UPF, the SMF may select a UPF based upon support of this feature. The SMF determines whether the UPF supports this feature via NRF or via N4 capability negotiation during N4 Association Setup. If no appropriate UPF support the feature, the SMF may allocate UE IP addresses, if configured to do so.
The IP address/prefix is released by the SMF (e.g. upon release of the PDU Session), likewise the UPF considers that any IP address it has allocated within a N4 session are released when this N4 session is released.
UPF may use NAT between the UE and the Data Network, and thus the 5GC allocated (private) UE IP address may not be visible on the N6 reference point.
When the UE has an IPv6 multi-homed PDU Session the UE selects the source IPv6 prefix according to IPv6 multi-homed routing rules pre-configured in the UE or received from network. IPv6 multi-homed routing rules received from the network have a higher priority than IPv6 multi-homed routing rules pre-configured in the UE
The SMF can generate the IPv6 multi-homed routing rules for a UE based on local configuration or dynamic PCC rules received from the PCF as defined in TS 23.503 [45]. If dynamic PCC is deployed, the SMF generates the IPv6 multi-home routing rules for a source IPv6 prefix based on the SDF Templates of those PCC rules which contain the DNAI corresponding to the newly assigned IPv6 prefix. The SMF can send IPv6 multi-homed routing rules to the UE to influence the source IPv6 prefix selection in IPv6 Router Advertisement (RA) messages according to RFC 4191 [8] at any time during the lifetime of the IPv6 multi-homed PDU Session. Such messages are sent via the UPF.
NOTE:	For multiple IPv4 PDU Session and multiple IPv6 PDU Session cases, routing rule based PDU Session selection is not specified in this Release of the specification.
If Stateless IPv6 Address Autoconfiguration is used for IPv6 address allocation to the UE, after PDU Session Establishment the UE may send a Router Solicitation message to the SMF to solicit a Router Advertisement message. The SMF sends a Router Advertisement message (solicited or unsolicited) to the UE. The Router Advertisement messages shall contain the IPv6 prefix.
After the UE has received the Router Advertisement message, it constructs a full IPv6 address via IPv6 Stateless Address Autoconfiguration in accordance with RFC 4862 [10]. To ensure that the link-local address generated by the UE does not collide with the link-local address of the UPF and the SMF, the SMF shall provide an interface identifier (see RFC 4862 [10]) to the UE and the UE shall use this interface identifier to configure its link-local address. For Stateless Address Autoconfiguration however, the UE can choose any interface identifier to generate IPv6 addresses, other than link-local, without involving the network. However, the UE shall not use any identifiers defined in TS 23.003 [19] as the basis for generating the interface identifier. For privacy, the UE may change the interface identifier used to generate full IPv6 address, as defined in TS 23.221 [23] without involving the network. Any prefix that the SMF advertises to the UE is globally unique. The SMF shall also record the relationship between the UE's identity (SUPI) and the allocated IPv6 prefix. Because any prefix that the SMF advertises to the UE is globally unique, there is no need for the UE to perform Duplicate Address Detection for any IPv6 address configured from the allocated IPv6 prefix. Even if the UE does not need to use Neighbor Solicitation messages for Duplicate Address Detection, the UE may, for example, use them to perform Neighbor Unreachability Detection towards the SMF, as defined in RFC 4861 [54]. Therefore, the SMF shall respond with a Neighbor Advertisement upon receiving a Neighbor Solicitation message from the UE.
In IPv6 multi-homing PDU session, SMF shall not allocate an interface identifier when a new IPv6 prefix allocated corresponding to the new PDU Session Anchor.
The above IPv6 related messages (e.g. Router Solicitation, Router Advertisement, Neighbor Solicitation, Neighbor Advertisement) are transferred between the SMF and UE via the UPF(s). If the Control Plane CIoT 5GS Optimisation is enabled for a PDU session, the above IPv6 related messages are transferred between the SMF and UE via the AMF after PDU Session Establishment, see clauses 4.3.2.2.1 and 4.3.2.2.2 of TS 23.502 [3], using the Mobile Terminated Data Transport in Control Plane CIoT 5GS Optimisation procedures.
Optionally, a single network prefix shorter than the default /64 prefix may be assigned to a PDU Session. In this case, the /64 default prefix used for IPv6 stateless autoconfiguration will be allocated from this network prefix; the remaining address space from the network prefix can be delegated to the PDU Session using prefix delegation after the PDU Session establishment and IPv6 prefix allocation via IPv6 stateless address autoconfiguration as defined in clause 5.8.2.2.3.
Depending on configuration, the SMF may obtain the prefix from a locally provisioned pool, from the PSA UPF or from the external DN.
The address space provided is maintained as an IPv6 address space pool available to the PDU Session for DHCPv6 IPv6 prefix requests with the exclusion of the IPv6 prefix that is allocated to the PDU Session during PDU Session establishment as defined in clause 5.8.2.2.3. The total IPv6 address space available for the PDU Session (UE PDU Session prefix and UE PDU Session IPv6 address space pool) shall be possible to aggregate into one IPv6 prefix that will represent all IPv6 addresses that the UE may use.
If the UE had indicated that it supports prefix exclusion and the prefix to be delegated to the UE includes the /64 prefix that was allocated to the PDU Session, the SMF shall utilise the prefix exclusion feature as specified for DHCPv6 Prefix Delegation in IETF RFC 6603 [162].
NOTE:	Support of the IPv6 prefix delegation in the SMF is assumed to be ensured by the operator e.g. by configuring specific DNN/S-NSSAI for PDU Sessions that are used by UEs that utilize IPv6 prefix delegation.
The UE uses DHCPv6 to request additional IPv6 prefixes (i.e. prefixes in addition to the default prefix) from the SMF after completing stateless IPv6 address autoconfiguration procedures. The UE acts as a "Requesting Router" as described in IETF RFC 8415 [163] and inserts one or more IA_PD option(s) into a DHCPv6 Solicit message sent from the UE to the SMF via the user plane and the UPF. The SMF acts as the DHCP server and fulfils the role of a "Delegating Router" according to IETF RFC 8415 [163]. The UE optionally includes the RAPID_COMMIT option in the DHCPv6 Solicit message to trigger two-message DHCPv6 procedure instead of the four-message DHCPv6 procedure. The UE shall include OPTION_PD_EXCLUDE option code in an OPTION_ORO option to indicate support for prefix exclusion. In response to the DHCPv6 Solicit message, the UE receives a DHCPv6 Reply message with one or more IA_PD prefix(es) for every IA_PD option that it sent in the DHCPv6 Solicit message. The SMF delegates a prefix excluding the default prefix with help of OPTION_PD_EXCLUDE. Prefix exclusion procedures shall follow IETF RFC 6603 [162].
For scenarios with RG connecting to 5GC, additional feature for IPv6 Prefix Delegation via DHCPv6 is defined in TS 23.316 [84].
CN Tunnel Info is the Core Network address of a N3/N9 tunnel corresponding to the PDU Session. It comprises the TEID and the IP address which is used by the UPF on the N3/N9 tunnel for the PDU Session.
The CN Tunnel Info allocation and release is performed by the UPF. The SMF shall indicate to the UPF when the UPF is required to allocate/release CN Tunnel Info.

The UPF shall manage the CN Tunnel Info space. When a new CN Tunnel Info is needed, the SMF shall request over N4 the UPF to allocate CN Tunnel Info for the applicable N3/N9 reference point. In response, the UPF provides CN Tunnel Info to the SMF. In the case of PDU Session Release or a UPF is removed from the user plane path of an existing PDU Session, the SMF shall request UPF to release CN Tunnel Info for the PDU Session. If the corresponding N4 Session is released the UPF releases the associated CN Tunnel Info.
This clause describes the detection process at the UPF that identifies the packets belonging to a session, or a service data flow.
The SMF is responsible for instructing the UP function about how to detect user data traffic belonging to a Packet Detection Rule (PDR). The other parameters provided within a PDR describe how the UP function shall treat a packet that matches the detection information.
The SMF controls the traffic detection at the UP function by providing detection information for every PDR.
For IPv4 or IPv6 or IPv4v6 PDU Session type, detection information is a combination of:
-	CN tunnel info.
-	Network instance.
-	QFI.
-	IP Packet Filter Set as defined in clause 5.7.6.2.
-	Application Identifier: The Application Identifier is an index to a set of application detection rules configured in UPF.
-	FQDN Filter for DNS Query message.
For Ethernet PDU Session type, detection information is a combination of:
-	CN tunnel info.
-	Network instance.
-	QFI.
-	Ethernet Packet Filter Set as defined in clause 5.7.6.3.
In this Release of the specification for Unstructured PDU Session Type, the UPF does not perform-QoS Flow level traffic detection for QoS enforcement.
Traffic detection information sent by the SMF to the UPF for a PDU Session may be associated with Network instance for detection and routing of traffic over N6. In the case of IP PDU Session Type, Network Instances can, e.g. be used by the UPF for traffic detection and routing in the case of different IP domains or overlapping IP addresses. In the case of Ethernet PDU Session Type, different Network Instances can e.g. be configured in the UPF with different ways to handle the association between N6 and the PDU Sessions.
Based on SMF instructions, UPF may identify the PDU Sets, according to the Protocol Description in PDR, to derive the PDU Set Information for DL traffics and send it to RAN via DL GTP-U header of each PDU identified as belonging to a PDU Set. The PDU Set Information, is described in clause 5.37.5. The PDU Set identification can be done by UPF implementation or by detecting RTP/SRTP header or payload. The details of the RTP/SRTP headers, header extensions and/or payloads used to identify PDU Sets are defined in TS 26.522 [179].
The SMF controls user-plane packet forwarding for traffic detected by a PDR by providing a FAR with instructions to the UPF, including:
-	Forwarding operation information;
-	Forwarding target information.
The details of the forwarding target and operation will depend on the scenario and is described below. The following forwarding functionality is required by the UPF:
-	Apply N3 /N9 tunnel related handling, i.e. encapsulation.
-	Forward the traffic to/from the SMF, e.g. as described in Table 5.8.2.5.2-1.
-	Forward the SM PDU DN Request Container from SMF to DN-AAA server
-	Forward the traffic according to locally configured policy for traffic steering.
-	Forward the traffic according to N4 rules of a 5G VN group for 5G VN group communication.
-	Forward the traffic to/from the EASDF.
Data forwarding between the SMF and UPF is transmitted on the user plane tunnel established on N4 interface, defined in TS 29.244 [65].
Scenarios for data forwarding between the SMF and UPF are defined as below:
Table 5.8.2.5.2-1: Scenarios for data forwarding between the SMF and UPF

When configuring an UPF acting as PSA for an Ethernet PDU Session Type, the SMF may instruct the UPF to route the traffic based on detected MAC addresses as follows.
-	The UPF learns the MAC address(es) connected via N6 based on the source MAC addresses of the DL traffic received on a N6 Network Instance.
-	The UPF learns the MAC address(es) of UE(s) and devices connected behind, if any, based on the source MAC address contained within the UL traffic received on a PDU Session (N3/N9 interface).
-	The UPF forwards DL unicast traffic (with a known destination address) on a PDU Session determined based on the source MAC address(es) used by the UE for the UL traffic.
-	The UPF forwards UL unicast traffic (with a known destination address) on a port (PDU Session or N6 interface) determined based on the source MAC address(es) learned beforehand.
-	In the case of multicast and broadcast traffic (if the destination MAC address is a broadcast or multicast address):
-	for DL traffic received by UPF on a N6 Network Instance the UPF should forward the traffic to every DL PDU Session (corresponding to any N4 Session) associated with this Network Instance
-	for uplink traffic received by UPF over a PDU session on a N3/N9 interface, the UPF should forward the traffic to the N6 interface and downlink to every PDU session (except toward the one of the incoming traffic) associated with the same N6 Network Instance
-	for uplink and downlink unicast traffic received by UPF, if the destination MAC has not been learnt, the UPF should forward the traffic to every PDU session associated with the same N6 Network Instance and towards the N6 interface. In any case the traffic is not replicated on the PDU Session or the N6 interface of the incoming traffic.
NOTE 1:	The UPF can consider a PDU Session or a N6 interface to be active or inactive in order to avoid forwarding loops. User data traffic is not sent on inactive PDU sessions or inactive N6 interface. This release of the specification does not further specify how the UPF determines whether a PDU Session or N6 interface is considered active or inactive.
NOTE 2:	This release of the specification supports only a single N6 interface in a UPF associated with the N6 Network Instance.
-	if the traffic is received with a VLAN ID, the above criteria apply only towards the N6 interface or PDU session matching the same VLAN ID, unless the UPF is instructed to remove the VLAN ID in the incoming traffic.
NOTE 3:	This release of the specification supports Independent VLAN Learning (IVL) and does not support Shared VLAN Learning (SVL), as described in IEEE Std 802.1Q [98].
-	if the destination MAC address of traffic refers to the same N6 interface or PDU session on which the traffic has been received, the frame shall be dropped.
In order to handle scenarios where a device behind a UE is moved from a source UE to a target UE, a MAC address is considered as no longer associated with a UPF interface (source UE's PDU session) when the MAC address has not been detected as Source MAC address in UL traffic for a pre-defined period of time or the MAC address has been detected under a different interface (target UE's PDU Session or N6).
NOTE 4:	The UPF/NW-TT may also be provided with static filtering entries as described in clause 5.28.3. How the UPF uses the static filtering entry to achieve forwarding of Ethernet frames to one or more egress ports is up to UPF implementation. The externally observable behaviour of 5GS Bridge needs to comply with IEEE Std 802.1Q [98].
For ARP/IPv6 Neighbour Solicitation traffic, a SMF's request to respond to ARP/IPv6 Neighbour Solicitation based on local cache information or to redirect such traffic from the UPF to the SMF overrules the traffic forwarding rules described above.
NOTE 5:	Local policies in UPF associated with the Network Instance can prevent local traffic switching in the UPF between PDU Sessions either for unicast traffic only or for any traffic. In the case where UPF policies prevent local traffic switching for any traffic (thus for broadcast/multicast traffic) some mechanism such as responding to ARP/ND based on local cache information or local multicast group handling is needed to ensure that upper layer protocol can run on the Ethernet PDU sessions.
The SMF may ask to get notified with the source MAC addresses used by the UE, e.g. if the PCF has subscribed to UE MAC address change notifications, as described in TS 23.503 [45].
In order to request the UPF to act as defined above, the SMF may, for each PDU Session corresponding to a Network Instance, set an Ethernet PDU Session Information in a DL PDR that identifies all (DL) Ethernet packets matching the PDU session. Alternatively, for unicast traffic the SMF may provide UPF with dedicated forwarding rules related with MAC addresses notified by the UPF.
The SMF shall support interfaces towards CHF and PCF. The SMF interacts with CHF and PCF based on information received from other control plane NFs and user plane related information received from the UPF.
QoS Flow level, PDU Session level and subscriber related information remain at the SMF, and only usage information is requested from the UPF.
Triggered by the PCC rules received from the PCF or preconfigured information available at SMF, as well as from the CHF for online charging method via quota management mechanisms, the SMF shall provide Usage Reporting Rules to the UPF for controlling how usage reporting is performed.
The SMF shall request the report of the relevant usage information for Usage Monitoring, based on Monitoring Keys and triggers which are specified in TS 23.503 [45]. Each Usage Reporting Rule requested for usage monitoring control is associated with the PDR(s) whose traffic is to be accounted under this rule. The SMF shall generate the Usage Reporting Rule for each Monitoring-key within the active PCC Rule(s), either preconfigured or received from the PCF and also shall keep the mapping between them. Multiple Usage Reporting Rules may be associated with the same PDR.
The SMF shall request the report of the relevant usage information for offline and online charging, based on Charging keys and additional triggers which are specified in TS 32.255 [68]. Each Usage Reporting Rule requested for offline or online charging is associated with the PDR(s) whose traffic is to be accounted under this rule. The SMF shall generate the Usage Reporting Rule for each Charging key and Sponsor Identity (if applicable) within the active PCC Rule(s), either preconfigured or received from the PCF, and also shall keep the mapping between them. Multiple Usage Reporting Rules may be associated with the same PDR.
The SMF function shall also provide reporting trigger events to the UPF for when to report usage information. The reporting trigger events (e.g. triggers, threshold information etc.) shall be supported for the PDU Session level reporting as well as on Rule level basis as determined by the SMF. The triggers may be provided as a volume, time or event to cater for the different charging/usage monitoring models supported by the TS 23.503 [45] for usage monitoring and by TS 32.255 [68] for converged offline and online charging. The SMF shall decide on the thresholds value(s) based on allowance received from PCF, CHF or based on local configuration. Other parameters for instructing the UPF to report usage information are defined in TS 29.244 [65].
When the PCC Rule attribute Service Data flow handling while requesting credit (specified in TS 23.503 [45]) indicates "non-blocking", the SMF shall request the report of the relevant usage information for the Charging key and Sponsor Identity (if applicable) and provide a default threshold value to the UPF while waiting for the quota from the CHF.
In some cases, the same Usage Reporting Rule can be used for different purposes (for both usage monitoring and charging), e.g. in the case that the same set of PDR(s), measurement method, trigger event, threshold, etc. apply. Similarly a reported measurement can be used for different purposes by the SMF.
The UPF shall support reporting of usage information to the SMF. The UPF shall be capable to support reporting based on different triggers, including:
-	Periodic reporting with period defined by the SMF.
-	Usage thresholds provided by the SMF.
-	Report on demand received from the SMF.
The SMF shall make sure that the multiple granularity levels required by the reporting keys in the Usage Reporting rules satisfy the following aggregation levels without requiring a knowledge of the granularity levels by the UPF:
-	PDU Session level reporting;
-	Traffic flow (for both charging and usage monitoring) level reporting as defined by the reporting keys in the Usage Reporting Rule (see the description above).
Based on the mapping between Monitoring key and PCC rule stored at the SMF, the SMF shall combine the reported information with session and subscriber related information which is available at the SMF, for Usage Monitoring reporting over the corresponding Npcf interface (N7 reference point).
Based on the mapping between Charging key and Sponsor Identity (if applicable) and PCC rule stored at the SMF, the SMF shall combine the reported information with session and subscriber related information which is available at the SMF, for offline and online charging reporting over the corresponding charging interfaces.
This functionality is specified in TS 32.255 [68].
The usage information shall be collected in the UPF and reported to the SMF as defined in 5.8.2.6, based on Monitoring Keys and triggers which are specified in TS 23.503 [45].
ARP is used for admission control (i.e. retention and pre-emption of the new QoS Flow). The value of ARP is not required to be provided to the UPF.
For every QoS Flow, the SMF shall determine the transport level packet marking value (e.g. the DSCP in the outer IP header) based on the 5QI, the Priority Level (if explicitly signalled) and optionally, the ARP priority level and provide the transport level packet marking value to the UPF.
The SMF shall provide the Session-AMBR values of the PDU Session to the UPF so that the UPF can enforce the Session-AMBR of the PDU Session across all Non-GBR QoS Flows of the PDU Session.
SMF shall provide the GFBR and MFBR value for each GBR QoS Flow of the PDU Session to the UPF. SMF may also provide the Averaging window to the UPF, if Averaging window is not configured at the UPF or if it is different from the default value configured at the UPF.
SMF may decide to activate ECN marking for L4S by PSA UPF for the QoS Flow (see clause 5.37). In this case, the SMF shall send an ECN marking for L4S indicator to UPF.
A predefined PCC rule is configured in the SMF.
The traffic detection filters, e.g. IP Packet Filter, required in the UP function can be configured either in the SMF and provided to the UPF, as service data flow filter(s), or be configured in the UPF, as the application detection filter identified by an application identifier. For the latter case, the application identifier has to be configured in the SMF and the UPF.
The traffic steering policy information can be only configured in the UPF, together with traffic steering policy identifier(s), while the SMF has to be configured with the traffic steering policy identifier(s).
Policies for traffic handling in the UPF, which are referred by some identifiers corresponding to the parameters of a PCC rule, can be configured in the UPF. These traffic handling policies are configured as predefined QER(s), FAR(s) and URR(s).
When a predefined PCC rule is activated/deactivated by the PCF, SMF shall decide what information has to be provided to the UPF to enforce the rule based on where the traffic detection filters (i.e. service data flow filter(s) or application detection filter), traffic steering policy information and the policies used for the traffic handling in the UPF are configured and where they are enforced:
-	If the predefined PCC rule contains an application identifier for which corresponding application detection filters are configured in the UPF, the SMF shall provide a corresponding application identifier to the UPF;
-	If the predefined PCC rule contains traffic steering policy identifier(s), the SMF shall provide a corresponding traffic steering policy identifier(s) to the UPF;
-	If the predefined PCC rule contains service data flow filter(s), the SMF shall provide them to the UPF;
-	If the predefined PCC rule contains some parameters for which corresponding policies for traffic handling in the UPF are configured in the UPF, the SMF shall activate those traffic handling policies via their rule ID(s).
The SMF shall maintain the mapping between a PCC rule received over Npcf and the flow level PDR rule(s) used on N4 interface.
The application detection filters required in the UPF can be configured either in the SMF and provided to the UPF as the service data flow filter, or be configured in the UP function identified by an application identifier.
When receiving a dynamic PCC rule from the PCF which contains an application identifier and/or parameters for traffic handling in the UPF:
-	if the application detection filter is configured in the SMF, the SMF shall provide it in the service data flow filter to the UPF, as well as parameters for traffic handling in the UPF received from the dynamic PCC rule;
-	otherwise, the application detection filters is configured in UPF, the SMF shall provide to UPF with the application identifier and the parameters for traffic handling in the UPF as required based on the dynamic PCC rule.
The SMF shall maintain the mapping between a PCC rule received over Npcf and the flow level PDR(s) used on N4 interface.
The uplink application's traffic redirection may be enforced either in the SMF (as specified in 5.8.2.5 Control of user plane forwarding) or directly in the UPF. The redirect destination may be provided in the dynamic PCC rule or be preconfigured, either in the SMF or in the UPF.
When receiving redirect information (redirection enabled/disabled and redirect destination) within a dynamic PCC rule or being activated/deactivated by the PCF for the predefined redirection policies, SMF shall decide whether to provide and what information to be provided to the UPF based on where the redirection is enforced and where the redirect destination is acquired/preconfigured. When redirection is enforced in the UPF and the redirect destination is acquired from the dynamic PCC rule or is configured in the SMF, SMF shall provide the redirect destination to the UPF. When redirection is enforced in the SMF, SMF shall instruct the UPF to forward applicable user plane traffic to the SMF.
The NEF (PFDF) shall provide PFD(s) to the SMF on the request of SMF (pull mode) or on the request of PFD management from NEF (push mode), as described in TS 23.503 [45]. The NEF may subscribe to NWDAF to get PDF determination analytics for known applications, and may create, update, or delete PFD(s) based on the analytics as specified in TS 23.288 [86]. The SMF shall provide the PFD(s) to the UPF, which have active PDR(s) with the application identifier corresponding to the PFD(s).
The SMF supports the procedures in clause 4.4.3.5 of TS 23.502 [3], for management of PFDs. PFD(s) is cached in the SMF, and the SMF maintains a caching timer associated to the PFD(s). When the caching timer expires and there's no active PCC rule that refers to the corresponding application identifier, the SMF informs the UPF to remove the PFD(s) identified by the application identifier using the PFD management message.
When a PDR is provided for an application identifier corresponding to the PFD(s) that are not already provided to the UPF, the SMF shall provide the PFD(s) to the UPF (if there are no PFD(s) cached, the SMF retrieves them from the NEF (PFDF) as specified in TS 23.503 [45]). When any update of the PFD(s) is received from NEF (PFDF) by SMF (using "push" or "pull" mode), and there are still active PDRs in UPF for the application identifier, the SMF shall provision the updated PFD set corresponding to the application identifier to the UPF using the PFD management message.
NOTE 1:	SMF can assure not to overload N4 signalling while managing PFD(s) to the UPF, e.g. forwarding the PFD(s) to the right UPF where the PFD(s) is enforced.
When the UPF receives the updated PFD(s) from either the same or different SMF for the same application identifier, the latest received PFD(s) shall overwrite any existing PFD(s) stored in the UPF.
NOTE 2:	For the case a single UPF is controlled by multiple SMFs, the conflict of PFD(s) corresponding to the same application identifier provided by different SMF can be avoided by operator enforcing a well-planned NEF (PFDF) and SMF/UPF deployment.
When a PFD is removed/modified and this PFD was used to detect application traffic related to an application identifier in a PDR of an N4 session and the UPF has reported the application start to the SMF as defined in clause 4.4.2.2 of TS 23.502 [3] for the application instance corresponding to this PFD, the UPF shall report the application stop to the SMF for the corresponding application instance identifier if the removed/modified PFD in UPF results in that the stop of the application instance is not being able to be detected.
If the PFDs are managed by local O&M procedures, PFD retrieval is not used; otherwise, the PFDs retrieved from NEF (PFDF) override any PFDs pre-configured in the SMF. When all the PFDs retrieved from the NEF (PFDF) for an application identifier are removed, the pre-configured PFDs are used. The SMF shall provide either the PFDs retrieved from NEF (PFDF) or the pre-configured PFDs for an application identifier to the UPF.
Sending of "end marker" is a functionality which involve SMF and UPF in order to assist the reordering function in the Target RAN. As part of the functionality, constructing of end marker packets can either be done in the SMF or in the UPF, as described in clauses 5.8.2.9.1 and 5.8.2.9.2. Whether constructing of end marker packets is performed by SMF or UPF is determined by network configuration.
In the case of inter NG-RAN Handover procedure without UPF change, SMF shall indicate the UPF to switch the N3 path(s) by sending an N4 Session Modification Request message with the new AN Tunnel Info of NG RAN and in addition, provide an indication to the UPF to send the end marker packet(s) on the old N3 user plane path.
On receiving this indication, the UPF shall construct end marker packet(s) and send it for each N3 GTP-U tunnel towards the source NG RAN after sending the last PDU on the old path.
In the case of inter NG-RAN Handover procedure with change of the UPF terminating N3, the SMF shall request the UPF with N9 reference point to the UPF terminating N3 to switch the N9 user plane path(s) by sending an N4 Session Modification Request message (N4 session ID, new CN Tunnel Info of the UPF terminating N3) and in addition, provide an indication to this UPF to send the end marker packet(s) on the old path.
On receiving this indication, the UPF shall construct end marker packet(s) and send it for each N9 GTP-U tunnel towards the source UPF after sending the last PDU on the old path.
On receiving the end marker packet(s) on N9 GTP-U tunnel, source UPF shall forward the end marker packet(s) and send it for each N3 GTP-U tunnel towards the source NG RAN.
UPF referred in this clause is the UPF terminates N3 reference point.
It is assumed that the PDU Session for the UE comprises of an UPF that acts as a PDU Session Anchor and an intermediate UPF terminating N3 reference point at the time of this Handover procedure.
In the case of inter NG-RAN Handover procedure without UPF change, SMF shall indicate the UPF to switch the N3 path(s) by sending an N4 Session Modification Request message (N4 session ID, new AN Tunnel Info of NG RAN). After sending the last PDU on the old path, UPF shall replace the old AN Tunnel Info with the new one and responds with an N4 Session Modification Response message to acknowledge the success of path switch.
When the path switch is finished, SMF constructs the end marker packet(s) and sends it to the UPF. UPF then forwards the packet(s) to the source NG RAN.
In the case of inter NG-RAN Handover procedure with UPF change, SMF shall indicate the PSA UPF to switch the N9 user plane path(s) by sending an N4 Session Modification Request message (N4 session ID, new CN Tunnel Info of UPF). After sending the last PDU on the old N9 path, PSA UPF shall replace the old CN Tunnel Info with the new one and responds with an N4 Session Modification Response message to acknowledge the success of path switch.
When the path switch is finished, SMF constructs the end marker packet(s) and sends it to PSA UPF. PSA UPF then forwards the packet(s) to the source UPF.
5GC shall support per PDU Session tunnelling on N3 between (R)AN and UPF and N9 between UPFs. If there exist more than one UPF involved for the PDU Session, any tunnel(s) between UPFs (e.g. in the case of two UPFs, between the UPF that is an N3 terminating point and the UPF for PDU Session Anchor) remains established when a UE enters CM-IDLE state. In the case of downlink data buffering by UPF, when mobile terminated (MT) traffic arrives at the PDU Session Anchor UPF, it is forwarded to the UPF which buffer the data packet via N9 tunnel. See clause 5.8.3 for more details on UPF buffering. In the case of Home Routed roaming, the SMF in HPLMN is not aware of the UP activation state of a PDU Session.
When the UP connection of the PDU Session is deactivated, the SMF may release the UPF of N3 terminating point. In that case the UPF (e.g. the Branching Point/UL CL or PDU Session Anchor) connecting to the released UPF of N3 terminating point will buffer the DL packets. Otherwise, when the UPF with the N3 connection is not released, this UPF will buffer the DL packets.
When the UP connection of the PDU Session is activated due to a down-link data arrived and a new UPF is allocated to terminate the N3 connection, a data forwarding tunnel between the UPF that has buffered packets and the newly allocated UPF is established, so that the buffered data packets are transferred from the old UPF that has buffered packets to the newly allocated UPF via the data forwarding tunnel.
For a PDU Session whose the UP connection is deactivated and the SMF has subscribed the location change notification, when the SMF is notified of UE's new location from the AMF and detects that the UE has moved out of the service area of the existing intermediate UPF, the SMF may decide to maintain the intermediate UPF, remove the established tunnel between UPFs (in the case of removal of the intermediate UPF) or reallocate the tunnel between UPFs (in the case of reallocation of the intermediate UPF).
The parameters used by SMF to control the functionality of the UPF as well as to inform SMF about events occurring at the UPF are described in clause 5.8.5.
For Ethernet PDU Session type, the SMF may control the UPF to report the different MAC (Ethernet) addresses used as source address of frames sent UL by the UE in a PDU Session. These MAC addresses are called UE MAC addresses.
This control and the corresponding reporting takes place over N4.
NOTE:	This is e.g. used to support reporting of all UE MAC addresses in a PDU Session to the PCF as described in clause 5.6.10.2.
The UPF reports the removal of a UE MAC address based on the detection of absence of traffic during an inactivity time. The inactivity time value is provided by the SMF to the UPF.
The SMF may configure the UPF(s) to apply different traffic forwarding methods to route traffic between PDU Sessions for a single 5G VN group. For example, depending on the destination address, some packet flows may be forwarded locally, while other packet flows are forwarded via N19 and other packet flows are forwarded to N6.
If a single SMF serves the DNN/S-NSSAI of the 5G VN group, the UPF local switching, N6-based forwarding and N19-based forwarding methods described in clause 5.29.4 are coordinated by the SMF. If an SMF set serves the DNN/S-NSSAI of the 5G VN group, implementation based mechanisms can be used between SMF(s) that are part of the SMF set for controlling the connectivity between the PSA UPFs of the UE members of the 5G VN group.
When a 5G VN group communication is extended in a wide area, bigger than the service area of any SMF set serving the DNN/S-NSSAI of the 5G VN group, multiple SMF sets might control the PDU Sessions of the UE members of the 5G VN group. In this case, N6/N19 connectivity between PSA UPFs of the UE members of the 5G VN group controlled by different SMF sets, is achieved via OAM configuration. As a deployment option, a subset of the UPFs controlled by an SMF Set may be configured with the N6/N19 connectivity to enable 5G VN group communication across SMF Sets. N6 connectivity between PSA UPFs via a DN may also exist.
5G VN group communication includes one to one communication and one to many communication. One to one communication supports forwarding of unicast traffic between two UEs within a 5G VN, or between a UE and a device on the DN. One to many communication supports forwarding of multicast traffic and broadcast traffic from one UE (or device on the DN) to many/all UEs within a 5G VN and devices on the DN.
Traffic forwarding within the 5G VN group is realized by using a UPF internal interface ("5G VN internal") and a two-step detection and forwarding process. In the first step, the packets received from any 5G VN group member (via it's PDU Session, via N6 or via N19) are forwarded to the UPF internal interface (i.e. Destination Interface set to "5G VN internal"). In the second step, PDRs installed at the UPF internal interface (i.e. Source Interface set to "5G VN internal") detect the packet and forward it to the respective 5G VN group member (via it's PDU Session, via N6 or via N19). The details of the PDR and FAR configuration are described in the following clauses.
For UEs belonging to the same 5G VN group and having PDU Sessions that correspond to N4 Sessions in the same PSA UPF, the following applies for traffic that is sent from one of these UEs to another one of these UEs using local switching: The incoming traffic for one PDU Session will match the corresponding N4 Session's PDR(s) of the source PDU Session (based on GTP-U header information). The traffic is then sent back to classification in that UPF (via the internal interface) and will match another N4 Session corresponding to the destination PDU Session (based on destination address in the PDU). The PDU is then forwarded to the target UE.
If 5G VN group members' PDU Sessions are served by different PSA UPFs and N19-based forwarding is applied, the SMF creates a group-level N4 Session with each involved UPF to enable N19-based forwarding and N6-based forwarding. When the traffic is then sent back to classification in that UPF (via the internal interface) it may match group-level N4 Session corresponding to the 5G VN group (based on destination address in the PDU or a default PDR rule with match-all packet filter). The PDU is then forwarded to N6 or to the UPF indicated in the group-level N4 Session via corresponding N19 tunnel. This enables the PDU to be sent to the target group member in the other UPF or to the device in the DN.
In the case of N19-based forwarding is not applied for a 5G VN group, group level N4 session is not required.
If more than one 5G VN group has to be supported in the PLMN, the N4 rule attribute Network Instance is used in addition to the UPF internal interface and set to a value representing the 5G VN group. This keeps the traffic of different 5G VN groups separate from each other and thus enables isolation of the 5G VN group communication during the packet detection and forwarding process. The SMF shall provide the PDRs and FARs related to the UPF internal interface as follows whenever more than one 5G VN group has to be supported in the PLMN:
-	The FAR with Destination Interface set to "5G VN internal" shall also contain the Network Instance set to the value representing the 5G VN group.
-	The PDR with Source Interface set to "5G VN internal" shall also contain the Network Instance set to the value representing the 5G VN group.
Forwarding Ethernet unicast traffic towards the PDU Session corresponding to the Destination MAC address of an Ethernet frame may correspond:
-	either to the SMF explicitly configuring DL PDR(s) with the MAC addresses detected by the UPF on PDU Sessions and reported to the SMF; this is further described in clause 5.8.2.13.1;
-	or to the SMF relying on MAC address learning in UPF as defined in clause 5.8.2.5.3. To request this UPF behaviour the SMF sets the Ethernet PDU Session Information indication in the DL PDR of the "5G VN internal" interface related with a 5G VN group. This may apply in the case that all PDU Sessions related with this 5G VN group are served by the same PSA or by multiple PSAs not inter-connected via N19.
For Ethernet traffic on 5G-VN, in the former case above where SMF explicitly configures DL PDR with the MAC addresses detected on PDU Sessions supporting a 5G VN group, the SMF acts as a central controller which is responsible for setting up the forwarding rules in the UPFs so that it avoids forwarding loops. The SMF becomes aware of the MAC addresses in use within a 5G VN group by the UPF's reporting of the MAC addresses. The SMF is responsible to react to topology changes in the Ethernet network. Local switching without SMF involvement is not specified for a 5G-VN when different PDU Sessions related with this 5G VN group may be served by different PSA(s) connected over N19.
NOTE:	The mechanisms described above implies signalling on N4 Sessions related with a VN group each time a new MAC address is detected as used (or no more used) within a PDU Session related with this 5G VN group. Hence the usage of the solution with SMF explicitly configuring DL PDR with the MAC addresses defined in this release can raise signalling scalability issues for large VN groups with lots of devices (MAC addresses) served by PDU sessions related with this VN group.
To enable unicast traffic forwarding in a UPF, the following applies:
-	The SMF provides for each 5G VN group member's N4 Session (i.e. N4 Session corresponding to PDU Session) the following N4 rules that enable the processing of packets received from this UE.
-	in order to detect the traffic, a PDR containing Source Interface set to "access side", and CN Tunnel Information set to PDU Session tunnel header (i.e. N3 or N9 GTP-U F-TEID); and
-	in order to forward the traffic, a FAR containing Destination Interface set to "5G VN internal".
-	The SMF provides for each 5G VN group member's N4 Session (i.e. N4 session corresponding to PDU Session) the following N4 rules that enable the processing of packets towards this UE.
-	in order to detect the traffic, a PDR containing Source Interface set to "5G VN internal", and Destination Address set to the IP/MAC address (es) of this 5G VN group member; and
-	in order to forward the traffic, a FAR containing Outer Header Creation indicating the N3/N9 tunnel information, and Destination Interface set "access side".
-	If N19-based forwarding is applied, the SMF configures the group-level N4 Session for processing packets received from a N19 tunnel with the following N4 rules for each N19 tunnel.
-	in order to detect the traffic, a PDR containing Source Interface set to "core side", and CN Tunnel Information set to N19 tunnel header (i.e. N19 GTP-U F-TEID); and
-	in order to forward the traffic, a FAR containing Destination Interface set to "5G VN internal".
-	If N19-based forwarding is applied, the SMF configures the group-level N4 Session for processing packets towards 5G VN group members anchored at other UPFs with the following N4 rules for each N19 tunnel.
-	in order to detect the traffic, a PDR containing Source Interface set to "5G VN internal", and Destination Address set to the IP/MAC address (es) of UEs anchored at the peer UPF of this N19 tunnel (e.g. based on the IP address range supported by the peer UPF); and
-	in order to forward the traffic to a 5G VN group member anchored at another UPF via the N19 tunnel, a FAR containing Outer Header Creation indicating the N19 tunnel information, Destination Interface set to "core side".
-	The SMF configures the group-level N4 Session for processing packets received from a 5G VN group member connected via N6 with the following N4 rules.
-	in order to detect the traffic, a PDR containing Source Interface set to "core side", and Source Address set to the IP/MAC address (es) of this 5G VN group member; and
-	in order to forward the traffic, a FAR containing Destination Interface set to "5G VN internal".
-	The SMF configures the group-level N4 Session for processing packets towards a 5G VN group member connected via N6 or packets towards a device residing in DN with the following N4 rules.
-	in order to detect the traffic, a PDR containing Source Interface set to "5G VN internal", and Destination Address set to the IP/MAC address (es) of this 5G VN group member; and
-	in order to forward the traffic to the 5G VN group member or device via N6, a FAR containing Destination Interface set to "core side".
-	The SMF shall update N4 rules for group-level N4 Session to enable correct forwarding of packets towards UE who's PSA UPF has been reallocated and address is unchanged.
-	The SMF may also configure the following N4 rules for the group-level N4 Session to process packets with an unknown destination address:
-	in order to detect the traffic, a PDR containing Source Interface set to "5G VN internal", a match-all Packet Filter, and a Precedence set to the lowest precedence value; and
-	in order to process the traffic, a FAR containing Destination Interface set to "core side" to route the traffic via N6 by default, or in the case of local SMF configuration that N6-based forwarding is not applied a FAR instructing the UPF to drop the traffic.
To enable the service continuity when the PSA UPF serving the UE changed, the following applies:
-	Keep the UE address unchanged if N6-based forwarding is not used.
-	Configure the UE's N4 Session with N4 rules (PDR, FAR) to detect and forward the traffic to this UE via its PDU Session tunnel(i.e. N3 tunnel) on the target PSA UPF.
-	If N19-based forwarding is applied: To switch the traffic towards this UE from the source PSA UPF to the target PSA UPF for N19-based forwarding, the SMF deletes the N4 rule (PDR) that detects the traffic towards this UE in the group-level N4 Session at UPFs involved in the 5G VN group (except the source PSA UPF), then adds or updates the PDR that detects the traffic towards this UE with the FAR containing the N19 tunnel information of the target PSA UPF in the group-level N4 Session at UPFs involved in the 5G VN group (except the target PSA UPF).
For Ethernet PDU Sessions, the SMF may instruct the UPF to route traffic to be replicated as described in clause 5.8.2.5.
For IP PDU Session types, the SMF may instruct the UPF to manage IP multicast traffic as described in clauses 4.6.6 and 7.7.1 of TS 23.316 [84]. The UPF replicates the IP multicast traffic received from PDU Sessions or N6 interface and sends the packets over other PDU Sessions and other N6 interface subscribed to the IP Multicast groups.
Mechanisms described in clauses 4.6.6 and 7.7.1 of TS 23.316 [84] apply to support 5G VN group communication with following clarifications:
-	These mechanisms are not limited to Wireline access and can apply on any access,
-	IP Multicast traffic allowed for a PDU Session is not meant for IPTV services reachable over N6,
-	IGMP /MLD signalling does not relate with STB or 5G-RG: Clauses 4.6.6 and 7.7.1 of TS 23.316 [84], apply to UE members of a 5G VN group instead of 5G-RG, and
-	Clauses 7.7.1.1.2 and 7.7.1.1.4 of TS 23.316 [84] are not applicable to 5G VN groups: members of the 5G VN groups may receive any multicast traffic associated with the (DNN, S-NSSAI) of the 5G VN group.
-	UPF exchange of signalling such as PIM (Protocol-Independent Multicast) may apply as defined in TS 23.316, with following clarification:
-	PIM signalling is generally exchanged over N6 but may be sent towards the PDU Session supporting the source address of multicast traffic identified by IGMP / MLD signalling for Source Specific Multicast. In the case of IGMP / MLD signalling not related with Source Specific Multicast no PIM signalling is sent towards any PDU Session
Alternatively, for IP or Ethernet type data communication, the SMF instructs the UPF via PDRs and FARs how to replicate user plane traffic.
The mechanism is supported in the following conditions:
-	When N19 is used, there is a full mesh of N19 tunnels between UPFs controlled by each SMF Set serving the 5G VN group;
-	There is no support for forwarding a broadcast/multicast packet with source address not known to SMF/UPF.
-	Each UPF supports one N6 interface instance towards the data network, or only supports N19-based forwarding without N6;
-	Multicast group formation of selected members of a 5G VN for Ethernet type data communication is not described in this release of the specification.
In this case, when the UPF receives a broadcast packet of a 5G VN group from N19 or N6, it shall distribute it to all 5G VN group members connected to this UPF. When the UPF receives a broadcast packet from a UE (source UE) via PDU Session associated with a 5G VN group, it shall distribute it to:
-	All 5G VN group members (except the source UE) connected to this UPF via local switch; and
-	All 5G VN group members connected to other UPFs via N19-based forwarding or N6-based forwarding; and
-	The devices on the DN via N6-based forwarding.
To enable broadcast traffic forwarding of a 5G VN group in a UPF, the following applies:
-	The SMF provides group-level N4 Session and each 5G VN group member' N4 Session with the PDR that detect the broadcast packet sent via "internal interface". When UPF receives the broadcast packets sent via "internal interface", it matches the broadcast packet against all PDRs installed at the "internal interface". A successful matching with a PDR that detect the broadcast packet instructs the UPF to continue the lookup of the other PDRs. A matching PDR that detects the broadcast packet shall instruct the UPF to duplicate the broadcast packet and perform processing (using associated FAR, URR, QER) on the copy instead of the original packet if the broadcast packet does not satisfy the packet replication skip information, otherwise the PDR instructs the UPF to skip the processing of the broadcast packet.
-	The broadcast packets received from N19 or N6 are forwarded to the UPF internal interface together with a N19 or N6 indication.
-	The SMF provides for each 5G VN group member' N4 Session (i.e. N4 session corresponding to PDU Session) the following N4 rules that enable the processing of broadcast packets towards this UE.
-	in order to detect the traffic, a PDR containing Source Interface set to "5G VN internal", Destination Address set to the broadcast address, the Packet replication skip information set to the IP/MAC address (es) of this 5G VN group member, and the indication to carry on matching; and
-	in order to forward the traffic, a FAR containing Outer Header Creation indicating the PDU Session tunnel information, and Destination Interface set "access side".
-	The SMF configures the group-level N4 Session for processing packets received from a N19 tunnel with the following N4 rules for each N19 tunnel.
-	in order to detect the traffic, a PDR containing Source Interface set to "core side", Destination Address set to the broadcast address, and CN Tunnel Information set to N19 tunnel header (i.e. N19 GTP-U TEID); and
-	in order to forward the traffic, a FAR containing Destination Interface set to "5G VN internal", Outer Header Creation with the N19 indication.
-	The SMF provides for the group-level N4 Session the following N4 rules that enable the processing of broadcast packets towards the other UPFs.
-	in order to detect the traffic, a PDR containing Source Interface set to "5G VN internal", Destination Address set to the broadcast address, the Packet replication skip information set to the N19 indication, and the indication to carry on matching; and
-	in order to forward the traffic to each involved UPF via the corresponding N19 tunnel, a FAR containing "Duplication" instruction, Outer Header Creation indicating the N19 tunnel information, Destination Interface set to "core side".
-	The SMF configures the group-level N4 Session for processing packets received from N6 with the following N4 rules.
-	in order to detect the traffic, a PDR containing Source Interface set to "core side", and Destination Address set to the broadcast address; and
-	in order to forward the traffic, a FAR containing Destination Interface set to "5G VN internal", Outer Header Creation with the N6 indication.
-	The SMF provides for the group-level N4 Session the following N4 rules that enable the processing of broadcast packets towards N6.
-	in order to detect the traffic, a PDR containing Source Interface set to "5G VN internal" and Destination Address set to the broadcast address and the Packet replication skip information set to the N6 indication; and
-	in order to forward the traffic to N6, a FAR containing Destination Interface set to "core side".
In this case, to enable multicast traffic forwarding of a 5G VN group in a UPF, broadcast traffic forwarding of a 5G VN applies to multicast traffic forwarding of a 5G VN with the following modifications:
-	The SMF installs PDRs for the multicast address instead of the broadcast address.
-	The PDRs and FARs are installed for PDU Sessions corresponding to the members of the multicast group.
-	In addition, the SMF installs the PDR identifying IGMP/MLD signalling for each 5G VN group member' N4 Session and a URR with a Reporting Trigger set to "IGMP reporting" for IGMP or set to "MLD reporting" for MLD. Based on the IP Multicast address in "IP multicast join" or "IP multicast leave" reports received from UPF, the SMF manipulates (delete or add) the PDR identifying the multicast traffic for the reported IP Multicast address at the corresponding 5G VN group member' N4 Session, and if required at the group-level N4 Session at the UPF(s) of the 5G VN group.
Operators can deploy UPF(s) supporting the Inter PLMN User Plane Security (IPUPS) functionality at the border of their network to protect their networks from invalid inter PLMN N9 traffic.
The IPUPS functionality forwards GTP-U packets (received via the N9 interface) only if they belong to an active PDU Session and are not malformed, as described in TS 33.501 [29].
The SMF can activate the IPUPS functionality together with other UP functionality in the same UPF, or insert a separate UPF in the UP path for the IPUPS functionality. In both cases the UPF with IPUPS functionality is controlled by the SMF via the N4 interface.

If requested by the SMF during N4 Session Establishment, the UPF (PSA) may setup L2TP towards an L2TP network server (LNS) in the DN and tunnel the PDU Session user plane traffic in this L2TP tunnel. In this case the UPF acts as a L2TP access concentrator (LAC).
To enable this, the SMF may provide L2TP information to the UPF, such as LNS IP address and/or LNS host name, as described in TS 29.244 [65]. This L2TP information may be configured on the SMF as part of the DNN configuration or received from the DN-AAA Server during secondary authentication/authorization, as described in clause 5.6.6. Alternatively, the L2TP tunnel parameters may be configured in the UPF Function. The L2TP tunnel parameters include necessary parameters for setting up L2TP tunnel towards the LNS (e.g. LNS address, tunnel password, etc.).
In addition, the SMF may provide PAP/CHAP authentication information to the UPF, for use in L2TP session establishment, in case it was received from the UE in the PDU Session Establishment Request.
When L2TP is to be used for a PDU Session, the SMF may select a UPF based upon support of this feature. The SMF determines whether the UPF supports this feature via N4 capability negotiation during N4 Association Setup or via NRF discovery.
If SMF requests the UPF to allocate UE IP address, as described in clause 5.8.2.2.1, the UPF (LAC) may retrieve this IP address from the LNS. In addition, if the SMF requests the UPF to provide DNS address(es), the UPF (LAC) may request the LNS to provide DNS address(es) and report such DNS address(es) to the SMF.
The UPF may expose information by means of UPF event exposure service as described in TS 23.502 [3] clause 5.2.26.2, via a service-based interface directly. The NF consumer, which may receive UPF event notifications, are AF/NEF, TSNAF/TSCTSF and NWDAF/DCCF/MFAF.
When the UPF supports the data exposure via the SBI interface, it may register its NF profile to the NRF including the UPF Event Exposure service. For the UPF Event Exposure service, the NF profile includes the related event ID(s).
For data collection from UPF (see clause 4.15.4.5 of TS 23.502 [3]), NF consumer do the subscription to the UPF directly or indirectly via SMF. A consumer may subscribe to the UPF event exposure service directly only for data collected for "any UE" e.g. to collect user data usage information for NWDAF NF Load analytic (see clause 6.5 of TS 23.288 [86]), and if the subscription is not including any of the following parameters: AoI, traffic filtering, BSSID/SSID, Application ID.
UPF selection is further described in clause 6.3.3.1.
To minimize the impact of event notification to UPF data processing, the event subscription may include Reporting suggestion information. The Reporting suggestion information includes Report urgency and Reporting window information. Reporting urgency information represents whether this event report can be delay tolerant, i.e. the event report can be delayed. If the Reporting urgency information indicates "delay tolerant", the Reporting time is also provided, which defines the last valid reporting time, and UPF shall report the detected event before the last valid time. Per Reporting suggestion information UPF can concatenate several notification messages to the same notification endpoint in one notification message.
An UPF which is deployed with NAT (Network Address Translation) functionality may support to provide the 5GC UE IP address to NEF based on NEF request containing public IP address and port number using the Nupf_GetPrivateUEIPaddr service as described in clause 4.15.10 of TS 23.502 [3] for AF specific UE ID retrieval.
The SMF may configure the UPF to perform QoS monitoring for a QoS Flow and to report the monitoring results with the help of the following parameters provided in the Session Reporting Rule (SRR) described in clause 5.8.5.11:
-	QoS parameter(s) to be measured indicating the subject of the QoS monitoring as defined in clause 5.45;
-	Reporting period indicating the time interval in which a new measurement result and a potential report has to be available. If no measurement result is available to the UPF within the Reporting period, the UPF shall report a measurement failure;
-	Reporting frequency indicating the type of the reporting as "periodic" or "event triggered":
-	If the Reporting frequency indicates "periodic", the UPF shall send a report each time the reporting period is over.
-	If the Reporting frequency indicates "event triggered", a Reporting threshold for each parameter in the QoS parameter(s) to be measured and a Minimum waiting time are provided as well. The UPF shall send a report when the measurement result matches or exceeds the indicated Reporting threshold. Subsequent reports shall not be sent by the UPF during the Minimum waiting time. If measurement results are received during the Minimum waiting time, the UPF shall report the minimum and the maximum measurement result when the Minimum waiting time is over.
-	(Optional) Target of the reporting and Indication of direct event notification indicating that the UPF shall send the reports to a different NF than the SMF (i.e. to the Local NEF or the AF). The NF is described by a Notification Target Address and a Notification Correlation ID. The SMF can also indicate that the UPF shall send the reports to both, the NF indicated by the Target of reporting and to the SMF. If so, the UPF shall send the reports to the SMF as well. If the Indication of direct event notification is not provided, the UPF shall send the reports to the SMF.
-	(Optional) Reporting suggestion information as defined in clause 5.8.2.17 applicable to Target of the reporting to reduce the UPF performance impacts.
The UPF sends reports to the SMF in the form of QoS Monitoring Report as described in clause 5.8.5.12 and reports to the Local NEF or the AF via the Nupf_EventExposure_Notify service operation described in clause 7.2.29.
5GC supports buffering of UE's downlink packets for deactivated PDU Sessions.
Support for buffering in the UPF is mandatory and optional in the SMF.
When the UP connection of a PDU Session is deactivated, buffering in UPF can be activated by the SMF. If the SMF supports buffering capability, the SMF can decide to activate buffering in SMF instead of buffering in UPF.
When the SMF decided to activate buffering in UPF, the SMF shall inform the UPF to start buffering packets for this PDU Session.
The SMF provides instructions to the UPF for at least the following behaviour:
-	buffer downlink packets with the following additional options:
-	reporting the arrival of first downlink packet (for a QoS Flow or a service data flow), and/or
-	reporting the first discarded downlink packet (for a service data flow), or
-	drop downlink packets with the following additional options:
-	reporting the first discarded downlink packet (for a service data flow).
-	buffer uplink packets.
When the SMF instructs the UPF for a service data flow to buffer downlink packets and to report the first discarded downlink packet, the SMF shall also instruct the UPF to report the arrival of the first downlink packet for this service data flow to enable the SMF check if this is also the first report for the QoS Flow (as described below).
Buffering in the UPF may be configured based on timers or the amount of downlink data to be buffered. The SMF decides whether buffering timers or amount of downlink data are handled by the UPF or SMF.
After starting buffering, when the first downlink packet (of a QoS Flow or a service data flow) arrives, UPF shall inform the SMF if it is setup to report. UPF sends a Downlink Data Report to the SMF via N4 unless specified otherwise and indicates the PDR by which the downlink packet was received. If the SMF receives a Downlink Data Report for a service data flow, the SMF shall also check if this is the first report for the QoS Flow corresponding to the PDR. If so, the SMF shall also proceed as described in clause 5.4.3.1.
After starting buffering, when the first downlink packet (of a service data flow) in a configured period of time that has been buffered is discarded by the UPF because the configured buffering time or amount of downlink data to be buffered is exceeded, the UPF shall inform the SMF if it is setup to report. UPF sends a Downlink Data Report to the SMF via N4 and indicates the PDR by which the discarded downlink packet was received.
A new report is sent if the SMF terminates and subsequently re-activates the buffering action at the UPF and the UPF again receives downlink packets.
NOTE:	For the notification about the downlink data delivery status "buffered" or "discarded" related to packets from a particular AF as part of the Nsmf_EventExposure service, it is expected that a PDR with a traffic filter identifying that AF as source and a Forwarding Action rule with action "buffer" is installed.
When the UP connection of the PDU Session is activated, the SMF updates the UPF of the change in buffering state. The buffered downlink packets, if any, are then forwarded to the (R)AN by the UPF.
If the UP connection of the PDU Session has been deactivated for a long time, the SMF may indicate the UPF to stop buffering for this PDU Session.
The SMF may indicate to the UPF to start or stop the buffering of uplink packets of an application associated to the PCC rule as described in clause 6.3.5 of TS 23.548 [130]. When the buffering of uplink packets is stopped the UPF shall forward all buffered uplink packets before it forwards any new uplink packets.
When the SMF supports buffering capability and the SMF decided to activate buffering in SMF for the PDU Session, the SMF shall inform the UPF to start forwarding the downlink packets towards the SMF.
When the UP connection of the PDU Session is activated, if there are buffered downlink packets available and their buffering duration has not expired, the SMF shall forward those packets to the UPF to relay them to the UE. These packets are then forwarded by the UPF to the (R)AN.
The SMF Pause of Charging functionality is supported with the purpose that the charging and usage monitoring data in the core network more accurately reflects the downlink traffic actually sent to the (R)AN. When the amount of downlink data incoming at the UPF for a PDU Session that is in deactivated state goes above a pre-configured threshold, the pause of charging functionality ensures that data that dropped in the core network is not included in charging and usage monitoring records.
The procedures for SMF Pause of Charging are described in TS 23.502 [3].
The Explicit Buffer Management is described in clause 5.8.2.19.
The SMF Pause of Charging is described in clause 5.8.2.20.
These parameters are used by SMF to control the functionality of the UPF as well as to inform SMF about events occurring at the UPF.
The N4 session management procedures defined in clause 4.4.1 of TS 23.502 [3] will use the relevant parameters in the same way for all N4 reference points: the N4 Session Establishment procedure as well as the N4 Session Modification procedure provide the control parameters to the UPF, the N4 Session Release procedure removes all control parameters related to an N4 session, and the N4 Session Level Reporting procedure informs the SMF about events related to the PDU Session that are detected by the UPF.
The parameters over N4 reference point provided from SMF to UPF comprises an N4 Session ID and may also contain:
-	Packet Detection Rules (PDR) that contain information to classify traffic (PDU(s)) arriving at the UPF;
-	Forwarding Action Rules (FAR) that contain information on whether forwarding, dropping or buffering is to be applied to a traffic identified by PDR(s);
-	Multi-Access Rules (MAR) that contain information on how to handle traffic steering, switching and splitting for a MA PDU Session;
-	Usage Reporting Rules (URR) contains information that defines how traffic identified by PDR(s) shall be accounted as well as how a certain measurement shall be reported;
-	QoS Enforcement Rules (QER), that contain information related to QoS enforcement of traffic identified by PDR(s);
-	Session Reporting Rules (SRR) that contain information to request the UP function to detect and report events for a PDU session that are not related to specific PDRs of the PDU session or that are not related to traffic usage measurement.
-	Trace Requirements;
-	Port Management Information Container in 5GS;
-	Bridge/Router Information.
The N4 Session ID is assigned by the SMF and uniquely identifies an N4 session.
If the UPF indicated support of Trace, the SMF may activate a trace session during a N4 Session Establishment or a N4 Session Modification procedure. In that case it provides Trace Requirements to the UPF. The SMF may deactivate an on-going trace session using a N4 Session Modification procedure. There shall be at most one trace session activated per N4 Session at a time.
For the MA PDU Session, the SMF may add an additional access tunnel information during an N4 Session Modification procedure by updating MAR with addition of an FAR ID which refers to an FAR containing the additional access tunnel information for the MA PDU session for traffic steering in the UPF. For the MA PDU Session, the SMF may request Access Availability report per N4 Session, during N4 Session Establishment procedure or N4 Session Modification procedure.
A N4 Session may be used to control both UPF and NW-TT behaviour in the UPF. A N4 session support and enable exchange of bridge/router configuration between the SMF and the UPF:
-	Information that the SMF needs for bridge/router management (clause 5.8.5.9);
-	Information that 5GS transparently relays between the TSN AF or TSCTSF and the NW-TT: transparent Port Management Information Container along with the associated NW-TT port number.
-	Information that 5GS transparently relays between the TSN AF or TSCTSF and the NW-TT: transparent user plane node Management Information Container (clause 5.8.5.14).
When a N4 Session related with bridge/router management is established, the UPF allocates a dedicated port number for the device side of the PDU Session. The UPF then provides to the SMF following configuration parameters for the N4 Session:
-	port number.
-	user-plane node ID.
To support TSN, the user-plane node ID is Bridge ID. The User Plane Node ID/Bridge ID may be pre-configured in the UPF based on deployment.
After the N4 session has been established, the SMF and UPF may at any time exchange transparent user plane node and Port Management Information Container over a N4 session.
N4 Session Context is identified by an N4 Session ID. An N4 Session Context is generated by SMF and UPF respectively to store the parameters related to an N4 session, including the N4 session ID and following information (see TS 29.244 [65] for an exhaustive list):
1)	general session related parameters such as S-NSSAI, PDU Session Type, Trace Information, APN/DNN, ATSSS Control Information;
2)	the PDRs, URRs, QERs, BAR(s), FARs, MARs used for this N4 session;
3)	parameters sent to support UPF statistics.
The UPF may use parameters listed above in bullets 1) (e.g. S-NSSAI) and 2) (e.g. Network Instance in PDR/FAR(s)) for determining internal UPF resources.
The following table describes the Packet Detection Rule (PDR) containing information required to classify a packet arriving at the UPF. Every PDR is used to detect packets in a certain transmission direction, e.g. UL direction or DL direction.
Table 5.8.5.3-1: Attributes within Packet Detection Rule

The following table describes the QoS Enforcement Rule (QER) that defines how a packet shall be treated in terms of bit rate limitation and packet marking for QoS purposes. All Packet Detection Rules that refer to the same QER share the same QoS resources, e.g. MFBR.
Table 5.8.5.4-1: Attributes within QoS Enforcement Rule

The following table describes the Usage Reporting Rule (URR) that defines how a packet shall be accounted as well as when and how to report the measurements.
Table 5.8.5.5-1: Attributes within Usage Reporting Rule

The following table describes the Forwarding Action Rule (FAR) that defines how a packet shall be buffered, dropped or forwarded, including packet encapsulation/decapsulation and forwarding destination.
Table 5.8.5.6-1: Attributes within Forwarding Action Rule

The UPF sends the Usage Report to inform the SMF about the measurement of an active URR or about the detection of application traffic of an active Packet Detection Rule. For each URR, the Usage Report may be generated repeatedly, i.e. as long as any one of the valid event triggers applies. A final Usage Report is sent for a URR when it is no longer active, i.e. either the URR is removed or all the references to this URR in any of the Packet Detection Rules belonging to the N4 session.
The following attributes can be included:
Table 5.8.5.7-1: Attributes within Usage Report

The following table describes the Multi-Access Rule (MAR) that includes the association to the two FARs for both 3GPP access and non-3GPP access in the case of supporting ATSSS.
Table 5.8.5.8-1: Attributes within Multi-Access Rule

The following table describes the User plane node Information (UI) that includes the information required to configure a 5GS logical bridge/router for TSC or Deterministic Networking PDU Sessions.
Table 5.8.5.9-1: User plane node Information


The following table describes the Session Reporting Rule (SRR) that defines the detection and reporting events that the UPF shall report, that are not related to specific PDRs of the PDU Session, as follows:
-	Per QoS Flow per UE QoS Monitoring Report, as specified in clause 5.33.3.2.
-	Change of 3GPP or non-3GPP access availability, for an MA PDU session.
-	Per QoS Flow N6 Traffic Parameter Measurement Report.
Table 5.8.5.11-1: Attributes within Session Reporting Rule

The UPF sends the session report to inform the SMF the detected events for a PDU Session that are related to an SRR. The UPF may support notification to the AF possibly via local NEF as described in clause 6.4 of TS 23.548 [130].
Table 5.8.5.12-1: Attributes within Session Reporting


The following table describes the TSC Management Information Container (TSC MIC) that includes UMIC, PMIC and the associated NW-TT port number.
The SMF may include the notification target address for PMIC/UMIC UPF event provided by the PCF in the TSC Management Information sent to UPF if the UPF supports the related redirect reporting via Nupf. If the notification target address for PMIC/UMIC UPF event is provided by the SMF, the UPF may directly report TSC management information to the TSNAF or TSCTSF using Nupf_EventExposure_Notify service operation described in clause 7.2.29.
Table 5.8.5.14-1: TSC Management Information Container

The UPF sends the Downlink Data Report to inform the SMF about the events related to receiving or discarding of downlink packets. The SMF controls this type of UPF report by providing instructions in the Buffer Action Rule of a FAR.
Following attributes can be included:
Table 5.8.5.15-1: Attributes within Downlink Data Report

Each subscriber in the 5G System shall be allocated one 5G Subscription Permanent Identifier (SUPI) for use within the 3GPP system. The 5G System supports identification of subscriptions independently of identification of the user equipment. Each UE accessing the 5G System shall be assigned a Permanent Equipment Identifier (PEI).
The 5G System supports allocation of a temporary identifier (5G-GUTI) in order to support user confidentiality protection.
A globally unique 5G Subscription Permanent Identifier (SUPI) shall be allocated to each subscriber in the 5G System and provisioned in the UDM/UDR. The SUPI is used only inside 3GPP system, and its privacy is specified in TS 33.501 [29].
The SUPI may contain:
-	an IMSI as defined in TS 23.003 [19], or
-	a network-specific identifier, used for private networks as defined in TS 22.261 [2].
-	a GLI and an operator identifier of the 5GC operator, used for supporting FN-BRGs, as further described in TS 23.316 [84].
-	a GCI and an operator identifier of the 5GC operator, used for supporting FN-CRGs and 5G-CRG, as further described in TS 23.316 [84].
A SUPI containing a network-specific identifier shall take the form of a Network Access Identifier (NAI) using the NAI RFC 7542 [20] based user identification as defined in TS 23.003 [19].
When UE needs to indicate its SUPI to the network (e.g. as part of the Registration procedure), the UE provides the SUPI in concealed form as defined in TS 23.003 [19].
In order to enable roaming scenarios, the SUPI shall contain the address of the home network (e.g. the MCC and MNC in the case of an IMSI based SUPI).
For interworking with the EPC, the SUPI allocated to the 3GPP UE shall always be based on an IMSI to enable the UE to present an IMSI to the EPC.
The usage of SUPI for W-5GAN is further specified in TS 23.316 [84].
5.9.2a	Subscription Concealed Identifier
The Subscription Concealed Identifier (SUCI) is a privacy preserving identifier containing the concealed SUPI. It is specified in TS 33.501 [29].
The usage of SUCI for W-5GAN access is further specified in TS 23.316 [84].
A Permanent Equipment Identifier (PEI) is defined for the 3GPP UE accessing the 5G System.
The PEI can assume different formats for different UE types and use cases. The UE shall present the PEI to the network together with an indication of the PEI format being used.
If the UE supports at least one 3GPP access technology (i.e. NG-RAN, E-UTRAN, UTRAN or GERAN), the UE must be allocated a PEI in the IMEI or IMEISV format.
If a UE has registered with a network by using a network subscription and a PEI of the UE, then the UE shall keep the PEI to be used with the network subscription and shall not use that PEI with another network subscription while the UE is in registered state in the network.
In the scope of this release, the PEI may be one of the following:
-	for UEs that support at least one 3GPP access technology, an IMEI or IMEISV, as defined in TS 23.003 [19];
-	PEI used in the case of W-5GAN access as further specified in TS 23.316 [84].
-	for UEs not supporting any 3GPP access technologies, the IEEE Extended Unique Identifier EUI-64 [113] of the access technology the UE uses to connect to the 5GC.
The AMF shall allocate a 5G Globally Unique Temporary Identifier (5G-GUTI) to the UE that is common to both 3GPP and non-3GPP access. It shall be possible to use the same 5G-GUTI for accessing 3GPP access and non-3GPP access security context within the AMF for the given UE. An AMF may re-assign a new 5G-GUTI to the UE at any time. The AMF provides a new 5G-GUTI to the UE under the conditions specified in clause 6.12.3 of TS 33.501 [29]. When the UE is in CM-IDLE, the AMF may delay providing the UE with a new 5G-GUTI until the next NAS transaction.
The 5G-GUTI shall be structured as:
	<5G-GUTI> := <GUAMI> <5G-TMSI>
	where GUAMI identifies one or more AMF(s).
When the GUAMI identifies only one AMF, the 5G-TMSI identifies the UE uniquely within the AMF. However, when AMF assigns a 5G-GUTI to the UE with a GUAMI value used by more than one AMF, the AMF shall ensure that the 5G-TMSI value used within the assigned 5G-GUTI is not already in use by the other AMF(s) sharing that GUAMI value.
The Globally Unique AMF ID (GUAMI) shall be structured as:
	<GUAMI> := <MCC> <MNC> <AMF Region ID> <AMF Set ID> <AMF Pointer>
	where AMF Region ID identifies the region, AMF Set ID uniquely identifies the AMF Set within the AMF Region and AMF Pointer identifies one or more AMFs within the AMF Set.
NOTE 1:	The AMF Region ID addresses the case that there are more AMFs in the network than the number of AMFs that can be supported by AMF Set ID and AMF Pointer by enabling operators to re-use the same AMF Set IDs and AMF Pointers in different regions.
NOTE 2:	In the case of SNPNs, the PLMN IDs may be shared among SNPNs such that the constructed GUAMIs are not globally unique. However, PLMN ID and NID are provided together, separate from the GUAMI, to uniquely identify selected or supported SNPN in RRC and N2.
NOTE 3: See TS 23.003 [19] for details on the structure of the fields of GUAMI.
The 5G-S-TMSI is the shortened form of the GUTI to enable more efficient radio signalling procedures (e.g. during Paging and Service Request) and is defined as:
	<5G-S-TMSI> := <AMF Set ID> <AMF Pointer> <5G-TMSI>
As specified in TS 38.304 [50] and TS 36.304 [52] for 3GPP access, the NG-RAN uses the 10 Least Significant Bits of the 5G-TMSI in the determination of the time at which different UEs are paged. Hence, the AMF shall ensure that the 10 Least Significant Bits of the 5G-TMSI are evenly distributed.
As specified in TS 38.331 [28] and TS 36.331 [51] for 3GPP access, the NG-RAN's RRC Connection Establishment's contention resolution process assumes that there is a low probability of the same 5G-TMSI being allocated by different AMFs to different UEs. The AMFs' process for allocating the 5G-TMSI should take this account.
NOTE 4:	To achieve this, the AMF could, for example, use a random seed number for any process it uses when choosing the UE's 5G-TMSI.
An AMF is identified by an AMF Name. AMF Name is a globally unique FQDN, the structure of AMF Name FQDN is defined in TS 23.003 [19]. An AMF can be configured with one or more GUAMIs. At a given time, GUAMI with distinct AMF Pointer value is associated to one AMF name only.
A DNN is equivalent to an APN as defined in TS 23.003 [19]. Both identifiers have an equivalent meaning and carry the same information.
The DNN may be used e.g. to:
-	Select a SMF and UPF(s) for a PDU Session.
-	Select N6 interface(s) for a PDU Session.
-	Determine policies to apply to this PDU Session.
The wildcard DNN is a value that can be used for the DNN field of Subscribed DNN list of Session Management Subscription data defined in clause 5.2.3.3 of TS 23.502 [3].
The wildcard DNN can be used with an S-NSSAI for operator to allow the subscriber to access any Data Network supported within the Network Slice associated with the S-NSSAI.
The subscription data for an UE in UDR may associate the subscriber with groups. A group is identified by an Internal-Group Identifier.
NOTE 1:	A UE can belong to a limited number of groups, the exact number is defined in stage 3 specifications.
NOTE 2:	In this Release of the specification, the support of groups is only defined in non-roaming case.
The Internal-Group Identifier(s) corresponding to an UE are provided by the UDM to the SMF as part Session Management Subscription data and (when PCC applies to a PDU Session) by the SMF to the PCF. The SMF may use this information to apply local policies and to store this information in CDR. The PCF may use this information to enforce AF requests as described in clause 5.6.7.
The Internal-Group Identifier(s) corresponding to an UE are provided by the UDM to the AMF as part of Access and Mobility Subscription data. The AMF may use this information to apply local policies (such as Group specific NAS level congestion control defined in clause 5.19.7.5).
Generic Public Subscription Identifier (GPSI) is needed for addressing a 3GPP subscription in different data networks outside of the 3GPP system. The 3GPP system stores within the subscription data the association between the GPSI and the corresponding SUPI.
GPSIs are public identifiers used both inside and outside of the 3GPP system.
The GPSI is either an MSISDN or an External Identifier, see TS 23.003 [19]. If MSISDN is included in the subscription data, it shall be possible that the same MSISDN value is supported in both 5GS and EPS.
NOTE:	There is no implied 1-to-1 relationship between GPSI and SUPI.
An AMF UE NGAP ID is an identifier used to identify the UE in AMF on N2 reference point. AMF allocates the AMF UE NGAP ID and send it to the 5G-AN. For the following N2 signalling interaction sent from 5G-AN to AMF, AMF UE NGAP ID is used to identify the UE at the AMF. AMF UE NGAP ID is unique per AMF set. AMF UE NGAP ID may be updated without AMF change, or with AMF change as specified at clause 5.21.2.2.
The UE Radio Capability ID is a short pointer with format defined in TS 23.003 [19] that is used to uniquely identify a set of UE Radio Capabilities (excluding UTRAN and NB-IoT capabilities). The UE Radio Capability ID is assigned either by the serving PLMN or by the UE manufacturer, as follows:
-	UE manufacturer-assigned: The UE Radio Capability ID may be assigned by the UE manufacturer in which case it includes a UE manufacturer identification (i.e. a Vendor ID). In this case, the UE Radio Capability ID uniquely identifies a set of UE radio capabilities and the UE Radio Capability for Paging for a UE by this manufacturer in any PLMN.
-	PLMN-assigned: If a UE manufacturer-assigned UE Radio Capability ID is not used by the UE or the serving network, or it is not recognised by the serving PLMN UCMF, the UCMF may allocate UE Radio Capability IDs for the UE corresponding to each different set of UE radio capabilities the PLMN may receive from the UE at different times. In this case, the UE Radio Capability IDs the UE receives are applicable to the serving PLMN and uniquely identify the corresponding sets of UE radio capabilities and and the UE Radio Capability for Paging(s) in this PLMN. The PLMN assigned UE Radio Capability ID includes a Version ID in its format. The value of the Version ID is the one configured in the UCMF, at time the UE Radio Capability ID value is assigned. The Version ID value makes it possible to detect whether a UE Radio Capability ID is current or outdated.
NOTE:	For the case the PLMN is configured to store PLMN assigned IDs in the UE manufacturer-assigned operation requested list defined in clause 5.4.4.1a, then the algorithm for assignment of PLMN-assigned UE Radio Capability ID shall assign different UE Radio Capability IDs for UEs with different TAC value.
The type of UE Radio Capability ID (UE manufacturer-assigned or PLMN-assigned) is distinguished when a UE Radio Capability ID is signalled.
The security features in the 5G System include:
-	Authentication of the UE by the network and vice versa (mutual authentication between UE and network).
-	Security context generation and distribution.
-	User Plane data confidentiality and integrity protection.
-	Control Plane signalling confidentiality and integrity protection.
-	User identity confidentiality.
-	Support of LI requirements as specified in TS 33.126 [35] subject to regional/national regulatory requirements, including protection of LI data (e.g. target list) that may be stored or transferred by an NF.
Detailed security related network functions for 5G are described in TS 33.501 [29].
When a UE is connected via a NG-RAN and via a standalone non-3GPP accesses, the multiple N1 instances are secured using independent NAS security contexts, each created based on the security context in the corresponding SEAF (e.g. in the common AMF when the UE is served by the same AMF) derived from the UE authentication.
The User Plane Security Enforcement information provides the NG-RAN with User Plane security policies for a PDU session. It indicates:
-	whether UP integrity protection is:
-	Required: for all the traffic on the PDU Session UP integrity protection shall apply.
-	Preferred: for all the traffic on the PDU Session UP integrity protection should apply.
-	Not Needed: UP integrity protection shall not apply on the PDU Session.
-	whether UP confidentiality protection is:
-	Required: for all the traffic on the PDU Session UP confidentiality protection shall apply.
-	Preferred: for all the traffic on the PDU Session UP confidentiality protection should apply.
-	Not Needed: UP confidentiality shall not apply on the PDU Session.
User Plane Security Enforcement information applies only over 3GPP access. Once determined at the establishment of the PDU Session the User Plane Security Enforcement information applies for the life time of the PDU Session.
NOTE 1:	Applicability of UP integrity protection of UP Security Enforcement is defined in TS 33.501 [29] and TS 38.300 [27].
The SMF determines at PDU session establishment a User Plane Security Enforcement information for the user plane of a PDU session based on:
-	subscribed User Plane Security Policy which is part of SM subscription information received from UDM; and
-	User Plane Security Policy locally configured per (DNN, S-NSSAI) in the SMF that is used when the UDM does not provide User Plane Security Policy information.
-	The maximum supported data rate per UE for integrity protection for the DRBs, provided by the UE in the Integrity protection maximum data rate IE during PDU Session Establishment. The UE supporting NR as primary RAT, i.e. NG-RAN access via Standalone NR, shall set the Integrity protection maximum data rate IE for Uplink and Downlink to full rate at PDU Session Establishment as defined in TS 24.501 [47]. A UE not supporting NR as primary RAT and supporting E-UTRA connected to 5GC, shall set the Integrity protection maximum data rate IE for Uplink and Downlink to NULL at PDU Session Establishment as defined in TS 24.501 [47].
The User Plane Security Enforcement information provides the MME with User Plane integrity protection policies for the PDU session (PDN Connection). The information indicates whether UP integrity protection is:
-	Required: for all the traffic on the PDU Session (PDN Connection) UP integrity protection shall apply.
-	Preferred: for all the traffic on the PDU Session (PDN Connection) UP integrity protection should apply.
-	Not Needed: UP integrity protection shall not apply on the PDU Session (PDN Connection).
In turn, the MME provides per EPS bearer User Plane Security Enforcement information to the E-UTRAN. All the bearers within a PDN Connection share the same User Plane integrity protection policies.
The UE capability to support user plane integrity protection with EPS is indicated to AMF in the S1 UE network capability information. If the UE supports user plane integrity protection with EPS, and the AMF supports the associated functionality, the AMF indicates this to SMF at PDU Session Establishment using NG-RAN. If the UE and AMF support user plane integrity protection with EPS, for PDU Sessions with UP integrity protection of UP Security Enforcement Information set to Required, the SMF may perform the EPS bearer ID allocation procedure as described in TS 23.502 [3] clause 4.11.1.4. If the UE does not support user plane integrity protection with EPS or the AMF does not support the associated functionality, the SMF shall not trigger the EPS bearer ID allocation procedure in clause 4.11.1.4 of TS 23.502 [3].
Unless the UE, the serving eNB and the MME support user plane integrity protection with EPS, the SMF+PGW-C shall reject a PDN Connection Establishment using EPS if the UP Security Enforcement Information has UP integrity protection set to Required.
The SMF+PGW-C shall (e.g. based on the received RAT Type) reject a PDN Connection Establishment using GERAN/UTRAN if the UP Security Enforcement Information has UP integrity protection set to Required.
NOTE 2:	This assumes that the optional user plane integrity protection for GPRS specified in Release 13 has not been deployed.
The SMF may, based on local configuration, reject the PDU Session Establishment request depending on the value of the maximum supported data rate per UE for integrity protection.
NOTE 3:	Reasons to reject a PDU Session Establishment request can e.g. be that the UP Integrity Protection is determined to be "Required" while the maximum supported data rate per UE for integrity protection is less than the expected required data rate for the DN.
NOTE 4:	The operator can take care to reduce the risk of such rejections when configuring the subscribed User Plane Security Policy for a DNN. For example, the operator may apply integrity protection "Required" only in scenarios where it can be assumed that the UE maximum supported data rate per UE for integrity protection is likely to be adequate for the DN.
The User Plane Security Policy provide the same level of information than User Plane Security Enforcement information.
User Plane Security Policy from UDM takes precedence over locally configured User Plane Security Policy.
The User Plane Security Enforcement information may include the maximum supported data rate for integrity protection provided by the UE, is communicated from SMF to the NG-RAN for enforcement as part of PDU session related information. If the UP Integrity Protection is determined to be "Required" or "Preferred", the SMF also provides the maximum supported data rate per UE for integrity protection as received in the Integrity protection maximum data rate IE. This takes place at establishment of a PDU Session or at activation of the user plane of a PDU Session. The NG-RAN rejects the establishment of UP resources for the PDU Session when it cannot fulfil User Plane Security Enforcement information with a value of Required. The NG-RAN may also take the maximum supported data rate per UE for integrity protection into account in its decision on whether to accept or reject the establishment of UP resources. In this case the SMF releases the PDU Session. The NG-RAN notifies the SMF when it cannot fulfil a User Plane Security Enforcement with a value of Preferred.
NOTE 5:	For example, the NG-RAN cannot fulfil requirements in User Plane Security Enforcement information with UP integrity protection set to "Required" when it cannot negotiate UP integrity protection with the UE.
It is responsibility of the NG-RAN to enforce that the maximum UP integrity protection data rate delivered to the UE in downlink is not exceeding the maximum supported data rate for integrity protection.
It is expected that generally the UP integrity protection data rate applied by the UE in uplink will not exceed the indicated maximum supported data rate, but the UE is not required to perform strict rate enforcement.
User Plane Security Enforcement information and the maximum supported data rate per UE for integrity protection is communicated from source to target NG-RAN node at handover. If the target RAN node cannot support requirements in User Plane Security Enforcement information, the target RAN node rejects the request to set up resources for the PDU Session. In this case the PDU Session is not handed over to the target RAN node and the PDU Session is released.
If the UE or the new eNB or the MME does not indicate support of user plane integrity protection with EPS, PDU Sessions with UP integrity protection of the User Plane Security Enforcement information set to Required are not transferred to EPS as follows:
-	In the case of mobility without N26, the SMF+PGW-C shall reject a PDN connectivity request in EPS with handover indication if the UP integrity protection of the User Plane Security Enforcement is set to Required.
NOTE 6:	As described in clause 5.17.2.3.3, the UE does not know before trying to move a given PDU Session to EPC, whether that PDU session can be transferred to EPC.
-	In the case of idle mode and connected mode mobility with N26 to EPS, or mobility without N26, the SMF+PGW-C ensures that the PDU session is released.
If the UE, target eNB and the target MME indicate support of User Plane Integrity Protection with EPS, PDU Sessions with UP integrity protection of the User Plane Security Enforcement information set to Required are transferred from 5GS to EPS according to existing procedures.
For the bearers of PDN Connections with UP integrity protection set to Required, at (both idle mode and connected mode) mobility (including intra-TA mobility) to an eNB that does not support User Plane Integrity Protection with EPS, the MME shall inform the SMF+PGW-C and the SMF+PGW-C ensures that the PDU session is released.
At connected mode mobility from EPS to GERAN/UTRAN or to a part of the EPS that does not support User Plane Integrity Protection, the source E-UTRAN shall ensure that EPS bearers with UP integrity protection of the User Plane Security Enforcement information set to Required are not handed over.
In the case of idle mode mobility from an MME that supports User Plane Integrity Protection, to an MME that does not support User Plane Integrity Protection, the (home) SMF+PGW-C shall trigger (e.g. based on the lack of MME UPIP capability information) the release of the bearers of PDN Connections with UP integrity protection set to Required.
At any (e.g. idle mode) mobility from EPS to GERAN/UTRAN, the (home) SMF+PGW-C shall trigger (e.g. based on the received RAT Type) the release of the bearers of PDN Connections with UP integrity protection set to Required.
PDU Sessions with UP confidentiality protection of the User Plane Security Enforcement information set to Required and UP integrity protection of the User Plane Security Enforcement information not set to Required, are allowed to be handed over to EPS regardless of how UP confidentiality protection applies in EPS.
In the case of dual connectivity, the Integrity Protection is set to "Preferred", the Master NG-RAN node may notify the SMF when it cannot fulfil a User Plane Security Enforcement with a value of Preferred. The SMF handling of the PDU session with respect to the Integrity Protection status is up to SMF implementation decision.
Dual Connectivity involves two radio network nodes in providing radio resources to a given UE (with active radio bearers), while a single N2 termination point exists for the UE between an AMF and the RAN. The RAN architecture and related functions to support Dual Connectivity is further described in RAN specifications (e.g. TS 37.340 [31]).
In this Release of the specification, the Dual Connectivity function does not apply to the NR RedCap UE.
The RAN node at which the N2 terminates, performs all necessary N2 related functions such as mobility management, relaying of NAS signalling, etc. and manages the handling of user plane connection (e.g. transfer over N3). It is called the Master RAN Node. It may use resources of another RAN node, the Secondary RAN node, to exchange User Plane traffic of an UE. Master RAN node takes into account the RSN and/or PDU Session Pair ID to determine if dual connectivity shall be set up and ensure appropriate PDU session handling ensures fully redundant user plane path as described in clause 5.33.2.1.
If the UE has Mobility Restriction (either signalled from the UDM, or, locally generated by the Serving PLMN policy in the AMF) the AMF signals these restrictions to the Master RAN Node as Mobility Restriction List; This may prevent the Master RAN node from setting up a Dual Connectivity for an UE.
NOTE 1:	Subject to policies in the NG-RAN, configuration of Dual Connectivity for a Data Radio Bearer can also be based on the Network Slice that the PDU Session belongs to.
Dual Connectivity provides the possibility for the Master node RAN to request SMF:
-	For some or all PDU Sessions of an UE: Direct all the DL User Plane traffic of the PDU Session to the either the Master RAN Node or to the Secondary RAN Node. In this case, there is a single N3 tunnel termination at the RAN for such PDU Session.
NOTE 2:	The terminating RAN Node, can decide to keep traffic for specific QFI(s) in a PDU Session for a UE on a single RAT, or split them across the two RATs.
-	For some other PDU Sessions of an UE: Direct the DL User Plane traffic of some QoS Flows of the PDU Session to the Secondary (respectively Master) RAN Node while the remaining QoS Flows of the PDU Session are directed to the Master (respectively Secondary) RAN Node. In this case there are, irrespective of the number of QoS Flows, two N3 tunnel terminations at the RAN for such PDU Session.
The Master RAN may create and change this assignment for the user plane of a PDU Session at any time during the life time of the PDU Session;
In both cases, a single PDU Session Id is used to identify the PDU Session.
Additional functional characteristics are:
-	User location information is based on the identity of the cell that is serving the UE in the Master RAN node. The cell identity of the Primary cell in the secondary RAN node may also be included. NG-RAN includes the user location information in NGAP messages where the contents of the user location information may change during the corresponding procedure.
-	Path update signalling related with Dual Connectivity and UPF re-allocation cannot occur at the same time.
5GC supports interactions towards CHF for network resource usage, as defined in TS 32.240 [41]. The CHF and the Nchf service are defined in TS 32.290 [67].
The SMF supports the interactions towards the CHF, as defined in TS 32.255 [68]. The UPF supports functionality to collect and report usage data to SMF. The N4 reference point supports the SMF control of the UPF collection and reporting of usage data.
The AMF supports interactions towards the CHF, as defined in TS 32.256 [114].
The SMSF supports interactions towards the CHF, as defined in TS 32.274 [118].
The NEF supports interactions towards the CHF, as defined in TS 32.254 [123].
When NG-RAN is deployed in dual connectivity configuration, the HPLMN or VPLMN operator may wish to record the data volume sent and received on the Secondary RAT.
In order to reduce the complexity of this procedure, the following principles are used in this release:
a)	The PLMN locally activates the Secondary RAT Usage Data Reporting by NG-RAN OAM. The activation is based on configuration in NG-RAN and NG-RAN determines whether the data volume report will contain data volumes consumed for the whole PDU Session or for selected QoS Flows or both as described in TS 38.413 [34].
	The activation can happen separately for Data Volume Reporting of NR in licensed or unlicensed spectrum and E-UTRA in licensed or unlicensed spectrum. If the PLMN uses this feature, it should ensure that this functionality is supported by all NG-RAN nodes that support NR or E-UTRA as a Secondary RAT.
b)	Depending on its configuration the NG-RAN reports uplink and downlink data volumes to the 5GC for the Secondary RAT (including the using of unlicensed spectrum for NR or E-UTRA) for the PDU Session or for selected QoS Flows or both and per time interval.
c)	During Xn handover and N2 handover, the source NG-RAN node reports the data volume to the 5GC. The reported data volume excludes data forwarded to the target RAN node.
d)	At the time of NG connection release, Secondary Node change/release, deactivation of UP connection for a PDU Session, the NG-RAN node reports the data volumes to the 5GC.
e)	To assist "partial CDR" generation, NG-RAN OAM can instruct the NG-RAN to also make periodic reports (as described in clause 5.12.3) if no event has triggered a report before the period expires.
NOTE 2:	The timing of these periodic NG-RAN reports is not expected to align with the timing of partial CDR generation. Hence the frequency of NG-RAN reports might be greater than that of partial CDR generation.
NOTE 3:	RAN needs to be able to partition the measurements in a report to indicate usage that occurred before and after an absolute time. An example of the absolute time is that RAN is configured to partition data usage reports that occurred before and after midnight.
Periodic reporting of the Secondary RAT usage data is an optional function. When NG-RAN, as defined in bullet e) of clause 5.12.12, is configured with a "time interval for Secondary RAT usage data reporting", the NG-RAN shall send a RAN Usage Data Report message for periodic reporting purposes to the SMF only when the timer expires for a UE for which Secondary RAT usage data reporting is ongoing. The timer runs from the last usage reporting for the UE.
Edge computing enables operator and 3rd party services to be hosted close to the UE's access point of attachment, so as to achieve an efficient service delivery through the reduced end-to-end latency and load on the transport network. Edge Computing support by 5GC is specified in this specification and in TS 23.548 [130].
NOTE: Edge Computing typically applies to non-roaming and LBO roaming scenarios. For HR roaming scenarios, Edge Computing applies only for "Home Routed with Session Breakout in VPLMN (HR-SBO)" which is described in clause 6.7 of TS 23.548 [130].
The 5G Core Network selects a UPF close to the UE and forwards traffic to enable the local access to the DN via a N6 interface according to the provided traffic steering rules to the UPF. This may be based on the UE's subscription data, UE location, the information from Application Function (AF) as defined in clause 5.6.7, the EAS information reported from EASDF (as defined in TS 23.548 [130]), policy or other related traffic rules.
Due to user or Application Function mobility, the service or session continuity may be required based on the requirements of the service or the 5G network.
The 5G Core Network may expose network information and capabilities to an Edge Computing Application Function.
NOTE:	Depending on the operator deployment, certain Application Functions can be allowed to interact directly with the Control Plane Network Functions with which they need to interact, while the other Application Functions need to use the external exposure framework via the NEF (see clause 6.2.10 for details).
Edge computing can be supported by one or a combination of the following enablers:
-	User plane (re)selection: the 5G Core Network (re)selects UPF to route the user traffic to the local part of the DN as described in clause 6.3.3;
-	Local Routing and Traffic Steering: the 5G Core Network selects the traffic to be routed to the applications in the local part of the DN;
-	this includes the use of a single PDU Session with multiple PDU Session Anchor(s) (UL CL / IP v6 multi-homing) as described in clause 5.6.4 and the use of a PDU Session with Distributed Anchor Point using SSC mode 2/3.
-	Session and service continuity to enable UE and application mobility as described in clause 5.6.9;
-	An Application Function may influence UPF (re)selection and traffic routing via PCF or NEF as described in clause 5.6.7;
-	Network capability exposure: 5G Core Network and Application Function to provide information to each other via NEF as described in clause 5.20 or directly as described in clause 4.15 of TS 23.502 [3] or from the UPF as described in clause 6.4 of TS 23.548 [130];
-	QoS and Charging: PCF provides rules for QoS Control and Charging for the traffic routed to the local part of the DN;
-	Support of Local Area Data Network: 5G Core Network provides support to connect to the LADN in a certain area where the applications are deployed as described in clause 5.6.5.
-	Discovery and re-discovery of Edge Applications Servers as described in TS 23.548 [130].
-	Support of Edge Relocation as described in TS 23.548 [130] and the case of involving AF change as described in clauses 4.3.6.2, 4.3.6.3 and 4.3.6.4 of TS 23.502 [3]. Support of 5GC triggered Edge relocation within the same hosting PLMN's EHEs.
-	Support of (I-)SMF (re)selection based on DNAI as described in clauses 4.3.5.1, 4.3.5.2 and 4.23.5.1 of TS 23.502 [3].
-	Support of finer sets of UEs.
-	Support of common EAS discovery and common DNAI determination for set of UEs as described in clause 6.2 of TS 23.548 [130].
-	Support of mapping information between EAS IP/IP range and DNAI as described in clause 6.8 of TS 23.548 [130].
-	Support of AF request for DNAI as described in clause 6.8 of TS 23.548 [130].
The policy and charging control framework for the 5G System is defined in TS 23.503 [45].
A Network Slice instance is defined within a PLMN or within an SNPN and shall include:
-	the Core Network Control Plane and User Plane Network Functions, as described in clause 4.2,
and, in the serving PLMN, at least one of the following:
-	the NG-RAN described in TS 38.300 [27];
-	the N3IWF or TNGF functions to the non-3GPP Access Network described in clause 4.2.8.2 or the TWIF functions to the trusted WLAN in the case of support of N5CW devices described in clause 4.2.8.5;
-	the W-AGF function to the Wireline Access Network described in clause 4.2.8.4.
The 5G System deployed in a PLMN shall always support the procedures, information and configurations specified to support Network Slice instance selection in the present document, TS 23.502 [3] and TS 23.503 [45].
NOTE 1:	Management of network slices are described in TS 28.530 [175], the procedures for provisioning of networks and network slices are described in TS 28.531 [176] and TS 28.541 [149] describes the resource model for managing the resources.
Network slicing support for roaming is described in clause 5.15.6.
Network slices may differ for supported features and network functions optimisations, in which case such Network Slices may have e.g. different S-NSSAIs with different Slice/Service Types (see clause 5.15.2.1). The operator can deploy multiple Network Slices delivering exactly the same features but for different groups of UEs, e.g. as they deliver a different committed service and/or because they are dedicated to a customer, in which case such Network Slices may have e.g. different S-NSSAIs with the same Slice/Service Type but different Slice Differentiators (see clause 5.15.2.1).
The network may serve a single UE with one or more Network Slice instances simultaneously via a 5G-AN regardless of the access type(s) over which the UE is registered (i.e. 3GPP Access and/or N3GPP Access). The AMF instance serving the UE logically belongs to each of the Network Slice instances serving the UE, i.e. this AMF instance is common to the Network Slice instances serving a UE.
NOTE 2:	Number of simultaneous connection of Network Slice instances per UE is limited by the number of S-NSSAIs in the Requested/Allowed NSSAI as described in clause 5.15.2.1.
NOTE 3:	In this Release of the specification it is assumed that in any (home or visited) PLMN it is always possible to select an AMF that can serve any combination of S-NSSAIs that will be provided as an Allowed NSSAI.
The selection of the set of Network Slice instances for a UE is triggered by the first contacted AMF in a Registration procedure normally by interacting with the NSSF, and can lead to a change of AMF. This is further described in clause 5.15.5.
A PDU Session belongs to one and only one specific Network Slice instance per PLMN. Different Network Slice instances do not share a PDU Session, though different Network Slice instances may have slice-specific PDU Sessions using the same DNN.
During the Handover procedure the source AMF selects a target AMF by interacting with the NRF as specified in clause 6.3.5.
Network Slice-Specific Authentication and Authorization (NSSAA) enables Network Slice specific authentication as described in clause 5.15.10.
Network Slice Admission Control (NSAC) controls the number of registered UEs per network slice, the number of UEs with at least one PDU Session/PDN Connection per network slice in the case of EPC interworking and the number of PDU Sessions per network slice as described in clause 5.15.11.
Support of subscription-based restrictions to simultaneous registration of network slices uses Network Slice Simultaneous Registration Group (NSSRG) information to enable control of which Network Slices that can be registered simultaneously by a UE as described in clause 5.15.12.
Support of data rate limitation per Network Slice for a UE enables enforcement of Maximum Bit Rate per Network Slice for a UE as described in clause 5.15.13.
The selection of N3IWF/TNGF supporting a set of slice(s) is described in clause 6.3.6 and clause 6.3.12 respectively.
The support of Network Slice usage control is described in clause 5.15.15.
Support of Optimized handling of temporarily available network slices is described in clause 5.15.16. It also covers aspects related to graceful release of network slices connectivity during slice decommissioning.
The Partial Network Slice support in a Registration Area is described in clause 5.15.17.
Support for Network Slices with Network Slice Area of Service not matching deployed Tracking Areas is described in clause 5.15.18.
Support of Network Slice Replacement is described in clause 5.15.19.
An S-NSSAI identifies a Network Slice.
An S-NSSAI is comprised of:
-	A Slice/Service type (SST), which refers to the expected Network Slice behaviour in terms of features and services;
-	A Slice Differentiator (SD), which is optional information that complements the Slice/Service type(s) to differentiate amongst multiple Network Slices of the same Slice/Service type.
An S-NSSAI can have standard values (i.e. such S-NSSAI is only comprised of an SST with a standardised SST value, see clause 5.15.2.2, and no SD) or non-standard values (i.e. such S-NSSAI is comprised of either both an SST and an SD or only an SST without a standardised SST value and no SD). An S-NSSAI with a non-standard value identifies a single Network Slice within the PLMN with which it is associated. An S-NSSAI with a non-standard value shall not be used by the UE in access stratum procedures in any PLMN other than the one to which the S-NSSAI is associated.
The S-NSSAIs in the NSSP of the URSP rules (see clause 6.6.2 of TS 23.503 [45]) and in the Subscribed S-NSSAIs (see clause 5.15.3) contain only HPLMN S-NSSAI values.
The S-NSSAIs in the Configured NSSAI, the Allowed NSSAI (see clause 5.15.4.1), the Requested NSSAI (see clause 5.15.5.2.1), the Rejected S-NSSAIs contain only values from the Serving PLMN. The Serving PLMN can be the HPLMN or a VPLMN.
The S-NSSAI(s) in the PDU Session Establishment contain one Serving PLMN S-NSSAI value and in addition may contain a corresponding HPLMN S-NSSAI value to which this first value is mapped (see clause 5.15.5.3). Further information for slice replacement is described in clause 5.15.19.
The optional mapping of Serving PLMN S-NSSAIs to HPLMN S-NSSAIs contains Serving PLMN S-NSSAI values and corresponding mapped HPLMN S-NSSAI values.
The NSSAI is a collection of S-NSSAIs. An NSSAI may be a Configured NSSAI, a Requested NSSAI, Allowed NSSAI or a Partially Allowed NSSAI. There can be at most eight S-NSSAIs in Allowed NSSAI and Requested NSSAI sent in signalling messages between the UE and the Network. There can be at most seven S-NSSAIs in the Partially Allowed NSSAI and at most seven S-NSSAIs rejected partially in the RA, and the sum of S-NSSAIs in the Allowed NSSAI, and the Partially Allowed NSSAI shall be at most eight. The Requested NSSAI signalled by the UE to the network allows the network to select the Serving AMF, Network Slice(s) and Network Slice instance(s) for this UE, as specified in clause 5.15.5.
NOTE 1:	There can be at most a maximum of seven S-NSSAIs in the Partially Allowed NSSAI since there will always be an Allowed NSSAI allocated.
Based on the operator's operational or deployment needs, a Network Slice instance can be associated with one or more S-NSSAIs, and an S-NSSAI can be associated with one or more Network Slice instances. Multiple Network Slice instances associated with the same S-NSSAI may be deployed in the same or in different Tracking Areas. When multiple Network Slice instances associated with the same S-NSSAI are deployed in the same Tracking Areas, the AMF instance serving the UE may logically belong to (i.e. be common to) more than one Network Slice instance associated with this S-NSSAI.
In a PLMN, when an S-NSSAI is associated with more than one Network Slice instance, one of these Network Slice instances, as a result of the Network Slice instance selection procedure defined in clause 5.15.5, serves a UE that is allowed to use this S-NSSAI. For any S-NSSAI, the network may at any one time serve the UE with only one Network Slice instance associated with this S-NSSAI until cases occur where e.g. this Network Slice instance is no longer valid in a given Registration Area, or a change in UE's Allowed NSSAI occurs, etc. In such cases, procedures mentioned in clause 5.15.5.2.2 or clause 5.15.5.2.3 apply.
Based on the Requested NSSAI (if any) and the Subscription Information, the 5GC is responsible for selection of a Network Slice instance(s) to serve a UE including the 5GC Control Plane and User Plane Network Functions corresponding to this Network Slice instance(s). The Subscription Information may contain restrictions to the simultaneous registration of network slices. This is provided to the serving AMF as part of the UE subscription, in the form of Network Slice Simultaneous Registration Group (NSSRG) information (see clause 5.15.12).
The (R)AN may use Requested NSSAI in access stratum signalling to handle the UE Control Plane connection before the 5GC informs the (R)AN of the Allowed NSSAI. The Requested NSSAI is used by the RAN for AMF selection, as described in clause 6.3.5. The UE shall not include the Requested NSSAI in the RRC Resume when the UE asks to resume the RRC connection and is CM-CONNECTED with RRC_INACTIVE state.
When a UE is successfully registered over an Access Type, the CN informs the (R)AN by providing the Allowed NSSAI for the corresponding Access Type.
NOTE 2:	The details of how the RAN uses NSSAI information are described in TS 38.300 [27].
Standardized SST values provide a way for establishing global interoperability for slicing so that PLMNs can support the roaming use case more efficiently for the most commonly used Slice/Service Types.
The SSTs which are standardised are in the following Table 5.15.2.2-1.
Table 5.15.2.2-1: Standardised SST values

NOTE 1:	The support of all standardised SST values is not required in a PLMN. Services indicated in this table for each SST value can also be supported by means of other SSTs.
NOTE 2:	A mapping of GSMA defined Network Slice Types (NEST) to standard SST values is defined in GSMA NG.116 [137].
The Subscription Information shall contain one or more S-NSSAIs i.e. Subscribed S-NSSAIs. The subscription information shall include at least one default S-NSSAI. The UDM sends at the most 16 Subscribed S-NSSAIs to AMF, i.e. the number that can fit in a Configured NSSAI. The subscription information the UDM sends to the AMF shall include at least one default S-NSSAI.
If an S-NSSAI is marked as default, then the network is expected to serve the UE with a related applicable Network Slice instance when the UE does not send any permitted S-NSSAI to the network in a Registration Request message as part of the Requested NSSAI.
The Subscription Information for each S-NSSAI may contain:
-	a Subscribed DNN list and one default DNN; and
-	the indication whether the S-NSSAI is marked as default Subscribed S-NSSAI; and
-	the indication whether the S-NSSAI is subject to Network Slice-Specific Authentication and Authorization; and
-	Network Slice Simultaneous Usage Group (NSSRG) information (see clause 5.15.12).
The network verifies the Requested NSSAI the UE provides in the Registration Request against the Subscription Information. For the S-NSSAIs subject to Network Slice-Specific Authentication and Authorization the clause 5.15.10 applies.
NOTE 1:	It is recommended that at least one of the Subscribed S-NSSAIs marked as default S-NSSAI is not subject to Network Slice-specific Authentication and Authorization, in order to ensure access to services even when Network Slice-specific Authentication and Authorization fails.
NOTE 2:	It is recommended to minimize the number of Subscribed S-NSSAIs in subscriptions for NB-IoT or NR RedCap capable UEs to minimize overhead for signalling a large number of S-NSSAIs in Requested NSSAI in RRC and NAS via NB-IoT or NR RedCap.
In roaming case, the UDM shall provide to the VPLMN only the S-NSSAIs from the Subscribed S-NSSAIs the HPLMN allows for the UE in the VPLMN. If the UE is subject to restrictions of simultaneous registration of network slices (i.e. if the Subscription Information for the S-NSSAIs contains NSSRG information), the UDM provides to the VPLMN a subscribed S-NSSAIs and, if applicable, NSSRG information, as described in clause 5.15.12.
NOTE 3:	Network slice instances supporting an S-NSSAI subject to Network Slice-Specific Authentication and Authorization need to be deployed with AMFs supporting Network Slice-Specific Authentication and Authorization, otherwise S-NSSAIs requiring Network Slice-Specific Authentication and Authorization would be incorrectly allowed without execution of Network Slice-Specific Authentication and Authorization.
NOTE 4:	Network slice instances supporting an S-NSSAI subject to Network Slice Admission Control (NSAC) for number of registered UE per network slice need to be deployed with AMFs supporting NSAC, otherwise S-NSSAIs requiring NSAC would be incorrectly allowed without execution of NSAC.
When the UDM updates the Subscribed S-NSSAI(s) to the serving AMF, based on configuration in this AMF, the AMF itself or the NSSF determines the mapping of the Configured NSSAI for the Serving PLMN and/or Allowed NSSAI to the Subscribed S-NSSAI(s). The serving AMF then updates the UE with the above information as described in clause 5.15.4.
The Network Slice configuration information contains one or more Configured NSSAI(s). A Configured NSSAI may either be configured by a Serving PLMN and apply to the Serving PLMN, or may be a Default Configured NSSAI configured by the HPLMN and that applies to any PLMNs for which no specific Configured NSSAI has been provided to the UE. There is at most one Configured NSSAI per PLMN.
NOTE 1:	The value(s) used in the Default Configured NSSAI are expected to be commonly decided by all roaming partners, e.g. by the use of values standardized by 3GPP or other bodies.
The Default Configured NSSAI, if it is configured in the UE, is used by the UE in a Serving PLMN only if the UE has no Configured NSSAI for the Serving PLMN.
The Configured NSSAI of a PLMN may include S-NSSAIs that have standard values or PLMN-specific values.
The Configured NSSAI for the Serving PLMN includes the S-NSSAI values which can be used in the Serving PLMN and may be associated with mapping of each S-NSSAI of the Configured NSSAI to one or more corresponding HPLMN S-NSSAI values. In the non-roaming case, the network shall not provide any mapped S-NSSAI to the UE with the Configured NSSAI. In the roaming case, the AMF shall provide to the UE the mapping of each S-NSSAI of the Configured NSSAI for the Serving PLMN to the corresponding S-NSSAI values of the HPLMN when providing NSSAI information, as described in TS 24.501 [47].
A UE subscription may contain Network Slice Simultaneous Registration Group (NSSRG) information. If so, the UE configuration is performed as described in clause 5.15.12.2.
The UE may be pre-configured with the Default Configured NSSAI. The UE may be provisioned/updated with the Default Configured NSSAI, determined by the UDM in the HPLMN, using the UE Parameters Update via UDM Control Plane procedure defined in clause 4.20 of TS 23.502 [3]. Each S-NSSAI in the Default Configured NSSAI may have a corresponding S-NSSAI as part of the Subscribed S-NSSAI(s). Consequently, if the Subscribed S-NSSAI(s) which are also present in the Default Configured NSSAI are updated the UDM should update the Default Configured NSSAI in the UE.
In the HPLMN, the S-NSSAIs in the Configured NSSAI provided as described in clause 5.15.4.2, at the time when they are provided to the UE, shall match the Subscribed S-NSSAIs for the UE.
When the Subscribed S-NSSAI(s) are updated (i.e. some existing S-NSSAIs are removed and/or some new S-NSSAIs are added) and one or more are applicable to the Serving PLMN the UE is registered in, as described in clause 5.15.3, or when the associated mapping is updated the AMF shall update the UE with the Configured NSSAI for the Serving PLMN and/or Allowed NSSAI and Partially Allowed NSSAI and/or the associated mapping to HPLMN S-NSSAIs (see clause 5.15.4.2). When there is the need to update the Allowed NSSAI or Partially Allowed NSSAI, the AMF shall provide the UE with the new Allowed NSSAI or Partially Allowed NSSAI and the associated mapping to HPLMN S-NSSAIs, unless the AMF cannot determine the new Allowed NSSAI (e.g. all S-NSSAIs in the old Allowed NSSAI have been removed from the Subscribed S-NSSAIs), in which case the AMF shall not send any Allowed NSSAI to the UE but indicate to the UE to perform a Registration procedure. If the UE is in a CM-IDLE state, the AMF may trigger Network Triggered Service Request or wait until the UE is in a CM-CONNECTED state as described in clause 4.2.4.2, TS 23.502 [3].
When providing a Requested NSSAI to the network upon registration, the UE in a given PLMN only includes and uses S-NSSAIs applying to this PLMN. The mapping of S-NSSAIs of the Requested NSSAI to HPLMN S-NSSAIs may also be provided (see clause 5.15.4.1.2 for when this is needed). The S-NSSAIs in the Requested NSSAI are part of the Configured and/or Allowed NSSAIs applicable for this PLMN, when they are available. If the UE has received NSSRG information together with the Configured NSSAI, it only includes in the Requested NSSAI S-NSSAIs that all share a common NSSRG. If the UE has stored Pending NSSAI and the UE is still interested in the Pending NSSAI then all the S-NSSAIs in the Requested NSSAI and the Pending S-NSSAI shall share a common NSSRG. If no Configured NSSAI and Allowed NSSAI for the PLMN are available, the S-NSSAIs in the Requested NSSAI correspond to the Default Configured NSSAI, if configured in the UE. Upon successful completion of a UE's Registration procedure over an Access Type, the UE obtains from the AMF an Allowed NSSAI or Partially Allowed NSSAI for this Access Type, which includes one or more S-NSSAIs and, if needed (see clause 5.15.4.1.2 for when this is needed), their mapping to the HPLMN S-NSSAIs. These S-NSSAIs are valid for the current Registration Area and Access Type provided by the AMF the UE has registered with and can be used simultaneously by the UE (up to the maximum number of simultaneous Network Slice instances or PDU Sessions).
The UE might also obtain from the AMF, one or more rejected S-NSSAIs with cause and validity of rejection. An S-NSSAI may be rejected:
-	for the entire PLMN;
-	for the current Registration Area; or
-	partially in the current Registration Area. Such S-NSSAI rejected partially in the current Registration area is associated with a list of TAs where the S-NSSAI is supported.
The AMF may also reject the use of an S-NSSAI due to congestion as described in clause 5.19.7.4.
While the UE remains RM-REGISTERED in the PLMN and regardless of the Access Type, the UE shall not re-attempt to register to an S-NSSAI rejected for the entire PLMN until this rejected S-NSSAI is deleted as specified below.
While the UE remains RM-REGISTERED in the PLMN, the UE shall not re-attempt to register to an S-NSSAI rejected in the current Registration Area until it moves out of the current Registration Area.
While the UE remains RM-REGISTERED in the PLMN, the UE shall not re-attempt to register to an S-NSSAI rejected partially in the RA until the UE moves into a TA which is in the list of TAs where the S-NSSAI is supported.
NOTE 2:	The details and more cases of S-NSSAI rejection are described in TS 24.501 [47].
S-NSSAIs that the UE provides in the Requested NSSAI which are neither in the Allowed NSSAI nor in the Partially Allowed NSSAI, nor provided as a rejected S-NSSAI, shall, by the UE, not be regarded as rejected, i.e. the UE may request to register these S-NSSAIs again next time the UE sends a Requested NSSAI.
The UE stores (S-)NSSAIs as follows:
-	When provisioned with a Configured NSSAI for a PLMN and/or a mapping of Configured NSSAI to HPLMN S-NSSAIs and possibly NSSRG information for each S-NSSAI in the Configured NSSAI (if applicable and supported by the UE), or when requested to remove the configuration due to network slicing subscription change, the UE shall:
-	replace any stored (old) Configured NSSAI for this PLMN with the new Configured NSSAI for this PLMN (if applicable); and
-	delete any stored associated mapping of this old Configured NSSAI for this PLMN to HPLMN S-NSSAIs and, if present and applicable, store the mapping of Configured NSSAI to HPLMN S-NSSAIs; and
-	delete any stored associated NSSRG information for each S-NSSAI of the Configured NSSAI and, if present, store the associated NSSRG information for each S-NSSAI of the Configured NSSAI; and
-	delete any stored rejected S-NSSAI for this PLMN;
-	keep the received Configured NSSAI for a PLMN (if applicable) and associated mapping to HPLMN S-NSSAIs (if applicable) and associated NSSRG information for each S-NSSAI of the Configured NSSAI (if applicable and supported by the UE) stored in the UE, even when registering in another PLMN, until a new Configured NSSAI for this PLMN and/or associated mapping are provisioned in the UE, or until the network slicing subscription changes, as described in clause 5.15.4.2. The number of Configured NSSAIs and associated mapping to be kept stored in the UE for PLMNs other than the HPLMN is up to UE implementation. A UE shall at least be capable of storing a Configured NSSAI for the serving PLMN including any necessary mapping of the Configured NSSAI for the Serving PLMN to HPLMN S-NSSAIs and the Default Configured NSSAI.
-	The Allowed NSSAI received in a Registration Accept message or a UE Configuration Update Command applies to a PLMN when at least a TAI of this PLMN is included in the RA/TAI list included in this Registration Accept message or UE Configuration Update Command. If the UE Configuration Update Command contains an Allowed NSSAI but not a TAI List, then the last received RA/TAI list applies for the decision on which PLMN(s) the Allowed NSSAI is applicable. If received, the Allowed NSSAI for a PLMN and Access Type and any associated mapping of this Allowed NSSAI to HPLMN S-NSSAIs shall be stored in the UE. The UE should store this Allowed NSSAI and any associated mapping of this Allowed NSSAI to HPLMN S-NSSAIs also when the UE is turned off, or until the network slicing subscription changes, as described in clause 5.15.4.2:
NOTE 3:	Whether the UE stores the Allowed NSSAI and any associated mapping of the Allowed NSSAI to HPLMN S-NSSAIs also when the UE is turned off is left to UE implementation.
-	When a new Allowed NSSAI for a PLMN and any associated mapping of the Allowed NSSAI to HPLMN S-NSSAIs are received over an Access Type, the UE shall:
-	replace any stored (old) Allowed NSSAI and any associated mapping for these PLMN and Access Type with this new Allowed NSSAI; and
-	delete any stored associated mapping of this old Allowed NSSAI for this PLMN to HPLMN S-NSSAIs and, if present, store the associated mapping of this new Allowed NSSAI to HPLMN S-NSSAIs;
-	If received, a Partially Allowed NSSAI received in a Registration Accept message or a UE Configuration Update Command message applies to the current Registration Area. The UE stores the Partially Allowed NSSAI in the same way as described for the Allowed NSSAI (see also clause 5.15.17).
-	If received, an S-NSSAI rejected for the entire PLMN shall be stored in the UE while RM-REGISTERED in this PLMN regardless of the Access Type or until it is deleted.
-	If received, an S-NSSAI rejected for the current Registration Area shall be stored in the UE while RM-REGISTERED until the UE moves out of the current Registration Area or until the S-NSSAI is deleted.
-	If received, an S-NSSAI rejected partially in the RA shall be stored in the UE while RM-REGISTERED until the UE moves out of the current Registration Area or until the S-NSSAI is deleted (see also clause 5.15.17).
NOTE 4:	The storage aspects of rejected S-NSSAIs are described in TS 24.501 [47].
-	If received, the Pending NSSAI shall be stored in the UE as described in TS 24.501 [47].
-	If received, the S-NSSAI validity time information shall be stored in the UE in the UE as described in TS 24.501 [47].
-	If received, the S-NSSAI location availability information shall be stored in the UE as described in TS 24.501 [47].
-	If received, the mapping of old S-NSSAI to the Alternative S-NSSAI shall be stored in the UE as described in TS 24.501 [47].
UE configuration to guide UE selection of a N3IWF/TNGF that supports the S-NSSAIs needed by the UE is defined in clause 6.3.6 and clause 6.3.12 respectively.
For the roaming case, one or more S-NSSAIs in an Allowed NSSAI provided to the UE can have values which are not part of the UE's current Network Slice configuration information for the Serving PLMN. In this case, the network provides the Allowed NSSAI together with the mapping of each S-NSSAI of the Allowed NSSAI to the corresponding S-NSSAI of the HPLMN. This mapping information allows the UE to associate Applications to S-NSSAIs of the HPLMN as per NSSP of the URSP rules or as per the UE Local Configuration, as defined in clause 6.1.2.2.1 of TS 23.503 [45] and to the corresponding S-NSSAI from the Allowed NSSAI.
In the non-roaming case, the network shall not provide any mapped S-NSSAI to the UE with the Allowed NSSAI.
In roaming case, the UE shall provide in the Requested NSSAI the mapping of S-NSSAIs of the Serving PLMN values to the corresponding S-NSSAI values of the HPLMN, for each S-NSSAI in the Requested NSSAI for which a mapping is available. These values are found in the mapping previously received from the Serving PLMN of the S-NSSAIs of the Configured NSSAI for the Serving PLMN or of the S-NSSAIs of the Allowed NSSAI for the Serving PLMN and Access Type to the corresponding S-NSSAIs values used in the HPLMN.
If the AMF provides Partially Allowed NSSAI to the UE, in roaming case the AMF may provide the mapping information of each S-NSSAI of the Partially Allowed NSSAI to the corresponding HPLMN S-NSSAI as described in clause 5.15.17.
At any time, the AMF may provide the UE with a new Configured NSSAI for the Serving PLMN, associated with mapping of the Configured NSSAI to HPLMN S-NSSAIs as specified in clause 5.15.4.1. The Configured NSSAI for the Serving PLMN and the mapping information is either determined in the AMF (if based on configuration, the AMF is allowed to determine the Network Slice configuration for the whole PLMN) or by the NSSF. The AMF provides an updated Configured NSSAI as specified in clause 4.2.4 of TS 23.502 [3], UE Configuration Update procedure.
If an S-NSSAI is to be stopped to be used, e.g. due to the network slice is to be deleted as described in TS 28.541 [149], the AMFs may reject UE requests for the S-NSSAI based on the OAM state before the network slice becomes unavailable. The AMF may based on operator policies (e.g. when there is no timing information related to the termination or the AMF or UE does not support the timing information as described in in clause 5.15.16), release PDU Sessions associated with the S-NSSAI, and remove the S-NSSAI from e.g. the Allowed NSSAI and the Configured NSSAI before the Network Slice becomes unavailable. The AMF may use the timing information as described in clause 5.15.16 if it supports this feature and set validity time of the S-NSSAI accordingly.
The AMF shall provide the UE with NSSRG information alongside the Configured NSSAI if NSSRG information is included in the subscription information received from the UDM and if the UE has indicated support for the feature as part of the registration request, see clause 5.15.12.
The AMF may provide the UE with the mapping of old S-NSSAI to the Alternative S-NSSAI if the UE has indicated support for the feature as part of the registration request, see clause 5.15.19.
If the HPLMN performs the configuration update of a UE registered in the HPLMN (e.g. due to a change in the Subscribed S-NSSAI(s) or due to a change of NSSRG information), this results in updates to the Configured NSSAI for the HPLMN and, if applicable, NSSRG information for each S-NSSAI of the Configured NSSAI. Updates to the Allowed NSSAI and/or, if present, to the associated mapping of the Allowed NSSAI to HPLMN S-NSSAIs are also possible if the configuration update affects S-NSSAI(s) in the current Allowed NSSAI.
If the VPLMN performs the configuration update of a UE registered in the VPLMN (e.g. due to a change in the Subscribed S-NSSAI(s), the associated mapping is updated, or due to a change of NSSRG information), this results in updates to the Configured NSSAI for the Serving PLMN and/or to the associated mapping of the Configured NSSAI for the Serving PLMN to HPLMN S-NSSAIs and, if applicable, NSSRG information for each S-NSSAI of the Configured NSSAI. Updates to the Allowed NSSAI and/or to the associated mapping of the Allowed NSSAI to HPLMN S-NSSAIs are also possible if the configuration update affects S-NSSAI(s) in the current Allowed NSSAI.
A UE for which the Configured NSSAI for the Serving PLMN has been updated as described in clause 5.15.4.1 and has been requested to perform a Registration procedure, shall initiate a Registration procedure to receive a new valid Allowed NSSAI (see clause 5.15.5.2.2).
When the subscribed S-NSSAIs change, a UDR flag is set in the HPLMN to make sure the current PLMN (or, if the UE was not reachable, the next serving PLMN) is informed by the UDM that the subscription data for network slicing has changed. The AMF, when it receives the indication from the UDM subscription has changed, indicates the UE that subscription has changed and uses any updated subscription information from the UDM to update the UE. Once the AMF updates the UE and obtains an acknowledgment from the UE, the AMF informs the UDM that the configuration update was successful and the UDM clears the flag in the UDR. If the UE is in a CM-IDLE state, the AMF may trigger Network Triggered Service Request or wait until the UE is in a CM-CONNECTED state as described in clause 4.2.4.2, TS 23.502 [3].
If the UE receives indication from the AMF that Network Slicing subscription has changed, the UE locally deletes the network slicing information it has for all PLMNs, except the Default Configured NSSAI (if present). It also updates the current PLMN network slicing configuration information with any received values from the AMF.
The update of URSP rules (which include the NSSP), if necessary at any time, is described in TS 23.503 [45].
The establishment of User Plane connectivity to a Data Network via a Network Slice instance(s) comprises two steps:
-	performing a RM procedure to select an AMF that supports the required Network Slices.
-	establishing one or more PDU Session to the required Data network via the Network Slice instance(s).
When a UE registers over an Access Type with a PLMN, if the UE has either or both of:
-	a Configured NSSAI for this PLMN;
-	an Allowed NSSAI for this PLMN and Access Type;
the UE shall provide to the network, in AS layer under the conditions described in clause 5.15.9 and in NAS layer, a Requested NSSAI containing the S-NSSAI(s) corresponding to the Network Slice(s) to which the UE wishes to register, unless they are stored in the UE in the Pending NSSAI.
The Requested NSSAI shall be one of:
-	the Default Configured NSSAI, i.e. if the UE has no Configured NSSAI nor an Allowed NSSAI for the serving PLMN;
-	the Configured-NSSAI, or a subset thereof as described below, e.g. if the UE has no Allowed NSSAI for the Access Type for the serving PLMN;
-	the Allowed-NSSAI for the Access Type over which the Requested NSSAI is sent, or a subset thereof; or
-	the Allowed-NSSAI for the Access Type over which the Requested NSSAI is sent, or a subset thereof, plus one or more S-NSSAIs from the Configured-NSSAI not yet in the Allowed NSSAI for the Access Type as described below.
NOTE 1:	If the UE wishes to register only a subset of the S-NSSAIs from the Configured NSSAI or the Allowed NSSAI, to be able to register with some Network Slices e.g. to establish PDU Sessions for some application(s), and the UE uses the URSP rules (which includes the NSSP) or the UE Local Configuration as defined in clause 6.1.2.2.1 of TS 23.503 [45], then the UE uses applicable the URSP rules or the UE Local Configuration to ensure that the S-NSSAIs included in the Requested NSSAI are not in conflict with the URSP rules or with the UE Local Configuration.
The subset of S-NSSAIs in the Configured-NSSAI provided in the Requested NSSAI consists of one or more S-NSSAI(s) in the Configured NSSAI applicable to this PLMN, if one is present, and for which no corresponding S-NSSAI is already present in the Allowed NSSAI for the access type for this PLMN. The UE shall not include in the Requested NSSAI any S-NSSAI that is currently rejected by the network (i.e. rejected in the current registration area or rejected in the PLMN). For the registration to a PLMN for which neither a Configured NSSAI applicable to this PLMN or an Allowed NSSAI are present, the S-NSSAIs provided in the Requested NSSAI correspond to the S-NSSAI(s) in the Default Configured NSSAI unless the UE has HPLMN S-NSSAI for established PDU Session(s) in which case the HPLMN S-NSSAI(s) shall be provided in the mapping of Requested NSSAI in the NAS Registration Request message, with no corresponding VPLMN S-NSSAI in the Requested NSSAI. If the UE has been provided with NSSRG information together with the Configured NSSAI, the UE only includes in the Requested NSSAI S-NSSAIs that share a common NSSRG, see clause 5.15.12.2. If the UE has stored Pending NSSAI and the UE is still interested in the Pending NSSAI then all the S-NSSAIs in the Requested NSSAI and the Pending S-NSSAI shall share a common NSSRG.
When a UE registers over an Access Type with a PLMN, the UE shall also indicate in the Registration Request message when the Requested NSSAI is based on the Default Configured NSSAI.
The UE shall include the Requested NSSAI in the RRC Connection Establishment and in the establishment of the connection to the N3IWF/TNGF (as applicable) and in the NAS Registration procedure messages subject to conditions set out in clause 5.15.9. However, the UE shall not indicate any NSSAI in RRC Connection Establishment or Initial NAS message unless it has either a Configured NSSAI for the corresponding PLMN, an Allowed NSSAI for the corresponding PLMN and Access Type, or the Default Configured NSSAI. If the UE has HPLMN S-NSSAI(s) for established PDU Session(s), the HPLMN S-NSSAI(s) shall be provided in the mapping of Requested NSSAI in the NAS Registration Request message, independent of whether the UE has the corresponding VPLMN S-NSSAI. The (R)AN shall route the NAS signalling between this UE and an AMF selected using the Requested NSSAI obtained during RRC Connection Establishment or connection to N3IWF/TNGF respectively. If the (R)AN is unable to select an AMF based on the Requested NSSAI, it routes the NAS signalling to an AMF from a set of default AMFs. In the NAS signalling, if the UE is roaming, the UE provides the mapping of each S-NSSAI of the Requested NSSAI to a corresponding HPLMN S-NSSAI.
When a UE registers with a PLMN, if for this PLMN the UE has not included a Requested NSSAI nor a GUAMI while establishing the connection to the (R)AN, the (R)AN shall route all NAS signalling from/to this UE to/from a default AMF. When receiving from the UE a Requested NSSAI and a 5G-S-TMSI or a GUAMI in RRC Connection Establishment or in the establishment of connection to N3IWF/TNGF, if the 5G-AN can reach an AMF corresponding to the 5G-S-TMSI or GUAMI, then 5G-AN forwards the request to this AMF. Otherwise, the 5G-AN selects a suitable AMF based on the Requested NSSAI provided by the UE and forwards the request to the selected AMF. If the 5G-AN is not able to select an AMF based on the Requested NSSAI, then the request is sent to a default AMF.
When the AMF selected by the AN during Registration Procedure receives the UE Registration request, or after an AMF selection by MME (i.e. during EPS to 5GS handover) the AMF receives S-NSSAI(s) from SMF+PGW-C in 5GC:
-	As part of the Registration procedure described in clause 4.2.2.2.2 of TS 23.502 [3], or as part of the EPS to 5GS handover using N26 interface procedure described in clause 4.11.1.2.2 of TS 23.502 [3], the AMF may query the UDM to retrieve UE subscription information including the Subscribed S-NSSAIs.
-	The AMF verifies whether the S-NSSAI(s) in the Requested NSSAI or the S-NSSAI(s) received from SMF+PGW-C are permitted based on the Subscribed S-NSSAIs (to identify the Subscribed S-NSSAIs the AMF may use the mapping to HPLMN S-NSSAIs provided by the UE, in the NAS message, for each S-NSSAI of the Requested NSSAI).
-	When the UE context in the AMF does not yet include an Allowed NSSAI for the corresponding Access Type, the AMF queries the NSSF (see (B) below for subsequent handling), except in the case when, based on configuration in this AMF, the AMF is allowed to determine whether it can serve the UE (see (A) below for subsequent handling). The IP address or FQDN of the NSSF is locally configured in the AMF.
NOTE 2:	The configuration in the AMF depends on operator's policy.
-	When the UE context in the AMF already includes an Allowed NSSAI for the corresponding Access Type, based on the configuration for this AMF, the AMF may be allowed to determine whether it can serve the UE (see (A) below for subsequent handling).
-	AMF or NSSF may have previously subscribed to slice load level and/or Observed Service Experience and/or Dispersion Analytics related network data analytics for a Network Slice from NWDAF, optionally for an Area of Interest composed of one or several TAIs. If AMF subscribes to analytics, AMF may determine that it cannot serve the UE based on received analytics (see (A) below). If AMF subscribes to notifications on changes on the Network Slice or Network Slice instance availability information from NSSF optionally indicating a list of supported TAIs, it may determine that it cannot serve the UE after the restriction notification is received (see (A) below). If AMF does not subscribe to notifications on changes on the availability information from NSSF, NSSF may take the analytics information into account when AMF queries NSSF (see (B) below).
NOTE 3:	The configuration in the AMF depends on the operator's policy.
(A) Depending on fulfilling the configuration as described above, the AMF may be allowed to determine whether it can serve the UE, and the following is performed:
-	For the mobility from EPS to 5GS, the AMF first derives the serving PLMN value(s) of S-NSSAI(s) based on the HPLMN S-NSSAI(s) in the mapping of Requested NSSAI (in CM-IDLE state) or the HPLMN S-NSSAI(s) received from SMF+PGW-C (in CM-CONNECTED state). After that the AMF regards the derived value(s) as the Requested NSSAI.
-	For the inter PLMN within 5GC mobility, the new AMF derives the serving PLMN value(s) of S-NSSAI(s) based on the HPLMN S-NSSAI(s) in the mapping of Requested NSSAI. After that the AMF regards the derived value(s) as the Requested NSSAI.
-	AMF checks whether it can serve all the S-NSSAI(s) from the Requested NSSAI present in the Subscribed S-NSSAIs (potentially using configuration for mapping S-NSSAI values between HPLMN and Serving PLMN), or all the S-NSSAI(s) marked as default in the Subscribed S-NSSAIs in the case that no Requested NSSAI was provided or none of the S-NSSAIs in the Requested NSSAI are permitted, i.e. do not match any of the Subscribed S-NSSAIs or not available at the current UE's Tracking Area (see clause 5.15.3).
-	If AMF has subscribed to slice load level and/or Observed Service Experience and/or Dispersion Analytics related network data analytics for a Network Slice from NWDAF, or if AMF had received a Network Slice restriction from NSSF that applies to the list of TAIs supported by the AMF, it may use that information to determine whether the AMF can serve the UE on the S-NSSAI(s) in the Requested NSSAI.
-	If the AMF can serve the S-NSSAIs in the Requested NSSAI, the AMF remains the serving AMF for the UE. The Allowed NSSAI is then composed of the list of S-NSSAI(s) in the Requested NSSAI permitted based on the Subscribed S-NSSAIs and/or the list of S-NSSAI(s) for the Serving PLMN which are mapped to the HPLMN S-NSSAI(s) provided in the mapping of Requested NSSAI permitted based on the Subscribed S-NSSAIs, or, if neither Requested NSSAI nor the mapping of Requested NSSAI was provided or none of the S-NSSAIs in the Requested NSSAI are permitted, all the S-NSSAI(s) marked as default in the Subscribed S-NSSAIs and taking also into account the availability of the Network Slice instances as described in clause 5.15.8 that are able to serve the S-NSSAI(s) in the Allowed NSSAI in the current UE's Tracking Areas in addition to any Network Slice instance restriction for the S-NSSAI(s) in the Allowed NSSAI provided by the NSSF. If the AMF has received NSSRG Information for the Subscribed S-NSSAIs as part of the UE subscription information, it shall only include in the Allowed NSSAI S-NSSAIs that all share a common NSSRG (see clause 5.15.12). If at least one S-NSSAI in the Requested NSSAI is not available in the current UE's Tracking Area, then either the AMF may determine a Target NSSAI or step (B) is executed. The AMF also determines the mapping if the S-NSSAI(s) included in the Allowed NSSAI needs to be mapped to Subscribed S-NSSAI(s) values. If no Requested NSSAI is provided, or the mapping of the S-NSSAIs in Requested NSSAI to HPLMN S-NSSAIs is incorrect, or the Requested NSSAI includes an S-NSSAI that is not valid in the Serving PLMN, or the UE indicated that the Requested NSSAI is based on the Default Configured NSSAI, the AMF, based on the Subscribed S-NSSAI(s) and operator's configuration, may also determine the Configured NSSAI for the Serving PLMN and, if applicable, the associated mapping of the Configured NSSAI to HPLMN S-NSSAIs, so these can be configured in the UE. Then Step (C) is executed.
-	Else, the AMF queries the NSSF (see (B) below).
(B) When required as described above, the AMF needs to query the NSSF, and the following is performed:
-	The AMF queries the NSSF, with Requested NSSAI, Default Configured NSSAI Indication, mapping of Requested NSSAI to HPLMN S-NSSAIs, the Subscribed S-NSSAIs (with an indication if marked as default S-NSSAI), NSSRG Information (if provided by the UDM, see clause 5.15.12), any Allowed NSSAI it might have for the other Access Type (including its mapping to HPLMN S-NSSAIs), PLMN ID of the SUPI and UE's current Tracking Area. If the AMF has pending NSSAI for the UE then the AMF includes pending NSSAI in the Requested NSSAI.
-	Based on this information, local configuration, and other locally available information including RAN capabilities in the current Tracking Area for the UE or load level information for a Network Slice instance provided by the NWDAF, the NSSF does the following:
-	It verifies which S-NSSAI(s) in the Requested NSSAI are permitted based on comparing the Subscribed S-NSSAIs with the S-NSSAIs in the mapping of Requested NSSAI to HPLMN S-NSSAIs. It considers the S-NSSAI(s) marked as default in the Subscribed S-NSSAIs in the case that no Requested NSSAI was provided or no S-NSSAI from the Requested NSSAI are permitted i.e. are not present in the Subscribed S-NSSAIs or not available e.g. at the current UE's Tracking Area. If NSSRG information is provided, the NSSF only selects S-NSSAIs that share a common NSSRG (see clause 5.15.12).
-	If AMF has not subscribed to notifications on changes on the Network Slice or Network Slice instance availability information from NSSF and NSSF has subscribed to slice load level and/or Observed Service Experience and/or Dispersion Analytics related network data analytics for a Network Slice from NWDAF, NSSF may use the analytics information for the determination of the (Network Slice instance(s) and the) list of S-NSSAI(s) in the Allowed NSSAI(s) to serve the UE.
-	It selects the Network Slice instance(s) to serve the UE. When multiple Network Slice instances in the UE's Tracking Area are able to serve a given S-NSSAI, based on operator's configuration, the NSSF may select one of them to serve the UE, or the NSSF may defer the selection of the Network Slice instance until a NF/service within the Network Slice instance needs to be selected.
-	It determines the target AMF Set to be used to serve the UE, or, based on configuration, the list of candidate AMF(s), possibly after querying the NRF.
NOTE 4:	If the target AMF(s) returned from the NSSF is the list of candidate AMF(s), the Registration Request message can only be redirected via the direct signalling between the initial AMF and the selected target AMF as described in clause 5.15.5.2.3. The NSSF does not provide the target AMF(s), when it provides a Target NSSAI in order to redirect or handover the UE to a cell of another TA as described in clause 5.3.4.3.3.
-	It determines the Allowed NSSAI(s) for the applicable Access Type, composed of the list of S-NSSAI(s) in the Requested NSSAI permitted based on the Subscribed S-NSSAIs and/or the list of S-NSSAI(s) for the Serving PLMN which are mapped to the HPLMN S-NSSAIs provided in the mapping of Requested NSSAI permitted based on the Subscribed S-NSSAIs, or, if neither Requested NSSAI nor the mapping of Requested NSSAI was provided or none of the S-NSSAIs in the Requested NSSAI are permitted, all the S-NSSAI(s) marked as default in the Subscribed S-NSSAIs, and taking also into account the availability of the Network Slice instances as described in clause 5.15.8 that are able to serve the S-NSSAI(s) in the Allowed NSSAI in the current UE's Tracking Areas. If NSSRG information applies, the NSSF only selects S-NSSAIs that share a common NSSRG (see clause 5.15.12).
-	It also determines the mapping of each S-NSSAI of the Allowed NSSAI(s) to the Subscribed S-NSSAIs if necessary.
-	Based on operator configuration, the NSSF may determine the NRF(s) to be used to select NFs/services within the selected Network Slice instance(s).
-	Additional processing to determine the Allowed NSSAI(s) in roaming scenarios and the mapping to the Subscribed S-NSSAIs, as described in clause 5.15.6.
-	If no Requested NSSAI is provided or the Requested NSSAI includes an S-NSSAI that is not valid in the Serving PLMN, or the mapping of the S-NSSAIs in Requested NSSAI to HPLMN S-NSSAIs is incorrect, or the Default Configured NSSAI Indication is received from AMF, the NSSF based on the Subscribed S-NSSAI(s) and operator configuration may also determine the Configured NSSAI for the Serving PLMN and, if applicable, the associated mapping of the Configured NSSAI to HPLMN S-NSSAIs, so these can be configured in the UE.
-	If at least one S-NSSAI in the Requested NSSAI is not available in the current UE's Tracking Area, the NSSF may provide a Target NSSAI for the purpose of allowing the NG-RAN to redirect the UE to a cell of a TA in another frequency band supporting network slices not available in the current TA as described in clause 5.3.4.3.3.
-	The NSSF returns to the current AMF the Allowed NSSAI for the applicable Access Type, the mapping of each S-NSSAI of the Allowed NSSAI to the Subscribed S-NSSAIs if determined and the target AMF Set, or, based on configuration, the list of candidate AMF(s). The NSSF may return the NRF(s) to be used to select NFs/services within the selected Network Slice instance(s), and the NRF to be used to determine the list of candidate AMF(s) from the AMF Set. The NSSF may return NSI ID(s) to be associated to the Network Slice instance(s) corresponding to certain S-NSSAIs. NSSF may return the rejected S-NSSAI(s) as described in clause 5.15.4.1. The NSSF may return the Configured NSSAI for the Serving PLMN and the associated mapping of the Configured NSSAI to HPLMN S-NSSAIs. The NSSF may return Target NSSAI as described in clause 5.3.4.3.3.
-	Depending on the available information and based on configuration, the AMF may query the appropriate NRF (e.g. locally pre-configured or provided by the NSSF) with the target AMF Set. The NRF returns a list of candidate AMFs.
-	If AMF Re-allocation is necessary, the current AMF reroutes the Registration Request or forwards the UE context to a target serving AMF as described in clause 5.15.5.2.3.
-	Step (C) is executed.
(C) The serving AMF shall determine a Registration Area such that all S-NSSAIs of the Allowed NSSAI for this Registration Area are available in all Tracking Areas of the Registration Area (and also considering other aspects as described in clause 5.3.2.3 and clause 5.3.4.3.3) and then return to the UE this Allowed NSSAI and the mapping of the Allowed NSSAI to the Subscribed S-NSSAIs if provided. The AMF may return the rejected S-NSSAI(s) as described in clause 5.15.4.1.
NOTE 5:	The S-NSSAIs in the Allowed NSSAI for Non-3GPP access are available homogeneously "in the PLMN" for the N3IWF case since a N3IWF providing access to a 5GC can be reached from any IP location. For other types of Non-3GPP access the S-NSSAIs in the Allowed NSSAI for Non-3GPP access can be not available homogeneously, for example different W-AGFs/TNGF(s) can be deployed in different locations and support different TAIs that support different network slices.
When either no Requested NSSAI was included, or the mapping of the S-NSSAIs in Requested NSSAI to HPLMN S-NSSAIs is incorrect, or a Requested NSSAI is not considered valid in the PLMN and as such at least one S-NSSAI in the Requested NSSAI was rejected as not usable by the UE in the PLMN, or the UE indicated that the Requested NSSAI is based on the Default Configured NSSAI, the AMF may update the UE slice configuration information for the PLMN as described in clause 5.15.4.2.
If the Requested NSSAI does not include S-NSSAIs which map to S-NSSAIs of the HPLMN subject to Network Slice-Specific Authentication and Authorization and the AMF determines that no S-NSSAI can be provided in the Allowed NSSAI for the UE in the current UE's Tracking Area and if no default S-NSSAI(s) could be added as described in step (A), the AMF shall reject the UE Registration and shall include in the rejection message the list of Rejected S-NSSAIs, each of them with the appropriate rejection cause value.
If the Requested NSSAI includes S-NSSAIs which map to S-NSSAIs of the HPLMN subject to Network Slice-Specific Authentication and Authorization, the AMF shall include in the Registration Accept message an Allowed NSSAI containing only those S-NSSAIs that are not to be subject to Network Slice-Specific Authentication and Authorization and, based on the UE Context in AMF, those S-NSSAIs for which Network Slice-Specific Authentication and Authorization for at least one of the corresponding HPLMN S-NSSAIs succeeded previously regardless the Access Type, if any.
The AMF shall also provide the list of Rejected S-NSSAIs, each of them with the appropriate rejection cause value.
If the AMF determined the Target NSSAI or received a Target NSSAI from the NSSF, the AMF should provide the Target NSSAI to the PCF for retrieving a corresponding RFSP as described in clause 5.3.4.3.1 or, if the PCF is not deployed, the AMF should determine a corresponding RFSP based on local configuration. Then the AMF provides the Target NSSAI and the corresponding RFSP to the NG-RAN as described in clause 5.3.4.3.3. The S-NSSAIs which map to S-NSSAIs of the HPLMN subject to an ongoing Network Slice-Specific Authentication and Authorization shall be included in the Pending NSSAI and removed from Allowed NSSAI. The Pending NSSAI may contain a mapping of the S-NSSAI(s) for the Serving PLMN to the HPLMN S-NSSAIs, if applicable. The UE shall not include in the Requested NSSAI any of the S-NSSAIs from the Pending NSSAI the UE stores, regardless of the Access Type.
If:
-	all the S-NSSAI(s) in the Requested NSSAI are still to be subject to Network Slice-Specific Authentication and Authorization; or
-	no Requested NSSAI was provided or none of the S-NSSAIs in the Requested NSSAI matches any of the Subscribed S-NSSAIs, and all the S-NSSAI(s) marked as default in the Subscribed S-NSSAIs are to be subject to Network Slice-Specific Authentication and Authorization;
the AMF shall provide a "NSSAA to be performed" indicator and no Allowed NSSAI to the UE in the Registration Accept message. Upon receiving the Registration Accept message, the UE is registered in the PLMN but shall wait for the completion of the Network Slice-Specific Authentication and Authorization without attempting to use any service provided by the PLMN on any access, except e.g. emergency services (see TS 24.501 [47]), until the UE receives an allowed NSSAI.
Then, the AMF shall initiate the Network Slice-Specific Authentication and Authorization procedure as described in clause 5.15.10 for each S-NSSAI that requires it, except, based on Network policies, for those S-NSSAIs for which Network Slice-Specific Authentication and Authorization have been already initiated on another Access Type for the same S-NSSAI(s). At the end of the Network Slice-Specific Authentication and Authorization steps, the AMF by means of the UE Configuration Update procedure shall provide a new Allowed NSSAI to the UE which also contains the S-NSSAIs subject to Network Slice-Specific Authentication and Authorization for which the authentication and authorization is successful. The AMF may perform AMF selection when NSSAA completes for the S-NSSAIs subject to NSSAA. If an AMF change is required, this shall be triggered by the AMF using the UE Configuration Update procedure indicating a UE re-registration is required. The S-NSSAIs which were not successfully authenticated and authorized are not included in the Allowed NSSAI and are included in the list of Rejected S-NSSAIs with a rejection cause value indicating Network Slice-Specific Authentication and Authorization failure.
Once completed the Network Slice-Specific (re-)Authentication and (re-)Authorization procedure, if the AMF determines that no S-NSSAI can be provided in the Allowed NSSAI for the UE, which is already authenticated and authorized successfully by a PLMN, and if no default S-NSSAI(s) could be added as described in step (A), the AMF shall execute the Network-initiated Deregistration procedure described in clause 4.2.2.3.3 of TS 23.502 [3] and shall include in the explicit De-Registration Request message the list of Rejected S-NSSAIs, each of them with the appropriate rejection cause value.
If an S-NSSAI is rejected with a rejection cause value indicating Network Slice-Specific Authentication and Authorization failure or revocation, the UE can re-attempt to request the S-NSSAI based on policy, local in the UE.
The set of Network Slices for a UE can be changed at any time while the UE is registered with a network, and may be initiated by the network, or by the UE, under certain conditions as described below.
The network, based on local policies, subscription changes and/or UE mobility and/or UE Dispersion data classification, operational reasons (e.g. a Network Slice instance is no longer available or load level information or service experience for a Network Slice or network slice instance provided by the NWDAF), may change the set of Network Slice(s) to which the UE is registered and provide the UE with a new Registration Area and/or Allowed NSSAI and the mapping of this Allowed NSSAI to HPLMN S-NSSAIs, for each Access Type over which the UE is registered. In addition, the network may provide the Configured NSSAI for the Serving PLMN, the associated mapping information, and the rejected S-NSSAIs. The network may perform such a change over each Access Type during a Registration procedure or trigger a notification towards the UE of the change of the Network Slices using a UE Configuration Update procedure as specified in clause 4.2.4 of TS 23.502 [3]. The new Allowed NSSAI(s) and the mapping to HPLMN S-NSSAIs are determined as described in clause 5.15.5.2.1 (an AMF Re-allocation may be needed). The AMF provides the UE with:
-	an indication that the acknowledgement from UE is required;
-	Configured NSSAI for the Serving PLMN (if required), rejected S-NSSAI(s) (if required) and TAI list, and
-	the new Allowed NSSAI with the associated mapping of Allowed NSSAI for each Access Type (as applicable) unless the AMF cannot determine the new Allowed NSSAI (e.g. all S-NSSAIs in the old Allowed NSSAI have been removed from the Subscribed S-NSSAIs).
	Furthermore:
-	If the changes to the Allowed NSSAI require the UE to perform immediately a Registration procedure because they affect the existing connectivity to AMF (e.g. the new S-NSSAIs require a separate AMF that cannot be determined by the current serving AMF, or the AMF cannot determine the Allowed NSSAI) or due to AMF local policies also when the changes does not affect the existing connectivity to AMF:
-	The serving AMF indicates to the UE the need for the UE to perform a Registration procedure without including the GUAMI or 5G-S-TMSI in the access stratum signalling after entering CM-IDLE state. The AMF shall release the NAS signalling connection to the UE to allow to enter CM-IDLE after receiving the acknowledgement from UE.
-	When the UE receives indications to perform a Registration procedure without including the GUAMI or 5G-S-TMSI in the access stratum signalling after entering CM-IDLE state, then:
-	The UE deletes any stored (old) Allowed NSSAI and associated mapping as well as any (old) rejected S-NSSAI.
-	The UE shall initiate a Registration procedure with the registration type Mobility Registration Update after the UE enters CM-IDLE state as specified in as described in step 4 of clause 4.2.4.2 of TS 23.502 [3]. The UE shall include a Requested NSSAI (as described in clause 5.15.5.2.1) with the associated mapping of Requested NSSAI in the Registration Request message. Also, the UE shall include, subject to the conditions set out in clause 5.15.9, a Requested NSSAI in access stratum signalling but no GUAMI.
-	If the AMF determines that the S-NSSAI in the Allowed NSSAI is replaced with Alternative S-NSSAI, the AMF provides the mapping of old S-NSSAI to the Alternative S-NSSAI to the UE (as described in clause 5.15.19).
If there is an established PDU Session associated with emergency services, then the serving AMF indicates to the UE the need for the UE to perform a Registration procedure but does not release the NAS signalling connection to the UE. The UE performs the Registration procedure only after the release of the PDU Session used for the emergency services.
In addition to sending the new Allowed NSSAI to the UE, when a Network Slice used for a one or multiple PDU Sessions is no longer available for a UE, the following applies:
-	If the Network Slice becomes no longer available under the same AMF and the Network Slice Replacement is not used (e.g. due to UE subscription change), the AMF indicates to the SMF(s) which PDU Session ID(s) corresponding to the relevant S-NSSAI shall be released. SMF releases the PDU Session according to clause 4.3.4.2 of TS 23.502 [3]. If the Network Slice Replacement is used, the AMF performs Network Slice Replacement as described in clause 5.15.19.
-	If the Network Slice becomes no longer available upon a change of AMF (e.g. due to Registration Area change), the new AMF indicates to the old AMF that the PDU Session(s) corresponding to the relevant S-NSSAI shall be released. The old AMF informs the corresponding SMF(s) to release the indicated PDU Session(s). The SMF(s) release the PDU Session(s) as described in clause 4.3.4 of TS 23.502 [3]. Then the new AMF modifies the PDU Session Status correspondingly. The PDU Session(s) context is locally released in the UE after receiving the PDU Session Status in the Registration Accept message.
The UE uses either the URSP rules (which includes the NSSP) or the UE Local Configuration as defined in clause 6.1.2.2.1 of TS 23.503 [45] to determine whether ongoing traffic can be routed over existing PDU Sessions belonging to other Network Slices or establish new PDU Session(s) associated with same/other Network Slice.
In order to change the set of S-NSSAIs the UE is registered to over an Access Type, the UE shall initiate a Registration procedure over this Access Type as specified in clause 5.15.5.2.1.
If, for an established PDU Session:
-	none of the values of the S-NSSAIs of the HPLMN in the mapping of the Requested NSSAI to S-NSSAIs of the HPLMN included in the Registration Request matches the S-NSSAI of the HPLMN associated with the PDU Session; or
-	none of the values of the S-NSSAIs in the Requested NSSAI matches the value of the S-NSSAI of HPLMN associated with the PDU Session and the mapping of the Requested NSSAI to S-NSSAIs of the HPLMN is not included in the Registration Request,
the network shall release this PDU Session as follows.
-	the AMF informs the corresponding SMF(s) to release the indicated PDU Session(s). The SMF(s) release the PDU Session(s) as described in clause 4.3.4 of TS 23.502 [3]. Then the AMF modifies the PDU Session Status correspondingly. The PDU Session(s) context is locally released in the UE after receiving the PDU Session Status from the AMF.
A change of the set of S-NSSAIs (whether UE or Network initiated) to which the UE is registered may, subject to operator policy, lead to AMF change, as described in clause 5.15.5.2.1.
If the AMF supports the Network Slice Replacement feature and is configured to use the NSSF to trigger the Network Slice Replacement, the AMF subscribes with the NSSF for notifications when any of the S-NSSAIs served by the AMF (e.g. the S-NSSAI in the Serving PLMN and the HPLMN S-NSSAI in roaming case) has to be replaced as described in clause 5.15.19.
If the AMF supports the Network Slice Instance Replacement and configured to use Network Slice Instance Replacement, the AMF subscribes with the NSSF for notifications when a Network Slice instances served by the AMF is congested or no longer available as described in clause 5.15.20.
The AMF may perform Network Slice Replacement for the PDU Session as described in clause 5.15.19.
During a Registration procedure in a PLMN, if the network decides that the UE should be served by a different AMF based on Network Slice(s) aspects, then the AMF that first received the Registration Request shall redirect the Registration request to target AMF via the 5G-AN or via direct signalling between the initial AMF and the target AMF. If the target AMF(s) are returned from the NSSF and identified by a list of candidate AMF(s), the redirection message shall only be sent via the direct signalling between the initial AMF and the target AMF. If the redirection message is sent by the AMF via the 5G-AN, the message shall include information for selection of a new AMF to serve the UE.
When during a Registration procedure the UE requests a new S-NSSAI which is not supported in the UE's current Tracking Area, the serving AMF itself or by interacting with the NSSF as described in clause 5.15.5.2.1 may determine a Target NSSAI. The AMF provides the Target NSSAI to the NG-RAN and the NG-RAN may apply redirection or handover of the UE to a cell in another TA supporting the Target NSSAI as described in clause 5.3.4.3.3.
During a EPS to 5GS handover using N26 interface procedure, if the network decides that the UE should be served by a different AMF based on Network Slice(s) aspects, then the AMF, which received the Forward Relocation Request from MME, shall forward the UE context to target AMF via direct signalling between the initial AMF and the target AMF as described in clause 4.11.1.2.2 of TS 23.502 [3].
For a UE that is already registered, the system shall support a redirection initiated by the network of a UE from its serving AMF to a target AMF due to Network Slice(s) considerations (e.g. the operator has changed the mapping between the Network Slice instances and their respective serving AMF(s)). Operator policy determines whether redirection between AMFs is allowed.
The PDU Session Establishment in a Network Slice instance to a DN allows data transmission in a Network Slice instance. A PDU Session is associated to an S-NSSAI and a DNN. A UE that is registered in a PLMN over an Access Type and has obtained a corresponding Allowed NSSAI, shall indicate in the PDU Session Establishment procedure the S-NSSAI according to the NSSP in the URSP rules or according to the UE Local Configuration as defined in clause 6.1.2.2.1 of TS 23.503 [45], and, if available, the DNN the PDU Session is related to. The UE includes the appropriate S-NSSAI from this Allowed NSSAI and, if mapping of the Allowed NSSAI to HPLMN S-NSSAIs was provided, an S-NSSAI with the corresponding value from this mapping.
If the UE cannot determine any S-NSSAI after performing the association of the application to a PDU Session according to clause 6.1.2.2.1 of TS 23.503 [45], the UE shall not indicate any S-NSSAI in the PDU Session Establishment procedure.
The network (HPLMN) may provision the UE with Network Slice selection policy (NSSP) as part of the URSP rules, see clause 6.6.2 of TS 23.503 [45]. When the Subscription Information contains more than one S-NSSAI and the network wants to control/modify the UE usage of those S-NSSAIs, then the network provisions/updates the UE with NSSP as part of the URSP rules. When the Subscription Information contains only one S-NSSAI, the network needs not provision the UE with NSSP as part of the URSP rules. The NSSP rules associate an application with one or more HPLMN S-NSSAIs. A default rule which matches all applications to a HPLMN S-NSSAI may also be included.
The UE shall store and use the URSP rules, including the NSSP, as described in TS 23.503 [45]. When a UE application associated with a specific S-NSSAI requests data transmission:
-	if the UE has one or more PDU Sessions established corresponding to the specific S-NSSAI, the UE routes the user data of this application in one of these PDU Sessions, unless other conditions in the UE prohibit the use of these PDU Sessions. If the application provides a DNN, then the UE considers also this DNN to determine which PDU Session to use. This is further described in clause 6.6.2 of TS 23.503 [45].
-	If the UE does not have a PDU Session established with this specific S-NSSAI, the UE requests a new PDU Session corresponding to this S-NSSAI and with the DNN that may be provided by the application. In order for the RAN to select a proper resource for supporting network slicing in the RAN, RAN needs to be aware of the Network Slices used by the UE. This is further described in clause 6.6.2 of TS 23.503 [45].
If the AMF is not able to determine the appropriate NRF to query for the S-NSSAI provided by the UE, the AMF may query the NSSF with this specific S-NSSAI, location information, PLMN ID of the SUPI. The NSSF determines and returns the appropriate NRF to be used to select NFs/services within the selected Network Slice instance. The NSSF may also return an NSI ID to be used to select NFs within the selected Network Slice instance to use for this S-NSSAI.
The AMF or NSSF may select an S-NSSAI (if the UE does not provide an S-NSSAI for the PDU session establishment) and a Network Slice instance, based on load level and/or Observe Service Experience and/or Dispersion analytics from NWDAF, as described in TS 23.288 [86].
The IP address or FQDN of the NSSF is locally configured in the AMF.
SMF discovery and selection within the selected Network Slice instance is initiated by the AMF when a SM message to establish a PDU Session is received from the UE. The appropriate NRF is used to assist the discovery and selection tasks of the required network functions for the selected Network Slice instance.
The AMF queries the appropriate NRF to select an SMF in a Network Slice instance based on S-NSSAI, DNN, NSI-ID (if available) and other information e.g. UE subscription and local operator policies, when the UE triggers PDU Session Establishment. The AMF may select the SMF among the set of the SMF instance(s) returned by the NRF or locally configured in the AMF, based on network data analytics (NF load, etc.) from the NWDAF as described in TS 23.288 [86]. The selected SMF establishes a PDU Session based on S-NSSAI and DNN.
When the AMF belongs to multiple Network Slice instances, based on configuration, the AMF may use an NRF at the appropriate level for the SMF selection.
For further details on the SMF selection, refer to clause 4.3.2.2.3 of TS 23.502 [3].
When a PDU Session for a given S-NSSAI is established using a specific Network Slice instance, the CN provides to the (R)AN the S-NSSAI corresponding to this Network Slice instance to enable the RAN to perform access specific functions.
The UE shall not perform PDU Session handover from one Access Type to another if the S-NSSAI of the PDU Session is not included in the Allowed NSSAI of the target Access Type.
For roaming scenarios:
-	If the UE only uses standard S-NSSAI values, then the same S-NSSAI values can be used in VPLMN as in the HPLMN.
-	If the VPLMN and HPLMN have an SLA to support non-standard S-NSSAI values in the VPLMN, the NSSF of the VPLMN maps the Subscribed S-NSSAIs values to the respective S-NSSAI values to be used in the VPLMN. The S-NSSAI values to be used in the VPLMN are determined by the NSSF of the VPLMN based on the SLA. The NSSF of the VPLMN need not inform the HPLMN of which values are used in the VPLMN.
	Depending on operator's policy and the configuration in the AMF, the AMF may decide the S-NSSAI values to be used in the VPLMN and the mapping to the Subscribed S-NSSAIs.
	For the home routed case, the AMF or NSSF may select an S-NSSAI (if the UE does not provide an S-NSSAI for the PDU session establishment) and a Network Slice instance, based on load level and/or Observe Service Experience and/or Dispersion analytics of the VPLMN and/or that of the HPLMN from NWDAF as described in TS 23.288 [86].
-	The UE constructs Requested NSSAI and provides the mapping of S-NSSAIs of the Requested NSSAI to HPLMN S-NSSAIs if the mapping is stored in the UE, as described in clause 5.15.5.2.1.
-	The NSSF in the VPLMN determines the Allowed NSSAI without interacting with the HPLMN.
-	the HPLMN may provide NSSRG Information as part of the Subscription information as described in clause 5.15.12.
-	The Allowed NSSAI in the Registration Accept includes S-NSSAI values used in the VPLMN. The mapping information described above is also provided to the UE with the Allowed NSSAI as described in clause 5.15.4.
-	If the S-NSSAI values are subject to NSAC, depending on operator's policy, a roaming agreement or an SLA between VPLMN and HPLMN, the AMF or SMF in VPLMN triggers a request for NSAC for these S-NSSAI values as described in clause 5.15.11.3.
-	In PDU Session Establishment procedure, the UE includes both:
(a)	the S-NSSAI that matches the application (that is triggering the PDU Session Request) within the NSSP in the URSP rules or within the UE Local Configuration as defined in clause 6.1.2.2.1 of TS 23.503 [45]; the value of this S NSSAI is used in the HPLMN; and
(b)	an S-NSSAI belonging to the Allowed NSSAI that maps to (a) using the mapping of the Allowed NSSAI to HPLMN S-NSSAIs; the value of this S-NSSAI is used in the VPLMN.
	For the home routed case, the AMF may select the V-SMF and the H-SMF based on network data analytics (NF load, etc.) of the VPLMN and that of the HPLMN from the NWDAF as described in TS 23.288 [86]. The V-SMF sends the PDU Session Establishment Request message to the H-SMF along with the S-NSSAI with the value used in the HPLMN (a). If the S-NSSAI values are subject to NSAC, the V-SMF or H-SMF triggers a request for NSAC for these S-NSSAI values as described in clause 5.15.11.3.
-	When a PDU Session is established, the CN provides to the AN the S-NSSAI with the value from the VPLMN corresponding to this PDU Session, as described in clause 5.15.5.3.
-	The Network Slice instance specific network functions in the VPLMN are selected by the VPLMN by using the S-NSSAI with the value used in the VPLMN and querying an NRF that has either been pre-configured, or provided by the NSSF in the VPLMN. The Network Slice specific functions of the HPLMN (if applicable) are selected by the VPLMN by using the related S-NSSAI with the value used in the HPLMN via the support from an appropriate NRF in the HPLMN, identified as specified in clause 4.17.5 of TS 23.502 [3] and, for SMF in clause 4.3.2.2.3.3 of TS 23.502 [3].
-	If the serving AMF supports the Network Slice Replacement feature and is configured to use the NSSF for Network Slice Replacement triggering, the AMF subscribes with the NSSF of the VPLMN for notifications when an HPLMN S-NSSAI needs to be replaced with an Alternative S-NSSAI, in addition to notifications for the Serving PLMN S-NSSAIs. The NSSF of the VPLMN shall subscribe with the NSSF of the HPLMN for notifications when an HPLMN S-NSSAI needs to be replaced with an Alternative S-NSSAI.
-	If the serving AMF support the Network Slice Instance Replacement and configured to use Network Slice Instance Replacement, the AMF subscribes with the NSSF of the VPLMN for notifications when a Network Slice instance is congested or no longer available as described in clause 5.15.19. The NSSF of the VPLMN shall subscribe with the NSSF of the HPLMN for notifications when the Network Slice instance is congested or no longer available.
A 5GS supports Network Slicing and might need to interwork with the EPS in its PLMN or in other PLMNs as specified in clause 5.17.2. The EPC may support the Dedicated Core Networks (DCN). In some deployments, the MME selection may be assisted by a DCN-ID provided by the UE to the RAN (see TS 23.401 [26]).
Mobility between 5GC to EPC does not guarantee all active PDU Session(s) can be transferred to the EPC.
During PDN connection establishment in the EPC, the UE allocates the PDU Session ID and sends it to the SMF+PGW-C via PCO. As described in clause 4.11.0a.5 of TS 23.502 [3], an S-NSSAI associated with the PDN connection is determined based on the S-NSSAI(s) supported by the SMF+PGW-C, the Subscribed S-NSSAI from UDM and the operator policy by the SMF+PGW-C, e.g. based on a combination of SMF+PGW-C address and APN, and is sent to the UE in PCO together with a PLMN ID that the S-NSSAI relates to. In Home Routed roaming case, the UE receives a HPLMN S-NSSAI value from the SMF+PGW-C. If the SMF+PGW-C supports more than one S-NSSAI and the APN is valid for more than one S-NSSAI, the SMF+PGW-C should only select an S-NSSAI that is mapped to the subscribed S-NSSAI of the UE and this subscribed S-NSSAI is not subject to Network Slice-Specific Authentication and Authorization. The UE stores this S-NSSAI and the PLMN ID associated with the PDN connection. The UE derives Requested NSSAI by taking into account of the received PLMN ID. The Requested NSSAI is included in the NAS Registration Request message and, subject to the conditions in clause 5.15.9, the RRC message carrying this Registration Request when the UE registers in 5GC if the UE is non-roaming or the UE has Configured NSSAI for the VPLMN in roaming case. If the UE has no Configured NSSAI of the VPLMN, the UE includes the HPLMN S-NSSAIs in the NAS Registration Request message as described in clause 5.15.5.2.1.
When UE moves from EPS to 5GS, AMF reallocation may happen as described in clause 5.15.7.2 and clause 5.15.7.3.
NOTE:	It is assumed that if a MME is configured with a N26 interface towards an AMF, the MME has N26 interfaces with all AMFs serving the same area than the initial AMF and that can serve UE subject to EPS to 5GS mobility.
In addition to the interworking principles documented in clause 5.17.2 the following applies for interworking with N26:
-	When UE moves from 5GS to EPS, the UE context information sent by AMF to MME includes the UE Usage type, which is retrieved from UDM by AMF as part of subscription data.
-	When UE moves from EPS to 5GS, then the UE includes the S-NSSAIs (with values for the Serving PLMN of the target 5GS, if available) associated with the established PDN connections in the Requested NSSAI in RRC Connection Establishment (subject to the conditions set out in clause 5.15.9) and NAS. The UE also provides to the AMF in the Registration Request message the mapping information as described in clause 5.15.6. The UE derives the S-NSSAIs values for the Serving PLMN by using the latest available information from EPS (if received in PCO) and from 5GS (e.g. based on URSP, Configured NSSAI, Allowed NSSAI). In the home-routed roaming case, the AMF selects default V-SMFs. The SMF+PGW-C sends PDU Session IDs and related S-NSSAIs to AMF. The AMF derives S-NSSAI values for the Serving PLMN as described in clause 5.15.5.2.1 and determines whether the AMF is the appropriate AMF to serve the UE. If not, the AMF reallocation may need be triggered. For each PDU Session the AMF determines whether the V-SMF need be reselected based on the associated S-NSSAI value for the Serving PLMN. If the V-SMF need be reallocated, i.e. change from the default V-SMF to another V-SMF, the AMF trigger the V-SMF reallocation as described in clause 4.23.3 of TS 23.502 [3].
In addition to the interworking principles documented in clause 5.17.2 the following applies for interworking without N26:
-	When the UE initiates the Registration procedure, and subject to the conditions set out in clause 5.15.9, the UE includes the S-NSSAI (with values for the Serving PLMN of the target 5GS) associated with the established PDN connections in the Requested NSSAI in the RRC Connection Establishment.
-	The UE includes the S-NSSAIs (with values for the Serving PLMN of the target 5GS, if available) and the HPLMN S-NSSAI received in the PCO for the PDN connections as mapping information when moving PDN connections to 5GC using PDU Session Establishment Request message. The UE derives the S-NSSAIs values for the Serving PLMN by using, the latest available information from EPS (if received in PCO) and from 5GS (e.g. based on URSP, Configured NSSAI, Allowed NSSAI).
In addition to the interworking principles documented in clause 5.17.2 the following applies for interworking with N26:
-	When a UE is CM-CONNECTED in 5GC and a handover to EPS occur, the AMF selects the target MME based on the source AMF Region ID, AMF Set ID and target location information. The AMF forwards the UE context to the selected MME over the N26 Interface. In the UE context, the AMF also includes the UE Usage type, if it is received as part of subscription data. The Handover procedure is executed as documented in TS 23.502 [3]. When the Handover procedure completes successfully the UE performs a Tracking Area Update. This completes the UE registration in the target EPS. As part of this the UE obtains a DCN-ID if the target EPS uses it.
-	When a UE is ECM-CONNECTED in EPC, and performs a handover to 5GS, the MME selects the target AMF based on target location information, e.g. TAI and any other available local information (including the UE Usage Type if one is available for the UE in the subscription data) and forwards the UE context to the selected AMF over the N26 interface. In the home-routed roaming case, the AMF selects default V-SMFs. The Handover procedure is executed as documented in TS 23.502 [3]. The SMF+PGW-C sends PDU Session IDs and related S-NSSAIs to AMF. Based on the received S-NSSAIs values the target AMF derives the S-NSSAI values for the Serving PLMN, the target AMF reselects a final target AMF if necessary as described in clause 5.15.5.2.1, the AMF reallocation procedure is triggered. For each PDU Session based on the associated derived S-NSSAI values if the V-SMF need be reallocated, the final target AMF triggers the V-SMF reallocation as described in clause 4.23.2 of TS 23.502 [3]. When the Handover procedure completes successfully the UE performs a Registration procedure. This completes the UE registration in the target 5GS and as part of this the UE obtains an Allowed NSSAI.
As described in clause 5.15.15, if Network Slice usage control is required for a PDN Connection, the SMF+PGW-C configures PDU Session inactivity timer to the UPF+PGW-U. When the SMF+PGW-C receives inactivity report of the PDN Connection from the UPF+PGW-U, the SMF+PGW-C releases the PDN Connection.
A Network Slice may be supported in the whole PLMN or in one or more Tracking Areas of the PLMN. Network Slices may also be available with an NS-AoS not matching deployed Tracking Areas as defined in clause 5.15.18.
The availability of a Network Slice refers to the support of the S-NSSAI in the involved NFs. In addition, policies in the NSSF may further restrict from using certain Network Slices in a particular TA, e.g. depending on the HPLMN of the UE. The UE can receive, for a Network Slice where the NS-AoS does not match the whole set of cells in one or more TAs, S-NSSAI location availability information as described in clause 5.15.18.
The support of a Network Slice in a TA is established end-to-end using a combination of OAM and signalling among network functions. It is derived by using the S-NSSAIs supported per TA in 5G-AN, the S-NSSAIs supported in the AMF and operator policies per TA in the NSSF.
The AMF learns the S-NSSAIs supported per TA by the 5G-AN when the 5G-AN nodes establish or update the N2 connection with the AMF (see TS 38.413 [34]) and TS 38.300 [27]). One or all AMF per AMF Set provides and updates the NSSF with the S-NSSAIs support per TA. The 5G-AN learns the S-NSSAIs per PLMN ID the AMFs it connects to support when the 5G-AN nodes establishes the N2 connection with the AMF or when the AMF updates the N2 connection with the 5G-AN (see TS 38.413 [34] and TS 38.300 [27]).
The NSSF may be configured with operator policies specifying under what conditions the S-NSSAIs can be restricted per TA and per HPLMN of the UE.
The per TA restricted S-NSSAIs may be provided to the AMFs of the AMF Sets at setup of the network and whenever changed.
The AMF may be configured for the S-NSSAIs it supports with operator policies specifying any restriction per TA and per HPLMN of the UE.
The Serving PLMN can control per Access Type which (if any) NSSAI the UE includes in the Access Stratum when establishing a connection caused by Service Request, Periodic Registration Update or Registration procedure used to update the UE capabilities. In addition, the Home and Visited PLMNs can also instruct the UE to never include NSSAI in the Access Stratum, regardless of the procedure that causes a RRC Connection to be established, i.e. to always enable privacy for the NSSAI).
During the Registration procedure, the AMF may provide to the UE in the Registration Accept message, an Access Stratum Connection Establishment NSSAI Inclusion Mode parameter, indicating whether and when the UE shall include NSSAI information in the Access Stratum Connection Establishment (e.g. an RRC connection Establishment defined in TS 38.331 [28]) according to one of these modes:
a)	The UE shall include an NSSAI set to the Allowed NSSAI, if available, in the Access Stratum Connection Establishment caused by a Service Request, Periodic Registration Update or Registration procedure used to update the UE capabilities;
b)	The UE shall include a NSSAI with the following content:
-	for the case of Access Stratum Connection Establishment caused by a Service Request: an NSSAI including the S-NSSAI(s) of the Network Slice(s) that trigger the Access Stratum Connection Establishment; i.e. all the S-NSSAIs of the PDU sessions that have the User Plane reactivated by the Service Request, or the S-NSSAIs of the Network Slices a Control Plane interaction triggering the Service Request is related to, e.g. for SM it would be the S-NSSAI of the PDU Session the SM message is about;
-	for the case of Access Stratum Connection Establishment caused by a Periodic Registration Update or Registration procedure used to update the UE capabilities, an NSSAI set to the Allowed NSSAI;
c)	The UE shall not include any NSSAI in the Access Stratum Connection Establishment caused by Service Request, Periodic Registration Update or Registration procedure used to update the UE capabilities; or
d)	The UE shall not provide NSSAI in the Access stratum.
For the case of Access Stratum Connection Establishment caused by Mobility Registration Update or Initial Registration in modes a), b) or c) the UE shall include the Requested NSSAI provided by the NAS layer and defined in clause 5.15.5.2.1.
For all UEs that are allowed to use modes a), b) or c), the Access Stratum Connection Establishment NSSAI Inclusion Mode should be the same over the same Registration Areas.The UE shall store and comply to the required behaviour for a PLMN per Access Type as part of the network slicing configuration. The Serving PLMN AMF shall not instruct the UE to operate in any other mode than mode d) in 3GPP Access Type unless the HPLMN provides an indication that it is allowed to do so (i.e. if a PLMN allows behaviours a,b,c, then its UDM sends to the serving AMF an explicit indication that the NSSAI can be included in RRC as part of the subscription data).
The UE default mode of operation is the following:
-	For 3GPP access the UE shall by default operate in mode d) unless it has been provided with an indication to operate in mode a), b) or c).
-	For untrusted non-3GPP access the UE shall operate by default in mode b) unless it has been provided with an indication to operate in mode a), c) or d).
-	For trusted non-3GPP access the UE shall operate by default in mode d) unless it has been provided with an indication to operate in mode a), b) or c).
-	For W-5GAN access the 5G-RG shall operate by default in mode b) unless it has been provided with an indication to operate in mode a), c) or d).
An operator may pre-configure the UE to operate by default according to mode c) in the HPLMN (i.e. the UE by default includes NSSAI in the access stratum when it performs an Initial Registration and Mobility Registration Update with the HPLMN until the HPLMN changes the mode as described above).
A serving PLMN or SNPN shall perform Network Slice-Specific Authentication and Authorization for the S-NSSAIs of the HPLMN or SNPN which are subject to it based on subscription information. The UE shall indicate in the Registration Request message in the UE 5GMM Core Network Capability whether it supports NSSAA feature. If the UE does not support NSSAA feature and if the UE requests any of these S-NSSAIs that are subject to Network Slice-Specific Authentication and Authorization, the AMF shall not trigger this procedure for the UE and they are rejected for the PLMN or SNPN. If the UE supports NSSAA feature and if the UE requests any of these S-NSSAIs that are subject to Network Slice-Specific Authentication and Authorization, they are included in the list of Pending NSSAI for the PLMN or SNPN, as described in clause 5.15.5.2.1.
If a UE is configured with S-NSSAIs, which are subject to Network Slice-Specific Authentication and Authorization, the UE stores an association between the S-NSSAI and corresponding credentials for the Network Slice-Specific Authentication and Authorization.
NOTE 1:	How the UE is aware that an S-NSSAI is subject to Network Slice-Specific Authentication and Authorization (e.g. based on local configuration) is out of scope of this specification.
The UE may support remote provisioning of credentials for NSSAA, specified in clause 5.39.
A UE that supports to be provisioned with the credentials used for NSSAA over UP remote provisioning shall use connectivity over an S-NSSAI/DNN which can access the provisioning server to establish a PDU session for remote provisioning as defined in clause 5.39.
NOTE 2:	The credentials for Network Slice-Specific Authentication and Authorization are not specified.
To perform the Network Slice-Specific Authentication and Authorization for an S-NSSAI, the AMF invokes an EAP- based Network Slice-Specific authorization procedure documented in clause 4.2.9 of TS 23.502 [3] (see also TS 33.501 [29]) for the S-NSSAI. When an NSSAA procedure is started and is ongoing for an S-NSSAI, the AMF stores the NSSAA status of the S-NSSAI as pending and when the NSSAA is completed the S-NSSAI becomes either part of the Allowed NSSAI or a Rejected S-NSSAI. The NSSAA status of each S-NSSAI, if any is stored, is transferred when the AMF changes.
This procedure can be invoked for a supporting UE by an AMF at any time, e.g. when:
a.	The UE registers with the AMF and one of the S-NSSAIs of the HPLMN or SNPN which maps to an S-NSSAI in the Requested NSSAI is requiring Network Slice-Specific Authentication and Authorization (see clause 5.15.5.2.1 for details), and the S-NSSAI in the Requested NSSAI can be added to the Allowed NSSAI by the AMF once the Network Slice-Specific Authentication and Authorization for the HPLMN or SNPN S-NSSAI succeeds; or
b.	The Network Slice-Specific AAA Server triggers a UE re-authentication and re-authorization for an S-NSSAI; or
c.	The AMF, based on operator policy or a subscription change, decides to initiate the Network Slice-Specific Authentication and Authorization procedure for a certain S-NSSAI which was previously authorized.
	In the case of re-authentication and re-authorization (b. and c. above) the following applies:
-	If S-NSSAIs that are requiring Network Slice-Specific Authentication and Authorization map to S-NSSAIs that are included in the Allowed NSSAI for each Access Type, AMF selects an Access Type to be used to perform the Network Slice Specific Authentication and Authorization procedure based on network policies.
-	If the Network Slice-Specific Authentication and Authorization for some S-NSSAIs mapped to some S-NSSAIs in the Allowed NSSAI is unsuccessful, the AMF shall update the Allowed NSSAI for each Access Type to the UE via UE Configuration Update procedure.
-	If the Network Slice-Specific Authentication and Authorization fails for all S-NSSAIs mapped to all S-NSSAIs in the Allowed NSSAI, the AMF determines a new Allowed NSSAI including default S-NSSAI(s). If no default S-NSSAI(s) could be added, the AMF shall execute the Network-initiated Deregistration procedure described in clause 4.2.2.3.3 of TS 23.502 [3] and shall include in the explicit De-Registration Request message the list of Rejected S-NSSAIs, each of them with the appropriate rejection cause value.
After a successful or unsuccessful UE Network Slice-Specific Authentication and Authorization, the UE context in the AMF shall retain the authentication and authorization status for the UE for the related specific S-NSSAI of the HPLMN or SNPN while the UE remains RM-REGISTERED in the PLMN or SNPN, so that the AMF is not required to execute a Network Slice-Specific Authentication and Authorization for a UE at every Periodic Registration Update or Mobility Registration procedure with the PLMN or SNPN.
A Network Slice-Specific AAA server may revoke the authorization or challenge the authentication and authorization of a UE at any time. When authorization is revoked for an S-NSSAI that maps to an S-NSSAI in the current Allowed NSSAI for an Access Type, the AMF shall provide a new Allowed NSSAI to the UE and trigger the release of all PDU sessions associated with the S-NSSAI, for this Access Type.
The AMF provides the GPSI of the UE related to the S-NSSAI to the AAA Server to allow the AAA server to initiate the Network Slice-Specific Authentication and Authorization, or the Authorization revocation procedure, where the current AMF serving the UE needs to be identified by the system, so the UE authorization status can be challenged or revoked.
The Network Slice-Specific Authentication and Authorization requires that the UE Primary Authentication and Authorization of the SUPI has successfully completed. If the SUPI authorization is revoked, then also the Network Slice-Specific authorization is revoked.
The Network Slice Admission Control Function (NSACF) monitors and controls the number of registered UEs per network slice and/or the number of PDU Sessions per network slice for the network slices that are subject to Network Slice Admission Control (NSAC). The NSACF is configured with the maximum number of UEs and/or the maximum number of PDU Sessions allowed to be served per S-NSSAI subject to NSAC. The NSACF is also configured with information indicating applicable access type(s) for the S-NSSAI (i.e. 3GPP Access Type, Non-3GPP Access Type, or both).
The NSACF also provides event-based Network Slice status notifications and reports to the consumer NFs (e.g. AF).
The NSACF may be responsible for one or more S-NSSAIs. For one S-NSSAI there may be one or multiple NSACFs deployed in a network (a PLMN or a SNPN) as follows:
-	If the network is configured with a single NSAC service area, there is a single NSACF configured with the maximum number of UEs per network slice and/or the maximum number of PDU Sessions per network slice, which are valid in the network.
-	If the network is configured with multiple NSAC service areas, an NSACF may be deployed on a NSAC service area basis, which can be one NSACF instance or one NSACF Set. There are three multiple NSAC architecture options:
-	Option 1: non-Hierarchal NSAC architecture. In this architecture, independent NSACFs are deployed in every NSAC service area. There is no interaction between the NSACFs deployed in different NSAC service areas. Each NSACF is configured with the maximum number of UEs per network slice and/or the maximum number of PDU Sessions which are valid in the NSAC service area (see clause 5.15.11.1 for more details).
-	Option 2: Centralized NSAC architecture. In this architecture, a single centralized NSACF is deployed in the network to handle admissions in all NSAC service areas. The centralized NSACF is configured with the total number of UEs per network slice and the maximum number of PDU Sessions for the entire PLMN. NSAC Requests from AMF or SMF to the single centralized NSCAF in this case includes the NSAC service area of the NF consumer if multiple NSAC service areas are deployed in PLMN.
NOTE 1:	It is possible to configure in the centralized architecture the maximum number of registered UEs and/or the number of PDU sessions per service area if required by the operator. In this case, NSAC admission can be performed on a per NSAC service area.
-	Option 3: Hierarchical NSAC architecture is deployed in the network. There are two roles of NSACF and interaction between them may be required (see clause 5.15.11.1a for more details):
-	Primary NSACF, controls and distributes of the maximum number of UEs and/or the maximum number of PDU Sessions for other NSACF(s) deployed in different NSAC service Area. The Primary NSACF handles overall NSAC for an S-NSSAI at the global level (i.e. it is ultimately responsible for the NSAC for an S-NSSAI).
‐	NSACF is responsible for one or multiple NSAC service Area. And one NSAC service area is only associated with one NSACF instance or one NSACF Set.
NOTE 2:	When multiple NSACFs are deployed, how the maximum number of UEs per network slice and the maximum number of PDU Sessions per network slice is distributed (by OAM for Option 1 and by the primary NSAF for Option 3) among multiple NSACFs, i.e. the algorithm of the maximum number distribution, is implementation specific.
NOTE 3:	When multiple NSACFs are deployed based on option 1, the UE moves to new NSAC service area with a different NSACF, and if the number of UE or PDU Sessions in the target NSACF has reached the maximum number, whether the session continuity can be guaranteed is left to implementation.
Subject to operator policy and national/regional regulations, the AMF may exempt UEs and the SMF may exempt PDU sessions from NSAC when the UE and/or PDU Session is used for Emergency service or for Critical and Priority services (e.g. MCX, MPS).
When the AMF receives a Registration Request for an Emergency Registration, or with a Registration Request with an Establishment Cause indicating a priority service (e.g. MCX, MPS) or when the AMF determines that there is a priority subscription (e.g. MPS, MCX) in the UDM, the AMF may accept the registration request without applying NSAC, i.e. the AMF triggers the NSAC procedure, but the response from the NSACF is ignored at the AMF.
When the SMF receives a PDU Session Establishment Request for an emergency PDU Session or a PDU Session Establishment Request with a priority header, the SMF may accept the PDU Session Establishment Request without applying NSAC, i.e. the SMF triggers the NSAC procedure, but the response from the NSACF is ignored at the SMF.
Alternatively, when NSAC is exempted for the UE and/or PDU Session, the AMF and the SMF skip the corresponding NSAC procedure, i.e. this UE (respectively PDU Session) is not counted towards the maximum number of UEs (respectively PDU Sessions).
The support of NSAC for the S-NSSAI used for onboarding as described in clause 5.30.2.10 is optional and subject to Onboarding Network operator policies. However, NSAC for S-NSSAI used for onboarding is not applicable to UEs that registered in ON-SNPN with Registration Type "SNPN Onboarding".
The NSACF keeps track of the current number of UEs registered for a network slice so that it can ensure it does not exceed the maximum number of UEs allowed to register with the network slice. The NSACF also maintains a list of UE IDs registered with a network slice that is subject to NSAC. When an event related to a UE causes the current number of UEs registered with a network slice to increase, the NSACF first checks whether the UE Identity is already in the list of UEs registered with that network slice. If not, the NSACF checks whether the maximum number of UEs per network slice for that network slice has already been reached and if it has, the NSACF applies admission control policies.
The AMF triggers a request to NSACF for NSAC for maximum number of UEs when the UE's registration status for a network slice subject to NSAC is changing, i.e. during the UE Registration procedure in clause 4.2.2.2.2 of TS 23.502 [3], UE Deregistration procedure in clause 4.2.2.3 of TS 23.502 [3], Network Slice-Specific Authentication and Authorisation procedure in clause 4.2.9.2 of TS 23.502 [3], AAA Server triggered Network Slice-Specific Re-authentication and Re-authorization procedure in clause 4.2.9.3 of TS 23.502 [3], AAA Server triggered Slice-Specific Authorization Revocation in clause 4.2.9.4 of TS 23.502 [3] and UE Configuration Update procedure in clause 4.2.4.2 of TS 23.502 [3].
NOTE 1:	Early Admission Control (EAC) mode is applicable for Number of UEs per network slice admission control. The use of EAC in relation to the number of registered UEs is described in clauses 4.2.11.2 and 4.2.11.3 of TS 23.502 [3].
Since the UE may register or deregister for an S-NSSAI via 3GPP access and/or non-3GPP access as described in clause 5.15.5.2.1. The Allowed NSSAI for the access type may change while the UE is registering to a network. The AMF provides the Access Type to the NSACF when triggering a request to increase or decrease the current number of UEs registered with a S-NSSAI. The NSACF may take the Access Type into account for increasing and decreasing the number of UEs per network slice by storing the UE ID with the associated one or more Access Type(s), i.e. the NSACF is able to add or remove a registration for the UE ID for each Access Type and trigger the increase or decrease of the current number of UEs registered with a S-NSSAI based on a policy that takes the access type into account. If the Access Type provided by the AMF is not configured for NSAC in the NSACF, the NSACF always accepts the request from the AMF without increasing or decreasing the number of UEs. If the Access Type provided by the AMF is configured for NSAC in the NSACF and the maximum number is reached, the NSACF sends a reject response to the AMF including the access type.
NOTE 2:	For example, if the NSACF is configured to apply NSAC for 3GPP Access Type only, the NSACF counts registration via 3GPP access type only. If the NSACF is configured to apply NSAC for both Access Types, and the UE newly registers via 3GPP access while the UE is already registered via non-3GPP access (or vice versa), the NSACF updates the UE ID entry with both 3GPP Access Type and non-3GPP Access Type and the NSACF may count the UE once or twice based on its policy.
In the hierarchal NSAC architecture, the NSACFs deployed in the service areas interacts with the primary NSACF when needed, and as explained below.
The main differences between the NSACFs deployed in a non-hierarchal architecture and NSACFs deployed in a hierarchal architecture is as follows:
-	When the AMF triggers an NSAC request to the NSACF, the AMF includes the UE already Registered indication if it can determine that the registered S-NSSAI has been registered in one service area before. The AMF determines the indication based on the received the Allowed NSSAI information from source AMF (in case of inter AMF handover) or from SMF+PGW-C (in case of mobility from EPS to 5GS)
-	There are two types of UE admission control: quota-based control or threshold-based control. A PLMN is configured to deploy only one type of UE admission control. Based on the type of UE admission control configured for the PLMN, the NSACF handles the NSAC request as described below:
-	For NSACFs supporting quota-based control, if upon receiving a request to increase the number of UEs and the local maximum number of UEs registered for a network slice has been reached, or upon receiving a request to decrease the number of UEs and no UE entry is in the NSACF, the NSACF interacts with the Primary NSACF for the handling of the NSAC request for the UE. The Primary NSACF may return in the response an updated local maximum number of registered UEs value to the NSACF based on the status of registered UEs for the network slice and which enables the NSACF to handle locally the request. Alternatively, and if the request includes the UE already Registered indication, the Primary NSACF may handle and store the UE entry to enable UE admission and allow for service continuity. The Primary NSACF may also reject the request.
-	For NSACF supporting threshold-based control, the NSACF is initially configured with the maximum number of Registered UEs to be admitted. If upon a receiving a request to increase the number of UEs and no UE already Registered indication and if UE admission threshold is at or above the threshold level configured at the NSACF, NSACF immediately rejects the NSAC request. If the received request includes the UE already Registered indication and if UE admission is at or above the threshold level configured at the NSACF, NSACF accepts the request to enable UE admission and allow for service continuity as long as the maximum number of Registered UEs have not been reached. If the local maximum number of registered UEs value have been reached, the NSACF interacts with the Primary NSACF for the handling of the NSAC request for the UE. The NSACF does not include the UE already Registered Indication in this case. The Primary NSACF may return an updated UE admission threshold value to the NSACF in the response which enables the NSACF to handle the request locally. Alternatively, the Primary NSACF may handle and store the UE entry. The Primary NSACF may also reject the request.
-	For both options, the Primary NSACF supports the following capabilities depending on the NSACF configuration:
-	Returning a new updated local maximum number of Registered UEs for the NSACF to admit if the NSACF is configured to support that feature; or
-	Returning a new updated UE admission threshold for the NSACF to apply if the NSACF is configured to support that feature;
-	The primary NSACF handles, stores entries only related to UEs which the NSAC request includes the UE already Registered indication, that are already admitted in an existing service area but cannot be admitted in the new service area due to no remaining local maximum number of Registered UEs, as long as the overall PLMN number of registered UEs at the Primary NSACF is not exhausted. The primary NSACF informs the NSACF in its response;
-	Based on the response from primary NSACF, the NSACF determines whether to accept or reject the NSAC request for UE registration. In addition, the NSACF may also update the local maximum number of Registered UEs or admission threshold respectively if the related updated value is received;
-	At any time, the Primary NSACF can update the NSACFs local maximum number of Registered UEs or admission threshold through the request/response XYZ service operation.
-	The Primary NSACF subscribes to all the NACFs to obtain the number of registered UEs at all NSACFs.
The main differences between the NSACFs deployed in a non-Hierarchical Single tier architecture and NSACFs deployed in a centralized architecture is as follows:
-	If multiple NSAC service areas are deployed in PLMN, the AMF provides the NSAC service area information to the centralized NSACF. The centralized NSACF also stores the NSAC service area of the AMF the UE is registered with.
The NSACF keeps track of the current number of PDU Sessions per network slice so that it can ensure it does not exceed the maximum number of PDU session allowed to be served by the network slice. When an event related to a UE causes the current number of PDU sessions established within the network slice is to increase, the NSACF checks whether the maximum number of PDU sessions per network slice for that network slice has already been reached and if it has, the NSACF applies admission control policies.
The anchor SMF triggers a request to NSACF for maximum number of PDU sessions per network slice control during PDU session establishment/release procedures in clauses 4.3.2 and 4.3.4 of TS 23.502 [3].
The SMF provides the Access Type to the NSACF when triggering a request to increase or decrease the number of PDU Sessions. The NSACF takes Access Type into account for increasing and decreasing the current number of PDU Sessions depending on the applicability of the Access Type for the NSAC for maximum number of PDU Sessions for the S-NSSAI.
NOTE 1:	For MA PDU Session, the SMF provides the Access Type to NSACF when the user plane connection is about to be established or released in the corresponding access network. With this, the SMF provides one or two Access Types for the MA PDU Session in the same request message to the NSACF. The NSACF can reject a single or both Access Types depending on the applicability of the Access Type for the NSAC.
NOTE 2:	I-SMF does not interact with NSCAF.
The main differences between the NSACFs deployed in a non-hierarchal architecture and NSACFs deployed in a hierarchal architecture is as follows:
-	The NSCAF is enhanced to support PDU session admission quota-based control.
-	When the local maximum number of PDU sessions is reached, the NSACF interacts with the primary NSACF to handle the request. The Primary NSACF either return an increased local maximum number to the NSACF, or reject the local maximum number value update request if all the global maximum number are consumed based on the status of established PDU sessions to the network slice.
-	Based on the response from primary NSACF, the NSACF updates the local maximum number if updated value is received from the primary NSACF. The NSACF updates local maximum number value (if received) and determines whether to accept or reject the NSAC request for PDU session establishment based on the local maximum number value.
-	The update of local maximum number value by the Primary NSACF can also happen at any time through the request/response service XYZ operation.
-	The Primary NSACF subscribes to all the NACFs to obtain the number of established PDU sessions at all NSACFs.
The main differences between the NSACFs deployed in a non-Hierarchical architecture and NSACFs deployed in a centralized architecture is as follows
-	If multiple NSAC service areas are deployed in PLMN, the SMF provides the NSAC service area information to the centralized NSACF. The centralized NSACF also stores the NSAC service area of the SMF the PDU session is established on.
In the case of roaming, depending on operator's policy, a roaming agreement or an SLA between the VPLMN and the HPLMN, NSAC of roaming UEs is performed by one of the following modes of NSAC admission:
-	VPLMN NSAC Admission; or
-	VPLMN with HPLMN assistance NSAC Admission; or
-	HPLMN NSAC Admission.
The VPLMN (AMF and SMF) identifies the mode to apply from the AMF subscription data at UE registration, and from the SMF subscription data at PDU session establishment.
For all the above modes, for NSAC of roaming UEs for maximum number of UEs per network slice and/or maximum number of PDU Sessions per network slice managed by the VPLMN, each S-NSSAI of the HPLMN that is subject to NSAC is mapped to a corresponding S-NSSAI of the VPLMN subject to NSAC.
For both VPLMN NSAC Admission and VPLMN with HPLMN assistance NSAC Admission modes, each configured S-NSSAI that is subject to NSAC and that is mapped from the HPLMN S-NSSAI, the SMF performs NSAC for home routed PDU sessions according to the principles described in clause 5.15.11.2.
For NSAC of roaming UEs for maximum number of UEs per network slice and/or maximum number of PDU Sessions per network slice managed by the VPLMN, the following principles shall be used:
-	For NSAC for the maximum number of UEs for S-NSSAI of the HPLMN, a NSACF in the VPLMN can be configured with the maximum number of allowed roaming UEs per mapped S-NSSAI of the HPLMN for a S-NSSAI of the HPLMN that is subject to NSAC. In such a case, the AMFs trigger a request to a NSACF of the VPLMN.
-	For NSAC for the maximum number of PDU Sessions for S-NSSAI of the HPLMN, a NSACF in the VPLMN can be configured with the maximum number of allowed PDU Sessions in LBO mode per mapped S-NSSAI of the HPLMN for a S-NSSAI of the HPLMN that is subject to NSAC. In such a case, the anchor SMF in the VPLMN triggers a request to a NSACF of the VPLMN.
-	For NSAC for the maximum number of UEs for S-NSSAI of the VPLMN, AMFs trigger a request to a NSACF of the VPLMN to perform NSAC based on the S-NSSAI of the VPLMN subject to NSAC. The NSACF of the HPLMN is not involved.
-	For NSAC for the maximum number of PDU Sessions for S-NSSAI of the VPLMN in the LBO roaming case, the SMF triggers a request to a NSACF of the VPLMN to perform NSAC based on the S-NSSAI of the VPLMN subject to NSAC. The NSACF of the HPLMN is not involved.
‐	The AMF or SMF (in LBO roaming case) in the VPLMN provides both the S-NSSAI in the VPLMN and the corresponding mapped S-NSSAI in the HPLMN to the NSACF in the VPLMN. The NSACF in the VPLMN performs NSAC for both S-NSSAI of the VPLMN and the corresponding mapped S-NSSAI of the HPLMN based on the SLA between the VPLMN and the HPLMN.
In addition to configuring the VPLMN NFs with the maximum number of allowed roaming UEs per mapped S-NSSAI of the HPLMN subject to NSAC, and the maximum number of allowed PDU Sessions in LBO mode per mapped S-NSSAI of the HPLMN subject to NSAC, the VPLMN can optionally fetch this information from the HPLMN primary NSACF in a hierarchal architecture or centralized NSACF in a centralized architecture. If the NSACF in VPLMN does not have quota configured but can receive quota from the HPLMN, the NSACF in VPLMN may interact with the HPLMN for retrieving the quota before processing any incoming request. The VPLMN is either configured or discovers the NSACF in the HPLMN for quota retrieval. However, in this case, the VPLMN rejects any additional requests exceeding the received information.
In this admission mode HPLMN delegates NSAC for S-NSSAIs subject to NSAC to the VPLMN, both for number of registered UEs and the number of LBO PDU sessions.
Every NSACF performing admission in the VPLMN for each S-NSSAI of the HPLMN that is subject to NSAC and mapped to a corresponding S-NSSAI of the VPLMN, fetches from the VPLMN primary NSACF in a hierarchal architecture the maximum number of registered UEs to be admitted and/or the maximum number of LBO PDU sessions to be allowed. The VPLMN primary or central NSACF, in turn, acquires the information from the HPLMN central or primary NSACF depending on the deployed architecture. The VPLMN is either configured or discovers the NSACF in the HPLMN for quota retrieval.
If re-distribution of quota is required in the VPLMN in a hierarchal architecture, amongst multiple NSACFs than this is handled by the primary NSACF in VPLMN with no involvement from the HPLMN. The VPLMN NSACF discovers the HPLMN primary or central NSACF or be configured with the needed information.
For any request(s) received in any NSACF in the VPLMN exceeding the received maximum number information, the NSACF interacts with the VPLMN primary NSACF which in turn interacts with HPLMN primary or central NSACF to receive an updated roaming quota for the corresponding mapped S-NSSAI, which is used to determine whether admission request is accepted or rejected, unless forbidden by the SLA. If an admission request is accepted, the UE entry is stored in the NSACF performing admission in the VPLMN. This applies to the number of registered UEs as well as the number of LBO PDU sessions. The primary NSACF in VPLMN may re-distribute the received updated roaming quota to the NSACFs in VPLMN to perform NSAC for Roaming UEs according to the principles described in clauses 5.15.11.1 and 5.15.11.2.
In this admission mode the AMF or SMF in VPLMN interacts with HPLMN for admission, both for number of registered UEs or the number of LBO PDU sessions respectively.
For each S-NSSAI of the HPLMN that is subject to NSAC and mapped to a corresponding S-NSSAI of the VPLMN, AMF performs NSAC admission for the number of registered UEs with the HPLMN central or primary NSACF for all inbound roamers from that HPLMN when they register in this VPLMN. The AMF discovers the HPLMN primary or central NSACF or be configured with the needed information.
For each S-NSSAI of the HPLMN that is subject to NSAC and mapped to a corresponding S-NSSAI of the VPLMN, every SMF in this VPLMN performs NSAC admission for the number of LBO PDU sessions with the HPLMN central or primary NSACF for all inbound roamers from that HPLMN when they initiate an LBO PDU session. The SMFs discover the HPLMN primary or central NSACF or be configured with the needed information. For each S-NSSAI of the HPLMN that is subject to NSAC, the SMF performs NSAC according to the principles described in clause 5.15.11.2 for home routed PDU sessions.
In the HPLMN NSAC admission mode, the primary NSACF or central NSACF in HPLMN determines whether the NSAC admission request for a roaming UE is accepted or rejected.
A consumer NF (e.g. AF, Primary NSACF) can subscribe with the NSACF for Network Slice status notifications and reports. Upon such subscription, the corresponding NSACF in different NSAC architecture as defined in clause 5.15.11.0 can provide event based notifications and reports to the consumer NF (e.g. to AF via NEF) related to the current number of UEs registered for a network slice or the current number of UEs with at least one PDU Session/PDN Connection in the case of EPC interworking or the current number of PDU Sessions established on a network slice.
NOTE:	The Primary NSACF subscribes Network Slice status from all the NSACF(s) it contacts with for the update of the maximum number of UE or PDU session configured at the NSACF.
This clause describes the NSAC for maximum number of registered UEs and for maximum number of PDU Sessions for network slice subjected to EPS interworking. The NSAC for maximum number of UE with at least one PDU Session/PDN Connection is described in clause 5.15.11.5a. A network slice subject to both NSAC and EPS counting shall be configured with only one of the options:
-	Maximum number of registered UEs and/or maximum number of PDU Session; or
-	Maximum number of UEs with at least one PDU Session/PDN Connection and/or maximum number of PDU Session.
If EPS counting is required for a network slice, the NSAC for maximum number of UEs and/or for maximum number of PDU Sessions per network slice is performed at the time of PDN connection establishment in case of EPC interworking. To support the NSAC for maximum number of UEs and/or for maximum number of PDU Sessions per network slice in EPC, the SMF+PGW-C is configured with the information indicating which network slice is subject to NSAC. During PDN connection establishment in EPC, the SMF+PGW-C selects an S-NSSAI associated with the PDN connection as described in clause 5.15.7.1. If the selected S-NSSAI by the SMF+PGW-C is subject to the NSAC, the SMF+PGW-C triggers interaction with NSACF to check the availability of the network slice by invoking separate NSAC procedures for number of UE and number of PDU Session (as described in clause 4.11.5.9 of TS 23.502 [3]), before the SMF+PGW-C provides the selected S-NSSAI to the UE. If the network slice is available, the SMF+PGW-C continues to proceed with the PDN connection establishment procedure.
The NSACF performs the following for checking network slice availability prior to returning a response to the SMF+PGW-C:
-	For NSAC for number of UEs, if the UE identity is already included in the list of UE IDs registered with a network slice, or the UE identity is not included in the list of UE IDs registered with a network slice and the current number of UE registration did not reach the maximum number, the NSACF responds to the SMF+PGW-C with the information that the network slice is available. The NSACF includes the UE identity in the list of UE IDs if not already on the list and increases the current number of UE registration. Otherwise, the NSACF returns a response indicating that the maximum number with the network slice has been reached.
	If hierarchical NSAC architecture is deployed, when the local maximum number or local threshold is reached the NSAC may interact with the Primary NSACF before it returns the response back to the SMF+PGW-C. For more details on handling at the NSACF and Primary NSACF see clause 5.15.11.1.2.
-	For NSAC for number of PDU Sessions, if the current number of PDU sessions is below the maximum number, the NSACF responds to the SMF+PGW-C with the information that the network slice is available. The NSACF increases the current number of PDU sessions. Otherwise, the NSACF returns the response indicating that the maximum number with the network slice has been reached.
	If hierarchical NSAC architecture is deployed, when the local maximum number is reached the NSAC may interact with the Primary NSACF before it returns the response back to the SMF+PGW-C. For more details on handling at the NSACF and Primary NSACF see clause 5.15.11.2.2.
If the maximum number of UEs and/or the maximum number of PDU sessions has already been reached, unless operator policy implements a different action, the SMF+PGW-C rejects the PDN connection.
NOTE 1:	As an implementation option, if the APN is mapped to more than one S-NSSAI and the first selected S-NSSAI is not available (e.g. either current number of UE registration reached maximum or current number of PDU sessions reached maximum), then based on the operator policy the PGW-C+SMF can try another mapped S-NSSAI for the PDN connection establishment procedure.
If the establishment of a new PDN Connections is with a different SMF+PGW-C from the SMF+PGW-C used for already existing PDN connection associated with the same S-NSSAI, each SMF+PGW-C will send a request for update (e.g. increase or decrease) to the NSACF. The NSACF may maintain a registration entry per SMF+PGW-C for the same UE ID.
The SMF+PGW-C provides the Access Type to the NSACF when triggering a request to increase or decrease the number of UEs and/or the number of PDU Sessions for an S-NSSAI.
NOTE 2:	The SMF+PGW-C determines the Access Type based on the RAT type parameter in the PMIP or GTP message received from the ePDG; or alternatively it can internally determine the Access Type based on the source node (e.g. SGW) sending the request for the PDN Connection establishment.
When the UE with ongoing PDN connection(s) moves from EPC to 5GC, the SMF+PGW-C triggers a request to decrease the number of the UE registration in NSACF and the AMF triggers a request to increase the number of the UE registration in NSACF when the UE is registered in the new AMF. If there are more than one PDN connections associated with the S-NSSAI, the NSACF may receive multiple requests for the same S-NSSAI from different SMF+PGW-Cs. When the UE with ongoing PDU session(s) moves from 5GC to EPC, the SMF+PGW-C triggers a request to increase the number of the UE registration in NSACF and the old AMF triggers a request to decrease the number of the UE registration in NSACF when the UE is deregistered in old AMF. If there are more than one PDU sessions associated with the S-NSSAI, the NSACF may receive multiple requests for the same S-NSSAI from different SMF+PGW-Cs. The NSACF maintains a list of UE IDs based on the requests from SMF+PGW-C(s) and AMF, and adjusts the current number of registrations accordingly.
When EPS counting is performed for a network slice, and the UE with ongoing PDN connection(s) moves from EPC to 5GC, session continuity is guaranteed from NSAC standpoint, as the admission was granted at the time of PDN connection establishment, i.e. the number of PDU session is not counted again in 5GC. Similarly, when the UE with ongoing PDU session(s) moves from 5GC to EPC, session continuity is guaranteed from NSAC standpoint as the admission of the PDN Connection(s) to the network slice was already granted at the time of PDU Session establishment in 5GC.
If the PDN connection associated with S-NSSAI is released in EPC, the SMF+PGW-C triggers a request (i.e. decrease) to NSACF for maximum number of UEs and/or maximum number of PDU sessions per network slice control. The NSACF decreases the current number of registrations and removes the UE identity from the list of UE IDs if the PDN connection(s) associated with the S-NSSAI are all released in EPC.
NOTE 3:	NSAC in EPC is not performed for the attachment without PDN connectivity.
If EPS counting is not required for a network slice, the NSAC for maximum number of UEs and/or for maximum number of PDU Sessions per network slice is performed when the UE moves from EPC to 5GC, i.e. when the UE performs mobility Registration procedure from EPC to 5GC (NSAC for maximum number of UEs per network slice) and/or when the PDN connections are handed over from EPC to 5GC (NSAC for maximum number of PDU Sessions per network slice). The SMF+PGW-C is configured with the information indicating the network slice is subject to NSAC only in 5GS. The PDN connection interworking procedure is performed as described in clause 5.15.7.1. Mobility from EPC to 5GC does not guarantee all active PDU Session(s) can be transferred to the 5GC in certain circumstances when either the current number of UE registration or the current number of PDU sessions would exceed the maximum number when the UE moves from EPC to 5GC. When the UE with ongoing PDU session(s) moves from 5GC to EPC, the SMF+PGW-C triggers a request to decrease the number of PDU Session to NSACF. If there are more than one PDU sessions associated with the S-NSSAI, the NSACF may receive multiple requests for the same S-NSSAI from different SMF+PGW-Cs and NSACF removes the PDU Session ID(s) while decreasing the number of PDU Session(s).
NOTE 4:	Given that session continuity is not guaranteed when EPS counting is not required, it is recommended for services which require the session continuity to support EPS counting.
NOTE 5:	When multiple NSACFs are deployed and if the number of UE in target NSACF has reached the maximum number, whether session continuity can be guaranteed is left to implementation.
NOTE 6:	When a centralized architecture is deployed, UE admission is guaranteed at inter-system and inter-AMF mobility if the same NSACF is selected. This is the case for non-roaming scenarios and for roaming scenarios with HPLMN NSAC Admission Mode described in clause 5.15.11.3.
5.15.11.5a	Support of Network Slice Admission Control in 5GS for maximum number of UEs with at least one PDU Session/PDN Connection
When EPS counting is required for a network slice and NSACF is configured with maximum number of UEs with at least one PDU Session/PDN Connection, the NSACF keeps track of the current number of UEs with at least one PDU session/PDN connection established on a network slice to ensure it does not exceed the maximum configured number.
To support the NSAC for maximum number of UEs with at least one PDU Session/PDN Connection, the SMF+PGW-C may be configured with one of the following options:
-	Option 1: Triggering an Nnsacf_NSAC_NumOfUEsUpdate_Request to NSACF for NSAC for maximum number of UEs when the UE establishes first PDU Session/PDN connection associated with the network slice in the SMF+PGW-C, or when the last PDU Session/PDN connection associated with the network slice is released. The NSACF performs admission control as described in clause 5.15.11.5 and the number of registered UE is replaced with number of UE with at least one PDU session/PDN connection. The AMF is not configured for this S-NSSAI to be subject to NSAC; or
-	Option 2: Triggering an Nnsacf_NSAC_NumOfPDUsUpdate_Request as described in clause 5.15.11.5 to NSACF and the NSACF performs admission control for the number of UEs with at least one PDU Session/PDN connection as follows:
-	The NSACF supports handling both for the number of UEs with at least one PDU Session/PDN Connection and number of PDU session for the S-NSSAI that is subject to EPC interworking and NSAC. In this case the AMF is not configured for this S-NSSAI to be subject to NSAC. As an optimization option, the SMF+PGW-C can be configured not to trigger the Nnsacf_NSAC_NumOfUEsUpdate_Request to NSACF.
-	When the NSACF receives request to increase the current number of PDU Session/PDN Connection established for the network slice, the NSACF checks whether this is the first PDU Session/PDN Connection associated with the network slice. If this is the first PDU Session/PDN Connection associated with the network slice the NSACF checks whether the maximum number of UEs with at least one PDU Session/PDN Connection has been reached. If the maximum number has not been reached then the NSACF increases the number of UE with at least one PDU session/PDN connection and add an entry for UE ID. If the maximum number of UEs has already been reached, unless operator policy implements a different action, the SMF+PGW-C rejects the PDU Session/PDN connection indicating the cause being the number of UEs in the network slice has been exceeded.
-	When the NSACF receives request to decrease the current number of PDU Session/PDN Connection established for the network slice, the NSACF locates the UE entry, checks whether this is the last PDU Session/PDN Connection associated with the network slice for the UE. If it is the last PDU Session/PDN Connection the NSACF decreases the number of UE with at least one PDU session/PDN connection and remove the associated UE entry.
NOTE 1:	A PLMN can deploy one of the above two options for a slice when EPS counting is required for a network slice and NSACF is configured with maximum number of UEs with at least one PDU Session/PDN Connection.
In both options, the SMF+PGW-C provides the Access Type to the NSACF when triggering a request to increase or decrease or update the number of UEs with at least one PDU Session/PDN Connection and/or the number of PDU Sessions for an S-NSSAI.
In the case of roaming, same mechanisms in clause 5.15.11.3 are used and number of registered UE is replaced with number of UE with at least one PDU Session/PDN Connection. For home routed PDU Session/PDN Connection only HPLMN admission mode can be used in this case.
If hierarchical NSAC architecture is deployed, when the local maximum number or local threshold is reached the NSAC may interact with the Primary NSACF before it returns the response back to the SMF+PGW-C. For more details on handling at the NSACF and Primary NSACF see clause 5.15.11.1.2.
NOTE 2:	When NSAC for number of UEs with at least one PDU session or one PDN connection is used, the session continuity is guaranteed at inter-system mobility as the admission is granted during the establishment of the PDU Session/PDN Connection.
The subscription information for a UE may include for each S-NSSAI Network Slice Simultaneous Registration Group (NSSRG) information constraining which S-NSSAIs can be simultaneously provided to the UE in the Allowed NSSAI.
When S-NSSAIs have associated NSSRG information, then the S-NSSAIs in the Allowed NSSAI shall share at least one NSSRG.
The NSSRG information, defining the association of S-NSSAIs to NSSRG, is provided as an additional and separate information.
 If the optional NSSRG information is not present for the S-NSSAIs of a subscription, and other restrictions do not apply e.g. availability at a specific location, then it is assumed that all the S-NSSAIs in the subscription information can be simultaneously provided to the UE in the Allowed NSSAI. However, if NSSRG information is present in the subscription information, at least one NSSRG shall be associated with each of the S-NSSAIs in the subscription information. At any time, if the AMF has received subscription information for a UE that includes NSSRG information, the Allowed NSSAI for the UE can only include S-NSSAIs which share a common NSSRG.
NOTE 1:	The AMF enforces NSSRG only for the access(es) the UE registered to the AMF. When the UE is registered to different PLMNs over 3GPP access and non-3GPP access, the AMF in one access cannot enforce a common NSSRG over both accesses.
The default S-NSSAIs, if more than one is present, are associated with the same NSSRGs, i.e. the UE is always allowed to be registered with all the default S-NSSAIs simultaneously. The HPLMN only sends S-NSSAIs sharing all the NSSRGs of the Default S-NSSAIs to a non-supporting VPLMN as part of the subscription information, i.e. in addition to the default S-NSSAI(s), the HPLMN may send any other subscribed S-NSSAI which shares at least all the NSSRG defined for the default S-NSSAI(s), and the HPLMN sends no NSSRG information to the VPLMN. A subscription information that includes NSSRG information shall include at least one default S-NSSAI.
A supporting AMF/NSSF, when it receives a Requested NSSAI, evaluates the S-NSSAIs of the HPLMN (in the mapping information of the Requested NSSAI, when a mapping information is applicable) based on any received NSSRG information for these S-NSSAIs, to determines whether they can be provided together in the Allowed NSSAI.
NOTE 2:	An HPLMN enabling support of subscription-based restrictions to simultaneous registration of network slices for a Subscriber, can set the subscribed S-NSSAI(s) already in the subscription information before the NSSRG information was added to the subscription information, to have the same NSSRGs defined for the default S-NSSAI(s) if it has to continue to support the same service behaviour for these S-NSSAIs.
A UE may support the subscription-based restrictions to simultaneous registration of network slices feature. In this case, the UE indicates its support in the Registration Request message in the Initial Registration and the Mobility Registration Update as part of the UE 5GMM Core Network Capability.
When the serving AMF provides the Configured NSSAI to the UE, and the UE has indicated it supports the subscription-based restrictions to simultaneous registration of network slices feature, the AMF also provides the UE with the NSSRG information related to the S-NSSAIs of the HPLMN which are in the mapping information of the Configured NSSAI. A UE which receives the NSSRG values in the network slicing configuration information shall only include in the Requested NSSAI S-NSSAIs that share a common NSSRG as per the received information. If the UE has stored Pending NSSAI and the UE is still interested in the Pending NSSAI then all the S-NSSAIs in the Requested NSSAI and the Pending S-NSSAI shall share a common NSSRG. If the HPLMN changes NSSRG information in the subscription information for a UE, the UDM updates the supporting AMF serving the UE with the new NSSRG information and the AMF, possibly after interaction with the NSSF (see clause 5.2.16.2.1 of TS 23.502 [3]), updates the UE as necessary with network slicing configuration by means of the UE Configuration Update procedure (this may include changes in the Configured NSSAI (and related mapping information) and changes in the Allowed NSSAI as applicable). The UE acknowledges this UE Configuration Update according to clause 4.2.4.2 of TS 23.502 [3].
At any time, a UE supporting subscription-based restrictions to simultaneous registration of network slices feature and that has received NSSRG information together with the Configured NSSAI shall only request S-NSSAIs, across all Access Type(s) regardless of whether the same PLMN or different PLMNs are used, that share one or more common NSSRG.
NOTE:	In Requested NSSAI across all Access Type(s), the UE needs to include S-NSSAIs that share at least one common NSSRG.
An AMF which supports the subscription-based restrictions to simultaneous registration of network slice feature configures a non-supporting UE with a Configured NSSAI including only the S-NSSAIs sharing all the NSSRG values of the default S-NSSAI(s), except if it has been instructed otherwise by the UDM. In addition to the default S-NSSAI(s), the AMF sends to the UE in the Configured NSSAI any other subscribed S-NSSAI whose NSSRG match at least those defined for the default S-NSSAI(s).
The UDM in a supporting HPLMN may optionally keep a record of the PEIs or Type Allocation Codes values regarding UE ability to handle network slices that cannot be provided simultaneously in Allowed NSSAI.
The UDM may, based on configuration or the optional PEI records, indicate the AMF to provide the non-supporting UEs with the full set of subscribed S-NSSAIs even if they do not share a common NSSRG. The UDM instructs the supporting AMFs of a PLMN to do so by indicating that the UE can be given a Configured NSSAI with all the S-NSSAIs in the subscription information. If this indication is received from the UDM by the AMF, this is included in the UE context.
Based on its policy (including configuration or optionally checking the specific PEI or Type Allocation Code used by the UE, and subject to roaming agreement) the UDM may also provide the serving AMF in a non-supporting VPLMN with all the S-NSSAI in the subscription information. In this case the AMF provides the UE with a Configured NSSAI including all the S-NSSAIs in the subscription information the AMF receives.
The AMF provides no NSSRG information to a non-supporting UE.
When an AMF which supports the subscription-based restrictions to simultaneous registration of network slice feature, receives from a UE a Requested NSSAI including S-NSSAIs that are supported in the Tracking Area but do not share a common NSSRG, or the AMF has pending NSSAI stored for the UE, and the S-NSSAI(s) of the requested NSSAI and the pending NSSAI do not share a common NSSRG, the AMF assumes the UE configuration is not up-to-date, and provides the following:
-	a supporting UE with an updated configuration including the up-to-date NSSRG information for the S-NSSAIs in the Configured NSSAI as described above.
-	a non-supporting UE with an updated Configured NSSAI including only the S-NSSAIs sharing all the NSSRG values of the default S-NSSAI(s), only for the case where the UE context does not include an indication to provide all the subscribed S-NSSAIs in the subscription information in the Configured NSSAI for the UE.
A UE subscription information may include an optional Slice Maximum Bit Rate for the UE (Subscribed UE-Slice-MBR) for an S-NSSAI, which applies for 3GPP access type only. The Subscribed UE-Slice-MBR includes a UL and a DL value. If a Subscribed UE-Slice-MBR is associated to an S-NSSAI in the subscription information, it is provided by the AMF to the NG-RAN when the AMF provides the Allowed NSSAI for the UE to the NG-RAN as UE-Slice-MBR QoS parameter. The UE-Slice-MBR QoS parameter is defined in clause 5.7.2.6. If the Subscribed UE-Slice-MBR for a UE changes, the AMF updates UE-Slice-MBR in the NG-RAN accordingly.
In roaming case, the UE-Slice-MBR is provided for the S-NSSAI of the VPLMN which maps to the S-NSSAI of the HPLMN and the AMF may first interact with the PCF for authorization of the Subscribed UE-Slice-MBR. If the AMF interacts with the PCF, the PCF may provide the Authorized UE-Slice-MBR that is used as UE-Slice-MBR by the AMF as described in clause 6.1.2.1 of TS 23.503 [45].
For a roaming UE, the S-NSSAI of the VPLMN maps to only one S-NSSAI of the HPLMN for which an UE-Slice-MBR is applied.
The enforcement of the UE-Slice-MBR value, if present in the UE context in the NG-RAN for an S-NSSAI, is described in clause 5.7.1.10.
NOTE:	The PCF for the PDU Session may in addition be configured to monitor the data rate per Network Slice for a UE and to strengthen or relax the traffic restrictions for individual PDU Sessions or PCC rules accordingly, as described in TS 23.503 [45] clause 6.2.1.9.
The NG-RAN may support Network Slice AS Groups (NSAGs) which are used as specified in TS 38.300 [27], TS 38.331 [28], TS 38.321 [143] and TS 38.304 [50]. A Network Slice AS Group is an identifier of a group of network slices which are associated with it. A Network Slice AS Group association with a group of network slices may be valid in one or more Tracking Areas. An S-NSSAI can be associated with at most one NSAG values for Random Access and at most one NSAG value for Cell Reselection within a Tracking Area. An S-NSSAI can be associated with different NSAG values in different Tracking Areas.
The NG-RAN provides (and updates) the AMF with the values of the NSAG(s) an S-NSSAI is associated with in a TA using the NG Set Up and RAN Configuration Update procedures (see TS 38.413 [34]). The AMF in turn provides this information to the NSSF. In deployments where the total number of groups does not exceed the number of groups associated with the NSAG size limit defined in TS 38.331 [28]), all the NSAGs configured in the NG-RAN may be unique per PLMN or SNPN. If the UE has indicated that the UE supports NSAG in the 5GMM Core Network Capability (see clause 5.4.4a), the AMF may, with or without NSSF assistance, configure the UE with NSAG Information for one or more S-NSSAIs in the Configured NSSAI, by including this NSAG Information in the Registration Accept message or the UE Configuration Command message. The UE uses the NSAG Information as defined in clause 5.3.4.3.1. The AMF shall indicate in the NSAG Information in which TA a specific NSAG association to S-NSSAI(s) is valid if the AMF provides in the UE configuration a NSAG value which is used in different TAs with a different association with NSSAIs. The configuration the AMF provides includes at least the NSAGs for the UE for the TAs of the Registration Area. If the AMF does not include the list of TAIs in association with an NSAG in the NSAG Information, the NSAG is valid in the Registered PLMN and equivalent PLMNs, or SNPN.
NOTE:	If the NSAGs for the PLMN and equivalent PLMNs have different associations to S-NSSAIs, then the AMF includes the list of TAIs in the NSAG information.
The UE shall store and consider the received NSAG Information, valid for the Registered PLMN and equivalent PLMNs, or SNPN until:
-	the UE receives new NSAG information in a Registration Accept message or UE Configuration Command message in this PLMN or SNPN; or
-	the UE receives a Configured NSSAI without any NSAG information in this PLMN or SNPN.
The UE shall store the currently valid NSAG information received in the Registered PLMN or SNPN when registered in this PLMN or SNPN and:
-	The UE should be able to store the NSAG information for at least the Registered-PLMN and equivalent PLMNs, or the Registered-SNPN and equivalent SNPNs.
-	The Registered-PLMN can provide NSAG information to the UE for the PLMN and the equivalent PLMNs, and the Registered-SNPN can provide NSAG information to the UE for the SNPN.
-	There can be at most 32 NSAGs configured in the UE at a time for a PLMN or SNPN.
-	At most 4 NSAGs can have an optional TAI associated with it.
The NSAG information is not required to be stored after power off or after the UE becomes Deregistered as it is not used for cell selection.
Network Slice usage control is achieved as follows:
1)	Configuring network-controlled Slice Usage Policy to supporting UEs (see clause 5.15.15.2).
2)	Configuring PDU Sessions inactivity timers, and Network Slice deregistration inactivity timers (see clause 5.15.15.3).
NOTE:	Roaming is not supported in this Release of the specification.
The UE during the Registration procedure may indicate in UE MM Core Network Capability that it supports UE configuration of network-controlled Slice Usage Policy. If so, the AMF determines Slice Usage Policy for a Network Slice for the UE and may configure the UE with this information together with Configured NSSAI to control the usage of this Network Slice. The AMF may be locally configured with network Slice Usage Policy, or receive the policy from the (AM-)PCF, or per the information received from UDM for AF managed timer values (see clause 5.15.15.3 for more details).
The network-controlled Slice Usage Policy is provided to the UE in the Registration Accept or the UE Configuration Update Command and may include:
-	An indication, for one or more of S-NSSAI(s) of the HPLMN in the Configured NSSAI, whether the UE only registers with the Network Slice with the network when applications in the UE require data transmission in the Network Slice (i.e. the UE can only register the Network Slice only on demand and consider the Network Slice as on demand S-NSSAI).
NOTE:	All Other Network Slices in the Configured NSSAI are handled by the UE using UE specific policies (e.g. they may be registered irrespective of applications need).
-	For all on demand S-NSSAI(s) of the HPLMN in the Configured NSSAI, a deregistration inactivity timer that causes the UE to deregister the Network Slice after the last PDU Session associated with the S-NSSAI is released. This deregistration inactivity timer is started at the UE and AMF per access type when the last PDU Session associated with the S-NSSAI is released, or the Network Slice is included in the Allowed NSSAI and no PDU session is established. The deregistration inactivity timer is stopped and reset when the first PDU session is established or the S-NSSAI is removed from the Allowed NSSAI. The AMF and UE may locally remove the S-NSSAI from the Allowed NSSAI when the timer expires. The AMF may also send a UE Configuration Update Command to remove the slice from the Allowed NSSAI.
	If the UE and network state became misaligned, the UE may, for example, request connectivity in a Network Slice which is no longer allowed. In this case, the AMF shall provide the updated Allowed NSSAI in a UE Configuration Update Command after rejecting the PDU Session establishment. The UE may then re-register with the Network Slice if needed.
The AMF receives deregistration inactivity timer values as described in clause 5.15.15.3.
The 5GC performs Network Slice usage monitoring to be able to enforce the release of inactive PDU Sessions, and deregistering of UEs from Network Slices with no PDU Sessions on them according to its own policies. In order to support usage monitoring for a Network Slice:
-	the AMF runs a slice deregistration inactivity timer per S-NSSAI and access type to deregister the Network Slice which is started when the Network Slice is not used by any PDU Session over the corresponding access type. The slice deregistration inactivity timer is stopped and reset when at least a PDU Session associated with the Network Slice is successfully established or the Network Slice is removed form the Allowed NSSAI. When the slice deregistration inactivity timer for a Network Slice over an access type expires, the AMF removes the Network Slice from the Allowed NSSAI over the access type by sending the UE Configuration Update Command to impacted UE(s).
-	the SMFs provide to UPFs that handle the PDU sessions in the Network Slice a PDU Session inactivity timer. The PDU Session inactivity timer is started after no data packet is transmitted or received and runs until the next data packet is transmitted or received which restarts the timer again. If the PDU Session inactivity timer expires before any packet is received or transmitted, the UPF reports this PDU Session inactivity event to the SMF to cause the SMF to release the PDU Session. While releasing the PDU session the SMF may indicate the release cause because of slice inactivity. When the AMF receives the notification of PDU Session release and it includes the release cause of slice inactivity and if the Network Slice of the released PDU Session is not used by other PDU Sessions (i.e. the last PDU Session using the Network Slice is released) over the corresponding access type, the AMF may trigger the UE Configuration Update procedure to remove the Network Slice from the Allowed NSSAI over that corresponding access type or start slice deregistration inactivity timer for the Network Slice.
If an S-NSSAI is dedicated for a single AF, and if authorized by operator policy to provide deregistration inactivity/PDU Session inactivity timer values for the S-NSSAI, the AF uses external parameter provisioning procedure to provide deregistration inactivity and PDU session inactivity timer values as described in clause 4.15.6.2 of TS 23.502 [3]. In this case, the AF provided timer values are stored in the UDM and provided to the AMF/SMF as part of subscription data for the corresponding S-NSSAI. If no AF is authorized to provide deregistration inactivity/PDU Session inactivity timer values for the S-NSSAI, the slice deregistration inactivity timer value and PDU Session inactivity timer value are either pre-configured in the AMF/SMF or received by the AMF/SMF during the AM Policy Association / SM Policy Association procedure respectively.
To enable a serving network to direct UEs to a preferred Network Slice, the AMF may request the UE to transfer a PDU Session from one S-NSSAI to another S-NSSAI as described in clause 5.15.19.
A network slice may be available for all UEs or a limited number of UEs only for a limited time that is known at the network in advance e.g. by OAM or subscription. The limited time duration may be due to, for example, the fact that network slice is only temporarily or periodically active in the deployment (e.g. for a limited time to serve an event or a UE may be only authorized to access the network slice for a limited time known in advance), or the network slice is being decommissioned at a known future time. This feature is enabled by S-NSSAI validity time that the network and the UE can handle to reduce the signalling load associated to the transitions in RM and SM states for the network slice.
The UE may indicate its support for temporarily available network slices in the UE MM Core Network Capability (see clause 5.4.4a) in the Registration Request. The AMF, based on OAM configuration or information received from the UDM or NSSF, may indicate to a supporting UE the validity time for one or more S-NSSAIs in the Configured NSSAI in the Registration Accept message or via the UE Configuration Update procedure. In roaming case, the AMF my include the validity time for an S-NSSAI in the Configured NSSAI either because of limited availability of the VPLMN S-NSSAI or the mapped S-NSSAI of the HPLMN.
NOTE 1:	When the validity time changes or a validity time is determined for a S-NSSAI in the configured NSSAI, the PLMN provides the new validity time for the S-NSSAIs in the Configured NSSAI to a supporting UE.
If a supporting UE is configured with validity time for an S-NSSAI:
a)	If the validity time indicates the S-NSSAI is available, the UE may request the S-NSSAI in a Requested NSSAI in a Registration request and, if the S-NSSAI is included in the Allowed NSSAI or in the Partially Allowed NSSAI, the UE may establish PDU sessions associated with the S-NSSAI.
b)	If the validity time indicates the S-NSSAI is not available
-	The UE shall not include the S-NSSAI in the Requested NSSAI;
-	If the S-NSSAI is already part of the Allowed NSSAI or Partially Allowed NSSAI, the UE shall remove the S-NSSAI from the locally stored Allowed NSSAI or Partially Allowed NSSAI and the UE shall also locally release any PDU sessions associated with the S-NSSAI.
-	If the validity time indicates the S-NSSAI will not be available again, the UE shall remove the S-NSSAI from the locally stored Configured NSSAI.
NOTE 2:	Subject to implementation decisions outside 3GPP scope, the UE may also use the validity time information to e.g. attempt to use another PDU sessions to continue supporting the connectivity with another connectivity option if possible according to the URSP rules, or, if not possible, e.g. provide implementation-dependent information on the availability of connectivity for specific applications affected by an impending connectivity loss, so the UE can let the end user prepare for the loss of connectivity.
For a supporting UE, if validity time applies to an S-NSSAI, an AMF supporting temporarily available network slices shall:
-	If the S-NSSAI is provided in a Requested NSSAI in a Registration Request by the UE and the validity time indicates the S-NSSAI is not available, but it is going to become available again (i.e. the UE is detected as not having up to date validity time), then the AMF sends the Configured NSSAI to the UE including the validity time for the S-NSSAI in the Registration Accept message. If the validity time indicates the S-NSSAI is not available and will not become available again, then the AMF sends the Configured NSSAI to the UE, excluding the S-NSSAI from the Configured NSSAI.
-	If the S-NSSAI is in the Allowed NSSAI or the Partially Allowed NSSAI for the UE and the validity time indicates that the S-NSSAI is not available, then locally remove (i.e. without sending any signalling to the UE) the S-NSSAI from the Allowed NSSAI or Partially Allowed NSSAI. If there is any PDU session established for the S-NSSAI, the AMF requests the SMF to release the PDU session:
-	If the UE is in CM-CONNECTED state, the AMF releases the PDU session for the S-NSSAI by sending to the SMF, as per step 1f in clause 4.3.4.2 of TS 23.502 [3], a Nsmf_PDUSession_UpdateSMContext Request with a release indication to request the release of the PDU Session and then the AMF forwards the N2 SM request to release the AN resources associated with the PDU session
-	If the UE is in CM-IDLE state, the AMF locally releases the PDU session without paging the UE and causes the SMF to locally release the SM context for the UE by a Nsmf_PDUSession_ReleaseSMContext, as in step 1c in clause 4.3.4.2 of TS 23.502 [3]. The PDU Session status is synchronized at next time when the UE connects to the network.
For a non-supporting UE, if validity time applies to an S-NSSAI, an AMF supporting temporarily available network slices shall:
-	If the validity time indicates the S-NSSAI is available, allow or partially allow the network slice when requested, establish PDU sessions when requested.
-	If the S-NSSAI is provided in a Requested NSSAI in a Registration Request by the UE and the validity time indicates the S-NSSAI is not available, reject the registration and remove the S-NSSAI from the Configured NSSAI by providing an updated Configured NSSAI in the Registration Accept message.
-	If the S-NSSAI is in the UE in the Allowed NSSAI or Partially Allowed NSSAI and the validity time indicates the S-NSSAI is not available, remove the S-NSSAI from the Configured NSSAI and the Allowed NSSAI or Partially Allowed NSSAI by a UE Configuration Update procedure. If there is any PDU session established for the S-NSSAI, the AMF requests the SMF to release the PDU session in the network:
-	If the UE is in CM-CONNECTED state, the AMF releases the PDU session for the S-NSSAI by sending to the SMF, as in step 1f in clause 4.3.4.2 of TS 23.502 [3], a Nsmf_PDUSession_UpdateSMContext Request with a release indication to request the release of the PDU Session and then the AMF forwards the N2 SM request to release the AN resources associated with the PDU session
-	If the UE is in CM-IDLE, the AMF locally releases the PDU session without paging the UE and causes the SMF to locally release the SM context for the UE by a Nsmf_PDUSession_ReleaseSMContext, as in step 1c in clause 4.3.4.2 of TS 23.502 [3]. The PDU Session status is synchronized at next time when the UE connects to the network
NOTE 3:	If the network slice becomes unavailable, and a large number of UEs are impacted, the AMF can send the updates to the non-supporting UEs in a manner that avoids surge in signalling (e.g. next time the UE becomes connected).
-	If the AMF detects from the validity time of a S-NSSAI that it is available again, then update the Configured NSSAI to include the S-NSSAI via a UE Configuration Update procedure.
NOTE 4:	The AMF, for the case of UE not performing any actions despite the validity timing information provided by the network, can terminate PDU Session(s) associated with S-NSSAI subject to be terminated according to the validity time by explicitly releasing the PDU Sessions associated with the S-NSSAI.
A Network Slice may be supported in one or more TAs in a PLMN/SNPN. The Partial Network Slice support in a Registration Area for a UE includes configuring the UE with a Partially Allowed NSSAI and/or S-NSSAI(s) rejected partially in the RA.
When creating a Registration Area for UEs registering over the 3GPP access and supporting the Partial Network Slice support in a Registration Area, the AMF may consider the trade-off between signalling for paging in TAs where the S-NSSAI is not supported versus the signalling for Mobility Registration Updates to register with the S-NSSAI in the TA(s) where the S-NSSAI is supported, so that the AMF may create a Registration Area including the TA(s) where a requested S-NSSAI is not supported. For supporting UEs, whether the AMF uses the Partially Allowed NSSAI or rejects the S-NSSAIs partially in the RA, or whether the AMF rejects the S-NSSAI for the current RA, is a per S-NSSAI decision which is based on AMF local policy. If supported and allowed by local policy, the Partially Allowed NSSAI and S-NSSAIs rejected partially in the RA may be applied simultaneously for one UE for different S-NSSAIs.
For such S-NSSAI:
-	If requested by the UE from a TA where the S-NSSAI is not supported,
-	the S-NSSAI is included either in the Partially Allowed NSSAI or the AMF rejects the S-NSSAI partially in the RA; or
-	if the S-NSSAI is subject to NSAC for maximum number of UEs, then the AMF should send this S-NSSAI as rejected partially in the RA, in the Registration Accept message.
-	If the S-NSSAI is subject to NSSAA and successful NSSAA status for the S-NSSAI is not present in the AMF, then the AMF either sends this S-NSSAI as rejected partially in the RA in the Registration Accept message, or the AMF starts executing NSSAA and includes the S-NSSAI in the Pending NSSAI in the Registration Accept message. If the S-NSSAI is subject to NSSAA and successful NSSAA status for the S-NSSAI is present, then the AMF may include the S-NSSAI either in the Partially Allowed NSSAI or the AMF rejects the S-NSSAI partially in the RA.
NOTE 1:	In roaming case the NSSAA requirement is based on the mapped S-NSSAI of the HPLMN.
-	if the slice deregistration inactivity timer is configured for the S-NSSAI (see clause 5.15.15.3), then AMF should send this S-NSSAI as rejected partially in the RA.
-	If requested by the UE from a TA where the S-NSSAI is supported,
-	the S-NSSAI is included in the Partially Allowed NSSAI; or
-	if the S-NSSAI is subjected to NSAC for maximum number of UEs, then the AMF should restrict the RA so that the S-NSSAI is supported in all the TAs of the RA and includes the S-NSSAI in the Allowed NSSAI.
-	If the S-NSSAI is subject to NSSAA, then the AMF starts executing NSSAA and sends this S-NSSAI in the Pending NSSAI in the Registration Accept message, unless successful NSSAA status is present in the AMF for this S-NSSAI (in which case it can be sent in the Partially Allowed NSSAI).
NOTE 2:	In roaming case the NSSAA requirement is based on the mapped S-NSSAI of the HPLMN.
-	if the S-NSSAI is included in neither the Partially Allowed NSSAI nor the Allowed NSSAI, the AMF may reject the S-NSSAI as described in clause 5.15.4.1.1.
While the S-NSSAIs of the Allowed NSSAI are supported in all the TAs of the Registration Area, the S-NSSAIs of the Partially Allowed NSSAI are supported only in the TAs corresponding to the list of TAs (which are subset of the list of TAIs forming the Registration Area) associated with the S-NSSAI.
If the UE supports Partial Network Slice support in a Registration Area, the AMF may create a Registration Area for the UE considering the support of the S-NSSAIs of the Requested NSSAI in the current TA and in the neighbouring TAs and provides to the UE in the Registration Accept message or in the UE Configuration Update Command message the Partially Allowed NSSAI or the S-NSSAIs rejected partially in the RA as follows:
-	If one or more of the requested S-NSSAI(s) are supported in a subset of the TAs of the (potential) Registration Area, the AMF may include such S-NSSAI(s) in the Partially Allowed NSSAI and corresponding mapping information of the S-NSSAI(s) of the Partially Allowed NSSAI to the HPLMN S-NSSAI(s). For each S-NSSAI of the Partially Allowed NSSAI the AMF provides a list of TAs where the S-NSSAI is supported. The UE is considered registered with the S-NSSAI in the whole Registration area. The AMF also provides the Partially Allowed NSSAI (without indication of the TA list where the partially allowed S-NSSAIs are supported) to the NG-RAN together with the UE's context.
-	Alternatively, the AMF may reject the S-NSSAI(s) with reject cause indicating "partially in the RA". For each S-NSSAI of the S-NSSAIs rejected partially in the RA the AMF provides a list of TAs for which the S-NSSAI is supported or not supported.
NOTE 3:	If the UE requests an S-NSSAI in a cell of a TA where the NS-AoS of the S-NSSAI does not match deployed Tracking Areas (see clause 5.15.18), the AMF includes the S-NSSAI in the Allowed NSSAI or Partially Allowed NSSAI.
When the UE stores Partially Allowed NSSAI the following applies:
-	the UE is considered registered with an S-NSSAI of the Partially Allowed NSSAI in the whole Registration area. The UE does not trigger registration when moving between the TAs of support and non-support for the S-NSSAI within the RA.
-	The UE is allowed to initiate PDU Session establishment for the S-NSSAI only when the UE is in a TA where the S-NSSAI is supported.
-	When the UE has already established a PDU Session with an S-NSSAI part of the Partially Allowed NSSAI, the UE is allowed to activate the User Plane Resources of the PDU Session only when the UE is in a TA part of the list of TAs associated with each S-NSSAI.
-	When the User Plane Resources are activated for a PDU Session of an S-NSSAI part of the Partially Allowed NSSAI and the UE moves to a TA which is not part of the list of TAs associated with the S-NSSAI, the User Plane Resources for the PDU Session shall be deactivated, but the PDU Session context in UE and SMF is not released. The User Plane Resources for the PDU Session shall not be activated as long as the UE is located in a TA which is not part of the list of TAs associated with the S-NSSAI of the Partially Allowed NSSAI. The UE and SMF shall not exchange user data as payload of a NAS message in both uplink and downlink directions.
When the UE stores a S-NSSAI rejected partially in the RA with the associated list of TAs, the UE is allowed to initiate a Mobility Registration Update procedure to request registration with the S-NSSAI only when the UE is in a TA supporting this S-NSSAI.
The network support for a Network Slice is defined on a per Tracking Area granularity. It may be beneficial to deploy some Network Slices such that the Network Slice have a limited geographical availability that is not matching existing Tracking Area boundaries.
The operator can in this case decide to change the topology of the Tracking Areas so they match the boundaries of the Network Slice, or the operator may configure resources for the Network Slices in the cells of TAs where the Network Slices are to be available, and in areas of the TAs where the network slice is defined to be not available the cells are configured with zero resources.
The AMF receives from the OAM the information on availability of a network slice when the granularity is smaller than TA, i.e. if the NS-AoS includes TAs where the network slice is not available in some cells of the TA.
In order to optimize the end-to-end behaviour, the AMF can, based on NS-AoS information received from OAM, configure supporting UEs with S-NSSAI location availability information, and the network may need to monitor the S-NSSAI usage and enforce the NS-AoS e.g. if the UE does not support the S-NSSAI location availability information.
S-NSSAI location availability information defines additional restrictions to the usage of an S-NSSAI in TAs where the Network Slice availability does not match the TA boundaries. The AMF is configured per S-NSSAI whether to send the S-NSSAI location availability information to supporting UEs.
The S-NSSAI location availability information sent to the UE includes, for each applicable S-NSSAI of the Configured NSSAI, Location information indicating the cells of TAs in the RA where the related S-NSSAI is available if the S-NSSAI is not available in all the cells of the TA.
If the UE has indicated that the UE supports S-NSSAI location availability information in the 5GMM Core Network Capability (see clause 5.4.4a), the AMF may, based on OAM configuration, configure the UE with S-NSSAI location availability information for one or more S-NSSAIs when the AMF allocates an RA where the Network Slice availability does not match whole TAs, by including the S-NSSAI location availability information in the Registration Accept message or the UE Configuration Command message. A UE that receives S-NSSAI location availability information applies the information as follows.
1.	If the S-NSSAI is rejected in the RA or rejected partially in the RA or rejected with a cause code that allows attempting to register the S-NSSAI again, the UE can request the S-NSSAI only if the S-NSSAI location availability information indicates that the S-NSSAI is available at the cell where the UE is camping.
2.	If the S-NSSAI is in the Partially Allowed NSSAI or in the Allowed NSSAI, the UE shall not activate User Plane for any already established PDU Session with that S-NSSAI if the UE is in a cell within the RA but outside the Location information of the S-NSSAI. The UE and SMF shall not exchange user data as payload of a NAS message in both uplink and downlink directions.
3.	If the S-NSSAI is in the Partially Allowed NSSAI or in the Allowed NSSAI, and the UE in CM-IDLE mode is moved to a cell outside the Location information of the S-NSSAI, and the UE has an established PDU Session with that S-NSSAI, the PDU Session is kept.
NOTE 1:	By Radio Resource Management and existing mechanisms in NG-RAN, handover can be used to keep the UE in the NS-AoS or steer the UE to enter the NS-AoS as long as radio conditions allow it.
NOTE 2:	Since the S-NSSAI location availability information is not a used as a trigger for the UE to perform MRU due to mobility, i.e. the UE performs MRU due to mobility upon changing to a new TA outside the UE's Registration Area, the S-NSSAI remains registered and is included in the Allowed NSSAI when the UE exits the NS-AoS. If the S-NSSAI is subject for NSAC, the S-NSSAI is counted towards NSAC as described in clause 5.15.11 also when the UE is outside the NS-AoS.
OAM may configure RRM policies for S-NSSAIs on a per cell basis as defined in TS 28.541 [149], i.e. cells outside the Network Slice Area of Service while in a TA supporting the S-NSSAI are allocated with no RRM resources for the S-NSSAI.
The network may enforce the NS-AoS for an S-NSSAI as follows:
1.	The network may monitor the validity of the S-NSSAI for UE in CM-CONNECTED state, i.e. the AMF subscribes to the AoI using the Location information of the S-NSSAI location availability information as described in TS 38.413 [34].
2.	If the non-supporting UE makes a PDU Session establishment request with an S-NSSAI that is not valid as per the S-NSSAI location availability information, the AMF may reject the NAS Transport message with a back-off timer using S-NSSAI based congestion control as described in clause 5.19.7.4.
3.	If the AMF determines that the UE in CM-CONNECTED has moved outside the NS-AoS, the AMF performs the following logic:
a)	If the non-supporting UE has other S-NSSAI(s) in the Allowed NSSAI, then the AMF may update the UE with a UE Configuration Update by removing the S-NSSAI from the Allowed NSSAI (which causes the UE to locally release the PDU Sessions) and optionally removing the S-NSSAI from the Configured NSSAI and then, the AMF requests the SMF to locally release in the network any PDU Sessions with that S-NSSAI as per step 1f in clause 4.2.3.4 in TS 23.502 [3]. Alternatively, the AMF requests the SMF to release PDU Sessions with that S-NSSAI.
b)	If the non-supporting UE does not have any other S-NSSAI in the Allowed NSSAI, then the AMF may update the UE with a UE Configuration Update by removing the S-NSSAI from the Allowed NSSAI (which causes the UE to locally release the PDU Sessions) and optionally removing the S-NSSAI from the Configured NSSAI, and adding a default S-NSSAI to the Allowed NSSAI and then, the AMF requests the SMF to locally release in the network any PDU Sessions with the removed S-NSSAI as per step 1f in clause 4.2.3.4 in TS 23.502 [3]. Alternatively, the AMF requests the SMF to release PDU Sessions with that S-NSSAI.
NOTE:	Whether the AMF removes the S-NSSAI from Allowed NSSAI and Configured NSSAI or only releases the associated PDU Sessions when the AMF enforces the NS-AoS is up to AMF configuration.
c)	For a non-supporting UE that does not have any other S-NSSAI in the Allowed NSSAI nor in the Configured NSSAI, then the AMF indicates to the SMF to release the PDU Session.
4.	If the AMF determines that the S-NSSAI becomes valid e.g. the UE has moved into the NS-AoS, the AMF may update the UE with a UCU e.g. including the S-NSSAI in the Configured NSSAI.
The Network Slice Replacement feature is used to replace an S-NSSAI with an Alternative S-NSSAI when an S-NSSAI becomes unavailable or congested. The Network Slice Replacement may be triggered in the following cases:
-	If the NSSF detects that an S-NSSAI becomes unavailable or congested (e.g. based on OAM or NWDAF analytics output), it sends network slice availability notification for the S-NSSAI to the AMF. The notification may include an Alternative S-NSSAI which can be used by the AMF to replace the S-NSSAI. The NSSF notifies the AMF when the S-NSSAI is available again.
-	If the PCF detects that an S-NSSAI becomes unavailable or congested for a UE (e.g. based on OAM or NWDAF analytics output), it sends access and mobility related policy notification to the AMF. The notification may include an Alternative S-NSSAI which can be used by the AMF to replace the S-NSSAI. The PCF notifies the AMF when the S-NSSAI is available again for the UE.
-	The OAM sends notification to AMF when an S-NSSAI becomes unavailable or congested (and also when this S-NSSAI becomes available again) and provides the Alternative S-NSSAI to AMF.
Based on the notification above from NSSF or PCF or OAM, the AMF may determine that an S-NSSAI is to be replaced with Alternative S-NSSAI. For roaming case, the AMF may receive network slice availability notification of the HPLMN S-NSSAI from NSSF in the HPLMN via NSSF in VPLMN, to trigger the Network Slice Replacement of the HPLMN S-NSSAI as described in clause 5.15.6.
NOTE 1:	It is recommended that, the operator configures to use only one mechanism when triggering the Network Slice Replacement for S-NSSAI.
The AMF determines the Alternative S-NSSAI for a UE registered with the S-NSSAI based on the notification from NSSF or PCF, or based on local configuration if the NSSF or PCF do not provide an alternative S-NSSAI. The Alternative S-NSSAI shall be supported in the UE Registration Area. If AMF cannot determine the Alternative S-NSSAI for the S-NSSAI, e.g. PCF or NSSF doesn't provide Alternative S-NSSAI, the AMF may further interact with the PCF to determine the Alternative S-NSSAI. The event trigger in AMF for interacting with PCF is described in clause 6.1.2.5 of TS 23.503 [45].
The UE indicates the support of Network Slice Replacement feature during the UE Registration procedure. For supporting UE in CM-CONNECTED state and if there is a PDU Sessions in the UE context associated with the S-NSSAI that needs to be replaced, the AMF provides the Alternative S-NSSAI for this S-NSSAI in the Allowed NSSAI and in the Configured NSSAI, if not included yet, and the mapping between S-NSSAI(s) to Alternative S-NSSAI(s) to the UE in UE Configuration Update message as follows:
-	for non-roaming UEs, the AMF provides the mapping of the S-NSSAI to the Alternative S-NSSAI to the UE.
-	for roaming UEs when the VPLMN S-NSSAI has to be replaced by a VPLMN Alternative S-NSSAI, the AMF provides the mapping of the VPLMN S-NSSAI to the Alternative VPLMN S-NSSAI to the UE.
-	for roaming UEs when the HPLMN S-NSSAI has to be replaced by an Alternative HPLMN S-NSSAI, the AMF provides the mapping of the HPLMN S-NSSAI to the Alternative HPLMN S-NSSAI to the UE.
NOTE 2:	The Alternative S-NSSAI or Alternative HPLMN S-NSSAI does not have to be part of the Subscribed S-NSSAI as long as they can be mapped to a HPLMN S-NSSAI that is part of the Subscribed S-NSSAIs.
For the supporting UE in CM-IDLE state, when the UE establishes a NAS signalling connection, e.g. through a Service Request procedure or through a UE registration procedure, if the AMF determines that the S-NSSAI is to be replaced and there is a PDU Session associated with the S-NSSAI in the UE context, the AMF sends the mapping of the S-NSSAI to the Alternative S-NSSAI to the UE in the UE Configuration Update message or in the Registration Accept message.
NOTE 3:	It is left to AMF local policy whether to send the mapping of the S-NSSAI to the Alternative S-NSSAI to the UE when there is no PDU session associated with the S-NSSAI or wait and send the mapping of the S-NSSAI to the Alternative S-NSSAI to the UE when the UE establishes a PDU Session associated with the S-NSSAI.
During a new PDU Session establishment procedure towards an S-NSSAI,
-	if the UE is provided with the mapping of the S-NSSAI to an Alternative S-NSSAI, the UE provides both the Alternative S-NSSAI and the S-NSSAI in the PDU Session Establishment message. When the AMF receives the Alternative S-NSSAI and the S-NSSAI in the PDU Session Establishment message, or when the AMF receives only the S-NSSAI in PDU Session Establishment message the AMF determines that the S-NSSAI is to be replaced with the Alternative S-NSSAI, the AMF includes both the Alternative S-NSSAI and the S-NSSAI to the SMF.
-	if the UE is not provided with the mapping of the S-NSSAI to the Alternative S-NSSAI, the UE provides the S-NSSAI in the PDU Session Establishment message. When the AMF determines that the requested S-NSSAI is to be replaced with the Alternative S-NSSAI and if the UE supports Network Slice Replacement, the AMF performs UE Configuration Update procedure to reconfigure the UE with the Alternative S-NSSAI. The AMF continues the PDU Session establishment procedure with the Alternative S-NSSAI and provides both the Alternative S-NSSAI and the S-NSSAI to the SMF.
The SMF proceeds with the PDU Session establishment using the Alternative S-NSSAI. The SMF sends the Alternative S-NSSAI to NG-RAN in N2 SM information and to UE in PDU Session Establishment Accept message.
For existing PDU Session associated with an S-NSSAI that is replaced with the Alternative S-NSSAI, after the AMF sends mapping of the S-NSSAI to the Alternative S-NSSAI to the supporting UE in UE Configuration Update message, the AMF sends updates to the SMF of the PDU Session, e.g. triggering Nsmf_PDUSession_UpdateSMContext service operation, that the PDU Session is to be transferred to Alternative S-NSSAI and includes the Alternative S-NSSAI as follows (see details in clause 4.3.3 of TS 23.502 [3]):
-	If the SMF determines that the PDU Session needs to be retained (e.g. if the anchor UPF can be reused with the alternative S-NSSAI and SSC mode 1), the SMF sends the Alternative S-NSSAI to the UPF in the N4 message, to the NG-RAN in N2 message and to the supporting UE in PDU Session Modification Command message.
-	If the SMF determines that the PDU Session needs to be re-established, the SMF sends the Alternative S-NSSAI to the supporting UE either in PDU Session Modification Command if the PDU Session is of SSC mode 3, or in PDU Session Release if the PDU Session is of SSC mode 2 or SSC mode 1, to trigger the re-establishment of the PDU Session. The UE includes both, the S-NSSAI and the Alternative S-NSSAI in the PDU Session Establishment message.
Editor's note:	How to use the existing NG-RAN resource of the replaced S-NSSAI is for FFS.
When the AMF is notified that the S-NSSAI is available again or the congestion of the S-NSSAI has been mitigated, if the AMF has configured the supporting UE with the Alternative S-NSSAI, and the AMF determines for the UE to use the S-NSSAI again, the AMF reconfigures the supporting UE (e.g. by using UE Configuration Update message) to use the S-NSSAI. If there is an existing PDU Session associated with the Alternative S-NSSAI, the AMF sends updates to the SMF of the PDU Session, e.g. triggering Nsmf_PDUSession_UpdateSMContext service operation, that the PDU Session is to be transferred to the S-NSSAI.
During a handover procedure, if an S-NSSAI has to be replaced with an Alternative S-NSSAI, the handover procedure (including any PDU session associated with the S-NSSAI to be replaced) shall continue unaffected by the Network Slice Replacement. Any Network Slice Replacement for the S-NSSAI shall not take place during the handover.
The Network Slice Instance Replacement is used when a PDU Session for a given S-NSSAI is established using a selected Network Slice instance and the S-NSSAI corresponding to this Network Slice instance is associated with multiple Network Slice instances. In this case, the network may change the Network Slice instance for the S-NSSAI if the selected Network Slice instance is no longer available (e.g. due to overload). The AMF may subscribe with the NSSF for notifications when any of the Network Slice instances served by the AMF is congested or no longer available. In case of roaming, the NSSF of VPLMN subscribes with the NSSF of the HPLMN for notifications. When the NSSF notifies the AMF that a Network Slice instance is congested or no longer available, for some of PDU Sessions associated with the Network Slice instance that is no longer available, the AMF may delete old NSI ID corresponding to the Network Slice instance that is no longer available and the SMF of the PDU Session(s) selected by using such old NSI ID is informed by the AMF to release the PDU Session(s). Subsequently, the SMF triggers the impacted UE(s) to establish new PDU session(s) associated with the same S-NSSAI as described in clause 5.6.9.2 for PDU Session(s) of SSC Mode 2 and SSC Mode 3. The AMF selects a new Network Slice instance for the given S-NSSAI during PDU Session Establishment.
The functional description for supporting Public Warning System for 5G System can be found in TS 23.041 [46].
This clause includes feature description for supporting SMS over NAS in 5G System. Support for SMS incurs the following functionality:
-	Support for SMS over NAS transport between UE and AMF. This applies to both 3GPP and Non 3GPP accesses.
-	Support for AMF determining the SMSF for a given UE.
-	Support for subscription checking and actual transmission of MO/MT-SMS transfer by the SMSF.
-	Support for MO/MT-SMS transmission for both roaming and non-roaming scenarios.
-	Support for selecting proper domains for MT SMS message delivery including initial delivery and re-attempting in other domains.
5G System supports SMS over NAS via both 3GPP access and non-3GPP access.
During Registration procedure, a UE that wants to use SMS provides an "SMS supported" indication over NAS signalling indicating the UE's capability for SMS over NAS transport. "SMS supported" indication indicates whether UE can support SMS delivery over NAS. If the core network supports SMS functionality, the AMF includes "SMS allowed" indication to the UE, and whether SMS delivery over NAS is accepted by the network.
SMS is transported via NAS transport message, which can carry SMS messages as payload.
IP-Connectivity Access Network specific concepts when using 5GS to access IMS can be found in TS 23.228 [15].
5GS supports IMS with the following functionality:
-	Indication toward the UE if IMS voice over PS session is supported.
-	Capability to transport the P-CSCF address(es) to UE.
-	Paging Policy Differentiation for IMS as defined in TS 23.228 [15].
-	IMS emergency service as defined in TS 23.167 [18].
-	Domain selection for UE originating sessions.
-	Terminating domain selection for IMS voice.
-	Support of P-CSCF restoration procedure (clause 5.16.3.9).
-	NRF based P-CSCF discovery (clause 5.16.3.11).
NOTE:	The NRF based P-CSCF discovery has no impact on the UE, i.e. the UE does not need to know how P-CSCF IP address(es) is discovered in the network.
-	NRF based HSS discovery (clause 5.16.3.12).
The serving PLMN AMF shall send an indication toward the UE during the Registration procedure over 3GPP access to indicate if an IMS voice over PS session is supported or not supported in 3GPP access and non-3GPP access. A UE with "IMS voice over PS" voice capability over 3GPP access should take this indication into account when performing voice domain selection, as described in clause 5.16.3.5.
The serving PLMN AMF may only indicate IMS voice over PS session supported over 3GPP access in one of the following cases:
-	If the network and the UE are able to support IMS voice over PS session in the current Registration Area with a 5G QoS Flow that supports voice as specified in clause 5.7.
-	If the network or the UE are not able to support IMS voice over PS session over NR connected to 5GC, but is able for one of the following:
-	If the network and the UE are able to support IMS voice over PS session over E-UTRA connected to 5GC, and the NG-RAN supports a handover or redirection to E-UTRA connected to 5GC for this UE at QoS Flow establishment for IMS voice;
-	If the UE supports handover to EPS, the EPS supports IMS voice, and the NG-RAN supports a handover to EPS for this UE at QoS Flow establishment for IMS voice; or
-	If the UE supports redirection to EPS, the EPS supports IMS voice, and the NG-RAN supports redirection to EPS for this UE at QoS Flow establishment for IMS voice.
-	If the network is not able to provide a successful IMS voice over PS session over E-UTRA connected to 5GC, but is able for one of the following:
-	If the UE supports handover to EPS, the EPS supports IMS voice, and the NG-RAN supports a handover to EPS for this UE at QoS Flow establishment for IMS voice; or
-	If the UE supports redirection to EPS, the EPS supports IMS voice, and the NG-RAN supports redirection to EPS for this UE at QoS Flow establishment for IMS voice.
The serving PLMN provides this indication based e.g. on local policy, UE capabilities, HPLMN, whether IP address preservation is possible, whether NG-RAN to UTRAN SRVCC is supported and how extended NG-RAN coverage is, and the Voice Support Match Indicator from the NG-RAN (see clause 4.2.8a of TS 23.502 [3]).
NOTE 1:	The terms "UE supports handover to EPS" or "UE supports redirection to EPS" used above also consider the case that the UE has signalled that S1 mode is enabled. In case the UE has signalled that S1 mode is disabled for a network that only supports IMS voice via EPS Fallback, the AMF will not indicate that IMS voice over PS session is supported over 3GPP access. A voice centric UE ensures its voice service as described in clauses 5.16.3.5 and 5.16.3.6.
The AMF in serving PLMN shall indicate that IMS voice over PS is supported only if the serving PLMN has a roaming agreement that covers support of IMS voice with the HPLMN. This indication is per Registration Area.
NOTE 2:	If the network supports EPS fallback for voice the 5GC can be configured not to perform the Voice Support Match Indicator procedure in order to set the IMS voice over PS session Supported Indication.
The serving SNPN provides the IMS voice over PS indication based e.g. on local policy, UE capabilities, whether IP address preservation is possible, and how extended NR coverage is. This indication is per Registration Area.
NOTE 3:	Since over 3GPP access, in SNPN access mode there is only support for NR and the "voice centric" UE cannot reselect to another RAT in the same registered SNPN if the first Registration Area that the UE tries to register from cannot support IMS voice, it is recommended that support for IMS voice is provided homogeneously in the whole SNPN if at all.
5.16.3.2a	IMS voice over PS Session Supported Indication over non-3GPP access
The serving PLMN AMF shall send an indication toward the UE during the Registration procedure over non-3GPP access to indicate whether an IMS voice over PS session is supported or not supported via non-3GPP access. A UE with "IMS voice over PS" voice capability over non-3GPP access should take this indication (received in the Registration procedure performed over either 3GPP access or Non-3GPP access) into account when performing the selection between N3IWF/TNGF and ePDG described in clause 6.3.6.
The serving PLMN AMF may only indicate IMS voice over PS session supported over non-3GPP access if the network is able to provide a successful IMS voice over PS session over N3IWF/TNGF connected to 5GC with a 5G QoS Flow that supports voice as specified in clause 5.7.
5GC shall support the usage of "Homogeneous Support of IMS Voice over PS Sessions" indication between AMF and UDM.
When the AMF initiates Nudm_UECM_Registration operation to the UDM, it shall:
-	if "IMS Voice over PS Sessions" is supported homogeneously in all TAs in the serving AMF for the UE, include the "Homogeneous Support of IMS Voice over PS Sessions" indication set to "Supported";
-	if none of the TAs of the serving AMF supports "IMS Voice over PS Sessions" for the UE, include the "Homogeneous Support of IMS Voice over PS Sessions" indication set to "Not supported";
-	if "IMS Voice over PS Sessions" support is either non-homogeneous or unknown, not include the "Homogeneous Support of IMS Voice over PS Sessions" indication.
The AMF shall be able to provide the "Homogeneous Support of IMS Voice over PS Sessions" indication as described above to the UDM using Nudm_UECM_Update operation as specified in clause 4.2.2.2.2 of TS 23.502 [3].
The UDM shall take this indication into account when doing Terminating Access Domain Selection (T-ADS) procedure for IMS voice.
NOTE:	A TA supports "IMS Voice over PS Sessions" if the serving AMF indicates IMS voice over PS Session Supported Indication over 3GPP access to the UE, as described in clause 5.16.3.2. In order to support routing of incoming IMS voice calls to the correct domain, the network-based T-ADS (see TS 23.292 [63] and TS 23.221 [23]) requires that the "Homogeneous Support of IMS Voice over PS Sessions" indication is set to "Supported" for all registered TAs of the UE or "Not supported" for all registered TAs of the UE.
At PDU Session Establishment procedure related to IMS, SMF shall support the capability to send the P-CSCF address(es) to UE. The SMF is located in VPLMN if LBO is used. This is sent by visited SMF if LBO is used. For Home routed, this information is sent by the SMF in HPLMN. P-CSCF address(es) shall be sent transparently through AMF, and in the case of Home Routed also through the SMF in VPLMN. The P-CSCF IP address(es) may be locally configured in the SMF, or discovered using NRF as described in clause 5.16.3.11.
NOTE 1:	Other options to provide P-CSCF to the UE as defined in TS 23.228 [15] is not excluded.
NOTE 2:	PDU Session for IMS is identified by "APN" or "DNN".
In the case of SNPN access the SMF is always located in the serving SNPN (no support for Home Routed traffic); therefore, the serving SMF sends the P-CSCF address(es) to the UE.
For UE originating calls, the 5GC capable UE performs access domain selection. The UE shall be able to take following factors into account for access domain selection decision:
-	The state of the UE in the IMS. The state information shall include: Registered, Unregistered.
-	The "IMS voice over PS session supported indication" as defined in clause 5.16.3.2.
-	Whether the UE is expected to behave in a "voice centric" or "data centric" way for 5GS.
-	UE capability of supporting IMS PS voice.
-	UE capability for operating in dual-registration mode with selective PDU Session transfer as defined in clause 5.17.2.3.3.
-	Whether 3GPP PS Data Off is active or not and whether IMS voice is included in 3GPP PS Data Off Exempt Services or not as defined in clause 5.24.
NOTE 1:	In this release of the specification, the exact logic of which PDU sessions are kept in which system for Dual Registration UE with selective transfer of certain PDU Sessions as defined in clause 5.17.2.3.3, is left up to UE implementation. The voice centric UE will keep the PDU Session used for IMS services to a system that supports voice over IMS. The voice centric UE can re-register with the IMS (if needed) when the IMS PDU session is transferred between 5GS and EPS.
To allow for appropriate domain selection for originating voice calls, the UE shall attempt Initial Registration in 5GC. If the UE fails to use IMS for voice, e.g. due to "IMS voice over PS session supported indication" indicates voice is not supported in 5G System, the UE behaves as described below for "voice centric" for 5GS or "data centric" for 5GS:
-	A UE set to "voice centric" for 5GS shall always try to ensure that Voice service is possible. A voice centric 5GC capable and EPC capable UE unable to obtain voice service in 5GS shall not select a cell connected only to 5GC. By disabling capabilities to access 5GS, the UE re-selects to E-UTRAN connected to EPC first (if available). When the UE selects E-UTRAN connected to EPC, the UE performs Voice Domain Selection procedures as defined in TS 23.221 [23].
-	A UE set to "data centric" for 5GS does not need to perform any reselection if voice services cannot be obtained.
NOTE 2:	The related radio capabilities in order for the voice centric UE to not reselect to NR or E-UTRA cell connected to 5GC (i.e. avoid ping pong) will be defined by RAN WGs.
When requested by IMS, the UDM/HSS shall be able to query the serving AMF for T-ADS related information. T-ADS is a functionality located in the IMS and is performed as specified in TS 23.221 [23].
The AMF shall respond to the query with the following information unless the UE is detached:
-	whether or not IMS voice over PS Session is supported in the registration area (s) where the UE is currently registered;
-	whether or not IMS voice over PS Session Supported Indication over non-3GPP access is supported in the WLAN where the UE is currently registered;
-	the time of the last radio contact with the UE; and
-	the current Access Type and RAT type.
If the UE is configured to support IMS voice, the UE shall include the information element "UE's usage setting" in Registration Request messages. The UE's usage setting indicates whether the UE behaves in a "voice centric" or "data centric" way (as defined in clause 5.16.3.5).
A UE supporting IMS voice over 3GPP access connected to 5GC and that is EPS capable shall also support IMS voice over E-UTRA connected to EPC.
NOTE:	Depending on operator's configuration, the UE's usage setting can be used by the network to choose the RFSP Index in use (see clause 5.3.4.3). As an example, this enables the enforcement of selective idle mode camping over E-UTRA for voice centric UEs.
To allow for appropriate domain selection for SMS delivery, it should be possible to provision UEs with the following HPLMN operator preferences on how an IMS enabled UE is supposed to handle SMS services:
-	SMS is not to be invoked over IP networks: the UE does not attempt to deliver SMS over IP networks. The UE attempts to deliver SMS over NAS signalling.
-	SMS is preferred to be invoked over IP networks: the UE attempts to deliver SMS over IP networks. If delivery of SMS over IP networks is not available, the UE attempts to deliver SMS over NAS signalling.
It should be possible to provision UEs with the HPLMN SMS over NAS operator preferences on access selection for delivering SMS over NAS signalling.
Based on the SMS over NAS preference:
-	SMS is preferred to be invoked over 3GPP access for NAS transport: the UE attempts to deliver MO SMS over NAS via 3GPP access if the UE is both registered in 3GPP access and non-3GPP access.
-	SMS is preferred to be invoked over non-3GPP access for NAS transport: the UE attempts to deliver MO SMS over NAS via non-3GPP access if the UE is both registered in 3GPP access and non-3GPP access. If delivery of SMS over NAS via non-3GPP access is not available, the UE attempts to deliver SMS over NAS via 3GPP access.
For the support of P-CSCF restoration the SMF behaves as described in TS 23.380 [61].
In order to support various deployment scenarios for obtaining IMS voice service, the UE and NG-RAN may support the mechanism to direct or redirect the UE from NG-RAN either towards E-UTRA connected to 5GC (RAT fallback) or towards EPS (E-UTRAN connected to EPC System fallback).
Following principles apply for IMS Voice Service:
-	The serving AMF indicates toward the UE during the Registration procedure that IMS voice over PS session is supported.
-	If a request for establishing the QoS Flow for IMS voice reaches the NG-RAN, the NG-RAN responds indicating rejection of the establishment request and the NG-RAN may trigger one of the following procedures depending on UE capabilities, N26 availability, network configuration and radio conditions:
-	Redirection to EPS;
-	Handover procedure to EPS;
-	Redirection to E-UTRA connected to 5GC; or
-	Handover to E-UTRA connected to 5GC.
-	If needed, Network Provided Location Information is provided as described in clauses 4.13.6.1 and 4.13.6.2 of TS 23.502 [3].
-	The ongoing IMS voice session is not impacted by a change of the IMS voice over PS session indicator from supported to unsupported (e.g. the UE receives during RAT Fallback or EPS Fallback the IMS voice over PS session indicator indicating that IMS voice over PS sessions are not supported).
NOTE:	Any change in IMS voice over PS session indicator applies to new IMS sessions initiated only after the ongoing IMS voice session is terminated.
During any release of RRC connection including after EPS/RAT fallback is performed, the eNB or NG-RAN node may provide to the UE dedicated idle mode priorities for NR as defined in TS 36.331 [51] taking into account RFSP, PLMNs contained in Handover Restriction List and local operator policy. If the UE remains ECM/CM-CONNECTED after the voice call has ended, the eNB or NG-RAN node may trigger handover to NR connected to 5GC, if configured to do so, taking into account local operator policy and Handover Restriction List.
P-CSCF selection functionality may be used by the SMF to select the P-CSCF for an IMS PDU Session of the UE.
The SMF can utilize the Network Repository Function to discover the P-CSCF instance(s). The NRF provides the IP address or the FQDN of P-CSCF instance(s) to the SMF. The P-CSCF selection function in the SMF selects the P-CSCF instance(s) based on the available P-CSCF instances obtained from NRF or based on the configured P-CSCF information in the SMF. If the SMF receives FQDN(s) from the NRF or is configured with FQDN(s) the SMF shall resolve these to IP addresses for sending to the UE in the PDU session response.
The following factors may be considered during the P-CSCF discovery and selection:
-	S-NSSAI of the PDU Session.
-	UE location information.
-	Local operator policies.
-	Availability of candidate P-CSCFs.
-	UE IP address.
-	Access Type.
-	Proximity to location of selected UPF.
-	Selected Data Network Name (DNN).
HSS discovery and selection functionality is used by the I-CSCF/S-CSCF/IMS-AS to select an HSS that manages the user's IMS subscriptions and has the ability to serve the IMS services for the UE, see clause AA.3.3 of TS 23.228 [15] and clause 6.3.1 for details.
Emergency Services are provided to support IMS emergency sessions. "Emergency Services" refers to functionalities provided by the serving network when the network is configured to support Emergency Services. Emergency Services are provided to normally registered UEs and to Emergency Registered UEs, that can be either normally registered or in limited service state. Depending on local regulation, receiving Emergency Services in limited service state does not require a valid subscription. Depending on local regulation and on operator's policy, the network may allow or reject a registration request for Emergency Services (i.e. Emergency Registration) from UEs that have been identified to be in limited service state. Four different behaviours of Emergency Services as defined in clause 4.3.12.1 of TS 23.401 [26] are supported.
Emergency Services shall not be provided to a UE over 3GPP access and non-3GPP access concurrently, except for the following case:
-	a UE may be Emergency or normally Registered and have an emergency PDU session over non-3GPP access or may be attached with an emergency session to ePDG over untrusted WLAN (as defined in TS 23.402 [43]) when 3GPP access becomes available. In which case the UE may have to register over 3GPP access and check first the support for Emergency Services over the 3GPP RAT it has selected (e.g. based on Emergency Services Support indication, Emergency Services Fallback, AS broadcast indicator). If there is native support for Emergency Services in the selected 3GPP RAT the UE will attempt to transfer the emergency PDU session from non-3GPP access to 3GPP access (see clause 4.9.2 or clause 4.9.3 of TS 23.502 [3]). If there is no native support for Emergency Services in the selected RAT, but Emergency Services Fallback to another RAT in 5GS or to another System where Emergency Services is supported (based on the conditions defined in clause 5.16.4.11), the UE may trigger first Emergency Services Fallback (see clause 4.13.4.2 of TS 23.502 [3]) and then attempt to transfer the emergency PDU session from non-3GPP access to 3GPP access (see clause 4.9.2 of TS 23.502 [3]). In these cases the UE may thus briefly be emergency registered and receive emergency services over both 3GPP access and non-3GPP access concurrently.
NOTE 1:	The conditions upon which the UE determines that 3GPP access becomes available are implementation dependent.
A UE may only attempt to use Emergency Services over non-3GPP access if it is unable to use Emergency Services over 3GPP access as specified in TS 23.167 [18].
The UE is only allowed to have one PDU session for Emergency services at a time. A PDU Session cannot be changed between a PDU Session for Non-Emergency services and a PDU Session for Emergency services. PDU session for emergency services can be transferred from one Access Type to another as specified in clause 5.16.4.9.
To provide Emergency Services, the AMF is configured with Emergency Configuration Data that are applied to Emergency Services that are established by an AMF based on request from the UE. The AMF Emergency Configuration Data contains the S-NSSAI and Emergency DNN which is used to derive an SMF. In addition, the AMF Emergency Configuration Data contains UE-AMBR and may also contain the statically configured SMF for the Emergency DNN. The SMF may also store Emergency Configuration Data that contains statically configured UPF information for the Emergency DNN.
NOTE 2:	The Network slices associated with emergency services are assumed to be configured consistently in the AMF (i.e. emergency configuration data) and NG-RAN nodes within the corresponding Registration Area where emergency services are to be supported.
When the UE is camped normally in the cell, i.e. not in limited service state, during Registration procedure described in clause 4.2.2.2 of TS 23.502 [3], the serving AMF includes an indication for Emergency Services Support within the Registration Accept to the UE. For 3GPP access, the Emergency Services Support indication is valid within the current Registration Area per RAT (i.e. this is to cover cases when the same registration area supports multiple RATs and they have different capability).
The Emergency Services Support is configured in the AMF according to local regulations and network capabilities. AMF includes Emergency Services Support indicator in the Registration Accept message to indicate that the UE can setup emergency PDU Session to obtain emergency services. The AMF may include additional local emergency numbers associated with the serving network for the UE, further defined in TS 24.501 [47].
During Registration procedures over 3GPP access in a PLMN, the 5GC includes the Emergency Services Support indicator, valid for the current Registration Area and indicating per RAT that Emergency Services are supported if any of the following conditions is true within the current Registration Area:
-	the Network is able to support Emergency Services natively over 5GS;
-	E-UTRA connected to 5GC supports IMS Emergency Services (e.g. voice), and the NG-RAN is able to trigger handover or redirection from NR to E-UTRA connected to 5GC at QoS Flow establishment for IMS Emergency Services (e.g. voice);
-	NG-RAN is able to trigger handover to EPS at QoS Flow establishment for IMS Emergency Services (e.g. voice);
-	NG-RAN is able to trigger redirection to EPS at QoS Flow establishment for IMS Emergency Services (e.g. voice); or
-	NG-RAN is able to trigger 5G SRVCC handover to UTRAN for IMS Emergency Services (i.e. voice).
During Registration procedures over non-3GPP access, the 5GC indicates that Emergency Services are supported if the Network is able to support Emergency Services natively over 5GS.
In the case of SNPN, during Registration procedures over 3GPP access, the 5GC includes the Emergency Services Support indicator, valid for the current Registration Area indicating that Emergency Services are supported if the following condition is true within the current Registration Area:
-	the Network is able to support Emergency Services natively over 5GS.
The 5GC includes an indication per RAT whether it supports Emergency Services Fallback (as defined in clause 5.16.4.11) to another RAT in 5GS or to another System where Emergency Services are supported natively. The Emergency Services Fallback support indicator is valid within the current Registration Area per RAT.
If a certain RAT is restricted for Emergency Services, AMF signals that the corresponding RAT is restricted for Emergency Services Support to the Master RAN Node. This helps assist the Master RAN node determine whether to set up Dual Connectivity for Emergency Services.
UEs that are in limited service state, as specified in TS 23.122 [17], or that camp normally on a cell but failed to register successfully to the network under conditions specified in TS 24.501 [47], initiate the Registration procedure by indicating that the registration is to receive Emergency Services, referred to as Emergency Registration, and a Follow-on request is included in the Registration Request to initiate PDU Session Establishment procedure with a Request Type indicating "Emergency Request". UEs that had registered for normal services and do not have emergency PDU Session established and that are subject to Mobility Restriction in the present area or RAT (e.g. because of restricted tracking area) shall initiate the UE Requested PDU Session Establishment procedure to receive Emergency Services, i.e. with a Request Type indicating "Emergency Request". Based on local regulation, the network supporting Emergency Services for UEs in limited service state provides Emergency Services to these UE, regardless whether the UE can be authenticated, has roaming or Mobility Restrictions or a valid subscription.
For Emergency Services over 3GPP access via PLMN, other than eCall over IMS, the UEs in limited service state that do not operate in SNPN access mode determine that the cell supports Emergency Services over NG-RAN from a broadcast indicator in AS. The cell connected to EPC and 5GC broadcasts separate broadcast indicator for EPC and 5GC to indicate support of emergency services by the EPC and 5GC. If the UE supports SNPN access mode, is in limited service state, is not operating in SNPN access mode, needs to make an emergency call and cannot find an acceptable cell in any PLMN, the UE may activate SNPN access mode and attempt to camp on an acceptable cell of any available SNPN supporting emergency calls (irrespective of SNPN ID or GIN) as defined in TS 23.122 [17]. For Emergency Services over untrusted non-3GPP access, other than eCall over IMS, the UE in limited service state selects any N3IWF as specified in clause 6.3.6. Emergency calls for eCall Over IMS may only be performed if the UE has a USIM.
For Emergency Services over NR via SNPN, other than eCall over IMS, the UEs in limited service state that operate in SNPN access mode determine that the cell supports Emergency Services over NR from a broadcast indicator in AS and indication that the SNPN supports Emergency Services. If the UE operates in SNPN access mode and is in limited service state, the UE shall attempt to camp on an acceptable cell of any available SNPN supporting emergency calls (irrespective of SNPN ID or GIN). If the UE cannot find acceptable cell on any available SNPN, the UE shall deactivate SNPN access mode and camp on any available PLMN cell supporting emergency calls (irrespective of PLMN ID) as defined in TS 23.122 [17].
For NR satellite access, if a UE in limited service state is aware of its location, the UE selects a PLMN that is allowed to operate in the UE location as specified in TS 23.122 [17]. The network may be configured to verify the location of a UE that is registering for emergency services as specified in clause 5.4.11.4.
There is no support for eCall over IMS for SNPNs in this Release.
A serving network shall provide an Access Stratum broadcast indication from NG-RAN (NR or E-UTRA connected to 5GC) to UEs indicating whether eCall Over IMS is supported:
-	When an E-UTRA cell is connected to EPC and 5GC, the cell broadcasts separate Access stratum broadcast indication for 5GC and EPC to indicate support of eCall over IMS by 5GC and EPC.
-	A UE that is not in limited service state determines that the NG-RAN cell supports eCall Over IMS via 5GC using the broadcast indicator for eCall over IMS. Emergency calls for eCall over IMS are not supported over non-3GPP access.
NOTE 3:	The Access Stratum broadcast indicator is determined according to operator policies and minimally indicates that the PLMN, or all of the PLMNs in the case of network sharing, and at least one emergency centre or PSAP to which an eCall Over IMS can be routed, support eCall Over IMS.
-	A UE in limited service state determines that the cell supports eCall Over IMS using both the broadcast indicator for support of Emergency Services over NG-RAN and the broadcast indicator of NG-RAN for eCall over IMS. Emergency calls for eCall Over IMS are not supported over Non-3GPP access and NR via SNPN.
NOTE 4:	The broadcast indicator for eCall Over IMS does not indicate whether UEs in limited service state are supported. So, the broadcast indicator for support of Emergency Services over NG-RAN that indicates limited service state support needs to be applied in addition.
For a UE that is Emergency Registered, if it is unauthenticated the security context is not set up on UE.
In order to receive Emergency Services, UEs that camp on a suitable cell in RM-DEREGISTERED state (i.e. without any conditions that result in limited service state), or that decide to access 5GC via non-3GPP access (and not in limited service state over non-3GPP access), initiate the Initial Registration procedure for normal service instead of Emergency Registration. Upon successful registration, such UEs shall initiate the UE Requested PDU Session Establishment procedure with a Request Type indicating "Emergency Request" to receive Emergency Services if the AMF indicated support for Emergency Services in 5GC (for the RAT the UE is currently camped on when UE is camping on 3GPP access). The UEs that camp normally on a cell or that are connected via Non-3GPP access are informed that the PLMN supports Emergency Services over 5G-AN from the Emergency Services Support indicator in the Registration procedure. This applies to both 3GPP and non-3GPP Access Types. There is no support for Emergency Services for SNPN that is accessed via NWu from a PLMN.
NOTE 5:	The Emergency Services Support indicator in the Registration procedures does not indicate support for eCall Over IMS.
For a UE that is Emergency Registered, normal PLMN or SNPN selection principles apply after the end of the IMS emergency session.
NOTE 6:	For Emergency Services, there is no support for inter PLMN mobility thus there is a risk of service disruption due to failed inter PLMN mobility attempts when there is no session continuity (e.g. change of anchor SMF/UPF due to mobility) for the PDU Session and/or based on operator policies.
NOTE 7	Based on operator policies, Inter PLMN mobility with session continuity can be supported for Emergency Services if the anchor SMF/UPF for PDU Session supporting Emergency Services does not change.
The UE shall set the RRC establishment cause to emergency as defined in TS 38.331 [28] when it requests an RRC Connection in relation to an emergency session.
In the case of Limited Service state, UE shall not include any Network Slice related parameters when communicating with the network.
When a PLMN or SNPN supports IMS and Emergency Services:
-	all AMFs in that PLMN or SNPN shall have the capability to support Emergency Services.
-	at least one SMF shall have this capability.
For other emergency scenarios (e.g. UE autonomous selection for initiating Emergency Services), refer to TS 23.167 [18] for domain selection principles.
For emergency service support in Public network integrated NPNs, refer to clause 5.30.3.5.
For emergency support via 5G ProSe UE-to-Network Relaying, refer to TS 23.304 [128].
According to clause 4.2, the non-roaming architectures (Figure 4.2.3-1 and Figure 4.2.3-2) and roaming architecture with the visited operator's application function (Figure 4.2.4-1 and Figure 4.2.4-4) apply for Emergency Services. The other non-roaming and roaming architectures with services provided by the home network do not apply for Emergency Services.
When Emergency Services are supported and local regulation requires IMS Emergency Sessions to be provided regardless of Mobility Restrictions or Access Restrictions, the Mobility Restrictions or Access Restrictions (see clause 5.3.4.1) should not be applied to UEs receiving Emergency Services. Additionally, due to Mobility Restrictions or Access Restrictions (e.g. CAG restrictions) for normally registered UEs, that have established both non-emergency PDU Sessions and emergency PDU Session, the AMF indicates to the SMF to perform a local release of all non-emergency PDU Sessions via PDU Session Release procedure as specified in clause 4.3.4 of TS 23.502 [3]. The UE locally releases non-emergency PDU Sessions. The AMF and the UE behave as if the UE is emergency registered as described in TS 24.501 [47].
When the (R)AN resources for Emergency Services are established, the ARP value for Emergency Services indicates the usage for Emergency Services to the 5G-AN.
During handover, the source NG-RAN and source AMF ignore any UE related restrictions during handover evaluation when there is an active PDU Session associated with emergency service.
During Mobility Registration Update procedures, including a Mobility Registration Update as part of a handover, the target AMF ignores any Mobility Restrictions or access restrictions for UE with emergency services where required by local regulation. Any non-emergency services are not allowed, by the target network when not allowed by the subscription for the target location. To allow the UE in limited service state (either Emergency Registered or registered for normal service) over a given Access Type to get access to normal services over this Access Type after the Emergency Session has ended and when it has moved to a new area that is not stored by the UE as a forbidden area, after allowing a period of time for subsequent Emergency Services, the UE may explicitly deregister and register for normal services over this Access Type without waiting for the emergency PDU Session Release by the SMF.
This functionality applies to all mobility procedures.
Over 3GPP access, an Emergency Registered UE when its Periodic Registration Update timer expires shall not initiate a Periodic Registration Update procedure but shall enter the RM-DEREGISTERED state. For such UEs, the AMF runs a mobile reachable timer with a similar value to the UE's Periodic Registration Update timer. After expiry of this timer the AMF may change the UE RM state for 3GPP Access in the AMF to RM-DEREGISTERED. The AMF assigns the Periodic Registration Update timer value to Emergency Registered UEs. This timer keeps the Emergency Registered UE registered for Emergency Services after change to CM-IDLE state to allow for a subsequent Emergency Service without a need for a new Emergency Registration.
Over non-3GPP access, an Emergency Registered UE is only reachable in CM-CONNECTED state: since the UE may only use Emergency Services over Non-3GPP access when it is not possible over 3GPP access, 3GPP access is assumed to be unavailable for paging the UE.
When a SMF is selected for Emergency Services, the SMF selection function described in clause 6.3.2 for normal services is applied to the Emergency DNN or the AMF selects the SMF directly from the AMF Emergency Configuration Data. If the SMF selection function described in clause 6.3.2 is used it shall always derive a SMF in the Serving PLMN or SNPN, which guarantees that the IP address is also allocated by the Serving PLMN or SNPN. When a UPF is selected for Emergency Services, the UPF selection function described in clause 6.3.3 for normal services is applied to the Emergency DNN or the SMF selects the UPF directly from the SMF Emergency Configuration Data. The information in the AMF Emergency Configuration Data and the SMF Emergency Configuration Data is specified in clause 5.16.4.1.
Local regulation may require supporting emergency calls from an unauthorised UE. In such a case, the SMF may not have subscription data. Additionally, the local network may want to provide Emergency Services support differently than what is allowed by a UE subscription. Therefore, the initial QoS parameters used for establishing Emergency Services are configured in the V-SMF (local network) in the SMF Emergency Configuration Data.
This functionality is used by the UE Requested PDU Session Establishment procedure when establishing Emergency Services.
Dynamic PCC is used for UEs establishing emergency service and shall be used to manage IMS emergency sessions when an operator allows IMS emergency sessions. When establishing Emergency Services with a SMF, the PCF provides the SMF with the QoS parameters, including an ARP value reserved for the Emergency Services to prioritize the QoS Flows when performing admission control, as defined in TS 23.503 [45].
The PCF rejects an IMS session established via the emergency PDU Session if the AF (i.e. P-CSCF) does not provide an emergency indication to the PCF.
Emergency service is provided by the serving PLMN or SNPN. The UE and serving PLMN or SNPN must have compatible IP address versions in order for the UE to obtain a local emergency PDU Session.
The QoS Flows of a PDU Session associated with the emergency DNN shall be dedicated for IMS emergency sessions and shall not allow any other type of traffic. The emergency contexts shall not be changed to non-emergency contexts and vice versa. The UPF shall block any traffic that is not from or to addresses of network functions (e.g. P-CSCF) providing Emergency Services.
If there is already an emergency PDU Session over a given Access Type (3GPP access or non-3GPP access), the UE shall not request another emergency PDU Session over any Access Type except for handing over the existing emergency PDU Session to the other Access Type.
If the SMF receives a new emergency PDU session establishment request and an emergency PDU Session exists for the same UE over any Access Type, the SMF shall remove the existing SM context locally and clear the associated resources in the network and proceed with the new request.

NOTE:	If the UE releases emergency PDU session locally and requests for establishment of a new one before the SMF has released the emergency PDU session due to PDU session inactivity as specified in clause 4.3.4.2 of TS 23.502 [3], the above duplicate emergency PDU session handling in the network removes the old emergency PDU session as part of establishing a new one. This releases all emergency call back resources related with the old emergency PDU Session.
The ARP reserved for emergency service shall only be assigned to QoS Flows associated with an emergency PDU Session. If the UE is Emergency Registered over a given access, it shall not request a PDU Session to any other DNN over this access.
5.16.4.9a	Handling of PDU Sessions for normal services for Emergency Registered UEs
For an Emergency Registered UE over a given Access Type:
-	the UE shall not initiate the UE Requested PDU Session Establishment procedure for normal service over this Access Type; and
-	the network shall reject any PDU Session Establishment request for normal service from the UE on this Access Type;
-	the UE may attempt to receive normal service over another Access Type if not otherwise prevented by the present document.
For service requirements for eCall only mode, refer to TS 22.101 [33].
A UE configured for eCall Only Mode shall remain in RM-DEREGISTERED state, shall camp on a network cell when available but shall refrain from any Registration Management, Connection Management or other signalling with the network. The UE may instigate Registration Management and Connection Management procedures in order to establish, maintain and release an eCall Over IMS session or a session to any non-emergency MSISDN(s) or URI(s) configured in the USIM for test and/or terminal reconfiguration services. Following the release of either session and after the UE has left RRC_CONNECTED state, the UE starts a timer whose value depends on the type of session (i.e. whether eCall or a session to a non-emergency MSISDN or URI for test/reconfiguration). While the timer is running, the UE shall perform normal RM/CM procedures and is permitted to respond to paging to accept and establish an incoming session (e.g. from an emergency centre, PSAP or HPLMN operator). When the timer expires, once the UE is not in RRC_CONNECTED state, the UE shall perform a UE-initiated Deregistration procedure if still registered and enter RM-DEREGISTERED state.
NOTE 1:	An HPLMN operator can change the eCall Only Mode configuration state of a UE in the USIM. An HPLMN operator can also instead add, modify or remove a non-emergency MSISDN or URI in the USIM for test and/or terminal reconfiguration services. This can occur following a UE call to a non-emergency MSISDN or URI configured for reconfiguration. When the eCall Only Mode configuration is removed, the UE operates as a normal UE that can support eCall over IMS.
NOTE 2:	A test call and a reconfiguration call can be seen as normal (non-emergency) call by a serving PLMN and normal charging rules can apply depending on operator policy.
NOTE 3:	An MSISDN configured in the USIM for test and/or terminal reconfiguration services for eCall Over IMS can differ from an MSISDN configured in the USIM for test services for eCall over the CS domain.
In order to support various deployment scenarios for obtaining Emergency Services, the UE and 5GC may support the mechanism to direct or redirect the UE either towards E-UTRA connected to 5GC (RAT fallback) when only NR does not support Emergency Services or towards EPS (E-UTRAN connected to EPC System fallback) when the 5GC does not support Emergency Services. Emergency Services fallback may be used when the 5GS does not indicate support for Emergency Services (see clause 5.16.4.1) and indicates support for Emergency Services fallback.
Following principles apply for Emergency Services Fallback:
-	If the AMF indicates support for Emergency Services fallback in the Registration Accept message, then in order to initiate Emergency Service, normally registered UE supporting Emergency Services fallback shall initiate a Service Request with Service Type set to Emergency Services fallback as defined in clause 4.13.4.1 of TS 23.502 [3].
-	AMF uses the Service Type Indication within the Service Request to redirect the UE towards the appropriate RAT/System. The 5GS may, for Emergency Services, trigger one of the following procedures:
-	Handover or redirection to EPS.
-	Handover or redirection to E-UTRA connected to 5GC.
-	After receiving the Service Request for Emergency Fallback, the AMF triggers N2 procedure resulting in either CONNECTED state mobility (Handover procedure) or IDLE state mobility (redirection) to either E-UTRA/5GC or to E-UTRAN/EPC depending on factors such as N26 availability, network configuration and radio conditions. In the N2 procedure, the AMF based on support for Emergency Services in 5GC or EPC may indicate the target CN for the RAN node to know whether inter-RAT fallback or inter-system fallback is to be performed. The target CN indicated in the N2 procedure is also conveyed to the UE in order to be able to perform the appropriate NAS procedures (S1 or N1 Mode).
-	When the AS re-keying procedure and the Emergency Fallback procedure collides, the AMF gives up the AS re-keying procedure and only initiates the Emergency Fallback procedure.
NOTE 1:	Emergency Services Fallback to EPS can be followed by an onward movement to GERAN or UTRAN via CSFB procedures if the PLMN does not support IMS emergency services.
NOTE 2:	If the UE has signalled that S1 mode is disabled for a network that only supports IMS voice via EPS Fallback, the AMF will not indicate that Emergency Services Fallback is supported over 3GPP access.
Emergency Services fallback is supported only in case of PLMN. Emergency Services Fallback is not supported for SNPN.
TS 22.153 [24] specifies the service requirements for Multimedia Priority Service (MPS). MPS allows Service Users (as per TS 22.153 [24]) priority access to system resources in situations such as during congestion, creating the ability to deliver or complete sessions of a high priority nature. Service Users are government-authorized personnel, emergency management officials and/or other authorized users. MPS supports priority sessions on an "end-to-end" priority basis.
MPS is based on the ability to invoke, modify, maintain and release sessions with priority, and deliver the priority media packets under network congestion conditions. MPS is supported in a roaming environment when roaming agreements are in place and where regulatory requirements apply.
NOTE 1:	If a session terminates on a server in the Internet (e.g. web-based service), then the remote end and the Internet transport are out of scope for this specification.
MPS is supported for Service Users using UEs connecting via 3GPP access. MPS is also supported for Service Users using UEs that support connecting via Trusted or Untrusted non-3GPP access via WLAN for MPS. N3IWF selection is according to clause 6.3.6 for PLMN access.
A Service User may use an MPS-subscribed UE or any other UE to obtain MPS. An MPS-subscribed UE obtains priority access to the Radio Access Network by using the Unified Access Control mechanism according to TS 22.261 [2]. This mechanism provides preferential access to UEs based on its assigned Access Identity. If an MPS-subscribed UE belongs to the special Access Identity as defined in TS 22.261 [2], the UE has preferential access to the network compared to ordinary UEs in periods of congestion.
MPS subscription allows users to receive priority services, if the network supports MPS. The same MPS subscription applies to access via 3GPP access and non-3GPP access via WLAN. MPS subscription entitles a USIM with special Access Identity. MPS subscription includes indication for support of priority PDU connectivity service including MPS for Data Transport Service and IMS priority service support for the end user. Priority Level regarding QoS Flows and IMS are also part of the MPS subscription information. The usage of Priority Level is defined in TS 22.153 [24], TS 23.503 [45] and TS 23.228 [15].
NOTE 2:	The same MPS subscription in the UDM and/or on the USIM is used for priority treatment of 3GPP procedures when the access is WLAN.
NOTE 3:	The term "Priority PDU connectivity services" is used to refer to 5G System functionality that corresponds to the functionality as provided by LTE/EPC Priority EPS bearer services in clause 4.3.18.3 of TS 23.401 [26].
MPS includes signalling priority and media priority. All MPS-subscribed UEs get priority for QoS Flows (e.g. used for IMS signalling) when established to the DN that is configured to have priority for a given Service User by setting MPS-appropriate values in the QoS profile in the UDM.
Service Users are treated as On Demand MPS subscribers or not, based on regional/national regulatory requirements. On Demand service is based on Service User invocation/revocation explicitly and applied to the media QoS Flows being established. When not On Demand MPS service does not require invocation, and provides priority treatment for all QoS Flows only to the DN that is configured to have priority for a given Service User after attachment to the 5G network.
MPS for Data Transport Service is an on-demand service that may be invoked/revoked by an authorized Service User using a UE with a subscription for MPS (i.e. according to its MPS profile), or using a UE that does not have a subscription for MPS (using methods not in scope of this specification).
MPS for Data Transport Service requires explicit invocation. The Service User invokes the service by communicating with an AF. The authorization of an MPS for Data Transport Service request is done by the AF or the PCF according to clause 6.1.3.11 of TS 23.503 [45]. Upon successful authorization, the PCF performs the necessary actions to achieve appropriate ARP and 5QI settings for the QoS Flows (see clause 6.1.3.11 of TS 23.503 [45]).
MPS for Data Transport Service enables the prioritization of all traffic on the QoS Flow associated with the default QoS rule and other QoS Flows upon AF request. The QoS modification to the QoS Flow associated with the default QoS rule and other QoS Flows is done based on operator policy and regulatory rules by means of local PCF configuration.
NOTE 4:	According to regional/national regulatory requirements and operator policy, On-Demand MPS (including MPS for Data Transport Service) Service Users can be assigned the highest priority.
NOTE 5:	If no configuration is provided, MPS for Data Transport Service applies only to the QoS Flow associated with the default QoS rule.
NOTE 6:	MPS for DTS controls the priority of traffic on QoS Flows independent of the application(s) being used. Other mechanisms (e.g. Priority PDU connectivity service) can be used to control the priority of traffic on other QoS Flows under the control of specific data application(s), based on operator policy.
NOTE 7:	MPS for Data Transport Service can be applied to any DNN other than the well-known DNN for IMS.
For MPS for Data Transport Service, the AF may also create an SDF for priority signalling between the UE and the AF (see clause 6.1.3.11 of TS 23.503 [45]).
Priority treatment is applicable to IMS based multimedia services and Priority PDU connectivity service including MPS for Data Transport Service.
Priority treatment for MPS includes priority message handling, including priority treatment during authentication, security, and Mobility Management procedures.
Priority treatment for MPS session requires appropriate ARP and 5QI (plus 5G QoS characteristics) setting for QoS Flows according to the operator's policy.
NOTE 8:	Use of QoS Flows for MPS with QoS characteristics signalled as part of QoS profile enables the flexible assignment of 5G QoS characteristics (e.g. Priority Level) for MPS.
When an MPS session is requested by a Service User, the following principles apply in the network:
-	QoS Flows employed in an MPS session shall be assigned ARP value settings appropriate for the priority of the Service User.
-	Setting ARP pre-emption capability and vulnerability for MPS QoS Flows, subject to operator policies and depending on national/regional regulatory requirements.
-	Pre-emption of non-Service Users over Service Users during network congestion situation, subject to operator policy and national/regional regulations.
The terminating network identifies the priority of the MPS session and applies priority treatment, including paging with priority, to ensure that the MPS session can be established with priority to the terminating user (either a Service User or normal user).
MPS priority mechanisms can be classified as subscription-related, invocation-related, and those applied to existing QoS Flows. Subscription related mechanisms, as described in clause 5.22.2, are further divided into two groups: those which are always applied and those which are conditionally applied. Invocation-related mechanisms, as described in clause 5.22.3, are further divided into three groups: those that apply for mobile originated SIP call/sessions, those that apply for mobile terminated SIP call/sessions, and those that apply for the Priority PDU connectivity services including MPS for Data Transport Service. Methods applied to existing QoS Flows focus on handover and congestion control and are described in clause 5.22.4.
NOTE 9:	The network can hide its topology from the AF supporting MPS for Data Transport Service. At the same time, the UE needs to provide its locally known IP address to the AF supporting MPS for Data Transport Service to support interactions with the applicable PCF. Thus, there can be no NAT of the UE IP address between the UPF and the AF supporting MPS for Data Transport Service.
For WLAN access, the UE may notify the TNAN/N3IWF of its MPS subscription before the NAS Registration Request. Based on operator policy, the TNAN/N3IWF may use this indication to provide this UE with priority treatment in the case of congestion/overload before receipt of the NAS Registration Request with an MPS priority establishment cause.
According to TS 22.280 [37], a Mission Critical Service (MCX Service) is a communication service reflecting enabling capabilities Mission Critical Applications and provided to end users from Mission Critical Organizations and mission critical applications for other businesses and organizations (e.g. utilities, railways). An MCX Service is either Mission Critical Push To Talk (MCPTT) as defined in TS 23.379 [38], Mission Critical Video (MCVideo) as defined in TS 23.281 [39], or Mission Critical Data (MCData) as defined in TS 23.282 [40] and represents a shared underlying set of requirements between two or more MCX Service types. MCX Services are not restricted only to the ones defined in this clause and such services can also have priority treatment, if defined via operator's policy and/or local regulation.
MCX Services are based on the ability to invoke, modify, maintain and release sessions with priority, and deliver the priority media packets under network congestion conditions. As specified in clause 6.8 of TS 22.261 [2], MCX Users require 5GS functionality that allows for real-time, dynamic, secure and limited interaction with the QoS and policy framework for modification of the QoS and policy framework by authorized users. The limited interaction is based on operator policy, and provides specific limitations on what aspects of the QoS and policy framework an authorized MCX User can modify. MCX Services are supported in a roaming environment when roaming agreements are in place and where regulatory requirements apply.
An MCX-subscribed UE obtains priority access to the Radio Access Network by using the Unified Access Control mechanism according to TS 22.261 [2]. This mechanism provides preferential access to UEs based on its assigned Access Identity. If an MCX-subscribed UE belongs to the special Access Identity as defined in TS 22.261 [2], the UE has preferential access to the network compared to ordinary UEs in periods of congestion. MCX subscription allows users to receive priority services, if the network supports MCX. MCX subscription entitles a USIM with special Access Identity.
MCX Services leverage the foundation of the 5G QoS Model as defined in clause 5.7, and 5G Policy Control as defined in clause 5.14. It requires that the necessary subscriptions are in place for both the 5G QoS Profile and the necessary Policies. In addition, MCX Services leverage priority mechanism as defined in clause 5.22.
The terminating network identifies the priority of the MCX Service session and applies priority treatment, including paging with priority, to ensure that the MCX Service session can be established with priority to the terminating user (either an MCX User or normal user).
Priority treatment for MCX Service includes priority message handling, including priority treatment during authentication, security, and Mobility Management procedures.
Priority treatment for MCX Service sessions require appropriate ARP and 5QI (plus 5G QoS characteristics) setting for QoS Flows according to the operator's policy.
NOTE:	Use of QoS Flows for MCX Service sessions with non-standardized 5QI values enables the flexible assignment of 5G QoS characteristics (e.g. Priority Level).
When a MCX Service session is requested by an MCX User, the following principles apply in the network:
-	QoS Flows employed in a MCX Service session shall be assigned ARP value settings appropriate for the priority of the MCX User.
-	Setting ARP pre-emption capability and vulnerability of QoS Flows related to a MCX Service session, subject to operator policies and depending on national/regional regulatory requirements.
-	Pre-emption of non-MCX Users over MCX Users during network congestion situations, subject to operator policy and national/regional regulations.
Priority treatment is applicable to IMS based multimedia services and priority PDU connectivity services.
Relative PDU priority decisions for MCX Service sessions are based on real-time data of the state of the network and/or based on modification of the QoS and policy framework by authorized users as described in clause 6.8 of TS 22.261 [2].
Clause 5.17.1 describes the UE and network behaviour for the migration from EPC to 5GC.
Deployments based on different 3GPP architecture options (i.e. EPC based or 5GC based) and UEs with different capabilities (EPC NAS and 5GC NAS) may coexist at the same time within one PLMN.
It is assumed that a UE that is capable of supporting 5GC NAS procedures may also be capable of supporting EPC NAS (i.e. the NAS procedures defined in TS 24.301 [13]) to operate in legacy networks e.g. in the case of roaming.
The UE will use EPC NAS or 5GC NAS procedures depending on the core network by which it is served.
In order to support smooth migration, it is assumed that the EPC and the 5GC have access to a common subscriber database, that is HSS in the case of EPC and the UDM in the case of 5GC, acting as the master data base for a given user as defined in TS 23.002 [21]. The PCF has access to the UDR that acts as a common subscriber database for a given user identified by a SUPI using the Nudr services defined in TS 23.502 [3].

Figure 5.17.1.1-1: Architecture for migration scenario for EPC and 5G CN
A UE that supports only EPC based Dual Connectivity with secondary RAT NR:
-	always performs initial access through E-UTRA (LTE-Uu) but never through NR;
-	performs EPC NAS procedures over E-UTRA (i.e. Mobility Management, Session Management etc) as defined in TS 24.301 [13].
A UE that supports camping on 5G Systems with 5GC NAS:
-	performs initial access either through E-UTRAN that connects to 5GC or NR towards 5GC;
-	performs initial access through E-UTRAN towards EPC, if supported and needed;
-	performs EPC NAS or 5GC NAS procedures over E-UTRAN or NR respectively (i.e. Mobility Management, Session Management etc) depending on whether the UE requests 5GC access or EPC access, if the UE also supports EPC NAS.
When camping on an E-UTRA cell connected to both EPC and 5GC, a UE supporting EPC NAS and 5GC NAS shall select a core network type (EPC or 5GC) and initiate the corresponding NAS procedure as specified in TS 23.122 [17].
In order to support different UEs with different capabilities in the same network, i.e. both UEs that are capable of only EPC NAS (possibly including EPC based Dual Connectivity with secondary NR) and UEs that support 5GC NAS procedures in the same network:
-	eNB that supports access to 5GC shall broadcast that it can connect to 5GC. Based on that, the UE AS layer indicates "E-UTRA connected to 5GC" capability to the UE NAS layer. In addition the eNB broadcasts the supported CIoT 5GS Optimisations that the UE uses for selecting a core network type.
-	It is also expected that the UE AS layer is made aware by the UE NAS layer whether a NAS signalling connection is to be initiated to the 5GC. Based on that, UE AS layer indicates to the RAN whether it is requesting 5GC access (i.e. "5GC requested" indication). The RAN uses this indication to determine whether a UE is requesting 5GC access or an EPC access. RAN routes NAS signalling to the applicable AMF or MME accordingly.
NOTE:	The UE that supports EPC based Dual Connectivity with secondary RAT only does not provide this "5GC requested" indication at Access Stratum when it performs initial access and therefore eNB uses the "default" CN selection mechanism to direct this UE to an MME
The 5GC network may steer the UE from 5GC based on:
-	Core Network type restriction (e.g. due to lack of roaming agreements) described in clause 5.3.4.1.1;
-	Availability of EPC connectivity;
-	UE indication of EPC Preferred Network Behaviour; and
-	Supported Network Behaviour.
The UE that wants to use one or more of these functionalities not supported by 5G System, when in CM-IDLE may disable all the related radio capabilities that allow the UE to access 5G System. The triggers to disable and re-enable the 5GS capabilities to access 5G System in this case are left up to UE implementation.
In order to support the interworking with EPC, the SMF+PGW-C provides information over N4 to the UPF+PGW-U related to the handling of traffic over S5-U. Functionality defined in TS 23.503 [45] for traffic steering control on SGi-LAN/N6 can be activated in UPF+PGW-U under consideration of whether the UE is connected to EPC or 5GC.
When the UE is connected to EPC and establishes/releases PDN connections, the following differences apply to N4 compared to when the UE is connected to 5GC:
-	The CN Tunnel Info is allocated for each EPS Bearer.
-	In addition to the Service Data Flow related information, the SMF+PGW-C shall be able to provide the GBR and MBR values for each GBR bearer of the PDN connection to the UPF+PGW-U.
If the UE does not have preconfigured rules for associating an application to a PDN connection (i.e. the UE does not have rules in UE local configuration and is not provisioned with ANDSF rules), the UE should use a matching URSP rule as defined in TS 23.503 [45], if available, to derive the parameters, e.g. APN, for the PDN connection establishment and associating an application to the PDN connection.
NOTE:	The mapping between the parameters in the URSP rules and the parameters used for PDN connection establishment is defined in TS 24.526 [110].
During mobility from EPS to 5GS, the handling of QoS constraints in V-SMF is specified in clauses 4.11.1.2.2 and 4.11.1.3.3 of TS 23.502 [3] and follows the same principle as described in clause 5.7.1.11.
Interworking with EPC in this clause refers to mobility procedures between 5GC and EPC/E-UTRAN, except for clause 5.17.2.4. Network slicing aspects for EPS Interworking are specified in clause 5.15.7
In order to interwork with EPC, the UE that supports both 5GC and EPC NAS can operate in single-registration mode or dual-registration mode:
-	In single-registration mode, UE has only one active MM state (either RM state in 5GC or EMM state in EPC) and it is either in 5GC NAS mode or in EPC NAS mode (when connected to 5GC or EPC, respectively). UE maintains a single coordinated registration for 5GC and EPC. Accordingly, the UE maps the EPS-GUTI to 5G GUTI during mobility between EPC and 5GC and vice versa following the mapping rules in Annex B. To enable re-use of a previously established 5G security context when returning to 5GC, the UE also keeps the native 5G-GUTI and the native 5G security context when moving from 5GC to EPC.
-	In dual-registration mode, UE handles independent registrations for 5GC and EPC using separate RRC connections. In this mode, UE maintains 5G-GUTI and EPS-GUTI independently. In this mode, UE provides native 5G-GUTI, if previously allocated by 5GC, for registrations towards 5GC and it provides native EPS-GUTI, if previously allocated by EPC, for Attach/TAU towards EPC. In this mode, the UE may be registered to 5GC only, EPC only, or to both 5GC and EPC.
	Dual-registration mode is intended for interworking between EPS/E-UTRAN and 5GS/NR. A dual-registered UE should not send its E-UTRA connected to 5GC and E-UTRAN radio capabilities to NR access when connected to 5GS/NR to avoid being handed over to 5GC-connected E-UTRA or to E-UTRAN.
NOTE 1:	This is to prevent the dual registered UE from being connected to the same E-UTRA cell either connected to EPC or 5GC simultaneously using separate RRC connections via single RAN node as a result of handover. If a dual- registered UE implementation chooses to send its E-UTRA capability when connected to 5GS/NR, the UE and the network behaviour when UE enters a 5GC-connected E-UTRA is not further specified. If however the UE is registered with 5GS/NR only, the UE can send its E-UTRA capability in order to allow inter-RAT handover to E-UTRA/5GC and Dual Connectivity with multiple RATs.
	If a dual-registered UE had not sent its E-UTRA connected to 5GC and E-UTRAN radio capabilities to 5GS and the UE needs to initiate emergency services, it shall locally re-enable its E-UTRA connected to 5GC and E-UTRAN radio capabilities in order to perform domain selection for emergency services as defined in TS 23.167 [18].
NOTE 2:	However even in this case, the UE is still not expected to connect to E-UTRAN/EPC and E-UTRA/5GC simultaneously using separate RRC connection via single RAN node as a result of the domain selection for emergency services.
The support of single registration mode is mandatory for UEs that support both 5GC and EPC NAS.
During E-UTRAN Initial Attach, UE supporting both 5GC and EPC NAS shall indicate its support of 5G NAS in UE Network Capability described in clause 4.11.1.5.2 of TS 23.502 [3].
During registration to 5GC, UE supporting both 5GC and EPC NAS shall indicate its support of EPC NAS.
NOTE 3:	This indication may be used to give the priority towards selection of SMF+PGW-C for UEs that support both EPC and 5GC NAS.
If the UE supports 5GC NAS, at PDN connection establishment in EPC, the UE may allocate a PDU Session ID and sends it via PCO, regardless of N1 mode status (i.e. enabled or disabled) in the UE.
NOTE 4:	UE providing a PDU Session ID at PDN connection establishment even when N1 mode is disabled allows for IP address preservation during EPC to 5GC mobility once the UE re-enables N1 mode.
NOTE 5:	For the case the MME has selected a standalone PGW for a PDN connection, if the UE re-enables N1 mode and reports the change in UE Network Capability, the MME can initiate PDN disconnection with reactivation required as described in clause 4.11.0a.8 of TS 23.502 [3] to allow selection of SMF+PGW-C thus session continuity at EPC to 5GC mobility.
If the EPC supports "Ethernet" PDU Session Type, and the 5GSM Capabilities indicate that the UE supports Ethernet PDN type in EPC, then PDU Session type "Ethernet" is transferred to EPC as "Ethernet". Otherwise, PDU Session types "Ethernet" and "Unstructured" are transferred to EPC as "non-IP" PDN type (when supported by UE and network). If the UE or EPC does not support Ethernet PDN type in EPC, the UE sets the PDN type to non-IP when it moves from 5GS to EPS and after the transfer to EPS, and the UE and the SMF shall maintain information about the PDU Session type used in 5GS, i.e. information indicating that the PDN Connection with "non-IP" PDN type corresponds to PDU Session type Ethernet or Unstructured respectively. This is done to ensure that the appropriate PDU Session type will be used if the UE transfers to 5GS.
PDN type "non-IP" is transferred to 5GS as "Unstructured" PDU Session type if it is successfully transferred.
It is assumed that if a UE supports Ethernet PDU Session type and/or Unstructured PDU Session type in 5GS it will also support non-IP PDN type in EPS. If this is not the case, the UE shall locally delete any EBI(s) corresponding to the Ethernet/Unstructured PDU Session(s) to avoid that the Ethernet/Unstructured PDU Session(s) are transferred to EPS.
MTU size consideration for PDU Sessions and PDN Connections towards a SMF+PGW-C follows the requirements in clause 5.6.10.4.
Networks that support interworking with EPC, may support interworking procedures that use the N26 interface or interworking procedures that do not use the N26 interface. Interworking procedures with N26 support provides IP address continuity on inter-system mobility to UEs that support 5GC NAS and EPC NAS and that operate in single registration mode. Networks that support interworking procedures without N26 shall support procedures to provide IP address continuity on inter-system mobility to UEs operating in both single-registration mode and dual-registration mode. In such networks, AMF shall provide the indication that interworking without N26 is supported to UEs during initial Registration in 5GC or MME may optionally provide the indication that interworking without N26 is supported in the Attach procedure in EPC as defined in TS 23.401 [26].
If the network does not support interworking with EPC, network shall not indicate support for "interworking without N26" to the UE.
When the HSS+UDM is required to provide the subscription data to the MME, for each APN, only one SMF+PGW-C FQDN and associated APN is provided to the MME according to TS 23.401 [26].
For interworking without N26 interface:
-	if the PDU session supports interworking, the SMF+PGW-C stores the SMF+PGW-C FQDN to SMF context in HSS+UDM when the SMF is registered to HSS+UDM.
-	For an APN, the HSS+UDM selects one of the stored SMF+PGW-C FQDN based on operator's policy.
For interworking with N26 interface:
-	For a DNN, AMF determines PDU session(s) associated with 3GPP access in only one SMF+PGW-C supporting EPS interworking via EBI allocation procedure as described in clause 4.11.1.4.1 of TS 23.502 [3].
-	If the network supports EPS interworking of non-3GPP access connected to 5GC, the AMF serving 3GPP access notifies the UDM to store the association between DNN and SMF+PGW-C FQDN which supports EPS interworking as Intersystem continuity context, to avoid MME receiving inconsistent SMF+PGW-C FQDN from AMF and HSS+UDM.
-	The AMF updates Intersystem continuity context if the SMF+PGW-C and DNN association is changed due to the AMF selecting another SMF+PGW-C for EPS interworking for the same DNN.
-	If the SMF+PGW-C FQDN and associated DNN exists in Intersystem continuity context, the HSS+UDM provides MME with SMF+PGW-C FQDN and associated APN.
It does not assume that the HSS+UDM is aware of whether N26 is deployed in the serving network. The HSS+UDM check the Intersystem continuity context first. If no SMF+PGW-C FQDN associated with an DNN exists in Intersystem continuity context, the HSS+UDM selects one of the SMF+PGW-C FQDN for the APN from SMF context based on operator's policy.
In entire clause 5.17.2 the terms "initial attach", "handover attach" and "TAU" for the UE procedures in EPC can alternatively be combined EPS/IMSI Attach and combined TA/LA depending on the UE configuration defined in TS 23.221 [23].
If a UE in MICO mode moves to E-UTRAN connected to EPC and any of the triggers defined in clause 5.4.1.3 occur, then the UE shall locally disable MICO mode and perform the TAU or Attach procedure as defined in clause 5.17.2. The UE can renegotiate MICO when it returns to 5GS during (re-)registration procedure.
IP address preservation for IP PDU sessions cannot be ensured on subsequent mobility from EPC/E-UTRAN to GERAN/UTRAN to a UE that had initially registered in 5GS and moved to EPC/E-UTRAN.
NOTE 6:	The SMF+PGW-C might not include the GERAN/UTRAN PDP Context anchor functionality. Also, 5GC does not provide GERAN/UTRAN PDP Context parameters to the UE when QoS Flows of PDU Session are setup or modified in 5GS. Hence, the UE might not be able to activate the PDP contexts when it transitions to GERAN/UTRAN.
IP address preservation for IP PDU sessions cannot be ensured on subsequent mobility from EPC/E-UTRAN to 5GS for a 5GS NAS capable UE that had initially established a PDP context via GERAN/UTRAN and moved to EPC/E-UTRAN. IP address preservation for IP PDU session mobility between EPC/E-UTRAN and 5GS may be re-ensured as specified in clause 5.17.2.4 when UE moves from GERAN/UTRAN into EPC/E-UTRAN.
NOTE 7:	The PGW acting as a GGSN might not support SMF+PGW-C functionality. GPRS does not support 5GS parameters transfer between UE and SMF+PGW-C (e.g. providing of PDU session ID and 5GS QoS information).
When a PDU session is moved from 5GS to EPS, the SMF+PGW-C keeps the registration and subscription in HSS+UDM until the corresponding PDN connection is released.
The SMF+PGW-C receives notification of subscription update regarding the 5G parameters (e.g. DNNs, S-NSSAIs) which are associated with the established PDN connection(s) connecting via EPS. If the subscription regarding DNN, QoS profile or PDN connection type associated with the PDN connection is updated, then the MME receives the subscription update and triggers corresponding actions according to TS 23.401 [26]. If the SMF+PGW-C receives subscription updates (e.g. change of 5GS Subscribed NSSAI) from the UDM the SMF+PGW-C triggers corresponding actions for the PDN connection. This may include (depending on the modified parameter) to:
-	update the UPF (e.g. for a change of Framed Route information); or
-	release the PDN connection with an appropriate cause (e.g. for change of EPS/5GS interworking support, for subscription removal of S-NSSAI associated with the PDN connection);
-	do nothing about changes to DNN and/or PDU Session type that are handled by the MME.
If header compression is used for Control Plane CIoT EPS/5GS Optimisations and when the UE moves from EPS to 5GS or from 5GS to EPS, the UE may initiate the PDU Session Modification Procedure or UE requested bearer resource modification procedure to renegotiate the header compression configuration and to establish the compression context between the UE and MME/SMF, see TS 23.401 [26] and TS 24.501 [47].
If the UE is moving from 5GS to EPS and the RAT type is also moving from a "broadband" RAT (e.g. NR or WB-E-UTRA) to NB-IoT in EMM-IDLE state, the UE should set the mapped EPS bearer context for which the EPS bearer is a dedicated EPS bearer to state BEARER CONTEXT INACTIVE as for NB-IoT UEs in EPS only support the default bearers. In addition, UE shall locally deactivate the related bearers according to the maximum number of supported UP resources and send the latest bearer context status in the TAU Request.
If APN Rate Control is used when the UE moves from EPC to 5GC then the P-GW/SCEF and UE store the current APN Rate Control Status for an APN. If while connected to 5GC the last PDU Session to a DNN that is the same as the APN identified in the APN Rate Control Status is released then the APN Rate Control Status may be stored in the AMF in addition to the Small Data Rate Control Status and the UE discards the APN Rate Control Status. The APN Rate Control Status is stored in the AMF so it can be provided to the MME during mobility to EPC and subsequently applied at establishment of a new first PDN Connection to the same APN, if valid. The APN Rate Control Status is provided to the UPF+PGW-U if a first new PDU Session is established towards the DNN that is the same as the APN identified in the APN Rate Control Status if the UE moves back to EPC, taking into account its validity period.
The UE may be provided with initial APN Rate Control parameters by the SMF when a first new PDU Session is established for a DNN and S-NSSAI that supports interworking with EPS and the DNN matches an APN. The SMF provides the APN Rate Control Status for the APN that matches the DNN, if available at the SMF, otherwise the configured APN Rate Control parameters for the APN that matches the DNN are provided as the initially applied parameters. If the initially applied parameters differ from the configured APN Rate Control parameters and the first APN Rate Control validity period expires, the UE is updated with the configured APN Rate Control parameters once the UE has moved to EPC.
NOTE 8:	If the APN Rate Control Status is provided to a UPF+PGW-U it is not used for Small Data Rate Control while the UE is connected to 5GC, it is only used as the APN Rate Control Status if the UE moves to EPC.
NOTE 9:	Encoding of APN and DNN specified in TS 23.003 [19] allows the comparison of EPS APN and 5GS DNN.
If a Service Gap timer is running in the AMF when the UE moves from 5GC to EPC, the AMF stops the running Service Gap timer. If the UE returns to 5GC from EPC the AMF provides the Service Gap Time to the UE as described in clause 5.31.16.
If a Service Gap timer is running in the MME when the UE moves from EPC to 5GC, the MME stops the running Service Gap timer. If the UE returns to E-UTRAN connected to EPC from 5GC the MME provides the Service Gap Time to the UE as described in TS 23.401 [26].
If a Service Gap timer is running in the UE when the UE moves to from 5GC to EPC and if Service Gap Time is received from the MME, the UE stores the received Service Gap Time for later use when the timer needs to be started next time, and the Service Gap timer that was started before the system change is kept running in the UE and applied for EPC. If a Service Gap timer is running in the UE when the UE moves to 5GC and if Service Gap Time is received from the AMF, the UE stores the received Service Gap Time for later use when the timer needs to be started next time, and the Service Gap timer that was started before the system change is kept running in the UE and applied in 5GS.
For UE currently served by EPC, a SMF+PGW-C may support L2TP tunnelling on N6, as described in clause 5.8.2.16.
Interworking procedures using the N26 interface, enables the exchange of MM and SM states between the source and target network. The N26 interface may be either intra-PLMN or inter-PLMN (e.g. to enable inter-PLMN mobility). When interworking procedures with N26 is used, the UE operates in single-registration mode. For the 3GPP access, the network keeps only one valid MM state for the UE, either in the AMF or MME. For the 3GPP access, either the AMF or the MME is registered in the HSS+UDM.
The support for N26 interface between AMF in 5GC and MME in EPC is required to enable seamless session continuity (e.g. for voice services) for inter-system change.
The UE's subscription may include restriction for Core Network Type (EPC) and RAT restriction for E-UTRA. If so, the UDM provides these restrictions to the AMF. The AMF includes RAT and Core Network type restrictions in the Handover Restriction List to the NR. The AMF and NR use these restrictions to determine if mobility of the UE to EPS or E-UTRA connected to EPS should be permitted. When the UE moves from 5GS to EPS, the SMF determines which PDU Sessions can be relocated to the target EPS, e.g. based on capability of the deployed EPS, operator policies for which PDU Session, seamless session continuity should be supported etc. The SMF can release the PDU Sessions that cannot be transferred as part of the handover or Idle mode mobility. However, whether the PDU Session is successfully moved to the target network is determined by target EPS.
Similarly, the UE's subscription may include restriction for Core Network Type (5GC) and RAT restriction for NR. If so, the HSS provides these restrictions to the MME. The MME includes RAT and Core Network type restrictions in the Handover Restriction List to the E-UTRAN. The MME and E-UTRAN use these restrictions to determine if mobility of the UE to 5GS or NR connected to 5GS should be permitted. If the SMF+PGW-C receives the PDU session ID from UE via PCO and know 5GC is not restricted for the PDN connection by user subscription, the SMF+PGW-C sends the mapped QoS parameters to UE. When the UE moves from EPS to 5GS, for the case when the MME has selected SMF+PGW-C even for PDN connections that cannot be relocated to the target 5GS, the SMF+PGW-C determines which PDN Connections can be relocated to the target 5GS, e.g. based on capability of the deployed 5GS, subscription and operator policies for which PDN Connection, seamless session continuity should be supported etc. The SMF+PGW-C and NG-RAN can reject the PDN Connections that cannot be transferred as part of the handover or Idle mode mobility.
For the case when the MME has selected standalone P-GW for a PDN connection for which session continuity is not supported and the AMF cannot retrieve the address of the corresponding SMF during EPS to 5GS mobility, the AMF does not move the PDN connection to 5GS.
NOTE 1:	When applying the AMF planned removal procedure or the procedure to handle AMF failures (see clause 5.21.2) implementations are expected to update the DNS configuration to enable MMEs to discover alternative AMFs if the MME tries to retrieve a UE context from an AMF that has been taken out of service or has failed. This addresses the scenario of UEs performing 5GS to EPS Idle mode mobility and presenting a mapped GUTI pointing to an AMF that has been taken out of service or has failed.
In the case of mobility from 5GS to EPS, if the MME lacks certain capability, e.g. MME not supporting 15 EPS bearers, the 5GC shall not transfer the UE EPS bearers and/or EPS PDN connections that are not supported by the EPC network. If the MME does not support 15 EPS bearers, the AMF determines which EBIs cannot be transferred to EPS, and retrieves the EPS bearer contexts from the SMF+PGW-C for the EBIs that can be transferred to EPS.
NOTE 2:	How the AMF determines which EBIs can be transferred to EPS is according to local configuration, e.g. according to DNN, S-NSSAI, ARP associated with an EBI.
In the case of mobility from 5GS to EPS, if the mobility is a result of the PCF modifying the RFSP Index value for the UE to indicate that EPC/E-UTRAN access is prioritized over the 5GS access, the AMF may be sent with a RFSP in Use Validity Time by the PCF as specified in TS 23.503 [45]. If the AMF receives RFSP in Use Validity Time and selects the RFSP Index in use identical to the authorized RFSP Index as specified in clause 5.3.4.3, then the AMF provides the MME with the RFSP Index in use and the RFSP in Use Validity Time, which indicates the time by which the RFSP Index in use will be used in the MME as specified in clause 4.11.1.5.8 of TS 23.502 [3].
NOTE 3:	The RFSP in Use Validity Time is to allow the UE to stay in EPS for a period of time to avoid the potential ping-pong issue (i.e. 5GS keeps sending the UE to EPS based on authorized RFSP Index from PCF, and the EPS keeps sending the UE back to 5GS immediately based on the subscribed RFSP Index.
NOTE 4:	The RFSP in Use Validity Time applies only to EPS but not to 5GS, therefore in the case of mobility from EPS to 5GS, the RFSP in Use Validity Time if received from MME is ignored by the AMF.
When the UE supports single-registration mode and network supports interworking procedure with the N26 interface:
-	For idle mode mobility from 5GS to EPS, the UE performs either TAU or Attach procedure with EPS GUTI mapped from 5G-GUTI sent as old Native GUTI, as described in clause 4.11.1.3.2.1 of TS 23.502 [3] and indicates that it is moving from 5GC. The UE includes in the RRC message a GUMMEI mapped from the 5G-GUTI and indicates it as a native GUMMEI and should in addition indicate it as "Mapped from 5G-GUTI". The MME retrieves the UE's MM and SM context from 5GC. For connected mode mobility from 5GS to EPS, either inter-system handover or RRC Connection Release with Redirection to E-UTRAN is performed. At inter-system handover, the AMF selects target MME based on 2 octet TAC format used in the Target ID as specified in TS 38.413 [34]. During the TAU or Attach procedure the HSS+UDM cancels any AMF registration associated with the 3GPP access (but not AMF registration associated with the non-3GPP access): an AMF that was serving the UE over both 3GPP and non-3GPP accesses does not consider the UE as deregistered over non 3GPP access.
-	For the first TAU after 5GC initial Registration, the UE and MME for the handling of UE Radio Capabilities follow the procedures as defined in clause 5.11.2 of TS 23.401 [26] for first TAU after GERAN/UTRAN Attach.
NOTE 1:	MMEs supporting interworking with N26 interface are not required to process the indication from the UE that it is moving from 5GC and will assume that the UE is moving from another MME.
-	For idle mode mobility from EPC to 5GC, the UE performs mobility Registration procedure with the 5G GUTI mapped from EPS GUTI and indicates that it is moving from EPC. The UE derives GUAMI from the native 5G-GUTI and includes GUAMI in the RRC message to enable RAN to route to the corresponding AMF (if available). If the UE holds no native 5G-GUTI, then the UE provides in the RRC message a GUAMI mapped from the EPS GUTI and indicates it as "Mapped from EPS". The AMF and SMF retrieve the UE's MM and SM context from EPC. For connected mode mobility from EPC to 5GC, either inter-system handover or RRC Connection Release with Redirection to NG-RAN is performed. At inter-system handover, the MME selects target AMF based on TAC used in the Target ID as specified in TS 38.413 [34]. During the Registration procedure, the HSS+UDM cancels any MME registration.
NOTE 2:	During a transition period, the source eNB may be configured via O&M to know that the MME is not upgraded and thus supports only 2 octet TAC. The Target ID for the NG-RAN node is set as "Target eNB ID" in the existing IEs as defined in TS 38.413 [34].
For both idle mode and connected mode mobility from EPC to 5GC:
-	The UE includes the native 5G-GUTI as an additional GUTI in the Registration request; the AMF uses the native 5G-GUTI to retrieve MM context identified by the 5G-GUTI from old AMF or from UDSF (if UDSF is deployed and the old AMF is within the same AMF set).
-	If this is the first mobility event for a PDU Session that was established while being connected to EPC, the UE shall trigger the PDU Session Modification procedure and:
-	should indicate the support of Reflective QoS to the network (i.e. SMF) if the UE supports Reflective QoS functionality. If the UE indicated support of Reflective QoS, the network may provide a Reflective QoS Timer (RQ Timer) value to the UE;
-	shall indicate the number of supported packet filters for signalled QoS rules, if the UE supports more than 16 packet filters for the PDU Session. The network shall store this information so that subsequent mobility events do not require another signalling of it.
-	should indicate the support of Multi-homed IPv6 PDU session to the network (i.e. SMF) if the UE supports Multi-homed IPv6 PDU session. If the UE indicated support of Multi-homed IPv6 PDU session, the network shall consider that this PDU session is supported to use multiple IPv6 prefixes.
-	should provide the UE Integrity Protection Maximum Data Rate to the network (i.e. SMF). The network shall consider that the maximum data rate per UE for user-plane integrity protection supported by the UE is valid for the lifetime of the PDU session.
For interworking without the N26 interface, IP address preservation is provided to the UEs on inter-system mobility by storing and fetching SMF+PGW-C and corresponding APN/DNN information via the HSS+UDM. In such networks AMF also provides an indication that interworking without N26 is supported to UEs during Initial Registration in 5GC or MME may optionally provide an indication that interworking without N26 is supported in the Attach procedure in EPC as defined in TS 23.502 [3] and TS 23.401 [26]. The UE provides an indication that it supports Request Type flag "handover" for PDN connectivity request during the attach procedure as described in clause 5.3.2.1 of TS 23.401 [26] and during initial Registration and Mobility Registration Update in 5GC.
NOTE 1:	The UE support of Request Type flag "handover" for PDN connectivity request during the attach procedure is needed for IP address preservation in the case of interworking without N26.
The indication that interworking without N26 is valid for the entire Registered PLMN and for PLMNs equivalent to the Registered PLMN that are available in the Registration Area. The same indication is provided to all UEs served by the same PLMN. UEs that operate in interworking without N26 may use this indication to decide whether to register early in the target system. UEs that only support single registration mode may use this indication as described in clause 5.17.2.3.2. UE that support dual registration mode uses this indication as described in clause 5.17.2.3.3.
Interworking procedures without N26 interface use the following two features:
1.	When UE performs Initial Attach in EPC (with or without "Handover" indication in PDN CONNECTIVITY Request message) and indicates that it is moving from 5GC, the MME indicates to the HSS+UDM not to cancel the registration of AMF, if any.
2.	When UE performs Initial Registration in 5GC and indicates that it is moving from EPC, the AMF indicates to the HSS+UDM not to cancel the registration of MME, if any.
To support mobility both for single and dual registration mode UEs, the following also are supported by the network:
3.	When PDU Session are created in 5GC, the SMF+PGW-C which supports EPS interworking stores the SMF+PGW-C FQDN along with DNN in the HSS+UDM.
4.	The HSS+UDM provides the information about dynamically allocated SMF+PGW-C and APN/DNN information to the target CN network. If there are multiple SMF+PGW-C serving the UE for the same DNN which support EPS interworking in 5GS, the HSS+UDM select one of them according to operator's policy and provides together with the associated APN to the MME.
5.	When PDN connections are created in EPC, the MME stores the SMF+PGW-C and APN information in the HSS+UDM.
NOTE 2:	Items 3, 4 and 5 are also supported in networks that support interworking with N26 procedures. This enables a VPLMN that does not deploy N26 interface to provide IP address preservation to roamed-in single-registration mode UEs from a HPLMN that only supports interworking with N26 procedures.
When the network serving the UE supports 5GS-EPS interworking procedures without N26 interface, the SMF shall not provide the UEs with mapped target system parameters of the target system when UE is in the source network.
A UE that operates in dual registration mode ignores any received mapped target system parameters (e.g. QoS parameters, bearer IDs/QFI, PDU Session ID, etc.).
When the UE supports single-registration mode and network supports interworking procedure without N26 interface:
-	For mobility from 5GC to EPC, the UE with at least one PDU Session established in 5GC may either:
-	if supported and if it has received the network indication that interworking without N26 is supported, perform Attach in EPC with a native EPS GUTI, if available, otherwise with IMSI with Request type "Handover" in PDN CONNECTIVITY Request message (clause 5.3.2.1 of TS 23.401 [26]) and indicating that the UE is moving from 5GC and subsequently moves all its other PDU Session using the UE requested PDN connectivity establishment procedure with Request Type "handover" flag (clause 5.10.2 of TS 23.401 [26]), or.
-	perform TAU with 4G-GUTI mapped from 5G-GUTI sent as old Native GUTI (clause 5.3.3 of TS 23.401 [26]) indicating that it is moving from 5GC, in which case the MME instructs the UE to re-attach. IP address preservation is not provided in this case.
-	for the first TAU after 5GC initial Registration, the UE and MME for the handling of UE Radio Capabilities follow the procedures as defined in clause 5.11.2 TS 23.401 [26] for first TAU after GERAN/UTRAN Attach.
NOTE 1:	The first PDN connection may be established during the E-UTRAN Initial Attach procedure (see TS 23.401 [26]).
NOTE 2:	At inter-PLMN mobility to a PLMN that is not an equivalent PLMN the UE always uses the TAU procedure.
-	For mobility from 5GC to EPC, the UE with no PDU Session established in 5GC
-	performs Attach in EPC (clause 5.3.2.1 of TS 23.401 [26]) indicating that the UE is moving from 5GC.
-	For mobility from EPC to 5GC, the UE performs Mobility Registration Update in 5GC with 5G-GUTI mapped from EPS GUTI and a native 5G-GUTI, if available, as Additional GUTI and indicating that the UE is moving from EPC. In this case, the AMF determines that old node is an MME, but proceeds as if the Registration is of type "initial registration". The UE may either:
-	if supported and if it has received the network indication "interworking without N26 supported", move all its PDN connections from EPC using the UE initiated PDU Session Establishment procedure with "Existing PDU Sessions" flag (clause 4.3.2.2.1 of TS 23.502 [3]), or
-	re-establish PDU Sessions corresponding to the PDN connections that it had in EPS. IP address preservation is not provided in this case.
NOTE 3:	The additional native 5G-GUTI enables the AMF to find the UE's 5G security context (if available).
NOTE 4:	When single-registration mode UE uses interworking procedures without N26, the registration states during the transition period (e.g. while UE is transferring all PDU Sessions / PDN Connections on the target side) are defined in Stage 3 specifications.
-	If the network determines that the UE is changing RAT type, if the UE requests to relocate the PDU session from EPC to 5GC or 5GC to EPC, the SMF/MME uses the "PDU session continuity at inter RAT mobility" or "PDN continuity at inter-RAT mobility" information, respectively, in the subscription to determine whether to maintain the PDU session/PDN connection (if being handed over) or reject the PDU session request, with the relevant cause.
-	If the UE requested to move the PDU session and the "PDN continuity at inter RAT mobility" information indicated "disconnect the PDN connection with a reactivation request" the network should provide a suitable cause code to the UE so that it can request a new PDU session.
To support mobility in dual-registration mode, the support of N26 interface between AMF in 5GC and MME in EPC is not required. A UE that supports dual registration mode may operate in this mode when it receives an indication from the network that interworking without N26 is supported.
For UE operating in dual-registration mode the following principles apply for PDU Session transfer from 5GC to EPC:
-	UE operating in Dual Registration mode may register in EPC ahead of any PDU Session transfer using the Attach procedure indicating that the UE is moving from 5GC without establishing a PDN Connection in EPC if the EPC supports EPS Attach without PDN Connectivity as defined in TS 23.401 [26]. Support for EPS Attach without PDN Connectivity is mandatory for UE supporting dual-registration procedures.
NOTE 1:	Before attempting early registration in EPC the UE needs to check whether EPC supports EPS Attach without PDN Connectivity by reading the related SIB in the target cell.
-	UE performs PDU Session transfer from 5GC to EPC using the UE initiated PDN connection establishment procedure with "handover" indication in the PDN Connection Request message (clause 5.10.2 of TS 23.401 [26]).
-	If the UE has not registered with EPC ahead of the PDU Session transfer, the UE can perform Attach in EPC with "handover" indication in the PDN Connection Request message (clause 5.3.2.1 of TS 23.401 [26]).
-	UE may selectively transfer certain PDU Sessions to EPC, while keeping other PDU Sessions in 5GC.
-	UE may maintain the registration up to date in both 5GC and EPC by re-registering periodically in both systems. If the registration in either 5GC or EPC times out (e.g. upon mobile reachable timer expiry), the corresponding network starts an implicit detach timer.
NOTE 2:	Whether UE transfers some or all PDU Sessions on the EPC side and whether it maintains the registration up to date in both EPC and 5GC can depend on UE capabilities that are implementation dependent. The information for determining which PDU Sessions are transferred on EPC side and the triggers can be pre-configured in the UE and are not specified in this Release of the specification. The UE does not know before-hand, i.e. before trying to move a given PDU session to EPC, whether that PDU session can be transferred to EPC.
For UE operating in dual-registration mode the following principles apply for PDN connection transfer from EPC to 5GC:
-	UE operating in Dual Registration mode may register in 5GC ahead of any PDN connection transfer using the Registration procedure indicating that the UE is moving from EPC (clause 4.2.2.2.2 of TS 23.502 [3]).
-	UE performs PDN connection transfer from EPC to 5GC using the UE initiated PDU Session Establishment procedure with "Existing PDU Session" indication (clause 4.3.2.2.1 of TS 23.502 [3]).
-	UE may selectively transfer certain PDN connections to 5GC, while keeping other PDN Connections in EPC.
-	UE may maintain the registration up to date in both EPC and 5GC by re-registering periodically in both systems. If the registration in either EPC or 5GC times out (e.g. upon mobile reachable timer expiry), the corresponding network starts an implicit detach timer.
NOTE 3:	Whether UE transfers some or all PDN connections on the 5GC side and whether it maintains the registration up to date in both 5GC and EPC can depend on UE capabilities that are implementation dependent. The information for determining which PDN connections are transferred on 5GC side and the triggers can be pre-configured in the UE and are not specified in this Release of the specification. The UE does not know before-hand, i.e. before trying to move a given PDN connection to 5GC, whether that PDN connection can be transferred to 5GC.
NOTE 4:	If EPC does not support EPS Attach without PDN Connectivity the MME detaches the UE when the last PDN connection is released by the PGW as described in clause 5.4.4.1 of TS 23.401 [26] (in relation to transfer of the last PDN connection to non-3GPP access).
When sending a control plane request for MT services (e.g. MT SMS) the network routes it via either the EPC or the 5GC. In absence of UE response, the network should attempt routing the control plane request via the other system.
NOTE 5:	The choice of the system through which the network attempts to deliver the control plane request first is left to network configuration.
When the UE supports single-registration mode or dual-registration mode without N26 interface:
-	If the UE is in CM-CONNECTED state in 5GC, the NG-RAN may perform RRC Connection Release with Redirection to E-UTRAN based on certain criteria (e.g. based on local configuration in NG-RAN, or triggered by the AMF upon receiving Handover Request message from NG-RAN).
-	If the UE is in ECM-CONNECTED state in EPC, the E-UTRAN may perform RRC Connection release with redirection to NG-RAN based on certain criteria (e.g. based on local configuration in E-UTRAN, or triggered by the MME upon receiving handover request from E-UTRAN).
IP address preservation upon direct mobility between 5GS and GERAN/UTRAN is not supported.
Upon mobility from 5GS to GERAN/UTRAN (e.g. upon leaving NG-RAN coverage) the UE shall perform the A/Gb mode GPRS Attach procedure or Iu mode GPRS Attach procedure (see TS 23.060 [56]).
As a UE option, to support IP address preservation at mobility from EPC to 5GS for PDN connections without 5GS related parameters, a 5GS capable UE may:
-	Following mobility from GERAN/UTRAN to EPS, release those PDN connection(s) and re-establish them as specified in clause 4.11.1.5.4.1 of TS 23.502 [3] so that they support interworking to 5GS.
NOTE 1:	It is recommended that a UE using this option does not do this behaviour after every change to EPS in PLMNs that do not support 5GS, nor for APNs that do not support mobility to 5GS; and, that such a UE supports storage of the 5GS related parameters while in GERAN/UTRAN. Whether and how the UE is aware of which PLMNs support 5GS and which APNs do not support mobility to 5GS is out of scope of this specification.
To support mobility from EPC to 5GS to EPC to GERAN/UTRAN for PDN connections established in EPC:
NOTE 2:	For the use of N7 or N40 interfaces while the UE is in GERAN/UTRAN access, the SMF+PGW-C selected by the MME (using the existing selection procedures described in clause 4.11.0a of TS 23.502 [3] and clause 4.3.8 of TS 23.401 [26]) needs to support functionality (e.g. signalling of GERAN/UTRAN cell identification over N7) specified in Annex L.
-	in signalling sent on the N26 interface, the MME should send the TI and BSS Container in the EPS Bearer Context (see Table 7.3.1-3 of TS 29.274 [101]), if there is any, of the EPS bearer to the SMF (V-SMF / I-SMF) via the AMF in the Bearer Context within the PDN Connection IE in the Forward Relocation Request and Context Response messages (TS 29.274 [101]); the SMF (V-SMF / I-SMF) should store the TI and BSS Container and the SMF (V-SMF / I-SMF) should provide the TI and BSS Container to the AMF (as part of a procedure to deliver SM context to AMF) so that the AMF sends the TI and BSS Container of the related EPS bearer in the Bearer Context within the EPS PDN Connection information in any subsequent Forward Relocation Request and Context Response message sent to an MME.
NOTE 3:	At mobility from EPC, the SMF+PGW-C / V-SMF / I-SMF receives the TI and BSS Container as part of the UE EPS PDN Connection information from the AMF and stores the TI. At mobility to EPC, the SMF+PGW-C / V-SMF / I-SMF provides the AMF with the TI and BSS Container as part of the UE EPS PDN Connection information. The SMF+PGW-C / V-SMF / I-SMF is not meant to understand the TI/BSS Container nor to use it for any other purpose than providing it back to AMF.
NOTE 4:	GERAN/UTRAN Mobility Management Bearer Synchronisation procedures will release any dedicated QoS Flows established in 5GS.
NOTE 5:	When the UE access the network via GERAN/UTRAN over Gn/Gp interface, Secondary PDP Context Activation Procedure is not supported.
IP address preservation at mobility from EPC to GERAN/UTRAN for PDU sessions established in 5GS is not supported.
With regard to interworking between 5GS and the Circuit Switched domain when the GERAN or UTRAN network is operating in NMO II (i.e. no Gs interface between MSC and SGSN):
-	upon mobility from 5GS to GERAN/UTRAN, the UE shall either:
-	act as if it is returning after a loss of GERAN/UTRAN coverage (and e.g. only perform a periodic LAU if the periodic LAU timer has expired), or,
-	perform a Location Update to the MSC. If the UE is registered for IMS voice and is configured, using Device Management or initial provisioning, to perform additional mobility management procedures when it has moved from a RAT that supports IMS voice over PS sessions to one that does not (see TS 23.060 [56]), it shall follow this option.
Upon mobility from GERAN/UTRAN to 5GS (e.g. upon selecting an NG-RAN cell) the UE shall perform the Registration procedure of "initial registration" type as described in TS 23.502 [3]. The UE shall indicate a 5G-GUTI as UE identity in the Registration procedure if it has a stored valid native 5G-GUTI (e.g. from an earlier registration in the 5G System). Otherwise the UE shall indicate a SUCI.
If a UE in MICO mode moves to GERAN/UTRAN and any of the triggers defined in clause 5.4.1.3 occur, then the UE shall locally disable MICO mode and perform the A/Gb mode GPRS Attach procedure or Iu mode GPRS Attach procedure (see TS 23.060 [56]). The UE can renegotiate MICO when it returns to 5GS during (re-)registration procedure.
In Single Registration mode, expiry of the periodic RAU timer, or, the periodic LAU timer shall not cause the UE to change RAT.
The 5G SRVCC from NG-RAN to UTRAN is specified in the TS 23.216 [88]. After the 5G SRVCC to UTRAN, all the PDU sessions of the UE are released.
Secondary authentication/authorization by a DN-AAA server during the establishment of a PDN connection over 3GPP access to EPC, is supported based on following principles:
-	It is optional for the UE to support EAP-based secondary authentication and authorization by DN-AAA over EPC,
-	A SMF+PGW-C shall be used to serve DNN(s) requiring secondary authentication/authorization by a DN-AAA server,
-	For secondary authentication/authorization by a DN-AAA server, the SMF+PGW-C runs the same procedures with PCF, UDM and DN-AAA and uses the same corresponding interfaces regardless of whether the UE is served by EPS or 5GS,
-	The interface towards the UE is different (usage of NAS for EPS instead of NAS for 5GS) between the EPS and 5GS cases.
This is further specified in Annex H of TS 23.502 [3].
In this Release, EAP based Secondary authentication by a DN-AAA server during the establishment of a PDN connection over non-3GPP access to EPC is not supported.
When a UE is simultaneously connected to the 5GC over a 3GPP access and a non-3GPP access, it may have PDU Sessions associated with 3GPP access and PDU Sessions associated with non-3GPP access. When inter-system handover from 5GS to EPS is performed for PDU Sessions associated with 3GPP access, the PDU Sessions associated with non-3GPP access are kept anchored by the network in 5GC and the UE may either:
-	keep PDU Sessions associated with non-3GPP access in 5GS (5GC+N3IWF or TNGF) (i.e. the UE is then registered both in EPS and, for non-3GPP access, in 5GS); or
-	locally or explicitly release PDU Sessions associated with non-3GPP access; or
-	once in EPS, transfer PDU Sessions associated with non-3GPP access to E-UTRAN by triggering PDN connection establishment with Request Type "Handover", as specified in TS 23.401 [26].
The detailed description for supporting network sharing and interworking between EPS and 5GS is described in clauses 4.11.1.2.1, 4.11.1.2.2, 4.11.1.3.2 and 4.11.1.3.3 of TS 23.502 [3].
Clause 4.3.5 shows the Service Exposure Network Architecture in scenarios where for EPC-5GC Interworking is required.
In scenarios where interworking between 5GS and EPC is possible, the network configuration is expected to associate UEs with SCEF+NEF node(s) for Service Capability Exposure. The SCEF+NEF hides the underlying 3GPP network topology from the AF (e.g. SCS/AS) and hides whether the UE is served by 5GC or EPC.
If the service exposure function that is associated with a given service for a UE is configured in the UE's subscription information, then an SCEF+NEF identity shall be used to identify the exposure function. For example, if a UE is capable of switching between EPC and 5GC, then the SCEF ID that is associated with any of the UE's APN configurations should point to an SCEF+NEF node.
For external exposure of services related to specific UE(s), the SCEF+NEF resides in the HPLMN. Depending on operator agreements, the SCEF+NEF in the HPLMN may have interface(s) with NF(s) in the VPLMN.
The SCEF+NEF exposes over N33 the same API as the SCEF supports over T8. If CAPIF is not supported, the AF is locally configured with the API termination points for each service. If CAPIF is supported, the AF obtains the service API information from the CAPIF core function via the Availability of service APIs event notification or Service Discover Response as specified in TS 23.222 [64].
The common state information shall be maintained by the combined SCEF+NEF node in order to meet the external interface requirements of the combined node. The common state information includes at least the following data that needs to be common for the SCEF and NEF roles of SCEF+NEF:
-	SCEF+NEF ID (must be the same towards the AF).
-	SCEF+NEF common IP address and port number.
-	Monitoring state for any ongoing monitoring request.
-	Configured set of APIs supported by SCEF+ NEF.
-	PDN Connection/PDU Session State and NIDD Configuration Information, including Reliable Data Service state information.
-	Network Parameter Configuration Information (e.g. Maximum Response Time and Maximum Latency).
The SCEF+NEF need not perform the same procedures for the configuration of monitoring events towards the HSS+UDM twice. For example, if the HSS+UDM is deployed as a combined node, a monitoring event only need to be configured by the SCEF+NEF just once.
The SCEF+NEF may configure monitoring events applicable to both EPC and 5GC using only 5GC procedures towards UDM. In this case, the SCEF+NEF shall indicate that the monitoring event is also applicable to EPC (i.e. the event must be reported both by 5GC and EPC) and may include a SCEF address (i.e. if the event needs to be configured in a serving node in the EPC and the corresponding notification needs to be sent directly to the SCEF). If the HSS and UDM are deployed as separate network entities, UDM shall use HSS services to configure the monitoring event in EPC as defined in TS 23.632 [102]. The UDM shall return an indication to SCEF+NEF of whether the configuration of the monitoring event in EPC was successful. In the case that the UDM reports that the configuration of a monitoring event was not possible in EPC, then the SCEF+NEF may configure the monitoring event using EPC procedures via the HSS as defined in TS 23.682 [36].
NOTE 1:	The SCEF+NEF uses only 5GC procedures to configure monitoring events in EPC and 5GC.
NOTE 2:	In terms of the CAPIF, the SCEF+NEF is considered a single node.
In addition to the interworking principles documented in clause 5.17.2.2, the following applies for interworking with N26:
-	When UE moves from EPS to 5GS, when the AMF registers in UDM, if no event subscription via UDM is available, the AMF indicates the situation to the UDM, and in this case the UDM can decide if the event subscriptions should be provisioned, otherwise if the AMF has event subscription information, after the registration procedure is completed, the AMF may inform the UDM of the currently subscribed events, and UDM will do synchronization if needed.
-	When UE moves from 5GS to EPS, the MME gets monitoring event configuration from HSS during as part of mobility procedure as specified in clause 4.11.1.3.2 of TS 23.502 [3].
In addition to the interworking principles documented in clause 5.17.2.3, the additional behaviour at EPS to 5GS mobility in clause 5.17.5.2.1 also applies.
When SCEF+NEF performs the procedure of monitoring via the AMF as described in clause 4.15.3.2.4 ("Exposure with bulk subscription") in TS 23.502 [3], if the AMF determines the interworking without N26 interface is supported, during mobility from 5GS to EPS, the AMF shall subscribe on behalf of SCEF+NEF for UDM+HSS notification of MME ID as described in clause 7.1.2 to trigger the SCEF+NEF to configure the monitoring request to the new MME. For single-registration mode, when UE's mobility from 5GS to EPS happens and Serving MME sends Update Location Request to the UDM+HSS, the UDM+HSS provides Serving MME ID to the SCEF+NEF which is the notification endpoint based on the subscription request from AMF. Then the SCEF+NEF performs the procedure of configuring monitoring via the MME for the same Monitoring Events as described in clause 5.6.2.1 of TS 23.682 [36].
When SCEF+NEF performs the procedure of monitoring via the UDM+HSS as described in clause 4.15.3.2.2 of TS 23.502 [3], when UE's mobility between 5GS and EPS happens, the UDM+HSS performs the procedure of configuring monitoring at the MME as described in clause 5.6.1.1 of TS 23.682 [36] and at the AMF as described in clause 4.15.3.2.1 of TS 23.502 [3].
A service related with common north-bound API may become unavailable due to UE being served by a CN node not supporting the service. If the availability or expected level of support of a service API associated with a UE changes, for example due to a mobility between 5GC and EPC, the AF shall be made aware of the change.
NOTE 1:	If CAPIF is supported and the service APIs become (un)available for the 5GC or EPC network, the AF obtains such information from the CAPIF core function.
If the SCEF+NEF receives the subscription request from the AF for the availability or expected level of support of a service API, the SCEF+NEF subscribes a CN Type Change event for the UE or Group of UEs to the HSS+UDM. If the HSS+UDM receives the subscription for CN Type Change event, the HSS+UDM includes the latest CN type for the UE or Group of UEs in the response for the subscription. If the HSS+UDM detects that the UE switches between being served by the MME and the AMF, the CN Type Change event is triggered, and the HSS+UDM notifies the latest CN type for the UE or Group of UEs to the SCEF+NEF. Based on the CN type information, the SCEF+NEF can determine the availability or expected level of support of a given service. The AF will be informed of such information via a subscription/notification service operation. The AF can subscribe for the availability or expected level of support of a service API with report type indicating either One-time report or Continuous report. If there is no CN type information for the UE in the SCEF+NEF, the SCEF+NEF subscribes monitoring event for a new CN Type Change event for the UE or Group of UEs to the HSS+UDM, otherwise, SCEF+NEF determines the CN type locally in the following conditions:
-	If the AF subscribes with report type indicating One-time report, the SCEF+NEF may consider the Freshness Timer of the latest CN type information for the UE or Group of UEs. The Freshness Timer is a parameter that is configured based on local SCEF+NEF policy. When a subscription request with One-time report type is received the SCEF+NEF checks if there is the latest CN type information received from the HSS+UDM for the indicated UE ID or External Group ID. If the elapsed time for the CN type information since the last reception is less than the Freshness Timer, then the SCEF+NEF may respond to the AF with the latest CN type information in order to avoid repeated query to HSS+UDM.
-	The SCEF+NEF has established a direct connection with MME or AMF or SMF.
When the UE or all members of a Group of UEs are being served by a MME, EPC is determined as CN type. When the UE or all members of a Group of UEs are being served by an AMF, 5GC is determined as CN type. When the UE is registered both in EPC and 5GC, or some members of a Group of UEs are registered in EPC while some members are registered in 5GC, 5GC+EPC is determined as CN type.
NOTE 2:	If 5GC+EPC is determined as the CN type serving the UE or the group of UEs, the SCEF+NEF determines that service APIs for both 5GC and EPC are available to the UE or the group of UEs.

The purpose of the Configuration Transfer between NG-RAN and E-UTRAN is to enable the transfer the RAN configuration information between the gNB and eNodeB via MME and AMF.
In order to make the information transparent for the MME and AMF, the information is included in a transparent container. The source and target RAN node addresses, which allows the Core Network nodes to route the messages. The mechanism depicted in Figure 5.17.7.1-1.

Figure 5.17.7.1-1: Configuration Transfer between gNB and E-UTRAN basic network architecture
The NG-RAN transparent containers are transferred from the source NG-RAN node to the destination E-UTRAN node and vice versa by use of Configuration Transfer messages.
An ENB Configuration Transfer message is used from the E-UTRAN node to the MME over S1 interface as described in TS 36.413 [100], the destination RAN node includes the en-gNB Identifier and may include a TAI associated with the en-gNB. If MME is aware that the en-gNB serves cells which provide access to 5GC, the MME relays the request towards a suitable AMF via inter-system signalling based on a broadcast 5G TAC. An AMF Configuration Transfer message is used from the AMF to the NG-RAN over N2 interface.
A Configuration Transfer message is used by the gNB node to the AMF over N2 interface for the reply, and a Configuration Transfer Tunnel message is used to tunnel the transparent container from AMF to MME over the N26 interface. MME relays this reply to the target eNB using a MME CONFIGURATION TRANSFER message. Transport of the RAN containers in E-UTRAN is specified in TS 23.401 [26].
Each Configuration Transfer message carrying the transparent container is routed and relayed independently by the core network node(s). Any relation between messages is transparent for the AMF and MME, i.e. a request/response exchange between applications, for example SON applications, is routed and relayed as two independent messages by the AMF and MME.
All the Configuration Transfer messages contain the addresses of the source and destination RAN nodes.
An gNB node is addressed by the Target NG-RAN node identifier as described in TS 38.413 [34].
An eNodeB is addressed by the Target eNodeB identifier as described in TS 36.413 [100].
The source RAN node sends a message to its core network node including the source and destination addresses.
MME uses the destination address to route the message to the correct AMF via N26 interface. AMF uses the destination address to route the message to the correct MME via N26 interface.
The AMF connected to the destination RAN node decides which RAN node to send the message to, based on the destination address.
The MME connected to the destination RAN node decides which RAN node to send the message to, based on the destination address.
The AMF performs relaying between N2 and N26 messages as described in TS 38.413 [34] and TS 29.274 [101].
The MME performs relaying between S1 and N26 message as described in TS 36.413 [100] and TS 29.274 [101].
When the UE first registers in 5GS, the UE includes the Indication of URSP Provisioning Support in EPS in the UE Policy Container carried in Registration Request. Only when receiving this indication in the UE Policy Container, the PCF will provision the URSP to UE in EPS.
During Initial Attach with default PDN connection establishment procedure in EPS, the UE provides the Indication of URSP Provisioning Support in EPS PCO in the PDN connectivity request to SMF+PGW-C. If the SMF+PGW-C supports URSP provisioning in EPS, it provides the Indication of URSP Provisioning Support in EPS PCO to UE in the PDN Connectivity Accept message.
NOTE 1:	The ePCO capability negotiation between UE and network is done during Attach procedure as defined in TS 24.301 [13].
When the UE receives the URSP Provisioning Support in EPS PCO and ePCO support indication from EPC, then the UE initiates the UE requested bearer resource modification procedure and includes the UE Policy Container ePCO in the Request Bearer Resource Modification message, the UE Policy Container ePCO will be further forwarded by MME to SMF+PGW-C. When the UE Policy Container ePCO is received by SMF+PGW-C, it forwards transparently the UE Policy Container to PCF for the PDU Session, then the PCF for the PDU Session establishes the UE Policy Association with PCF for the UE. The PCF for the UE generates the corresponding URSP rules in a similar way as it is done in 5GS and sends the URSP rules to UE in the UE Policy Container as described in clause 4.11.0a.5 of TS 23.502 [3].
If the UE does not receive the URSP Provisioning Support in EPS PCO and ePCO support indication from EPC, then the UE does not initiate the UE requested bearer resource modification procedure to send the UE Policy Container ePCO to EPC.
The PDN Connection used by UE and SMF/PGW-C to convey UE Policy Container ePCO shall be kept when the UE is in the CONNECTED mode. When the UE is attached to EPS, the PCF for the PDU Session retrieves the PCRTs for UE Policy from PCF for the UE and subscribes to the applicable PCRTs to SMF+PGW-C. The PCF for the PDU Session sends the UE Policy Container in the same PDN connection/PDU session in which the UE Policy Container was received.
During EPS to 5GS mobility with N26, the UE Policy Association is terminated by PCF for PDU Session when it receives the indication of RAT type change from the SMF+PGW-C.
During 5GS to EPS mobility with N26, the PCF for the PDU Session determines whether the UE supports URSP delivery in EPS by checking UE context policy control subscription information in UDR. The PCF for the PDU Session discovers the address of PCF for the UE serving the UE by querying BSF. The PCF for the UE recovers the information about the PSI list in the UE and the subscribed PCRTs in 5GS from former UE Policy Association for the UE after receiving the UE Policy Association Establishment request including a UE Policy Container only including an indication about the trigger for the UE Policy Association Establishment ("5GS to EPS mobility").
NOTE 2:	At 5GS to EPS mobility with N26, the guard timer in the AMF (as specified in clauses 4.11.1.2.1 and 4.11.1.3.2 of TS 23.502 [3]) ensures that the UE Policy Association remains until the PCF for the UE detects that a UE Policy Association establishment is received from a PCF for the PDU Session indicating 5GS to EPS mobility.
NOTE 3:	In the case that the UE is still registered and reachable over non-3GPP access, the PCF for UE can have two UE policy associations for one UE, and based on local configuration the PCF can decide to use one of the UE policy associations to update URSP rule to the UE. The UE can receive URSP Rules over any of these two accesses.
A network sharing architecture shall allow multiple participating operators to share resources of a single shared network according to agreed allocation schemes. The shared network includes a radio access network. The shared resources include radio resources.
The shared network operator allocates shared resources to the participating operators based on their planned and current needs and according to service level agreements.
In this Release of the specification, only the 5G Multi-Operator Core Network (5G MOCN) network sharing architecture, in which only the RAN is shared in 5G System, is supported. 5G MOCN for 5G System, including UE, RAN and AMF, shall support operators' ability to use more than one PLMN ID (i.e. with same or different country code (MCC) some of which is specified in TS 23.122 [17] and different network codes (MNC)) or combinations of PLMN ID and NID. 5G MOCN supports NG-RAN Sharing with or without multiple Cell Identity broadcast as described in TS 38.300 [27].
5G MOCN also supports the following sharing scenarios involving non-public networks, i.e.NG-RAN can be shared by any combination of PLMNs, PNI-NPNs (with CAG), and SNPNs (each identified by PLMN ID and NID).
NOTE 1:	PNI-NPNs (without CAG) are not explicitly listed above as it does not require additional NG-RAN sharing functionality compared to sharing by one or multiple PLMNs.
In all non-public network sharing scenarios, each Cell Identity as specified in TS 38.331 [28] is associated with one of the following configuration options:
-	one or multiple SNPNs;
-	one or multiple PNI-NPNs (with CAG); or
-	one or multiple PLMNs only.
NOTE 2:	This allows the assignment of multiple cell identities to a cell and also allows the cell identities to be independently assigned, i.e. without need for coordination, by the network sharing partners, between PLMNs and/or non-public networks.
NOTE 3:	Different PLMN IDs (or combinations of PLMN ID and NID) can also point to the same 5GC. When same 5GC supports multiple SNPNs (identified by PLMN ID and NID), it is up to the operator's policy whether they are used as equivalent SNPNs for a UE.
NOTE 4:	There is no standardized mechanism to avoid paging collisions if the same 5G-S-TMSI is allocated to different UEs by different PLMNs or SNPNs of the shared network, as the risk of paging collision is assumed to be very low. If such risk is to be eliminated then PLMNs and SNPNs of the shared network needs to coordinate the value space of the 5G-S-TMSI to differentiate the PLMNs and SNPNs of the shared network.

Figure 5.18.1-1: A 5G Multi-Operator Core Network (5G MOCN) in which multiple CNs are 
connected to the same NG-RAN
If a shared NG-RAN is configured to indicate available networks (PLMNs and/or SNPNs) for selection by UEs, each cell in the shared radio access network shall in the broadcast system information include available core network operators in the shared network.
The Broadcast System Information broadcasts a set of PLMN IDs and/or PLMN IDs and NIDs and one or more additional set of parameters per PLMN e.g. cell-ID, Tracking Areas, CAG Identifiers. All 5G System capable UEs that connect to NG-RAN support reception of multiple PLMN IDs and per PLMN specific parameters. All SNPN-enabled UEs support reception of multiple combinations of PLMN ID and NID and SNPN-specific parameters.
The available core network operators (PLMNs and/or SNPNs) shall be the same for all cells of a Tracking Area in a shared NG-RAN network.
UEs not set to operate in SNPN access mode decode the broadcast system information and take the information concerning available PLMN IDs into account in PLMN and cell (re-)selection procedures. UEs set to operate in SNPN access mode decode the broadcast system information and take the information concerning available PLMN IDs and NIDs into account in network and cell (re-)selection procedures. Broadcast system information is specified in TS 38.331 [28] for NR, TS 36.331 [51] for E-UTRA and related UE access stratum idle mode procedures in TS 38.304 [50] for NR and TS 36.304 [52] for E-UTRA.
5.18.2a	PLMN list and SNPN list handling for network sharing
The AMF prepares lists of PLMN IDs or SNPN IDs suitable as target PLMNs or target SNPNs for use at idle mode cell (re)selection and for use at handover and RRC Connection Release with redirection. The AMF:
-	provides the UE with the list of PLMNs or list of SNPNs that the UE shall consider as Equivalent to the serving PLMN or the serving SNPN (see TS 23.122 [17]); and
-	provides the NG-RAN with a prioritised list of permitted PLMNs or a prioritized list of permitted SNPNs. When prioritising these PLMNs or SNPNs, the AMF may consider the following information: HPLMN of the UE or the subscribed SNPN of the UE, the serving PLMN or the serving SNPN, a preferred target PLMN (e.g. based on last used EPS PLMN) or a preferred target SNPN, or the policies of the operator(s).
For a UE registered in an SNPN, the AMF shall not provide a list of equivalent PLMNs to the UE and shall not provide a list of permitted PLMNs to NG-RAN.
For a UE registered in a PLMN, the AMF shall not provide a list of equivalent SNPNs to the UE and shall not provide a list of permitted SNPNs to NG-RAN.
NOTE:	This clause applies to UEs not operating in SNPN access mode. Network selection for UEs set to operate in SNPN access mode is described in clause 5.30.2.4.
A UE that has a subscription to one of the sharing core network operators shall be able to select this core network operator while within the coverage area of the shared network and to receive subscribed services from that core network operator.
Each cell in shared NG-RAN shall in the broadcast system information include the PLMN-IDs concerning available core network operators in the shared network.
When a UE performs an Initial Registration to a network, one of available PLMNs shall be selected to serve the UE. UE uses all the received broadcast PLMN-IDs in its PLMN (re)selection processes which is specified in TS 23.122 [17]. UE shall inform the NG-RAN of the selected PLMN so that the NG-RAN can route correctly. The NG-RAN shall inform the core network of the selected PLMN.
As per any network, after Initial Registration to the shared network and while remaining served by the shared network, the network selection procedures specified in TS 23.122 [17] may cause the UE to perform a reselection of another available PLMN.
UE uses all of the received broadcast PLMN-IDs in its cell and PLMN (re)selection processes.
The NG-RAN uses the selected PLMN/SNPN (provided by the UE at RRC establishment, or, provided by the AMF/source NG-RAN at N2/Xn handover) to select target cells for future handovers (and radio resources in general) appropriately. The network should not move the UE to another available PLMN/SNPN, e.g. by handover, as long as the selected PLMN/SNPN is available to serve the UE's location.
In the case of handover or network controlled release to a PLMN in a shared network:
-	When multiple PLMN IDs are broadcasted in a cell selected by NG-RAN, NG-RAN shall select a target PLMN, taking into account the prioritized list of PLMN IDs provided via Mobility Restriction List from AMF.
-	For Xn based HO procedure, Source NG-RAN indicates the selected PLMN ID to the target NG-RAN, see TS 38.300 [27].
-	For N2 based HO procedure, the NG-RAN indicates a selected PLMN ID to the AMF as part of the TAI sent in the HO required message. Source AMF uses the TAI information supplied by the source NG-RAN to select the target AMF/MME. The source AMF should forward the selected PLMN ID to the target AMF/MME. The target AMF/MME indicates the selected PLMN ID to the target NG-RAN/eNB so that the target NG-RAN/eNB can select target cells for future handover appropriately.
-	For RRC connection release with redirection to E-UTRAN procedure, NG-RAN decides the target network by using PLMN information as defined in the first bullet.
A change in serving PLMN is indicated to the UE as part of the UE registration with the selected network via 5G-GUTI in 5GS.
In the case of handover or network controlled release to an SNPN in a shared network, the following applies:
-	When multiple SNPN IDs are broadcasted in a cell selected by NG-RAN, NG-RAN shall select a target SNPN, taking into account the prioritized list of SNPN IDs provided via Mobility Restriction List from AMF.
-	For Xn based HO procedure, Source NG-RAN indicates the selected SNPN ID to the target NG-RAN, see TS 38.300 [27].
-	For N2 based HO procedure, the NG-RAN indicates a selected SNPN ID to the AMF together with the TAI sent in the HO required message. Source AMF uses the selected SNPN ID together with the TAI information supplied by the source NG-RAN to select the target AMF. The source AMF should forward the selected SNPN ID to the target AMF. The target AMF indicates the selected SNPN ID to the target NG-RAN so that the target NG-RAN can select target cells for future handover appropriately.
A change in serving SNPN is indicated to the UE as part of the UE registration with the selected network.
As defined in clause 5.15.1, a Network Slice is defined within a PLMN or SNPN. Network sharing is performed among different PLMNs and/or SNPNs. In the case of network sharing, each PLMN or SNPN sharing the NG-RAN defines and supports its PLMN- or SNPN- specific set of slices that are supported by the common NG-RAN.
In order to ensure that the network functions within 5G System are operating under nominal capacity for providing connectivity and necessary services to the UE. Thus, it supports various measures to guard itself under various operating conditions (e.g. peak operating hour, extreme situations). It includes support for load (re-)balancing, overload control and NAS level congestion control. A 5GC NF is considered to be in overload when it is operating over its nominal capacity resulting in diminished performance (including impacts to handling of incoming and outgoing traffic).
AMF can support load balancing and re-balancing of TNL associations between 5G-AN and AMF by using mechanisms specified in clause 5.21.1.
The AMF Load Balancing functionality permits UEs that are entering into an AMF Region/AMF Set to be directed to an appropriate AMF in a manner that achieves load balancing between AMFs. This is achieved by setting a Weight Factor for each AMF, such that the probability of the 5G-AN selecting an AMF is proportional to Weight Factor of the AMF. The Weight Factor is typically set according to the capacity of an AMF node relative to other AMF nodes. The Weight Factor is sent from the AMF to the 5G-AN via NGAP messages (see TS 38.413 [34]).
NOTE 1:	An operator may decide to change the Weight Factor after the establishment of NGAP connectivity as a result of changes in the AMF capacities. e.g. a newly installed AMF may be given a very much higher Weight Factor for an initial period of time making it faster to increase its load.
NOTE 2:	It is intended that the Weight Factor is NOT changed frequently. e.g. in a mature network, changes on a monthly basis could be anticipated, e.g. due to the addition of 5G-AN or 5GC nodes.
NOTE 3:	Weight Factors for AMF Load Balancing are associated with AMF Names.
Load balancing by 5G-AN node is only performed between AMFs that belong to the same AMF set, i.e. AMFs with the same PLMN, AMF Region ID and AMF Set ID value.
The 5G-AN node may have their Load Balancing parameters adjusted (e.g. the Weight Factor is set to zero if all subscribers are to be removed from the AMF, which will route new entrants to other AMFs within an AMF Set).
The AMF load re-balancing functionality permits cross-section of its subscribers that are registered on an AMF (within an AMF Set) to be moved to another AMF within the same AMF set with minimal impacts on the network and end users. AMF may request some or all of the 5G-AN node(s) to redirect a cross-section of UE(s) returning from CM-IDLE state to be redirected to another AMF within the same AMF set, if the 5G-AN is configured to support this. The AMF may request some or all of the 5G-AN node(s) to redirect the UEs served by one of its GUAMI(s) to a specific target AMF within the same AMF set or to any different AMF within the same AMF set.
When indicating a specific target AMF, the AMF should ensure that the load re-balancing will not cause overload in the target AMF.
NOTE:	This requirement can be fulfilled by the AMF itself or by the OAM.
For UE(s) in CM-IDLE state, when UE subsequently returns from CM-IDLE state and the 5G-AN receives an initial NAS message with a 5G S-TMSI or GUAMI pointing to an AMF that requested for redirection, the 5G-AN should select the specific target AMF (provided by the original AMF) or a different AMF from the same AMF set and forward the initial NAS message.
For UE(s) in CONNECTED mode, similar mechanisms for AMF Management can be used to move the UE to another AMF in the same AMF set as described in clause 5.21.2, except that the old AMF deregisters itself from NRF.
The newly selected/target AMF (which is now the serving AMF) will re-assign the GUTI (using its own GUAMI(s)) to the UE(s). It is not expected that the 5G-AN node rejects any request or enables access control restriction when it receives a request for redirection for load control from the connected AMF(s).
When the AMF wants to stop redirection, the AMF can indicate that it can serve all UE(s) in CM-IDLE state to stop the redirection.
NOTE 1:	An example use for the AMF load re-balancing functionality is for the AMF to pro-actively re-balance its load prior to reaching overload i.e. to prevent overload situation.
NOTE 2:	Typically, AMF Load Re-Balancing is not needed when the AMF becomes overloaded because the Load Balancing function should have ensured that the other AMFs within the AMF Set are similarly overloaded.
The AMF shall contain mechanisms for avoiding and handling overload situations. This includes the following measures:
-	N2 overload control that could result in RRC reject, RRC Connection Release and unified access barring.
-	NAS congestion control.
Under unusual circumstances, if AMF has reached overload situation, the AMF activates NAS level congestion control as specified in Clause 5.19.7 and AMF restricts the load that the 5G-AN node(s) are generating, if the 5G-AN is configured to support overload control. N2 overload control can be achieved by the AMF invoking the N2 overload procedure (see TS 38.300 [27] and TS 38.413 [34]) to all or to a proportion of the 5G-AN nodes with which the AMF has N2 connections. The AMF may include the S-NSSAI(s) in NGAP OVERLOAD START message sent to 5G-AN node(s) to indicate the Network Slice(s) with which NAS signalling is to be restricted. To reflect the amount of load that the AMF wishes to reduce, the AMF can adjust the proportion of 5G-AN nodes which are sent NGAP OVERLOAD START message, and the content of the overload start procedure.
When NGAP OVERLOAD START is sent by multiple AMFs or from the same AMF set in the same PLMN towards the 5G-AN, it should be ensured that the signalling load is evenly distributed within the PLMN and within each AMF set.
A 5G-AN node supports restricting of 5G-AN signalling connection when a signalling connection establishment are attempted by certain UEs (which are registered or attempting to register with the 5GC), as specified in TS 38.331 [28] and TS 36.331 [51]. Additionally, a 5G-AN node provides support for the barring of UEs as described in TS 22.261 [2]. These mechanisms are further specified in TS 38.331 [28] and TS 36.331 [51]. For 3GPP Access Type, the signalling connection establishment attempt includes a RRC Connection Resume procedure from RRC_INACTIVE.
By sending the NGAP OVERLOAD START message, the AMF can request the 5G-AN node to apply the following behaviour for UEs that the AMF is serving:
a)	Restrict 5G-AN signalling connection requests that are not for emergency, not for exception reporting and not for high priority mobile originated services; or
b)	Restrict 5G-AN signalling connection requests for uplink NAS signalling transmission to that AMF;
c)	Restrict 5G-AN signalling connection requests where the Requested NSSAI at AS layer only includes the indicated S-NSSAI(s) in the NGAP OVERLOAD START message. This applies also to RRC_INACTIVE Connection Resume procedure where the Allowed NSSAI in the stored UE context in the RAN only includes S-NSSAIs included in the NGAP OVERLOAD START.
d)	only permit 5G-AN signalling connection requests for emergency sessions and mobile terminated services for that AMF; or
e)	only permit 5G-AN signalling connection requests for high priority sessions, exception reporting and mobile terminated services for that AMF;
The above applies for RRC Connection Establishment procedure and RRC Connection Resume procedures over 3GPP access, as well as for the UE-N3IWF connection establishment over untrusted Non-3GPP access and for the UE-TNGF connection establishment over trusted Non-3GPP access.
The AMF can provide a value that indicates the percentage of connection requests to be restricted in the NGAP OVERLOAD START, and the 5G-AN node may consider this value for congestion control.
When restricting a 5G-AN signalling connection, the 5G-AN indicates to the UE an appropriate wait timer that limits further 5G-AN signalling connection requests until the wait timer expires.
During an overload situation, the AMF should attempt to maintain support for emergency services and for MPS.
When the AMF is recovering, the AMF can either:
-	send a NGAP OVERLOAD START message with a new percentage value that permits more connection requests to be successful, or
-	send a NGAP OVERLOAD STOP message.
to the same 5G-AN node(s) the NGAP OVERLOAD START was previously sent.
The SMF shall contain mechanisms for avoiding and handling overload situations. This can include the following measures:
-	SMF overload control that could result in rejections of NAS requests.
The SMF overload control may be activated by SMF due to congestion situation at SMF e.g. configuration, by a restart or recovery condition of a UPF, or by a partial failure or recovery of a UPF for a particular UPF(s).
Under unusual circumstances, if the SMF has reached overload situation, the SMF activates NAS level congestion control as specified in clause 5.19.7. The SMF may restrict the load that the AMF(s) are generating, if the AMF is configured to enable the overload restriction.
NAS level congestion control may be applied in general (i.e. for all NAS messages), per DNN, per S-NSSAI, per DNN and S-NSSAI, or for a specific group of UEs.
NAS level congestion control is achieved by providing the UE a back-off time. To avoid that large amounts of UEs initiate deferred requests (almost) simultaneously, the 5GC should select each back-off time value so that the deferred requests are not synchronized. When the UE receives a back-off time, the UE shall not initiate any NAS signalling with regards to the applied congestion control until the back-off timer expires or the UE receives a mobile terminated request from the network, or the UE initiates signalling for emergency services or high priority access.
AMFs and SMFs may apply NAS level congestion control, but should not apply NAS level congestion control for procedures not subject to congestion control.
This clause only applies to NAS Mobility Management congestion control.
Under general overload conditions the AMF may reject NAS messages from UEs using any 5G-AN. When a NAS request is rejected, a Mobility Management back-off time may be sent by the AMF to the UE. While the Mobility Management back-off timer is running, the UE shall not initiate any NAS request except for Deregistration procedure and procedures not subject to congestion control (e.g. high priority access, emergency services) and mobile terminated services. After any such Deregistration procedure, the back-off timer continues to run. While the Mobility Management back-off timer is running, the UE is allowed to perform Mobility Registration Update if the UE is already in CM-CONNECTED state. If the UE receives a paging request or a NAS notification message from the AMF while the Mobility Management back off timer is running, the UE shall stop the Mobility Management back-off timer and initiate the Service Request procedure or the Mobility Registration Update procedure over 3GPP access and/or non-3GPP access as applicable. Over non-3GPP access, if the UE is in CM-IDLE state when the back-off timer is stopped, it shall initiate the UE-triggered Service Request procedure as soon as it switches back to CM-CONNECTED state.
In order to allow the UE to report the PS Data Off status change in PDU Session Modification Request message, the UE behaves as follows while keeping the NAS MM back-off timer running in the UE:
-	When the UE is in CM-IDLE state and has not moved out of the Registration Area, the UE is allowed to send a Service Request message with an indication that the message is exempted from NAS congestion control. When the UE is in CM-IDLE mode and has moved out of the Registration Area, the UE is allowed to send a Mobility Registration Update request message, with a Follow-on request, and with an indication that the message is exempted from NAS congestion control.
-	When the UE is in CM-CONNECTED state, the UE sends a PDU Session Modification Request with PS Data Off status change carried in UL NAS Transport message with an indication that the message is exempted from NAS congestion control.
When the NAS MM congestion control is activated at AMF, if the UE indicates that the NAS MM message is exempted from NAS congestion control, the AMF shall not reject the NAS MM message and shall forward the NAS SM message to the corresponding SMF with an indication that the NAS SM message was indicated to be exempted from NAS congestion control. The SMF ensures that the NAS SM message is not subject to congestion control otherwise the SMF rejects the message, e.g. the SMF shall reject PDU Session Modification received if it is not for Data Off status reporting.
The Mobility Management back-off timer shall not impact Cell/RAT/Access Type and PLMN change. Cell/RAT/TA/Access Type change does not stop the Mobility Management back-off timer. The Mobility Management back-off timer shall not be a trigger for PLMN reselection or SNPN reselection. The back-off timer is stopped as defined in TS 24.501 [47] when a new PLMN or SNPN, that is not an equivalent PLMN or is not an equivalent SNPN, is accessed.
To avoid that large amounts of UEs initiate deferred requests (almost) simultaneously, the AMF should select the Mobility Management back-off timer value so that the deferred requests are not synchronized.
If the UE required to report 5GSM Core Network Capability change, or the Always-on PDU Session Requested indication while the NAS MM congestion control timer was running and was unable to initiate MM signalling, the UE defers the related MM signalling until the MM congestion control timer expires and initiates after the expiry of the timer.
In the case of a UE with scheduled communication pattern, the AMF may consider the UE's communication pattern while selecting a value for the Mobility Management back-off timer so that the UE does not miss its only scheduled communication window.
The AMF should not reject Registration Request message for Mobility Registration Update that are performed when the UE is already in CM-CONNECTED state.
The AMF may reject the Service Request message and a UL NAS Transfer with a Mobility Management back-off time when the UE is already in CM-CONNECTED state. If UE receives a DL NAS Transfer message from the AMF while the Mobility Management back off timer is running, the UE shall stop the Mobility Management back-off timer.
For CM-IDLE state mobility, the AMF may reject Registration Request messages for Mobility Registration Update by including a Mobility Management back off time value in the Registration Reject message.
If UE registered in the same PLMN for 3GPP access and non-3GPP access and receives a Mobility Management back-off time from the AMF, the back-off time (and corresponding start and stop) is applied equally to both 3GPP access and non-3GPP access. If UE registered in different PLMNs for 3GPP access and non-3GPP access respectively and receives a Mobility Management back-off time, the back-off time is only applied to the PLMN that provides the time to the UE.
If the AMF rejects Registration Request messages or Service Request with a Mobility Management back-off time which is larger than the sum of the UE's Periodic Registration Update timer and the Implicit Deregistration timer, the AMF should adjust the mobile reachable timer and/or Implicit Deregistration timer such that the AMF does not implicitly deregister the UE while the Mobility Management back-off timer is running.
NOTE:	This is to minimize signalling after the Mobility Management back-off timer expires.
If the AMF deregisters the UE with an indication of re-registration required, the UE behaviour for handling the back-off timer(s) is as specified in TS 24.501 [47].
DNN based congestion control is designed for the purpose of avoiding and handling of NAS SM signalling congestion for the UEs with a back-off timer associated with or without a DNN regardless of the presence of an S-NSSAI. Both UE and 5GC shall support the functionality to enable DNN based congestion control.
SMFs may apply DNN based congestion control towards the UE by rejecting PDU Session Establishment Request message, or PDU Session Modification Request message except for those sent for the purpose of reporting 3GPP PS Data Off status change for a specific DNN with a running back-off timer. The SMF may release PDU Sessions belonging to a congested DNN by sending a PDU Session Release Command message towards the UE with a DNN back-off timer. If a DNN back-off time is set in the PDU Session Release Command message, the cause value of "reactivation requested" shall not be set.
If NWDAF is deployed, the SMF may make use of Session Management Congestion Control Experience analytics provided by NWDAF, as defined in clause 6.12 of TS 23.288 [86], to determine back-off timer provided to UEs.
NOTE:	For example, the SMF can apply a short back-off timer to the UEs in the list of high-experienced UEs while the SMF can apply a long back-off timer to the UEs in the list of low-experienced UEs.
When DNN based congestion control is activated at AMF e.g. configured by OAM, the AMF provides a NAS Transport Error message for the NAS Transport message carrying an SM message, and in the NAS Transport Error message it includes a DNN back-off timer.
The UE associates the received back-off time with the DNN (i.e. no DNN, DNN only) which the UE included in the uplink NAS MM message carrying the corresponding NAS SM request message.
The UE associates the received back-off time with the DNN (i.e. no DNN, DNN only) in any PLMN unless the DNN associated with the back-off timer is an LADN DNN in which case the UE only associates it to the PLMN in which the back-off time was received.
The UE behaves as follows when the DNN back-off timer is running:
-	If a DNN is associated with the back-off timer, the UE shall not initiate any Session Management procedures for the congested DNN. The UE may initiate Session Management procedures for other DNNs. The UE shall not initiate any Session Management procedure for the corresponding APN when UE moves to EPS. The UE may initiate Session Management procedures for other APNs when the UE moves to EPS;
-	If no DNN is associated with the back-off timer, the UE may only initiate Session Management requests of any PDU Session Type for a specific DNN;
-	Upon Cell/TA/PLMN/RAT change, change of untrusted non-3GPP access network or change of Access Type, the UE shall not stop the back-off timer;
-	The UE is allowed to initiate the Session Management procedures for high priority access and emergency services;
-	The UE is allowed to initiate the Session Management procedure for reporting Data Off status change to the network;
-	If the UE receives a network initiated Session Management message other than PDU Session Release Command for the congested DNN associated to a running back-off timer, the UE shall stop the back-off timer and respond to the 5GC;
-	If the UE receives a PDU Session Release Command message for the congested DNN, it shall stop the back-off timer unless it receives a new back-off time from SMF;
-	The UE is allowed to initiate PDU Session Release procedure (i.e. sending PDU Session Release Request message). The UE shall not stop the back-off timer when the related PDU Session is released;
-	The list above is not an exhaustive list, i.e. more details of the above actions and further conditions, if any, are specified in TS 24.501 [47].
If UE initiates one of the Session Management procedures that are exempted from NAS congestion control, the UE indicates that the carried NAS SM message is exempted from NAS congestion control in the UL NAS Transport message as described in TS 24.501 [47]. When the DNN based congestion control is activated at AMF, if the UE indicates that the NAS SM message in the UL NAS Transport message is exempted from NAS congestion control, the AMF shall not apply DNN based congestion control on the UL NAS Transport message and shall forward the NAS SM message to the corresponding SMF with an indication that the message was received with exemption indication. The SMF evaluates whether the NAS SM message is allowed to be exempted from DNN based congestion control. If it is not, the SMF rejects the message, e.g. the SMF shall reject PDU Session Modification received if it is not for Data Off status reporting).
The UE shall maintain a separate back-off timer for each DNN that the UE may use.
To avoid that large amounts of UEs initiate deferred requests (almost) simultaneously, the 5GC should select the back-off timer value so that deferred requests are not synchronized.
If the UE required to report 5GSM Core Network Capability change, or the Always-on PDU Session Requested indication while DNN based congestion control was running and was unable to initiate SM signalling, the UE defers the related SM signalling until the DNN based congestion control timer expires and initiates the necessary SM signalling after the expiry of the timer.
The DNN based Session Management congestion control is applicable to the NAS SM signalling initiated from the UE in the Control Plane. The Session Management congestion control does not prevent the UE from sending and receiving data or initiating Service Request procedures for activating User Plane connection towards the DNN(s) that are under Session Management congestion control.
S-NSSAI based congestion control is designed for the purpose of avoiding and handling of NAS signalling congestion for the UEs with back-off timer associated with or without an S-NSSAI regardless of the presence of a DNN.
The UE associates the received back-off time with the S-NSSAI and DNN (i.e. no S-NSSAI and no DNN, no S-NSSAI, S-NSSAI only, an S-NSSAI and a DNN) which was included in the uplink NAS MM message carrying the corresponding NAS SM request message for the PLMN which is under congestion.
S-NSSAI based congestion control is applied as follows:
-	If an S-NSSAI is determined as congested, then the SMF may apply S-NSSAI based congestion control towards the UE for SM requests except for those sent for the purpose of reporting 3GPP PS Data Off status change for a specific S-NSSAI and provides a back-off time and an indication of HPLMN congestion;
-	If the UE receives an S-NSSAI based back-off time without an indication of HPLMN congestion, the UE shall apply the S-NSSAI back-off timer only in the PLMN in which the back-off time was received. If the UE receives S-NSSAI based back-off time with an indication of HPLMN congestion, the UE shall apply the S-NSSAI based back-off timer in the PLMN in which the back-off time was received and in any other PLMN;
-	The SMF may release PDU Sessions belonging to a congested S-NSSAI by sending a PDU Session Release Request message towards the UE with a back-off time associated either to the S-NSSAI only (i.e. with no specific DNN) or a combination of the S-NSSAI and a specific DNN. If NWDAF is deployed, the SMF may make use of Session Management Congestion Control Experience analytics provided by NWDAF, as defined in clause 6.12 of TS 23.288 [86], to determine back-off timer provided to UEs;
NOTE:	For example, the SMF can apply a short back-off timer to the UEs in the list of high-experienced UEs while the SMF can apply a long back-off timer to the UEs in the list of low-experienced UEs.
-	If S-NSSAI based congestion control is activated at AMF e.g. configured by OAM and an S-NSSAI is determined as congested, then the AMF applies S-NSSAI based congestion control towards the UE for UE-initiated Session Management requests. In this case, the AMF provides a NAS Transport Error message for the NAS Transport message carrying the SM message, and in the NAS Transport Error message it includes a back-off timer; If NWDAF is deployed, the AMF may determine that S-NSSAI is congested based on the network slice load level analytics defined in TS 23.288 [86].
-	The UE behaves as follows in the PLMN where the S-NSSAI based congestion control applies when the back-off timer is running:
-	If the back-off timer was associated with an S-NSSAI only (i.e. not associated with an S-NSSAI and a DNN), the UE shall not initiate any Session Management procedures for the congested S-NSSAI;
-	If the back-off timer was associated with an S-NSSAI and a DNN, then the UE shall not initiate any Session Management procedures for that combination of S-NSSAI and DNN;
-	If the UE receives a network-initiated Session Management message other than PDU Session Release Command for the congested S-NSSAI, the UE shall stop this back-off timer and respond to the 5GC;
-	If the UE receives a PDU Session Release Command message for the congested S-NSSAI, it shall stop the back-off timer unless it receives a new back-off time from SMF;
-	Upon Cell/TA/PLMN/RAT change, change of untrusted non-3GPP access network or change of Access Type, the UE shall not stop the back-off timer for any S-NSSAI or any combination of S-NSSAI and DNN;
-	The UE is allowed to initiate the Session Management procedures for high priority access and emergency services for the S-NSSAI;
-	The UE is allowed to initiate the Session Management procedure for reporting Data Off status change for the S-NSSAI or the combination of S-NSSAI and DNN.
-	If the back-off timer is not associated to any S-NSSAI, the UE may only initiate Session Management procedures for specific S-NSSAI;
-	If the back-off timer is not associated to any S-NSSAI and DNN, the UE may only initiate Session Management procedures for specific S-NSSAI and DNN;
-	The UE is allowed to initiate PDU Session Release procedure (e.g. sending PDU Session Release Request message). The UE shall not stop the back-off timer when the related PDU Session is released;
-	The list above is not an exhaustive list, i.e. more details of the above actions and further conditions, if any, are specified in TS 24.501 [47].
The UE shall maintain a separate back-off timer for each S-NSSAI and for each combination of S-NSSAI and DNN that the UE may use.
If UE initiates one of the Session Management procedure that are exempt from NAS congestion control, the UE indicates that the carried NAS SM message is exempted from NAS congestion control in the UL NAS Transport message as described in TS 24.501 [47]. When the S-NSSAI based congestion control is activated at AMF, if the UE indicates that the NAS SM message in the UL NAS Transport message is exempted from NAS congestion control, the AMF shall not apply S-NSSAI based congestion control on the UL NAS Transport message and shall forward the NAS SM message to the corresponding SMF with an indication that the message was received with exemption indication. The SMF evaluates whether that the NAS SM message is allowed to be exempted from S-NSSAI based congestion control. If it is not, the SMF rejects the message, e.g. the SMF shall reject PDU Session Modification received if it is not for Data Off status reporting.
The back-off timer associated with an S-NSSAI or a combination of an S-NSSAI and a DNN shall only apply to congestion control for Session Management procedures when UE is in 5GS.
To avoid that large amounts of UEs initiate deferred requests (almost) simultaneously, the 5GC should select the value of the back-off timer for the S-NSSAI based congestion control so that deferred requests are not synchronized.
If the UE required to report 5GSM Core Network Capability change, or the Always-on PDU Session Requested indication while S-NSSAI based congestion control timer was running and was unable to initiate SM signalling, the UE defers the related SM signalling until the S-NSSAI based congestion control timer expires and initiates the necessary SM signalling after the expiry of the timer.
The S-NSSAI based congestion control does not prevent the UE from sending and receiving data or initiating Service Request procedure for activating User Plane connection for a PDU Session associated to the S-NSSAI that is under the congestion control.
The group specific NAS level congestion control applies to a specific group of UEs. Group specific NAS level congestion control is performed at the 5GC only, and it is transparent to UE. The AMF or SMF or both may apply NAS level congestion control for a UE associated to an Internal-Group Identifier (see clause 5.9.7).
NOTE:	5GC logic for Group specific NAS level congestion control is not described in this Release of the specification.
Under overload conditions the AMF may restrict requests from UEs for data transmission via Control Plane CIoT 5GS Optimisation. A Control Plane data back-off timer may be returned by the AMF (e.g. in Registration Accept messages, Service Reject message or Service Accept message). While the Control Plane data back-off timer is running, the UE shall not initiate any data transfer via Control Plane CIoT 5GS Optimisation, i.e. the UE shall not send any Control Plane Service Request with uplink data as defined in TS 24.501 [47]. The AMF shall store the Control Plane data back-off timer per UE and shall not process any further requests (other than exception reporting and a response to paging) for Data Transport via a Control Plane Service Request from that UE while the Control Plane data back-off timer is still running.
NOTE 1:	The Control Plane data back-off timer does not affect any other mobility management or session management procedure.
NOTE 2:	The Control Plane data back-off timer does not apply to user plane data communication.
If the UE is allowed to send exception reporting, the UE may send an initial NAS Message for exception reporting even if Control Plane data back-off timer is running.
The UE may respond to paging with an initial NAS Message without uplink data even if the Control Plane data back-off timer is running.
If the AMF receives an initial NAS Message in reponse to a paging, and the AMF has a Control Plane data back-off timer running for the UE, and the AMF is not overloaded, and AMF decides to accept the Control Plane Service Request, then the AMF shall respond with Service Accept without the Control Plane data back-off timer and stop the Control Plane data back-off timer. If the UE receives a Service Accept without the Control Plane data back-off timer from the AMF while the Control Plane data back-off timer is running, the UE shall stop the Control Plane data back-off timer. The Control Plane data back-off timer in the UE and the AMF is stopped at PLMN change.
If the AMF receives a Control Plane Service Request with uplink data, and decides to send the UE a Control Plane data back-off timer, the AMF may decide to process the Control Plane Service Request with uplink data, i.e. decrypt and forward the data payload, or not based on the following:
-	If the UE has indicated Release Assistance Information that no further Uplink and Downlink Data transmissions are expected, then the AMF may process (integrity check/decipher/forward) the received Control Plane data packet, and send a Service Accept to the UE with Control Plane data back-off timer. The UE interprets this as successful transmission of the Control Plane data packet starts the Control Plane data back-off timer.
-	For all other cases, the AMF may decide to not process the received Control Plane data packet and send a Service Reject to the UE with Control Plane data back-off timer. The UE interprets this indication as unsuccessful delivery of the control plane data packet and starts the Control Plane data back-off timer. The AMF may take into consideration whether the PDU Session is set to Control Plane only to make the decision whether to reject the packet and send Service Reject or move the PDU Session to user plane and process the data packet as described in next bullet.
-	Alternatively, if UE has not provided Release Assistance Information, and the PDU Session not set to Control Plane only, and UE supports N3 data transfer, then the AMF may initiate establishment of N3 bearer according to the procedure defined in clause 4.2.3 of TS 23.502 [3]. In this case the AMF may also return a Control Plane data back-off timer within the Service Accept.
The AMF only includes the Control Plane data back-off timer if the UE has indicated support for Control Plane CIoT 5GS optimizations in the Registration Request.
The Network Exposure Function (NEF) supports external exposure of capabilities of network functions. External exposure can be categorized as Monitoring capability, Provisioning capability, Policy/Charging capability, Analytics reporting capability and Member UE selection capability. The Monitoring capability is for monitoring of specific event for UE in 5G System and making such monitoring events information available for external exposure via the NEF. The Provisioning capability is for allowing external party to provision of information which can be used for the UE in 5G System. The Policy/Charging capability is for handling access and mobility management, QoS and charging policies for the UE based on the request from external party. The Analytics reporting capability is for allowing an external party to fetch or subscribe/unsubscribe to analytics information generated by 5G System (this is further defined in TS 23.288 [86]). The Member UE selection capability is for allowing an external party to acquire one or more list(s) of candidate UE(s) (among the list of target member UE(s) provided by the AF) and additional information that is based on the assistance information generated by 5G System based on some defined filtering criteria, the details are explained in clause 4.15.13 in TS 23.502 [3].
Monitoring capability is comprised of means that allow the identification of the 5G network function suitable for configuring the specific monitoring events, detect the monitoring event, and report the monitoring event to the authorised external party. Monitoring capability can be used for exposing UE's mobility management context such as UE location, reachability, roaming status, and loss of connectivity. Monitoring capability can also be used for exposing QoS monitoring result. AMF stores URRP-AMF information in the MM context to determine the NFs that are authorised to receive direct notifications from the AMF. UDM stores URRP-AMF information locally to determine authorised monitoring requests when forwarding indirect notifications. The Monitoring capability also allows AF to subscribe to the group status changes for a group, either a 5G VN group as described in clause 5.29.2, as well as a group configured by OA&M. In this case the AF is notified if the group member list is updated or a group member is no longer subscribed to the group.
Provisioning capability allows an external party to provision the Expected UE Behaviour or the 5G-VN group information or DNN and S-NSSAI specific Group Parameters or ECS Address Configuration Information or service specific information to 5G NF via the NEF. The provisioning comprises of the authorisation of the provisioning external third party, receiving the provisioned external information via the NEF, storing the information, and distributing that information among those NFs that use it. The externally provisioned data can be consumed by different NFs, depending on the data. In the case of provisioning the Expected UE Behaviour, the externally provisioned information which is defined as the Expected UE Behaviour parameters in clause 4.15.6.3 of TS 23.502 [3] or Network Control parameter in clause 4.15.6.3a of TS 23.502 [3] consists of information on expected UE movement, Expected UE Behaviour parameters or expected Network Configuration parameter. The provisioned Expected UE Behaviour parameters may be used for the setting of mobility management or session management parameters of the UE. In the case of provisioning the 5G-VN group information the externally provisioned information is defined as the 5G-VN group parameters in clause 4.15.6.7 of TS 23.502 [3] and it consists of some information on the 5G-VN group. In the case of the provisioning the DNN and S-NSSAI specific Group Parameters, the externally provisioned information is defined in clause 4.15.6.14 of TS 23.502 [3] and clause 5.20b. In the case of provisioning ECS address, the externally provisioned information is defined as the ECS Address Configuration Information in clause 4.15.6.3d of TS 23.502 [3]. The affected NFs are informed via the subscriber data update as specified in clause 4.15.6.2 of TS 23.502 [3]. The externally provisioned information which is defined as the Service Parameters in clause 4.15.6.7 of TS 23.502 [3] consists of service specific information used for supporting the specific service in 5G system. The provisioned Service Parameters may be delivered to the UEs. The affected NFs are informed of the data update.
Policy/Charging capability is comprised of means that allow the request for session and charging policy, enforce QoS policy, apply accounting functionality and requests to influence access and mobility management policies. It can be used for specific QoS/priority handling for the session of the UE, and for setting applicable charging party or charging rate.
Analytics reporting capability is comprised of means that allow discovery of type of analytics that can be consumed by external party, the request for consumption of analytics information generated by NWDAF.
Member UE selection capability is comprised of means that allows filtering and providing one or more list(s) of candidate UE(s) (among the list of target member UE(s) provided by the AF) and additional information that can be consumed by external party, the request for consumption of UE list generated by external party.
An NEF may support CAPIF functions for external exposure as specified in clause 6.2.5.1.
An NEF may support exposure of NWDAF analytics as specified in TS 23.288 [86].
The NEF may support exposure of 5GS and/or UE availability and capabilities for time synchronization service as specified in clause 5.27.1.8.
An NEF may support exposure of event based notifications and reports for NSACF as specified in clause 5.15.11.
An AF may only be able to identify the target UE of an AF request for external exposure of 5GC capabilities (e.g. Data Provisioning or for Event Exposure for a specific UE) by providing the UE's address information. In this case the NEF first needs to retrieve the Permanent identifier of the UE before trying to fulfil the AF request. The NEF may determine the Permanent identifier of the UE, as described in clause 4.15.3.2.13 of TS 23.502 [3], based on:
-	the address of the UE as provided by the AF; this may be an IP address or a MAC address;
-	the corresponding DNN and/or S-NSSAI information: this may have been provided by the AF or determined by the NEF based on the requesting AF; this is needed if the UE address is an IP address.
The NEF may provide an AF specific UE Identifier to the AF:
-	that has explicitly requested a translation from the address of the UE to a unique UE identifier (via Nnef_UEId service); or
-	that has implicitly requested a translation from the address of the UE to a AF specific UE Identifier by requesting external exposure about an individual UE identified by its address.
The AF may have its own means to maintain the AF specific UE Identifier through, e.g. an AF session. After the retrieval of an AF specific UE Identifier the AF shall not keep maintaining a mapping between this identifier and the UE IP address as this mapping may change.
The AF specific UE Identifier shall not correspond to a MSISDN; it is represented as a GPSI in the form of an External Identifier. When used as an AF specific UE identifier, the External Identifier provided by the 5GCN shall be different for different AF.
NOTE 1:	This is to protect user privacy.
NOTE 2:	The AF specific UE identifier is ensured to be unique across different AFs as defined in TS 23.003 [19] by configuration. Such configuration is assumed to be coordinated between the different involved entities (e.g. NEF(s) and UDM/UDR).
NOTE 3:	Based on policies, the NEF can be configured to enforce restriction on the usage of AF specific UE identifier (e.g. rejection of a service request from AF not authorized to use the UE identifier).
5.20a	Data Collection from an AF
An NF that needs to collect data from an AF may subscribe/unsubscribe to notifications regarding data collected from an AF, either directly from the AF or via NEF.
The data collected from an AF is used as input for analytics by the NWDAF.
The details for the data collected from an AF as well as interactions between NEF, AF and NWDAF are described in TS 23.288 [86].
5.20b	Support exposure of DNN and S-NSSAI specific Group Parameters
5.20b.1	Group attribute provisioning
A group may be a 5G VN group managed as defined in clause 5.29.2, as well as a group configured by OA&M.
An AF may provision attributes for a group:
-	LADN Service area, the LADN service area is consisted of Tracking Area identities or geographical information, it is applicable to each UE member within the group and for a specific DNN and S-NSSAI.
-	QoS, the QoS refers to 5QI, ARP and 5QI Priority Level as defined in clause 5.7.2.7 and it is applicable to each UE member within the group and for a specific DNN and S-NSSAI.
5.20b.2	Support LADN service area for a group
The procedure as defined in clause 4.15.6.2 of TS 23.502 [3] is applicable for provisioning of LADN service area for a group with the following clarifications and enhancements:
-	The AF request additionally contains the LADN service area as part of DNN and S-NSSAI specific Group Parameters, and the LADN service area is stored in UDR as subscription data and delivered to AMF. If the AMF receives the LADN service area for a group, the AMF configures the DNN of the group as LADN DNN.
-	If the AF provides the LADN service area in the form of geographical information, the NEF maps the geographical information to a list of TAs before sending the service area to the UDM.
LADN per DNN and S-NSSAI as defined in clause 5.6.5a is applicable for enforcement of LADN service area.
5.20b.3	Support QoS for a group
The procedure as defined in clause 4.15.6.2 of TS 23.502 [3] is applicable for provisioning of QoS for a group with the following clarifications and enhancements:
-	The AF request additionally contains the QoS for the group, and the UDM stores such QoS in the UDR and uses such QoS to set 5GS Subscribed QoS profile in Session Management Subscription data for each UE within the group.
-	When a UE belongs to multiple groups simultaneously, the strictest QoS profile among groups the group member belongs to is selected.
NOTE:	In the case that the strictest QoS profile can not be fulfilled, the next strictest QoS profile is selected.
Mechanisms as defined in clause 5.7.2.7 are used to enforce the 5GS Subscribed QoS profile for each UE within a group thus to support enforcement of QoS for a group.
5.20b.4	Void

5.20b.5	Support Change of PDU Session Type for a group of UEs
The Service specific parameters provisioning procedure as defined in clauses 4.15.6.7 and 4.15.6.7a of TS 23.502 [3] is applicable for updating of PDU session type of the URSP for a group of UEs.
When the UE receives the URSP rules, the UE re-evaluates the URSP rules, and may release the PDU session and re-establishes the PDU session with the high precedence PDU session type in the URSP rules.
5.20c	Provisioning of traffic characteristics and monitoring of performance characteristics for a group
NEF provisioning capability as defined in clause 5.20 allows an AF to perform provisioning of traffic characteristics and monitoring of performance characteristics for a group of UEs as specified in clause 4.15.6.14 of TS 23.502 [3] and clause 6.1.3.28 of TS 23.503 [45].
NOTE :	The AF may use application layer functionalities to handle requests for UE-to-UE traffic as defined by SA WG6.
The NEF determines whether or not to invoke the TSCTSF in the same way as for AF session with required QoS procedure, as described in step 2 of clause 4.15.6.6 in TS 23.502 [3]. In the case that the TSCTSF is used, the TSCTSF receives the AF requested QoS information from the NEF. In the case that TSCTSF is not used, the AF request is handled as described in clause 4.15.6.14 of TS 23.502 [3] and clause 6.1.3.28 of TS 23.503 [45].
When the TSCTSF receives the AF requested QoS information from NEF or the PCF(s) receive the AF requested QoS information from UDR, the TSCTSF or PCF (s) manage the AF requested QoS information for each UE group member within the group as follows:
-	Translate the External Group ID into a list of SUPIs by invoking Nudm_SDM_Get service.
-	Determine which of these UE group members have active PDU Sessions matching the DNN and S-NSSAI and determine the relevant UE address.
-	Manage the request status (activated, de-activated, failed) for each UE group member within the group:
-	Apply the AF requested QoS information if the UE group member is registered or has active PDU Session matching the DNN and S-NSSAI. Set the status to activated if the QoS resources are assigned for the UE group member, otherwise, failed.
-	Set the status to de-activated if the UE group member is not registered or has no active PDU Session matching the DNN and S-NSSAI.
-	Delete the request status for the UE group member if the UE group member is removed from the group, and further revokes AF request QoS information if the request status is activated.
-	Check whether to apply the AF requested QoS information and update the request status for the UE group member if the UE group member is newly added to the group.
-	When the AF requested QoS information contains temporal invalidity condition:
-	Revoke AF requested QoS information for each UE group member which is marked as active, so to e.g. to remove or modify PCC rules as defined in clause 4.16.5.2 of TS 23.502 [3] if the start-time is reached.
-	Apply AF requested QoS information for each UE group member that has active PDU Sessions matching the DNN and S-NSSAI, e.g. to add or modify PCC rules as defined in clause 4.16.5.2 of TS 23.502 [3].
5.20d	User Plane Direct 5GS Information Exposure
5.20d.1	General
In order to expose network information, the user plane direct 5GS information exposure function may be applied. The user plane direct 5GS information exposure function allows the UPF to report the network information directly to consumer based on the instructions provided by SMF.
NOTE:	In the scenario of Edge Computing as described in TS 23.548 [130], the consumer can be the L-NEF or local AF when the local AF is trusted.
When the exposed network information is provided by the UPF, the PSA UPF may be instructed to report network information via Nupf_EventExposure service (e.g. directly to an AF, i.e. bypassing the SMF and the PCF); or the UPF may be instructed to report the information to the consumer via SMF/PCF/NEF, as described in clause 5.8.2.18.
When the exposed network information is provided by the NG-RAN, the NG-RAN may be instructed by the SMF to report the information via the GTP-U tunnel(s) between the NG RAN and PSA UPF, as defined in clause 5.45.
The User Plane Direct 5GS Information Exposure may be used for exposing the following information:
-	QoS Monitoring information (see clause 5.45).
-	TSC Management Information (see clause 5.28.3).
5GC supports different virtualized deployment scenarios, including but not limited to the options below:
-	A Network Function instance can be deployed as distributed, redundant, stateless, and scalable NF instance that provides the services from several locations and several execution instances in each location.
-	This type of deployments would typically not require support for addition or removal of NF instances for redundancy and scalability. In the case of an AMF this deployment option may use enablers like, addition of TNLA, removal of TNLA, TNLA release and rebinding of NGAP UE association to a new TNLA to the same AMF.
-	A Network Function instance can also be deployed such that several network function instances are present within a NF set provide distributed, redundant, stateless and scalability together as a set of NF instances.
-	This type of deployments may support for addition or removal of NF instances for redundancy and scalability. In the case of an AMF this deployment option may use enablers like, addition of AMFs and TNLAs, removal of AMFs and TNLAs, TNLA release and rebinding of NGAP UE associations to a new TNLA to different AMFs in the same AMF set.
-	The SEPP, although not a Network Function instance, can also be deployed distributed, redundant, stateless, and scalable.
-	The SCP, although not a Network Function instance, can also be deployed distributed, redundant, and scalable.
Also, deployments taking advantage of only some or any combination of concepts from each of the above options is possible.
5G-AN node shall have the capability to support multiple TNL associations per AMF, i.e. AMF name.
An AMF shall provide the 5G-AN node with the weight factors for each TNL association of the AMF.
The AMF shall be able to request the 5G-AN node to add or remove TNL associations to the AMF.
The AMF shall be able to indicate to the 5G-AN node the set of TNL associations used for UE-associated signalling and the set of TNL associations used for non-UE associated signalling.
NOTE: The TNL association(s) indicated for UE-associated and non-UE associated signalling can either be overlap or be different.
While a UE is in CM-Connected state the 5G-AN node shall maintain the same NGAP UE-TNLA-binding (i.e. use the same TNL association and same NGAP association for the UE) unless explicitly changed or released by the AMF.
An AMF shall be able to update the NGAP UE-TNLA-binding (i.e. change the TNL association for the UE) in CM-CONNECTED state at any time. The NGAP UE-TNLA-binding can also be updated when a UE-specific NGAP message initiated by AMF is received via a new TNL association.
An AMF shall be able to update the NGAP UE-TNLA-binding (i.e. change the TNL association for the UE) in response to an N2 message received from the 5G-AN by triangular redirection (e.g. by responding to the 5G-AN node using a different TNL association).
An AMF shall be able to command the 5G-AN node to release the NGAP UE-TNLA-binding for a UE in CM-CONNECTED state while maintaining N3 (user-plane connectivity) for the UE at any time.
The 5G-AN node shall consider the following factors for selecting a TNL association for the AMF for the initial N2 message e.g. N2 INITIAL UE MESSAGE:
-	Availability of candidate TNL associations.
-	Weight factors of candidate TNL associations.
The AMF may use any TNL association intended for non-UE associated signalling for initiation of the N2 Paging procedure.
The 5G System should support establishment of association between AMF and 5G-AN node.
A new AMF can be added to an AMF set and association between AMF and GUAMI can be created and/or updated as follows:
-	AMF shall be able to dynamically update the NRF with the new or updated GUAMI(s) to provide mapping between GUAMI(s) and AMF information. Association between GUAMI(s) and AMF is published to NRF. In addition, to deal with planned maintenance and failure, an AMF may optionally provide backup AMF information, i.e. it act as a backup AMF if the indicated GUAMI associated AMF is unavailable. It is assumed that the backup AMF and the original AMF are in the same AMF set as they have access to the same UE context. Based on that information one GUAMI is associated with an AMF, optionally with a backup AMF used for planned removal and/or another (same or different) backup AMF used for failure.
-	Upon successful update, the NRF considers the new and/or updated GUAMI(s) for providing AMF discovery results to the requester. Requester can be other CP network functions.
-	The new AMF provides its GUAMI to 5G-AN and 5G-AN store this association. If the association between the same GUAMI and another AMF exists in the 5G-AN (e.g. due to AMF planned removal), the previously stored AMF is replaced by the new AMF for the corresponding GUAMI association.
Information about new AMF should be published and available in the DNS system. It should allow 5G-AN to discover AMF and setup associations with the AMF required. N2 setup procedure should allow the possibility of AMFs within the AMF Set to advertise the same AMF Pointer and/or distinct AMF Pointer value(s) to the 5G-AN node.
To support the legacy EPC core network entity (i.e. MME) to discover and communicate with the AMF, the information about the AMF should be published and available in the DNS system. Furthermore, GUMMEI and GUAMI encoding space should be partitioned to avoid overlapping values in order to enable MME discover an AMF without ambiguity.
An AMF can be taken graciously out of service as follows:
-	If an UDSF is deployed in the network, then the AMF stores the context for registered UE(s) in the UDSF. The UE context includes the AMF UE NGAP ID that is unique per AMF set. In order for the AMF planned removal procedure to work graciously, 5G-S-TMSI shall be unique per AMF Set. If there are ongoing transactions (e.g. N1 procedure) for certain UE(s), AMF stores the UE context(s) in the UDSF upon completion of an ongoing transaction.
-	The AMF deregister itself from NRF indicating due to AMF planned removal.
NOTE 1:	It is assumed that the UE contexts from the old AMF include all event subscriptions with peer CP NFs.
NOTE 2: Before removal of AMF the overload control mechanism can be used to reduce the amount of ongoing transaction.
An AMF identified by GUAMI(s) shall be able to notify the 5G-AN that it will be unavailable for processing transactions by including GUAMI(s) configured on this AMF. Upon receipt of the indication that an AMF(identified by GUAMI(s)) is unavailable, 5G-AN shall take the following action:
-	5G-AN should mark this AMF as unavailable and not consider the AMF for selection for subsequent N2 transactions until 5G-AN learns that it is available (e.g. as part of discovery results or by configuration).
-	During NGAP Setup procedure, the AMF may include an additional indicator that the AMF will rebind or release the NGAP UE-TNLA-binding on a per UE-basis for UE(s) in CM-CONNECTED state. If that indicator is included and the 5G-AN supports timer mechanism, the 5G-AN starts a timer to control the release of NGAP UE-TNLA-binding. For the duration of the timer or until the AMF releases or re-binds the NGAP UE-TNLA-binding the AN does not select a new AMF for subsequent UE transactions. Upon timer expiry, the 5G-AN releases the NGAP UE UE-TNLA-binding(s) with the corresponding AMF for the respective UE(s), for subsequent N2 message, the 5G-AN should select a different AMF from the same AMF set when the subsequent N2 message needs to be sent.
NOTE 3:	For UE(s) in CM-CONNECTED state, after indicating that the AMF is unavailable for processing UE transactions and including an indicator that the AMF releases the NGAP UE-TNLA-binding(s) on a per UE-basis, the AMF can either trigger a re-binding of the NGAP UE associations to an available TNLA on a different AMF in the same AMF set or use the NGAP UE-TNLA-binding per UE release procedure defined in TS 23.502 [3] to release the NGAP UE-TNLA-binding on a per UE-basis while requesting the AN to maintain N3 (user plane connectivity) and UE context information.
NOTE 4:	The support and the use of timer mechanism in 5G-AN is up to implementation.
-	If the instruction does not include the indicator, for UE(s) in CM-CONNECTED state, 5G-AN considers this as a request to release the NGAP UE-TNLA-binding with the corresponding AMF for the respective UE(s) while maintaining N3 (user plane connectivity) and UE context information. For subsequent N2 message, the 5G-AN should select a different AMF from the same AMF set when the subsequent N2 message needs to be sent.
-	For UE(s) in CM-IDLE state, when it subsequently returns from CM-IDLE state and the 5G-AN receives an initial NAS message with a 5G S-TMSI or GUAMI pointing to an AMF that is marked unavailable, the 5G-AN should select a different AMF from the same AMF set and forward the initial NAS message. If the 5G-AN can't select an AMF from the same AMF set, the 5G-AN selects another new AMF as described in clause 6.3.5.
An AMF identified by GUAMI(s) shall be able to instruct other peer CP NFs, subscribed to receive such a notification, that it will be unavailable for processing transactions by including GUAMI(s) configured on this AMF. If the CP NFs register with NRF for AMF unavailable notification, then the NRF shall be able to notify the subscribed NFs to receive such a notification that AMF identified by GUAMI(s) will be unavailable for processing transactions. Upon receipt of the notification that an AMF (GUAMI(s)) is unavailable, the other CP NFs shall take the following actions:
-	CP NF should mark this AMF (identified by GUAMI(s)) as unavailable and not consider the AMF for selection for subsequent MT transactions until the CP NF learns that it is available (e.g. as part of NF discovery results or via NF status notification from NRF).
-	Mark this AMF as unavailable while not changing the status of UE(s) associated to this AMF (UE(s) previously served by the corresponding AMF still remain registered in the network), and AMF Set information.
-	For the UE(s) that were associated to the corresponding AMF, when the peer CP NF needs to initiate a transaction towards the AMF that is marked unavailable, CP NF should select another AMF from the same AMF set (as in clause 6.3.5) and forward the transaction together with the old GUAMI. The new AMF retrieves UE context from the UDSF. If CP NF needs to send a notification to new AMF which is associated with a subscription from the old AMF, the CP NF shall exchange the old AMF information embedded in the Notification Address with the new AMF information, and use that Notification Address for subsequent communication.
NOTE 5:	If the CP NF does not subscribe to receive AMF unavailable notification (either directly from the AMF or via NRF), the CP NF may attempt forwarding the transaction towards the old AMF and detect that the AMF is unavailable after certain number of attempts. When it detects unavailable, it marks the AMF and its associated GUAMI(s) as unavailable. CP NF should select another AMF from the same AMF set (as in clause 6.3.5) and forward the transaction together with the old GUAMI. The new AMF retrieves UE context from the UDSF and process the transaction.
Following actions should be performed by the newly selected AMF:
-	When there is a transaction with the UE the newly selected AMF retrieves the UE context from the UDSF based on SUPI, 5G-GUTI or AMF UE NGAP ID and processes the UE message accordingly and updates the 5G-GUTI towards the UE, if necessary. For UE(s) in CM-CONNECTED state, it may also update the NGAP UE association with a new AMF UE NGAP ID towards the 5G-AN and replace the GUAMI in the UE context stored at the 5G-AN with the new GUAMI associated with the newly selected AMF if the 5G-GUTI has been updated. The AMF also informs the NG-RAN of the new UE Identity Index Value (derived from the new 5G-GUTI).
-	When there is a transaction with the UE, the new selected AMF updates the peer NFs (that subscribed to receive AMF unavailability notification from old AMF), with the new selected AMF information.
-	If the new AMF is aware of a different AMF serving the UE (by implementation specific means) it forwards the uplink N2 signalling of the UE to that AMF directly if necessary, the 5G-AN shall be able to receive the message from a different AMF, or it rejects the transaction from the peer CP NFs with a cause to indicate that new AMF has been selected, the peer CP NFs resend the transaction to the new AMF.
NOTE 6:	This bullet above addresses situations where 5G-AN node selects an AMF and CP NFs select another AMF for the UE concurrently. It also addresses the situation where CP NFs select an AMF for the UE concurrently
-	If the UE is in CM-IDLE state and the new AMF does not have access to the UE context, the new AMF selects one available AMF from the old AMF set as described in clause 6.3.5. The selected AMF retrieves the UE context from the UDSF and provides the UE context to the new AMF. If the new AMF doesn't receive the UE context then the AMF may force the UE to perform Initial Registration.
An AMF can be taken graciously out of service as follows:
-	The AMF can forward registered UE contexts, UE contexts grouped by the same GUAMI value, to target AMF(s) within the same AMF set, including the source AMF name used for redirecting UE's MT transaction. The UE context includes the per AMF Set unique AMF UE NGAP ID. In order for the AMF planned removal procedure to work graciously, 5G-S-TMSI shall be unique per AMF set. If there are ongoing transactions (e.g. N1 procedure) for certain UE(s), AMF forwards the UE context(s) to the target AMF upon completion of an ongoing transaction.
-	The AMF deregister itself from NRF indicating due to AMF planned removal.
NOTE 1:	It is assumed that the UE contexts from the old AMF include all event subscriptions with peer CP NFs.
NOTE 2: Before removal of AMF the overload control mechanism can be used to reduce the amount of ongoing transaction.
An AMF shall be able to instruct the 5G-AN that it will be unavailable for processing transactions by including GUAMI(s) configured on this AMF and its corresponding target AMF(s). The target AMF shall be able to update the 5G-AN that the UE(s) served by the old GUAMI(s) are now served by target AMF. The target AMF provides the old GUAMI value that the 5G-AN can use to locate UE contexts served by the old AMF. Upon receipt of the indication that an old AMF is unavailable, 5G-AN shall take the following action:
-	5G-AN should mark this AMF as unavailable and not consider the AMF for selection for subsequent N2 transactions until 5G-AN learns that it is available (e.g. as part of discovery results or by configuration). The associated GUAMIs are marked as unavailable.
-	During NGAP Setup, the AMF may include an additional indicator that the AMF will rebind or release the NGAP UE-TNLA-binding on per UE-basis. If that indicator is included and the 5G-AN supports timer mechanism, the 5G-AN starts a timer to control the release of NGAP UE-TNLA-binding(s). For the duration of the timer or until the AMF releases or re-binds the NGAP UE-TNLA-binding, the AN does not select a new AMF for subsequent transactions. Upon timer expiry, the 5G-AN releases the NGAP UE-TNLA-binding(s) with the corresponding AMF for the respective UE(s), for subsequent N2 message, the 5G-AN uses GUAMI which points to the target AMF that replaced the old unavailable AMF, to forward the N2 message to the corresponding target AMF(s).
NOTE 3:	For UE(s) in CM-CONNECTED state, after indicating that the AMF is unavailable for processing UE transactions and including an indicator that the AMF releases the NGAP UE-TNLA-binding on a per UE-basis, the AMF can either trigger a re-binding of the NGAP UE associations to an available TNLA on a different AMF within the same AMF set or use the NGAP UE-TNLA-binding per UE release procedure defined in TS 23.502 [3] to release the NGAP UE-TNLA-binding on a per UE-basis while requesting the AN to maintain N3 (user plane connectivity) and UE context information.
NOTE 4:	The support and the use of timer mechanism in 5G-AN is up to implementation.
	If the instruction does not include the indicator, for UE(s) in CM-CONNECTED state, 5G-AN considers this as a request to release the NGAP UE UE-TNLA-binding(s) with the corresponding AMF for the respective UE(s) while maintaining N3 (user plane connectivity) and UE context information. For subsequent N2 message, the 5G-AN uses GUAMI based resolution which points to the target AMF that replaced the old unavailable AMF, to forward the N2 message to the corresponding target AMF(s).
-	For UE(s) in CM-IDLE state, when it subsequently returns from CM-IDLE state and the 5G-AN receives an initial NAS message with a 5G S-TMSI or GUAMI, based resolution the 5G-AN uses 5G S-TMSI or GUAMI which points to the target AMF that has replaced the old unavailable AMF and, the 5G-AN forwards N2 message.
An AMF shall be able to instruct other peer CP NFs, subscribed to receive such a notification, that it will be unavailable for processing transactions by including GUAMI(s) configured on this AMF and its corresponding target AMF(s). The target AMF shall update the CP NF that the old GUAMI(s) is now served by target AMF. The old AMF provides the old GUAMI value to target AMF and the target AMF can use to locate UE contexts served by the old AMF. If the CP NFs register with NRF for AMF unavailable notification, then the NRF shall be able to notify the subscribed NFs to receive such a notification (along with the corresponding target AMF(s)) that AMF identified by GUAMI(s) will be unavailable for processing transactions. Upon receipt of the notification that an AMF is unavailable, the other CP NFs shall take the following action:
-	Mark this AMF and its associated GUAMI(s) as unavailable while not changing the status of UE(s) associated to this AMF (UE(s) previously served by the corresponding AMF still remain registered in the network), and AMF Set information.
-	For the UE(s) that were associated to the corresponding AMF, when the peer CP NF needs to initiate a transaction towards the AMF that is marked unavailable and the old unavailable AMF was replaced by the target AMF, CP NF should forward the transaction together with the old GUAMI to the target AMF(s). If CP NF needs to send a notification to new AMF which is associated with a subscription from the old AMF, the CP NF shall exchange the old AMF information embedded in the Notification Address with the new AMF information, and use that Notification Address for subsequent communication.
NOTE 5:	If the CP NF does not subscribe to receive AMF unavailable notification (either directly with the AMF or via NRF), the CP NF may attempt forwarding the transaction towards the old AMF and detect that the AMF is unavailable after certain number of attempts. When it detects unavailable, it marks the AMF and its associated GUAMI(s) as unavailable.
The following actions should be performed by the target AMF:
-	To allow AMF process ongoing transactions for some UE(s) even after it notifies unavailable status to the target AMF, the target AMF keeps the association of the old GUAMI(s) and the old AMF for a configured time. During that configured period, if target AMF receives the transaction from the peer CP NFs and cannot locate UE context, it rejects the transaction with old AMF name based on that association, and the indicated AMF is only used for the ongoing transaction. The peer CP NFs resend the transaction to the indicated AMF only for the ongoing transaction. For subsequent transactions, peer CP NFs should use the target AMF. When the timer is expired, the target AMF deletes that association information.
-	When there is a transaction with the UE the target AMF uses SUPI, 5G-GUTI or AMF UE NGAP ID to locate UE contexts and processes the UE transactions accordingly and updates the 5G-GUTI towards the UE, if necessary. For UE(s) in CM-CONNECTED state, it may also update the NGAP UE association with a new AMF UE NGAP ID towards the 5G-AN and replace the GUAMI in the UE context stored at the 5G-AN with the new GUAMI associated with the newly selected AMF if the 5G-GUTI has been updated. The AMF also informs the NG-RAN of the new UE Identity Index Value (derived from the new 5G-GUTI).
-	Target AMF shall not use old GUAMI to allocate 5G-GUTI for UE(s) that are being served by Target AMF.
In order to try and handle AMF failure in a graceful manner (i.e. without impacting the UE), AMF can either back up the UE contexts in UDSF, or per GUAMI granularity in other AMFs (serving as backup AMF for the indicated GUAMI).
NOTE 1:	Frequency of backup is left to implementation.
For deployments without UDSF, for each GUAMI the backup AMF information (in association to the GUAMI) is configured in the AMF. The AMF sends this information to 5G-AN and other CP NFs during the N2 setup procedure or the first (per NF) interaction with other CP NFs.
In the case that an AMF fails and the 5G-AN/peer CP NFs detect that the AMF has failed, or the 5G-AN/peer CP NFs receives notification from another AMF in the same AMF set that this AMF has failed, following actions are taken:
-	The OAM deregister the AMF from NRF indicating due to AMF failure.
-	5G-AN marks this AMF as failed and not consider the AMF for selection until explicitly notified.
-	For UE(s) in CM-CONNECTED state, 5G-AN considers failure detection or failure notification as a trigger to release the NGAP UE-TNLA-binding(s) with the corresponding AMF for the respective UE(s) while maintaining N3 (user plane connectivity) and other UE context information. For subsequent N2 message, if the backup AMF information of the corresponding failed AMF is not available the 5G-AN should select a different AMF (as in clause 6.3.5) from the same AMF set when the subsequent N2 message needs to be sent for the UE(s). If no other AMF from the AMF set is available, then it can select an AMF (implementation dependent) from the same AMF Region as in clause 6.3.5. If backup AMF information of the corresponding failed AMF is available, the 5G-AN forwards the N2 message to the backup AMF.
NOTE 2:	One AMF in the AMF set may be configured to send this failure notification message.
-	For UE(s) in CM-IDLE state, when it subsequently returns from CM-IDLE state and the 5G-AN receives an initial NAS message with a S-TMSI or GUAMI pointing to an AMF that is marked failed, if the backup AMF information of the corresponding failed AMF is not available the 5G-AN should select a different AMF from the same AMF set and forward the initial NAS message. If no other AMF from the AMF set is available, then it can select an AMF (implementation dependent) from the same AMF Region as in clause 6.3.5. If backup AMF information of the corresponding failed AMF is available, the 5G-AN forwards the N2 message to the backup AMF.
-	Peer CP NFs consider this AMF as unavailable while retaining the UE context.
-	For the UE(s) that were associated to the corresponding AMF, when the peer CP NF needs to initiate a transaction towards the AMF, if backup AMF information of the corresponding failed AMF is not available, CP NF should select another AMF from the same AMF set and forward the transaction together with the old GUAMI. If neither the backup AMF nor any other AMF from the AMF set is available, then CP NF can select an AMF from the same AMF Region as in clause 6.3.5. If backup AMF information of the corresponding failed AMF is available, the CP NF forwards transaction to the backup AMF. If CP NF needs to send a notification to new AMF which is associated with a subscription from the old AMF, the CP NF shall exchange the old AMF information embedded in the Notification Address with the new AMF information, and use that Notification Address for subsequent communication.
-	When the 5G-AN or CP NFs need to select a different AMF from the same AMF set,
-	For deployments with UDSF, any AMF from the same AMF set can be selected.
-	For deployments without UDSF, the backup AMF is determined based on the GUAMI of the failed AMF.
Following actions should be taken by the newly selected AMF:
-	For deployments with UDSF, when there is a transaction with the UE the newly selected AMF retrieves the UE context from the UDSF using SUPI, 5G-GUTI or AMF UE NGAP ID and it processes the UE message accordingly and updates the 5G-GUTI towards the UE, if necessary.
-	For deployments without UDSF, backup AMF (the newly selected AMF), based on the failure detection of the old AMF, instructs peer CP NFs and 5G-AN that the UE contexts corresponding to the GUAMI of the failed AMF is now served by this newly selected AMF. The backup AMF shall not use old GUAMI to allocate 5G-GUTI for UE(s) that are being served by Target AMF. The backup AMF uses the GUAMI to locate the respective UE Context(s).
-	When there is a transaction with the UE, the new AMF updates the peer NFs (that subscribed to receive AMF unavailability notification from old AMF) with the new AMF information.
-	If the new AMF is aware of a different AMF serving the UE (by implementation specific means) it redirects the uplink N2 signalling to that AMF, or reject the transaction from the peer CP NFs with a cause to indicate that new AMF has been selected. The peer CP NFs may wait for the update from the new AMF and resend the transaction to the new AMF.
NOTE 3:	This bullet above addresses situations where 5G-AN node selects an AMF and other CP NFs select an AMF for the UE concurrently. It also addresses the situation where CP NFs select an AMF for the UE concurrently.
NOTE 4:	It is assumed that the UE contexts from the old AMF include all event subscriptions with peer CP NFs.
-	If the UE is in CM-IDLE state and the new AMF does not have access to the UE context, the new AMF selects one available AMF from the old AMF set as described in clause 6.3.5. The selected AMF retrieves the UE context from the UDSF and provides the UE context to the new AMF. If the new AMF doesn't receive the UE context then the AMF may force the UE to perform Initial Registration.
-	If the UE is in CM-CONNECTED state, the new AMF may also update the NGAP UE association with a new AMF UE NGAP ID towards the 5G-AN and replace the GUAMI in the UE context stored at the 5G-AN with the new GUAMI associated with the newly selected AMF if the 5G-GUTI has been updated.
NOTE 5:	The above N2 TNL association selection and AMF management is applied to the selected PLMN.
A Network Function instance can be deployed such that several network function instances are present within an NF Set to provide distribution, redundancy and scalability together as a Set of NF instances. The same is also supported for NF Services. This can be achieved when the equivalent NFs and NF Services share the same context data or by Network Function/NF Service Context Transfer procedures as specified in clause 4.26 of TS 23.502 [3].
NOTE:	A NF can be replaced by an alternative NF within the same NF Set in the case of scenarios such as failure, load balancing, load re-balancing.
Such a network reliability design shall work in both communication modes, i.e. Direct Communication and Indirect Communication. In the Direct Communication mode, the NF Service consumer is involved in the reliability related procedures. In Indirect Communication mode, the SCP is involved in the reliability related procedures.
Equivalent Control Plane NFs may be grouped into NF Sets, e.g. several SMF instances are grouped into an SMF Set. NFs within a NF Set are interchangeable because they share the same context data, and may be deployed in different locations, e.g. different data centres.
In the case of SMF, multiple instances of SMFs within an SMF Set need to be connected to the same UPF:
-	If the N4 association is established between a SMF instance and an UPF, each N4 association is only managed by the related SMF instance.
-	If only one N4 association is established between a SMF Set and an UPF, any SMF in the SMF Set should be able to manage the N4 association with the UPF.
Furthermore, for a given UE and PDU Session any SMF in the SMF Set should be able to control the N4 session with the UPF (however, at any given time, only one SMF in the SMF Set will control the UPF for a given UE's PDU Session).
A Control Plane NF is composed of one or multiple NF Services. Within a NF a NF service may have multiple instances. These multiple NF Service instances can be grouped into NF Service Set if they are interchangeable with each other because they share the same context data.
NOTE:	The actual mapping of instances to a given Set is up to deployment.
The NF producer instance is the NF instance which host the NF Service Producer. When the NF producer instance is not available, another NF producer instance within the same NF Set is selected.
For Direct Communication mode, the NF Service consumer may subscribe to status change notifications of NF instance from the NRF. If the NF Service consumer is notified by the NRF or detects by itself (e.g. request is not responded) that the NF producer instance is not available anymore, another available NF producer instance within the same NF Set is selected by the NF Service consumer.
For Indirect Communication mode, the SCP or NF Service consumer may subscribe to status change notifications of NF instance from the NRF and selects another NF producer instance within the same NF Set if the original NF producer instance serving the UE is not available anymore.
NOTE:	It is up to the implementation on how the SCP knows a NF producer instance is not available anymore.
When multiple NF Service instances within a NF Service Set are exposed to the NF Service consumer or SCP and the failure of NF Service instance is detected or notified by the NRF, i.e. it is not available anymore, the NF Service consumer or SCP selects another NF Service instance of the same NF Service Set within the NF instance, if available. Otherwise the NF Service consumer or SCP selects a different NF instance within the same NF Set.
NOTE:	The NF Producer instance can change the NF Service instance in the response to the service request.
When multiple NF Service instances within a NF Service Set are exposed to the NF Service consumer or SCP as a single NF Service, the reliability, i.e. the selection of an alternative NF Service instance is handled within the NF instance.
Network Function/NF Service Context Transfer Procedures allow transfer of Service Context of a NF/NF Service from a Source NF/NF Service Instance to the Target NF/NF Service Instance e.g. before the Source NF/NF Service can gracefully close its NF/NF Service. Service Context Transfer procedures are supported as specified in clause 4.26 of TS 23.502 [3].
Source NF / OA&M system determines when Source NF needs to transfer UE contexts to an NF in another NF set. Source NF should initiate this only for UE(s) that are not active in order to limit and avoid impacting services offered to corresponding UE(s).
The 5GS and the 5G QoS model allow classification and differentiation of specific services such as listed in clause 5.16, based on subscription-related and invocation-related priority mechanisms. These mechanisms provide abilities such as invoking, modifying, maintaining, and releasing QoS Flows with priority, and delivering QoS Flow packets according to the QoS characteristics under network congestion conditions.
Subscription-related Priority Mechanisms include the ability to prioritize flows based on subscription information, including the prioritization of RRC Connection Establishment based on Unified Access Control mechanisms and the establishment of prioritized QoS Flows.
Invocation-related Priority Mechanisms include the ability for the service layer to request/invoke the activation of prioritized QoS Flows through an interaction over Rx/N5 and packet detection in the UPF.
QoS Mechanisms applied to established QoS Flows include the ability to fulfil the QoS characteristics of QoS Flows through preservation of differentiated treatment for prioritized QoS Flow and resource distribution prioritization.
Messages associated with priority services that are exchanged over service-based interfaces may include a Message Priority header to indicate priority information, as specified in TS 23.502 [3] and TS 29.500 [49].
In addition, the separation of concerns between the service classification provided by the core network through the association of Service Data Flows to QoS, and the enforcing of QoS differentiation in (R)AN through the association of QoS Flows to Data Radio bearers, supports the prioritization of QoS Flows when a limitation of the available data radio bearers occurs.
In addition, it also includes the ability for the service layer to provide instructions on how to perform pre-emption of media flows with the same priority assigned through an interaction over Rx as defined in TS 23.503 [45].
Subscription-related mechanisms which are always applied:
-	(R)AN: During initial Access Network Connection Establishment, the Establishment Cause is set to indicate that special treatment is to be applied by the (R)AN in the radio resource allocation as specified in clause 5.2 for 3GPP access.
-	UDM: As defined in clause 5.2.3 of TS 23.502 [3], the UE subscription data in the UDM contains an MPS subscription indication (i.e. MPS priority) and an MCX subscription indication (i.e. MCX priority) for the UE that has subscription to MPS and MCX, respectively. The MPS priority and the MCX priority, if available, are provided to the AMF via the Registration or the UE Configuration Update procedure as defined in clause 4.2 of TS 23.502 [3].
-	AMF: Following Access Network Connection Establishment, the receipt of the designated Establishment Cause (i.e. high priority access) by the AMF will result in priority handling of the "Initial UE Message" received as part of the Registration procedures of clause 4.2.2 of TS 23.502 [3]. If the AMF did not receive a designated Establishment Cause (i.e. high priority access), but when the AMF determines that there is a MPS priority (or MCX priority) in the UDM for that UE, the AMF shall provide priority handling for that UE at that time and shall provide the MPS priority (or MCX priority) to the UE via the Registration or the UE Configuration Update procedure, as defined in clause 4.2 of TS 23.502 [3]. In addition, certain exemptions to Control Plane Congestion and Overload Control are provided as specified in clause 5.19.
Subscription-related mechanisms which are conditionally applied:
-	UE: When barring control parameters are broadcast by the RAN, access barring based on Access Identity(es) configured in the USIM and/or an Access Category is applied prior to an initial upstream transmission for the UE which provides a mechanism to limit transmissions from UEs categorized as non-prioritized, while allowing transmissions from UEs categorized as prioritized (such as MPS subscribed UEs), during the RRC Connection Establishment procedure as specified in clause 5.2.
-	UDM: One or more ARP priority levels are assigned for prioritized or critical services. The ARP of the prioritized QoS Flows for each DN is set to an appropriate ARP priority level. The 5QI is from the standard value range as specified in clause 5.7.2.7. In addition, Priority Level may be configured for the standardized 5QIs, and if configured, it overwrites the default value specified in the QoS characteristics Table 5.7.4-1.
-	PCF: The "IMS Signalling Priority" information is set for the subscriber in the UDM, and the PCF modifies the ARP of the QoS Flow used for IMS signalling, for each DN which supports prioritized services leveraging on IMS signalling, to an appropriate ARP priority level assigned for that service.
The generic mechanisms used based on invocation-related Priority Mechanisms for prioritised services are based an interaction with an Application Function and between the Application Function and the PCF over Rx/N5 interface.
These mechanisms apply to mobile originated as well as mobile terminated SIP call/sessions (clause 5.21 of TS 23.228 [15]) and Priority PDU connectivity services including MPS for Data Transport Service.
NOTE 1:	Clause 5.21 of TS 23.228 [15] is applicable to 5GS, with the understanding that the term PCRF corresponds to PCF in the 5GS.
Invocation-related mechanisms for Mobile Originations e.g. via SIP/IMS:
-	PCF: When an indication for a session arrives over the Rx/N5 Interface and the UE does not have priority for the signalling QoS Flow, the PCF derives the ARP and 5QI parameters, plus associated QoS characteristics as appropriate, of the QoS Flow for Signalling as per Service Provider policy as specified in clause 6.1.3.11 of TS 23.503 [45].
-	PCF: For sessions such as MPS, when establishing or modifying a QoS Flow for media as part of the session origination procedure, the PCF selects the ARP and 5QI parameters, plus associated QoS characteristics as appropriate, to provide priority treatment to the QoS Flow(s).
-	PCF: When all active sessions to a particular DN are released, and the UE is not configured for priority treatment to that particular PDU Session for a DN, the PCF will downgrade the IMS Signalling QoS Flows from appropriate settings of the ARP and 5QI parameters, plus associated QoS characteristics as appropriate, to those entitled by the UE based on subscription.
Invocation-related mechanisms for Mobile Terminations e.g. via SIP/IMS:
-	PCF: When an indication for a session arrives over the Rx/N5 Interface, mechanisms as described above for Mobile Originations are applied.
-	UPF: If an IP packet arrives at the UPF for a UE that is CM-IDLE, the UPF sends a "Data Notification" including the information to identify the QoS Flow for the DL data packet to the SMF, as specified in clause 4.2.3.3 of TS 23.502 [3].
-	SMF: If a " Data Notification" message arrives at the SMF for a QoS Flow associated with an ARP priority level value that is entitled for priority use, delivery of priority indication during the Paging procedure is provided by inclusion of the ARP in the N11 interface "N1N2MessageTransfer" message, as specified in clause 4.2.3.3 of TS 23.502 [3].
-	AMF: If an "N1N2MessageTransfer" message arrives at the AMF containing an ARP priority level value that is entitled for priority use, the AMF handles the request with priority and includes the "Paging Priority" IE in the N2 "Paging" message set to a value assigned to indicate that there is an IP packet at the UPF entitled to priority treatment, as specified in clause 4.2.3.3 of TS 23.502 [3].
-	SMF: For a UE that is not configured for priority treatment, upon receiving the "N7 Session Management Policy Modification" message from the PCF with an ARP priority level that is entitled for priority use, the SMF sends an "N1N2MessageTransfer" to update the ARP for the Signalling QoS Flows, as specified in clause 4.3.3.2 of TS 23.502 [3].
-	AMF: Upon receiving the "N1N2MessageTransfer" message from the SMF with an ARP priority level that is entitled for priority use, the AMF updates the ARP for the Signalling QoS Flows, as specified in clause 4.3.3.2 of TS 23.502 [3].
-	(R)AN: Inclusion of the "Paging Priority" in the N2 "Paging" message triggers priority handling of paging in times of congestion at the (R)AN as specified in clause 4.2.3.3 of TS 23.502 [3].
Invocation-related mechanisms for the Priority PDU connectivity services:
-	PCF: If the state of the Priority PDU connectivity services is modified from disabled to enabled, the QoS Flow(s) controlled by the Priority PDU connectivity services are established/modified to have the service appropriate settings of the ARP and 5QI parameters, plus associated QoS characteristics as appropriate, using the PDU Session Modification procedure as specified in clause 4.3.3 of TS 23.502 [3].
-	PCF: If the state of Priority PDU connectivity services is modified from enabled to disabled, the QoS Flow(s) controlled by the Priority PDU connectivity services are modified from Priority PDU connectivity service appropriate settings of the ARP and 5QI parameters, plus associated QoS characteristics as appropriate, to those entitled by the UE as per subscription, using the PDU Session Modification procedure as specified in clause 4.3.3 of TS 23.502 [3].
Invocation-related mechanisms for MPS for Data Transport Service:
-	MPS for Data Transport Service follows the same steps as those for Priority PDU connectivity services. The QoS Flows that will be subject to MPS for Data Transport Service are based on operator policy and regulations by means of local PCF configuration.
NOTE 2:	If no configuration is provided, MPS for Data Transport Service applies to the QoS Flow associated with the default QoS rule.
Mechanisms applied to established QoS Flows:
-	(R)AN: QoS Flows requested in the Xn "Handover Request" or N2 "Handover Request" which are marked as entitled to priority by virtue of inclusion of an ARP value from the set allocated by the Service Provider for prioritised services are given priority over requests for QoS Flows which do not include an ARP from the set as specified in clause 4.9 of TS 23.502 [3].
-	SMF: Congestion management procedures in the SMF will provide priority to QoS Flows established for sessions during periods of extreme overload. Prioritised services are exempt from any session management congestion controls. See clause 5.19.
-	AMF: Congestion management procedures in the AMF will provide priority to any Mobility Management procedures required for the prioritised services during periods of extreme overload. Prioritised services are exempt from any Mobility Management congestion controls. See clause 5.19.5.
-	QoS Flows whose ARP parameter is from the set allocated by the Service Provider for prioritised services' use shall be exempt from release during QoS Flow load rebalancing.
-	(R)AN, UPF: IMS Signalling Packets associated with prioritised services' use are handled with priority. Specifically, during times of severe congestion when it is necessary to drop packets on the IMS Signalling QoS Flow, or QoS Flow supporting MPS for Data Transport Service signalling, to ensure network stability, these FEs shall drop packets not associated with priority signalling such as MPS or Mission Critical services before packets associated with priority signalling. See clauses 5.16.5 and 5.16.6.
-	(R)AN, UPF: During times of severe congestion when it is necessary to drop packets on a media QoS Flow to ensure network stability, these FEs shall drop packets not associated with priority sessions such as MPS or Mission Critical services before packets associated with priority sessions. See clauses 5.16.5 and 5.16.6.
Asynchronous type communication (ATC) enables 5GC to delay synchronizing UE context with the UE, so as to achieve an efficient signalling overhead and increase system capacity. The support of ATC is optional for the AMF.
5GC supports asynchronous type communication with the following functionality:
-	Capability to store the UE context based on the received message, and synchronize the UE context with the involved network functions or UE later;
For network function (e.g. PCF, UDM, etc.) triggered signalling procedure (e.g. network triggered Service Request procedure, network triggered PDU Session Modification procedure, etc.), if the UE CM state in the AMF is CM-IDLE state and the requesting network function indicates to the AMF the ATC is allowed for the signalling, if the AMF supports the ATC feature, the AMF may update and store the UE context based on the received message without paging UE immediately. When the UE CM state in the AMF enters CM-CONNECTED state, the AMF forwards N1 and N2 message to synchronize the UE context with the (R)AN and/or the UE.
If the originating NF does not require immediate delivery, it may indicate that the AMF is allowed to use ATC.
NOTE:	Pre-Rel-17 AMF implementation cannot decode the indication that ATC is allowed.
This feature, when activated by the user, prevents traffic via 3GPP access of all IP packets, Unstructured and Ethernet data except for those related to 3GPP PS Data Off Exempt Services. The 3GPP PS Data Off Exempt Services are a set of operator services, defined in TS 22.011 [25] and TS 23.221 [23], that are the only allowed services when the 3GPP PS Data Off feature has been activated by the user. The 5GC shall support 3GPP PS Data Off operation in both non-roaming and roaming scenarios.
UEs may be configured with up to two lists of 3GPP PS Data Off Exempt Services and the list(s) are provided to the UEs by HPLMN via Device Management or UICC provisioning. When the UE is configured with two lists, one list is valid for the UEs camping in the home PLMN and the other list is valid for any VPLMN the UE is roaming in. When the UE is configured with a single list, without an indication to which PLMNs the list is applicable, then this list is valid for the home PLMN and any PLMN the UE is roaming in.
NOTE 1:	The operator needs to ensure coordinated list(s) of 3GPP Data Off Exempt Services provisioned in the UE and configured in the network.
The UE reports its 3GPP PS Data Off status in PCO (Protocol Configuration Option) to (H-)SMF during UE requested PDU Session Establishment procedure for establishment of a PDU Session associated with 3GPP access and/or non-3GPP access. The UE does not need to report PS Data Off status during the PDU Session Establishment procedure for handover of the PDU Session between 3GPP access and non 3GPP access if 3GPP PS Data Off status is not changed since the last report. The PS Data Off status for a PDU Session does not affect data transfer over non-3GPP access.
If 3GPP PS Data Off is activated, the UE prevents the sending of uplink IP packets, Unstructured and Ethernet data except for those related to 3GPP PS Data Off Exempt Services, based on the pre-configured list(s) of Data Off Exempt Services.
If 3GPP PS Data Off is activated for a UE with MA PDU Sessions established through the ATSSS feature (see clause 5.32), the data transferred over the non-3GPP access of the MA PDU sessions are unaffected, which is ensured by the policy for ATSSS Control as specified in clause 5.32.3.
The UE shall immediately report a change of its 3GPP PS Data Off status in PCO by using UE requested PDU Session Modification procedure. This also applies to the scenario of inter-RAT mobility to NG-RAN and to scenarios where the 3GPP PS Data Off status is changed when the session management back-off timer is running as specified in clause 5.19.7.3 and clause 5.19.7.4. For UEs in Non-Allowed Area (or not in Allowed Area) as specified in clause 5.3.4.1, the UE shall also immediately report a change of its 3GPP PS Data Off status for the PDU Session. For UEs moving out of LADN area and the PDU Session is still maintained as specified in clause 5.6.5, the UE shall also immediately report a change of its 3GPP PS Data Off status for the PDU Session.
The additional behaviour of the SMF for 3GPP PS Data Off is controlled by local configuration or policy from the PCF as defined in TS 23.503 [45].
NOTE 2:	For the PDU Session used for IMS services, the 3GPP Data Off Exempt Services are enforced in the IMS domain as specified TS 23.228 [15]. Policies configured in the (H-)SMF/PCF need to ensure those services are always allowed when the 3GPP Data Off status of the UE is set to "activated".
5GS supports tracing as described in TS 32.421 [66]. 5GS support may include subscriber tracing (tracing targeting a SUPI) or equipment tracing (tracing targeting a PEI) but also other forms of tracing further described in TS 32.421 [66].
NOTE 1:	TS 23.501 / TS 23.502 [3] / TS 23.503 [45] only describe how 5GS signalling supports delivery of Trace Requirements about a UE (Signalling Based Activation/Deactivation of Tracing). OAM delivery of tracing requirements as well as the transfer of tracing results to one or more Operations Systems are out of scope of these documents.
The content of Trace Requirements about a UE (e.g. trace reference, address of the Trace Collection Entity, etc.) is defined in TS 32.421 [66].
Trace Requirements about a UE may be configured in subscription data of the UE and delivered together with other subscription data by the UDM towards the AMF, the SMF and/or the SMSF.
The AMF propagates Trace Requirements about a UE received from the UDM to network entities not retrieving subscription information from UDM, i.e. to the 5G-AN, to the AUSF and to the PCF. The AMF also propagates Trace Requirements to the SMF and to the SMSF. If the I-SMF or V-SMF is needed for the PDU session, the AMF propagates Trace Requirements to the I-SMF or V-SMF. The I-SMF or V-SMF also propagates Trace Requirements received from the AMF to the I-UPF or V-UPF (over N4).
Trace Requirements about a UE may be sent by the AMF to the 5G-AN as part of:
-	the N2 procedures used to move the UE from CM-IDLE to CM-CONNECTED or,
-	the N2 procedures to request a Hand-over from a target NG-RAN or,
-	a stand-alone dedicated N2 procedure when tracing is activated while the UE is CM-CONNECTED.
Trace Requirements about a UE sent to a 5G-AN shall not contain information on the SUPI or on the PEI of the UE. Trace Requirements are directly sent from Source to Target NG-RAN in the case of Xn Hand-Over.
The SMF propagates Trace Requirements about a UE received from the UDM to the UPF (over N4) and to the PCF. The SMF provides Trace Requirements to the PCF when it has selected a different PCF than the one received from the AMF.
Once the SMF or the SMSF has received subscription data, Trace Requirements received from UDM supersede Trace requirements received from the AMF. Trace Requirements are exchanged on N26 between the AMF and the MME.
5GS supports 5G LAN-type service as defined in clause 5.29. 5G LAN-type service includes the 5G VN group management that can be configured by a network administrator.
The parameters for 5G VN group is defined in clause 5.29.
The 5G VN group parameters about a UE may be configured in subscription data of the UE and delivered together with other subscription data by the UDM towards the AMF and SMF.
The purpose of the Configuration Transfer is to enable the transfer of information between two RAN nodes at any time via NG interface and the Core Network. An example of application is to exchange the RAN node's IP addresses in order to be able to use Xn interface between the NG-RAN node for Self-Optimised Networks (SON), as specified in TS 38.413 [34].
Configuration Transfer between two RAN node provides a generic mechanism for the exchange of information between applications belonging to the RAN nodes.
In order to make the information transparent for the Core Network, the information is included in a transparent container that includes source and target RAN node addresses, which allows the Core Network nodes to route the messages. The mechanism is depicted in figure 5.26 1.

Figure 5.26-1: inter NG-RAN Configuration Transfer basic network architecture
The NG-RAN transparent containers are transferred from the source NG-RAN node to the destination NG-RAN node by use of Configuration Transfer messages.
A Configuration Transfer message is used from the NG-RAN node to the AMF over N2 interface, a AMF Configuration Transfer message is used from the AMF to the NG-RAN over N2 interface, and a Configuration Transfer Tunnel message is used to tunnel the transparent container from a source AMF to a target AMF over the N14 interface.
Each Configuration Transfer message carrying the transparent container is routed and relayed independently by the core network node(s).
All the Configuration Transfer messages contain the addresses of the source and destination RAN nodes. An NG-RAN node is addressed by the Target NG-RAN node identifier.
The following description applies to all the Configuration Transfer messages used for the exchange of the transparent container.
The source RAN node sends a message to its core network node including the source and destination addresses. The AMF uses the destination address to route the message to the correct AMF via the N14 interface.
The AMF connected to the destination RAN node decides which RAN node to send the message to, based on the destination address.
The AMF performs relaying between N2 and N14 messages as described in TS 38.413 [34], TS 29.518 [71].
This clause describes 5G System features that can be used independently or in combination to enable time-sensitive communication, time synchronization and deterministic networking:
-	Delay-critical GBR;
-	A hold and forward mechanism to schedule traffic as defined in IEEE Std 802.1Q [98] for Ethernet PDU Sessions in DS-TT and NW-TT (see clause 5.27.4) to de-jitter flows that have traversed the 5G System if the 5G System is to participate transparently as a bridge in a TSN network;
-	TSC Assistance Information: describes TSC flow traffic characteristics as described in clause 5.27.2 that may be provided optionally for use by the gNB, to allow more efficiently schedule radio resources for periodic traffic and applies to PDU Session type Ethernet and IP.
-	Time Synchronization: describes how 5GS can operate as a PTP Relay (IEEE Std 802.1AS [104]), as a Boundary Clock or as Transparent Clock (IEEE Std 1588 [126]) for PDU Session type Ethernet and IP and how 5GS can detect and report the status of the time synchronization.
-	RAN feedback for BAT offset and adjusted periodicity describes a mechanism supported by NG-RAN and 5G CN that enables AF to adapt to received BAT offset and adjusted periodicity from NG-RAN for a given traffic flow.
The 5G System integration as a bridge in an IEEE 802.1 TSN network as described in clause 5.28 can make use of all features listed above.
To support any of the above features to enable time-sensitive communication, time synchronization and deterministic networking, during the PDU Session establishment, the UE shall request to establish a PDU Session as an always-on PDU Session, and the PDU Sessions are established as Always-on PDU session as described in clause 5.6.13. In this release of the specification, to use any of the above features to enable time-sensitive communication, time synchronization and deterministic networking:
-	Home Routed PDU Sessions are not supported;
-	PDU Sessions are supported only for SSC mode 1;
-	Service continuity is not supported when the UE moves from 5GS to EPS .i.e. interworking with EPS is not supported for a PDU Session for time synchronization or TSC or deterministic networking.
For supporting time synchronization service, the 5GS is configured to operate in one or multiple PTP instances and to operate in one of the following modes (if supported) for each PTP instance:
1)	as time-aware system as described in IEEE Std 802.1AS [104],
2)	as Boundary Clock as described in IEEE Std 1588 [126], provisioned by the profiles supported by this 3GPP specification including SMPTE Profile for Use of IEEE Std 1588 [126] Precision Time Protocol in Professional Broadcast Applications ST 2059-2:2015 [127];
NOTE 1:	Via proper configuration of the IEEE Std 1588 [126] data set members, the 5G internal system clock can become the time source for the PTP grandmaster function for the connected networks in the case of mode 1 and mode 2.
NOTE 2:	In some cases where the 5G internal system clock is the time source for the PTP grandmaster function for the connected networks, it might not be required for the UE to receive gPTP or PTP messages over user plane. The UE and DS-TT uses the 5G timing information and generates the necessary gPTP or PTP message for the end station, if needed (this is implementation specific).
3)	as peer-to-peer Transparent Clock as described in IEEE Std 1588 [126], provisioned by the profiles supported by this 3GPP specification including SMPTE Profile for Use of IEEE Std 1588 Precision Time Protocol in Professional Broadcast Applications ST 2059-2:2015 [127]; or
4)	as end-to-end Transparent Clock as described in IEEE Std 1588 [126], provisioned by the profiles supported by this 3GPP specification including SMPTE Profile for Use of IEEE Std 1588 Precision Time Protocol in Professional Broadcast Applications ST 2059-2:2015 [127].
NOTE 3:	When the GM is external, the operation of 5GS as Boundary Clock assumes that profiles that are supported by the 5GS allows the exemption specified in clauses 9.5.9 and 9.5.10 of IEEE Std 1588 [126] where the originTimestamp (or preciseOriginTimestamp in case of two-step operation) is not required to be updated with the syncEventEgressTimestamp (and a Local PTP Clock locked to the external GM). As described in clause 5.27.1.2.2, only correctionField is updated with the 5GS residence time and link delay, in a similar operation as specified by IEEE Std 802.1AS [104].
The configuration of the time synchronization service in 5GS for option 1 by TSN AF and CNC is described in clause 5.28.3, and for options 1-4 by AF/NEF and TSCTSF in clause 5.27.1.8 and clause 5.28.3.
The 5GS shall be modelled as an IEEE Std 802.1AS [104] or IEEE Std 1588 [126] compliant entity based on the above configuration.
NOTE 4:	This release of the specification does not support the PTP management mechanism or PTP management messages as described in clause 15 in IEEE Std 1588 [126].
The DS-TT and NW-TT at the edge of the 5G system may support the IEEE Std 802.1AS [104] or other IEEE Std 1588 [126] profiles' operations respective to the configured mode of operation. The UE, gNB, UPF, NW-TT and DS- TTs are synchronized with the 5G GM (i.e. the 5G internal system clock) which shall serve to keep these network elements synchronized. The TTs located at the edge of 5G system fulfil some functions related to IEEE Std 802.1AS [104] and may fulfil some functions related to IEEE Std 1588 [126], e.g. (g)PTP support and timestamping. Figure 5.27.1-1 illustrates the 5G and PTP grandmaster (GM) clock distribution model via 5GS.

Figure 5.27.1-1: 5G system is modelled as PTP instance for supporting time synchronization
Figure 5.27.1-1 depicts the two synchronizations systems considered: the 5G Clock synchronization and the (g)PTP domain synchronization.
-	5G Access Stratum-based Time Distribution: Used for NG RAN synchronization and also distributed to the UE. The 5G Access Stratum-based Time Distribution over the radio interface towards the UE is specified in TS 38.331 [28]. This method may be used to either further distribute the 5G timing to devices connected to a UE (using implementation-specific means) or to support the operation of the (g)PTP-based time distribution method.
-	(g)PTP-based Time Distribution: Provides timing among entities in a (g)PTP domain. This process follows the applicable profiles of IEEE Std 802.1AS [104] or IEEE Std 1588 [126]. This method relies on the 5G access stratum-based time distribution method to synchronize the UE/DS-TT and on the 5GS time synchronization to synchronize the gNB (which, in turn, may synchronize the DS-TT) and the NW-TT.
The gNB needs to be synchronized to the 5G GM clock.
The 5GS supports two methods for determining the grandmaster PTP Instance and the time-synchronization spanning tree.
-	Method a), BMCA procedure.
-	Method b), local configuration.
This is further described in clause 5.27.1.6.
The 5G internal system clock shall be made available to all user plane nodes in the 5G system. The UPF and NW-TT may get the 5G internal system clock via the underlying PTP compatible transport network with mechanisms outside the scope of 3GPP. The 5G internal system clock shall be made available to UE with signalling of time information related to absolute timing of radio frames as described in TS 38.331 [28]. The 5G internal system clock shall be made available to DS-TT by the UE.
The mechanisms for distribution of TSN GM clock and time-stamping described in this clause are according to IEEE Std 802.1AS [104].
NOTE 1:	It means Externally-observable behaviour of the 5GS bridge needs to comply with IEEE Std 802.1AS [104].
For downlink Time Synchronization, upon reception of a downlink gPTP message from NW-TT port in Follower state, the NW-TT makes an ingress timestamping (TSi) for each gPTP event (Sync) message and uses the cumulative rateRatio received inside the gPTP message payload (carried within Sync message for one-step operation or Follow_up message for two-step operation) to calculate the link delay from the upstream TSN node (gPTP entity connected to NW-TT) expressed in TSN GM time as specified in IEEE Std 802.1AS [104]. NW-TT then calculates the new cumulative rateRatio (i.e. the cumulative rateRatio of the 5GS) as specified in IEEE Std 802.1AS [104] and modifies the gPTP message payload (carried within Sync message for one-step operation or Follow_up message for two-step operation) as follows:
-	Adds the link delay from the upstream TSN node in TSN GM time to the correction field.
-	Replaces the cumulative rateRatio received from the upstream TSN node with the new cumulative rateRatio.
-	Adds TSi in the Suffix field of the gPTP packet as described in clause H.2.
The UPF/NW-TT uses the ingress port number of the NW-TT, and domainNumber and sdoId in the received gPTP message to assign the gPTP message to a PTP instance in the NW-TT. If the NW-TT does not have a matching PTP instance, the UPF/NW-TT discards the message. The UPF/NW-TT then forwards the gPTP message from TSN network to the PTP ports in DS-TT(s) in Leader state within this PTP instance via PDU sessions terminating in this UPF that the UEs have established to the TSN network. The UPF/NW-TT also forwards the gPTP message to the PTP ports in NW-TT in Leader state within this PTP instance. All gPTP messages are transmitted on a QoS Flow that complies with the residence time upper bound requirement specified in IEEE Std 802.1AS [104].
NOTE 2:	Leader and Follower terms in this specification maps to Master and Slave terms respectively for (g)PTP time synchronization as specified in IEEE Std 802.1AS [104] and IEEE Std 1588 [126]. This terminology can require update depending on the IEEE 1588 WG response to SA WG2.
NOTE 3:	The sum of the UE-DS-TT residence time and the PDB of the QoS Flow needs to be lower than the residence time upper bound requirement for a time-aware system specified in IEEE Std 802.1AS [104] in the following cases:
a)	If the PTP port in DS-TT is in Follower state and a PTP port in the NW-TT is in Leader state; or 
b)	a PTP port in DS-TT is in Leader state and a PTP port in NW-TT is in Follower state.
NOTE 4:	If the PTP port in DS-TT is in a Follower state, and a PTP port in another DS-TT is in Leader state, then the sum of the residence time for these two DS-TT ports and the PDB of the QoS flow of the two PDU Sessions needs to be lower than the residence time upper bound requirement for a time-aware system specified in IEEE Std 802.1AS [104].
A UE receives the gPTP messages and forwards them to the DS-TT. The DS-TT then creates egress timestamping (TSe) for the gPTP event (Sync) messages for external TSN working domains. The difference between TSi and TSe is considered as the calculated residence time spent within the 5G system for this gPTP message expressed in 5GS time. The DS-TT then uses the rateRatio contained inside the gPTP message payload (carried within Sync message for one-step operation or Follow_up message for two-step operation) to convert the residence time spent within the 5GS in TSN GM time and modifies the payload of the gPTP message that it sends towards the downstream TSN node (gPTP entity connected to DS-TT) as follows:
-	Adds the calculated residence time expressed in TSN GM time to the correction field.
-	Removes Suffix field that contains TSi.
If the ingress DS-TT has indicated support of the IEEE Std 802.1AS [104] PTP profile as described in clause K.2.1 and the network has configured a PTP instance with the IEEE Std 802.1AS [104] PTP profile for the ingress DS-TT, the ingress DS-TT performs the following operations for received UL gPTP messages for the PTP instance:
-	Adds the link delay from the upstream TSN node (gPTP entity connected to DS-TT) in TSN GM time